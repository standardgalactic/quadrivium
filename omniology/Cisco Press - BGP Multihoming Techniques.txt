1
SANOG 8
BGP Multihoming
Techniques
Philip Smith    <pfs@cisco.com>
SANOG 8
26th July - 4th August 2006
Karachi

2
SANOG 8
Presentation Slides
• Available on
ftp://ftp-eng.cisco.com
/pfs/seminars/SANOG8-Multihoming.pdf
And on the SANOG8 website
• Feel free to ask questions any time

3
SANOG 8
Preliminaries
• Presentation has many configuration examples
Uses Cisco IOS CLI
• Aimed at Service Providers
Techniques can be used by many enterprises too
• Feel free to ask questions

4
SANOG 8
BGP Multihoming Techniques
• Why Multihome?
• Definition & Options
• Preparing the Network
• Basic Multihoming
• Service Provider Multihoming
• Internet Exchange Points

5
SANOG 8
Why Multihome?
It’s all about redundancy, diversity & reliability

6
SANOG 8
Why Multihome?
• Redundancy
One connection to internet means the network
is dependent on:
Local router (configuration, software,
hardware)
WAN media (physical failure, carrier failure)
Upstream Service Provider (configuration,
software, hardware)

7
SANOG 8
Why Multihome?
• Reliability
Business critical applications demand
continuous availability
Lack of redundancy implies lack of reliability
implies loss of revenue

8
SANOG 8
Why Multihome?
• Supplier Diversity
Many businesses demand supplier diversity as a matter
of course
Internet connection from two or more suppliers
With two or more diverse WAN paths
With two or more exit points
With two or more international connections
Two of everything

9
SANOG 8
Why Multihome?
• Not really a reason, but oft quoted…
• Leverage:
Playing one ISP off against the other for:
Service Quality
Service Offerings
Availability

10
10
10
SANOG 8
Why Multihome?
• Summary:
Multihoming is easy to demand as requirement for any
service provider or end-site network
But what does it really mean:
In real life?
For the network?
For the Internet?
And how do we do it?

11
11
11
SANOG 8
BGP Multihoming Techniques
• Why Multihome?
• Definition & Options
• Preparing the Network
• Basic Multihoming
• Service Provider Multihoming
• Internet Exchange Points

12
SANOG 8
Multihoming: Definitions &
Options
What does it mean, what do we need, and how do we do
it?

13
13
13
SANOG 8
Multihoming Definition
• More than one link external to the local
network
two or more links to the same ISP
two or more links to different ISPs
• Usually two external facing routers
one router gives link and provider redundancy
only

14
14
14
SANOG 8
AS Numbers
• An Autonomous System Number is required by
BGP
• Obtained from upstream ISP or  Regional
Registry (RIR)
AfriNIC, APNIC, ARIN, LACNIC, RIPE NCC
• Necessary when you have links to more than one
ISP or to an exchange point
• 16 bit integer, ranging from 1 to 65534
Zero and 65535 are reserved
64512 through 65534 are called Private ASNs

15
15
15
SANOG 8
Private-AS – Application
• Applications
An ISP with customers
multihomed on their
backbone (RFC2270)
-or-
A corporate network
with several regions
but connections to the
Internet only in the
core
-or-
Within a BGP
Confederation
1880
193.1.34.0/24
65003
193.2.35.0/24
65002
193.0.33.0/24
    65001
193.0.32.0/24
A
193.1.32.0/22  1880
B
C

16
16
16
SANOG 8
Private-AS – Removal
• Private ASNs MUST be removed from all prefixes
announced to the public Internet
Include configuration to remove private ASNs in the
eBGP template
• As with RFC1918 address space, private ASNs
are intended for internal use
They should not be leaked to the public Internet
• Cisco IOS
neighbor x.x.x.x remove-private-AS

17
17
17
SANOG 8
Configuring Policy
• Three BASIC Principles for IOS
configuration examples throughout
presentation:
prefix-lists to filter prefixes
filter-lists to filter ASNs
route-maps to apply policy
• Route-maps can be used for filtering, but
this is more “advanced” configuration

18
18
18
SANOG 8
Policy Tools
• Local preference
outbound traffic flows
• Metric (MED)
inbound traffic flows (local scope)
• AS-PATH prepend
inbound traffic flows (Internet scope)
• Communities
specific inter-provider peering

19
19
19
SANOG 8
Originating Prefixes: Assumptions
• MUST announce assigned address block to
Internet
• MAY also announce subprefixes – reachability is
not guaranteed
• Current RIR minimum allocation is /21
Several ISPs filter RIR blocks on this boundary
Several ISPs filter the rest of address space according
to the IANA assignments
This activity is called “Net Police” by some

20
20
20
SANOG 8
Originating Prefixes
•
Some RIRs publish their minimum allocation sizes per /8 address
block
AfriNIC:
www.afrinic.net/docs/policies/afpol-v4200407-000.htm
APNIC: 
www.apnic.net/db/min-alloc.html
ARIN:
www.arin.net/reference/ip_blocks.html
LACNIC:
lacnic.net/en/registro/index.html
RIPE NCC:
www.ripe.net/ripe/docs/smallest-alloc-sizes.html
Note that AfriNIC only publishes its current minimum allocation size,
not the allocation size for its address blocks
•
IANA publishes the address space it has assigned to end-sites and
allocated to the RIRs:
www.iana.org/assignments/ipv4-address-space
•
Several ISPs use this published information to filter prefixes on:
What should be routed (from IANA)
The minimum allocation size from the RIRs

21
21
21
SANOG 8
“Net Police” prefix list issues
• meant to “punish” ISPs who pollute the routing table with
specifics rather than announcing aggregates
• impacts legitimate multihoming especially at the Internet’s edge
• impacts regions where domestic backbone is unavailable or
costs $$$ compared with international bandwidth
• hard to maintain – requires updating when RIRs start allocating
from new address blocks
• don’t do it unless consequences understood and you are
prepared to keep the list current
Consider using the Project Cymru bogon BGP feed
http://www.cymru.com/BGP/bogon-rs.html

22
22
22
SANOG 8
Multihoming Scenarios
• Stub network
• Multi-homed stub network
• Multi-homed network
• Load-balancing

23
23
23
SANOG 8
Stub Network
• No need for BGP
• Point static default to upstream ISP
• Router will load share on the two parallel circuits
• Upstream ISP advertises stub network
• Policy confined within upstream ISP’s policy
AS100
AS101

24
24
24
SANOG 8
Multi-homed Stub Network
• Use BGP (not IGP or static) to loadshare
• Use private AS (ASN > 64511)
• Upstream ISP advertises stub network
• Policy confined within upstream ISP’s policy
AS100
AS65530

25
25
25
SANOG 8
Multi-Homed Network
• Many situations possible
multiple sessions to same ISP
secondary for backup only
load-share between primary and secondary
selectively use different ISPs
AS300
AS200
AS100
Global Internet

26
26
26
SANOG 8
Multiple Sessions to an ISP
– Example One
• Use eBGP multihop
eBGP to loopback addresses
eBGP prefixes learned with loopback
address as next hop
• Cisco IOS
router bgp 65534
 neighbor 1.1.1.1 remote-as 200
 neighbor 1.1.1.1 ebgp-multihop 2
!
ip route 1.1.1.1 255.255.255.255 serial 1/0
ip route 1.1.1.1 255.255.255.255 serial 1/1
ip route 1.1.1.1 255.255.255.255 serial 1/2
AS 65534
1.1.1.1
AS 200

27
27
27
SANOG 8
Multiple Sessions to an ISP
– Example One
• One eBGP-multihop
gotcha:
R1 and R3 are eBGP peers
that are loopback peering
Configured with:
neighbor x.x.x.x ebgp-multihop 2
If the R1 to R3 link goes
down the session could
establish via R2
AS 200
AS 100
R1
R3
R2
Used Path
Desired Path

28
28
28
SANOG 8
Multiple Sessions to an ISP
– Example One
• Try and avoid use of ebgp-multihop unless:
It’s absolutely necessary –or–
Loadsharing across multiple links
• Many ISPs discourage its use, for example:
We will run eBGP multihop, but do not support it as a standard offering
because customers generally have a hard time managing it due to:
• routing loops
• failure to realise that BGP session stability problems are usually due
connectivity problems between their CPE and their BGP speaker

29
29
29
SANOG 8
Multiple Sessions to an ISP
 – Example Two
• BGP multi-path
• Limit to number of parallel
paths depending on
implementation
• For this example, three
BGP sessions required
• Cisco IOS Configuration
router bgp 201
 neighbor 1.1.2.1 remote-as 200
 neighbor 1.1.2.5 remote-as 200
 neighbor 1.1.2.9 remote-as 200
 maximum-paths 3
AS 201
AS 200

30
30
30
SANOG 8
Multiple Sessions to an ISP
• Simplest scheme is to use
defaults
• Learn/advertise prefixes for
better control
• Planning and some work
required to achieve
loadsharing
Point default towards one ISP
Learn selected prefixes from
second ISP
Modify the number of prefixes
learnt to achieve acceptable
load sharing
• No magic solution
AS 201
ISP
CC
DD
AA
BB

31
31
31
SANOG 8
BGP Multihoming Techniques
• Why Multihome?
• Definition & Options
• Preparing the Network
• Basic Multihoming
• Service Provider Multihoming
• Internet Exchange Points

32
SANOG 8
Preparing the Network
Putting our own house in order first…

33
33
33
SANOG 8
Preparing the Network
• We will deploy BGP across the network before
we try and multihome
• BGP will be used therefore an ASN is required
• If multihoming to different ISPs, public ASN
needed:
Either go to upstream ISP who is a registry member, or
Apply to the RIR yourself for a one off assignment, or
Ask an ISP who is a registry member, or
Join the RIR and get your own IP address allocation too
(this option strongly recommended)!

34
34
34
SANOG 8
Preparing the Network
• The network is not running any BGP at the
moment
single statically routed connection to upstream
ISP
• The network is not running any IGP at all
Static default and routes through the network
to do “routing”

35
35
35
SANOG 8
Preparing the Network
IGP
• Decide on IGP: OSPF or ISIS 
• Assign loopback interfaces and /32 addresses to
each router which will run the IGP
Loopback is used for OSPF and BGP router id anchor
Used for iBGP and route origination
• Deploy IGP (e.g. OSPF)
IGP can be deployed with NO IMPACT on the existing
static routing
OSPF distance is 110, static distance is 1
Smallest distance wins

36
36
36
SANOG 8
Preparing the Network
IGP (cont)
• Be prudent deploying IGP – keep the Link State
Database Lean!
Router loopbacks go in IGP
WAN point to point links go in IGP
(In fact, any link where IGP dynamic routing will be run
should go into IGP)
Summarise on area/level boundaries (if possible) – i.e.
think about your IGP address plan

37
37
37
SANOG 8
Preparing the Network
IGP (cont)
• Routes which don’t go into the IGP include:
Dynamic assignment pools (DSL/Cable/Dial)
Customer point to point link addressing
(using next-hop-self in iBGP ensures that these do NOT
need to be in IGP)
Static/Hosting LANs
Customer assigned address space
Anything else not listed in the previous slide

38
38
38
SANOG 8
Preparing the Network
iBGP
• Second step is to
configure the local
network to use iBGP
• iBGP can run on
all routers, or
a subset of routers, or
just on the upstream edge
• iBGP must run on all
routers which are in the
transit path between
external connections
AS200
FF
EE
DD
CC
AA
BB

39
39
39
SANOG 8
Preparing the Network
iBGP (Transit Path)
• iBGP must run on all
routers which are in the
transit path between
external connections
• Routers C, E and F are not
in the transit path
Static routes or IGP will
suffice
• Router D is in the transit
path
Will need to be in iBGP
mesh, otherwise routing
loops will result
AS200
FF
EE
DD
CC
AA
BB

40
40
40
SANOG 8
Preparing the Network
Layers
• Typical SP networks have three layers:
Core – the backbone, usually the transit path
Distribution – the middle, PoP aggregation
layer
Aggregation – the edge, the devices
connecting customers

41
41
41
SANOG 8
Preparing the Network
Aggregation Layer
• iBGP is optional
Many ISPs run iBGP here, either partial routing (more
common) or full routing (less common)
Full routing is not needed unless customers want full table
Partial routing is cheaper/easier, might usually consist of
internal prefixes and, optionally, external prefixes to aid
external load balancing
Communities and peer-groups make this administratively easy
• Many aggregation devices can’t run iBGP
Static routes from distribution devices for address pools
IGP for best exit

42
42
42
SANOG 8
Preparing the Network
Distribution Layer
• Usually runs iBGP
Partial or full routing (as with aggregation layer)
• But does not have to run iBGP
IGP is then used to carry customer prefixes (does not
scale)
IGP is used to determine nearest exit
• Networks which plan to grow large should
deploy iBGP from day one
Migration at a later date is extra work
No extra overhead in deploying iBGP, indeed IGP
benefits

43
43
43
SANOG 8
Preparing the Network
Core Layer
• Core of network is usually the transit path
• iBGP necessary between core devices
Full routes or partial routes:
Transit ISPs carry full routes in core
Edge ISPs carry partial routes only
• Core layer includes AS border routers

44
44
44
SANOG 8
Preparing the Network
iBGP Implementation
Decide on:
• Best iBGP policy
Will it be full routes everywhere, or partial, or
some mix?
• iBGP scaling technique
Community policy?
Route-reflectors?
Techniques such as peer groups and peer
templates?

45
45
45
SANOG 8
Preparing the Network
iBGP Implementation
• Then deploy iBGP:
Step 1: Introduce iBGP mesh on chosen routers
make sure that iBGP distance is greater than IGP distance (it
usually is)
Step 2: Install “customer” prefixes into iBGP
Check! Does the network still work?
Step 3: Carefully remove the static routing for the
prefixes now in IGP and iBGP
Check! Does the network still work?
Step 4: Deployment of eBGP follows

46
46
46
SANOG 8
Preparing the Network
iBGP Implementation
Install “customer” prefixes into iBGP?
• Customer assigned address space
Network statement/static route combination
Use unique community to identify customer assignments
• Customer facing point-to-point links
Redistribute connected through filters which only permit
point-to-point link addresses to enter iBGP
Use a unique community to identify point-to-point link
addresses (these are only required for your monitoring
system)
• Dynamic assignment pools & local LANs
Simple network statement will do this
Use unique community to identify these networks

47
47
47
SANOG 8
Preparing the Network
iBGP Implementation
Carefully remove static routes?
• Work on one router at a time:
Check that static route for a particular destination is also
learned either by IGP or by iBGP
If so, remove it
If not, establish why and fix the problem
(Remember to look in the RIB, not the FIB!)
• Then the next router, until the whole PoP is done
• Then the next PoP, and so on until the network is now
dependent on the IGP and iBGP you have deployed

48
48
48
SANOG 8
Preparing the Network
Completion
• Previous steps are NOT flag day steps
Each can be carried out during different maintenance
periods, for example:
Step One on Week One
Step Two on Week Two
Step Three on Week Three
And so on
And with proper planning will have NO customer visible
impact at all

49
49
49
SANOG 8
Preparing the Network
Configuration Summary
• IGP essential networks are in IGP
• Customer networks are now in iBGP
iBGP deployed over the backbone
Full or Partial or Upstream Edge only
• BGP distance is greater than any IGP
• Now ready to deploy eBGP

50
50
50
SANOG 8
BGP Multihoming Techniques
• Why Multihome?
• Definition & Options
• Preparing the Network
• Basic Multihoming
• “BGP Traffic Engineering”
• Internet Exchange Points

51
SANOG 8
Basic Multihoming
Learning to walk before we try running

52
52
52
SANOG 8
Basic Multihoming
• No frills multihoming
• Will look at two cases:
Multihoming with the same ISP
Multihoming to different ISPs
• Will keep the examples easy
Understanding easy concepts will make the more
complex scenarios easier to comprehend
All assume that the site multihoming has a /19 address
block

53
53
53
SANOG 8
Basic Multihoming
• This type is most commonplace at the edge of
the Internet
Networks here are usually concerned with inbound
traffic flows
Outbound traffic flows being “nearest exit” is usually
sufficient
• Can apply to the leaf ISP as well as Enterprise
networks

54
SANOG 8
Basic Multihoming
Multihoming to the Same ISP

55
55
55
SANOG 8
Basic Multihoming:
Multihoming to the same ISP
• Use BGP for this type of multihoming
use a private AS (ASN > 64511)
There is no need or justification for a public ASN
Making the nets of the end-site visible gives no useful
information to the Internet
• Upstream ISP proxy aggregates
in other words, announces only your address block to
the Internet from their AS (as would be done if you had
one statically routed connection)

56
SANOG 8
Two links to the same ISP
One link primary, the other link backup only

57
57
57
SANOG 8
Two links to the same ISP
(one as backup only)
• Applies when end-site has bought a large
primary WAN link to their upstream a
small secondary WAN link as the backup
For example, primary path might be an E1,
backup might be 64kbps

58
58
58
SANOG 8
Two links to the same ISP
(one as backup only)
AS 100
AS 65534
AA
CC
• Border router E in AS100 removes private AS and any
customer subprefixes from Internet announcement
DD
EE
BB
primary
backup

59
59
59
SANOG 8
Two links to the same ISP
(one as backup only)
• Announce /19 aggregate on each link
primary link:
Outbound – announce /19 unaltered
Inbound – receive default route
backup link:
Outbound – announce /19 with increased metric
Inbound – received default, and reduce local preference
• When one link fails, the announcement of the /19
aggregate via the other link ensures continued
connectivity

60
60
60
SANOG 8
Two links to the same ISP
(one as backup only)
• Router A Configuration
router bgp 65534
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.2 remote-as 100
 neighbor 122.102.10.2 description RouterC
 neighbor 122.102.10.2 prefix-list aggregate out
 neighbor 122.102.10.2 prefix-list default in
!
ip prefix-list aggregate permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!

61
61
61
SANOG 8
Two links to the same ISP
(one as backup only)
• Router B Configuration
router bgp 65534
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.6 remote-as 100
 neighbor 122.102.10.6 description RouterD
 neighbor 122.102.10.6 prefix-list aggregate out
 neighbor 122.102.10.6 route-map routerD-out out
 neighbor 122.102.10.6 prefix-list default in
 neighbor 122.102.10.6 route-map routerD-in in
!
..next slide

62
62
62
SANOG 8
Two links to the same ISP
(one as backup only)
ip prefix-list aggregate permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
route-map routerD-out permit 10
 match ip address prefix-list aggregate
 set metric 10
route-map routerD-out permit 20
!
route-map routerD-in permit 10
 set local-preference 90
!

63
63
63
SANOG 8
Two links to the same ISP
(one as backup only)
• Router C Configuration (main link)
router bgp 100
 neighbor 122.102.10.1 remote-as 65534
 neighbor 122.102.10.1 default-originate
 neighbor 122.102.10.1 prefix-list Customer in
 neighbor 122.102.10.1 prefix-list default out
!
ip prefix-list Customer permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0

64
64
64
SANOG 8
Two links to the same ISP
(one as backup only)
• Router D Configuration (backup link)
router bgp 100
 neighbor 122.102.10.5 remote-as 65534
 neighbor 122.102.10.5 default-originate
 neighbor 122.102.10.5 prefix-list Customer in
 neighbor 122.102.10.5 prefix-list default out
!
ip prefix-list Customer permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0

65
65
65
SANOG 8
Two links to the same ISP
(one as backup only)
• Router E Configuration
router bgp 100
 neighbor 122.102.10.17 remote-as 110
 neighbor 122.102.10.17 remove-private-AS
 neighbor 122.102.10.17 prefix-list Customer out
!
ip prefix-list Customer permit 121.10.0.0/19
• Router E removes the private AS and
customer’s subprefixes from external
announcements
• Private AS still visible inside AS100

66
SANOG 8
Two links to the same ISP
With Loadsharing

67
67
67
SANOG 8
Loadsharing to the same ISP
• More common case
• End sites tend not to buy circuits and leave them
idle, only used for backup as in previous
example
• This example assumes equal capacity circuits
Unequal capacity circuits requires more refinement –
see later

68
68
68
SANOG 8
Loadsharing to the same ISP
AS 100
AS 65534
AA
CC
• Border router E in AS100 removes private AS and any
customer subprefixes from Internet announcement
DD
EE
BB
Link one
Link two

69
69
69
SANOG 8
Loadsharing to the same ISP
• Announce /19 aggregate on each link
• Split /19 and announce as two /20s, one on each link
basic inbound loadsharing
assumes equal circuit capacity and even spread of traffic across
address block
• Vary the split until “perfect” loadsharing achieved
• Accept the default from upstream
basic outbound loadsharing by nearest exit
okay in first approx as most ISP and end-site traffic is inbound

70
70
70
SANOG 8
Loadsharing to the same ISP
• Router A Configuration
router bgp 65534
 network 121.10.0.0 mask 255.255.224.0
 network 121.10.0.0 mask 255.255.240.0
 neighbor 122.102.10.2 remote-as 100
 neighbor 122.102.10.2 prefix-list routerC out
 neighbor 122.102.10.2 prefix-list default in
!
ip prefix-list default permit 0.0.0.0/0
ip prefix-list routerC permit 121.10.0.0/20
ip prefix-list routerC permit 121.10.0.0/19
!
ip route 121.10.0.0 255.255.240.0 null0
ip route 121.10.0.0 255.255.224.0 null0
Router B configuration is similar but with the other /20

71
71
71
SANOG 8
Loadsharing to the same ISP
• Router C Configuration
router bgp 100
 neighbor 122.102.10.1 remote-as 65534
 neighbor 122.102.10.1 default-originate
 neighbor 122.102.10.1 prefix-list Customer in
 neighbor 122.102.10.1 prefix-list default out
!
ip prefix-list Customer permit 121.10.0.0/19 le 20
ip prefix-list default permit 0.0.0.0/0
• Router C only allows in /19 and /20 prefixes from
customer block
• Router D configuration is identical

72
72
72
SANOG 8
Loadsharing to the same ISP
• Loadsharing configuration is only on customer
router
• Upstream ISP has to
remove customer subprefixes from external
announcements
remove private AS from external announcements
• Could also use BGP communities

73
SANOG 8
Two links to the same ISP
Multiple Dualhomed Customers (RFC2270)

74
74
74
SANOG 8
Multiple Dualhomed Customers
(RFC2270)
• Unusual for an ISP just to have one dualhomed customer
Valid/valuable service offering for an ISP with multiple PoPs
Better for ISP than having customer multihome with another
provider!
• Look at scaling the configuration
⇒ Simplifying the configuration
Using templates, peer-groups, etc
Every customer has the same configuration (basically)

75
75
75
SANOG 8
Multiple Dualhomed Customers
(RFC2270)
AS 100
AS 65534
A1
A1
CC
• Border router E in AS100 removes
private AS and any customer
subprefixes from Internet announcement
DD
EE
B1
B1
AS 65534
A2
A2
B2
B2
AS 65534
A3
A3
B3
B3

76
76
76
SANOG 8
Multiple Dualhomed Customers
• Customer announcements as per previous
example
• Use the same private AS for each customer
documented in RFC2270
address space is not overlapping
each customer hears default only
• Router An and Bn configuration same as Router
A and B previously

77
77
77
SANOG 8
Multiple Dualhomed Customers
• Router A1 Configuration
router bgp 65534
 network 121.10.0.0 mask 255.255.224.0
 network 121.10.0.0 mask 255.255.240.0
 neighbor 122.102.10.2 remote-as 100
 neighbor 122.102.10.2 prefix-list routerC out
 neighbor 122.102.10.2 prefix-list default in
!
ip prefix-list default permit 0.0.0.0/0
ip prefix-list routerC permit 121.10.0.0/20
ip prefix-list routerC permit 121.10.0.0/19
!
ip route 121.10.0.0 255.255.240.0 null0
ip route 121.10.0.0 255.255.224.0 null0
Router B1 configuration is similar but for the other /20

78
78
78
SANOG 8
Multiple Dualhomed Customers
• Router C Configuration
router bgp 100
 neighbor bgp-customers peer-group
 neighbor bgp-customers remote-as 65534
 neighbor bgp-customers default-originate
 neighbor bgp-customers prefix-list default out
 neighbor 122.102.10.1 peer-group bgp-customers
 neighbor 122.102.10.1 description Customer One
 neighbor 122.102.10.1 prefix-list Customer1 in
 neighbor 122.102.10.9 peer-group bgp-customers
 neighbor 122.102.10.9 description Customer Two
 neighbor 122.102.10.9 prefix-list Customer2 in

79
79
79
SANOG 8
Multiple Dualhomed Customers
 neighbor 122.102.10.17 peer-group bgp-customers
 neighbor 122.102.10.17 description Customer Three
 neighbor 122.102.10.17 prefix-list Customer3 in
!
ip prefix-list Customer1 permit 121.10.0.0/19 le 20
ip prefix-list Customer2 permit 121.16.64.0/19 le 20
ip prefix-list Customer3 permit 121.14.192.0/19 le 20
ip prefix-list default permit 0.0.0.0/0
• Router C only allows in /19 and /20 prefixes
from customer block
• Router D configuration is almost identical

80
80
80
SANOG 8
Multiple Dualhomed Customers
• Router E Configuration
assumes customer address space is not part of
upstream’s address block
router bgp 100
 neighbor 122.102.10.17 remote-as 110
 neighbor 122.102.10.17 remove-private-AS
 neighbor 122.102.10.17 prefix-list Customers out
!
ip prefix-list Customers permit 121.10.0.0/19
ip prefix-list Customers permit 121.16.64.0/19
ip prefix-list Customers permit 121.14.192.0/19
• Private AS still visible inside AS100

81
81
81
SANOG 8
Multiple Dualhomed Customers
• If customers’ prefixes come from
ISP’s address block
do NOT announce them to the Internet
announce ISP aggregate only
• Router E configuration:
router bgp 100
 neighbor 122.102.10.17 remote-as 110
 neighbor 122.102.10.17 prefix-list my-aggregate out
!
ip prefix-list my-aggregate permit 121.8.0.0/13

82
SANOG 8
Basic Multihoming
Multihoming to different ISPs

83
83
83
SANOG 8
Two links to different ISPs
• Use a Public AS
Or use private AS if agreed with the other ISP
But some people don’t like the “inconsistent-AS” which
results from use of a private-AS
• Address space comes from
both upstreams or
Regional Internet Registry
• Configuration concepts very similar

84
84
84
SANOG 8
Inconsistent-AS?
• Viewing the prefixes
originated by AS65534 in the
Internet shows they appear to
be originated by both AS210
and AS200
This is NOT bad
Nor is it illegal
• Cisco IOS command is
show ip bgp inconsistent-as
AS 200
AS 65534
AS 210
Internet

85
SANOG 8
Two links to different ISPs
One link primary, the other link backup only

86
86
86
SANOG 8
Two links to different ISPs
(one as backup only)
• Announce /19 aggregate on each link
primary link makes standard announcement
backup link lengthens the AS PATH by using AS
PATH prepend
• When one link fails, the announcement of the
/19 aggregate via the other link ensures
continued connectivity

87
87
87
SANOG 8
AS 100
AS 120
AS 130
CC
DD
Two links to different ISPs
(one as backup only)
Announce /19 block
with longer AS PATH
Internet
Announce /19 block
BB
AA

88
88
88
SANOG 8
Two links to different ISPs
(one as backup only)
• Router A Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 100
 neighbor 122.102.10.1 prefix-list aggregate out
 neighbor 122.102.10.1 prefix-list default in
!
ip prefix-list aggregate permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0

89
89
89
SANOG 8
Two links to different ISPs
(one as backup only)
• Router B Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 neighbor 120.1.5.1 remote-as 120
 neighbor 120.1.5.1 prefix-list aggregate out
 neighbor 120.1.5.1 route-map routerD-out out
 neighbor 120.1.5.1 prefix-list default in
 neighbor 120.1.5.1 route-map routerD-in in
!
ip prefix-list aggregate permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
route-map routerD-out permit 10
 set as-path prepend 130 130 130
!
route-map routerD-in permit 10
 set local-preference 80

90
90
90
SANOG 8
Two links to different ISPs
(one as backup only)
• Not a common situation as most sites tend
to prefer using whatever capacity they
have
• But it shows the basic concepts of using
local-prefs and AS-path prepends for
engineering traffic in the chosen direction

91
SANOG 8
Two links to different ISPs
With Loadsharing

92
92
92
SANOG 8
Two links to different ISPs
(with loadsharing)
• Announce /19 aggregate on each link
• Split /19 and announce as two /20s, one on
each link
basic inbound loadsharing
• When one link fails, the announcement of the
/19 aggregate via the other ISP ensures
continued connectivity

93
93
93
SANOG 8
AS 100
AS 120
AS 130
CC
DD
Two links to different ISPs
(with loadsharing)
Announce second
/20 and /19 block
Internet
Announce first
/20 and /19 block
BB
AA

94
94
94
SANOG 8
Two links to different ISPs
(with loadsharing)
• Router A Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 network 121.10.0.0 mask 255.255.240.0
 neighbor 122.102.10.1 remote-as 100
 neighbor 122.102.10.1 prefix-list firstblock out
 neighbor 122.102.10.1 prefix-list default in
!
ip prefix-list default permit 0.0.0.0/0
!
ip prefix-list firstblock permit 121.10.0.0/20
ip prefix-list firstblock permit 121.10.0.0/19

95
95
95
SANOG 8
Two links to different ISPs
(with loadsharing)
• Router B Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 network 121.10.16.0 mask 255.255.240.0
 neighbor 120.1.5.1 remote-as 120
 neighbor 120.1.5.1 prefix-list secondblock out
 neighbor 120.1.5.1 prefix-list default in
!
ip prefix-list default permit 0.0.0.0/0
!
ip prefix-list secondblock permit 121.10.16.0/20
ip prefix-list secondblock permit 121.10.0.0/19

96
96
96
SANOG 8
Two links to different ISPs
(with loadsharing)
• Loadsharing in this case is very basic
• But shows the first steps in designing a
load sharing solution
Start with a simple concept
And build on it…!

97
SANOG 8
Two links to different ISPs
More Controlled Loadsharing

98
98
98
SANOG 8
Loadsharing with different ISPs
• Announce /19 aggregate on each link
On first link, announce /19 as normal
On second link, announce /19 with longer AS PATH,
and announce one /20 subprefix
controls loadsharing between upstreams and the
Internet
• Vary the subprefix size and AS PATH length
until “perfect” loadsharing achieved
• Still require redundancy!

99
99
99
SANOG 8
AS 100
AS 120
AS 130
CC
DD
Loadsharing with different ISPs
Announce /20 subprefix, and
/19 block with longer AS path
Internet
Announce /19 block
BB
AA

100
100
100
SANOG 8
Loadsharing with different ISPs
• Router A Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 100
 neighbor 122.102.10.1 prefix-list default in
 neighbor 122.102.10.1 prefix-list aggregate out
!
ip prefix-list aggregate permit 121.10.0.0/19

101
101
101
SANOG 8
Loadsharing with different ISPs
• Router B Configuration
router bgp 130
 network 121.10.0.0 mask 255.255.224.0
 network 121.10.16.0 mask 255.255.240.0
 neighbor 120.1.5.1 remote-as 120
 neighbor 120.1.5.1 prefix-list default in
 neighbor 120.1.5.1 prefix-list subblocks out
 neighbor 120.1.5.1 route-map routerD out
!
route-map routerD permit 10
 match ip address prefix-list aggregate
 set as-path prepend 130 130
route-map routerD permit 20
!
ip prefix-list subblocks permit 121.10.0.0/19 le 20
ip prefix-list aggregate permit 121.10.0.0/19

102
102
102
SANOG 8
Loadsharing with different ISPs
• This example is more commonplace
• Shows how ISPs and end-sites subdivide
address space frugally, as well as use the
AS-PATH prepend concept to optimise the
load sharing between different ISPs
• Notice that the /19 aggregate block is
ALWAYS announced

103
103
103
SANOG 8
BGP Multihoming Techniques
• Why Multihome?
• Definition & Options
• Preparing the Network
• Basic Multihoming
• “BGP Traffic Engineering”
• Internet Exchange Points

104
SANOG 8
Service Provider
Multihoming
BGP Traffic Engineering

105
105
105
SANOG 8
Service Provider Multihoming
• Previous examples dealt with loadsharing
inbound traffic
Of primary concern at Internet edge
What about outbound traffic?
• Transit ISPs strive to balance traffic flows in both
directions
Balance link utilisation
Try and keep most traffic flows symmetric
Some edge ISPs try and do this too
• The original “Traffic Engineering”

106
106
106
SANOG 8
Service Provider Multihoming
• Balancing outbound traffic requires inbound
routing information
Common solution is “full routing table”
Rarely necessary
Why use the “routing mallet” to try solve loadsharing
problems?
“Keep It Simple” is often easier (and $$$ cheaper) than
carrying N-copies of the full routing table

107
107
107
SANOG 8
Service Provider Multihoming
MYTHS!!
•
Common MYTHS
•
1: You need the full routing table to multihome
People who sell router memory would like you to believe this
Only true if you are a transit provider
Full routing table can be a significant hindrance to multihoming
•
2: You need a BIG router to multihome
Router size is related to data rates, not running BGP
In reality, to multihome, your router needs to:
Have two interfaces,
Be able to talk BGP to at least two peers,
Be able to handle BGP attributes,
Handle at least one prefix
•
3: BGP is complex
In the wrong hands, yes it can be! Keep it Simple!

108
108
108
SANOG 8
Service Provider Multihoming:
Some Strategies
• Take the prefixes you need to aid traffic
engineering
Look at NetFlow data for popular sites
• Prefixes originated by your immediate
neighbours and their neighbours will do more to
aid load balancing than prefixes from ASNs
many hops away
Concentrate on local destinations
• Use default routing as much as possible
Or use the full routing table with care

109
109
109
SANOG 8
Service Provider Multihoming
• Examples
One upstream, one local peer
Two upstreams, one local peer
One upstream, local exchange point
• Require BGP and a public ASN
• Examples assume that the local network has
their own /19 address block

110
SANOG 8
Service Provider
Multihoming
One upstream, one local peer

111
111
111
SANOG 8
One Upstream, One Local Peer
• Very common situation in many regions of the
Internet
• Connect to upstream transit provider to see the
“Internet”
• Connect to the local competition so that local
traffic stays local
Saves spending valuable $ on upstream transit costs
for local traffic

112
112
112
SANOG 8
One Upstream, One Local Peer
AS 110
CC
AA
Upstream ISP
AS130
Local Peer
AS120

113
113
113
SANOG 8
One Upstream, One Local Peer
• Announce /19 aggregate on each link
• Accept default route only from upstream
Either 0.0.0.0/0 or a network which can be used as
default
• Accept all routes from local peer

114
114
114
SANOG 8
One Upstream, One Local Peer
• Router A Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.2 remote-as 120
 neighbor 122.102.10.2 prefix-list my-block out
 neighbor 122.102.10.2 prefix-list AS120-peer in
!
ip prefix-list AS120-peer permit 122.5.16.0/19
ip prefix-list AS120-peer permit 121.240.0.0/20
ip prefix-list my-block permit 121.10.0.0/19
!
ip route 121.10.0.0 255.255.224.0 null0
Prefix filters
inbound

115
115
115
SANOG 8
• Router A – Alternative Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.2 remote-as 120
 neighbor 122.102.10.2 prefix-list my-block out
 neighbor 122.102.10.2 filter-list 10 in
!
ip as-path access-list 10 permit ^(120_)+$
!
ip prefix-list my-block permit 121.10.0.0/19
!
ip route 121.10.0.0 255.255.224.0 null0
One Upstream, One Local Peer
AS Path filters –
more “trusting”

116
116
116
SANOG 8
One Upstream, One Local Peer
• Router C Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list default in
 neighbor 122.102.10.1 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0

117
117
117
SANOG 8
One Upstream, One Local Peer
• Two configurations possible for Router A
Filter-lists assume peer knows what they are
doing
Prefix-list higher maintenance, but safer
Some ISPs use both
• Local traffic goes to and from local peer,
everything else goes to upstream

118
118
118
SANOG 8
Aside:
Configuration Recommendation
• Private Peers
The peering ISPs exchange prefixes they originate
Sometimes they exchange prefixes from neighbouring ASNs
too
• Be aware that the private peer eBGP router should carry
only the prefixes you want the private peer to receive
Otherwise they could point a default route to you and
unintentionally transit your backbone

119
SANOG 8
Service Provider
Multihoming
Two Upstreams, One local peer

120
120
120
SANOG 8
Two Upstreams, One Local Peer
• Connect to both upstream transit providers to
see the “Internet”
Provides external redundancy and diversity – the
reason to multihome
• Connect to the local peer so that local traffic
stays local
Saves spending valuable $ on upstream transit costs
for local traffic

121
121
121
SANOG 8
Two Upstreams, One Local Peer
AS 110
CC
AA
Upstream ISP
AS140
Local Peer
AS120
DD
Upstream ISP
AS130

122
122
122
SANOG 8
Two Upstreams, One Local Peer
• Announce /19 aggregate on each link
• Accept default route only from upstreams
Either 0.0.0.0/0 or a network which can be used as
default
• Accept all routes from local peer

123
123
123
SANOG 8
Two Upstreams, One Local Peer
• Router A
Same routing configuration as in example with
one upstream and one local peer
Same hardware configuration

124
124
124
SANOG 8
Two Upstreams, One Local Peer
• Router C Configuration
  router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list default in
 neighbor 122.102.10.1 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0

125
125
125
SANOG 8
Two Upstreams, One Local Peer
• Router D Configuration
  router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.5 remote-as 140
 neighbor 122.102.10.5 prefix-list default in
 neighbor 122.102.10.5 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0

126
126
126
SANOG 8
Two Upstreams, One Local Peer
• This is the simple configuration for Router C
and D
• Traffic out to the two upstreams will take
nearest exit
Inexpensive routers required
This is not useful in practice especially for
international links
Loadsharing needs to be better

127
127
127
SANOG 8
Two Upstreams, One Local Peer
• Better configuration options:
Accept full routing from both upstreams
Expensive & unnecessary!
Accept default from one upstream and some
routes from the other upstream
The way to go!

128
128
128
SANOG 8
Two Upstreams, One Local Peer
Full Routes
• Router C Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list rfc1918-deny in
 neighbor 122.102.10.1 prefix-list my-block out
 neighbor 122.102.10.1 route-map AS130-loadshare in
!
ip prefix-list my-block permit 121.10.0.0/19
! See www.cymru.com/Documents/bogon-list.html
! ...for “RFC1918 and friends” list
..next slide
Allow all prefixes in
apart from RFC1918
and friends

129
129
129
SANOG 8
Two Upstreams, One Local Peer
Full Routes
ip route 121.10.0.0 255.255.224.0 null0
!
ip as-path access-list 10 permit ^(130_)+$
ip as-path access-list 10 permit ^(130_)+_[0-9]+$
!
route-map AS130-loadshare permit 10
 match ip as-path 10
 set local-preference 120
route-map AS130-loadshare permit 20
 set local-preference 80
!

130
130
130
SANOG 8
Two Upstreams, One Local Peer
Full Routes
• Router D Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.5 remote-as 140
 neighbor 122.102.10.5 prefix-list rfc1918-deny in
 neighbor 122.102.10.5 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
! See www.cymru.com/Documents/bogon-list.html
! ...for “RFC1918 and friends” list
Allow all prefixes in
apart from RFC1918
and friends

131
131
131
SANOG 8
Two Upstreams, One Local Peer
Full Routes
• Router C configuration:
Accept full routes from AS130
Tag prefixes originated by AS130 and AS130’s neighbouring
ASes with local preference 120
Traffic to those ASes will go over AS130 link
Remaining prefixes tagged with local preference of 80
Traffic to other all other ASes will go over the link to
AS140
• Router D configuration same as Router C without
the route-map

132
132
132
SANOG 8
Two Upstreams, One Local Peer
Full Routes
• Full routes from upstreams
Expensive – needs lots of memory and CPU
Need to play preference games
Previous example is only an example – real life will
need improved fine-tuning!
Previous example doesn’t consider inbound traffic –
see earlier in presentation for examples

133
133
133
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Strategy:
Ask one upstream for a default route
Easy to originate default towards a BGP neighbour
Ask other upstream for a full routing table
Then filter this routing table based on neighbouring ASN
E.g. want traffic to their neighbours to go over the link to
that ASN
Most of what upstream sends is thrown away
Easier than asking the upstream to set up custom BGP
filters for you

134
134
134
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Router C Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list rfc1918-nodef-deny in
 neighbor 122.102.10.1 prefix-list my-block out
 neighbor 122.102.10.1 filter-list 10 in
 neighbor 122.102.10.1 route-map tag-default-low in
!
..next slide
Allow all prefixes
and default in; deny
RFC1918 and friends
AS filter list filters
prefixes based on
origin ASN

135
135
135
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0
  !
  ip as-path access-list 10 permit ^(130_)+$
ip as-path access-list 10 permit ^(130_)+_[0-9]+$
!
route-map tag-default-low permit 10
 match ip address prefix-list default
 set local-preference 80
route-map tag-default-low permit 20
!

136
136
136
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Router D Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.5 remote-as 140
 neighbor 122.102.10.5 prefix-list default in
 neighbor 122.102.10.5 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0

137
137
137
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Router C configuration:
Accept full routes from AS130
(or get them to send less)
Filter ASNs so only AS130 and AS130’s neighbouring ASes
are accepted
Allow default, and set it to local preference 80
Traffic to those ASes will go over AS130 link
Traffic to other all other ASes will go over the link to AS140
If AS140 link fails, backup via AS130 – and vice-versa

138
138
138
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Partial routes from upstreams
Not expensive – only carry the routes necessary for
loadsharing
Need to filter on AS paths
Previous example is only an example – real life will
need improved fine-tuning!
Previous example doesn’t consider inbound traffic –
see earlier in presentation for examples

139
139
139
SANOG 8
Two Upstreams, One Local Peer
• When upstreams cannot or will not
announce default route
Because of operational policy against using
“default-originate” on BGP peering
Solution is to use IGP to propagate default
from the edge/peering routers

140
140
140
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Router C Configuration
router ospf 110
   default-information originate metric 30
   passive-interface Serial 0/0
  !
  router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list rfc1918-deny in
 neighbor 122.102.10.1 prefix-list my-block out
 neighbor 122.102.10.1 filter-list 10 in
!
..next slide

141
141
141
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
ip prefix-list my-block permit 121.10.0.0/19
! See www.cymru.com/Documents/bogon-list.html
! ...for “RFC1918 and friends” list
!
ip route 121.10.0.0 255.255.224.0 null0
ip route 0.0.0.0 0.0.0.0 serial 0/0 254
!
ip as-path access-list 10 permit ^(130_)+$
ip as-path access-list 10 permit ^(130_)+_[0-9]+$
  !

142
142
142
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Router D Configuration
router ospf 110
   default-information originate metric 10
   passive-interface Serial 0/0
  !
  router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.5 remote-as 140
 neighbor 122.102.10.5 prefix-list deny-all in
 neighbor 122.102.10.5 prefix-list my-block out
!
..next slide

143
143
143
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
  ip prefix-list deny-all deny 0.0.0.0/0 le 32
  ip prefix-list my-block permit 121.10.0.0/19
!
  ip route 121.10.0.0 255.255.224.0 null0
  ip route 0.0.0.0 0.0.0.0 serial 0/0 254
!

144
144
144
SANOG 8
Two Upstreams, One Local Peer
Partial Routes
• Partial routes from upstreams
Use OSPF to determine outbound path
Router D default has metric 10 – primary outbound path
Router C default has metric 30 – backup outbound path
Serial interface goes down, static default is removed
from routing table, OSPF default withdrawn

145
145
145
SANOG 8
Aside:
Configuration Recommendation
• When distributing internal default by iBGP or OSPF
Make sure that routers connecting to private peers or to IXPs
do NOT carry the default route
Otherwise they could point a default route to you and
unintentionally transit your backbone
Simple fix for Private Peer/IXP routers:
ip route 0.0.0.0 0.0.0.0 null0

146
SANOG 8
Service Provider
Multihoming
One Upstream, Local Exchange Point

147
147
147
SANOG 8
One Upstream, Local Exchange Point
• Very common situation in many regions of the Internet
• Connect to upstream transit provider to see the “Internet”
• Connect to the local Internet Exchange Point so that local
traffic stays local
Saves spending valuable $ on upstream transit costs for
local traffic

148
148
148
SANOG 8
One Upstream, Local Exchange Point
AS 110
CC
AA
Upstream ISP
AS130
IXP

149
149
149
SANOG 8
One Upstream, Local Exchange Point
• Announce /19 aggregate to every
neighbouring AS
• Accept default route only from upstream
Either 0.0.0.0/0 or a network which can be used as
default
• Accept all routes originated by IXP peers

150
150
150
SANOG 8
One Upstream, Local Exchange Point
• Router A Configuration
interface fastethernet 0/0
 description Exchange Point LAN
 ip address 120.5.10.1 mask 255.255.255.224
 ip verify unicast reverse-path
!
router bgp 110
 neighbor ixp-peers peer-group
 neighbor ixp-peers prefix-list my-block out
 neighbor ixp-peers remove-private-AS
 neighbor ixp-peers route-map set-local-pref in
..next slide

151
151
151
SANOG 8
One Upstream, Local Exchange Point
 neighbor 120.5.10.2 remote-as 100
 neighbor 120.5.10.2 peer-group ixp-peers
 neighbor 120.5.10.2 prefix-list peer100 in
 neighbor 120.5.10.3 remote-as 101
 neighbor 120.5.10.3 peer-group ixp-peers
 neighbor 120.5.10.3 prefix-list peer101 in
 neighbor 120.5.10.4 remote-as 102
 neighbor 120.5.10.4 peer-group ixp-peers
 neighbor 120.5.10.4 prefix-list peer102 in
 neighbor 120.5.10.5 remote-as 103
 neighbor 120.5.10.5 peer-group ixp-peers
 neighbor 120.5.10.5 prefix-list peer103 in
..next slide

152
152
152
SANOG 8
One Upstream, Local Exchange Point
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list peer100 permit 122.0.0.0/19
ip prefix-list peer101 permit 122.30.0.0/19
ip prefix-list peer102 permit 122.12.0.0/19
ip prefix-list peer103 permit 122.18.128.0/19
!
route-map set-local-pref permit 10
 set local-preference 150
!

153
153
153
SANOG 8
One Upstream, Local Exchange
• Note that Router A does not generate the aggregate for AS110
If Router A becomes disconnected from backbone, then the
aggregate is no longer announced to the IX
BGP failover works as expected
• Note the inbound route-map which sets the local preference
higher than the default
This ensures that local traffic crosses the IXP
(And avoids potential problems with uRPF check)

154
154
154
SANOG 8
One Upstream, Local Exchange Point
• Router C Configuration
router bgp 110
 network 121.10.0.0 mask 255.255.224.0
 neighbor 122.102.10.1 remote-as 130
 neighbor 122.102.10.1 prefix-list default in
 neighbor 122.102.10.1 prefix-list my-block out
!
ip prefix-list my-block permit 121.10.0.0/19
ip prefix-list default permit 0.0.0.0/0
!
ip route 121.10.0.0 255.255.224.0 null0

155
155
155
SANOG 8
One Upstream, Local Exchange Point
• Note Router A configuration
Prefix-list higher maintenance, but safer
uRPF on the IX facing interface
No generation of AS110 aggregate
• IXP traffic goes to and from local IXP,
everything else goes to upstream

156
156
156
SANOG 8
Aside:
IXP Configuration Recommendation
•
IXP peers
The peering ISPs at the IXP exchange prefixes they originate
Sometimes they exchange prefixes from neighbouring ASNs too
•
Be aware that the IXP border router should carry only the prefixes
you want the IXP peers to receive and the destinations you want
them to be able to reach
Otherwise they could point a default route to you and
unintentionally transit your backbone
•
If IXP router is at IX, and distant from your backbone
Don’t originate your address block at your IXP router

157
SANOG 8
Internet Exchange Points
Bill Woodcock <woody@pch.net>

