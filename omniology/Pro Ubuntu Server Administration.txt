www.it-ebooks.info

Pro Ubuntu Server 
Administration
Sander van Vugt
www.it-ebooks.info

Pro Ubuntu Server Administration
Copyright © 2009 by Sander van Vugt
All rights reserved. No part of this work may be reproduced or transmitted in any form or by any means, 
electronic or mechanical, including photocopying, recording, or by any information storage or retrieval 
system, without the prior written permission of the copyright owner and the publisher.
ISBN-13 (pbk):  978-1-4302-1622- 3
ISBN-13 (electronic):  978-1-4302-1623- 0
Printed and bound in the United States of America 9 8 7 6 5 4 3 2 1
Trademarked names may appear in this book. Rather than use a trademark symbol with every occurrence 
of a trademarked name, we use the names only in an editorial fashion and to the benefit of the trademark 
owner, with no intention of infringement of the trademark.
Lead Editor: Frank Pohlmann
Technical Reviewer: Samuel Cuella
Editorial Board: Clay Andres, Steve Anglin, Mark Beckner, Ewan Buckingham, Tony Campbell,  
Gary Cornell, Jonathan Gennick, Michelle Lowman, Matthew Moodie, Jeffrey Pepper, Frank Pohlmann, 
Ben  Renow- Clarke, Dominic Shakeshaft, Matt Wade, Tom Welsh
Project Manager: Beth Christmas
Copy Editor: Bill McManus
Associate Production Director: Kari  Brooks- Copony
Production Editor: Elizabeth Berry
Compositor: Linda Weidemann
Proofreader: Liz Welch
Indexer: Becky Hornyak
Artist: April Milne
Cover Designer: Kurt Krames
Manufacturing Director: Tom Debolski
Distributed to the book trade worldwide by  Springer- Verlag New York, Inc., 233 Spring Street, 6th Floor, 
New York, NY 10013. Phone  1-800- SPRINGER, fax  201-348- 4505,  e-mail kn`ano)ju<olnejcan)o^i*_om, 
or visit dppl6++sss*olnejcankjheja*_ki. 
For information on translations, please contact Apress directly at 2855 Telegraph Avenue, Suite 600, 
Berkeley, CA 94705. Phone  510-549- 5930, fax  510-549- 5939,  e-mail ejbk<]lnaoo*_ki, or visit dppl6++
sss*]lnaoo*_ki. 
Apress and friends of ED books may be purchased in bulk for academic, corporate, or promotional 
use. eBook versions and licenses are also available for most titles. For more information, reference our 
Special Bulk Sales–eBook Licensing web page at dppl6++sss*]lnaoo*_ki+ejbk+^qhgo]hao.
The information in this book is distributed on an “as is” basis, without warranty. Although every pre-
caution has been taken in the preparation of this work, neither the author(s) nor Apress shall have any 
liability to any person or entity with respect to any loss or damage caused or alleged to be caused directly 
or indirectly by the information contained in this work. 
www.it-ebooks.info

This book is dedicated to Florence.  
And the next, and the next, and all of them, always.
www.it-ebooks.info

v
Contents at a Glance
Foreword . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xv
About the Author . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xvii
About the Technical Reviewer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xix
Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxi
CHAPTER 1 
Performing an Advanced Ubuntu Server Installation . . . . . . . . . . . . . . . 1
CHAPTER 2 
Using Ubuntu Server for System Imaging . . . . . . . . . . . . . . . . . . . . . . . . 29
CHAPTER 3 
Performance Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45
CHAPTER 4 
Performance Optimization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83
CHAPTER 5 
Advanced File System Management . . . . . . . . . . . . . . . . . . . . . . . . . . . . 109
CHAPTER 6 
Network Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 131
CHAPTER 7 
Creating an Open Source SAN  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 161
CHAPTER 8 
Configuring OpenLDAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
CHAPTER 9 
Integrating Samba  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231
CHAPTER 10 
Configuring Ubuntu Server As a Mail Server . . . . . . . . . . . . . . . . . . . . 249
CHAPTER 11 
Managing Ubuntu Server Security . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281
CHAPTER 12 
Configuring Ubuntu Server As a VPN Server  . . . . . . . . . . . . . . . . . . . . 303
CHAPTER 13 
Configuring Kerberos and NTP on Ubuntu Server . . . . . . . . . . . . . . . . 321
CHAPTER 14 
Ubuntu Server Troubleshooting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 343
INDEX  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 383
www.it-ebooks.info

vii
Contents
Foreword . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xv
About the Author . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . xvii
About the Technical Reviewer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xix
Introduction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .xxi
CHAPTER 1 
Performing an Advanced Ubuntu Server Installation . . . . . . 1
What’s So Special About an Enterprise Installation? . . . . . . . . . . . . . . . . . . . 1
Server Hardware  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2
Connection to a SAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2
Authentication Handling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 3
Preparing for the Installation in a Network . . . . . . . . . . . . . . . . . . . . . . . . . . . 3
Which RAID? . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 4
Choosing a File System  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5
Installing Ubuntu Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 7
Starting the Installation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8
Creating a  Software- Based RAID Solution . . . . . . . . . . . . . . . . . . . . . . . 9
Creating LVM Logical Volumes on Top of a  
Software RAID Device  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
Completing the Installation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22
Post-Installation Tasks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24
Setting Up NIC Bonding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24
Setting Up Multipathing. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 28
www.it-ebooks.info

NCONTENTS
viii
CHAPTER 2 
Using Ubuntu Server for System Imaging . . . . . . . . . . . . . . . . . 29
Setting Up a Clonezilla Imaging Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29
Setting Up Diskless Remote Boot in Linux  . . . . . . . . . . . . . . . . . . . . . . . . . . 30
Installing the DRBL Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31
Configuring the DRBL Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32
Setting Up the DHCP Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33
Completing Clonezilla Configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35
Configuring the Clients for Cloning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 36
Setting Up the Server for Cloning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37
Cloning the Client . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43
CHAPTER 3 
Performance Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45
Interpreting What Your Computer Is Doing: top . . . . . . . . . . . . . . . . . . . . . . 45
CPU Monitoring with top . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46
CPU Performance Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48
Memory Monitoring with top . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 49
Process Monitoring with top. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 50
Analyzing CPU Performance  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51
Finding Memory Problems . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57
Monitoring Storage Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65
Monitoring Network Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
Performance Baselining . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 81
CHAPTER 4 
Performance Optimization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83
Strategies for Optimizing Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83
About /proc and sysctl. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83
Applying a Simple Test . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85
CPU Tuning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 87
Understanding CPU Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 87
Optimizing CPU Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 88
www.it-ebooks.info

NCONTENTS
ix
Tuning Memory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91
Understanding Memory Performance . . . . . . . . . . . . . . . . . . . . . . . . . . 91
Optimizing Memory Usage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92
Tuning Storage Performance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96
Understanding Storage Performance . . . . . . . . . . . . . . . . . . . . . . . . . . 96
Optimizing the I/O Scheduler . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97
Optimizing Reads . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98
Network Tuning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98
Tuning Kernel Parameters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 98
Optimizing TCP/IP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100
Some Hints on Samba and NFS Performance Optimization . . . . . . 105
Generic Network Performance Optimization Tips . . . . . . . . . . . . . . . 106
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 107
CHAPTER 5 
Advanced File System Management . . . . . . . . . . . . . . . . . . . . . . 109
Understanding File Systems  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 109
Inodes and Directories  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 110
Superblocks, Inode Bitmaps, and Block Bitmaps . . . . . . . . . . . . . . . 112
Journaling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114
Indexing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 115
Optimizing File Systems . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 116
Optimizing Ext2/Ext3 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 116
Tuning XFS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 124
What About ReiserFS? . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 128
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 130
CHAPTER 6 
Network Monitoring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 131
Starting with Nagios . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 131
Configuring Nagios . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 135
Location of the Configuration Files . . . . . . . . . . . . . . . . . . . . . . . . . . . 135
The Master Configuration File: nagios.cfg . . . . . . . . . . . . . . . . . . . . . 136
Creating Essential Nagios Configuration Files . . . . . . . . . . . . . . . . . . 138
www.it-ebooks.info

NCONTENTS
x
Installing NRPE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 152
Configuring NRPE on the Monitored Server . . . . . . . . . . . . . . . . . . . . 152
Configuring the Nagios Server to Use NRPE . . . . . . . . . . . . . . . . . . . 154
Managing Nagios . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 155
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 159
CHAPTER 7 
Creating an Open Source SAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 161
Preparing Your Open Source SAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
Hardware Requirements . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
Installing Required Software . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 163
Setting Up the Distributed Replicated Block Device  . . . . . . . . . . . . . . . . . 164
Accessing the SAN with iSCSI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169
Configuring the iSCSI Target . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169
Configuring the iSCSI Initiator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 173
Setting Up Heartbeat . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 175
Setting Up the Base Cluster from /etc/ha.d/ha.cf . . . . . . . . . . . . . . . 175
Configuring Cluster Resources  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180
Backing Up the Cluster Configuration . . . . . . . . . . . . . . . . . . . . . . . . . 187
Configuring STONITH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191
Heartbeat Beyond the Open Source SAN . . . . . . . . . . . . . . . . . . . . . . . . . . . 194
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 195
CHAPTER 8 
Configuring OpenLDAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
Using the LDAP Directory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197
Introducing OpenLDAP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 201
Configuring OpenLDAP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 202
Installing OpenLDAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 202
Configuring the Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203
Adding Information to the LDAP Database . . . . . . . . . . . . . . . . . . . . . 215
Using ldapsearch to Verify Your Configuration . . . . . . . . . . . . . . . . . 217
www.it-ebooks.info

NCONTENTS
xi
Using LDAP Management Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 220
Modifying Entries in the LDAP Database . . . . . . . . . . . . . . . . . . . . . . 221
Deleting Entries from the LDAP Database . . . . . . . . . . . . . . . . . . . . . 222
Changing a Password . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 222
Logging In to an LDAP Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 223
Configuring PAM for LDAP Authentication . . . . . . . . . . . . . . . . . . . . . 223
Setting Up nsswitch.conf to Find LDAP Services . . . . . . . . . . . . . . . 228
Testing LDAP Client Connectivity  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230
CHAPTER 9 
Integrating Samba . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231
Setting Up Samba the Easy Way . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 231
Creating a Local Directory to Share . . . . . . . . . . . . . . . . . . . . . . . . . . 232
Applying Permissions to the Local Directory . . . . . . . . . . . . . . . . . . . 232
Defining the Share . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 232
Creating a Samba User Account . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
Testing Access to the Share . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235
Integrating Samba with LDAP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 236
Preparing Samba to Talk to LDAP . . . . . . . . . . . . . . . . . . . . . . . . . . . . 236
Preparing LDAP to Work with Samba . . . . . . . . . . . . . . . . . . . . . . . . . 237
Telling Samba to Use LDAP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 238
Using Samba As a Primary Domain Controller . . . . . . . . . . . . . . . . . . . . . . 241
Changing the Samba Configuration File . . . . . . . . . . . . . . . . . . . . . . . 241
Creating Workstation Accounts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243
Integrating Samba in Active Directory . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 244
Making Samba a Member of the Active Directory Domain . . . . . . . 244
Using Kerberos to Make Samba a Member of Active Directory . . . 245
Authenticating Linux Users on Windows with Winbind . . . . . . . . . . . . . . . 245
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247
www.it-ebooks.info

NCONTENTS
xii
CHAPTER 10 
Configuring Ubuntu Server As a Mail Server . . . . . . . . . . . . . 249
Understanding the Components of a Mail Solution . . . . . . . . . . . . . . . . . . 249
Configuring the Postfix MTA  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 250
Handling Inbound and Outbound Mail  . . . . . . . . . . . . . . . . . . . . . . . . 251
Installing Postfix and Configuring the Initial Settings . . . . . . . . . . . . 256
Configuring Postfix Further . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 257
Managing Postfix Components . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 262
Configuring the Master Daemon . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263
Configuring Global Settings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 264
Configuring a Simple Postfix Mail Server . . . . . . . . . . . . . . . . . . . . . . 267
Tuning Postfix with Lookup Tables . . . . . . . . . . . . . . . . . . . . . . . . . . . 269
Using Postfix Management Tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . 273
Receiving  E-mail Using IMAP or POP3 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274
Fetching  E-mail Using Cyrus IMAPd . . . . . . . . . . . . . . . . . . . . . . . . . . 275
Filtering Incoming  E-mail with procmail  . . . . . . . . . . . . . . . . . . . . . . 278
Getting  E-mail with POP3 Using Qpopper . . . . . . . . . . . . . . . . . . . . . 279
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280
CHAPTER 11 
Managing Ubuntu Server Security . . . . . . . . . . . . . . . . . . . . . . . . 281
Managing Cryptography . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281
Introduction to SSL  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 282
Public and Private Keys . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 282
The Need for a Certificate Authority . . . . . . . . . . . . . . . . . . . . . . . . . . 283
Creating a Certificate Authority and Server Certificates . . . . . . . . . 284
Securing Applications with AppArmor . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 290
AppArmor Components . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 290
Installing and Starting AppArmor  . . . . . . . . . . . . . . . . . . . . . . . . . . . . 293
Creating and Managing AppArmor Profiles  . . . . . . . . . . . . . . . . . . . 294
Updating a Profile . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 299
Monitoring AppArmor’s Status . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 299
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302
www.it-ebooks.info

NCONTENTS
xiii
CHAPTER 12 
Configuring Ubuntu Server As a VPN Server . . . . . . . . . . . . . 303
Installing and Configuring OpenVPN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 303
VPN Networking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 304
Generating Certificates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305
Configuring the VPN Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 313
Configuring a Linux VPN Client . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 316
Configuring Windows Clients . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 320
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 320
CHAPTER 13 
Configuring Kerberos and NTP on Ubuntu Server . . . . . . . . 321
Configuring an NTP Time Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 321
How NTP Works . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 322
Customizing Your NTP Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327
Understanding Kerberos . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 329
Installing and Configuring Kerberos . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 330
Configuring the Kerberos Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 332
Configuring Generic Kerberos Settings  . . . . . . . . . . . . . . . . . . . . . . . 332
Configuring the KDC Settings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335
Configuring the Kerberos Client  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 339
Configuring Simple Kerberos Applications . . . . . . . . . . . . . . . . . . . . . 339
Logging In with Kerberos . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 340
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341
CHAPTER 14 
Ubuntu Server Troubleshooting . . . . . . . . . . . . . . . . . . . . . . . . . . . 343
Identifying the Problem . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 344
Troubleshooting Tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351
Working with init=/bin/bash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 351
Rescue a Broken System . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 353
Working with a Knoppix Rescue CD . . . . . . . . . . . . . . . . . . . . . . . . . . 357
www.it-ebooks.info

NCONTENTS
xiv
Common Problems and How to Fix Them . . . . . . . . . . . . . . . . . . . . . . . . . . 360
Grub Errors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 361
No Master Boot Record . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 364
Partition Problems . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 365
LVM Logical Volume Problems  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 368
Kernel Problems . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 375
File System Problems . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 378
Lost Administrator Password . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 380
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 381
INDEX  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 383
www.it-ebooks.info

xv
Several months ago, we received a post to the q^qjpq)oanran mailing list from Sander 
van Vugt. Sander explained that he was writing an advanced book on Ubuntu Server 
administration, as well as a second edition of his Beginning Ubuntu Server Administra-
tion. Sander solicited ideas and asked for feedback. Though several books have been 
published on Ubuntu Server Edition, this is the first time, to my knowledge, that feedback 
has been sought from the Ubuntu Server community. We are grateful for the chance to 
help, and some of the suggestions made by Ubuntu Server Edition’s developers and users 
appear in the pages of this book. 
This book covers Ubuntu 8.04 LTS Server Edition, sometimes referred to by its code-
name “Hardy Heron.” Ubuntu releases an LTS (Long Term Support) edition about every 
two years. The LTS designation indicates that this release will be maintained and sup-
ported for five years by Canonical Ltd., the commercial sponsor of Ubuntu. By focusing 
on the LTS edition, Sander ensures that this book will be a useful addition to your library.
I am thankful to Sander for writing a book targeted at professional administrators. 
I think that it comes at a perfect time for Ubuntu Server Edition. We worked hard to make 
Ubuntu 8.04 our most  enterprise- ready version yet, and this book is targeted at the enter-
prise administrators who need to know about Ubuntu Server’s advanced features. Among 
the new and updated features are the following:
 s  )NTEGRATED HOST FIREWALLING TO PROTECT  )NTERNET FACING SERVERS
 s  !DDED !PP!RMOR POLICIES AND INCREASED KERNEL HARDENING
 s  )NCREASED RANGE OF STORAGE CAPABILITIES INCLUDING I3#3) AND $2"$
 s  3UNS /PEN*$+ NEW TO 5BUNTU 3ERVER IN THE 5BUNTU  DISTRIBUTION  s  !CTIVE $IRECTORY INTEGRATION PROVIDED BY ,IKEWISE /PEN
 s  !DDED +6- VIRTUALIZATION SUPPORT
I think the fact that this book is focused on the enterprise users, that it covers the 
LTS edition, and that Sander asked for Ubuntu Server community feedback all add up to 
making this a good book. I hope that it is useful to you, and helps you in your adoption of 
Ubuntu Server Edition.
Foreword
www.it-ebooks.info

NFOREWORD
xvi
/NE LAST WORD ABOUT THE 5BUNTU 3ERVER COMMUNITY 4HOUGH 5BUNTU HAS A CORPORATE sponsor, a large portion of the work is done by the community. Who is the community? 
Anyone who submits a bug report, helps package applications, writes documentation, 
answers questions from other users on the mailing list or IRC, or helps testing. We would 
love for you to get involved and help us make Ubuntu Server even better than it is now. 
I encourage you to visit dpplo6++sege*q^qjpq*_ki+OanranPa]i+ for more information. 
Rick Clark
Engineering Manager, Ubuntu Server Edition
www.it-ebooks.info

xvii
About the Author
NSANDER VAN VUGT is an independent trainer and consultant who lives 
in the Netherlands and works in the extended EMEA (Europe, Middle 
East, and Africa) area. He specializes in Linux high availability, storage 
solutions, and performance problems, and has successfully imple-
mented Linux clusters across the globe. Sander has written several 
books about  Linux- related subjects, including The Definitive Guide to 
SUSE Linux Enterprise Server (Apress, 2006) and Beginning Ubuntu 
Server Administration (Apress, 2008).
Sander’s articles can be found on several international web sites and in magazines 
such as SearchEnterpriseLinux.com, Linux Journal, and Linux Magazine. He works as 
a volunteer for the Linux Professional Institute (LPI), contributing topics for different 
certification levels. Most important, Sander is the father of Alex and Franck, and is the 
loving husband of Florence. For more information, consult Sander’s web site: sss*
o]j`anr]jrqcp*_ki. Sander can be reached by  e-mail at i]eh<o]j`anr]jrqcp*_ki.
www.it-ebooks.info

xix
NSAMUEL CUELLA, born in 1985, currently is an IT student and works as a Linux/Solaris 
trainer. Samuel taught the complete Mandriva certification program in China (JUST Uni-
versity) and also teaches Linux for LPI certification training. He is a Novell Certified Linux 
Professional (CLP).
About the Technical Reviewer
www.it-ebooks.info

xxi
This book is about advanced Ubuntu Server administration. In this book you will read 
about topics that normally are of interest to experienced administrators. The typical 
reader of this book will already know how to handle basic tasks such as managing files, 
users, permissions, and services such as Apache and Samba.
I have written this book around some major themes. First of them is administering 
Ubuntu Server in the data center. This theme covers typical issues that you’ll encounter 
only when installing Ubuntu Server in an enterprise environment, such as connecting the 
server to the SAN or configuring Ubuntu Server as a Clonezilla imaging server. You’ll also 
learn how to set up high availability for services running on Ubuntu Server.
The second major theme is performance and troubleshooting. There is a chapter 
about performance monitoring and analysis, which is followed by a chapter about per-
formance optimization. You’ll also find a chapter about file system monitoring and 
optimization. The last chapter in the book provides extensive coverage of Ubuntu Server 
troubleshooting.
The next theme comprises advanced options offered by network services. You’ll learn 
HOW TO SET UP AN /PEN,$!0 $IRECTORY SERVER HOW TO CONNECT YOUR 3AMBA SERVER TO THAT Directory server, and how to configure Ubuntu Server as a mail server.
4HE LAST THEME IS SECURITY 4HIS STARTS WITH AN INTRODUCTION TO /PEN33, AND THE CON-
FIGURATION OF A CERTIFICATE AUTHORITY 4HE CHAPTER ON /PEN60. DELVES FURTHER INTO THE TOPIC of certificates, and the chapter on Kerberos shows how you can use Kerberos to set up 
secure authentication for different services. You’ll also find some  in- depth information 
about the configuration of AppArmor to protect your applications. 
I hope that this book meets your requirements and that you enjoy reading it as much 
as I have enjoyed writing it!
Introduction
www.it-ebooks.info

1
C H A P T E R  1
Performing an Advanced 
Ubuntu Server Installation
Installing Ubuntu Server 
with RAID
You know how to install Ubuntu Server. There are, however, some additional challenges 
that you may face when installing Ubuntu Server in a network. Most important of those 
challenges is that your server may need a  software- based RAID solution. If you want to 
configure your server with software RAID, and especially if you want to use LVM volumes 
on top of that, installing Ubuntu Server can be quite hard. In this chapter you’ll learn all 
you need to know about such an installation.
What’s So Special About an Enterprise 
Installation?
You may ask: what’s the big deal about an enterprise network installation of Ubuntu 
Server versus a “normal” Ubuntu Server installation? There are some important differ-
ences when installing Ubuntu Server in an enterprise environment in which other servers 
are used as well, as this section explains. First, take a look at the recommended minimal 
installation requirements for a normal server installation:
 s   -" OF 2!-
 s   -(Z #05
 s   '" HARD DRIVE
 s  /PTICAL DRIVE
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
2
The next few sections discuss some of the most significant differences between a net-
work installation and a simple  stand- alone installation.
Server Hardware
The first major difference between a demo installation in your test network and an enter-
prise network installation is in the server hardware itself. When setting up a server in an 
enterprise environment, you probably want some redundancy. You can implement that 
redundancy by making sure that some devices have a backup available. For example, 
most  data-center- grade servers have a dual power supply, two network cards, and at least 
two hard disks. The advantage? If one breaks, the server can start using the other. And the 
big deal is that all of this happens automatically. 
Some of the setup of this redundant hardware is done in the hardware itself. I don’t 
cover that in this book. Some setup can be software based as well. For example, the use 
OF SOFTWARE 2!)$ OR .)# TEAMING ALSO KNOWN AS .)# BONDING	 MAKES SURE THAT TWO network boards are presented as one single network interface. The purpose of that ? It 
can add redundancy to your network card, or if you prefer, it can increase performance 
because two network cards bundled together can handle twice the workload of a single 
network card working alone.
Connection to a SAN
Next, your SERVER MAY BE CONNECTED TO A STORAGE AREA NETWORK 3!.	 )F YOUVE NEVER worked with a SAN before, no worries—just consider it a bunch of external disks for the 
MOMENT #HAPTER  COVERS IN DEPTH SETTING UP 5BUNTU 3ERVER AS A 3!. 4YPICALLY A SPE-
CIALIZED NETWORK CARD CALLED A HOST BUS ADAPTER ("!	 TAKES CARE OF THE CONNECTION TO A 3!. 3UCH A HOST ADAPTER MAY USE I3#3) WHICH SENDS 3#3) PACKETS ENCAPSULATED IN )0 OVER A  COPPER BASED NETWORK OR IT MAY BE A &IBRE #HANNEL CARD USING AN EXPENSIVE &IBRE #HANNEL INFRASTRUCTURE If your server is connected to a SAN, you normally would want to have some redun-
DANCY IN THE 3!. AS WELL 4HIS REDUNDANCY IS IMPLEMENTED BY USING MULTIPLE ("!S THAT connect to the SAN using different network connections. Now, there is something unique 
ABOUT THIS SCENARIO .ORMALLY WHEN THE ("! IN YOUR SERVER CONNECTS TO THE 3!. IT GETS an additional storage device. For instance, if you have a local hard disk in your server, you 
would normally see it as the device +`ar+o`] )F JUST ONE ("! CONNECTS TO THE SHARED STOR-
AGE ON THE 3!. THE ("! WOULD OFFER YOUR SERVER ACCESS TO AN EXTERNAL HARD DRIVE WHICH would be seen by your server as a new storage device, typically +`ar+o`^. 
.OW IMAGINE THE SITUATION IN WHICH TWO DIFFERENT ("!S USE SEPARATE NETWORK CON-
NECTIONS TO CONNECT TO THE SAME SHARED STORAGE AREA ON THE 3!. %ACH OF THE TWO ("!S www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
3
would give you an additional external device, so you would see an additional +`ar+o`^ and 
+`ar+o`_. There is one problem with that, though: both +`ar+o`^ and +`ar+o`_ would refer 
to the same storage device! That normally is not a good idea, and that is where multipath 
comes in. When using multipath, an additional kernel module is loaded. The purpose of 
this module is to tell the operating system that the devices +`ar+o`^ and +`ar+o`_ IN THIS EXAMPLE	 ARE JUST THE SAME DEVICE !S YOU CAN UNDERSTAND WHEN CONNECTING YOUR SERVER to a redundant SAN, the configuration of multipath is an absolute requirement. 
Authentication Handling
/NE LAST difference when installing your server in a network environment is that typi-
cally you would implement an external authentication mechanism. If you have only one 
SERVER IT MAKES PERFECT SENSE TO HANDLE USER AUTHENTICATION ON THAT SERVER ITSELF (OW-
ever, if you have more than one server, it makes sense to use a service that takes care of 
AUTHENTICATION FOR YOU AT A CENTRALIZED LOCATION IN THE NETWORK 4HIS REFERS TO A SERVER THAT has already been set up in the network for this purpose. Such a service might be your 
,$!0 SERVER OR A -ICROSOFT !CTIVE $IRECTORY ENVIRONMENT 4HE 5BUNTU 3ERVER INSTALLATION process helps you to set that up as well. In the next section you’ll read all about it. 
Preparing for the Installation in a Network
You now know what to take care of when installing Ubuntu Server in a network environ-
ment. So let’s talk about the installation itself. In this section you’ll read how a typical 
server installation in a network environment takes place. I’ll assume that you have 
installed Ubuntu Server before, so I’ll be rather brief on the obvious parts, and more in 
DEPTH WITH REGARD TO THE ADVANCED PARTS OF THE INSTALLATION "EFORE YOU START THE ACTUAL installation, you should understand what I’m going to install here for purposes of 
demonstration. 
The server that you are going to read about in this section has the following 
properties:
 s  4WO  QUAD CORE PROCESSORS
 s   '" OF 2!-
 s  &IVE DISKS
 s  4WO 'IGABIT %THERNET NETWORK BOARDS
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
4
NNote You may not have the hardware described here available. That’s no problem, because you can 
create a configuration like this rather easily using virtualization software like VMware. Okay, it’s a problem 
to create two virtual CPUs with quad core each, and it will be a problem allocating 8 GB of RAM in most situ-
ations as well, but processors and RAM don’t make that big of a difference when performing the installation 
anyway. The focus here is on disk and network setup. And using a free virtualization solution like VMware 
Server, you can just create as many disks and as many Ethernet network boards as you like. 
It’s fine if your server has additional properties, but from the installation perspec-
TIVE HAVING THE PRECEDING LIST OF PROPERTIES REALLY IS ALL THAT MATTERS "EFORE YOU INSERT THE INSTALLATION #$ AND START THE INSTALLATION IT HELPS TO MAKE A PLAN -OST IMPORTANT IS THE planning of your disk setup. In a typical server installation, what you want above all is 
redundancy and performance at the same time. This means that if a disk breaks, the other 
disks should take over immediately. To reach this goal, you would probably want to work 
with some kind of RAID setup. 
Which RAID?
There are two ways to set up RAID on your server: hardware based and software based. 
If your server has a hardware RAID controller, you should consult the documentation for 
that controller. Every RAID controller is different, and there is no generic way in which 
I can describe how to set that up. If your server does not have hardware RAID, you can 
use a  software- based RAID solution. Software RAID often does not offer the same level of 
performance as hardware RAID, but the advantage is that you don’t have to pay anything 
extra to use it. When implementing software RAID, the following four methods are of 
interest:
 s  RAID 0: This RAID method IS REFERRED TO AS DISK STRIPING !CTUALLY 2!)$  JUST BUN-
dles two disks together. This is excellent for performance, because you have two 
CONTROLLERS THAT CAN HANDLE THE DATA FLOW SIMULTANEOUSLY BUT 2!)$  IS NOT BUILT FOR REDUNDANCY AND FAULT TOLERANCE )F ONE DISK IN A 2!)$  ARRAY BREAKS YOU CANT access any data on the array anymore. 
 s  RAID 1: RAID 1 is all ABOUT DISK MIRRORING /NE DISK IS USED AS THE ACTIVE DISK AND HANDLES ALL )/ THE OTHER DISK IS USED ONLY AS A HOT BACKUP DISK %VERYTHING THAT happens on the active disk happens on the backup disk as well, so at all times, the 
backup disk will be the same. Therefore, if the active disk fails, the backup disk can 
take over easily. This is a very safe method of working, but it doesn’t offer the best 
performance. Therefore, especially if you are in an environment in which lots of 
files are written to the storage devices, you either should not use RAID 1 or should 
create a RAID 1 array that uses two controllers to increase write speed on the 
RAID. For rather static volumes, however, RAID 1 is an excellent solution.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
5
 s  RAID 10 2!)$  OFFERS YOU THE BEST OF BOTH WORLDS ITS 2!)$  WITH 2!)$  behind it. So, you have excellent performance and excellent fault tolerance at the 
same time. There is one disadvantage, though: you need a minimum of four disks 
to set it up.
 s  RAID 5 )F YOU NEED TO WRITE HUGE AMOUNTS OF DATA 2!)$  IS WHAT YOU NEED 4O SET UP 2!)$  YOU NEED A MINIMUM OF THREE DISKS 7HEN A FILE IS WRITTEN IT IS SPREAD over two of the three disks, and the third disk is used to write parity information 
FOR THIS FILE "ASED ON THIS PARITY INFORMATION IF SOMETHING GOES WRONG WITH ONE OF THE DISKS IN THE 2!)$  ARRAY THE 2!)$ SOFTWARE IS ALWAYS ABLE TO RECONSTRUCT THE DATA IN A VERY FAST WAY 4O PROMOTE OPTIMAL PERFORMANCE IN 2!)$  THE PARITY information is spread over all the disks in the array. So there is no dedicated disk 
that stores this information, and that promotes very good performance as well. 
NNote The parity information that is used in a RAID setup creates some kind of a checksum for all files on 
the RAID. If a disk in the RAID gets lost, the original file can be reconstructed based on the parity information. 
Apart from the RAID technologies mentioned here, there are other RAID solutions as 
WELL (OWEVER EVERYTHING ELSE RELATES IN SOME WAY TO THE TECHNIQUES MENTIONED HERE )N the example that I’ll show in this chapter, you will install a server that has a RAID 1 array 
FOR THE SYSTEM FILES AND A 2!)$  ARRAY TO STORE DATA FILES /N TOP OF THE 2!)$ ARRAYS YOU NEED SOME DISK STORAGE MECHANISM AS WELL "ASICALLY there are two options: use logical volumes or use traditional partitions. Especially for data 
VOLUMES IT IS A VERY CLEVER IDEA TO USE LOGICAL PARTITIONS .OT ONLY ARE THESE EASILY RESIZ-
able, but they also offer the snapshot feature. Using snapshot technology makes it a lot 
easier to make a backup of open files. Most backup programs have a problem backing up 
FILES THAT ARE IN USE WHEREAS IF YOU USE SNAPSHOT TECHNOLOGY YOU CAN FREEZE THE STATUS OF your volumes, which allows you to back up anything on the snapshot. Also, when using 
LOGICAL VOLUMES YOU CAN GO FAR BEYOND THE MAXIMUM OF  PARTITIONS THAT YOU CAN CREATE when using traditional partitions. The one disadvantage is that you can’t boot from a logi-
cal volume.
Choosing a File System 
Next, you need to consider what you want to do on top of these logical volumes. In all 
cases, you need to format the logical volume so that a file system is created that allows 
you to store files on your server. Typically, the following file systems are available:
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
6
 s  Ext2: The traditional Linux file system since shortly after Linux was created. It is 
very stable, but does not offer journaling functionality, which means that it can 
TAKE A VERY	 LONG TIME TO REPAIR THE FILE SYSTEM IN CASE OF PROBLEMS 5SE %XT ON small volumes that are mainly  read- only.
 s  Ext3 "ASICALLY %XT IS JUST %XT WITH JOURNALING ADDED TO IT *OURNALING ALLOWS YOU TO RECOVER VERY FAST IN CASE PROBLEMS DO OCCUR %XT IS A GOOD SOLUTION TO STORE DATA BUT IT IS NOT THE BEST FILE SYSTEM WHEN YOU ARE USING MANY READ MORE THAN ABOUT 	 FILES IN ONE DIRECTORY 4HE INDEXING METHODOLOGY USED IN %XT IS rather limited. 
 s  XFS: XFS was CREATED BY SUPERCOMPUTER MANUFACTURER 3') AS AN OPEN SOURCE FILE system. The most important property of XFS is that it is meant for “large.” That 
means large files, large amounts of data, and large file systems. XFS also is a com-
PLETE   BIT FILE SYSTEM )T HAS SOME EXCELLENT TUNING OPTIONS AS WELL A JOURNAL AND a very  well- tuned index. All that makes XFS currently the best solution to store 
data files.
 s  ReiserFS: In the LATE S (ANS 2EISER CREATED 2EISER&3 A REVOLUTIONARY FILE SYSTEM THAT WAS ORGANIZED IN A TOTALLY DIFFERENT WAY COMPARED TO THE EARLY FILE SYS-
TEMS THAT WERE AVAILABLE AT THAT TIME "ECAUSE OF THIS COMPLETELY NEW APPROACH ReiserFS offered supreme performance, especially in environments in which many 
SMALL FILES HAD TO BE HANDLED 3OME OTHER MINOR	 ISSUES WERE ADDRESSED AS WELL AND THAT MADE IT A VERY NICE FILE SYSTEM FOR DATA VOLUMES (OWEVER KERNEL SUPPORT for ReiserFS has never been great and that has lead to stability issues. In specific 
environments in which many large files need to be handled, ReiserFS may still 
be a good choice, but be aware that ReiserFS is not very stable and you will have 
problems with it sooner or later. 
 s  JFS *OURNALED &ILE 3YSTEM WAS DEVELOPED BY )"- AS ONE OF THE FIRST FILE SYSTEMS that offered journaling. The development of this file system has stopped, however, 
and therefore I don’t recommend its use on new servers. 
"ASED on the preceding information, you should now be capable of creating a blue-
print for the disk layout that your server is going to use.  Table 1-1 provides an overview 
of what I’m going to install on my server in this chapter. The items in parentheses are 
RECOMMENDED SIZES WHEN WORKING FROM A 6-WARE TEST ENVIRONMENT OR ANY OTHER TEST environment in which available storage is limited. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
7
NNote Chapter 4 covers advanced file system management tasks. ReiserFS management is included as 
well. Normally I wouldn’t recommend using ReiserFS anymore, but to make it easier for you to apply the con-
tents of Chapter 4, in the example setup, I’m setting up a ReiserFS file system as well. 
 Table 1-1. Blueprint of Server Disk Layout
Directory 
Size 
File System 
Storage Back End 
Storage Device
+^kkp  -"  -"	 %XT 0RIMARY PARTITION 2!)$ 
+  '"  '"	 %XT ,6- VOLUME 2!)$ 
+r]n  '"  '"	 8&3 ,6- VOLUME 2!)$ 
+pil  '"  '"	 2EISER&3 ,6- VOLUME 2!)$ 
+onr  '"  '"	 8&3 ,6- VOLUME 2!)$ 
+dkia  '"  '"	 8&3 ,6- VOLUME 2!)$ 
Now that we’ve done our homework, it’s time to start. In the next section you’ll read 
how to actually install this configuration.
Installing Ubuntu Server
/NE more check to do before you start the actual installation: Ubuntu Server is available 
IN  AND   BIT VERSIONS 4O GET THE MOST OUT OF YOUR SERVER HARDWARE MAKE SURE TO USE A   BIT VERSION OF 5BUNTU 3ERVER &OR INSTANCE   BIT 5BUNTU CANT ADDRESS MORE THAN  '" OF 2!- AND EVEN IF YOU USE THE SPECIAL 0!% 0HYSICAL !DDRESS %XTENSION	 VERSION OF THE KERNEL THAT USES  BITS INSTEAD OF THE DEFAULT  BITS TO ADDRESS MEMORY YOU CANT GO BEYOND  '" OF 2!- 7HEN USING  BITS HOWEVER YOU CAN ADDRESS EXABYTES OF MEM-
ORY WHICH IS PROBABLY ENOUGH FOR THE NEXT COUPLE OF YEARS 4O USE A   BIT VERSION OF THE OPERATING SYSTEM YOUR DRIVERS MUST BE AVAILABLE IN   BIT VERSIONS AS WELL )N SOME CASES that may be a problem. So it’s best to do some research and check if drivers for your hard-
WARE DEVICES ARE AVAILABLE IN   BIT VERSIONS )F THEY ARE USE  BITS OTHERWISE USE  BITS
NNote To understand what I’m covering in this book, it doesn’t really matter whether you’re using the 
 32- bit or  64- bit Ubuntu server version. Using a different version of the operating system doesn’t change 
much the way in which you will work with Ubuntu Server. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
8
Starting the Installation
This section describes how to perform the first steps of the installation:
 
1. "OOT YOUR SERVER FROM THE INSTALLATION MEDIA AND SELECT THE INSTALLATION LANGUAGE THAT YOU WANT TO USE &OR  NON53 BASED INSTALLATIONS DONT FORGET TO USE THE & button from the initial installation window to set your local keyboard layout.
 
2. After you specify your local settings, the installation program shows the available 
network interface cards that it has found and asks you to select a primary network 
BOARD AS SHOWN IN  &IGURE  "ECAUSE .)# TEAMING WHICH IS NEEDED TO ADD BOTH network cards to one interface, is not supported by the installation program, just 
select your first network board and press Enter.
 Figure 1-1. NIC teaming is not supported by the installation program, so just press 
Enter to configure the first Ethernet interface using DHCP. 
 
3. Enter a name for your server. The default name Ubuntu is probably not sufficient, 
so make sure to specify something unique. 
 
4. Select YOUR TIME ZONE AND WAIT FOR THE 0ARTITION $ISKS INTERFACE TO APPEAR
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
9
Creating a  Software- Based RAID Solution
This section describes how to set up Ubuntu Server using software RAID to provide for 
maximal redundancy. Using software RAID helps you to get the best performance and 
redundancy if no  hardware- based RAID solution is available.
 
1. &ROM THE 0ARTITION $ISKS SCREEN SELECT -ANUAL AND PRESS %NTER -AKE SURE NOT TO SELECT THE 'UIDED OPTION WHICH IS THE DEFAULT AS YOU CAN SEE IN  &IGURE  9OU next see an overview of all disk devices that the installer has found, as shown in 
 &IGURE 
 Figure 1-2. Don’t press Enter to accept default values in this screen!
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
10
 Figure 1-3. The installer gives an overview of all available disk devices.
 
2. From THE OVERVIEW IN  &IGURE  YOU HAVE TO SELECT ALL DISK DEVICES ONE BY ONE THIS MEANS THAT YOU HAVE TO PERFORM THIS STEP FIVE TIMES	 )F THERE IS NOTHING ON THE disks yet, the installer will ask you if it needs to set up a partition table. Select Yes 
and then press Enter. After you have done this, the result will look similar to the 
SCREEN SHOWN IN  &IGURE 
 
3. 3ELECT THE FIRST &2%% 30!#% INDICATOR THAT YOU SEE AS SHOWN IN  &IGURE 	 AND PRESS %NTER 9OULL SEE THE 0ARTITION $ISKS INTERFACE SHOWN IN  &IGURE  &ROM THIS INTERFACE MAKE SURE TO SELECT #REATE A .EW 0ARTITION AND THEN PRESS %NTER www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
11
 Figure 1-4. Before proceeding, make sure that you see something similar to this.
 Figure 1-5. Select Create a New Partition and press Enter to continue.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
12
 
4. The INSTALLER ASKS WHAT PARTITION SIZE YOU WANT TO USE /N THE FIRST DEVICE ONLY CRE-
ATE A  -" PARTITION WHICH YOU WILL USE LATER AS the boot partition, and make 
IT A PRIMARY PARTITION THAT IS AT THE BEGINNING OF YOUR HARD DISKS 0RESS %NTER AFTER SPECIFYING THE PARTITION SIZE WHICH TAKES YOU TO THE SCREEN SHOWN IN  &IGURE  -AKE SURE THAT YOU SPECIFY TO USE IT AS AN %XT FILE SYSTEM AND USE +^kkp as the 
MOUNT POINT AS SHOWN IN  &IGURE  &OR ALL OTHER PARAMETERS YOU CAN ACCEPT THE DEFAULT VALUES ON THIS PARTITION .EXT SELECT $ONE 3ETTING 5P THE 0ARTITION AND press Enter to proceed.
 Figure 1-6. Make a boot partition first.
 
5. Next, you must set up the free space that remains on the first hard disk as space to 
be used by the software RAID. To set up the partition, follow these steps:
  s  3ELECT THE NEXT &2%% 30!#% INDICATOR AND PRESS %NTER TO PROCEED   s  3ELECT #REATE A .EW 0ARTITION AND ACCEPT THE PARTITION SIZE THAT THE INSTALLATION PROGRAM SUGGESTS 7RITE THIS SIZE DOWN BECAUSE YOULL NEED TO USE EXACTLY THE SAME SIZE ON THE SECOND HARD DISK   s  3ELECT #ONTINUE AND PRESS %NTER TO USE THIS NEW PARTITION )N THE FOLLOWING screen, select it to be a primary partition. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
13
  s  )N THE PARTITION SETTINGS WINDOW THE SCREEN SHOWN IN  &IGURE 	 SPECIFY that the partition should be used as a physical volume for RAID, as shown in 
 &IGURE    s  3ELECT $ONE 3ETTING 5P THE 0ARTITION  Figure 1-7. Select Physical Volume for RAID to mark the partition as usable for 
software RAID.
 
6. Repeat THE PROCEDURE FROM 3TEP  FOR THE FREE SPACE ON ALL OTHER DISK DEVICES /N THE SECOND DISK THE PARTITION SHOULD BE THE EXACT SAME SIZE AS THE 2!)$ PARTITION on disk 1, and on all other disks, you can use all available disk space. When fin-
ished, the 0ARTITION $ISKS SCREEN SHOULD LOOK SIMILAR TO  &IGURE   
7. Still FROM WITHIN THE PARTITION OVERVIEW SELECT THE OPTION #ONFIGURE 3OFTWARE 2!)$ AT THE TOP OF THE SCREEN	 AND PRESS %NTER 4HIS TAKES YOU TO THE SCREEN SHOWN IN  Figure 1-9. Select Yes and press Enter to write the current partitioning to your 
hard disks. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
14
 Figure 1-8. After setting up all partitions that you want to use in your RAID setup, the 
Partition Disks screen looks like this.
 Figure 1-9. Before creating the RAID sets, you need to write the partitions to disk.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
15
 
8. The installer takes you automatically to the Multidisk utility, which helps you to 
CREATE THE 2!)$ DEVICE &ROM THERE SELECT #REATE -$ $EVICE AND PRESS %NTER Next, select from the three different RAID types that are supported by this utility 
SEE  &IGURE 	 2!)$  2!)$  AND 2!)$  )N THIS PROCEDURE ) SHOW YOU HOW TO CREATE A 2!)$  SET AND A 2!)$  SET SO FIRST SELECT 2!)$ AND PRESS %NTER
 Figure 1-10. First make the RAID 1 array for your operating system files.
 
9. Specify the number of active devices that you want to use. For a RAID 1 array, this 
WOULD TYPICALLY BE TWO DEVICES 4HIS VALUE IS ADDED BY DEFAULT SO SELECT #ONTINUE and press Enter to proceed. 
 
10. Indicate how many spare devices you want to use. In RAID 1, there are no spare 
DEVICES SO ACCEPT THE VALUE OF  WHICH IS ENTERED BY DEFAULT SELECT #ONTINUE AND press Enter. 
 
11. To complete the RAID setup, you need to add partitions that you’ve marked as 
RAID partitions to the RAID set. Make sure to select +`ar+o`]. and +`ar+o`^- SEE  &IGURE 	 AND THEN SELECT #ONTINUE AND PRESS %NTER
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
16
 Figure 1-11. After selecting the devices you want to add to your RAID set, select 
Continue and press Enter.
 
12. "ACK IN THE MAIN 2!)$ CONFIGURATION MENU SELECT #REATE -$ $EVICE ONCE MORE TO CREATE THE 2!)$  ARRAY .OW ADD ALL REMAINING DEVICES TO THIS ARRAY -AKE SURE TO use at least three devices as active devices. You don’t need any spare devices here. 
When you’re back in the main RAID menu, select Finish and press Enter to write 
the RAID configuration to your server’s hard drive. 
Creating LVM Logical Volumes on Top of a Software 
RAID Device
You now have set up two software RAID devices. These devices can be used just as you 
WOULD USE A NORMAL HARD DISK AS A STORAGE DEVICE /N A HARD DISK YOU CAN SET UP TRADI-
tional partitions, as well as LVM logical volumes. For maximal flexibility, it is a good idea 
to use LVM logical volumes. In this section you’ll learn how to set them up on top of the 
software RAID devices you’ve just created. This procedure also works if you are using 
HARDWARE 2!)$ JUST USE THE HARDWARE 2!)$ DEVICE NAMES INSTEAD OF THE i` device names 
used in this procedure.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
17
 
1. You now automatically return to the main menu, in which you’ll see the two RAID 
DEVICES THAT YOUVE JUST CREATED 3ELECT THE SIZE SPECIFICATION THAT YOU SEE DIRECTLY UNDER THE 2!)$  DEVICE SEE  &IGURE 	 AND PRESS %NTER TO START PUTTING SOME logical volumes on the device. This brings you to THE 0ARTITION $ISKS INTERFACE THAT you’ve seen a couple of times before. 
 Figure 1-12. Select the size specification under the name of the RAID device and press 
Enter.
 
2. From THE 0ARTITION $ISKS INTERFACE CHANGE THE STATUS OF THE PARTITION FROM $O .OT 5SE TO 5SE !S 0RESS %NTER SELECT 0HYSICAL 6OLUME FOR ,6- AND PRESS %NTER AGAIN .EXT BACK IN THE 0ARTITION $ISKS INTERFACE SELECT $ONE 3ETTING 5P THE 0ARTI-
TION AND PRESS %NTER )N THE 0ARTITION $ISKS INTERFACE THE FIRST 2!)$ DEVICE NOW IS MARKED AS AN ,6- VOLUME 2EPEAT 3TEPS  AND  FROM THIS PROCEDURE TO MAKE THE other RAID device usable as an LVM device as well. After doing this successfully, 
THE 0ARTITION $ISKS INTERFACE SHOULD LOOK SIMILAR TO  &IGURE  www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
18
 Figure 1-13. Before you start to create logical volumes, your Partition Disks interface 
should look similar to this. 
 
3. Now that you’ve marked the RAID devices as physical volumes in the LVM setup, 
which makes them usable for LVM, it’s time to put some LVM logical volumes 
on them. First, you are going to create a volume for the root directory and swap 
space and put that on the RAID 1 array. Next, you’ll create the +r]n, +dkia, and 
+pil VOLUMES ON THE 2!)$  ARRAY 3TART BY SELECTING THE OPTION #ONFIGURE THE ,OGICAL 6OLUME -ANAGER PRESS %NTER	 )N THE OVERVIEW YOU SHOULD SEE THAT THERE currently are two physical volumes available. To create the highest possible redun-
dancy, you’ll create a volume group on each of them. To do this, from the interface 
THAT YOU SEE IN  &IGURE  SELECT #REATE 6OLUME 'ROUP AND PRESS %NTER
 
4. Next, you need to provide a name for the volume group you want to create. In this 
scenario, because you want a volume group that is clearly divided between two 
physical storage devices, I suggest using the names of these devices for the volume 
group name. So make a volume group with the name RAID1 on the RAID 1 array, 
AND NEXT CREATE A VOLUME GROUP WITH THE NAME 2!)$ ON THE 2!)$  ARRAY !FTER creating the volume group, select the storage device on which you want to create 
IT !S YOU CAN SEE IN  &IGURE  THE NAMES OF THESE STORAGE DEVICES WILL BE +`ar+
i`, for the first RAID device and +`ar+i`- for the second RAID device. Make sure 
that you create both volume groups now. After selecting the storage device, select 
#ONTINUE AND PRESS %NTER www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
19
 Figure 1-14. Select Create Volume Group and press Enter to start defining 
a volume group.
 Figure 1-15. Select the storage device that you want to use, select Continue, and 
press Enter.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
20
 
5. You next see a summary of the current LVM configuration that shows that you 
NOW HAVE TWO VOLUME GROUPS &ROM HERE SELECT #REATE ,OGICAL 6OLUME AND PRESS Enter. This gives you a list of all existing volume groups. Select the volume group 
in which you want to create the logical volume and press Enter. Next, enter the 
name of the logical volume you want to create and proceed to the next step. In 
THE FOLLOWING SCREEN SEE  &IGURE 	 ENTER THE SIZE OF THE LOGICAL VOLUME THAT YOU WANT TO CREATE )TS A GOOD IDEA NEVER TO USE ALL AVAILABLE DISK SPACE THIS GIVES YOU THE FLEXIBILITY TO RESIZE EASILY AT A LATER STAGE 3ELECT #ONTINUE AND PRESS %NTER
 Figure 1-16. It’s a good idea never to use all available disk space when creating the 
logical volumes. 
 
6. #REATE all the logical volumes that you want to use, and then, from the LVM sum-
MARY SCREEN SHOWN IN  &IGURE  SELECT &INISH AND PRESS %NTER TO COMPLETE THIS procedure. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
21
 Figure 1-17. After creating all logical volumes, select Finish and press Enter to 
complete this part of the procedure.
 
7. At this stage you have created the RAID devices, put some logical volume groups 
on top of them, and created the logical volumes that you want to use in the volume 
groups. Now it’s time for the final step: you need to put some file systems in the 
volume groups. To do this, select the logical volumes one by one. From THE 0ARTI-
TION $ISKS INTERFACE WHICH SHOULD NOW LOOK SIMILAR TO THAT SHOWN IN  &IGURE  YOU CAN EASILY RECOGNIZE BY THEIR NAMES THE LOGICAL VOLUMES THAT YOUVE CREATED Select the line that marks the free space that is available on the logical volumes 
and press Enter. 
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
22
 Figure 1-18. Select the logical volumes one by one to put a file system on them. 
 
8. You ARE NOW BACK IN THE OVERVIEW SCREEN OF THE 0ARTITION $ISKS INTERFACE 3ELECT the line labeled Use As and select the file system that you want to use on this logi-
cal volume. After selecting the file system, select the directory on which you want 
TO MOUNT THIS VOLUME .EXT SELECT $ONE 3ETTING 5P THE 0ARTITION AND PRESS %NTER Repeat this procedure for all the logical volumes that you have created. After doing 
THIS FOR ALL YOUR VOLUMES SELECT &INISH 0ARTITIONING AND 7RITE #HANGES TO $ISK AND press Enter. This writes the disk layout that you have created and brings you to the 
next step of the procedure. 
Completing the Installation
Now that you’ve set up the disk layout for your server, it’s time to complete the instal-
lation. This includes creating a user account, specifying where to authenticate, and 
selecting one or more of the predefined installation patterns for your server. In the fol-
lowing procedure, you’ll learn what’s involved.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
23
 
1. As you probably already know, on Ubuntu server you won’t work as root by 
default. Therefore, you are asked to enter the name of a new user that will be 
created now. Your first name might not be a bad idea. Make sure this user has 
a password as well.
 
2. If you need a proxy server to access the outside world, you can now enter the 
data that you need to access this proxy server. You’ll do this as a URL. This can be 
a basic URL, but you can also use a URL that includes a username and password. 
For instance, if a special user account oanran- with the password l<oos,n` needs 
to authenticate on the proxy with the name omqe` THAT IS REACHABLE ON PORT  the line you enter looks as follows: dppl6++oanran-6l<oos,n`<omqe`6/-.,. If no proxy 
information is needed, you can just skip this field and leave it empty.
 
3. Select one or more of the installation patterns available for your server. This is 
not an important option, because later you can install all software packages that 
are offered here. Now the software is copied to your server. Wait until this is com-
pleted. 
 
4. 9OULL NOW SEE A MESSAGE THAT INSTALLATION IS COMPLETE SEE  &IGURE 	 0RESS Enter now to boot into your new system. 
 Figure 1-19. When the installation is completed, press Enter to start the 
installed system.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
24
Post-Installation Tasks
Now you have a functional instance of Ubuntu Server, but you are not done yet. In a typi-
cal  data- center installation, a server has several network cards, and to get the best out of 
THESE NETWORK CARDS YOU PROBABLY WANT TO SET UP .)# BONDING 9OU CAN CONFIGURE .)# bonding in two ways: for maximal redundancy or for maximal performance. Your enter-
prise server might connect to a SAN as well. This adds another requirement: setting up 
multipathing. The next two subsections describe how to accomplish these tasks.
Setting Up NIC Bonding
Even the most basic network servers have at least two network cards. Some models even 
have four or more network cards installed. This not only is useful if you want to connect 
your server to several networks at the same time, but also enables you to use these multi-
ple network cards to increase performance or redundancy. The technique used for this is 
REFERRED TO AS .)# BONDING 5SING .)# BONDING YOULL GET A NEW NETWORK DEVICE THAT TYPI-
cally has the name ^kj`,. Two of the physical network cards are assigned to this device. 
7HEN SETTING UP .)# BONDING YOU DONT WORK WITH apd, and apd- ANYMORE YOULL WORK with ^kj`, INSTEAD 4HAT MEANS THAT THE )0 ADDRESS IS ASSIGNED TO ^kj`, as well. 
Speaking IN A GENERAL WAY THERE ARE TWO DIRECTIONS YOU CAN GO WITH .)# BONDING When setting it up for redundancy, one of the network cards will be active, whereas the 
other one is on standby and takes over only if the active network card fails. This enables 
fault tolerance on the network connection for your server. In the  high- performance setup, 
the two network cards in the bonding configuration work together to handle the work 
LOAD 4HAT MEANS THAT YOU COULD CREATE A  GIGABIT CONNECTION BY BUNDLING TWO '" NET-
WORK CARDS )N THE FOLLOWING PROCEDURE YOULL LEARN HOW TO SET UP .)# BONDING ON 5BUNTU 3ERVER "UT BEFORE STARTING TAKE A LOOK AT THE LIST IN  4ABLE  OF THE DIFFERENT OPTIONS THAT YOU CAN USE WHEN SETTING UP .)# BONDING
 Table 1-2. NIC Bonding Options
Option 
Use
MODE  4HIS MODE ENABLES ROUND ROBIN 4HAT MEANS THAT PACKETS ARE TRANSMITTED IN A SEQUENTIAL way between the network cards assigned to the bonding interface. Using this option, 
you’ll get load balancing and redundancy at the same time.
mode=1 
 Using this mode, one of the network cards is active and the other one is passive. This 
enables fault tolerance, but doesn’t do anything for performance.
MODE  4HIS MODE DIVIDES THE WORK LOAD BETWEEN ASSOCIATED DEVICES BUT TRIES TO KEEP A NETWORK connection on the same device as long as possible. This offers redundancy and load bal-
ANCING AT THE SAME TIME BUT WITH BETTER PERFORMANCE THAN MODE "ECAUSE THIS MODE is also more complicated, it is more prone to errors.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
25
Option 
Use
MODE  5SE THIS MODE TO TRANSMIT EVERYTHING ON ALL SLAVE DEVICES 4HIS MODE PROVIDES FAULT TOLERANCE WITH THE SHORTEST RECOVERY TIMES A NETWORK CARD MAY FAIL WITHOUT SERVICE interruption. 
MODE  4HIS MODE USES )%%% AD $YNAMIC ,INK AGGREGATION 4HIS BUNDLES THE NETWORK cards in the bond device as one, but does require additional configuration on the net-
work switch.
MODE  4HIS MODE DISTRIBUTES CONNECTIONS TO THE NETWORK CARDS IN THE BOND DEVICE THUS ENABLING LOAD BALANCING /NE OF THE MAJOR ADVANTAGES TO USING THIS MODE IS THAT NO additional configuration is needed on the switch. 
The FOLLOWING PROCEDURE EXPLAINS HOW TO SET UP .)# BONDING
 
1. #REATE A MODULE ALIAS IN +ap_+ik`lnk^a*`+]he]oao, as shown in  Listing 1-1. This 
MAKES SURE THAT THE RIGHT KERNEL MODULE IS LOADED WHEN SETTING UP .)# BONDING Make sure that the names of the kernel devices for apd, and apd- in  Listing 1-1 are 
REPLACED BY THE REAL MODULE NAMES NEEDED FOR YOUR NETWORK CARDS "ECAUSE THE bonding is between apd, and apd- only, you don’t need to do anything on apd. 
here.
 Listing 1-1. Use /etc/modprobe.d/aliases to Load the Correct Kernel Modules
=llaj`pkpda^kppkikbpdeobeha6
]he]o^kj`,^kj`ejc
]he]oapd,a-,,
]he]oapd-a-,,
]he]oapd.a-,,
klpekjo^kj`ejcik`a9,ieeikj9-,,
 
2. In the +ap_+ik`lnk^a+]n_d directory, you’ll find a file that contains settings for your 
SPECIFIC KERNEL ARCHITECTURE SEE ,ISTING   	 &OR INSTANCE IF YOU ARE USING AN I kernel, the name of this file is e/42. Edit this file to make sure the right options are 
loaded for the bonding device.
 Listing 1-2. Edit the /etc/modprobe.d/arch/i386 File to Contain the Correct 
Bonding Options
=llaj`pkpda^kppkikbpdeobeha6
]he]o^kj`,^kj`ejc
klpekjo^kj`ejcik`a9,ieeikj9-,,`ksj`ah]u9.,
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
26
 
3. As a final step, you need to modify the file that contains the configuration of 
your network card to create the ^kj`, device and its properties. The example in 
 ,ISTING  SHOWS WHAT THE CONTENT OF THIS FILE LOOKS LIKE -AKE SURE TO CHANGE  SERVER SPECIFIC SETTINGS SUCH AS THE -!# ADDRESS USED IN THIS example.
 Listing 1-3. Change the /etc/network/interfaces File to Create the bond0 Device
Pdeobeha`ao_ne^aopdajapskngejpanb]_ao]r]eh]^hakjukqnouopai
]j`dkspk]_per]papdai*Bkniknaejbkni]pekj(oaaejpanb]_ao$1%*
Pdahkkl^]_gjapskngejpanb]_a
]qpkhk
eb]_ahkejaphkkl^]_g
Pdalnei]nujapskngejpanb]_a
]qpkapd,
eb]_aapd,ejapop]pe_
]``naoo-5.*-24*,*-.,
japi]og.11*.11*.11*,
japskng-5.*-24*,*,
^nk]`_]op-5.*-24*,*.11
c]pas]u-5.*-24*,*-
]qpk^kj`,
eb]_a^kj`,ejapop]pe_
]``naoo-5.*-24*,*-.,
japi]og.11*.11*.11*,
japskng-5.*-24*,*,
^nk]`_]op-5.*-24*,*.11
c]pas]u-5.*-24*,*-
ds]``naooapdan,,6,/6>/60461,6.?
lkop)qlebajoh]ra^kj`,apd,apd-
This completes all required steps to set up the bond device. To verify that it comes up 
when your server starts, reboot your server now.
Setting Up Multipathing
A server in a data center is often connected to a SAN. To avoid having a single point of 
FAILURE YOUR SERVER PROBABLY HAS TWO ("!S THAT ARE CONFIGURED TO TWO STORAGE NETWORKS THAT CONNECT TO THE SAME 3!. FILER SEE  &IGURE 	 www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
27
 Figure 1-20. Schematic overview of the way a server is connected to the SAN
This redundancy in the SAN connections would normally produce an undesirable 
result. Let’s say your server has a redundant connection to one LUN on the SAN. For 
the moment, consider the SAN to be a black box, and a LUN to be some storage that is 
allocated in a logical group on the SAN, like you would use partitions on hard drives. See 
#HAPTER  FOR INFORMATION ON HOW TO SET UP A 3!. YOURSELF 4HE SERVER WOULD SEE THIS ,5. VIA BOTH THE FIRST AND SECOND ("!S "ECAUSE THE SERVER NORMALLY HAS NO WAY OF DETERMIN-
ing that it sees the same device on the SAN twice, it would offer you two new devices—for 
instance, +`ar+o`^ COMING VIA THE FIRST ("! AND +`ar+o`_ COMING VIA THE SECOND ("! As you can imagine, this is not good.
To prevent your server from getting two devices, you should use multipathing. Initial-
IZING THIS IS NOT TOO DIFFICULT 5BUNTU 3ERVER HAS A MULTIPATH DAEMON THAT YOU CAN LOAD TO take care of this problem. Installing it is a really simple  two- step procedure:
 
1. Use ]lp)capejop]hhiqhpel]pd)pkkho to install the multipath software.
 
2. Enter the command +ap_+ejep*`+iqhpel]pd` to start the multipath process, and 
make sure that it automatically restarts when you restart your server. 
The result of these two steps is that you’ll get a new storage device. Use b`eog)h or 
hoo_oe to find out what the name of this device is. This storage device refers to your SAN. 
When setting up partitions on the SAN, make sure to use this storage device, and not the 
+`ar+o`^ and +`ar+o`_ devices that your server also still gives you.
www.it-ebooks.info

CHAPTER 1 N   PERFORMING AN ADVANCED UBUNTU SERVER INSTALLATION
28
Summary
In this chapter you have learned how to set up a server in an enterprise environment. 
As you have seen, this is quite a different approach from setting up a server in a small 
business or home environment. You have learned how to set up software RAID, and LVM 
LOGICAL VOLUMES ON TOP OF THAT 9OU HAVE ALSO LEARNED HOW TO SET UP .)# BONDING FOR OPTI-
MIZED NETWORK CARD PERFORMANCE AND MULTIPATH FOR OPTIMIZED 3!. CONNECTIONS )N THE next chapter you’ll learn how to set up Ubuntu Server for workstation imaging. 
www.it-ebooks.info

29
C H A P T E R  2
Using Ubuntu Server for 
System Imaging
Clonezilla on Ubuntu Server
In the first chapter of this book, you read how to perform an enterprise network instal-
lation of Ubuntu Server. The topic of this chapter is somewhat related to installation of 
Ubuntu Server. In this chapter you’ll learn how to set up a Clonezilla imaging server. 
There may be several reasons why you would want to set up such a server. The most 
important of them is that working with workstation images reduces help desk expenses. 
If after a minimal period of troubleshooting it turns out that repairing a workstation is 
going to take too long, it’s much faster just to restore the image of that workstation. Of 
course, this assumes that all  work- related files will be written to some other server first. 
In this chapter you’ll learn how to set up Clonezilla for imaging. 
Setting Up a Clonezilla Imaging Server
The Clonezilla imaging server is currently the most popular open source imaging solu-
tion. It has two versions, a  stand- alone version and a server version. Whereas the  stand- 
alone version does well to make and restore images of single machines, you’ll need the 
server version if you need to make images of multiple systems. In its current version, up 
to 40 workstations can be imaged simultaneously using a method that uses broadcast or 
multicast to ensure optimal use of network bandwidth.
Before installing the required software, make sure that your environment is set up for 
imaging. Basically, it comes down to two elements: 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
30
 s  ! FAST DEDICATED NETWORK FOR IMAGING YOU DO ABSOLUTELY WANT 'IGABIT OR BETTER	 This means that you need a second network card installed on your server and 
a dedicated Ethernet network connected to that network card. 
 s  7ORKSTATIONS THAT CAN BOOT FROM THE NETWORK CARD 08% BOOT	 !LL MODERN NETWORK CARDS SUPPORT 08% BOOT SO THAT SHOULDNT BE A PROBLEM *UST MAKE SURE THAT YOU enable network boot in the BIOS of your workstation. 
I’ll assume that you have both elements. If not, save yourself a great deal of hassle 
and make sure that these are in place before you start. 
Setting Up Diskless Remote Boot in Linux
To use Clonezilla in a server environment, you need to set up diskless remote boot first. 
4HE SOLUTION FOR THAT IS $ISKLESS 2EMOTE "OOT IN ,INUX $2",	 YOU CAN DOWNLOAD IT from dppl6++`n^h*okqn_abknca*jap+kja0]hh. Before setting up DRBL, you must set up the 
NETWORK INTERFACE CARD !SSUMING THAT YOUVE JUST INSTALLED ON YOUR 5BUNTU  SERVER a second network card for use with DRBL and the network card hasn’t been set up yet, 
follow this procedure to set up the second network card:
 
1. Using root permissions, open the file +ap_+japskng+ejpanb]_ao.
 
2. To add a second network card that is meant to be used for Clonezilla only, add the 
FOLLOWING INFORMATION TO THE FILE /F COURSE YOU ARE FREE TO USE ANY )0 INFORMATION that you want to use.
]qpkapd-
eb]_aapd-ejapop]pe_
]``naoo-,*,*,*-,
japi]og.11*.11*.11*,
japskng-,*,*,*,
^nk]`_]op-,*,*,*.11
 
3. Restart the network to activate the new configuration. Don’t forget to make sure 
THAT YOUR NEW NETWORK CARD YOU SHOULD SEE IT AS apd-	 REALLY IS AVAILABLE
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
31
Installing the DRBL Software
Now that the network is prepared, you can install the DRBL software. It is a good idea to 
use Ubuntu’s secure ]lp TO DO THIS SO YOU FIRST NEED TO DOWNLOAD THE $2", '0' KEY AND install it. Use the following two commands to do that:
scapdppl6++`n^h*j_d_*knc*ps+CLC)GAU)@N>H
]lp)gau]``CLC)GAU)@N>H
Next, you need to change the +ap_+]lp+okqn_ao*heop file to add the new installation 
sources that allow you to add the DRBL software and keep it up to date. Make sure to add 
the following two lines to the okqn_ao*heop file:
`a^dppl6++bnaa*j_d_*knc*ps+q^qjpqd]n`ui]ejnaopne_pa`qjeranoaiqhperanoa
`a^dppl6++bnaa*j_d_*knc*ps+`n^h)_kna`n^hop]^ha
Next, execute the following commands to install the software:
]lp)capql`]pa
]lp)capejop]hh`n^h
$EPENDING ON THE SPEED OF YOUR )NTERNET CONNECTION THIS MAY TAKE A WHILE !FTER this command has finished execution, all required software is downloaded but nothing is 
installed yet. 
When you run the ]lp)capejop]hh`n^h command, the installation program asks the 
following questions, the recommend answers to which are provided:
 
1. Do you want to install some network boot images for different Linux distributions? 
Doing so would download more than 100 MB from the Internet to allow you to 
perform an easy installation of workstations. Normally, you don’t need to do this, 
so press Enter to accept the default value No and proceed. 
 
2. Do you want serial console output for typical clients? Unless you know you do 
need it, choose the default option, which is No.
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
32
 
3. What kind of kernel do you want to use on the clients to do imaging? Typically, 
YOU WOULD CHOOSE OPTION  WHICH OFFERS I AND BETTER /PTION  IS FOR OLD  PRE 0ENTIUM CLIENTS ONLY AND OPTION  IS ONLY FOR IF YOUR #05 IS THE SAME ON THE DRBL server and clients. This would typically not be the case, so choose 1 here 
and proceed. 
 
4. $O YOU WANT TO UPGRADE YOUR OPERATING SYSTEM !SSUMING YOU DONT NEED TO DO THAT AT THIS POINT PRESS %NTER TO ACCEPT THE DEFAULT VALUE OF .O 'O HAVE A CUP of coffee now, because several megabytes of files need to be downloaded at this 
stage. 
Configuring the DRBL Software
!FTER the download is finished, you can start the configuration. I’ll assume that your DRBL 
SERVER HAS TWO NETWORK INTERFACES SEE  &IGURE 	 apd,, which is used for normal Internet 
and user traffic, and apd-, which is used for DRBL. apd- IS CONFIGURED WITH THE )0 ADDRESS  IN THIS EXAMPLE OF COURSE YOU ARE FREE TO USE ANY OTHER ADDRESS RANGE YOU LIKE $O MAKE SURE HOWEVER THAT YOU ARE USING A   BIT SUBNET MASK BECAUSE OTHERWISE THE broadcast/multicast performance will be very bad. 
 Figure 2-1. Schematic overview of the imaging network
Now to configure DRBL, use the +klp+`n^h+o^ej+`n^hlqod)e command. This will set 
up your server. Setting up your server this way is easy, because the program will detect 
almost all settings automatically. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
33
The first couple of questions ask you about the DNS configuration you want to use. 
0AY ATTENTION WHEN YOURE ASKED WHICH NETWORK CARD IS USED FOR YOUR )NTERNET CONNEC-
TION SPECIFY THE CORRECT CARD HERE OR ELSE YOULL HAVE $2", TRAFFIC ON THAT CARD !FTER YOU select the Internet interface, the DRBL interface is selected automatically. 
.EXT YOU CAN POPULATE THE DATABASE OF YOUR $2", SERVER WITH THE -!# ADDRESSES OF THE CLIENTS (OW DOES THIS WORK 0RESS 9 TO TELL $2", THAT IT SHOULD START COLLECTING -!# addresses now. 
&INALLY START UP ALL THE CLIENT COMPUTERS ONE BY ONE AND MAKE SURE THEY BOOT FROM THEIR NETWORK CARD !S INDICATED IN THE MENU PRESS  TO FIND OUT IF ALL THE CLIENTS HAVE BEEN FOUND /NCE YOU ARE CONFIDENT THAT ALL CLIENTS HAVE BEEN DETECTED PRESS  TO FINISH COLLECTING -!# ADDRESSES OF CONNECTED CLIENTS AND QUIT 4HE ADVANTAGE OF DOING THIS IS THAT YOU CAN BIND PARTICULAR CONFIGURATIONS TO PARTICULAR WORKSTATIONS 9OU ARE NOT REQUIRED TO DO THIS THOUGH 7ITHOUT THE FIXED -!# ADDRESS TO )0 ADDRESS CONNECTION $2", ALSO WORKS WELL !ND AFTER ALL YOU HAVE MORE FLEXIBILITY IF YOU DONT HAVE TO CREATE FIXED )0 ADDRESS TO -!# ADDRESS MAPPINGS first.
NNote You also can use DRBL to boot workstations with a Ubuntu image. The software even allows you 
to store private configuration environments on the server for each of these workstations. If you want to go 
this way, it is a very good idea to make a mapping between IP addresses and MAC addresses of the work-
stations. If you just want to do imaging, there is no reason to create this mapping. 
Setting Up the DHCP Server
In the NEXT STEP SEE  ,ISTING 	 THE $2", PROGRAM ASKS YOU WHETHER YOU WANT THE $(#0 SERVER WHICH IS CONFIGURED AUTOMATICALLY TO HAND OUT THE SAME )0 ADDRESS TO clients at all times. This is useful if you want the same client to work with the same con-
FIGURATION AT ALL TIMES )F THIS IS THE CASE PRESS 9 OTHERWISE PRESS %NTER TO CONTINUE )N CASE YOU DO WANT THE CLIENTS TO WORK WITH THE SAME )0 ADDRESSES AT ALL TIMES THEIR -!# addresses must be stored in a configuration file. The DRBL setup program creates this file 
AUTOMATICALLY FOR YOU *UST PRESS %NTER TO accept the default name for this file. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
34
 Listing 2-1. The DRBL Program Sets Up a DHCP Server Automatically
@kukqs]jppkhappda@D?Loanre_aej@N>Hoanrankbbano]iaEL]``naoopkpda
_heajparanupeiasdaj_heajp^kkpo$Ebukqs]jppdeobqj_pekj(ukqd]rapk
_khha_ppdaI=?]``naooaokb_heajpo(]j`o]rapdaiejbeha$o%$]oejpda
lnarekqolnk_a`qna%%*Pdeoeobknpda_heajpo_kjja_pa`pk@N>Hoanran#o
apdanjapjapskngejpanb]_aapd-;
Wu+JY
.EXT YOU MUST SPECIFY THE )0 ADDRESS THAT THE $(#0 SERVER WILL HAND OUT FOR THE FIRST CLIENT 9OU DO THIS BY SPECIFYING THE LAST BYTE ONLY SEE  ,ISTING 	 3O FOR EXAMPLE IF YOU ARE ON THE NETWORK  AND YOU WANT THE FIRST CLIENT TO HAVE THE )0 ADDRESS  JUST ENTER  HERE ! $(#0 RANGE WILL THEN BE CONFIGURED AUTOMATICALLY 0RESS 9 TO ACCEPT THIS RANGE 9OU WILL SEE AN OVERVIEW OF THE NETWORK CONFIGURATION OF your DRBL server. Happy with it? Then press Enter to continue. 
 Listing 2-2. Specify How the DHCP Range to Be Used Must Be Configured
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
@kukqs]jppkhappda@D?Loanre_aej@N>Hoanrankbbano]iaEL]``naoopkpda
_heajparanupeiasdaj_heajp^kkpo$Ebukqs]jppdeobqj_pekj(ukqd]rapk_khha_p
pdaI=?]``naooaokb_heajpo(]j`o]rapdaiejbeha$o%$]oejpdalnarekqo
lnk_a`qna%%*Pdeoeobknpda_heajpo_kjja_pa`pk@N>Hoanran#oapdanjapjapskng
ejpanb]_aapd-;
Wu+JYj
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
KGHapÑo_kjpejqa(sasehhoappdaEL]``naookb_heajpo^ubenop^kkpcapoEL
benopejopa]`kbbeta`kja
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
Sd]peopdaejepe]hjqi^an`kukqs]jppkqoaejpdah]opoapkb`ecepoejpdaEL
$e*a*pdaejepe]hr]hqakb`ejpdaEL]``naoo]*^*_*`%bkn@N>H_heajpo_kjja_pa`
pkpdeoapdanjaplknpapd-*
W-Y
Once THE $(#0 SERVER HAS BEEN FULLY CONFIGURED THE CONFIGURATION PROGRAM TELLS YOU WHAT THE $2", NETWORK SHOULD CURRENTLY LOOK LIKE SEE  ,ISTING 	 #HECK THAT THIS IS what you expected, and if it is, proceed with the configuration.
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
35
 Listing 2-3. The DRBL Setup Program Shows What It Is Going to Configure
PdaH]ukqpbknukqn@N>Hajrenkjiajp6
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
JE?JE?EL?heajpo
')))))))))))))))))))))))))))))'
x@N>HOANRANx
xx
x'))Wapd,Y-5.*-24*-*2,')pkS=J
xx
x'))Wapd-Y-,*,*,*---')pk_heajpocnkql-W-._heajpo(pdaenEL
xxbnki-,*,*,*1,)-,*,*,*2-Y
')))))))))))))))))))))))))))))'
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
Pkp]h_heajpo6-.
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
LnaooAjpanpk_kjpejqa***
Next you need to specify which DRBL mode you want to use. There are two differ-
ENT SCENARIOS HERE &IRST YOU CAN USE $2", TO PROVIDE EACH CLIENT WITH A BOOT IMAGE THAT you’ll use to give them a useable operating system. Do this at all times, because it gives 
you a complete working environment available on the client, and that may be useful if 
YOU NEED TO SET ADDITIONAL PARAMETERS FROM THE CLIENTS  08% DELIVERED OPERATING SYSTEM During the next step, specify that you want to use full Clonezilla mode. This provides 
everything a client needs to boot and do its work in the Clonezilla environment, which 
enables you to do easy workstation imaging. 
Completing Clonezilla Configuration
Now YOU ARE GETTING TO THE NEXT STEP OF THE CONFIGURATION 9OU NEED TO ASSIGN A DIRECTORY that can be used by Clonezilla. I suggest using a rather large storage device, format-
TING IT WITH 8&3 AND MOUNTING IT ON A DIRECTORY +_hkjavehh] might be suitable. Do not 
USE 2EISER&3 FOR THIS FILE SYSTEM BECAUSE IT ISNT VERY STABLE !LSO MAKE SURE THAT YOUR +ap_+bop]^ file is modified to activate this directory the next time your server boots. To 
configure this, follow these steps:
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
36
 
1. !SSUMING THAT YOU HAVE A DEDICATED HARD DISK WITH AN EXISTING PARTITION ON IT which is reachable via the device +`ar+o`^-, use igbo*tbo+`ar+o`^- to format the 
DEVICE WITH THE 8&3 FILE SYSTEM
 
2. Use ig`en+_hkjavehh] to create the Clonezilla directory.
 
3. Make sure your +ap_+bop]^ includes the following line to mount the Clonezilla 
directory automatically:
+`ar+o`^-+_hkjavehh]tbo`ab]qho,,
!FTER you specify which file system to use, the configuration program asks you if you 
want to set a password as well. If you use a password, only authenticated clients can use 
Clonezilla services. Do what fits your situation best here. 
Now the installer asks if you want to define a boot prompt for clients. It may be 
a good idea to do so, so that your clients have the option to specify what they want to do 
WHEN BOOTING WITH AN IMAGE THEYVE OBTAINED FROM THE $2", SERVER ! DEFAULT TIMEOUT of 7 seconds is generated for this boot prompt. If this is not enough time, change it in the 
NEXT STEP &OLLOWING THAT JUST PRESS %NTER TO SPECIFY THAT YOU DONT WANT TO SEE A GRAPHICAL boot menu on the client computers. 
.EXT THE CONFIGURATION PROGRAM ASKS IF YOU WANT TO USE THE $2", SERVER AS A .!4 SERVER )F YOU JUST WANT TO USE #LONEZILLA FOR CLONING SELECT .O HERE &OR THE NEXT THREE QUESTIONS PRESS %NTER TO SELECT THE DEFAULT OPTIONS 4HIS WILL START THE #LONEZILLA $(#0 SERVER AND ALL RELATED SERVICES !T THIS STAGE YOU CAN USE 08% BOOT ON THE CLIENTS TO BOOT them into the Clonezilla server. 
Configuring the Clients for Cloning
Now that you’ve set up a basic Clonezilla environment, you are going to use the 
`n^h)_heajp)osep_d command to add the appropriate Clonezilla options to the boot 
menu, thus enabling end users to specify what they want to do on their client work-
STATIONS 9OU CAN CONFIGURE THE ENVIRONMENT IN DIFFERENT WAYSFOR FULLY AUTOMATIC SETUP or in such a way that the administrator starts the cloning process manually after using 
08% BOOT ON THE CLIENT &IRST YOULL LEARN HOW TO USE THE `n^h)_heajp)osep_d command to 
set up the server, and then you’ll learn how to start cloning on the clients. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
37
Setting Up the Server for Cloning
The following procedure, typically a  one-time- only procedure, allows you to set up the 
Clonezilla server for cloning:
 
1. /N THE SERVER EITHER BY 33( OR DIRECTLY	 START the +klp+`n^h+o^ej+`n^h)_heajp)
osep_d COMMAND TO ACCESS THE SCREEN SHOWN IN  &IGURE   Figure 2-2. You can set up imaging for all nodes, or for a limited selection of nodes only.
 
2. Specify IN WHAT MODE YOUR CLIENT WILL BE STARTING AUTOMATICALLY !SSUMING THAT YOULL BE USING 08% BOOT ONLY WHEN YOU WANT TO CLONE THE CLIENT SELECT THE OPTION _hkjavehh])op]RT AS SHOWN IN  &IGURE  4HIS AUTOMATICALLY STARTS THE CLONING engine. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
38
 Figure 2-3. Make sure to select  clonezilla- start to start the cloning process automatically 
after your workstation boots from its network card.
 
3. 9OU CAN now select an option to start a clone or restore process automatically 
SEE  &IGURE 	 !FTER YOU CHOOSE ONE OF THESE AUTOMATIC OPTIONS #LONEZILLA WILL use multicast mode, thus allowing you to clone at the highest possible speed. The 
disadvantage of using an automatic option, where your selection is predefined, 
is that you’ll always need to run the `n^h)_heajp)osep_d command before every 
major job. The alternative is to use the option oaha_p)ej)_heajp, which uses uni-
cast but gives more flexibility from within the client. Because it is more flexible, 
I’ll use this option. 
 
4. Specify what to offer as the default client boot option. Make sure to select the 
option )u-, which halts to show you the boot menu. In the next and last screen, 
select )lna^kkp, which will reboot the client machine automatically after it has 
been cloned. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
39
 Figure 2-4. For optimal performance, use one of the first four options; for optimal flexibility, 
use the  select-in- client option. 
Cloning the Client
Now that everything is set up, you are ready to start cloning your client:
 
1. Make sure the workstation that you want to boot boots from its network card. 
9OULL SEE THE $2", BOOT MENU WITH THE #LONEZILLA OPTION SELECTED BY DEFAULT SEE  &IGURE 	 -AKE SURE YOUR WORKSTATION BOOTS THIS OPTION  
2. &ROM the Clonezilla menu, you can choose from two different options, as shown 
IN  &IGURE  5SE the option `are_a)ei]ca to write an image file to the Clonezilla 
server. The `are_a)`are_a option is useful only if you want to clone the contents of 
A HARD DRIVE TO AN EXTERNAL STORAGE DEVICE 4HIS DOESNT WRITE AN IMAGE FILE IT JUST CLONES YOUR HARD DRIVE TO THE SELECTED STORAGE DEVICE !NY STORAGE DEVICE CAN BE used for this purpose, as long as it is at least as big as the hard drive you want to 
clone.
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
40
 Figure 2-5. When booting the workstation from the network card, the Clonezilla 
option automatically pops up. 
 Figure 2-6. Use the  device- image option to write the cloned disk to an image file on 
the Clonezilla server. 
 
3. Specify WHAT ACTION YOU WANT TO TAKE SEE  &IGURE 	 4HE MOST IMPORTANT OPTIONS are o]ra`eog, which clones the entire disk to the image file, and naopkna`eog, which 
restores the client from an image file. The other two options allow you to save and 
restore individual partitions only.
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
41
 Figure 2-7. Select savedisk to write the contents of the entire hard drive to an 
image file.
 
4. 3PECIFY WHAT PRIORITY SHOULD BE USED 4HE DEFAULT PRIORITY FITS WELL IT WILL TRY THE jpbo_hkja PROGRAM WHICH OBVIOUSLY IS FOR .4&3 FILE SYSTEMS ONLY IF YOURE NOT USING .4&3 IT TRIES l]npei]ca AND IF THAT ALSO DOESNT WORK IT WILL USE THE VERY SLOW	 `` command to clone the disk. Count on that to take a couple of hours, 
though, because `` is rather inefficient.
 
5. Make sure that the option is selected that forces the client to wait before clon-
ing. This option makes sure that nothing will happen by accident, and as you can 
imagine, that’s rather important.
 
6. In the following screen, you need to specify what command you want to use to 
compress the cloned image. The default value, which uses cvel, will do rather well 
HERE &OLLOWING THAT YOU NEED TO GIVE A NAME TO SAVE THE IMAGE SEE  &IGURE 	 This is very important, because when restoring the original state of your hard 
drive, this image name will be the only thing that you’ve got. So, make sure that 
ALL YOUR MACHINES HAVE A UNIQUE NAME AND USE THAT MACHINE NAME APPENDED BY THE DATE ON WHICH YOUVE CREATED THE IMAGE IF YOUD LIKE	 TO STORE THE image. 
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
42
 Figure 2-8. Make sure to use something more descriptive than the default name for 
your image.
 
7. 3ELECT THE HARD DISKS	 THAT YOU WANT TO CLONE SEE  &IGURE 	 4YPICALLY ONLY ONE disk will be offered, but if the machine you’re cloning has more than one hard 
drive, you can clone all of them with Clonezilla. 
 Figure 2-9. Select all disks that you want to include in your image.
www.it-ebooks.info

CHAPTER 2 N   USING UBUNTU SERVER FOR SYSTEM IMAGING
43
That’s all. The cloning process will start now. Be patient, because it can take some 
time to complete. 
Summary
In this chapter you’ve learned how to use Ubuntu Server as a system imaging solution. 
This is a very useful solution that allows you to recover from problems on workstations 
fast and easily. In the next chapter you’ll learn all about performance monitoring on 
Ubuntu Server. 
www.it-ebooks.info

45
C H A P T E R  3
Performance Monitoring
Finding Performance Problems  
on Ubuntu Server
Running a server is one thing. Running a server that works well is something else. On 
a server whose default settings haven’t been changed since installation, things may just 
go terribly wrong from a performance perspective. Finding a performance problem on 
a Linux server is not that easy. You need to know what your computer is doing and how to 
interpret performance monitoring data. In this chapter you’ll learn how to do just that. 
To give you a head start, you’ll have a look at pkl first. Though almost everyone 
already knows how to use the pkl utility, few know how to really interpret the data that 
pkl provides. The pkl utility is a very good starting place when analyzing performance on 
your server. It gives you a good indication of what component is causing performance 
problems in your server. After looking at pkl, we’ll consider some advanced utilities that 
help to identify performance problems on particular devices. Specifically, we’ll look at 
performance monitoring on the CPU, memory, storage, and network. 
Interpreting What Your Computer Is Doing: top
Before you start to look at the details produced by performance monitoring, you should 
have a general overview of the current state of your server. The pkl utility is an excellent 
tool to help you with that. As an example for discussion, let’s start by looking at a server 
that is restoring a workstation from an image file, using the Clonezilla imaging solution. 
The pkl output in  Listing 3-1 shows how busy the server is that is doing the restoration. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
46
 Listing 3-1. Analyzing top on a Somewhat Busy Server
pkl),56-56-.ql.-iej(/qoano(hk]`]ran]ca6,*11(,*.-(,*-/
P]ogo6-0,pkp]h(-nqjjejc(-/5ohaalejc(,opklla`(,vki^ea
?lq$o%6,*,!qo(-*,!ou(,*,!je(5,*-!e`(/*5!s](,*,!de(1*,!oe(,*,!op
Iai60,4/.32gpkp]h(545-1.gqoa`(/,50-.0gbnaa(-13-.g^qbbano
Os]l6.,53-00gpkp]h(,gqoa`(.,53-00gbnaa(42.440g_]_da`
LE@QOANLNJERENPNAOODNO!?LQ!IAIPEIA'?KII=J@
1/1,nkkp.,,,,,O,,*,,6,,*,1jbo`
1/12nkkp.,,,,,O,,*,,6,,*,3jbo`
1/15nkkp.,,,,,O,,*,,6,,*,4jbo`
-nkkp.,,-4,032,104O,,*,,6,-*-5ejep
.nkkp-1)1,,,O,,*,,6,,*,,gpdna]``
/nkkpNP)1,,,O,,*,,6,,*,,iecn]pekj+,
0nkkp-1)1,,,O,,*,,6,,*,,gokbpenm`+,
1nkkpNP)1,,,O,,*,,6,,*,,s]p_d`kc+,
2nkkpNP)1,,,O,,*,,6,,*,,iecn]pekj+-
3nkkp-1)1,,,O,,*,,6,,*,,gokbpenm`+-
4nkkpNP)1,,,O,,*,,6,,*,,s]p_d`kc+-
5nkkp-1)1,,,O,,*,,6,,*,,arajpo+,
-,nkkp-1)1,,,O,,*,,6,,*,,arajpo+-
--nkkp-1)1,,,O,,*,,6,,*,,gdahlan
02nkkp-1)1,,,O,,*,,6,,*,,g^hk_g`+,
03nkkp-1)1,,,O,,*,,6,,*,,g^hk_g`+-
1,nkkp-1)1,,,O,,*,,6,,*,,g]_le`
CPU Monitoring with top
When analyzing performance, you start at the first line of the pkl output. The hk]`]ran]ca 
parameters are of particular interest. There are three of them, indicating the load average 
for the last 1 minute, the last 5 minutes, and the last 15 minutes. The anchor value is 1.00. 
You will see 1.00 on a  one- CPU system any time that all CPU cycles are fully utilized but 
no processes are waiting in the queue. 1.00 is the anchor value for each CPU core in your 
system. So, for example, on a  dual- CPU,  quad- core system, the anchor value would be 
8.00.
NNote The load average is for your system, not for your CPU. It is perfectly possible to have a load average 
far above 1.00 even while your CPU is doing next to nothing.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
47
Having a system that works exactly at the anchor value may be good, but it isn’t the 
best solution in all cases. You need to understand more about the nature of a typical 
workload before you can determine whether or not a workload of 1.00 is good. 
Consider, for example, a task that is running completely on one CPU, without caus-
ing overhead in memory or other critical system components. You can force such a task 
by entering the following line of code at the dash prompt:
sdehapnqa7`kpnqa7`kja
This task will completely claim the CPU, thus causing a workload of 1.00. However, 
because this is a task that doesn’t do any I/O, the task does not have waiting times; there-
fore, for a task like this, 1.00 is considered a heavy workload. You can compare this to 
a task that is I/O intensive, such as a task in which your complete hard drive is copied 
to the null device. This task will also easily contribute to a workload that is higher than 
1.00, but because there is a lot of waiting for I/O involved, it’s not as bad as the sdehapnqa 
task from the preceding example line. So, basically, the hk]`]ran]ca line doesn’t give too 
much useful information. When you see that your server’s CPU is quite busy, you should 
find out why it is that busy. By default, pkl gives a summary for all CPUs in your server; 
if you press 1 on your keyboard, pkl will show a line for each CPU core in your server. All 
modern servers are multicore, so you should apply this option. It not only gives you infor-
mation about the multiprocessing environment, but also shows you the performance 
indicators for individual processors and the processes that use them.  Listing 3-2 shows an 
example in which usage statistics are provided on a  dual- core server.
 Listing 3-2. Monitoring Performance on a  Dual- Core Server
pkl),56/06-0ql/2iej(/qoano(hk]`]ran]ca6,*/-(,*11(,*0.
P]ogo6-0,pkp]h(-nqjjejc(-/5ohaalejc(,opklla`(,vki^ea
?lq,6,*/!qo(,*4!ou(,*,!je(5.*4!e`(.*3!s](,*,!de(/*1!oe(,*,!op
?lq-6,*.!qo(,*3!ou(,*,!je(53*/!e`(-*4!s](,*,!de(,*,!oe(,*,!op
Iai60,4/.32gpkp]h(/5/3.44gqoa`(-01544gbnaa(23.g^qbbano
Os]l6.,53-00gpkp]h(-12gqoa`(.,52544gbnaa(/4..3,,g_]_da`
LE@QOANLNJERENPNAOODNO!?LQ!IAIPEIA'?KII=J@
-nkkp.,,-4,032,104O,,*,,6,-*-5ejep
.nkkp-1)1,,,O,,*,,6,,*,,gpdna]``
/nkkpNP)1,,,O,,*,,6,,*,,iecn]pekj+,
0nkkp-1)1,,,O,,*,,6,,*,-gokbpenm`+,
1nkkpNP)1,,,O,,*,,6,,*,,s]p_d`kc+,
2nkkpNP)1,,,O,,*,,6,,*,,iecn]pekj+-
3nkkp-1)1,,,O,,*,,6,,*,.gokbpenm`+-
4nkkpNP)1,,,O,,*,,6,,*,,s]p_d`kc+-
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
48
5nkkp-1)1,,,O,,*,,6,,*,.arajpo+,
-,nkkp-1)1,,,O,,*,,6,,*,,arajpo+-
--nkkp-1)1,,,O,,*,,6,,*,,gdahlan
02nkkp-1)1,,,O,,*,,6,,*,,g^hk_g`+,
03nkkp-1)1,,,O,,*,,6,,*,,g^hk_g`+-
1,nkkp-1)1,,,O,,*,,6,,*,,g]_le`
1-nkkp-1)1,,,O,,*,,6,,*,,g]_le[jkpebu
-/3nkkp-1)1,,,O,,*,,6,,*,,goanek`
The output in  Listing 3-2 provides information that you can use for CPU performance 
monitoring, memory monitoring and process monitoring, as described in the following 
subsections.
CPU Performance Monitoring
When you are trying to determine what your server is doing exactly, the CPU lines (?lq, 
and ?lq- in  Listing 3-2) are important indicators. They enable you to monitor CPU per-
formance, divided into different performance categories. The following list summarizes 
these categories:
 s  qo: Refers to the workload in user space. Typically, this relates to running pro-
cesses that don’t perform many system calls, such as I/O requests or requests to 
hardware resources. If you see a high load here, that means your server is heavily 
used by applications.
 s  ou: Refers to the work that is done in system space. These are important tasks in 
which the kernel of your operating system is involved as well. Load average in sys-
tem space should in general not be too high. It is elevated when running processes 
that don’t perform many system calls (I/O tasks and so on) or when the kernel is 
handling many IRQs or doing many scheduling tasks. 
 s  je: Relates to the number of jobs that have been started with an adjusted je_a 
value. 
 s  e`: Indicates how busy the idle loop is. This special loop indicates the amount of 
time that your CPU is doing nothing. Therefore, a high percentage in the idle loop 
means the CPU is not too busy.
 s  s]: Refers to the amount of time that your CPU is waiting for I/O. This is an impor-
tant indicator. If the value is often above 30 percent, that could indicate a problem 
on the I/O channel that involves storage and network performance. See the sec-
tions “Monitoring Storage Performance” and “Monitoring Network Performance” 
later in this chapter to find out what may be happening. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
49
 s  de: Relates to the time the CPU has spent handling hardware interrupts. You will 
see some utilization here when a device is particularly busy (optical drives do 
stress this parameter from time to time), but normally you won’t ever see it above 
a few percentage points.
 s  oe: Relates to software interrupts. Typically, these are  lower- priority interrupts 
that are created by the kernel. You will probably never see a high utilization in this 
field. 
 s  op: Relates to an environment in which virtualization is used. In some virtual 
environments, the hypervisor (which is responsible for allocating time to virtual 
machines) can take (“steal,” hence “st”) CPU time to give it to virtual machines. 
If this happens, you will see some utilization in the op field. If the utilization here 
starts getting really high, you should consider offloading virtual machines from 
your server. 
Memory Monitoring with top
The second type of information provided by pkl, as shown in  Listing 3-2, is information 
about memory and swap usage. The Iai line contains four parameters:
 s  pkp]h: The total amount of physical memory installed in your server. 
 s  qoa`: The amount of memory that is currently in use by devices or processes. See 
also the information about the ^qbbano and _]_da` parameters (_]_da` is discussed 
following this list).
 s  bnaa: The amount of memory that is not in use. On a typical server that is opera-
tional for more than a couple of hours, you will always see that this value is rather 
low.
 s  ^qbbano: The write cache that your server uses. All data that a server has to write 
to disk is written to the write cache first. From there, the disk controller takes care 
of this data when it has time to write it. The advantage of using the write cache 
is that, from the perspective of the  end- user process, the data is written, so the 
application the user is using does not need to wait anymore. This buffer cache, 
however, is memory that is used for nonessential purposes, and when an applica-
tion needs more memory and can’t allocate that from the pool of free memory, the 
write cache can be written to disk (flushed) so that memory that was used by the 
write cache is available for other purposes. When this parameter is getting really 
high (several hundreds of megabytes), it may indicate a failing storage subsystem. 
In the Os]l line you can find one parameter that doesn’t relate to swap, _]_da`. 
This parameter relates to the number of files that are currently stocked in cache. When 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
50
a user requests a file from the server, the file normally has to be read from the hard disk. 
Because a hard disk is much slower than RAM, this process causes major delays. For 
that reason, every time after fetching a file from the server hard drive, the file is stored in 
cache. This is a read cache and has one purpose only: to speed up reads. When memory 
that is currently allocated to the read cache is needed for other purposes, the read cache 
can be freed immediately so that more memory can be added to the pool of available 
(“free”) memory. Your server will typically see a (very) high amount of cached memory, 
which, especially if your server is used for reads mostly, is considered good, because it 
will speed up your server. If your server is used for reads mostly and this parameter falls 
below 40 percent of total available memory, you will most likely see a performance slow-
down. Add more RAM if this happens. 
Swap and cache are distinctly different. Whereas cache is a part of RAM that is used 
to speed up disk access, swap is a part of disk space that is used to emulate RAM on 
a hard disk. For this purpose, Linux typically uses a swap partition, which you created 
when installing your server. If your server starts using swap, that is bad in most cases, 
because it is about 1,000 times slower than RAM. Some applications (particularly Oracle 
apps) always work with swap, and if you are using such an application, usage of swap is 
not necessarily bad because it improves the performance of the application. In all other 
cases, you should start worrying if more than a few megabytes of swap is used. In Chap-
ter 4, you’ll learn what you can do if your server starts swapping too soon. 
Process Monitoring with top
The last part of the pkl output is reserved for information about the most active pro-
cesses. You’ll see the following parameters regarding these processes:
 s  LE@: The process ID of the process.
 s  QOAN: The user identity used to start the process.
 s  LN: The priority of the process. The priority of any process is determined automati-
cally, and the process with the highest priority is eligible to be run first because it 
is first in the queue of runnable processes. Some processes run with a  real- time 
priority, which is indicated as NP. Processes with this priority can claim CPU cycles 
in real time, which means that they will always have highest priority. 
 s  JE: The je_a value with which the process was started. 
 s  RENP: The amount of memory that was claimed by the process when it first started. 
This is not the same as swap space. Virtual memory in Linux is the total amount of 
memory that is used.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
51
 s  NAO: The amount of the process memory that is effectively in RAM (NAO is short for 
“resident memory”). The difference between RENP and NAO is the amount of the 
process memory that has been reserved for future use by the process. The process 
does not need this memory at this instant, but it may need it in a second. It’s just 
a view of the swap mechanism.
 s  ODN: The amount of memory this process shares with another process.
 s  O: The status of a process.
 s  !?LQ: The percentage of CPU time this process is using. You will normally see the 
process with the highest CPU utilization at the top of this list.
 s  !IAI: The percentage of memory this process has claimed.
 s  PEIA': The total amount of time that this process has been using CPU cycles.
 s  ?KII=J@: The name of the command that relates to this process.
Analyzing CPU Performance
The pkl utility offers a good starting point for performance tuning. However, if you really 
need to dig deep into a performance problem, pkl does not offer enough information, so 
you need more advanced tools. In this section you’ll learn how to find out more about 
CPU  performance- related problems. 
Most people tend to start analyzing a performance problem at the CPU, because 
they think CPU performance is the most important factor on a server. In most situa-
tions, this is not true. Assuming that you have a newer CPU, not an old  486- based CPU, 
you will hardly ever see a performance problem that really is related to the CPU. In most 
cases, a problem that looks like it is caused by the CPU is caused by something else. 
For instance, your CPU may just be waiting for data to be transferred from the network 
device. 
To monitor what is happening on your CPU, you should know something about the 
conceptual background of process handling, starting with the run queue. Before being 
served by the CPU, every process enters the run queue. Once it is in the run queue, a pro-
cess can be runnable or blocked. A runnable process is a process that is competing for 
CPU time. The Linux scheduler decides which runnable process to run next based on the 
current priority of the process. A blocked process doesn’t compete for CPU time. It is just 
waiting for data from some I/O device or system call to arrive. When looking at the system 
load as provided by utilities like qlpeia or pkl, you will see a number that indicates the 
load requested by runnable and blocked processes, as in the following example using the 
qlpeia utility:
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
52
nkkp<iah6zqlpeia
--6.56-3ql.-iej(-qoan(hk]`]ran]ca6,*,,(,*,,(,*,1
A modern Linux system is always a multitasking system. This is true for every proces-
sor architecture that can be used, because the Linux kernel constantly switches between 
different processes. In order to perform this switch, the CPU needs to save all the context 
information for the old process and retrieve context information for the new process. 
The performance price for these context switches is heavy. In an ideal world, you 
need to make sure that the number of context switches is limited to a certain extent. 
You can do this by using a multicore CPU architecture, a server with multiple CPUs, or 
a combination of both. Another solution is to offload processes from a server that is too 
busy. Processes that are serviced by the kernel scheduler, however, are not the only cause 
of context switching. Hardware interrupts, caused by hardware devices demanding the 
CPU’s attention, are another important source of context switching. 
As an administrator, it is a good idea to compare the number of CPU context switches 
with the number of interrupts. This gives you an idea of how they relate, but cannot be 
used as an absolute performance indicator. In my experience, about ten times as many 
context switches as interrupts is fine; if there are many more context switches per inter-
rupt, it may indicate that your server has a performance problem that is caused by too 
many processes competing for CPU power. If this is the case, you will be able to verify 
a rather high workload for those processes with pkl as well. 
NNote Ubuntu Server uses a tickless kernel. That means that the timer interrupt is not included in the 
interrupt listing. Older kernels included those ticks in the interrupt listing, and you may find that to be true on 
other versions of Ubuntu Linux. If this is the case, the interrupt value normally is much higher than the num-
ber of context switches. 
To get an overview of the number of context switches and timer interrupts, you can 
use riop]p)o.  Listing 3-3 shows example output of this command. In this example, the 
performance behavior of the server is pretty normal, as the number of context switches is 
about ten times as high as the number of interrupts.
 Listing 3-3. The Relationship Between Interrupts and Context Switches Gives an Idea of 
What Your Server Is Doing
nkkp<iah6zriop]p)o
.,310,4pkp]hiaiknu
-45.-2,qoa`iaiknu
455200]_peraiaiknu
5/./-.ej]_peraiaiknu
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
53
-4/.04bnaaiaiknu
-454/2^qbbaniaiknu
-000.12os]l_]_da
-,1..-2pkp]hos]l
-,,qoa`os]l
-,1.--2bnaaos]l
//1/055jkj)je_aqoan_lqpe_go
.,454je_aqoan_lqpe_go
-,.33/0ouopai_lqpe_go
-30..3-443e`ha_lqpe_go
/42.54/EK)s]ep_lqpe_go
3//.ENM_lqpe_go
/530-okbpenm_lqpe_go
,opa]h_lqpe_go
.22,./.1l]caol]ca`ej
50342.30l]caol]ca`kqp
3l]caoos]lla`ej
.4l]caoos]lla`kqp
-3.45.2/ejpannqlpo
-5,.22.03?LQ_kjpatposep_dao
-.,510/0-1^kkppeia
0.//,5bkngo
Another performance indicator for what is happening on your CPU is the interrupt 
counter, which you can find in the file +lnk_+ejpannqlpo. The kernel receives interrupts 
from devices that need the CPU’s attention. It is important for the system administrator 
to know how many interrupts there are, because if the number is very high, the kernel will 
spend a lot of time servicing them, and other processes will get less attention.  Listing 3-4 
shows the contents of the +lnk_+ejpannqlpo file, which gives a precise overview of every 
interrupt the kernel has handled since startup.
 Listing 3-4. /proc/interrupts Shows Exactly How Many of Each Interrupt Have Been Handled
nkkp<iah6z_]p+lnk_+ejpannqlpo
?LQ,?LQ-
,641,EK)=LE?)a`capeian
-6.,EK)=LE?)a`cae4,0.
36,,EK)=LE?)a`cal]nlknp,
46/,EK)=LE?)a`canp_
56-,EK)=LE?)b]opake]_le
-.60,EK)=LE?)a`cae4,0.
-265,EK)=LE?)b]opakeqd_e[d_`6qo^-(da_e
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
54
-36,,EK)=LE?)b]opakehe^]p]
-460-0,EK)=LE?)b]opakeqd_e[d_`6qo^1(ad_e[d_`6qo^2(apd-
-56-2-/,,EK)=LE?)b]opakeqd_e[d_`6qo^0(kd_e-/50(he^]p](he^]p]
.-6,,EK)=LE?)b]opakeqd_e[d_`6qo^.
..6.1,,EK)=LE?)b]opakeqd_e[d_`6qo^/(ad_e[d_`6qo^3
./6-55,EK)=LE?)b]opakeD@=Ejpah
.-36.-24,L?E)IOE)a`caapd,
JIE6,,Jkj)i]og]^haejpannqlpo
HK?6.-.,41300.Hk_]hpeianejpannqlpo
NAO6-05/.1Nao_da`qhejcejpannqlpo
?=H6-/0/32bqj_pekj_]hhejpannqlpo
PH>6-.-/3PH>odkkp`ksjo
PNI6,,Pdani]harajpejpannqlpo
OLQ6,,Olqnekqoejpannqlpo
ANN6,
IEO6,
In a  multi- CPU or multicore environment, there can be some very specific 
 performance- related problems. One of the major problems in such environments is that 
processes are served by different CPUs. Every time a process switches between CPUs, 
the information in cache has to be switched as well. You pay a high performance price 
for this. The pkl utility can provide information about the CPU that was last used by any 
process, but you need to switch this on. To do that, from the pkl utility, first use the b 
command and then f. This switches on the option H]opqoa`_lq$OIL% for an SMP envi-
ronment.  Listing 3-5 shows the interface from which you can do this.
 Listing 3-5. Switching Different Options On or Off in top
?qnnajpBeah`o6=ADEKMPSGJI^_`bcflhnoqruvTbknsej`ks-6@ab
Pkcchabeah`ore]beah`happan(pula]jukpdangaupknapqnj
&=6LE@9Lnk_aooE`q6jBHP9L]caB]qhp_kqjp
&A6QOAN9QoanJ]iar6j@NP9@enpuL]cao_kqjp
&D6LN9Lneknepuu6S?D=J9OhaalejcejBqj_pekj
&E6JE9Je_ar]hqav6Bh]co9P]ogBh]co8o_da`*d:
&K6RENP9Renpq]hEi]ca$g^%&T6?KII=J@9?kii]j`j]ia+heja
&M6NAO9Naoe`ajpoeva$g^%
&P6ODN9Od]na`Iaioeva$g^%Bh]cobeah`6
&S6O9Lnk_aooOp]pqo,t,,,,,,,-LB[=HECJS=NJ
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
55
&G6!?LQ9?LQqo]ca,t,,,,,,,.LB[OP=NPEJC
&J6!IAI9Iaiknuqo]ca$NAO%,t,,,,,,,0LB[ATEPEJC
&I6PEIA'9?LQPeia(dqj`na`pdo,t,,,,,,0,LB[BKNGJKATA?
^6LLE@9L]najpLnk_aooLe`,t,,,,,-,,LB[OQLANLNER
_6NQOAN9Na]hqoanj]ia,t,,,,,.,,LB[@QIL?KNA
`6QE@9QoanE`,t,,,,,0,,LB[OECJ=HA@
b6CNKQL9CnkqlJ]ia,t,,,,,4,,LB[IAI=HHK?
c6PPU9?kjpnkhhejcPpu,t,,,,.,,,LB[BNAA[L=CAO$.*1%
f6L9H]opqoa`_lq$OIL%,t,,,,4,,,`a^qcbh]c$.*1%
l6OS=L9Os]lla`oeva$g^%,t,,,.0,,,ola_e]hpdna]`o$.*1%
h6PEIA9?LQPeia,t,,-@,,,,ola_e]hop]pao$.*1%
n6?K@A9?k`aoeva$g^%,t,,-,,,,,LB[QOA@BLQ$pdnq.*0%
o6@=P=9@]p]'Op]_goeva$g^%
After switching on the H]opqoa`?LQ $OIL% option, you will see the column L in pkl 
that displays the number of the CPU that was last used by a process.
To monitor CPU utilization, pkl offers a very good starting point. If that doesn’t give 
you enough information, try the riop]p utility as well. You may need to install this pack-
age first, using ]lp)capejop]hhouoop]p. With riop]p you can get a nice, detailed view of 
what is happening on your server. Of special interest is the _lq section, which contains 
the five most important parameters on CPU usage:
 s  _o: The number of context switches
 s  qo: The percentage of time the CPU has spent in user space
 s  ou: The percentage of time the CPU has spent in system space
 s  e`: The percentage of CPU utilization in the idle loop
 s  s]: The percentage of utilization the CPU was waiting for I/O
There are two ways to use riop]p. Probably the most useful way to run it is in sample 
mode. In this mode, a sample is taken every n seconds, where you specify the number of 
seconds for the sample as an option when starting riop]p. Running performance moni-
toring utilities in this way is always good, because it shows you progress over a given 
amount of time. You may find it useful as well to run riop]p for a given amount of time 
only. For instance,  Listing 3-6 shows output of a riop]p command that takes a sample 
30 times with a  2- second interval between samples. This was started by entering the com-
mand riop]p./,.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
56
Listing 3-6. In Sample Mode, vmstat Can Give You Trending Information
nkkp<iah6zriop]p./,
lnk_o)))))))))))iaiknu)))))))))))))os]l)))))))ek)))))ouopai))))))_lq))))
n^osl`bnaa^qbb_]_daoeok^e^kej_oqooue`s]
,,,/45/4.,./3-213-4,,,2/-.0,,-,,,
,,,/45/112./40413-04,,0.4.45.-2,,55-
,,,/45/11../40413.04,,,,.0,,,-,,,
,,,/45/11../40413.04,,,,./5,,-,,,
,,,/45/11../40413.04,,,/0--00,,-,,,
,,,/45-01../41215/-.,,-,424-0.0.4/5,-54,
,,,/44423../4122..2,,,-0.0,..3.01/.,.54,
,,,/444244./4122..2,,,,,./5,,-,,,
,,,/444244./4122..2,,,,4/0-,,-,,,
,,,/444244./4122..2,,,,,./5,,-,,,
,,,/444244./4122..2,,,,,./5,,-,,,
,,,/44.544.0/,023,,,,,.1421.0,35.41-,033.,
,,,/44-.2,.0/4424.4,,,22.,-510.2-2,.52.
,,,/4351/..02,0254,4,,43.04.31./131,/445
,,,/435,,,.025.3,0,,,,/.,,-31..33/,-510
,,,/434000.03.03,51.,,/,4,41.--.1,-511
,,,/434000.03.03,51.,,,0,4/5,,-,,,
,,,/434/.,.03.03,51.,,,2/01,,-,,,
,,,/434/.,.03.03,51.,,,,./4,,-,,,
,,,/434.,0.03243,52,,,0/03,-2/,,-,,,
,,,/434.,0.03243,52,,,,,./5,,-,,,
n^osl`bnaa^qbb_]_daoeok^e^kej_oqooue`s]
,,,/434.,0.033.3,512,,-,2-1,//.,,55,
,,,/4322.4.04243.4-.,,35.,/-040,21,/444
,,,/430.32.1-4030-0,,,400-.14123/55,040-.
,,,/43.5-2.1.3231100,,244...-02-2-5,.5,5
,,,/43.5-2.1.3231100,,,,./5,,-,,,
,,,/43.5-2.1.3231100,,,/,.-100,,-,,,
,,,/43.5-2.1.3231100,,,,./5,,-,,,
,,,/43.5-2.1.3231100,,,,./4,,-,,,
,,,/43.5-2.1.3231100,,,,.01,,-,,,
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
57
Another useful way to run riop]p is with the option )o. In this mode, riop]p shows 
you all the statistics since the system booted. As you can see in  Listing 3-6, apart from the 
 CPU- related options, riop]p also shows information about processors, memory, swap, 
I/O, and the system. These options are covered later in this chapter.
Finding Memory Problems
Memory is very important on a server, possibly more important than CPU. The CPU can 
work smoothly only if processes are ready in memory and can be offered from there; if 
this is not the case, the server has to get its data from the I/O channel, which is about 
1,000 times slower to access than memory. From the processor’s point of view, even sys-
tem RAM is relatively slow. Therefore, modern server processors have large amounts of 
cache, which is even faster than memory. 
You have read earlier in this chapter how to interpret basic memory statistics 
provided by pkl, so I will not cover them again in this section. Instead, I cover some 
 more- advanced  memory- related information. First, you should know that in memory 
a default page size is used. On an i386 system, typically 4 KB pages are used. This means 
that everything that happens, happens in chunks of 4 KB. There is nothing wrong with 
that if you have a server handling large amounts of small files. If, however, your server 
handles huge files, it is highly inefficient if only these small 4 KB pages are used. For that 
purpose, huge pages can be used, with a size of up to 2 MB. You’ll learn how to set these 
up in Chapter 4.
If a server runs out of memory, it resorts to using swap memory. Swap memory is 
emulated RAM on your server’s hard drive. Because the hard disk is involved in swapping, 
you should avoid it at all times; access times to a hard drive are about 1,000 times slower 
than access times to RAM. If your server is slow, swap usage is the first thing to look at. 
You can do this by using the command bnaa)i. This gives you an overview similar to the 
output shown in  Listing 3-7.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
58
 Listing 3-7. free -m Provides Information About Swap Usage
nkkp<iah6zbnaa)i
pkp]hqoa`bnaaod]na`^qbbano_]_da`
Iai6/543/40--02,5/3-5
)+'^qbbano+_]_da6--./431
Os]l6.,03,.,03
As you can see, on the server from which this sample is taken, nothing is wrong—
there is no swap usage at all, and that is good. 
On the other hand, if you see that your server is swapping, the next thing you need to 
know is how actively it is swapping. The riop]p utility provides useful information about 
this. This utility provides swap information in the oe (swap in) and ok (swap out) columns. 
If you see no swap activity at all, that’s fine. In that case, swap space has been allocated 
but is not used. If, however, you do see significant activity in these columns, you’re in 
trouble. This means that swap space is not only allocated, but also being used, and that 
will really slow down your server. The solution? Reduce the workload on this server. To 
do this, you must make sure that you move processes that use lots of memory to another 
server, and that is where pkl comes in handy. In the !IAI column, pkl gives information 
about memory usage. Find the most active process and make sure that it loads some-
where else. 
When swapping memory pages in and out, your server uses the difference between 
active and inactive memory. Inactive memory is memory that hasn’t been used for some 
time, whereas active memory is memory that has been used recently. When moving 
memory blocks from RAM to swap, the kernel makes sure that only blocks from inactive 
memory are moved. You can see statistics about active and inactive memory by using 
riop]p)o. In the example in  Listing 3-8, you can see that the amount of active memory is 
relatively small compared to the amount of inactive memory. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
59
 Listing 3-8. Use vmstat -s to Get Statistics About Active vs. Inactive Memory
nkkp<iah6zriop]p)o
0,4/.32Gpkp]hiaiknu
/5//.20Gqoa`iaiknu
5,5,0G]_peraiaiknu
/342044Gej]_peraiaiknu
-1,,-.Gbnaaiaiknu
30/2G^qbbaniaiknu
/4-..,4Gos]l_]_da
.,53-00Gpkp]hos]l
,Gqoa`os]l
.,53-00Gbnaaos]l
352jkj)je_aqoan_lqpe_go
,je_aqoan_lqpe_go
-120ouopai_lqpe_go
40,.1e`ha_lqpe_go
0/22EK)s]ep_lqpe_go
,ENM_lqpe_go
.5/5okbpenm_lqpe_go
,opkhaj_lqpe_go
/55/222l]caol]ca`ej
.,-23l]caol]ca`kqp
,l]caoos]lla`ej
,l]caoos]lla`kqp
00212ejpannqlpo
0/42-,?LQ_kjpatposep_dao
-.-/11/415^kkppeia
123-bkngo
Another issue that you should be aware of is that on  32- bit processors, there is 
a problem accessing memory above 1 GB directly. To make it possible to access this 
memory anyway, Linux uses high and low memory. High memory is not accessible 
directly by the kernel, so typically  user- space programs are loaded here. The kernel can 
only address low memory directly. On  64- bit processors, this difference does not exist. 
Some Linux kernels have a problem addressing memory on servers with 4 GB or more of 
memory. On those kernels, you’ll see about 3.2 GB of RAM only. Ubuntu Server, however, 
addresses this issue by using a kernel with Physical Address Extensions (PAEs) by default. 
These kernels can address as much as 16 GB of RAM.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
60
When analyzing memory usage, you should take into account the memory that is 
used by the kernel itself as well. This is called slab memory. You can see the amount of 
slab memory currently in use in the +lnk_+iaiejbk file.  Listing 3-9 gives an example of the 
contents of this file, which gives you detailed information about memory usage.
 Listing 3-9. /proc/meminfo Gives Detailed Information About Memory Usage
nkkp<iah6z_]p+lnk_+iaiejbk
IaiPkp]h60,4/.32g>
IaiBnaa6-05000g>
>qbbano6402,g>
?]_da`6/4--100g>
Os]l?]_da`6,g>
=_pera630--.g>
Ej]_pera6/4,/124g>
DecdPkp]h6/.,50.,g>
DecdBnaa64-,0g>
HksPkp]h643/412g>
HksBnaa6-0-/0,g>
Os]lPkp]h6.,53-00g>
Os]lBnaa6.,53-00g>
@enpu64,g>
Snepa^]_g6,g>
=jkjL]cao6133-2g>
I]lla`6-.25.g>
Oh]^6-4012g>
ONa_h]ei]^ha60524g>
OQjna_h]ei6-/044g>
L]caP]^hao6-/12g>
JBO[Qjop]^ha6,g>
>kqj_a6,g>
?kiiepHeiep60-/434,g>
?kiieppa`[=O620453.g>
Ri]hhk_Pkp]h6--4332g>
Ri]hhk_Qoa`64,2,g>
Ri]hhk_?dqjg6--,.0,g>
DqcaL]cao[Pkp]h6,
DqcaL]cao[Bnaa6,
DqcaL]cao[Nor`6,
DqcaL]cao[Oqnl6,
Dqcal]caoeva6.,04g>
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
61
In  Listing 3-9, you can see that the amount of memory that is used by the Linux 
kernel is relatively small. But what exactly does it mean that about 18 MB is used by the 
kernel? If you need more details about that, you may like the oh]^pkl utility. This utility 
provides information about the different parts (referred to as objects) of the kernel and 
what exactly they are doing. For normal performance analysis purposes, the OEVA and 
J=IA columns are the most interesting ones. The other columns are of interest mainly to 
programmers and kernel developers and are therefore not described in this chapter. In 
 Listing 3-10, you can see an example of information provided by oh]^pkl. 
 Listing 3-10. slabtop Provides Information About Kernel Memory Usage
nkkp<iah6zoh]^pkl
=_pera+Pkp]hK^fa_po$!qoa`%641411+4411,$53*,!%
=_pera+Pkp]hOh]^o$!qoa`%60-.,+0-.,$-,,*,!%
=_pera+Pkp]h?]_dao$!qoa`%614+30$34*0!%
=_pera+Pkp]hOeva$!qoa`%6-3./0*41G+-3443*--G$52*0!%
Iejeiqi+=ran]ca+I]teiqiK^fa_p6,*,-G+,*.,G+4*,,G
K>FO=?PERAQOAK>FOEVAOH=>OK>F+OH=>?=?DAOEVAJ=IA
-2-54-2-5/55!,*.5G-.02-/0540Gn]`et[pnaa[jk`a
-/.2,-/.2,-,,!,*,1G-12412.0Gouobo[`en[_]_da
-.,5,-.,4.55!,*-/G0,//,-2-.G`ajpnu
2-002-00-,,!,*,-G-.1-.04Ggi]hhk_)4
1-.,02-55,!,*,.G.,.124,Ggi]hhk_)-2
/524/4/252!,*,2G2.20.04Ggi]hhk_)20
//2,//1355!,*//G.4,-.--.,Gejk`a[_]_da
/.-2/.-2-,,!,*04G0,.4-2,4Gatp/[ejk`a[_]_da
/.-..01232!,*,1G003/-32G^qbban[da]`
/-24/-24-,,!,*0/G/1.5-0,4Godiai[ejk`a[_]_da
.3-0.20553!,*,5G1502./2Gri[]na][opnq_p
./4,...55/!,*,.G-0-3,12G=_le)J]iaol]_a
.,04.,0355!,*,/G-2-.420Ggi]hhk_)/.
-341-20-5-!,*-5G41.-/0,Ggi]hhk_)-5.
-03.5/32/!,*-.G02/.-40Ggi]hhk_)-.4
---.-,5154!,*1,G-/54112Ggi]hhk_)1-.
The most interesting information you get from oh]^pkl is the amount of memory 
a particular slab is using. If this amount of memory seems too high, there may be some-
thing wrong with this module and you might need to update your kernel. The oh]^pkl 
utility may also be able to help you find information on how much resources a certain 
kernel module is using. For instance, you’ll find information about the caches your file 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
62
system drivers are using, and this may indicate that it is better to use another file system 
after all. 
When tuning memory utilization, another utility that you should never forget is lo. 
The advantage of lo is that it gives memory usage information on all processes on your 
server, and it is easy to cnal on its result to find information about particular processes. 
To monitor memory usage, the lo]qt command is very useful. It gives memory informa-
tion in the ROV and NOO columns. ROV provides information about the virtual memory that 
is used. This relates to the total amount of memory that is claimed by a process. NOO refers 
to the amount of hardware memory that is in use.  Listing 3-11 gives an example of some 
lines of lo]qt output. 
 Listing 3-11. ps aux Gives Memory Usage Information for Particular Processes
nkkp<iah6zlo]qt
QOANLE@!?LQ!IAIROVNOOPPUOP=POP=NPPEIA?KII=J@
nkkp-,*,,*,.400-25.;Oo-06-3,6,-+o^ej+ejep
nkkp.,*,,*,,,;O8-06-3,6,,Wgpdna]``Y
nkkp/,*,,*,,,;O8-06-3,6,,Wiecn]pekj+,Y
nkkp0,*,,*,,,;O8-06-3,6,,Wgokbpenm`+,Y
nkkp1,*,,*,,,;O8-06-3,6,,Ws]p_d`kc+,Y
nkkp2,*,,*,,,;O8-06-3,6,,Wiecn]pekj+-Y
***
sss)`]p]1130,*,,*,./1.000,.0;Oh-06-4,6,,+qon+o^ej+]l]_d
nkkp12/3,*,,*,.124-.-2ppu-Oo-06-4,6,,+^ej+hkcej))
nkkp12/4,*,,*,0-5.-320ppu-O'-06-4,6,,)^]od
nkkp1214,*,,*,4,1..052;Oo-06.1,6,,ood`6nkkp<lpo+
nkkp122-,*,,*,0-32-3/2lpo+,Oo-06.1,6,,)^]od
nkkp13-5,*,,*,/2/.-,/2lpo+,N'-16,,,6,,lo]qt
When looking at the output of lo]qt, you may notice that there are two different 
kinds of processes. The names of some are between square brackets, whereas the names 
of others are not. If the name of a process is between square brackets, the process is part 
of the kernel. All other processes are “normal” processes. 
If you need more information about a process and what exactly it is doing, there are 
two ways to get that information. First, you can check the +lnk_ directory for the par-
ticular process; for instance, +lnk_+1214 gives information for the process with PID 5658. 
In this directory, you’ll find the i]lo file that gives some more insight into how memory 
is mapped for this process. As you can see in  Listing 3-12, this information is rather 
detailed. It includes the exact memory addresses this process is using and even tells you 
about subroutines and libraries that are related to this process. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
63
 Listing 3-12. /proc/PID/maps Gives Detailed Information on Memory Utilization of 
Particular Processes
nkkp<iah6z_]p+lnk_+1214+i]lo
^334-,,,)^34_-,,,ns)o,,,,,,,,,,6,5-00-0+`ar+vank$`ahapa`%
^34_-,,,)^34_0,,,n)tl,,,,,,,,ba6,,14,4/.5+he^+oa_qnepu+l]i[heiepo*ok
^34_0,,,)^34_1,,,ns)l,,,,.,,,ba6,,14,4/.5+he^+oa_qnepu+l]i[heiepo*ok
^34_1,,,)^34_3,,,n)tl,,,,,,,,ba6,,14,4//0+he^+oa_qnepu+l]i[i]eh*ok
^34_3,,,)^34_4,,,ns)l,,,,-,,,ba6,,14,4//0+he^+oa_qnepu+l]i[i]eh*ok
^34_4,,,)^34`/,,,n)tl,,,,,,,,ba6,,14,4/1-+he^+oa_qnepu+l]i[qjet*ok
^34`/,,,)^34`0,,,ns)l,,,,^,,,ba6,,14,4/1-+he^+oa_qnepu+l]i[qjet*ok
^34`0,,,)^34a,,,,ns)l^34`0,,,,,6,,,
***
^3a^3,,,)^3a^4,,,n)tl,,,,,,,,ba6,,14,4//4+he^+oa_qnepu+l]i[jkhkcej*ok
^3a^4,,,)^3a^5,,,ns)l,,,,,,,,ba6,,14,4//4+he^+oa_qnepu+l]i[jkhkcej*ok
^3a^5,,,)^3a^^,,,ns)l^3a^5,,,,,6,,,
^3a^^,,,)^3a^_,,,n)tl^3a^^,,,,,6,,,Wr`okY
^3a^_,,,)^3a`2,,,n)tl,,,,,,,,ba6,,14,4-01+he^+h`).*3*ok
^3a`2,,,)^3a`4,,,ns)l,,,-5,,,ba6,,14,4-01+he^+h`).*3*ok
^3a`4,,,)^3b/-,,,n)tl,,,,,,,,ba6,,-,332/,+qon+o^ej+ood`
^3b/-,,,)^3b//,,,ns)l,,,15,,,ba6,,-,332/,+qon+o^ej+ood`
^3b//,,,)^3b1^,,,ns)l^3b//,,,,,6,,,Wda]lY
^bb5],,,)^bb]b,,,ns)l^bba^,,,,,6,,,Wop]_gY
Another way of finding out what particular processes are doing is to use the li]l 
command. This command mines the +lnk_+LE@+i]lo file to provide information about 
subprocesses that have memory in use. Also, it adds a summary of memory usage, as dis-
played by lo]qt.  Listing 3-13 gives an impression of the output of this utility.
 Listing 3-13. pmap Mines /proc/PID/maps to Provide Its Information
nkkp<iah6zli]l)`1214
12146ood`6nkkp<lpo+,
=``naooG^upaoIk`aKbboap@are_aI]llejc
^334-,,,-.4,ns)o),,,,,,,,,,,,,,,,,,,6,,,,5vank$`ahapa`%
^34_-,,,-.n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[heiepo*ok
^34_0,,,0ns))),,,,,,,,,,,,.,,,,ba6,,,,,l]i[heiepo*ok
^34_1,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[i]eh*ok
^34_3,,,0ns))),,,,,,,,,,,,-,,,,ba6,,,,,l]i[i]eh*ok
^34_4,,,00n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[qjet*ok
^34`/,,,0ns))),,,,,,,,,,,,^,,,,ba6,,,,,l]i[qjet*ok
^34`0,,,04ns))),,,,,,,,^34`0,,,,,,6,,,,,W]jkjY
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
64
^34a,,,,-2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^joo[`jo).*3*ok
^34a0,,,4ns))),,,,,,,,,,,,/,,,,ba6,,,,,he^joo[`jo).*3*ok
^34a2,,,-.n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[ajr*ok
^34a5,,,0ns))),,,,,,,,,,,,.,,,,ba6,,,,,l]i[ajr*ok
^34a^,,,-.4,ns)o),,,,,,,,,,,,,,,,,,,6,,,,5vank$`ahapa`%
^3]/^,,,/2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^joo[behao).*3*ok
^3]00,,,4ns))),,,,,,,,,,,,4,,,,ba6,,,,,he^joo[behao).*3*ok
^3]02,,,/.n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^joo[jeo).*3*ok
^3]0a,,,4ns))),,,,,,,,,,,,3,,,,ba6,,,,,he^joo[jeo).*3*ok
^3]1,,,,.4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^joo[_kil]p).*3*ok
^3]13,,,4ns))),,,,,,,,,,,,2,,,,ba6,,,,,he^joo[_kil]p).*3*ok
^3]15,,,4ns))),,,,,,,,^3]15,,,,,,6,,,,,W]jkjY
^3]1^,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^gauqpeho)-*.*ok
^3]1`,,,0ns))),,,,,,,,,,,,-,,,,ba6,,,,,he^gauqpeho)-*.*ok
^3]1a,,,.4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^gn^1oqllknp*ok*,*-
^3]21,,,0ns))),,,,,,,,,,,,2,,,,ba6,,,,,he^gn^1oqllknp*ok*,*-
^3]22,,,-/-2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^_).*3*ok
^3^]b,,,0n)))),,,,,,,,,,-05,,,,ba6,,,,,he^_).*3*ok
^3^^,,,,4ns))),,,,,,,,,,-0],,,,ba6,,,,,he^_).*3*ok
^3^^.,,,-.ns))),,,,,,,,^3^^.,,,,,,6,,,,,W]jkjY
^3^^1,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^_ki[ann*ok*.*-
^3^^3,,,0ns))),,,,,,,,,,,,-,,,,ba6,,,,,he^_ki[ann*ok*.*-
^3^^4,,,-/2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^g1_nulpk*ok*/*-
^3^`],,,0ns))),,,,,,,,,,,..,,,,ba6,,,,,he^g1_nulpk*ok*/*-
^3^`^,,,0ns))),,,,,,,,^3^`^,,,,,,6,,,,,W]jkjY
^3^`_,,,112n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^gn^1*ok*/*/
^3_23,,,4ns))),,,,,,,,,,,4],,,,ba6,,,,,he^gn^1*ok*/*/
^3_25,,,-2,n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^coo]le[gn^1*ok*.*.
^3_5-,,,0ns))),,,,,,,,,,,.4,,,,ba6,,,,,he^coo]le[gn^1*ok*.*.
^3_5.,,,/2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^_nulp).*3*ok
^3_5^,,,4ns))),,,,,,,,,,,,4,,,,ba6,,,,,he^_nulp).*3*ok
^3_5`,,,-12ns))),,,,,,,,^3_5`,,,,,,6,,,,,W]jkjY
^3__0,,,4,n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^joh).*3*ok
^3_`4,,,4ns))),,,,,,,,,,,-/,,,,ba6,,,,,he^joh).*3*ok
^3_`],,,4ns))),,,,,,,,^3_`],,,,,,6,,,,,W]jkjY
^3_`_,,,4,n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^v*ok*-*.*/*/
^3_b,,,,0ns))),,,,,,,,,,,-/,,,,ba6,,,,,he^v*ok*-*.*/*/
^3_b-,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^qpeh).*3*ok
^3_b/,,,4ns))),,,,,,,,,,,,-,,,,ba6,,,,,he^qpeh).*3*ok
^3_b1,,,0ns))),,,,,,,,^3_b1,,,,,,6,,,,,W]jkjY
^3_b2,,,--5.n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^_nulpk*ok*,*5*4
^3a.,,,,40ns))),,,,,,,,,,-.5,,,,ba6,,,,,he^_nulpk*ok*,*5*4
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
65
^3a/1,,,-.ns))),,,,,,,,^3a/1,,,,,,6,,,,,W]jkjY
^3a/4,,,2,n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^naokhr).*3*ok
^3a03,,,4ns))),,,,,,,,,,,,b,,,,ba6,,,,,he^naokhr).*3*ok
^3a05,,,4ns))),,,,,,,,^3a05,,,,,,6,,,,,W]jkjY
^3a0^,,,.,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^`^qo)-*ok*/*0*,
^3a3b,,,4ns))),,,,,,,,,,,//,,,,ba6,,,,,he^`^qo)-*ok*/*0*,
^3a4-,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^_g)_kjja_pkn*ok*,*,*,
^3a4/,,,0ns))),,,,,,,,,,,,-,,,,ba6,,,,,he^_g)_kjja_pkn*ok*,*,*,
^3a40,,,5.n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^oahejqt*ok*-
^3a5^,,,4ns))),,,,,,,,,,,-2,,,,ba6,,,,,he^oahejqt*ok*-
^3a5`,,,4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^`h).*3*ok
^3a5b,,,4ns))),,,,,,,,,,,,-,,,,ba6,,,,,he^`h).*3*ok
^3a]-,,,0ns))),,,,,,,,^3a]-,,,,,,6,,,,,W]jkjY
^3a].,,,/2n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^l]i*ok*,*4-*2
^3a]^,,,0ns))),,,,,,,,,,,,4,,,,ba6,,,,,he^l]i*ok*,*4-*2
^3a]_,,,.4n)t)),,,,,,,,,,,,,,,,,ba6,,,,,he^sn]l*ok*,*3*2
^3a^/,,,0ns))),,,,,,,,,,,,3,,,,ba6,,,,,he^sn]l*ok*,*3*2
^3a^1,,,0n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[ikp`*ok
^3a^2,,,0ns))),,,,,,,,,,,,,,,,,ba6,,,,,l]i[ikp`*ok
^3a^3,,,0n)t)),,,,,,,,,,,,,,,,,ba6,,,,,l]i[jkhkcej*ok
^3a^4,,,0ns))),,,,,,,,,,,,,,,,,ba6,,,,,l]i[jkhkcej*ok
^3a^5,,,4ns))),,,,,,,,^3a^5,,,,,,6,,,,,W]jkjY
^3a^^,,,0n)t)),,,,,,,,^3a^^,,,,,,6,,,,,W]jkjY
^3a^_,,,-,0n)t)),,,,,,,,,,,,,,,,,ba6,,,,,h`).*3*ok
^3a`2,,,4ns))),,,,,,,,,,,-5,,,,ba6,,,,,h`).*3*ok
^3a`4,,,/12n)t)),,,,,,,,,,,,,,,,,ba6,,,,,ood`
^3b/-,,,4ns))),,,,,,,,,,,15,,,,ba6,,,,,ood`
^3b//,,,-2,ns))),,,,,,,,^3b//,,,,,,6,,,,,W]jkjY
^bb5],,,40ns))),,,,,,,,^bba^,,,,,,6,,,,,Wop]_gY
i]lla`64,1.Gsnepa]^ha+lner]pa634,God]na`6.12,G
One of the advantages of the li]l command is that it gives detailed information 
about the order in which a process does its work. You can see calls to external libraries, 
as well as additional memory allocation (malloc) requests that the program is making, as 
reflected in the lines that have W]jkjY at the end. 
Monitoring Storage Performance
One of the hardest things to do properly is to monitor storage utilization. The reason is 
that the storage channel typically is at the end of the chain. Other elements in your server 
can have a positive or negative influence on storage performance. For instance, if your 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
66
server is low on memory, that will be reflected in storage performance, because if your 
server doesn’t have enough memory, there can’t be a lot of cache and buffers, and thus 
your server has more work to do on the storage channel. Likewise, a slow CPU can have 
a negative impact on storage performance, because the queue of runnable processes 
can’t be cleared fast enough. Therefore, before jumping to the conclusion that you have 
bad performance on the storage channel, you need to take other factors into consider-
ation as well. 
It is generally hard to optimize storage performance on a server. The best behavior 
really depends on the kind of workload your server typically has. For instance, a server 
that has a lot of reads has different needs from those of a server that does mainly writes. 
A server that is doing writes most of the time may benefit from a storage channel with 
many disks, because more controllers can work on clearing the write buffer cache from 
memory. If, however, your server is mainly reading data, the effect of having many disks 
is just the opposite. Because of the large number of disks, seek times will increase and 
therefore performance will be negatively impacted. 
The following are some indicators that you are experiencing storage performance 
problems:
 s  -EMORY BUFFERS AND CACHE ARE HEAVILY USED BUT #05 UTILIZATION IS LOW
 s  $ISK OR CONTROLLER UTILIZATION IS HIGH
 s  .ETWORK RESPONSE TIMES ARE LONG BUT NETWORK UTILIZATION IS LOW
Before you try to understand storage performance, there is another factor that you 
should consider: the way that disk activity typically takes place. First, a storage device 
generally handles large sequential transfers better than it handles small random transfers. 
The reason is that, in memory, you can configure  read- ahead and write buffers, which 
means that the storage controller is likely to go to the next block to which it needs to go. 
If your server handles small files mostly,  read- ahead buffers have no effect at all, or might 
even slow down your server. In Chapter 5, you will learn how to optimize your server for 
such a workload. 
From the perspective of which tools to use, there are two tools that really count when 
doing disk performance analysis. Before you read about these tools, however, you should 
be aware of the shortcomings of analyzing disk performance. The most important prob-
lem is that the Linux kernel does not track I/O of a process. This means that there are no 
tools that help you find which process is causing all disk I/O traffic. You can only try to 
deduce what process is causing a high I/O load, by analyzing other factors such as mem-
ory utilization and CPU utilization of that particular process. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
67
The best tool to start your disk performance analysis is riop]p. This tool has a couple 
of options that help you see what is happening on a particular disk device, such as )`, 
which gives you statistics for individual disks, and )l, which gives partition performance 
statistics. As you already know, you can use riop]p with an ejpanr]h parameter and a _kqjp 
parameter.  Listing 3-14 shows the result of the command riop]p)`, which gives detailed 
information on storage utilization for all disk devices on your server.
 Listing 3-14. vmstat Is the Best Utility to Get Information About Storage Utilization
nkkp<iah6zriop]p)`
`eog)))))))))))))na]`o))))))))))))))))))))))))snepao))))))))))))))))EK))))))
pkp]hianca`oa_pknoiopkp]hianca`oa_pknoio_qnoa_
n]i,,,,,,,,,,,
***
o`]/02543155-2-,-,/.,-0-300.-041,.,-,,4
o`^0-213451502-0-235,.,,-2--.,42,.00,,-0
on,,,,,,,,,,,
i`,..153,-4,4,,,0031,/130,,,,
`i),-/3,,,-,515014,3,.,,,-2,,--,,--
`i)--,0,4/.52,,,,,,,
`i).4,5.,203/2.,,3,0-/1,//,4,11.,,5
`i)/.45,.-21.42,22,1-0,,,
`i)0-3/,-.,5-0,,22,1-0,,,
***
o`b,,,,,,,,,,
hkkl,,,,,,,,,,,
hkkl3,,,,,,,,,,
The output of this command shows detailed statistics about the reads and writes that 
have occurred on a disk. The following parameters are displayed when using riop]p)`: 
 s  na]`o: pkp]h: Total number of reads requested.
 s  na]`o: ianca`: Total number of adjacent locations that have been merged to 
improve performance. This is the result of the na]`]da]` parameter. High num-
bers are good here, because a high number means that within the same read 
request, a couple of adjacent blocks have been read as well. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
68
 s  na]`o: oa_pkno: Total number of disk sectors that have been read. 
 s  na]`o: io: Total time spent reading from disk.
 s  snepao: pkp]h: Total number of writes.
 s  snepao: ianca`: Total number of writes to adjacent sectors.
 s  snepao: oa_pkno: Total number of sectors that have been written.
 s  snepao: io: Total time, in milliseconds, your system has spent writing data.
 s  EK: _qn: Total number of I/O requests currently in progress.
 s  EK: oa_: Total amount of time spent waiting for I/O to complete. 
Another way of monitoring disk performance with riop]p is by running riop]p in 
sample mode. For instance, riop]p.-1 will run 15 samples with a  2- second interval. 
 Listing 3-15 shows the result of this command. 
 Listing 3-15. Sample Mode Provides a  Real- Time Impression of Disk Utilization
nkkp<iah6zriop]p.-1
lnk_o)))))))))))iaiknu)))))))))))))os]l)))))))ek)))))ouopai))))))_lq))))
n^osl`bnaa^qbb_]_daoeok^e^kej_oqooue`s]
,,,/2220,,-0/00.5.052,,1201353,,,55,
,,,/20101.-0/00/-/24,,,-,12,,-.,02.-45,050.
,-/,/2.//20-0/00//133.,,--,0,,-.-.3...-,25..
,,,/2,.,/.-0/4,/1244,,,-,12,-4-..11././,35,/
,,,/14.,04-0/4,/33-.0,,-,,4,,--1.1.,45,05//
,,,/12-,32-0/4,/54-2,,,-,12,.0-.,25.-0-,15-0
,,,/1/521.-0/4,0-5.4,,,-,12,,--5-/..,5,05.0
,,,/1-4,-2-0/4,00,//2,,-,12,,--2/....2,35,/
,,,/054312-0/4,0152,,,,52,,,-,4...011,05./
,,,/0334/.-0/4,04,4,,,,-,12,,-.,--..35,/50.
,,,/0122,,-0/4,1,-40,,,-,12,,-.,34.23,,/50/
,,,/0/12/2-0/4,1./,00,,-,12,,-.-,2-41,,/5/0
,,,/0-04.0-0/4,100,-2,,-,12,,--545-3/-,/5.0
,,,//5/1-2-0/4,121-/2,,-,12,,--5-5-521,25..
,,,//3,5.,-0/4,143.-2,,--,0,,-./34.,.,,15,0
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
69
The columns that count in  Listing 3-15 are the ek: ^e and ek: ^k columns, because they 
show you the number of blocks that came in from the storage channel (^e) and the num-
ber of blocks that were written to the storage channel (^k). In  Listing 3-15, it is pretty clear 
that the server is busy servicing some heavy read requests and is doing nearly no writes at 
all. You should be aware, however, that it is not always this easy. In some situations you 
will find that some clients are performing heavy read requests while your server shows 
next to no activity in the ek: ^e column. If that happens, the reason probably is that the 
data that was read is still in cache. 
Another tool to monitor performance on the storage channel is ekop]p. It provides an 
overview per device of the number of reads and writes. In the example in  Listing 3-16, you 
can see the following device parameters being displayed:
 s  plo: Number of transactions (reads plus writes) handled per second
 s  >hg[na]`+o: Number of blocks read per second
 s  >hg[snpj+o: Rate of disk blocks written per second
 s  >hg[na]`: Total number of blocks read since startup
 s  >hg[snpj: Total number of blocks written since startup
 Listing 3-16. iostat Provides Information About the Number of Blocks Read and Written 
per Second
nkkp<iah6zekop]p
Hejqt.*2*.0)-2)oanran$iah%,2+-2+.,,4
]rc)_lq6!qoan!je_a!ouopai!eks]ep!opa]h!e`ha
,*-.,*,,-*-.,*50,*,,53*4.
@are_a6plo>hg[na]`+o>hg[snpj+o>hg[na]`>hg[snpj
o`]5*4/.,12*111*3.3/10.-4.,022
o`^4*54.,13*2,3*533/1351,.41,4
i`,1-1*4/0--.*20-/*3,-03,230005,,0
`i),1*130/*-/-*03-10.-41.20
`i)-,*,/,*./,*,,4/.,
`i)./*32-4*-4--*5021,-20.24,
`i)/,*-,,*2-,*-0.-211-0
`i)01,2*.50,05*42,*-0-004..051-0
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
70
If ekop]p doesn’t give you enough detail, you can use the )t option as well. This 
option gives lots of information, and therefore doesn’t fit on the screen nicely in most 
cases.  Listing 3-17 shows an example of ekop]p)t being used.
 Listing 3-17. iostat -x Provides Much Information About What Is Happening on the 
Storage Channel
nkkp<iah6zekop]p)t
Hejqt.*2*.0)-2)oanran$iah%,2+-2+.,,4
]rc)_lq6!qoan!je_a!ouopai!eks]ep!opa]h!e`ha
,*--,*,,-*2/-*.0,*,,53*,.
@are_a6nnmi+osnmi+on+os+onoa_+osoa_+o±
]rcnm)ov]rcmq)ov]s]epor_pi!qpeh
o`]/23*54,*..-/*1/,*00/-/1*-11*./±
..0*5-,*,/-*43-*-1-*2,
o`^/25*2,,*.4--*5-,*2//-/2*,13*.2±
.1,*20,*,/.*,5-*/5-*30
i`,,*,,,*,,34/*4.-*122.25*43-.*1,±
4*,,,*,,,*,,,*,,,*,,
`i),,*,,,*,,0*3-,*-2/3*21-*.4±
4*,,,*,.0*12,*4,,*/5
`i)-,*,,,*,,,*,/,*,-,*.,±
,*,44*,,,*,,3*.3/*.5,*,-
`i).,*,,,*,,-*54-*/2-1*4/-,*44±
4*,,,*,-.*,0,*3/,*.0
`i)/,*,,,*,,,*,3,*,.,*1/±
,*-/3*11,*,,4*,2-*1.,*,-
`i)0,*,,,*,,332*54,*,.2.-1*--,*-/±
4*,,.*.,.*4/,*,.-*/4
When you use the )t option, ekop]p gives you the following information:
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
71
 s  nnmi+o: Reads per second merged before issued to disk. Compare this to the infor-
mation in the n+o column to find out how much you gain in efficiency because of 
read ahead. 
 s  snmi+o: Writes per second merged before issued to disk. Compare this to the s+o 
parameter to see how much performance gain you have because of write ahead.
 s  n+o: The number of real reads per second.
 s  s+o: The number of real writes per second.
 s  noa_+o: The number of  512- byte sectors read per second.
 s  soa_: The number of  512- byte sectors written per second.
 s  ]rcnm)ov: The average size of files requested from disk. This is an important 
parameter because, based on the information that you get, you can optimize your 
file system accordingly (see Chapter 4 for more information on that). 
 s  ]rcmq)ov: The average size of the disk request queue. This should be low at all 
times, because it gives the number of pending disk requests. If there is a high 
number here, that means that the performance of your storage channel cannot 
cope with the performance of your network. 
 s  ]s]ep: The average waiting time, in milliseconds. This is the time the request has 
been waiting in the I/O queue plus the time that it actually took to service this 
request. This parameter should also be low in all cases. 
 s  or_pi: The average service time, in milliseconds. This is the time it took before 
a request could be submitted to disk. If this parameter is below a few milliseconds 
(never more than 10 ms), nothing is wrong on your server. However, if this param-
eter is higher than that, something is wrong and you should consider doing some 
storage optimization. 
 s  !qpeh: The percentage of CPU utilization that was related to I/O. 
As you can see, ekop]p)t is an important command to find out what’s happening on 
your storage channel. The only thing it doesn’t give is information about what processes 
are responsible for the I/O on your server. The Linux kernel does not provide a direct way 
of finding that information, but by using the hokb (list open files) command, you can at 
least find the names of files that are open on a device. And with the names of the files, 
you’ll find the names of related processes as well. In  Listing 3-18 you can see how hokb 
nicely puts all this information in its output. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
72
 Listing 3-18. lsof Is Useful for Finding the Processes Working on a Given Device
nkkp<iah6zhokb+r]n
?KII=J@LE@QOANB@PULA@ARE?AOEVAJK@AJ=IA
nl_*op]p`0320op]p`_s`@EN.10(..12/211+r]n+he^+jbo
ouohkc`1,10ouohkc-sNAC.10(./5.0/4/2.0+r]n+hkc+]qpd*hkc
oi^`1050nkkp2qNAC.10(.4-5.-0,,±
+r]n+he^+o]i^]+oa_napo*p`^
oi^`1050nkkp-0qNAC.10(.0,52-00,±
+r]n+he^+o]i^]+jp`nerano*p`^
oi^`1050nkkp-1qNAC.10(.0,52-0,/±
+r]n+he^+o]i^]+cnkql[i]llejc*p`^
oi^`1050nkkp-2qNAC.10(.0,52-0,3±
+r]n+he^+o]i^]+]__kqjp[lkhe_u*p`^
oi^`1050nkkp-3qNAC.10(.0,52-00-±
+r]n+he^+o]i^]+jplnejpano*p`^
oi^`1050nkkp-4qNAC.10(.252-001±
+r]n+he^+o]i^]+jpbknio*p`^
`d_l`/11.4`d_l`2sNAC.10(.00.0/13-±
+r]n+he^+`d_l/+`d_l`*ha]oao
]p`1105`]aikj_s`@EN.10(.3.-.-2±
+r]n+olkkh+_nkj+]pfk^o
_nkj112,nkkp_s`@EN.10(.-.,-.-0+r]n+olkkh+_nkj
]l]_da.114.nkkp.sNAC.10(../3,/022±
+r]n+hkc+]l]_da.+annkn*hkc
]l]_da.114.nkkp3sNAC.10(.,.3.,±
+r]n+hkc+]l]_da.+]__aoo*hkc
]l]_da.114/sss)`]p].sNAC.10(../3,/022+r]n+hkc+]l]_da.+annkn*hkc
]l]_da.114/sss)`]p]3sNAC.10(.,.3.,±
+r]n+hkc+]l]_da.+]__aoo*hkc
]l]_da.1145sss)`]p].sNAC.10(../3,/022+r]n+hkc+]l]_da.+annkn*hkc
]l]_da.1145sss)`]p]3sNAC.10(.,.3.,±
+r]n+hkc+]l]_da.+]__aoo*hkc
]l]_da.115/sss)`]p].sNAC.10(../3,/022+r]n+hkc+]l]_da.+annkn*hkc
]l]_da.115/sss)`]p]3sNAC.10(.,.3.,±
+r]n+hkc+]l]_da.+]__aoo*hkc
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
73
Monitoring Network Performance
On a typical server, network performance is as important as disk, memory, and CPU  
performance. After all, the data has to be delivered over the network to the end user. 
The problem, however, is that things aren’t always as they seem. In some cases a net-
work problem can be caused by misconfiguration in server RAM. If, for example, packets 
get dropped on the network, the reason may very well be that your server doesn’t have 
enough buffers reserved for receiving packets, which may be because your server is low 
on memory. Again, everything is related, and your task is to find the real cause of the 
troubles. 
When considering network performance, there are different kinds of information 
to be analyzed. As you know, several layers of communication are used on the network. 
If you want to analyze a problem with your Samba server, that requires a completely 
different approach from analyzing a problem with dropped packets. A good network 
performance analysis always goes from the bottom up. That means that you first need to 
check what is happening at the physical layer, and then go up through the Ethernet, IP, 
TCP/UDP, and protocol layers. 
When analyzing network performance, always start by checking the network inter-
face itself. Good old eb_kjbec offers excellent statistics to do just that. For instance, 
consider  Listing 3-19, which gives the result of eb_kjbec on the apd- network interface.
 Listing 3-19. Use ifconfig to See What Is Happening on Your Network Board
nkkp<iah6zeb_kjbecapd-
apd-Hejgaj_]l6ApdanjapDS]``n,,6,_6b26/b61`6^^
ejap]``n6-,*,*,*-,>_]op6-,*,*,*.11I]og6.11*.11*.11*,
ejap2]``n6ba4,66.,_6b2bb6ba/b61`^^+20O_kla6Hejg
QL>NK=@?=OPNQJJEJCIQHPE?=OPIPQ6-1,,Iapne_6-
NTl]_gapo634-1/5,annkno6,`nklla`6,krannqjo6,bn]ia6,
PTl]_gapo6-.0.34.2annkno6,`nklla`6,krannqjo6,_]nnean6,
_khheoekjo6,ptmqaqahaj6-,,,
NT^upao6144,14540$12,*4I>%PT^upao6-1.2503-3-$-*0C>%
Ejpannqlp6-4>]oa]``naoo6,ta4,,
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
74
As you can see from  Listing 3-19, the apd- network board has been quite busy, with 
560 MB of received data and 1.4 GB of transmitted data. This is the total overview of what 
your server has been doing since it started up, so you will see that these statistics can be 
much higher for a server that has been up and running for a long time. You can also see 
that IPv6 (ejap2) has been enabled for this network card. There’s nothing wrong with that, 
but if you don’t use IPv6, there’s no reason why it should be enabled. 
Next, in the lines NTl]_gapo and PTl]_gapo, you can see send (transmit, TX) and 
receive (RX) statistics. It’s not especially the number of packets that is of interest here, but 
mainly the number of erroneous packets. In fact, all of these parameters should be 0 at 
all times. If you see anything else, you should check what is going on. The following error 
indicators are displayed using eb_kjbec:
 s  annkno: Represents the number of packets that had an error. Typically, this is due 
to bad cabling or a duplex mismatch. In modern networks, duplex settings are 
detected automatically, and most of the time that goes quite well, so if you see an 
increasing number here, it might be a good idea to replace the patch cable to your 
server.
 s  `nklla`: A packet gets dropped if the server has no memory available to receive it. 
Dropped packets will also occur on a server that runs out of memory, so make sure 
that you have enough physical memory installed in your server.
 s  krannqjo: An overrun will occur if your NIC gets overwhelmed with packets. If 
you are using  up-to- date hardware, overruns may indicate that someone is doing 
a denial-of-service attack on your server.
 s  bn]ia: A frame error is an error caused by a physical problem in the packet, such as 
a CRC error. You may see this error on a server with a bad connection link.
 s  _]nnean: The carrier is the electrical wave that is used for modulation of the signal. 
It really is the component that carries the data over your network. The error coun-
ter should be 0 at all times, and if it isn’t, you probably have a physical problem 
with the network board, so it’s time to replace the network board itself. 
 s  _khheoekjo: You might see this error in an Ethernet network in which a hub is used 
instead of a switch. Modern switches make packet collisions impossible, so you 
will probably never see this error anymore. 
If you see a problem when using eb_kjbec, the next step should be to check your 
network board settings. You can use apdpkkh to do this. The problem with apdpkkh is that 
it’s not supported for each network board. So, in some situations, apdpkkh will show you 
next to nothing. In other cases, it will give you detailed information, as you can see in 
 Listing 3-20.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
75
 Listing 3-20. Use ethtool to Check Settings of Your Network Board
nkkp<iah6zapdpkkhapd-
Oappejcobknapd-6
Oqllknpa`lknpo6WPLY
Oqllknpa`hejgik`ao6-,^]oaP+D]hb-,^]oaP+Bqhh
-,,^]oaP+D]hb-,,^]oaP+Bqhh
-,,,^]oaP+Bqhh
Oqllknpo]qpk)jackpe]pekj6Uao
=`ranpeoa`hejgik`ao6-,^]oaP+D]hb-,^]oaP+Bqhh
-,,^]oaP+D]hb-,,^]oaP+Bqhh
-,,,^]oaP+Bqhh
=`ranpeoa`]qpk)jackpe]pekj6Uao
Olaa`6-,,,I^+o
@qlhat6Bqhh
Lknp6Pseopa`L]en
LDU=@6,
Pn]jo_aeran6ejpanj]h
=qpk)jackpe]pekj6kj
OqllknpoS]ga)kj6lqi^c
S]ga)kj6c
?qnnajpiaoo]caharah6,t,,,,,,//$1-%
Hejg`apa_pa`6uao
Typically, just a few parameters from the apdpkkh output are of interest, the Olaa` and 
@qlhat settings. They show you how your network board is talking to other nodes. If you 
see, for example, that your server is set to full duplex, whereas all other nodes in your net-
work use half duplex, you’ve found your problem and know what you need to fix. 
Another nice tool to monitor what is happening on the network is IPTraf (start it by 
entering elpn]b). This is a  real- time monitoring tool that shows what is happening on the 
network from a graphical interface. When you start it, it shows you a license agreement 
window. From that window, press a key to continue to the IPTraf main menu, which you 
can see in  Figure 3-1.
Before you launch IPTraf from this menu, choose the Configure option. From there, 
you can specify what exactly you want to see and how you want it to be displayed. For 
instance, a useful setting to change is the additional port range. By default, IPTraf shows 
activity on privileged TCP/UDP ports only. If you have a specific application that you 
want to monitor and it doesn’t use one of these privileged ports, select Additional Ports 
from the configuration interface (see  Figure 3-2) and specify additional ports that you 
want to monitor.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
76
 Figure 3-1. IPTraf works from a menu to show you  real- time network usage statistics.
 Figure 3-2. Use the Additional Ports option from the configuration interface to monitor 
nonprivileged ports as well.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
77
After telling elpn]b how to do its work, from the main menu use the IP Traffic Moni-
tor option to start the tool. You can next select on which interface you want to listen, or 
just press Enter to listen on all interfaces. Next, IPTraf asks you in which file you want to 
write log information. You should be aware that it isn’t always a good choice to configure 
logging, because logging may fill up your file systems quite fast. In case you don’t want to 
log, press Ctrl+X now. This will start the IPTraf interface, which displays everything that is 
happening on your server and on what port exactly it is happening (see  Figure 3-3). 
 Figure 3-3. IPTraf gives a  real- time overview of what is happening on your server’s network 
boards.
Apart from the  real- time overview of what is happening on the network, IPTraf also 
offers the LAN station monitor, shown in  Figure 3-4. This interface is a great help in find-
ing workstations that cause a lot of network load. For instance, you can use this to find 
the workstation that is doing video streaming or online gaming. 
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
78
 Figure 3-4. The LAN station monitor shows the most active LAN station at the top of the list.
If it’s not so much the performance on the network card that you are interested in, 
but more what is happening at the service level, japop]p is a good basic network perfor-
mance tool. It uses different parameters to show you what ports are open and on what 
ports your server sees activity. My personal favorite way of using japop]p is by issuing the 
japop]p)pqhlj command. This gives an overview of all listening ports on the server and 
even tells you what other node is connected to a particular port. See  Listing 3-21 for an 
overview. 
 Listing 3-21. netstat Enables You to See Which Ports Are Listening on Your Server and Who Is 
Connected
nkkp<iah6zjapop]p)pqhlj
=_peraEjpanjap_kjja_pekjo$kjhuoanrano%
LnkpkNa_r)MOaj`)MHk_]h=``naooBknaecj=``naooOp]paLE@+Lnkcn]ij]ia
p_l,,,*,*,*,6.,05,*,*,*,6&HEOPAJ)
p_l,,,*,*,*,6231,*,*,*,6&HEOPAJ1-2.+nl_*ultbn`
p_l,,,*,*,*,6-/5,*,*,*,6&HEOPAJ10-5+oi^`
p_l,,,*,*,*,624/,*,*,*,6&HEOPAJ1-3,+ul^ej`
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
79
p_l,,,*,*,*,6---,*,*,*,6&HEOPAJ0304+lknpi]l
p_l,,,*,*,*,64,,*,*,*,6&HEOPAJ114.+]l]_da.
p_l,,,*,*,*,60.4/1,*,*,*,6&HEOPAJ1/54+nl_*ikqjp`
p_l,,-.3*,*,*-610/.,*,*,*,6&HEOPAJ1-53+lkopcnao
p_l,,-.3*,*,*-62,-,,*,*,*,6&HEOPAJ15/4+-
p_l,,,*,*,*,6//.0.,*,*,*,6&HEOPAJ)
p_l,,,*,*,*,62,,.2,*,*,*,6&HEOPAJ0320+nl_*op]p`
p_l,,,*,*,*,600/,*,*,*,6&HEOPAJ1.5,+]l]_da.
p_l,,,*,*,*,6001,*,*,*,6&HEOPAJ10-5+oi^`
p_l,,,*,*,*,6225,*,*,*,6&HEOPAJ1-12+uloanr
p_l2,,666..666&HEOPAJ1--3+ood`
p_l2,,66-62,-,666&HEOPAJ15/4+-
q`l,,,*,*,*,6.,05,*,*,*,6&)
q`l,,-5.*-24*-*556-/3,*,*,*,6&10-3+ji^`
q`l,,-,*,*,*-,6-/3,*,*,*,6&10-3+ji^`
q`l,,,*,*,*,6-/3,*,*,*,6&10-3+ji^`
q`l,,-5.*-24*-*556-/4,*,*,*,6&10-3+ji^`
q`l,,-,*,*,*-,6-/4,*,*,*,6&10-3+ji^`
q`l,,,*,*,*,6-/4,*,*,*,6&10-3+ji^`
q`l,,,*,*,*,6224,*,*,*,6&1-12+uloanr
q`l,,,*,*,*,623-,*,*,*,6&1-15+nl_*ull]oos``
q`l,,,*,*,*,6230,*,*,*,6&1-2.+nl_*ultbn`
q`l,,,*,*,*,624.,*,*,*,6&1-3,+ul^ej`
q`l,,,*,*,*,624/,*,*,*,6&1-3,+ul^ej`
q`l,,,*,*,*,60131,,*,*,*,6&)
q`l,,,*,*,*,63,,,*,*,*,6&0320+nl_*op]p`
q`l,,,*,*,*,623,*,*,*,6&11.4+`d_l`/
q`l,,,*,*,*,625,*,*,*,6&10.4+ej*pbpl`
q`l,,,*,*,*,6/1,-2,*,*,*,6&0320+nl_*op]p`
q`l,,,*,*,*,601,-,,*,*,*,6&1/54+nl_*ikqjp`
q`l,,,*,*,*,6---,*,*,*,6&0304+lknpi]l
q`l,,-,*,*,*-,6-./,*,*,*,6&012/+jpl`
q`l,,-5.*-24*-*556-./,*,*,*,6&012/+jpl`
q`l,,-.3*,*,*-6-./,*,*,*,6&012/+jpl`
q`l,,,*,*,*,6-./,*,*,*,6&012/+jpl`
q`l2,,ba4,66.-56`-bb6baa`6-./666&012/+jpl`
q`l2,,ba4,66.,_6b2bb6ba/b6-./666&012/+jpl`
q`l2,,66-6-./666&012/+jpl`
q`l2,,666-./666&012/+jpl`
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
80
When using japop]p, quite a few options are available. The following is an overview of 
the most interesting ones:
 s  )l: Shows the PID of the program that has opened a port
 s  )_: Updates the display every second
 s  )o: Shows statistics for IP, UDP, TCP, and ICMP
 s  )p: Shows TCP sockets
 s  )q: Shows UDP sockets
 s  )s: Shows RAW sockets
 s  )h: Shows listening ports
 s  )j: Resolves addresses to names
Many other tools are available to monitor the network as well, but most of them are 
beyond the scope of this chapter because they are protocol or service specific; thus, they 
won’t help you as much in finding performance problems on the network. However, 
I want to mention one very simple performance testing method that I personally use at 
all times when analyzing a performance problem. Because all that counts when analyz-
ing network performance is how fast your network can copy data from and to your server, 
I like to measure that by creating a big file (1 GB, for example) and copying it over the 
network. To measure time, I use a peia command that gives a clear impression of how 
long it really took to copy the file. For instance, peiao_loanran6+^ecbeha+hk_]h`en will 
end with a summary of the total time it took to copy the file over. This is an excellent test, 
especially when you start optimizing performance, because it will show you immediately 
whether you reached your goals or not. 
Performance Baselining
The purpose of a performance baseline is to establish what exactly is happening on your 
server and what level of performance is normal at any given moment in time. By estab-
lishing a performance baseline that is based on the  long- term statistics for your server, it 
is easier to interpret the performance data that you’ll find at any given moment in time. 
To do performance baselining, you can use tools like Nagios, which also includes an alert-
ing function that will send you a message when a threshold is passed. To give you the 
perfect impression of what your server is doing, it’s a good idea to implement a baselin-
ing tool as well. In Chapter 6, you’ll read more about utilities that you can use for this 
purpose.
www.it-ebooks.info

CHAPTER 3 N   PERFORMANCE MONITORING
81
Summary
In this chapter you have learned how to monitor performance on your server. Now you 
can understand what really is happening on a server that isn’t performing well. Next, you 
need to do something with that information. In Chapter 4 you will learn how to tune per-
formance parameters to get the best out of your server. 
www.it-ebooks.info

83
C H A P T E R  4
Performance Optimization
Tuning Ubuntu Server  
Like a Racing Car
No matter on which kind of server you install it, Ubuntu Server will always be installed 
with the same settings. To give an example, the area of reserved memory in RAM for 
packets coming in to the network board will always be the same, no matter if your server 
has 128 MB or 128 GB of RAM. As you can guess, there’s something to gain here! In this 
chapter you’ll read about performance optimization. We’ll explore what possibilities 
there are to optimize performance of the CPU, RAM, storage, and network. I’ll also give 
a few hints on optimizing performance for network services like Samba and NFS. If every-
thing goes well, at the end of this chapter, your server will be performing a lot better. 
Strategies for Optimizing Performance
You can look at performance optimization in two different ways. For some people, it 
just means changing some parameters and seeing what happens. That is not the best 
approach. A much better approach is to start with performance monitoring first. This 
will give you some  crystal- clear ideas about what exactly is happening with performance 
on your server. Before optimizing anything, you should know what exactly to optimize. 
For example, if the network performs badly, you should know whether the problems are 
caused by the network or caused by an insufficient amount of memory allocated for the 
network packets coming in and going out. So make sure you know what to optimize. 
About /proc and sysctl
Once you know what to optimize, it comes down to actually doing it. In many situa-
tions, optimizing performance means writing a parameter to the +lnk_ file system. This 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
84
file system is created by the kernel when your server boots up, and normally contains 
the settings that your kernel is working with. Under +lnk_+ouo, you’ll find many system 
parameters that can be changed. The easy way to change system parameters is to a_dk the 
new value to the configuration file. For example, the +lnk_+ouo+ri+os]llejaoo file contains 
a value that indicates how willing your server is to swap. The range of this value is 0 to 
100; a low value means that your server will avoid swapping as long as possible, whereas 
a high value means that your server is more willing to swap. The default value in this file 
is 60. If you think your server is too eager to swap, you could change this value, using
a_dk/,:+lnk_+ouo+ri+os]llejaoo
This method works well, but there is a problem. As soon as your server restarts, you 
will lose this value. So, the better solution is to store it in a configuration file and make 
sure that configuration file is read when your server boots up again. A configuration file 
exists for this purpose, named +ap_+ouo_ph*_kjb. When booting, your server starts the 
lnk_lo service that reads this configuration file and applies all settings in it. So, to make it 
easier for you to apply the same settings again and again, put them in this configuration 
file. There is a small syntax difference, though. 
In +ap_+ouo_ph*_kjb, you refer to files that exist in the +lnk_+ouo hierarchy. So the 
name of the file you are referring to is relative to this directory. Also, instead of using 
a slash as the separator between directory, subdirectories, and files, it is common to use 
a dot (even if the slash is accepted as well). That means that to apply the change to the 
os]llejaoo parameter previously introduced, you would include the following line in 
+ap_+ouo_ph*_kjb:
ri*os]llejaoo9/,
This setting would be applied only the next time that your server reboots. Instead of 
just writing it to the configuration file, you can apply it to the current ouo_ph settings as 
well. To do that, use the ouo_ph command; the following command can be used to apply 
this setting immediately:
ouo_phri*os]llejaoo9/,
In fact, using this solution does exactly the same thing as using the a_dk/,:
+lnk_+ouo+ri+os]llejaoo command. The most practical way of applying these settings 
is to write them to +ap_+ouo_ph*_kjb first, and then activate them using ouo_ph)l+ap_+
ouo_ph*_kjb. Once the settings are activated in this way, you can also get an overview of all 
current ouo_ph settings, using ouo_ph)].  Listing 4-1 shows a partial example of the output 
of this command. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
85
 Listing 4-1. sysctl -a Shows All Current sysctl Settings
bo*ejk`a)jn9--553/,,
bo*ejk`a)op]pa9--553/,,,,,,,
bo*beha)jn94/.,/21/-/
bo*beha)i]t9/21/-/
bo*`ajpnu)op]pa9-/0,241-501,,,
bo*kranbhksqe`9211/0
bo*kranbhksce`9211/0
bo*ha]oao)aj]^ha9-
bo*`en)jkpebu)aj]^ha9-
bo*ha]oa)^na]g)peia901
bo*]ek)jn9,
bo*]ek)i]t)jn9211/2
bo*ejkpebu*i]t[qoan[ejop]j_ao9-.4
bo*ejkpebu*i]t[qoan[s]p_dao91.0.44
bo*ejkpebu*i]t[mqaqa`[arajpo9-2/40
***
oqjnl_*q`l[ohkp[p]^ha[ajpneao9-2
oqjnl_*p_l[ohkp[p]^ha[ajpneao9-2
oqjnl_*iej[naorlknp9221
oqjnl_*i]t[naorlknp9-,./
The output of ouo_ph)] can be somewhat overwhelming. I recommend using it in 
combination with cnal to find the information you need. For example, ouo_ph)]xcnal
tbo would show you only lines that have the text tbo in their output.
Applying a Simple Test
Although ouo_ph and its configuration file ouo_ph*_kjb are very useful tools to change 
 performance- related settings, you should thoroughly test your changes before applying 
them. Before you write a parameter to the system, make sure that it really is the param-
eter you need. The big question, though, is how to know that for sure. Even if not valid 
in all cases, I like to do a small test with a 1 GB file to find out what exactly the effect of 
a parameter is. First, I create a 1 GB file, using the following:
``eb9+`ar+vankkb9+nkkp+-C>beha^o9-I_kqjp9-,.0
By copying this file around and measuring the time it takes to copy it, you can get 
a pretty good idea of the effect of some of the parameters. Many tasks you perform 
on your Linux server are  I/O- related, so this simple test can give you an impression of 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
86
whether or not there is any improvement after you have tuned performance. To measure 
the time it takes to copy this file, use the peia command, followed by _l, as in peia_l
+nkkp+-C>beha+pil. In  Listing 4-2, you can see an example of what this looks like when 
measuring I/O performance on your server. In this example, I’m using the peia command 
to measure how much time it took to complete a given command. The output of peia 
gives three parameters: 
 s  na]h: The real time, in seconds, it took to complete the command. This includes 
waiting time as well. 
 s  qoan: The time spent in user space that was required to complete the command. 
 s  ouo: The time spent in system space to complete the command. 
 Listing 4-2. Use time to Measure Performance While Copying a File
nkkp<iah6z``eb9+`ar+vankkb9+nkkp+-C>beha^o9-I_kqjp9-,.0
-,.0',na_kn`oej
-,.0',na_kn`okqp
-,3/30-4.0^upao$-*-C>%_klea`(3*31545o(-/4I>+o
nkkp<iah6zpeia_l-C>beha+pil
na]h,i4*200o
qoan,i,*,1,o
ouo,i.*51,o
When doing a test like this, though, it is important to interpret it in the right way. 
Consider for example  Listing 4-3, in which the same command was repeated a few sec-
onds later. 
 Listing 4-3. The Same Test, 10 Seconds Later
nkkp<iah6zpeia_l-C>beha+pil
na]h,i3*554o
qoan,i,*,2,o
ouo,i/*./,o
As you can see, it now performs about  two- thirds of a second faster than the first time 
the command was used. Is this the result of a performance parameter that I’ve changed in 
between? No, but let’s have a look at the result of bnaa)i, as shown in  Listing 4-4.
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
87
 Listing 4-4. Cache Also Plays an Important Role in Performance
nkkp<iah6zbnaa)i
pkp]hqoa`bnaaod]na`^qbbano_]_da`
Iai6/543..02-30-,-3.-,4
)+'^qbbano+_]_da6--5/423
Os]l6.,03,.,03
Any idea what has happened here? The entire 1 GB file was put in cache. As you can 
see, bnaa)i shows almost 2 GB of data in cache that wasn’t there before and that has an 
influence on the time it takes to copy a large file around. 
So what lesson is there to learn? Performance optimization is complex. You have to 
take into account multiple factors that all have their influence on the performance of 
your server. Only when this is done the right way will you truly see how your server per-
forms and whether or not you have succeeded in improving its performance. If you’re not 
looking at the data properly, you may miss things and think that you have improved per-
formance, while in reality you might have made it worse. 
NCaution Performance tuning is complicated. If you miss a piece of information, the performance penalty 
for your server may be severe. Only apply the knowledge from this chapter if you feel confident about your 
assumptions. If you don’t feel confident, don’t change anything, but instead ask an expert for his opinion. 
CPU Tuning
Assuming that you have applied all the lessons from Chapter 3 and have a clear picture 
of what is wrong with the utilization of your server, it is time to start optimizing. In this 
section you’ll learn what you can do to optimize the performance of your server’s CPU. 
First, you’ll learn about aspects of the inner workings of the CPU that are important when 
trying to optimize performance parameters for the CPU. Then, you’ll read about several 
common techniques to optimize CPU utilization.
Understanding CPU Performance
To be able to tune the CPU, you should know what is important with regard to this part of 
your system. To understand CPU performance, you should know about the thread sched-
uler. This part of the kernel makes sure that all process threads get an equal number of 
CPU cycles. Because most processes will do some I/O as well, it’s not a problem that the 
scheduler puts process threads on hold momentarily. While not being served by the CPU, 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
88
the process thread can wait for I/O. The fact that the process is doing that while being put 
on hold by the scheduler increases its efficiency. The scheduler operates by using fair-
ness, meaning that all threads are moving forward using equal time segments. By using 
fairness, the scheduler makes sure there is not too much latency. 
The scheduling process is pretty simple in a  single- CPU core environment. Naturally, 
it is more complicated in a multicore environment. To work in a  multi- CPU or multicore 
environment, your server uses a specialized symmetric multiprocessing (SMP) kernel. 
If needed, this kernel is installed automatically. In an SMP environment, the scheduler 
should make sure that some kind of load balancing is used. This means that process 
threads are spread over all available CPU cores. In fact, if a program is not written using 
a multithreaded or multiprocessor architecture, the kernel could only run this mono-
lithic program on a dedicated CPU core. The kernel is only able to dispatch threads or 
processes on CPU cores, so only multithreaded processes could have their execution flow 
dispatched on distinct CPU cores. For example, if the Apache Web Server is compiled 
using the legacy  mono- process architecture, it will take one CPU core. If it is compiled 
with the multiprocessor or multithreaded model, all processes and threads will run at the 
same time on the different CPU threads.
A specific concern in a  multi- CPU environment is to ensure that the scheduler pre-
vents processes and threads from being moved to other CPU cores. Moving a process 
means that the information the process has written in the CPU cache has to be moved as 
well, and that is a relatively expensive procedure. 
You may think that a server will benefit if you install multiple CPU cores, but this is 
not true. When working on multiple cores, chances increase that processes swap around 
between cores, taking their cached information with them, which slows down perfor-
mance in a multiprocessing environment. In two specific situations, you can benefit from 
a multiprocessing environment:
 s  7HEN USING VIRTUALIZATION YOU CAN PIN VIRTUAL MACHINES TO A PARTICULAR #05 CORE
 s  7HEN USING AN APPLICATION THAT IS WRITTEN FOR AN 3-0 ENVIRONMENT FOR EXAMPLE Oracle), the kernel will be able to dispatch all the threads and processes on the dif-
ferent cores efficiently.
Optimizing CPU Performance
CPU performance optimization is really just about doing two things: prioritizing pro-
cesses and optimizing the SMP environment. Every process gets a static priority from the 
scheduler. The scheduler can differentiate between  real- time (RT) processes and normal 
processes, but if a process falls into one of these categories, it will be equal to all other 
processes in the same category. That means the priority of RT processes is higher than the 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
89
priority of normal processes, but also that it is not possible to differentiate between differ-
ent RT processes. Be aware, though, that some RT processes (most of them are part of the 
Linux kernel) will run with highest priority, whereas the rest of the available CPU cycles 
have to be divided between the other processes. In that procedure, it’s all about fairness: 
the longer a process is waiting, the higher its priority will be. 
The way that the scheduler does its work is not tunable by any parameter in the +lnk_ 
file system. The only way to tune it is by changing the values for some parameters that are 
defined in the kernel source file ganjah+o_da`*_. Because this is a difficult procedure that 
in most situations doesn’t give any benefits, I strongly advise against it. Another reason 
why you shouldn’t do it is that, in modern Linux systems, there is another, much more 
efficient method to do this: use the je_a command. 
Adjusting Process Priority Using nice
You probably already know how the je_a command works. It has a range that goes from 
-20 to 19. The lower the je_a value of a process, the higher its priority. So a process that 
has a je_a value of -20 will always get the highest possible priority. I strongly advice 
against using -20, because if the process that runs with this je_a value is a very busy pro-
cess, you risk other processes not being served at all anymore. This could even result in 
a crash of your server, so be careful with -20. If ever you want to adjust the je_a value of 
a process, do it by using increments of 5. So if you want to increase the priority of the pro-
cess using PID 1234, try using naje_a, as follows:
naje_a)1-./0
See if the process performs better now, and if it doesn’t, naje_a it to -10, but never go 
beyond the value of -15, because you risk making your server completely dysfunctional. 
If ever you feel the need to increase process priority of a process beyond -15, your server 
probably just is overloaded and there are other measures to take. In that case, you may 
benefit from one of the following options:
 s  #HECK WHICH PROCESSES ARE STARTED WHEN YOU BOOT YOUR SERVER 9OU CAN USE THE ouor_kjbec utility to display a list of all services and their current startup status. 
You may have some processes that you don’t really need. Remove them from your 
runlevels.
 s  3EE IF PROCESSES ARE COMPETING FOR #05 CYCLES 9OU CAN DO THIS BY LOOKING AT THE output of pkl. If you see several processes that are very busy, they definitely are 
competing for CPU cycles. If this is the case, try offloading one or more processes 
to another server. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
90
 s  ,OOK AT THE WAIT TIME FOR YOUR #05 )F THE WAIT TIME AS SHOWN BY THE s] param-
eter in pkl, is high, the problem might not be process related, but rather storage 
related. 
 s  )F IT IS MAINLY ONE PROCESS THAT IS VERY BUSY THUS PREVENTING OTHER PROCESSES FROM doing their work, see if you can run it on a multicore server. In that scenario, the 
busy process can just claim one of the cores completely (given that it is developed 
using the multiprocessing model), while all vital system processes are served by 
the other core. 
Optimizing SMP Environments
If you are working in an SMP environment, one important utility to use to improve per-
formance is the p]ogoap command. You can use p]ogoap to set CPU affinity for a process 
to one or more CPUs. The result is that your process is less likely to be moved to another 
CPU. The p]ogoap command uses a hexadecimal bitmask to specify which CPU to use. In 
this bitmap, the value ,t- refers to CPU0, ,t. refers to CPU1, ,t0 refers to CPU2, ,t4 refers 
to CPU3, and so on. 
NNote I follow the default Linux way of referring to CPU numbers, in which CPU0 is the first CPU, CPU1 the 
second, and so on. 
So if you have a command that you would like to bind to CPUs 2 and 3, you would 
use the following command:
p]ogoap,t?okia_kii]j`
NNote If you are surprised about the ,t? in the preceding command, the number used by p]ogoap is 
a hexadecimal number. CPUs 2 (hexadecimal value 4) and 3 (hexadecimal value 8) make up the value of 12, 
which, when written in a hexadecimal way, equals C. 
You can also use p]ogoap on running processes, by using the )l option. With this 
option, you can refer to the PID of a process; for instance,
p]ogoap,t/3,/0
would set the affinity of the process using PID 7034 to CPUs 0 and 1. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
91
You can specify CPU affinity for IRQs as well. To do this, you can use the same bit-
mask that you use with p]ogoap. Every interrupt has a subdirectory in +lnk_+enm+, and in 
that subdirectory there is a file with the name oil[]bbejepu. So, for example, if your IRQ 
5 is producing a very high workload (check +lnk_+ejpannqlpo to see if this is the case) and 
you therefore want that IRQ to work on CPU1, use the following command:
a_dk,t.:+lnk_+enm+/+oil[]bbejepu
Tuning Memory
System memory is a very important part of a computer. It functions as a buffer between 
CPU and I/O. By tuning memory, you can really get the best out of it. Linux works with 
the concept of virtual memory, which is the total of all usable memory available on 
a server. You can tune the working of virtual memory by writing to the +lnk_+ouo+ri 
directory. This directory contains lots of parameters that help you to tune the way your 
server’s memory is used. As always when tuning the performance of a server, there are no 
solutions that work in all cases. Use the parameters in +lnk_+ouo+ri with caution and use 
them one by one. Only by tuning each parameter individually will you be able to deter-
mine whether you really got better memory performance.
Understanding Memory Performance
In a Linux system, virtual memory is used for many purposes. First, there are processes 
that claim their amount of memory. When tuning memory consumption for processes, 
it helps to know how these processes allocate memory. For instance, a database server 
that allocates large amounts of system memory when starting up has different needs 
from those of a mail server that works with small files only. Also, each process has its own 
memory space, which may not be addressed by other processes. The kernel ensures that 
this never happens. 
When a process is created, using the bkng$% system call (which basically creates 
a child process from the parent), the kernel creates a virtual address space for the process. 
The virtual address space used by a process is made up of pages. These pages have a fixed 
size of 4 KB on a  32- bit system. On a  64- bit server, you can choose between 4, 8, 16, 32, 
and 64 KB pages. 
Another important aspect of memory usage is caching. Your system includes a read 
cache and a write cache, and the way in which you tune a server that handles mostly read 
requests differs from the way in which you tune a server that handles write requests. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
92
Optimizing Memory Usage
Basically, there are two kinds of servers: servers that run a heavy application that allocates 
lots of memory, and servers that offer services and therefore are accessed frequently by 
users. Depending on the kind of server you use, you can follow a different optimization 
approach. Three items are of specific interest with regard to this issue: the configuration 
of huge pages, the optimization of the write cache, and the optimization of  inter- process 
communication.
Configuring Huge Pages
If your server is a heavily used application server, it may benefit from using large 
pages, also referred to as huge pages. A huge page by default is 2 MB. Using huge pages 
may be useful to improve performance in  high- performance computing and with 
 memory- intensive applications. By default, no huge pages are allocated, because they 
would be a waste on a server that doesn’t need them. Typically, you set them from the 
Grub boot loader when you’re starting your server. Later on, you can check the number 
of huge pages in use from the +lnk_+ouo+ri+jn[dqcal]cao parameter. The following proce-
dure summarizes how to set huge pages:
 
1. Using an editor, open the Grub menu configuration file in +^kkp+cnq^+iajq*hop.
 
2. Find the part of the configuration file that defines how your system should boot. 
It looks like the example in  Listing 4-5.
 Listing 4-5. The Boot Section in /boot/grub/menu.lst
pephaQ^qjpq4*,0(ganjah.*2*.0)-2)oanran
nkkp$d`,(,%
ganjah+rihejqv).*2*.0)-2)oanrannkkp9+`ar+i]llan+ouopai)nkkp±
nkmqeapolh]odXdqcal]cao920
ejepn`+ejepn`*eic).*2*.0)-2)oanran
mqeap
 
3. In the ganjah line, make sure that you enable huge pages, by using the parameter 
dqcal]cao9jj. In  Listing 4-5, I have defined the number of huge pages for this 
server to be 64. 
 
4. Save your settings and reboot your server to activate them.
Be careful, though, when allocating huge pages. All memory pages that are allocated 
as huge pages are no longer available for other purposes, and if your server needs a heavy 
read or write cache, you will suffer from allocating too many huge pages immediately. If 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
93
you find out that this is the case, you can change the number of huge pages currently in 
use by writing to the +lnk_+ouo+ri+jn[dqcal]cao parameter. Your server will pick up this 
new number of huge pages immediately. 
Optimizing Write Cache
The parameters described in this section all relate to the buffer cache. As discussed ear-
lier, your server maintains a write cache. By putting data in that write cache, the server 
can delay writing data. This is useful for more than one reason. Imagine that just after 
committing the write request to the server, another write request is made. It will be easier 
for the server to handle that write request if the data is not yet written to disk but is still 
in memory. You may also want to tune the write cache to balance between the amount 
of memory reserved for reading and the amount that is reserved for writing data. 
The first relevant parameter is in +lnk_+ouo+ri+`enpu[n]pek. This parameter is used 
to define the maximum percentage of memory that is used for the write cache. When the 
percentage of buffer cache in use exceeds this parameter, your server will write memory 
from the buffer cache to disk as soon as possible. The default of 10 percent works fine 
for an average server, but in some situations you may want to increase or decrease the 
amount of memory used here.
Related to `enpu[n]pek are the `enpu[atlena[_ajpeoa_o and `enpu[snepa^]_g[
_ajpeoa_o parameters, also in +lnk_+ouo+ri. These parameters determine when data in the 
write cache expires and has to be written to disk, even if the write cache hasn’t reached 
the threshold as defined in `enpu[n]pek yet. By using these parameters, you reduce the 
chances of losing data when a power outage occurs on your server. On the contrary, if you 
want to use power more efficiently, it is useful to give both these parameters the value of 
0, which actually disables them and keeps data as long as possible in the write cache. This 
is useful for laptop computers, because your hard disk needs to spin up in order to write 
this data, and that takes a lot of power; turning off both of these parameters delays writing 
to hard disk as long as possible, which is good if you want to limit power consumption. 
The last parameter that is related to writing data is jn[l`bhqod[pdna]`o. This param-
eter helps in determining the number of threads the kernel launches for writing data from 
the buffer cache. Understanding it is easy: having more of these threads means faster 
write back. So if you have the idea that buffer cache on your server is not cleared fast 
enough, increase the value of l`bhqod[pdna]`o using the following command:
ouo_ph)sri*jn[l`bhqod[pdna]`o90
When using this option, do respect the limitations. By default, the minimal value of 
l`bhqod[pdna]`o is set to 2 and the maximum is 8. 
Next, there is the issue of overcommitting memory. By default, every process tends to 
claim more memory than it really needs. This is good, because it makes the process faster. 
If the process already has some spare memory available, it can access it much faster when 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
94
it needs it, because it doesn’t have to ask the kernel if it has some more memory avail-
able. To tune the behavior of overcommitting memory, you can write to the +lnk_+ouo+ri+
kran_kiiep[iaiknu parameter. Its default value is 0, which means that the kernel checks if 
it still has memory available before granting it. If that doesn’t give you the performance 
you need, you can consider changing the value to 1, which forces the system to think 
there is enough memory in all cases. This is good for performance of  memory- intensive 
tasks, but may result in processes getting killed automatically. You can also use the value 
of 2, which means that the kernel fails the memory request if there is not enough memory 
available. The minimal amount of memory that is available is specified in the +lnk_+ouo+
ri+kran_kiiep[n]pek parameter, which by default is set to 50 percent of available RAM. 
Using the value of 2 makes sure that your server will never run out of available memory 
by granting memory that is demanded by a process that needs huge amounts of memory 
(on a server with 16 GB of RAM, the memory allocation request would be denied only if 
more than 8 GB was requested by one single process).
Another je_a parameter is +lnk_+ouo+ri+os]llejaoo. This indicates how eager the 
process is to start swapping out memory pages. A high value means that your server will 
swap very fast, and a low value means that the server will wait some more before starting 
to swap. The default value of 60 does well in most situations. If you still think your server 
starts swapping too fast, set it to a somewhat lower value, like 30. 
Optimizing  Inter- Process Communication
The last relevant parameters are those related to shared memory. Shared memory is 
a memory area that the Linux kernel or Linux applications can use to make communica-
tion between processes (also known as  Inter- Process Communication, or IPC) as fast as 
possible. The cool thing about shared memory is that the kernel is not involved in the 
communication between the processes using it, and data doesn’t even have to be copied 
because the memory areas can be addressed directly. To get an idea of shared memory–
related settings your server is currently using, use the el_o)hi command, as shown in 
 Listing 4-6.
 Listing 4-6. Use ipcs -lm to View Shared Memory Settings
nkkp<iah6zel_o)hi
))))))Od]na`IaiknuHeiepo))))))))
i]tjqi^ankboaciajpo90,52
i]toacoeva$g^upao%9/.324
i]tpkp]hod]na`iaiknu$g^upao%94/442,4
iejoacoeva$^upao%9-
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
95
If your applications are written to use shared memory, you can benefit from tuning 
some of its parameters. If, on the contrary, your applications don’t use share memory, it 
doesn’t make a difference if you change the shared memory–related parameters. One of 
the  best- known examples of an application that uses shared memory is Oracle. To find 
out whether shared memory is used on your server and, if so, in what amount it is used, 
use the el_o)i command.  Listing 4-7 shows an example of its output on a server where 
just one shared memory segment is used.
 Listing 4-7. Use ipcs -m to Find Out if Your Server Is Using Shared Memory Segments
nkkp<iah6zel_o)i
))))))Od]na`IaiknuOaciajpo))))))))
gauodie`ksjanlanio^upaoj]pp_dop]pqo
,t,,1.a._-,lkopcnao2,,.5/24/.,0
The first parameter that is related to shared memory is odii]t. This defines the maxi-
mum size, in bytes, of a single shared memory segment that a Linux process can allocate. 
You can see the current setting in the configuration file +lnk_+ouo+ganjah+odii]t:
nkkp<iah6z_]p+lnk_+ouo+ganjah+odii]t
//1100/.
This sample was taken from a system that has 4 GB of RAM. The odii]t setting was 
automatically created to allow processes to allocate up to about 3.3 GB of RAM. It doesn’t 
make sense to tune the parameter to use all available RAM, because RAM has to be used 
for other purposes as well. 
The second parameter that is related to shared memory is odiije, which is not, as 
you might think, the minimal size of shared memory segments, but rather the maxi-
mum number of shared memory segments that your kernel can allocate. You can get the 
default value from +lnk_+ouo+ganjah+odiije; it should be set to 4096. If you run an applica-
tion that relies heavily on the use of shared memory, you may benefit from increasing this 
parameter; for instance:
ouo_ph)sganjah*odiije94-5.
The last parameter related to shared memory is odi]hh. It is set in +lnk_+ouo+ganjah+
odi]hh and defines the total number of shared memory pages that can be used system 
wide. Normally, the value should be set to the value of odii]t, divided by the current page 
size your server is using. On a  32- bit processor, finding the page size is easy—it is always 
set to 4096. On a  64- bit computer, you can use the cap_kjb command to determine the 
current page size:
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
96
cap_kjbL=CA[OEVA
0,52
If the odi]hh parameter doesn’t contain a value that is big enough for your applica-
tion, change it as needed. For instance, use the following command:
ouo_ph)sganjah*odi]hh9.,53-1.
Tuning Storage Performance
The third element in the chain of Linux performance is the storage channel. Performance 
optimization on this channel can be divided in two categories: file system performance 
and I/O buffer performance. File system optimization is dealt with in Chapter 5, so this 
section focuses on I/O optimization that is not directly related to the file system.
Understanding Storage Performance
To determine what happens with I/O on your server, Linux uses the I/O scheduler. This 
kernel component sits between the block layer that communicates directly with the file 
systems and the device drivers, as depicted in  Figure 4-1. The block layer generates I/O 
requests for the file systems and passes those requests to the I/O scheduler. This sched-
uler in turn transforms the request and passes it to the  low- level drivers. The drivers 
forward the request to the actual storage devices. If you want to optimize storage perfor-
mance, optimizing the I/O scheduler is an important part of that.
 Figure 4-1. The I/O scheduler sits between the file systems and the actual devices.
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
97
Optimizing the I/O Scheduler
Working with an I/O scheduler makes your computer more flexible. The I/O scheduler 
can prioritize I/O requests and reduce the amount of time needed to search for data 
on the hard disk. Also, the I/O scheduler makes sure that a request is handled before it 
times out. An important goal of the I/O scheduler is to make hard disk seek times more 
efficient. The scheduler does this by collecting requests before really committing them 
to disk. Because of this approach, the scheduler can do its work more efficiently. For 
instance, it may choose to order requests before committing them to disk, which makes 
hard disk seeks more efficient. 
When optimizing the performance of the I/O scheduler, there is a dilemma: you can 
optimize read performance or write performance, but not both at the same time. Opti-
mizing read performance means that write performance will be not as good, whereas 
optimizing write performance means you have to pay a price in read performance. So 
before you start to optimize the I/O scheduler, you should really analyze what type of 
workload is generated by your server. 
There are four different ways for the I/O scheduler to do its work:
 s  7HEN YOU CHOOSE #OMPLETE &AIR 1UEUEING _bm), the I/O scheduler tries to allo-
cate I/O bandwidth fairly. This approach offers a good solution for machines with 
mixed workloads and offers the best compromise between latency and through-
put. Latency is relevant in an environment in which a lot of data is read, and 
throughput is relevant in an environment in which there are a lot of file writes.
 s  4HE $EADLINE SCHEDULER `a]`heja) works with five different I/O queues and there-
fore is very capable of differentiating between read requests and write requests. 
It does this by merging write actions and sorting them, which allows them to get 
written to disk faster. When using this scheduler, read requests will get a higher 
priority. Write requests do not have a deadline and, therefore, data to be written 
can remain in cache for a longer period. This scheduler does well in environ-
ments in which both good read and good write performance is required but 
reads have a bit higher priority. This scheduler does particularly well in database 
environments. 
 s  4HE .OOP SCHEDULER jkkl) performs only minimal merging functions on your 
data. Because there is no sorting, this scheduler has minimal overhead. This 
scheduler was developed for  non-disk- based block devices, such as memory 
devices. It also does well on storage media that have extensive caching. 
 s  4HE !NTICIPATORY SCHEDULER ]jpe_el]pknu) tries to reduce read response times. It 
does so by introducing a controlled delay in all read requests. This increases the 
possibility that another read request can be handled in the same I/O request and 
therefore makes reads more efficient. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
98
There are two ways to change the current I/O scheduler. You can a_dk a new value 
to the +ouo+^hk_g+8UKQN@ARE?A:+mqaqa+o_da`qhan file. Alternatively, you can set it as a boot 
parameter, using ahar]pkn9ukqno_da`qhan at the Grub prompt or in the Grub menu. The 
choices are jkkl, ]jpe_el]pknu, `a]`heja, and _bm.
Optimizing Reads
Another way to optimize how your server works is by tuning read requests. This is some-
thing that you can do on a  per- disk basis. First, there is na]`[]da]`, which can be tuned 
in +ouo+^hk_g+8UKQN@ARE?A:+mqaqa+na]`[]da]`[g^. On a default Ubuntu Server installa-
tion, this parameter is set to 128 KB. If you have slow disks, you can optimize your read 
performance by using a higher value; 512 KB, for instance, is a good option. Also, you can 
tune the number of outstanding read requests by using +ouo+^hk_g+8UKQN@ARE?A:+mqaqa+
jn[namqaopo. The default value for this parameter also is set to 128, but a higher value may 
optimize your server in a significant way. Try 512, or even 1024, to get the best read per-
formance, but do always observe whether it introduces too much latency while writing 
files. 
NNote Optimizing read performance works well but be aware that, while making read performance bet-
ter, you’ll also introduce latency on writes. In general, there is nothing against that, but if your server loses 
power, all data that is still in memory buffers and hasn’t been written yet will be lost. 
Network Tuning
Among the most difficult items to tune is network performance, because multiple layers 
are used in networking. First, there are buffers on the network card itself that deal with 
physical packets. Next, there is the TCP/IP protocol stack, and then the application stack. 
All layers work together, and tuning one will have its consequences at the other layers. 
While tuning the network, always work upward in the protocol stack. That is, start by tun-
ing the packets themselves, then tune the TCP/IP stack, and after that have a look at the 
service stacks that are in use on your server. 
Tuning Kernel Parameters
While it initializes, the kernel sets some parameters automatically, based on the amount 
of memory that is available on your server. So the good news is that in many situations, 
there is no work to be done here. Some parameters, however, by default are not set in the 
most optimal way, so there is some performance to gain there. 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
99
For every network connection, the kernel allocates a socket. The socket is the  end- 
to- end line of communication. Each socket has a receive buffer and a send buffer, also 
known as the read (receive) and write (send) buffers. These buffers are very important; 
if they are full, no more data can be processed, so data will be dropped. This will have 
important consequences for the performance of your server, because if data is dropped, 
it needs to be processed again. 
The basis of all reserved sockets on the network comes from two +lnk_ tunables:
+lnk_+ouo+jap+_kna+siai[`ab]qhp
+lnk_+ouo+jap+_kna+niai[`ab]qhp
All  kernel- based sockets are reserved from these sockets. However, if a socket is TCP 
based, the settings in here are overwritten by  TCP- specific parameters, in particular the 
p_l[niai and p_l[siai parameters. The upcoming section “Tuning TCP Read and Write 
Buffers” give more details on how to optimize those parameters. 
The values of siai[`ab]qhp and niai[`ab]qhp are set automatically when your server 
boots. If, however, you suffer from dropped packets, you may benefit from increasing 
them. In many cases the values that are used by default are rather low. To set them, tune 
the following parameters in +ap_+ouo_ph*_kjb:
jap*_kna*siai[`ab]qhp
jap*_kna*niai[`ab]qhp
Especially if you have dropped packets, try doubling them to find out if it leads to 
a better network performance.
Related to the default read and write buffer sizes are the maximum read and write 
buffer sizes, niai[i]t and siai[i]t. These are also calculated automatically when your 
server boots up, but for many situations are far too low. For instance, on a server that has 
4 GB of RAM, the sizes of these are set to 128 KB only! You may benefit from changing 
their values to 8 MB instead:
ouo_ph)sjap*_kna*niai[i]t94/442,4
ouo_ph)sjap*_kna*siai[i]t94/442,4
When increasing the read and write buffer sizes, you also have to increase the maxi-
mum number of incoming packets that can be queued. This is set in jap`ar[i]t[^]_ghkc. 
The default value is set to 1000, which is not enough for very busy servers. Try increasing 
it to a much higher value, like 8000, especially if you suffer from long latency times on 
your network, or if there are lots of dropped packets:
ouo_ph)sjap*_kna*jap`ar[i]t[^]_ghkc94,,,
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
100
Apart from the maximum number of incoming packets that your server can queue, 
there also is a maximum number of incoming connections that can be accepted. You can 
set this parameter from the oki]t_kjj file in +lnk_:
ouo_ph)sjap*_kna*oki]t_kjj91-.
By tuning this parameter, you will limit the number of new connections that are 
dropped. 
Optimizing TCP/IP
Up to now, you have tuned kernel buffers for network sockets only. These are generic 
parameters. If you are working with TCP, some specific tunables are available as well. 
Sometimes the options are related; if they are, the option that is higher in the protocol 
stack will always win. That is, a TCP tunable will overwrite a generic tunable. Most of 
the TCP tunables by default have a value that is too low. Chances are that you can gain 
a lot by increasing them. All relevant options are in +lnk_+ouo+jap+elr0, as you can see in 
 Listing 4-8.
 Listing 4-8. Set All  IP- Related Parameters by Adding the Value You Want to Use in /proc/sys/
net/ipv4
nkkp<iah6+lnk_+ouo+jap+elr0ho
_elok[_]_da[^q_gap[oevap_l[`i][_klu^na]g
_elok[_]_da[aj]^hap_l[`o]_g
_elok[n^i[klpbipp_l[a_j
_elok[n^i[opne_pr]he`p_l[b]_g
_kjbp_l[bej[peiakqp
e_il[a_dk[ecjkna[]hhp_l[bnpk
e_il[a_dk[ecjkna[^nk]`_]opop_l[bnpk[naolkjoa
e_il[annkno[qoa[ej^kqj`[eb]``np_l[gaal]hera[ejprh
e_il[ecjkna[^kcqo[annkn[naolkjoaop_l[gaal]hera[lnk^ao
e_il[n]paheiepp_l[gaal]hera[peia
e_il[n]pai]ogp_l[hks[h]paj_u
ecil[i]t[iai^anodelop_l[i]t[knld]jo
ecil[i]t[iobp_l[i]t[oopdnaod
ejap[laan[c_[i]tpeiap_l[i]t[ouj[^]_ghkc
ejap[laan[c_[iejpeiap_l[i]t[ps[^q_gapo
ejap[laan[i]tpphp_l[iai
ejap[laan[iejpphp_l[ik`an]pa[n_r^qb
ejap[laan[pdnaodkh`p_l[ipq[lnk^ejc
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
101
el[`ab]qhp[pphp_l[jk[iapne_o[o]ra
el[`uj]``np_l[knld]j[napneao
el[bkns]n`p_l[nakn`anejc
elbn]c[decd[pdnaodp_l[napn]jo[_khh]loa
elbn]c[hks[pdnaodp_l[napneao-
elbn]c[i]t[`eopp_l[napneao.
elbn]c[oa_nap[ejpanr]hp_l[nb_-//3
elbn]c[peiap_l[niai
el[hk_]h[lknp[n]jcap_l[o]_g
el[jkjhk_]h[^ej`p_l[ohks[op]np[]bpan[e`ha
el[jk[lipq[`eo_p_l[op`qnc
jaecdp_l[ouj]_g[napneao
japbehpanp_l[ouj_kkgeao
nkqpap_l[ouj[napneao
p_l[]^_p_l[peiaop]ilo
p_l[]^knp[kj[kranbhksp_l[pok[sej[`ereokn
p_l[]`r[sej[o_]hap_l[ps[na_u_ha
p_l[]hhksa`[_kjcaopekj[_kjpnkhp_l[ps[naqoa
p_l[]ll[sejp_l[sej`ks[o_]hejc
p_l[]r]eh]^ha[_kjcaopekj[_kjpnkhp_l[siai
p_l[^]oa[ioop_l[skng]nkqj`[oecja`[sej`kso
p_l[_kjcaopekj[_kjpnkh
Tuning TCP Read and Write Buffers
A good place to start to optimize network performance is to tune the TCP read buffer size 
and write buffer size. By tuning them, you modify the amount of memory reserved for 
incoming (read) and outgoing (write) packets. These values are written to p_l[niai and 
p_l[siai. The kernel tries to allocate the best possible values for these parameters when 
it boots, but in some cases it doesn’t work out that well. An indication of this is, for exam-
ple, if your network suffers from dropped packets. If that happens, you can change the 
minimum size, the default size, and the maximum size of these buffers. Notice that each 
of these two parameters contains three values at the same time, for minimal, default, and 
maximal size. In general there is no need to tune the minimal size. Tuning the default 
size can be interesting, though. This is the buffer size that will be available when your 
server boots. By tuning it, you will ensure that your server works with the correct values 
straight away, and that you won’t have to do any extra work. Tuning the maximum size 
is important, as it defines the upper threshold above which packets will get dropped. In 
 Listing 4-9 you can see the default settings for these parameters on my server that has 
4 GB of RAM.
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
102
 Listing 4-9. Default Settings for TCP Read and Write Buffers
nkkp<iah6z_]p+lnk_+ouo+jap+elr0+p_l[niai
0,5243/4,0-50/,0
nkkp<iah6z_]p+lnk_+ouo+jap+elr0+p_l[siai
0,52-2/400-50/,0
In this example, the maximum size is quite good, and 4 MB is available as the maxi-
mum size for read and write buffers. The default write buffer size, though, is limited. 
Imagine that you want to tune these parameters in a way that the default write buffer size 
is as big as the default read buffer size, and the maximum for both parameters is set to 
8 MB. You could do that by using the next two commands:
ouo_ph)sjap*elr0*p_l[niai90,5243/4,4/442,4
ouo_ph)sjap*elr0*p_l[siai90,5243/4,4/442,4
Before tuning options like these, you should always check the availability of memory 
on your server. All memory that is allocated for TCP read and write buffers can’t be used 
for other purposes anymore, so you might cause problems in other areas while tuning 
these. However, if you use a modern server that has gigabytes of RAM, this problem will 
not be relevant for you.
Tuning TCP Acknowledgments
Another useful set of parameters in +lnk_+ouo+jap+elr0 is related to TCP’s use of acknowl-
edgments. TCP uses acknowledgments to confirm that certain packets have been 
received. Let’s have a look at an example to understand how this works. Imagine that 
the sender in a TCP connection sends a series of packets, numbered 1,2,3,4,5,6,7,8,9,10. 
Now imagine that the receiver receives all of them, with the exception of packet 5. In the 
default setting, the receiver would acknowledge receiving up to packet 4, in which case 
the sender would send packets 5,6,7,8,9,10 again. This is a waste of bandwidth, because 
packets 6,7,8,9,10 have been received correctly already and will be sent again. 
To handle this acknowledgment traffic in a more efficient way, the setting +lnk_+ouo+
jap+elr0+p_l[o]_g is enabled (has the value of 1). That means in cases like the preceding 
example, only missing packets have to be sent again and not the complete packet stream. 
For the sake of your network bandwidth, that is good, because only those packets that 
really need to be retransmitted are retransmitted. So if your bandwidth is low, you should 
always leave +lnk_+ouo+jap+elr0+p_l[o]_g on. If, however, you are on a fast network, there 
is a downside. When using this parameter, packets may come in out of order, in which 
case you need larger TCP receive buffers to keep all the packets until they can be defrag-
mented and put in the right order. That means that using this parameter involves more 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
103
memory being reserved. From that perspective, on fast network connections, you better 
switch it off. To switch it off, use the following:
ouo_ph)sjap*elr0*p_l[o]_g9,
When disabling TCP selective acknowledgments as just discussed, you should also 
disable two related parameters: p_l[`o]_g and p_l[b]_g. These parameters enable selec-
tive acknowledgments for specific packet types. If p_l[o]_g is enabled, these should be on 
as well, and if p_l[o]_g is disabled, make sure these are off. To enable them, use the fol-
lowing two commands:
ouo_ph)sjap*elr0*p_l[`o]_g9,
ouo_ph)sjap*elr0*p_l[b]_g9,
If you prefer to work with selective acknowledgments, you can also tune the amount 
of memory that is reserved to buffer incoming packets that have to be put in the right 
order. With p_l[o]_g on, these buffers need to be bigger than they need to be if p_l[o]_g 
is off. This is because more packets need to be held in the buffer, waiting for all pack-
ets to be received, before your server can process them. Two parameters relate to this, 
elbn]c[hks[pdnaod and elbn]c[decd[pdnaod. When the number that is specified in elbn]c[
decd[pdnaod is reached, new packets to be defragmented are dropped until the server 
reaches elbn]c[hks[pnaod. Make sure the value of both of these parameters is set high 
enough at all times if your server uses selective acknowledgments. The following values 
are reasonable for most servers:
ouo_ph)sjap*elr0*elbn]c[hks[pdnaod9/5/.-2
ouo_ph)sjap*elr0*elbn]c[decd[pdnaod91.0.44
Optimizing Connections
Next in +lnk_+ouo+jap+elr0 is the length of the TCP Syn queue that is created for each 
port. The idea is that all incoming connections are queued until they can be serviced. As 
you can probably guess, when the queue is full, connections get dropped. The situation is 
that the p_l[i]t[ouj[^]_ghkc parameter that manages these  per- port queues has a default 
value that is too low, as only 1024 bytes are reserved for each port. For good performance, 
it is better to allocate 8192 bytes per port. I recommend always using the value 8192 for 
this parameter, to make sure that your server won’t suffer from lost packets:
ouo_ph)sjap*elr0*p_l[i]t[ouj[^]_ghkc94-5.
Also, there are some options that relate to the time an established connection 
is maintained. The idea is that every connection that your server has to keep alive 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
104
uses resources. If your server is a very busy server, at a given moment, it will be out of 
resources and tell new incoming clients that no resources are available. Because a client 
can easily reestablish a connection in most cases, you probably want to tune your server 
in a way that it detects failing connections as soon as possible. 
The first parameter that relates to maintaining connections is p_l[ouj]_g[napneao. 
This parameter defines the number of times the kernel will send a response to an incom-
ing new connection request. The default value is 5. Given the current quality of network 
connections, 3 is probably enough. So use the following to change it:
ouo_ph)sjap*elr0*p_l[ouj]_g[napneao9/
Next is the p_l[napneao. option. This relates to the number of times the server tries to 
resend data to a remote host that has an established session. Because it is inconvenient 
for a client computer if a connection is dropped, the default value, 15, is a lot higher than 
the default value for p_l[ouj]_g[napneao. However, retrying it 15 times means that all that 
time your server can’t use its resources for something else. Therefore, better decrease this 
parameter to a more reasonable value of 5:
ouo_ph)sjap*elr0*p_l[napneao.91
The parameters just mentioned relate to sessions that appear to be gone. Another 
area where you can do some optimization is in maintaining inactive sessions. By 
default, a TCP session can remain idle forever. You probably don’t want that, so use the 
p_l[gaal]hera[peia option to determine how long an established inactive session will be 
maintained. By default, this will be 7200 seconds (2 hours). If your server tends to run out 
of resources, limit it to a considerably shorter period of time:
ouo_ph)sjap*elr0*p_l[gaal]hera[peia95,,
Related to gaal]hera[peia is the number of packets that your server sends before 
deciding that a connection is dead. You can manage this by using the p_l[gaal]hera[
lnk^ao parameter. By default, nine packets are sent before a server is considered dead. 
Change this value to 3 if you want to terminate dead connections faster:
ouo_ph)sjap*elr0*p_l[gaal]hera[lnk^ao9/
Related to the number of keepalive probes is the interval you want to use to send 
these probes. By default, that happens every 75 seconds. So even with three probes, it still 
takes more than 3 minutes before your server can see that a connection has really failed. 
To bring this period back, give the p_l[gaal]hera[ejprh parameter the value of 15:
ouo_ph)sjap*elr0*p_l[gaal]hera[ejprh9-1
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
105
To complete the story about maintaining connections, we need two more param-
eters. By default, the kernel waits a little before reusing a socket. If you run a busy server, 
performance will benefit from switching this feature off. To do this, use the following two 
commands:
ouo_ph)sjap*elr0*p_l[ps[naqoa9-
ouo_ph)sjap*elr0*p_l[ps[na_u_ha9-
Some Hints on Samba and NFS Performance Optimization
In Linux environments, there are two file servers that really matter. First, there is NFS. 
NFS is a  kernel- integrated file server, simple and therefore very fast, but not particularly 
secure. With NFS version 4, some security features have been added to NFS, but because 
in version 4 NFS isn’t simple anymore, few companies really use it. The tips in this chap-
ter are all version 3 related. 
Samba is the open source implementation of the Windows Server Message Block 
(SMB) protocol that is used for file sharing in Windows environments. Because most 
users use Windows, Samba is a very popular file server. You can even use it with Apple or 
Linux clients, because they also include a Samba client stack.
NNote Modern Linux kernels can use two different modules for the Samba client: the older smbfs and the 
newer cifs. If it is available, use the cifs kernel module at all times, because it performs much better than the 
older smbfs module.
Optimizing NFS Performance
The first performance optimization parameters for NFS that almost everyone uses are the 
noeva and soeva options. These are client options, used when mounting an NFS share. If 
the MTU size on your network is set to 9000 bytes, make sure to use an noeva and soeva of 
8192 bytes. The following line shows how to mount an NFS file server using these options:
ikqjp)pjbo)knoeva94-5.(soeva94-5.iuoanran6+iuod]na+iu`ena_pknu
The next choice in NFS performance optimization is whether to use ouj_ or ]ouj_. 
These are options when exporting a mount on the NFS server. The default choice is to 
export a mount with the ouj_ option. This means that incoming data is written to disk 
before the NFS server confirms. This is safe, but it also is rather slow. If you are willing 
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
106
to take the risk of losing some data when your server crashes, and get a better write per-
formance in exchange, use the ]ouj_ flag. The following example line from +ap_+atlknpo 
shows how to use it:
+iuod]na&$ns(]ouj_(nkkp[omq]od%
Optimizing Samba Performance
As is the case for NFS, there also are some performance parameters that you can use 
to increase Samba server performance. Unless stated otherwise, you should set these 
parameters in +ap_+o]i^]+oi^*_kjb. The first of them is the socket option p_l[jk`ah]u, 
which can be used in combination with the IP Type of Service (TOS) option. If your 
Samba server serves clients on the LAN, use the following:
ok_gapklpekjo9ELPKO[HKS@AH=UP?L[JK@AH=U
If your server is serving Samba clients over a WAN connection, better use the 
following:
ok_gapklpekjo9ELPKO[PDNKQCDLQPP?L[JK@AH=U
The next setting to consider is the maximum transmit size. Normally, your client 
negotiates with the server to determine what maximum size to use for packets. You can 
set the maximum size the server will allow by using the tiep option in oi^*_kjb. The inter-
esting thing is that you might think that bigger is always better, but this is not the case. If 
your clients perform badly, try a value smaller than the default of 65536; for instance:
tiep9/.324
When using this parameter, don’t set it too low. 4096 really is the minimal value to 
use, but you probably never want to go that low. 
Apart from the options mentioned here, Samba has many other tuning options. 
Check i]joi^*_kjb for more information. 
Generic Network Performance Optimization Tips
Until now, we have discussed kernel parameters only. There are also some  more- generic 
hints to consider when optimizing performance on the network. You probably already 
have applied all of them, but just to be sure, let’s repeat some of the most important tips:
www.it-ebooks.info

CHAPTER 4 N   PERFORMANCE OPTIMIZATION
107
 s  -AKE SURE YOU HAVE THE LATEST NETWORK DRIVER MODULES
 s  5SE NETWORK CARD TEAMING TO DOUBLE PERFORMANCE OF THE NETWORK CARD IN YOUR server.
 s  #HECK %THERNET CONFIGURATION SETTINGS SUCH AS THE FRAME SIZE -45 SPEED AND duplex mode on your network. Make sure all devices involved in network commu-
nications use the same settings.
 s  )F SUPPORTED BY ALL DEVICES IN YOUR NETWORK USE   BYTE JUMBO FRAMES 4HIS reduces the number of packets sent over the network, thereby reducing the over-
head that is caused by sending all those packets, the result of which is a speedier 
network overall. 
Summary
In this chapter you have learned how to tune performance of your server. Even if mod-
ern Linux kernels are quite good in automatically setting the best  performance- related 
parameters, there is always room for improvement. Performance optimization can be 
cumbersome work, though, in which many elements are involved, not only parts of your 
server. In the next chapter you’ll learn more about advanced file system management. 
www.it-ebooks.info

109
C H A P T E R  5
Advanced File System 
Management
Getting the Best Out of Your 
File Systems
File system management is among the first things that you do when you start using 
Ubuntu Server. When you installed Ubuntu Server, you had to select a default file system. 
At that time, you probably didn’t consider advanced file system options. If you didn’t, this 
chapter will help you to configure those options. This chapter first provides an  in- depth 
look at the way a server file system is organized, so that you understand what tasks your 
file system has to perform. This discussion also considers key concepts such as journaling 
and indexing. Following that, you’ll learn how to tune and optimize the relevant Ubuntu 
file systems.
Understanding File Systems
A file system is the structure that is used to access logical blocks on a storage device. For 
Linux, different file systems are available, of which Ext2, Ext3, XFS, and, to some extent, 
ReiserFS are the most important. All have in common the way in which they organize log-
ical blocks on the storage device. Another commonality is that inodes and directories play 
a key role in allocating files on all four file systems. Despite these common elements, each 
file system has some properties that distinguish it from the others. In this section you will 
read both about the properties that all file systems have in common and about the most 
important differences. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
110
Inodes and Directories
The basic building block of a file system is the logical block. This is a storage unit your 
file system is using. Typically, it exists on a logical volume or a traditional partition (see 
Chapter 1 for more information). To access the data blocks, the file system collects infor-
mation about where the blocks of any given file are stored. This information is written 
to the inode. Every file on a Linux file system has an inode, and the inode contains the 
almost complete administrative record of your files. To give you a better idea of what an 
inode is,  Listing 5-1 shows the contents of an inode as it exists on an Ext2 file system, as 
shown with the `a^qcbo utility. Use the following procedure to display this information:
 
1. Make sure files on the file system cannot be accessed while working in `a^qcbo. 
You could consider remounting the file system using ikqjp)knaikqjp(nk
+ukqnbehaouopai. However, if you have installed your server according to the guide-
lines in Chapter 1, remounting is not necessary. You will have an Ext2-formatted 
+^kkp. If necessary, use the ikqjp command to find out which device it is using (this 
should be +`ar+d`]- or +`ar+o`]-) and proceed. 
 
2. Open a directory on the device that you want to monitor and use the ho)e com-
mand to display a list of all file names and their inode numbers. Every file has one 
inode that contains its complete administrative record. Note the inode number, 
because you will need it in step 4 of this procedure. 
 
3. Use the `a^qcbo command to access the file system on your device in debug mode. 
For example, if your file system is +`ar+o`]-, you would use `a^qcbo+`ar+o`]-.
 
4. Use the op]p command that is available in the file system debugger to show the 
contents of the inode. When done, use atep to close the `a^qcbo environment.
 Listing 5-1. The Ext2/Ext3 debugfs Tool Allows You to Show the Contents of an Inode
nkkp<iah6+^kkp`a^qcbo+`ar+o`]-
`a^qcbo-*0,*4$-/)I]n).,,4%
`a^qcbo6op]p8-5:
Ejk`a6-5Pula6nacqh]nIk`a6,200Bh]co6,t,Cajan]pekj6.2/.04,,,,
Qoan6,Cnkql6,Oeva64.--513
Beha=?H6,@ena_pknu=?H6,
Hejgo6->hk_g_kqjp6-2-,2
Bn]ciajp6=``naoo6,Jqi^an6,Oeva6,
_peia6,t04-32.23))Pqa=ln.5-06,-6--.,,4
]peia6,t041a]/a5))OqjFqj..-16--6/3.,,4
ipeia6,t04-32.23))Pqa=ln.5-06,-6--.,,4
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
111
>HK?GO6
$,)--%6..305)..32,($EJ@%6..32-($-.).23%6..32.)./,-3($@EJ@%6./,-4(±
$EJ@%6./,-5($.24)1./%6./,.,)./.31($EJ@%6./.32($1.0)335%6./.33)./1/.(±
$EJ@%6./1//($34,)-,/1%6./1/0)./345($EJ@%6./35,($-,/2)-.5-%6./35-).0,02(±
$EJ@%6.0,03($-.5.)-103%6.0,04).0/,/($EJ@%6.0/,0($-104)-4,/%6.0/,1).012,(±
$EJ@%6.012-($-4,0)-4-4%6.012.).0132($-4-5).,15%6.1,53).1//3($EJ@%6.1//4(±
$.,2,)./-1%6.1//5).1150($EJ@%6.1151($./-2).13-%6.1152).141-($EJ@%6.141.(±
$.13.).4.3%6.141/).2-,4($EJ@%6.2-,5($.4.4)/,4/%6.2--,).2/21($EJ@%6.2/22(±
$/,40)///5%6.2/23).22..($EJ@%6.22./($//0,)/151%6.22.0).2435($EJ@%6.244,(±
$/152)/41-%6.244-).3-/2($EJ@%6.3-/3($/41.)0-,3%6.3-/4).3/5/($EJ@%6.3/50(±
$0-,4)0/2/%6.3/51).321,($EJ@%6.321-($0/20)02-5%6.321.).35,3($EJ@%6.35,4(±
$02.,)0431%6.35,5).4-20($EJ@%6.4-21($0432)1-/-%6.4-22).40.-($EJ@%6.40..(±
$1-/.)1/43%6.40./).4234($EJ@%6.4235($1/44)120/%6.424,).45/1($EJ@%6.45/2(±
$1200)1455%6.45/3).5-5.($EJ@%6.5-5/($15,,)2-11%6.5-50).5005($EJ@%6.501,(±
$2-12)20--%6.501-).53,2($EJ@%6.53,3($20-.)2223%6.53,4).552/($EJ@%6.5520(±
$2224)25./%6.5521)/,..,($EJ@%6/,..-($25.0)3-35%6/,...)/,033($EJ@%6
If you look closely at the information that is displayed by using `a^qcbo, you’ll see that 
it basically is the same information that is displayed when using ho)h on a given file. The 
only difference is that in this output you can see the blocks that are in use by your file as 
well, and that may come in handy when restoring a file that has been deleted by accident. 
The interesting thing about the inode is that it contains no information about the 
name of the file, because, from the perspective of the operating system, the name is not 
important. Names are for human users and they can’t normally handle inodes too well. 
To store names, Linux uses a directory tree.
A directory is a special kind of file, containing a list of files that are in the directory, 
plus the inode that is needed to access these files. Directories themselves have an inode 
number as well; the only directory that has a fixed inode is +. This guarantees that your 
file system can always start locating files. 
If, for example, a user wants to read the file +ap_+dkopo, the operating system will first 
look in the root directory (which always is found at the same location) for the inode of the 
directory +ap_. Once it has the inode for +ap_, it can check what blocks are used by this 
inode. Once the blocks of the directory are found, the file system can see what files are 
in the directory. Next, it checks which inode it needs to open the +ap_+dkopo file. It then 
uses that inode to open the file and present the data to the user. This procedure works the 
same for every file system that can be used. 
In a very basic file system such as Ext2, the procedure works exactly in the way just 
described. Advanced file systems may offer options to make the process of allocating 
files somewhat easier. For instance, the file system may work with extents. An extent is 
a large number of contiguous blocks allocated by the file system as one unit. This makes 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
112
handling large files a lot easier. Since 2006, there is a patch that enhances Ext3 to sup-
port extent allocation. You can see the result immediately when comparing the result 
of  Listing 5-1 with  Listing 5-2. This is the inode for the same file after it has been copied 
from the Ext2 volume to the Ext3 volume. As you can see, it has many fewer blocks to 
manage.
 Listing 5-2. A File System Supporting Extents Has Fewer Individual Blocks to Manage and 
Thus Is Faster
nkkp<iah6+`a^qcbo+`ar+ouopai+nkkp
`a^qcbo-*0,*4$-/)I]n).,,4%
`a^qcbo6op]p8.014,:
Ejk`a6.014,Pula6nacqh]nIk`a6,200Bh]co6,t,Cajan]pekj6.,.2/01/-1
Qoan6,Cnkql6,Oeva64.--513
Beha=?H6,@ena_pknu=?H6,
Hejgo6->hk_g_kqjp6-2,20
Bn]ciajp6=``naoo6,Jqi^an6,Oeva6,
_peia6,t043./4aa))IkjFqh3--60,6/,.,,4
]peia6,t043./4aa))IkjFqh3--60,6/,.,,4
ipeia6,t043./4aa))IkjFqh3--60,6/,.,,4
>HK?GO6
$,)--%6-,2052)-,21,3($EJ@%6-,21,4($-.)-,/1%6-,21,5)-,31/.(±
$@EJ@%6-,31//($EJ@%6-,31/0($-,/2).,,0%6-,31/1)-,41,/
PKP=H6.,,4
$AJ@%
A file system may use other techniques to work faster as well, such as allocation 
groups. By using allocation groups, a file system divides the available space into chunks 
and manages each chunk of disk space individually. By doing this, the file system can 
achieve a much higher I/O performance. All Linux file systems use this technique; some 
even use the allocation group to store backups of vital file system administration data. 
Superblocks, Inode Bitmaps, and Block Bitmaps
To mount a file system, you need a file system superblock. Typically, this is the first block 
on a file system and contains generic information about the file system. You can make it 
visible using the op]po command from a `a^qcbo environment.  Listing 5-3 shows you what 
it looks like for an Ext3 file system. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
113
 Listing 5-3. Example of an Ext3 Superblock
nkkp<iah6z`a^qcbo+`ar+ouopai+nkkp
`a^qcbo-*0,*4$-/)I]n).,,4%
`a^qcbo6op]po
Behaouopairkhqiaj]ia68jkja:
H]opikqjpa`kj68jkp]r]eh]^ha:
BehaouopaiQQE@6`0,201a.)0-.a)041a)5..1)4a3b43^5b124
Behaouopaii]ce_jqi^an6,tAB1/
Behaouopainareoekj6-$`uj]ie_%
Behaouopaiba]pqnao6d]o[fkqnj]hatp[]ppnnaoeva[ejk`a`en[ej`at±
behapulajaa`o[na_kranuol]noa[oqlanh]nca[beha
Behaouopaibh]co6oecja`[`ena_pknu[d]od
@ab]qhpikqjpklpekjo6$jkja%
Behaouopaiop]pa6_ha]j
Annkno^ad]rekn6?kjpejqa
BehaouopaiKOpula6Hejqt
Ejk`a_kqjp6211/2,,
>hk_g_kqjp6.2.-00,,
Naoanra`^hk_g_kqjp6-/-,3.,
Bnaa^hk_go6./412/03
Bnaaejk`ao62034023
Benop^hk_g6,
>hk_goeva60,52
Bn]ciajpoeva60,52
Naoanra`C@P^hk_go6-,-3
>hk_golancnkql6/.324
Bn]ciajpolancnkql6/.324
Without superblock, you cannot mount the file system; therefore, most file systems 
keep backup superblocks at different locations in the file system. In that case, if the real 
file system gets broken, you can mount using the backup superblock and still access the 
file system anyway. 
Apart from the superblocks, the file system contains an inode bitmap and a block 
bitmap. By using these bitmaps, the file system driver can determine easily if a given 
block or inode is available. When creating a file, the inode and blocks used by the file are 
marked as in use, and when deleting a file, they are marked as available and thus can be 
overwritten by new files. 
After the inode and block bitmaps sits the inode table. This contains the administra-
tive information of all files on your file system. Since it normally is big (an inode is at least 
128 bytes), there is no backup of the inode table. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
114
Journaling
With the exception of Ext2, all current Linux file systems support journaling. The journal 
is used to track changes of files as well as metadata. The goal of using a journal is to make 
sure that transactions are processed properly, especially if a power outage occurs. In that 
case, the file system will check the journal when it comes back up again and, depending 
on the journaling style that is configured, do a rollback of the original data or a check on 
the data that was open when the server crashed. Using a journal is essential on large file 
systems to which lots of files get written. Only if a file system is very small, or writes hardly 
ever occur on the file system, can you configure the file system without a journal.
NTip An average journal takes about 40 MB of disk space. If you need to configure a very small file system, 
such as the 100 MB +^kkp partition, it doesn’t make sense to create a journal on it. Use Ext2 in those cases.
In Chapter 4, you read about the scheduler and how it can be used to reorder read 
and write requests. Using the scheduler can give you a great performance benefit. When 
using a journal, however, there is a problem: write commands cannot be reordered. The 
reason is that, to use reordering, data has to be kept in cache longer, whereas the pur-
pose of a journal is to ensure data security, which means that data has to be written as 
soon as possible.
To avoid reordering, a journal file system should use barriers. This ensures that the 
disk cache is flushed immediately, which ensures that the journal gets updated properly. 
Barriers are enabled by default, but they may slow down the write process. If you want 
your server to perform write operations as fast as possible, and at the same time you are 
willing to take an increased risk of data loss, you should switch barriers off. To switch off 
barriers, add a mount option. Each file system needs a different option:
 s  8&3 USES jk^]nnean.
 s  %XT USES ^]nnean9,.
 s  2EISER&3 USES ^]nnean9jkja.
Journaling offers three different journaling modes. All of these are specified as 
options while mounting the file system, which allows you to use different journaling 
modes on different file systems. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
115
 s `]p]9kn`ana`: When using this option, only metadata is journaled and barriers 
are enabled by default. This way, data is forced to be written to hard disk as fast as 
possible, which reduces the chances of things going wrong. This journaling mode 
uses the optimal balance between performance and data security.
 s  `]p]9snepa^]_g: If you want the best possible performance, use this option. This 
option only journals metadata, but does not guarantee data integrity. This means 
that, based on the information in the journal, when your server crashes, the file 
system can try to repair the data but may fail, in which case you will end up with 
the old data (dating from before the moment that you initialized the write action) 
after a system crash. This option at least guarantees fast recovery after a system 
crash, which is sufficient for many environments.
 s `]p]9fkqnj]h: If you want the best guarantees for your data, use this option. When 
using this option, data and metadata is journaled. This ensures the best data integ-
rity, but gives bad performance because all data has to be written twice. It has to 
be written to the journal first, and then to the disk when it is committed to disk. If 
you need this journaling option, you should always make sure that the journal is 
written to a dedicated disk. Every file system has options to accomplish that. 
Indexing
When file systems were still small, no indexing was used. An index wasn’t necessary to 
get a file from a list of a few hundred files. Nowadays, directories can contain many thou-
sands, sometimes even millions, of files; to manage so many files, an index is essential. 
Basically, there are two approaches to indexing. The easiest approach is to add an 
index to a directory. This approach is used by the Ext3 file system: it adds an index to 
all directories and thus makes the file system faster when many files exist in a directory. 
However, this is not the best approach to indexing. 
For optimal performance, it is better to work with a balanced tree (also referred to as 
 b- tree) that is integrated into the heart of the file system itself. In such a balanced tree, 
every file is a node in the tree and every node can have child nodes. Because every file is 
represented in the indexing tree, the file system is capable of finding files very quickly, no 
matter how many files there are in a directory. Using a  b- tree for indexing also makes the 
file system a lot more complicated. If things go wrong, the risk exists that you will have to 
rebuild the entire file system, and that can take a lot of time. In this process, you even risk 
losing all data on your file system. Therefore, when choosing a file system that is built on 
top of a  b- tree index, make sure it is a stable file system. Currently, XFS and ReiserFS have 
an internal  b- tree index. Of these two, ReiserFS isn’t considered a very stable file system, 
so better use XFS if you want indexing.
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
116
Optimizing File Systems
Every file system has its own options for optimization. In fact, the presence or absence 
of a particular option may be a reason to prefer or avoid a given file system in particular 
situations. Speaking in general, Ext3/Ext3 is a fantastic generic file system. It is stable 
and very good in environments in which not too much data is written. XFS is a very 
dynamic file system with lots of tuning options that make it an excellent candidate for 
handling large amounts of data. ReiserFS should be avoided. Its main developer, Hans 
Reiser, is in prison for  second- degree murder, so the future of ReiserFS is currently very 
uncertain. Regardless, it is covered later in the chapter just in case you are stuck using 
a ReiserFS file system.
Optimizing Ext2/Ext3
Before the arrival of journaling file systems, Ext2 was the default file system on all Linux 
distributions. It was released in 1993 as a successor to the old and somewhat buggy Ext 
file system. Ext2 was successful for a few years, until the release of Ext3 in the late 1990s. 
Initially, there was only one difference between Ext2 and Ext3: Ext3 has a journal, whereas 
Ext2 doesn’t have one. Over time, patches have enhanced Ext3 some more. For instance, 
Ext3 has directory indexing and works with extents, neither of which is the case for Ext2. 
The successor of Ext3 is Ext4. This file system is already well on its way toward release, but 
because it is not included in Ubuntu Server 8.04, I won’t cover it in this book.
On a current Linux server, it isn’t really a dilemma whether you should use Ext2 or 
Ext3. In almost all cases you want to use Ext3, because it has more features. Choose Ext2 
only if you specifically don’t want a journal, perhaps because your file system is too small 
to host a journal. For example, this is the case for the +^kkp file system. Because Ext2 and 
Ext3 are almost completely compatible, I’ll cover Ext3 optimization in the rest of this 
subsection.
Creating Ext2/Ext3
While creating an Ext3 file system, you can pass many options to it. Even if you don’t pass 
any options, some options will be applied automatically from the +ap_+iga.bo*_kjb con-
figuration file. In this file, you can include default options for Ext2 and Ext3.  Listing 5-4 
shows you what the contents of this file look like. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
117
 Listing 5-4. Use /etc/mke2fs.conf to Specify Default Options to Always Use when Creating an 
Ext3 File System
nkkp<iah6z_]p+ap_+iga.bo*_kjb
W`ab]qhpoY
^]oa[ba]pqnao9ol]noa[oqlan(behapula(naoeva[ejk`a(`en[ej`at(atp[]ppn
^hk_goeva90,52
ejk`a[oeva9-.4
ejk`a[n]pek9-2/40
Wbo[pulaoY
oi]hh9w
^hk_goeva9-,.0
ejk`a[oeva9-.4
ejk`a[n]pek90,52
y
bhkllu9w
^hk_goeva9-,.0
ejk`a[oeva9-.4
ejk`a[n]pek94-5.
y
jaso9w
ejk`a[n]pek90,52
y
h]ncabeha9w
ejk`a[n]pek9-,04132
y
h]ncabeha09w
ejk`a[n]pek90-50/,0
y
For a complete overview of options that you can use when creating an Ext3 file 
 system, use the man page of igbo*atp/.  Table 5-1 covers only the most useful options.
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
118
 Table 5-1. Most Useful mkfs.ext3 Options
Option 
Description
)_ 
 This option checks the device for bad blocks. Use it if you don’t 
trust the device and are unable to buy a new storage device. By 
default, a fast  read- only test is performed when using this option. If 
you want to perform a faster read/write test, use )__.
)c^hk_go[lan[cnkql 
 Ext3 organizes its file system in block groups. By using block 
groups, the file system can perform operations in parallel, which 
increases general file system performance. If you want more tasks 
on your file system to run simultaneously, use fewer blocks per 
block group. You should consider, however, that when creating 
the Ext3 file system, the optimal number of blocks per block group 
is calculated automatically, so it may not make sense to use this 
 option.
)F`are_a9atpanj]h)fkqnj]h 
 Use this option if you want to use an external journal. You should 
always use this option if you want to apply the `]p]9fkqnj]h mount 
option, because it allows for much better performance. If you 
want to use this option, you must create an external journal first. 
You would normally do that using the )Kfkqnj]h[`ar  option. For 
instance, use igbo*atp/)Kfkqnj]h[`ar+`ar+o`^- to make +`ar+
o`^- your journal device. Next, you can create the file system that 
uses the external journal by using the command igbo*atp/)F
`are_a9+`ar+o`^-.
)Jjqi^an[kb[ejk`ao 
 When creating an Ext3 file system, Ext3 creates a fixed number of 
inodes. By default, this would be half the number of data blocks 
available on the file system. The problem is that when all inodes 
are used, you cannot create new files, even if you still have lots 
of blocks available. If you know beforehand that you are going to 
work with many small files, or many large files, it may be useful to 
change the number of inodes by using this option. Be aware that it 
is not possible to change the number of inodes once the file system 
has been created. Note that Ext2/Ext3 is not capable of allocating 
new inodes dynamically. If this capability is important to you, use 
XFS instead, because it will automatically create new inodes as 
needed. 
)K`en[ej`at 
 Use this feature to create a directory index on Ext3 file systems. 
This enables indexing and therefore makes your file system a lot 
more scalable. 
)O 
 This is a remarkable option that lets you write superblock and 
group descriptors only. Use this option if all of the superblocks and 
backup superblocks are corrupted and you want to recover the file 
system anyway. This option does not touch the inode table or the 
inode and block bitmaps, so it will recover your file system in some 
cases. You might make the situation worse, however, so only use 
this option as a last resort.
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
119
Mounting Ext2/Ext3
To activate a file system, you have to mount it. While mounting it, you can use specific 
mount options to determine how the file system must be activated.  Table 5-2 lists and 
describes the most useful Ext2/Ext3 mount options.
 Table 5-2. Most Useful Ext2/Ext3 Mount Options
Option 
Description
_da_g9jkja 
 Ext2/Ext3 is checked automatically from time to 
time. If you want to prevent your file system from 
being checked at any time (which may take a long 
time to complete), use this option.
o^9oqlan^hk_g 
 Use this option to specify the superblock that you 
want to use when mounting the Ext2/Ext3 file sys-
tem. By default, an Ext2/Ext3 file system creates 
some backup superblocks. Use `qil.bo to find 
out where they are. In most cases, you will have 
a backup superblock on block 32768. To use this 
superblock, you need to specify it as a 1 KB block 
unit. Because the file system by default uses 4 KB 
blocks in almost all cases, you should multiply 
the number 32768 by 4. So, to mount it, use ikqjp
o^9-/-,3.+`ar+okiapdejc+okiasdana.
jkhk]` 
 This option tells an Ext3 file system not to load the 
journal when mounting.
`]p]9fkqnj]h, `]p]9kn`ana`, `]p]9snepa^]_g 
 Use this option to specify what kind of journal-
ing you want to use. The different options were 
discussed in the “Journaling” section earlier in 
this chapter.
_kiiep9j 
 This option is used to synchronize data and meta-
data every n seconds. The default value is 5; use 0 
to disable automatic sync completely.
Analyzing and Repairing Ext2/Ext3
If you happen to encounter problems on your Ext2/Ext3 file system, the file system offers 
some commands that can help you to analyze and repair the file system, as described in 
this section. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
120
e2fsck 
a.bo_g is a file system check utility that works on both Ext2 and Ext3. If you think some-
thing might be wrong with your file system, run a.bo_g. You should make sure, though, 
that the file system on which you run it is not currently mounted. Because this is hard 
to accomplish if you want to run it on your root file system, it is not a bad idea to use the 
automatic check that occurs every once in a while when mounting an Ext2/Ext3 file sys-
tem. This check is on by default, so don’t switch it off.
When you run a.bo_g on an Ext3 file system, the utility will check the journal and 
repair any inconsistencies. Only if the superblock indicates that there is a problem with 
the file system will the utility check data as well. On Ext2, a.bo_g will always check data, 
because this is the only option. Normally, a.bo_g will automatically repair all errors it 
finds, unless an error requires human intervention, in which case a.bo_g will notify you so 
that you can use one of the advanced options by hand.  Table 5-3 provides an overview of 
the most useful options that a.bo_g has to offer.
 Table 5-3. Most Useful e2fsck Options
Option 
Description
)^oqlan^hk_g 
 Use this option to read one of the backup superblocks. Unlike when using 
the ikqjp command, you can refer to the normal block position where the 
file system can find the backup superblock, which is block 32768 in most 
cases.
)_ 
 This option lets a.bo_g check for bad blocks. If it finds them, it will write 
them to a specific inode reserved for this purpose. In the future, the file 
system will avoid using any of these blocks. Be aware, though, that bad 
blocks are often an indication of real problems on your hard drive. Use the 
)_ option with a.bo_g as a temporary solution until you can replace your 
hard drive. 
)b 
 Use this option to force checking, even if the file system seems to be with-
out problems. 
)fatpanj]h[fkqnj]h 
 Use this option to specify where the external journal can be found. You’ll 
need this option if your file system uses an external journal. 
)l 
 This option tells bo_g to automatically repair everything that can be re-
paired without human intervention.
)u 
 This option assumes an answer of yes to all questions. This goes further 
than default )l behavior and will also automatically enter yes to questions 
that normally require human intervention.
dumpe2fs and tune2fs 
In some situations, a.bo_g may not do its work properly. In such cases, two useful utilities 
to analyze a little bit further what is happening are `qila.bo and pqja.bo. `qila.bo dumps 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
121
the contents of the superblock and the information about all block group descriptors (see 
 Listing 5-5). On large file systems, a.bo_g will give you huge amounts of output. If you just 
want to see information from the superblock, use it with the )d option, which makes it 
more readable.
 Listing 5-5. dumpe2fs Shows the Contents of the Superblock and All Group Descriptors
Behaouopairkhqiaj]ia68jkja:
H]opikqjpa`kj68jkp]r]eh]^ha:
BehaouopaiQQE@6/^]^b`/1)`a/2)0_4-)5b^5)-]544`1045.3
Behaouopaii]ce_jqi^an6,tAB1/
Behaouopainareoekj6-$`uj]ie_%
Behaouopaiba]pqnao6behapulaol]noa[oqlan
@ab]qhpikqjpklpekjo6$jkja%
Behaouopaiop]pa6jkp_ha]j
Annkno^ad]rekn6?kjpejqa
BehaouopaiKOpula6Hejqt
Ejk`a_kqjp605,12,
>hk_g_kqjp65355//
Naoanra`^hk_g_kqjp604552
Bnaa^hk_go645433/
Bnaaejk`ao605,1.5
Benop^hk_g6-
>hk_goeva6-,.0
Bn]ciajpoeva6-,.0
>hk_golancnkql64-5.
Bn]ciajpolancnkql64-5.
Ejk`aolancnkql60,44
Ejk`a^hk_golancnkql61--
H]opikqjppeia6PqaFqh4,.6146//.,,4
H]opsnepapeia6PqaFqh4,.6146//.,,4
Ikqjp_kqjp6-
I]teiqiikqjp_kqjp6/,
H]op_da_ga`6PqaFqh4,.6146-2.,,4
?da_gejpanr]h6,$8jkja:%
Naoanra`^hk_goqe`6,$qoannkkp%
Naoanra`^hk_goce`6,$cnkqlnkkp%
Benopejk`a6--
Ejk`aoeva6-.4
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
122
Cnkql,6$>hk_go-)4-5.%
Lnei]nuoqlan^hk_g]p-(Cnkql`ao_nelpkno]p.)1
>hk_g^epi]l]p2$'1%(Ejk`a^epi]l]p3$'2%
Ejk`ap]^ha]p4)1-4$'3%
.,.5bnaa^hk_go(0,3,bnaaejk`ao(.`ena_pkneao
Bnaa^hk_go61/.).12,
Bnaaejk`ao6-3(.,)0,44
Cnkql-6$>hk_go4-5/)-2/40%
>]_gqloqlan^hk_g]p4-5/(Cnkql`ao_nelpkno]p4-50)4-53
>hk_g^epi]l]p4-54$'1%(Ejk`a^epi]l]p4-55$'2%
Ejk`ap]^ha]p4.,,)43-,$'3%
.,51bnaa^hk_go(0,44bnaaejk`ao(,`ena_pkneao
Bnaa^hk_go6-0.5,)-2/40
Bnaaejk`ao60,45)4-32
Cnkql.6$>hk_go-2/41).0132%
>hk_g^epi]l]p-2/41$',%(Ejk`a^epi]l]p-2/42$'-%
Ejk`ap]^ha]p-2/5.)-25,.$'3%
1305bnaa^hk_go(0,44bnaaejk`ao(,`ena_pkneao
Bnaa^hk_go6-2/43)-2/5-(-25,/)..202
Bnaaejk`ao64-33)-..20
If you see a parameter that you don’t like when using `qila.bo, you can use pqja.bo 
to change it. Basically, pqja.bo works on the same options as igbo*atp/, so you won’t have 
a hard time understanding its options. Consult the man page for more details on pqja.bo. 
debugfs 
If you really are ready for a deep dive into your file system, `a^qcbo is the utility you need. 
Make sure that you use it on an unmounted file system only. The `a^qcbo tool works at 
a very deep level and may severely interfere with other processes that try to access files 
while you are debugging them. So, if necessary, take your live CD and use `a^qcbo from 
there. 
After starting `a^qcbo, you’ll find yourself in the `a^qcbo interface, which offers some 
specific commands. You will also recognize some generic Linux commands that you 
know from a bash environment, but, as you will find out, they work a bit differently in 
a `a^qcbo environment. For example, the ho command in `a^qcbo shows you not only file 
names, but also the number of blocks in use by this item and the inode of this item, which 
is very useful information if you really need to start troubleshooting (see  Listing 5-6).
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
123
 Listing 5-6. The ls Command in debugfs Works Differently
nkkp<iah6+`a^qcbo+`ar+ouopai+nkkp
`a^qcbo-*0,*4$-/)I]n).,,4%
`a^qcbo6ho
.$-.%*.$-.%**--$.,%hkop'bkqj`2-/14,5$-.%r]n
0.,.053$-.%^kkp1,510.1$-.%onr//143/$-.%ap_
.5.0101$-2%ia`e].0133$-2%_`nki.0134$.,%ejepn`*eic
14,4-.5$-.%he^-,3/-1/$-.%qon-0-3.-3$-.%^ej
142103/$-.%`ar-522,4-$-.%dkia-13.421$-.%ijp
2-24133$-.%lnk_2,42213$-.%nkkp..33/33$-.%o^ej
0503525$-.%pil/2,005$-.%ouo1142501$-.%klp
-/,.1.5$-2%ejepn`.0135$-2%rihejqv04,43,1$-2%pbpl^kkp
.505-.-$.,%_hkjavehh]-341413$-.%eoko
.014,$/2%ejepn`*eic).*2*.0)-2)oanran.014-$/25.%//143/
$AJ@%
In case you are wondering how this information may be useful to you, imagine a situ-
ation where you can’t access one of the directories in the root file system anymore. This 
information gives you the inode that contains the administrative data on the item. Next, 
you can dump the inode from the `a^qcbo interface to a normal file. For instance, the 
command `qil8.014,:+.014, would create a file with the name .014, in the root of your 
file system and fill that with the contents of inode 24580. That allows you to access the 
data that file occupies again and may help in troubleshooting.
This information may also help when recovering deleted files. Imagine that a user 
tells you that he has created three files, +dkia+qoan+beha-, +dkia+qoan+beha., and +dkia+
qoan+beha/, but has accidentally deleted beha. and desperately needs to get it back. The 
first thing you can do is use the ho`ah command from the `a^qcbo interface. Chances are 
it will give you a list of deleted inodes, including their original size and deletion time. 
 Listing 5-7 shows an example. 
 Listing 5-7. The lsdel Command in debugfs Gives You an Overview of Deleted Files
nkkp<iah6+`a^qcbo+`ar+o`]-
`a^qcbo-*0,*4$-/)I]n).,,4%
`a^qcbo6ho`ah
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
124
Ejk`aKsjanIk`aOeva>hk_goPeia`ahapa`
.//,.5,-,,200-2/40-3+-3OqjFqh2--6.3605.,,4
.//,/,,-,,200-2/40-3+-3OqjFqh2-160-6,-.,,4
-3,-,,2004-0-+-PqaFqh4,26//601.,,4
/`ahapa`ejk`aobkqj`*
$AJ@%
As  Listing 5-7 demonstrates, in the information that ho`ah gives you, you can see the 
inode number, original owner, size in blocks, and, most important, the time the file was 
deleted. Based on that information, it’s easy to recover the original file. If it was the file 
in inode 233030, from the `a^qcbo interface, use `qil8.//,/,:+knecej]hbeha to recover 
it. Unfortunately, due to some differences between Ext2 and Ext3, ho`ah works well on 
Ext2 but rarely works well on Ext3. In that case, you have to use some more advanced 
techniques.
Given the fact that the user in our example has created some files, it may be interest-
ing to see what inodes were used. Let’s say beha- still uses inode 123, beha. uses 127, and 
beha/ is removed, so you can’t find that information anymore. Chances are, however, 
that the inode that beha/ has used was not too far away from inode 127, so you can try 
to dump all inodes between inode 128 and 140. Chances are that this will allow you to 
recover the original file, thanks to `qila.bo.
There are many other commands available from `a^qcbo as well. The dahl command 
from within the `a^qcbo interface will give you a complete list. I recommend that you 
check out these commands and try to get an impression of the possibilities they offer, 
because you may need to use them some day. 
Tuning XFS
The best feature of XFS is its scalability. The file system is completely 64 bits, which allows 
for use of file systems with sizes up to 9 exabytes (that is, 9 million terabytes). It is orga-
nized in a  well- structured way that makes it a very fast file system. In an XFS file system, 
three different sections can be used for data storage. Most important of these is the data 
section. This is the only section that is created by default. The other two sections are the 
log section and the  real- time section.
Organization of the XFS File System
The data section contains data blocks, and file system metadata (the administrative data) 
as well. Like Ext3, XFS uses different allocation groups. These block groups are created 
automatically when using igbo*tbo, and sizes are calculated based on the size of the file 
system. Using these block groups is good for performance, because working with several 
block groups allows the file system to perform actions in parallel. 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
125
One of the most important parameters when creating an XFS file system is the 
number of allocation groups created. The default value performs well, but for better per-
formance, it is a good idea to increase the number of block allocation groups. This is what 
you should do if the file system is very write intensive and sufficient memory is available. 
If the server in question doesn’t have much available memory, using too many block 
groups is bad for performance. Also, when using a large number of block groups, you 
should make sure that there is enough available disk space in the file system at all times. 
When the file system is almost full, the file system will allocate lots of CPU cycles to han-
dle all the simultaneous requests from the different block allocation groups. Fortunately, 
you can always use the tbo[cnksbo command to grow an XFS file system if necessary.
The log section is used as a file system journal. Changes in file system metadata are 
stored in it until the file system has time to commit these changes to the data section. 
When the file system crashes, upon mount, the file system can read incomplete transac-
tions from this log section and recover the file system in a fast way. In the default setting, 
the log section is included in the data section. For better performance, you can choose to 
put it outside of the data section, which allows you to put it on another medium as well. 
The  real- time section is a unique property of the XFS file system. This section is used 
by files that have to be written to disk as fast as possible—in real time. To mark a file as 
a  real- time file, use the tbo_ph function. This function is not available as a  command- line 
utility; instead, you have to implement it in the tools that you are writing to handle data 
on the XFS file system. If a file is real time, it will never be stored in memory buffers 
before writing it to disk, but rather will be written without further delay. This is an excel-
lent way of preventing file system corruption. 
Setting XFS Properties
To set properties for the XFS file system, you need to specify them when creating the file 
system. Creating an XFS file system with default settings is not too hard; the following 
command, for instance, is used to format +`ar+o`]- as an XFS file system:
igbo*tbo+`ar+o`]-
This command would format the file system as XFS with an internal log section, 
without a  real- time section. If you would like to put the log section on a different device, 
which leads to better performance, use the following:
igbo*tboÌhhkc`ar9+`ar+o`^-(oeva9-,,,,^+`ar+o`]-
With this command, a  10,000- block log section is created on +`ar+o`^-. 
An important setting when creating the XFS file system is the number of allocation 
groups that you want to create. Depending on the file system size that you are using, the 
number of allocation groups is set automatically; use the tbo[ejbk command to find out 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
126
the number of allocation groups set on your file system.  Listing 5-8 shows the ]c_kqjp 
(number of allocation groups) parameter, which is set to 16, and the ]coeva (size per allo-
cation group), which is set to 1,638,400 blocks. 
 Listing 5-8. Showing XFS File System Information with xfs_info
nkkp<iah6ztbo[ejbk+onr
iap])`]p]9+`ar+i]llan+ouopai)onreoeva9.12]c_kqjp9-2(]coeva9-2/40,,^hgo
9oa_pov91-.]ppn9,
`]p]9^oeva90,52^hk_go9.2.-00,,(ei]tl_p9.1
9oqjep9,ose`pd9,^hgo(qjsneppaj9-
j]iejc9ranoekj.^oeva90,52
hkc9ejpanj]h^oeva90,52^hk_go9-.4,,(ranoekj9-
9oa_pov91-.oqjep9,^hgo(h]vu)_kqjp9,
na]hpeia9jkjaatpov90,52^hk_go9,(npatpajpo9,
To increase performance for this file system, you can change the number of alloca-
tion groups to 32, for example. You would do this by using the ]c_kqjp9/. option when 
creating the file system. The complete command to do this for a file system that you want 
to create on +`ar+o`]- is
igbo*tboÌbÌ`]c_kqjp9/.
You do not need to calculate the size of the allocation groups, because that will be 
calculated automatically. In the preceding command, you can see that the option Ìb is 
used, which is required in certain cases; igbo*tbo will not write to the device if it suspects 
that a file system already exists on that device. So, if you want to  re- create an XFS file sys-
tem, make sure that you use the option Ìb. 
Managing the XFS File System
Before storing files on your XFS file system, you need to mount it. XFS has some specific 
mount options. Among the most important option is ]hhk_oeva, which specifies how 
much data to allocate for each file that you want to write. By using this parameter, you 
can avoid fragmentation and thus get better performance out of the file system. The 
default value of 64 KB does well for average workloads, but if you are putting large files on 
the file system, it may make sense to increase the ]hhk_oeva parameter considerably. For 
instance, a 512 MB ]hhk_oeva is good for multimedia solutions, such as Internet broad-
casting. Valid values reach from 4 KB to 1 GB, with power of 2 increments. Use this mount 
option at all times, because it will make your XFS file system perform much better.
The second option that is wise to use when mounting the file system is a rather 
generic one that you can use for other file system as well: jk]peia makes sure that the 
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
127
access time of files is not modified every time a file is accessed. It is a good idea to use this 
parameter in  write- intensive environments, because writing a new access time to the file 
system every time a file is accessed has a high performance price. 
A third important mount option is ^]nnean. This option is important if you want to 
make sure that files are written properly to hard disk. On modern disk systems, a file is 
not written directly to the hard drive, but to a write cache instead. When the file has been 
written to these  in- memory buffers, the file system is informed that the file has been writ-
ten, whereas in fact it hasn’t been. If at that moment the server crashes, the modifications 
to the file will get lost. When using the ^]nnean option, you can force the file system to 
write modifications to  on- disk write buffers, instead of to  in- memory write buffers, thus 
ensuring that the file really is written to disk. There’s only one condition: your disk must 
have a cache that can be used for writing files, but that is the case on almost all modern 
hard drives. 
Once mounted, you will see that many file system utilities have an XFS alternative. 
For instance, if you use i]jÌgtbo to search the man pages for all commands that relate 
to XFS, you’ll see that numerous commands are available. The function of some com-
mands is not too hard to figure out. For example, if you have worked with bo_g, you will 
have no problem using tbo[nal]en to repair the XFS file system. And if you have resized 
a file system before, you’ll find that it’s not too hard to resize an XFS file system using 
tbo[cnksbo. XFS has some very specific utilities as well, the most significant of which are 
described next:
 s  tbonp_l: As previously discussed, when creating an XFS file system, you can spec-
ify that a  real- time section be created as well. Files that are written to this section 
are written there without using the disk cache mechanism, which helps you to pre-
vent file system corruption. If you want, you can copy files to that section directly, 
using the tbo[np_l command. When using this command, you can even specify 
that a fixed extend size must be used. For the rest, tbo[np_l works like an ordinary 
file copy command. 
 s  tbo`qil: You have probably worked with p]n to create backups before. When using 
XFS, the tbo`qil command is the most appropriate way of creating backups. The 
most important difference is that tbo`qil will back up all XFS attributes as well, 
whereas this is not the case for other backup utilities like p]n, which don’t under-
stand XFS metadata. Using tbo`qil is not too hard; it backs up files and all their 
attributes to a storage media, a regular file, or standard output. Once backed up 
there, you can restore files using the tbonaopkna command. For example, use the 
following command to dump your complete root file system to tape:
tbo`qilÌrpn]_aÌb+`ar+p]la+
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
128
 
 If you are familiar with using p]n, you’ll notice the similarities between the two 
commands. As mentioned, if you want to make sure that all  XFS- specific attributes 
are backed up as well, use tbo`qil.
 s  tbo[bnaava: For other file systems, it is rather uncommon to freeze access to the 
file system, as you can do with the tbo[bnaava command. Freezing access to a file 
system is useful if you want to make a snapshot using your volume manager, 
because it makes sure that nothing is written to the file system for a given time. To 
“unfreeze” the file system later, use tbo[bnaava again, which switches on access to 
the file system again. 
What About ReiserFS?
There was a moment in time when ReiserFS was a stable and very fast file system. This 
file system works particularly well if your server uses applications that work with numer-
ous small files. Unfortunately, ReiserFS is not very stable (and its future is uncertain, as 
noted earlier), so you should avoid using it. In case you can’t avoid using it, this section 
discusses some ways to make it perform better. 
First, ReiserFS can benefit from using an external journal, especially if journal mode 
is set to `]p]9fkqnj]h. To create a ReiserFS file system that uses an external journal, use 
ignaeoanbo:
ignaeoanbo)f+`ar+o`]-+`ar+o`^-
Some  ReiserFS- specific options can be enabled when mounting it. The most impor-
tant option is jkp]eh. By default, ReiserFS stores small files and parts at the end of a file 
directly in its index tree. This makes the file system faster, but also more prone to error. 
Storing parts of the end of a file directly in the tree may be useful, because it prevents 
a small piece at the end of a file from using a complete disk block. If you don’t want this 
to happen, use the jkp]eh option. This is an important mount option, because it will make 
the file system more stable. 
ReiserFS is notorious for being difficult to fix when it encounters problems. If you can 
no longer mount a particular ReiserFS file system, you need to use bo_g*naeoanbo. This 
program offers powerful options to check and repair a ReiserFS file system.  Table 5-4 lists 
and describes its most useful options.
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
129
 Table 5-4. Most Useful fsck.reiserfs Options
Option 
Description
))_da_g 
 This is the default option. It will check the file system, but it won’t repair errors if 
they are found. 
))bet)bet]^ha 
 Use this option if the ))_da_g option has found an error that it says can be 
repaired using ))bet)bet]^le. It will help in some situations, but doesn’t fix the 
most serious errors. 
))na^qeh`)pnaa 
 This option will rebuild the complete tree on which ReiserFS is based. Only use 
it if ))_da_g tells you that you have to; it is better to avoid it if you can. This op-
tion can take a long time to complete, and success is not guaranteed. Therefore, 
make sure that you have a backup copy of the volume on which you are using 
this option before you start to use it. 
))uao 
 Use this option to automatically confirm all questions that the program will ask 
you. 
ReiserFS also has a debug utility, `a^qcnaeoanbo. You can use it to check current set-
tings of your ReiserFS file system.  Listing 5-9 gives you an example of its output.
 Listing 5-9. debugreiserfs Gives an Overview of Options Your ReiserFS File System Is Using
nkkp<iah6+`a^qcnaeoanbo+`ar+ouopai+r]n
`a^qcnaeoanbo/*2*-5$.,,/sss*j]iaouo*_ki%
Behaouopaiop]pa6_kjoeopaj_ueojkp_da_ga`]bpanh]opikqjpejc
Naeoanbooqlan^hk_gej^hk_g-2kj,tba,.kbbkni]p/*2sepdop]j`]n`fkqnj]h
?kqjpkb^hk_gokjpda`are_a6.2.-00,,
Jqi^ankb^epi]lo64,,
>hk_goeva60,52
Bnaa^hk_go$_kqjpkb^hk_go)qoa`Wfkqnj]h(^epi]lo(`]p](naoanra`Y±
^hk_go%6..5251,,
Nkkp^hk_g6/.442
BehaouopaieoJKP_ha]j
Pnaadaecdp60
D]odbqj_pekjqoa`pkoknpj]iao6n1
K^fa_pe`i]loeva0(i]t53.
www.it-ebooks.info

CHAPTER 5 N   ADVANCED FILE SYSTEM MANAGEMENT
130
Fkqnj]hl]n]iapano6
@are_aW,t,Y
I]ce_W,t1_a]^1-5Y
Oeva4-5/^hk_go$ej_hq`ejc-bknfkqnj]hda]`an%$benop^hk_g-4%
I]tpn]jo]_pekjhajcpd-,.0^hk_go
I]t^]p_doeva5,,^hk_go
I]t_kiiep]ca/,
>hk_gonaoanra`^ufkqnj]h6,
Boop]pabeah`6,t,6
o^[ranoekj6.
ejk`acajan]pekjjqi^an6035--
QQE@64_]12^/1)abb-)0,,-)4^b`)bb]_,-,5-`-^
H=>AH6
Oapbh]coejO>6
=PPNE>QPAO?HA=J
In case `a^qcnaeoanbo shows you an option that you don’t like, you can change it for 
the existing file system by using naeoanbopqja. This command uses the same options as 
igbo*naeoanbo; see its man page for more details about these options.
Summary
In this chapter you have learned about file system management. You now know how to 
tune your file system for optimal performance. You have also learned about some utilities 
that you can use to fix a file system that is broken. In the next chapter you’ll learn how to 
use Nagios to monitor your Ubuntu Servers from a distance. 
www.it-ebooks.info

131
C H A P T E R  6
Network Monitoring
Knowing When It Goes Wrong 
Without Watching It
As an administrator, it is your responsibility to know when things are about to go 
wrong. You can, of course, go sit by your server all day and figure out if everything is going 
all right, but you probably have better things to do. Nagios offers services to monitor the 
network for you. In this chapter you’ll learn how to install and use Nagios. 
Starting with Nagios
Nagios is a  network- wide monitoring tool. In this chapter you’ll learn how to set it up 
on your servers. Once it is set up, you can watch the status of servers in your network via 
a web browser. Don’t want to watch a web browser all time? That’s fine, because you can 
configure Nagios to send relevant security alerts to some specified users on the network if 
something goes wrong. Nagios allows you to monitor local server events, such as running 
out of disk space, as network events. 
Before you install Nagios, make sure that you have a web server configured (you can 
read more about configuring Apache Web Server in Chapter 11 of my book Beginning 
Ubuntu Server Administration, from Apress) and running. Nagios uses a web interface to 
show its information, so you can’t do without that. Once you have confirmed it is up and 
running, install the j]ceko packages:
]lp)capejop]hhj]ceko.j]ceko)lhqcejoj]ceko)ei]cao
This command installs about 40 MB of data on your server. Once that is done, you 
have to complete the installation by setting up authentication. Nagios uses the file 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
132
+ap_+j]ceko.+dpl]oos`*qoano, but this file is not created automatically. The following 
command creates it for you, puts a user with the name j]ceko]`iej in it, and prompts for 
a password:
dpl]oos`)_+ap_+j]ceko.+dpl]oos`*qoanoj]ceko]`iej
There are two configuration files related to user authentication. First, +ap_+
j]ceko.+]l]_da.*_kjb contains all settings that allow Nagios to communicate with 
Apache.  Listing 6-1 shows its contents.
 Listing 6-1. /etc/nagios2/apache2.conf Sets Up Communication Between Nagios and Apache
nkkp<iah6+ap_+j]ceko._]p]l]_da.*_kjb
O_nelp=he]o+_ce)^ej+j]ceko.+qon+he^+_ce)^ej+j]ceko.
O_nelp=he]o+j]ceko.+_ce)^ej+qon+he^+_ce)^ej+j]ceko.
=he]o+j]ceko.+opuhaodaapo+ap_+j]ceko.+opuhaodaapo
=he]o+j]ceko.+qon+od]na+j]ceko.+dp`k_o
8@ena_pknuI]p_d$+qon+od]na+j]ceko.+dp`k_ox+qon+he^+_ce)^ej+j]ceko.%:
KlpekjoBkhhksOuiHejgo
@ena_pknuEj`atej`at*dpih
=hhksKranne`a=qpd?kjbec
Kn`an=hhks(@aju
=hhksBnki=hh
=qpdJ]iaJ]ceko=__aoo
=qpdPula>]oe_
=qpdQoanBeha+ap_+j]ceko.+dpl]oos`*qoano
namqenar]he`)qoan
8+@ena_pknuI]p_d:
As you can see, the ]l]_da.*_kjb file contains the authentication settings and some 
basic paths that Nagios has to use. The other relevant configuration file is +ap_+j]ceko.+
_ce*_bc, which contains the name of the admin user that is used for different purposes, as 
well as other settings that are related to the CGI scripts that Nagios uses. The interesting 
part of this script is that you can change admin names in it. By default, j]ceko]`iej is the 
only user who has administrative permissions to perform different tasks. If, for instance, 
you want to use another user account for hosts and  services- related commands, change it 
in the _ce*_bc file.  Listing 6-2 shows its contents.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
133
NNote For better readability, I have removed all comment lines. Consult the configuration file on disk to 
see the comment lines as well. 
 Listing 6-2. cgi.cfg Contains the Authorizations of the admin User
j]ceko[_da_g[_kii]j`9+qon+he^+j]ceko+lhqcejo+_da_g[j]cekoX
+r]n+_]_da+j]ceko.+op]pqo*`]p1#+qon+o^ej+j]ceko.#
qoa[]qpdajpe_]pekj9-
]qpdkneva`[bkn[ouopai[ejbkni]pekj9j]ceko]`iej
]qpdkneva`[bkn[_kjbecqn]pekj[ejbkni]pekj9j]ceko]`iej
]qpdkneva`[bkn[ouopai[_kii]j`o9j]ceko]`iej
]qpdkneva`[bkn[]hh[oanre_ao9j]ceko]`iej
]qpdkneva`[bkn[]hh[dkopo9j]ceko]`iej
]qpdkneva`[bkn[]hh[oanre_a[_kii]j`o9j]ceko]`iej
]qpdkneva`[bkn[]hh[dkop[_kii]j`o9j]ceko]`iej
`ab]qhp[op]pqoi]l[h]ukqp91
`ab]qhp[op]pqosnh[h]ukqp90
lejc[oujp]t9+^ej+lejc)j)Q)_1 DKOP=@@NAOO 
nabnaod[n]pa95,
At this point, you have a very basic Nagios server up and running. Before you start 
to configure it, you need to find out if it works properly. From a workstation, start your 
browser and connect to the following URL:
dppl6++ukqn[j]ceko[oanran+j]ceko.
This should give you a login prompt at which you can enter the name and password 
of the admin user you have just created. After entering these, you should see the Nagios 
web interface, as shown in  Figure 6-1. Don’t bother clicking around in it, because you 
haven’t set up anything yet. Therefore, you won’t see much for the moment. Read the fol-
lowing sections to find out how to configure Nagios.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
134
 Figure 6-1. After installing Nagios, connect to it to see if it works.
NNote The Nagios web interface gives access to some documentation that is installed on your server as 
well. You can use this documentation, but be aware that the paths on Ubuntu Server are different from the 
pathnames referred to in the documentation.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
135
Configuring Nagios
Nagios uses lots of configuration files. The most difficult part of managing Nagios is to 
find the right configuration file for a specific purpose. To make it even more difficult, 
Nagios distinguishes between core configuration files and  plug- in configuration files, 
 add- on files that can be used as an extension to the default functionality of Nagios. 
Location of the Configuration Files
When you first start working with Nagios, it looks like configuration files are located just 
about everywhere! To help you pinpoint the locations of these files, the following list 
identifies the most common directories in which Nagios stores information:
 s  +ap_+j]ceko.: This is the master configuration directory. It contains the most 
important configuration files, among which you will find the j]ceko*_bc config-
uration file.
 s  +qon+he^+j]ceko+lhqcejo: As mentioned, Nagios works with  plug- ins. Every  plug- in 
allows you to monitor an additional service. For example, Nagios by itself doesn’t 
know how to monitor Oracle. If, however, the Oracle  plug- in has been installed in 
this directory (which is the case after a default installation), the  plug- in can man-
age Oracle.
 s  +ap_+j]ceko.+_kjb*`: This directory contains some of the most important Nag-
ios configuration files. If the file you are looking for is not in here, also check 
+ap_+j]ceko)lhqcejo+_kjbig.
 s  +ap_+j]ceko)lhqcejo+_kjbec: This directory contains the configuration files for the 
 plug- ins that are installed on your server.
 s  +r]n+he^+j]ceko.: Nagios writes its output to this directory. When Nagios has been 
up and running for some time, you’ll find *kqp files in this directory. These files 
contain the information that is used by the Nagios web interface. 
 s  +r]n+hkc+j]ceko.: This is the directory where Nagios writes its log files. Use it if 
anything goes wrong with your Nagios environment. 
Before diving deep into the different configuration files, you should also be aware 
of the +ap_+j]ceko.+_kii]j`o*_bc file. To do its work, Nagios uses its own command set. 
The _kii]j`o*_bc file defines the most important commands.  Listing 6-3 gives a partial 
example.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
136
 Listing 6-3. /etc/nagios2/commands.cfg Defines the Most Common Nagios Commands
nkkp<iah6+ap_+j]ceko._]p_kii]j`o*_bc
#lnk_aoo)dkop)lanb`]p]#_kii]j``abejepekj
`abeja_kii]j`w
_kii]j`[j]ialnk_aoo)dkop)lanb`]p]
_kii]j`[heja+qon+^ej+lnejpb!^ H=OPDKOP?DA?G Xp DKOPJ=IA ±
Xp DKOPOP=PA Xp
 DKOP=PPAILP Xp DKOPOP=PAPULA Xp±
 DKOPATA?QPEKJPEIA Xp DKOPKQPLQP Xp DKOPLANB@=P= Xj::±
+r]n+he^+j]ceko.+dkop)lanb`]p]*kqp
y
#lnk_aoo)oanre_a)lanb`]p]#_kii]j``abejepekj
`abeja_kii]j`w
_kii]j`[j]ialnk_aoo)oanre_a)lanb`]p]
_kii]j`[heja+qon+^ej+lnejpb!^ H=OPOANRE?A?DA?G Xp DKOPJ=IA ±
Xp OANRE?A@AO? Xp
 OANRE?AOP=PA Xp OANRE?A=PPAILP Xp±
 OANRE?AOP=PAPULA Xp OANRE?AATA?QPEKJPEIA Xp OANRE?AH=PAJ?U ±
Xp OANRE?AKQPLQP Xp OANRE?ALANB@=P= Xj::+r]n+he^+j]ceko.+oanre_a)lanb`]p]*kqp
y
Nagios commands are well structured. If you feel you are missing any functionality in 
the default Nagios command set, you can create your own Nagios commands as well. The 
_kii]j`o*_bc file contains some hints on how to do that.
The Master Configuration File: nagios.cfg
The master configuration file that Nagios uses is +ap_+j]ceko.+j]ceko*_bc. This file 
determines where Nagios should read and write specific information. By using _bc[beha 
statements, it also tells Nagios what additional configuration files to read. For example, 
these statements can refer to configuration files for specific modules that you want to 
use. By default, all of these configuration files are disabled, which means that Nagios 
basically monitors nothing. Of course, it makes sense to enable them, but only after you 
have modified the configuration file according to your needs.  Listing 6-4 shows the part 
of j]ceko*_bc that indicates what configuration files to use. Be aware, though, that these 
are only example files, and in some cases refer to files that don’t even exist at the location 
that is indicated.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
137
 Listing 6-4. From nagios.cfg, Additional Configuration Files Are Included
?kii]j``abejepekjo
_bc[beha9+ap_+j]ceko.+_kii]j`o*_bc
Pdaoakpdanat]ilhao]nap]gajbnkiqlopna]i#oo]ilha_kjbecqn]pekj
behao*
Ukq_]jolhepkpdanpulaokbk^fa_p`abejepekjo]_nkoooaran]h
_kjbecbehaoebukqseod$]o`kjadana%(kngaalpdai]hhej]
oejcha_kjbecbeha*
_bc[beha9+ap_+j]ceko.+_kjp]_pcnkqlo*_bc
_bc[beha9+ap_+j]ceko.+_kjp]_po*_bc
_bc[beha9+ap_+j]ceko.+`alaj`aj_eao*_bc
_bc[beha9+ap_+j]ceko.+ao_]h]pekjo*_bc
_bc[beha9+ap_+j]ceko.+dkopcnkqlo*_bc
_bc[beha9+ap_+j]ceko.+dkopo*_bc
_bc[beha9+ap_+j]ceko.+oanre_ao*_bc
_bc[beha9+ap_+j]ceko.+peialanek`o*_bc
Atpaj`a`dkop+oanre_aejbk`abejepekjo]najksopkna`]hkjcsepd
kpdank^fa_p`abejepekjo6
_bc[beha9+ap_+j]ceko.+dkopatpejbk*_bc
_bc[beha9+ap_+j]ceko.+oanre_aatpejbk*_bc
Ukq_]j]hokpahhJ]cekopklnk_aoo]hh_kjbecbehao$sepd]*_bc
atpajoekj%ej]l]npe_qh]n`ena_pknu^uqoejcpda_bc[`en
`ena_pera]oodksj^ahks6
_bc[`en9+ap_+j]ceko.+oanrano
_bc[`en9+ap_+j]ceko.+lnejpano
_bc[`en9+ap_+j]ceko.+osep_dao
_bc[`en9+ap_+j]ceko.+nkqpano
As a Nagios administrator, it is also useful if you know about the other important 
lines in the j]ceko*_bc file. The following list provides an overview of the most important 
definitions it contains:
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
138
 s  hkc[beha9+r]n+hkc+j]ceko.+j]ceko*hkc: This parameter tells Nagios where to log its 
information.
 s  _bc[`en9+ap_+j]ceko.+_kjb*`: This line tells Nagios to include all configuration files 
in the specified directory.
 s  _bc[beha9+ap_+j]ceko.+_kii]j`o*_bc: This line tells Nagios to load the configura-
tion file _kii]j`o*_bc as well. Likewise, other _bc[beha lines are used to refer to 
additional configuration files that Nagios should include.
 s  op]pqo[beha9+r]n+_]_da+j]ceko.+op]pqo*`]p: This file contains current status infor-
mation about all hosts and services that are monitored. The CGI scripts from the 
Nagios web server interpret this file and display its contents in a graphical way.
 s  _da_g[atpanj]h[_kii]j`9,: This default line makes sure that no external commands 
can be executed. If you want to manage Nagios using a web server (which should 
always be the case), you need to enable this option by giving it the value 1. 
 s  hkc[nkp]pekj[iapdk`9`: This line specifies in what way the Nagios log file should be 
rotated. By default, this will happen daily. Valid values for this parameter follow:
  s  j: Don’t rotate the log
  s  d: Rotate hourly
  s  `: Rotate daily
  s  s: Rotate weekly
  s  i: Rotate monthly
 s  hkc[]n_dera[l]pd9+r]n+hkc+j]ceko.+]n_derao: If log rotation is enabled, this param-
eter describes where the archive of log files should be written to. 
Creating Essential Nagios Configuration Files
Nagios needs some minimal configuration files, and they should reside in one of the 
directories defined in the j]ceko*_bc file using the _bc[`en directive. The default location 
to put them would be +ap_+j]ceko.+_kjb*`. Make sure that you create at least the follow-
ing configuration files:
 s  _kjp]_po*_bc: This file defines which people should get a message in case of 
trouble.
 s  _kjp]_pcnkqlo*_bc: All contacts specified in _kjp]_po*_bc should be a member of at 
least one contact group. Use this file to define the contact group.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
139
 s  pailh]pao*_bc: This file defines templates that can be used by other configuration 
files.
 s  dkopo*_bc: Use this file to define the hosts that Nagios will monitor.
 s  dkopcnkqlo*_bc: In large networks, it is useful to subdivide hosts into host groups, 
such as servers, switches, routers, and so on.
 s  oanre_ao*_bc: The file defines specific services that you want to monitor for each 
host.
 s  peialanek`o*_bc: This file defines time periods used in all configuration files.
Now it is time to start the real work, which unfortunately involves a lot of typing. In 
the rest of this chapter, we will work on a small example network in which four Linux 
servers are used. Three of these are on the internal network, and one of them is on the 
Internet. Nagios can monitor other operating systems as well, but let’s try to set up 
 Linux- based host monitoring first. The following servers are monitored:
 s  -5.*-24*-*55: DHCP, NFS, web, Nagios, SSH
 s  -5.*-24*-*-,,: Samba, SSH
 s  -5.*-24*-*-,-: Web, FTP, SSH
 s  4,*25*5/*.-2: Web, SSH
Creating a Contacts File
Start with the creation of the _kjp]_po*_bc file. As specified in +ap_+j]ceko.+j]ceko*_bc, 
this file should reside in +ap_+j]ceko., so make sure to create it there.  Listing 6-5 gives an 
example of what this file may look like.
 Listing 6-5. Example contacts.cfg File
_kjp]_p`abejepekjbknhej`]
`abeja_kjp]_pw
_kjp]_p[j]iahej`]
]he]ohej`]pdkioaj
oanre_a[jkpebe_]pekj[lanek`skngdkqno
dkop[jkpebe_]pekj[lanek`skngdkqno
oanre_a[jkpebe_]pekj[klpekjo_(n
dkop[jkpebe_]pekj[klpekjo`(n
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
140
oanre_a[jkpebe_]pekj[_kii]j`ojkpebu)^u)ai]eh
dkop[jkpebe_]pekj[_kii]j`odkop)jkpebu)^u[ai]eh
ai]ehhej`]<hk_]hdkop
y
The interesting part of this configuration file is that there are quite a few 
 cross- references. That is, the _kjp]_po*_bc file depends on what you do in other 
configuration files. For instance, the lines oanre_a[jkpebe_]pekj[lanek` and 
dkop[jkpebe_]pekj[lanek` are periods that you will define later in the peialanek`o*_bc file.
In the example _kjp]_po*_bc file in  Listing 6-6, you also see that some 
oanre_a[jkpebe_]pekj[klpekjo and dkop[jkpebe_]pekj[klpekjo parameters are used. 
The following oanre_a[jkpebe_]pekj[klpekjo parameters can be used:
 s  j: Do not notify at all
 s  s: Notify on WARNING states
 s  q: Notify on UNKNOWN states
 s  _: Notify on CRITICAL states
 s  n: Notify when the service recovers and returns to OK state
Likewise, the following dkop[jkpebe_]pekj[klpekjo parameters can be used:
 s  j: Do not notify at all
 s  `: Notify on DOWN host states
 s  q: Notify if host is unreachable
 s  n: Notify when host recovers
Defining a Contacts Group
After defining the contacts file, you may want to create a contact group as well. This 
makes it easier in large implementations to address all contacts at once.  Listing 6-6 shows 
what a contact group may look like.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
141
 Listing 6-6. Example of a Contact Group
@abejepekjkb]j]`iejo_kjp]_pcnkql
`abeja_kjp]_pcnkqlw
_kjp]_pcnkql[j]ia]`iejo
]he]o]`iejeopn]pkno
iai^anonkkp(hej`]
y
Defining Hosts and Host Groups
After defining whom to contact if things go wrong, you have to define hosts and, if so 
required, hostnames. The hosts you define will inherit some of their settings from the 
host template. On Ubuntu 8.04, you’ll find this template in the file +ap_+j]ceko.+_kjb*`+
cajane_)dkopo[j]ceko.*_fg. Normally you don’t need to edit the settings in this file. You 
just need to refer to it when defining your hosts. This hosts configuration file may look 
similar to the example shown in  Listing 6-7.
 Listing 6-7. Example hosts.cfg File
`abejepekjkbQ^qjpqOanran
`abejadkopw
dkop[j]iaiah
]he]oQ^qjpqOanran
]``naoo-5.*-24*-*55
qoacajane_)dkop
_da_g[_kii]j`_da_g)dkop)]hera
i]t[_da_g[]ppailpo-,
jkpebe_]pekj[ejpanr]h-.,
jkpebe_]pekj[lanek`.0t3
jkpebe_]pekj[klpekjo`(q(n
y
@abejepekjkbcajane_O]i^]oanran
`abejadkopw
dkop[j]iaouh
]he]oO]i^]Oanran
]``naoo-5.*-24*-*-,,
qoacajane_)dkop
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
142
_da_g[_kii]j`_da_g)dkop)]hera
i]t[_da_g[]ppailpo-,
jkpebe_]pekj[ejpanr]h-.,
jkpebe_]pekj[lanek`.0t3
jkpebe_]pekj[klpekjo`(q(n
y
@abejepekjkbejpanj]hsa^oanran
`abejadkopw
dkop[j]iahej
]he]oSa^Oanran
]``naoo-5.*-24*-*-,-
qoacajane_)dkop
_da_g[_kii]j`_da_g)dkop)]hera
i]t[_da_g[]ppailpo-,
jkpebe_]pekj[ejpanr]h-.,
jkpebe_]pekj[lanek`.0t3
jkpebe_]pekj[klpekjo`(q(n
y
`abejadkopw
dkop[j]iahkn
]he]oatpanj]hsa^oanran
]``naoo4,*25*5/*.-2
qoacajane_)dkop
_da_g[_kii]j`_da_g)dkop)]hera
i]t[_da_g[]ppailpo-,
jkpebe_]pekj[ejpanr]h-.,
jkpebe_]pekj[lanek`.0t3
jkpebe_]pekj[klpekjo`(q(n
y
In the example dkopo*_bc file in  Listing 6-7, you can see that some new parameters 
are used. Of these, the nonobvious parameters are as follows:
 s  _da_g[_kii]j`: Refers to the command that Nagios uses to check if the host is up. 
In all cases, it should refer to the _da_g)dkopo)]hera command.
 s  i]t[_da_g[]ppailpo: Defines how many checks Nagios should run as a maximum. 
If a host still doesn’t reply after reaching this threshold, Nagios will consider it 
unavailable.
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
143
 s  jkpebe_]pekj[ejpanr]h: Defines, in minutes, how often you should receive a notifi-
cation if the problem still exists. Use the value 0 if you want just one notification to 
be sent after the problem is discovered.
 s  jkpebe_]pekj[lanek`: Defines during which time period notifications should be 
sent to the contacts. It is a good idea to use 24x7 here, to make sure that notifica-
tions will be sent at all times.
 s  jkpebe_]pekj[klpekjo: Defines in what situations notifications should be sent out. 
The following options are available:
  s  `: Notify if host is down
  s  q: Notify if host is unreachable
  s  n: Send notification when host recovers
  s  j: Do not send notifications
After defining hosts, you must specify the host groups that your hosts belong to. 
There are many approaches to creating host groups, and a host may be a member of 
more than one host group. Ultimately, your business needs will dictate which host 
groups to use. In the example in  Listing 6-8, you can see that three different approaches 
are used to define host groups. First, there is a host group that contains all hosts, and 
then there are functional host groups, and last there are host groups based on locations 
that are used. 
 Listing 6-8. Host Groups Make Managing Hosts Easier
=hhdkopo
`abejadkopcnkqlw
dkopcnkql[j]ia]hh
]he]o]hhdkopo
iai^ano&
y
`abejadkopcnkqlw
dkopcnkql[j]iaejpanj]h
]he]oejpanj]hdkopo
iai^anoiah(ouh(hej
y
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
144
`abejadkopcnkqlw
dkopcnkql[j]iasa^oanrano
]he]osa^oanrano
iai^anoiah(hej(hkn
y
`abejadkopcnkqlw
dkopcnkql[j]iabehaoanrano
]he]obehaoanrano
iai^anoiah(ouh
y
Defining Services to Monitor
Now that your hosts and host groups are defined, it’s time to work on the services. In 
the oanre_ao*_bc file, you define what particular services you want to monitor. Normally, 
making sure that all relevant services are defined is a lot of work. In Nagios, you can 
monitor network services as well as local services. For instance, there is a service to check 
available local disk space, or you can check based on any network protocol as well. 
Before you start to work on the oanre_ao*_bc file, you should understand what it does. 
In the services file, different services are checked. To do this, Nagios needs  plug- ins. 
You’ll find a list of all available  plug- ins in the +qon+he^+j]ceko+lhqcejo directory. I rec-
ommend that you have a look at this directory and get an idea of the possibilities that 
are offered. You can run every  plug- in from this directory as an independent executable, 
which gives you an idea of the  plug- in possibilities. Some  plug- ins just run and that’s all, 
whereas other  plug- ins can have lots of options that enable you to determine what exactly 
the  plug- in should do.  Listing 6-9 gives you an example of the help output from the 
_da_g[`eog  plug- in. Many  plug- ins have complex options like this one, so make sure that 
you are aware of the options that exist for the  plug- ins you want to use before you config-
ure the oanre_ao*_bc file.
 Listing 6-9. Nagios  Plug- ins Often Have Lots of Options to Define What You Want Them to 
Do
nkkp<iah6+qon+he^+j]ceko+lhqcejo*+_da_g[`eog))dahl
_da_g[`eogr-404$j]ceko)lhqcejo-*0*--%
?klunecdp$_%-555Apd]jC]hop]`8j]ceko<j]ceko*knc:
?klunecdp$_%-555).,,2J]cekoLhqcej@arahkliajpPa]i
8j]cekolhqc)`arah<heopo*okqn_abknca*jap:
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
145
Pdeolhqcej_da_gopda]ikqjpkbqoa``eogol]_akj]ikqjpa`behaouopai
]j`cajan]pao]j]hanpebbnaaol]_aeohaoopd]jkjakbpdapdnaodkh`r]hqao
Qo]ca6_da_g[`eog)sheiep)_heiepW)SheiepYW)GheiepYw)ll]pdx)t`are_ay
W)?YW)AYW)aYW)ccnkqlYW)gYW)hYW)IYW)iYW)Nl]pdYW)nl]pdY
W)ppeiakqpYW)qqjepYW)rYW)TpulaY
Klpekjo6
)d())dahl
Lnejp`ap]eha`dahlo_naaj
)R())ranoekj
Lnejpranoekjejbkni]pekj
)s())s]njejc9EJPACAN
AtepsepdS=NJEJCop]pqoebhaoopd]jEJPACANqjepokb`eog]nabnaa
)s())s]njejc9LAN?AJP!
AtepsepdS=NJEJCop]pqoebhaoopd]jLAN?AJPkb`eogol]_aeobnaa
)_())_nepe_]h9EJPACAN
Atepsepd?NEPE?=Hop]pqoebhaoopd]jEJPACANqjepokb`eog]nabnaa
)_())_nepe_]h9LAN?AJP!
Atepsepd?NEP?=Hop]pqoebhaoopd]jLAN?AJPkb`eogol]_aeobnaa
)S())es]njejc9LAN?AJP!
AtepsepdS=NJEJCop]pqoebhaoopd]jLAN?AJPkbejk`aol]_aeobnaa
)G())e_nepe_]h9LAN?AJP!
Atepsepd?NEPE?=Hop]pqoebhaoopd]jLAN?AJPkbejk`aol]_aeobnaa
)l())l]pd9L=PD())l]npepekj9L=NPEPEKJ
L]pdknl]npepekj$i]u^anala]pa`%
)t())at_hq`a[`are_a9L=PD8OPNEJC:
Ecjkna`are_a$kjhuskngoeb)lqjola_ebea`%
)?())_ha]n
?ha]npdnaodkh`o
)A())at]_p)i]p_d
Bknl]pdoknl]npepekjoola_ebea`sepd)l(kjhu_da_gbknat]_pl]pdo
)a())annkno)kjhu
@eolh]ukjhu`are_ao+ikqjplkejposepdannkno
)c())cnkql9J=IA
Cnkqll]pdao*Pdnaodkh`o]llhupk$bnaa)%ol]_akb]hhl]npepekjopkcapdan
)g())gehk^upao
O]ia]o#))qjepog>#
)h())hk_]h
Kjhu_da_ghk_]hbehaouopaio
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
146
)H())op]p)naikpa)bo
Kjhu_da_ghk_]hbehaouopaio]c]ejoppdnaodkh`o*Uap_]hhop]pkj±
naikpabehaouopaio
pkpaopebpdau]na]__aooe^ha$a*c*pk`apa_pOp]haJBOD]j`hao%
)I())ikqjplkejp
@eolh]updaikqjplkejpejopa]`kbpdal]npepekj
)i())iac]^upao
O]ia]o#))qjepoI>#
)=())]hh
Atlhe_ephuoaha_p]hhl]pdao*Pdeoeoamqer]hajppk)N#*&#
)N())anace)l]pd9L=PD())anace)l]npepekj9L=NPEPEKJ
?]oaejoajoeperanacqh]natlnaooekjbknl]pd+l]npepekj$i]u^anala]pa`%
)n())anac)l]pd9L=PD())anac)l]npepekj9L=NPEPEKJ
Nacqh]natlnaooekjbknl]pdknl]npepekj$i]u^anala]pa`%
)E())ecjkna)anace)l]pd9L=PD())ecjkna)anace)l]npepekj9L=NPEPEKJ
Nacqh]natlnaooekjpkecjknaoaha_pa`l]pd+l]npepekj$_]oaejoajoepera%±
$i]u^anala]pa`%
)e())ecjkna)anac)l]pd9L=PD())ecjkna)anac)l]npepekj9L=NPEPEKJ
Nacqh]natlnaooekjpkecjknaoaha_pa`l]pdknl]npepekj$i]u^anala]pa`%
)p())peiakqp9EJPACAN
Oa_kj`o^abkna_kjja_pekjpeiaokqp$`ab]qhp6-,%
)q())qjepo9OPNEJC
?dkkoa^upao(g>(I>(C>(P>$`ab]qhp6I>%
)r())ran^koa
Odks`ap]ehobkn_kii]j`)heja`a^qccejc$J]cekoi]upnqj_]pakqplqp%
)T())at_hq`a)pula9PULA
Ecjkna]hhbehaouopaiokbej`e_]pa`pula$i]u^anala]pa`%
At]ilhao6
_da_g[`eog)s-,!)_1!)l+pil)l+r]n)?)s-,,,,,)_1,,,,)l+
?da_go+pil]j`+r]n]p-,!]j`1!(]j`+]p-,,I>]j`1,I>
_da_g[`eog)s-,,I)_1,I)?)s-,,,I)_1,,I)coe`@=P=)n#Z+kn]_ha+OE@+`]p]*& #
?da_go]hhbehaouopaiojkpi]p_dejc)n]p-,,I]j`1,I*Pdaboi]p_dejc±
pda)nnacat]nacnkqla`sde_dia]jopdabnaaol]_apdnaodkh`o]na±
]llhea`pk]hh`eogopkcapdan
_da_g[`eog)s-,,I)_1,I)?)s-,,,I)_1,,I)l+bkk)?)s1!)_/!)l+^]n
?da_go+bkkbkn-,,,I+1,,I]j`+^]nbkn1+/!*=hhnai]ejejcrkhqiaoqoa-,,I+1,I
Oaj`ai]ehpkj]ceko)qoano<heopo*okqn_abknca*japebukqd]ramqaopekjo
nac]n`ejcqoakbpdeookbps]na*Pkoq^iepl]p_daoknoqccaopeilnkraiajpo(
oaj`ai]ehpkj]cekolhqc)`arah<heopo*okqn_abknca*jap
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
147
After you have familiarized yourself with the possibilities the  plug- ins have to offer, 
you can start creating the services file.  Listing 6-10 shows a very simple example of 
a services file. In this file, Nagios will monitor whether hosts are available. Next, for web 
servers, it will monitor whether the web service is still up and running. In this file, Nagios 
will monitor the availability of hosts, web services, and disk space for host hkn. 
Like the dkopo*_bc file, the oanre_ao*_bc file also uses a template containing 
some generic settings. These default settings are read from +ap_+j]ceko.+_kjb*`+
cajane_)oanre_a[j]ceko.*_fg. If you want to overwrite settings from the template file, you 
can include them in the oanre_ao*_bc file. In  Listing 6-10, you can see that that is done for 
the check on local disk usage for host hkn. Consider this not as a complete configuration 
file, but rather as a starting point to build your own configuration. 
 Listing 6-10. services.cfg Defines What Exactly You Want to Monitor
?da_gdkopcnkqlo
?da_geb]hhoanre_aonalhupklejcpaop
`abejaoanre_aw
dkopcnkql[j]ia]hh
qoacajane_)oanre_a
oanre_a[`ao_nelpekjLEJC
_da_g[_kii]j`_da_g[lejc-,,*,(.1!1,,*,(31!
jkpebe_]pekj[ejpanr]h,
y
?da_gsa^oanre_ao]r]eh]^ehepu
`abejaoanre_aw
dkopcnkql[j]iasa^oanrano
qoacajane_)oanre_a
oanre_a[`ao_nelpekjDPPL
_da_g[_kii]j`_da_g[dppl
jkpebe_]pekj[ejpanr]h,
y
?da_g]r]eh]^ha`eogol]_a
`abejaoanre_aw
dkop[j]iahkn
qoacajane_)oanre_a
oanre_a[`ao_nelpekj?da_ghk_]h`eogqo]ca
eo[rkh]peha,
_da_g[lanek`.0t3
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
148
i]t[_da_g[]ppailpo/
jkni]h[_da_g[ejpanr]1
napnu[_da_g[ejpanr]h-
_kjp]_p[cnkqlo]`iejo
jkpebe_]pekj[ejpanr]h-.,
jkpebe_]pekj[lanek`.0t3
jkpebe_]pekj[klpekjo_(n
_da_g[_kii]j`_da_g[`eog.,!-,!+
y
Working with Nagios Commands
Let’s first look at the two _da_g commands that are used in this example file:
_da_g[lejc-,,*,(.1!1,,*,(31!
_da_g[`eog.,!-,!+
It may surprise you that the commands are not used exactly as shown in the help out-
put that you see when executing the command with the ))dahl option. If you look closer, 
you will see that it does work the same way—it is just written in a different way. Look at 
the _da_g[`eog command, for example. This command, as used in the oanre_ao*_bc script, 
uses three parameters, separated by exclamation marks. If you look at the help output of 
+qon+he^+j]ceko+lhqcejo+_da_g[`eog))dalp, you see the result shown in  Listing 6-11.
 Listing 6-11. Partial Output of check_disk Usage Information
nkkp<iah6+qon+he^+j]ceko+lhqcejo*+_da_g[`eog))dahlxhaoo
_da_g[`eogr-404$j]ceko)lhqcejo-*0*--%
?klunecdp$_%-555Apd]jC]hop]`8j]ceko<j]ceko*knc:
?klunecdp$_%-555).,,2J]cekoLhqcej@arahkliajpPa]i
8j]cekolhqc)`arah<heopo*okqn_abknca*jap:
Pdeolhqcej_da_gopda]ikqjpkbqoa``eogol]_akj]ikqjpa`behaouopai
]j`cajan]pao]j]hanpebbnaaol]_aeohaoopd]jkjakbpdapdnaodkh`r]hqao
Qo]ca6_da_g[`eog)sheiep)_heiepW)SheiepYW)GheiepYw)ll]pdx)t`are_ay
W)?YW)AYW)aYW)ccnkqlYW)gYW)hYW)IYW)iYW)Nl]pdYW)nl]pdY
W)ppeiakqpYW)qqjepYW)rYW)TpulaY
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
149
Klpekjo6
)d())dahl
Lnejp`ap]eha`dahlo_naaj
)R())ranoekj
Lnejpranoekjejbkni]pekj
)s())s]njejc9EJPACAN
AtepsepdS=NJEJCop]pqoebhaoopd]jEJPACANqjepokb`eog]nabnaa
)s())s]njejc9LAN?AJP!
AtepsepdS=NJEJCop]pqoebhaoopd]jLAN?AJPkb`eogol]_aeobnaa
)_())_nepe_]h9EJPACAN
As you can see, this command has three options that are required: )sheiep, )_heiep, 
and )ll]pd or )t`are_a. )s generates a warning if less than the specified percentage of 
disk space is free, )_ generates a critical event if less than the specified percentage of disk 
space is free, and )l or )t refers to either the path or the device name that Nagios has to 
monitor for available disk space. As used in the oanre_ao*_bc file, these are exactly the 
three parameters that are used. The same applies to the ping test that is performed from 
the same script. 
Defining Time Periods
The last relevant part of a Nagios configuration is the definition of time periods. In most 
cases you probably want to see an alert no matter when the event occurs, but in some 
cases you may choose to forward alerts to specific persons when an event occurs during 
a given period of the day.  Listing 6-5, earlier in the chapter, specified that user hej`] will 
get alerts only during work hours. The definition of these time periods comes from the 
file +ap_+j]ceko.+_kjb*`+peialanek`o[j]ceko.*_bc. This file contains some useful default 
definitions of time periods, but can also be modified as required.  Listing 6-12 gives an 
example of its contents.
 Listing 6-12. Using timeperiods_nagios2.cfg to Define During What Times of Day Nagios Has 
to Act
nkkp<iah6+ap_+j]ceko.+_kjb*`_]ppeialanek`o[j]ceko.*_bc

peialanek`o*_bc

Pdeo`abejao]peialanek`sdana]hhpeiao]nar]he`bkn_da_go(
jkpebe_]pekjo(ap_*Pda_h]ooe_.0t3oqllknpjecdpi]na*6)%
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
150
`abejapeialanek`w
peialanek`[j]ia.0t3
]he]o.0Dkqno=@]u(3@]uo=Saag
oqj`]u,,6,,).06,,
ikj`]u,,6,,).06,,
pqao`]u,,6,,).06,,
sa`jao`]u,,6,,).06,,
pdqno`]u,,6,,).06,,
bne`]u,,6,,).06,,
o]pqn`]u,,6,,).06,,
y
Danaeo]ohecdphubneaj`heanlanek``qnejcskngdkqno
`abejapeialanek`w
peialanek`[j]iaskngdkqno
]he]oOp]j`]n`SkngDkqno
ikj`]u,56,,)-36,,
pqao`]u,56,,)-36,,
sa`jao`]u,56,,)-36,,
pdqno`]u,56,,)-36,,
bne`]u,56,,)-36,,
y
Pda_kilhaiajpkbskngdkqno
`abejapeialanek`w
peialanek`[j]iajkjskngdkqno
]he]oJkj)SkngDkqno
oqj`]u,,6,,).06,,
ikj`]u,,6,,),56,,(-36,,).06,,
pqao`]u,,6,,),56,,(-36,,).06,,
sa`jao`]u,,6,,),56,,(-36,,).06,,
pdqno`]u,,6,,),56,,(-36,,).06,,
bne`]u,,6,,),56,,(-36,,).06,,
o]pqn`]u,,6,,).06,,
y
Pdeokjaeo]b]rknepa6jaran6%
`abejapeialanek`w
peialanek`[j]iajaran
]he]oJaran
y
aj`kbbeha
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
151
Restarting Nagios with Your Configuration
Your configuration files should now be in place, which means it is time to restart Nagios. 
To do this, use the command +ap_+ejep*`+j]ceko.naop]np. If you have applied changes 
to your Apache configuration as well, don’t forget to restart the Apache web server also, 
using +ap_+ejep*`+]l]_da.naop]np. When you restart Nagios, watch the console of your 
server. After all, you did apply lots of changes to the different configuration files, and 
making one tiny little typing error will cause the restart of Nagios to fail. If there is some 
serious error that prevents Nagios from restarting, you will see it on the console of your 
server, as shown in the example in  Listing 6-13. 
 Listing 6-13. If Nagios Fails to Restart, It Will Tell You Why
nkkp<iah6+ap_+ejep*`*+j]cekonaop]np
&Naop]npejcj]ceko.ikjepknejc`]aikjj]ceko.
J]ceko.*--
?klunecdp$_%-555).,,3Apd]jC]hop]`$dppl6++sss*j]ceko*knc%
H]opIk`ebea`6,/)-.).,,4
He_ajoa6CLH
Na]`ejc_kjbecqn]pekj`]p]***
Annkn6Qjatla_pa`op]npkbk^fa_p`abejepekjejbeha±
#+ap_+j]ceko.+_kjb*`+oanre_ao*_bc#kjheja-.*I]gaoqnaukq_hkoa±
lna_a`ejck^fa_po^abknaop]npejc]jaskja*
&&&:Kjakniknalnk^haios]oaj_kqjpana`sdehalnk_aooejcpda_kjbecbehao***
?da_gukqn_kjbecqn]pekjbeha$o%pkajoqnapd]ppdau_kjp]ejr]he`
`ena_perao]j``]p]`abejpekjo*Ebukq]naqlcn]`ejcbnki]lnarekqo
ranoekjkbJ]ceko(ukqodkqh`^a]s]napd]pokiar]ne]^hao+`abejepekjo
i]ud]ra^aajnaikra`knik`ebea`ejpdeoranoekj*I]gaoqnapkna]`
pdaDPIH`k_qiajp]pekjnac]n`ejcpda_kjbecbehao(]osahh]opda
#Sd]poJas#oa_pekjpkbej`kqpsd]pd]o_d]jca`*
&annknoej_kjbec
If an error occurs, fix it and restart Nagios. This part of the configuration requires 
some patience. You have created lots of configuration files, all by hand, so it’s likely that 
now you have to eliminate lots of errors, also by hand. 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
152
NCaution When using +ap_+ejep*`+j]ceko.naop]np, the service may falsely report that it is up and 
running. Don’t trust this result. When debugging your Nagios server for configuration errors, first stop it by 
using +ap_+ejep*`+j]ceko.opkl and then restart it by using +ap_+ejep*`+j]ceko.op]np.
Installing NRPE
To monitor some services, you just need Nagios on your server and nothing else. To mon-
itor other parameters on a managed host, you need a local agent on that host as well. The 
name of the service is NRPE and it exists for different server platforms. Setting up NRPE 
consists of two parts. The first part happens on the server that you want to monitor, and 
the second part happens on the Nagios server.
Configuring NRPE on the Monitored Server
Because you may have Linux distributions other than Ubuntu Server in your network, 
and because these servers may not know ]lp)cet, this section covers a more generic 
way to install the NRPE service on Linux servers. In this method, the jnla*p]n*cv file 
is installed. Of course, you can install NRPE on Ubuntu Server as well. To do this, use 
]lp)capejop]hhj]ceko)jnla)lhqcin.
NCaution If you want to install NRPE on Ubuntu, don’t install and extract the *p]n*cv file that is offered 
from the Nagios download site as described in the following procedure. Use the j]ceko)jnla)lhqcej 
package instead. Install it with the command ]lp)capejop]hhj]ceko)jnla)lhqcin. If your distribution 
is not Ubuntu but has a method of installing NRPE from its software repositories, you should always do it that 
way. Only if that doesn’t work can you apply steps  1- 4 from the following procedure.
 
1. On the server you want to manage, create a j]ceko user and a j]ceko group and 
configure +qon+hk_]h+j]ceko as the home directory that the user should use:
cnkql]``j]ceko
qoan]``)cj]ceko)i`+qon+hk_]h+j]cekoj]ceko
 
2. Go to sss*j]ceko*knc+`ksjhk]`. From there, click the Go button for Get Addons. 
Next, select the latest version of NRPE and click Go to continue. In the File Down-
load dialog box that asks you whether you want to save the jnla archive to disk, 
click Save. Store it somewhere on disk; the +pil directory is a reasonable choice. 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
153
 
3. Assuming that you have just downloaded the jnla package to the +pil direc-
tory, use _`+pil to go to that directory, and then use the command p]nvtrb
jnla8ranoekj:*p]n*cv to extract it. This creates a subdirectory with the name 
jnla)8ranoekn>.
 
4. Use _` to go into the subdirectory that was just created, and then compile the jnla 
 plug- in using the following commands. If this fails, make sure that you have a C 
compiler installed on your server.
*+_kjbecqna
i]ga]hh
 
5. Copy the jnla file from the on_ subdirectory to the directory where Nagios would 
expect its  plug- in files to be located. If on your server nothing related to Nagios has 
been installed so far, use the location +qon+hk_]h+j]ceko. If something related to 
Nagios has already been installed, check whether +r]n+he^+j]ceko already exists on 
your server. If it does, copy the jnla file there.
 
6. In the directory to which you just copied the jnla module, use your editor to cre-
ate the jnla configuration file. The name of this file must be jnla*_bc, so if you just 
copied the module to +r]n+he^+j]ceko, make sure that you create the file +r]n+he^+
j]ceko+jnla*_bc. Give the file the following contents, while making sure that the 
]hhksa`[dkopo line contains the IP address of your Nagios server:
oanran[lknp91222
jnla[qoan9j]ceko
jnla[cnkql9j]ceko
]hhksa`[dkopo9-5.*-24*-*55
This basically finishes the NRPE installation. To execute Nagios commands on 
the host that you are monitoring, you would also need Nagios  plug- ins. If nothing was 
installed yet on your server, download the  plug- ins from sss*j]ceko*knc (or from your 
distribution’s software repositories) and put them in the default path +qon+hk_]h+j]ceko+
he^ata_. If on your server some Nagios components were installed already, check the local 
server configuration to find the location of the  plug- in files. Always check if +qon+he^+
j]ceko+lhqcejo exists before putting  plug- ins in +qon+hk_]h+j]ceko+he^ata_. Many distri-
butions use this location in +qon+he^+j]ceko to store  plug- ins.
Once the  plug- ins are installed, you can add to the jnla*_bc configuration file the 
checks that you want Nagios to perform on this host. For instance, add the following line 
to check if available disk space on the monitored machine falls below the warning thresh-
old of 20% and the critical threshold of 10%:
_kii]j`W_da_g[`eogY9+qon+he^+j]ceko+lhqcejo+_da_g[`eog)s.,)_-,
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
154
NTip Before you include the plug-in command in the jnla*_bc file, make sure it really works. You can 
verify this by running it from the command line, just as you would include it in the configuration file.
Did it all work? If so, then I recommend that you add the following lines to your jnla*
_bc file as a default. This is information that you would normally be interested in when 
monitoring a remote host. 
_kii]j`W_da_g[qoanoY9+qon+he^+j]ceko+lhqcejo+_da_g[qoano)s1)_-,
_kii]j`W_da_g[hk]`Y9+qon+he^+j]ceko+lhqcejo+_da_g[hk]`)s-1(-,(1)_/,(.1(.,
_kii]j`W_da_g[vki^ea[lnk_oY9+qon+he^+j]ceko+lhqcejo+_da_g[lnk_o)s1)_-,)oV
_kii]j`W_da_g[pkp]h[lnk_oY9+qon+he^+j]ceko+lhqcejo+_da_g[lnk_o)s-1,,_.,,
After you create the NRPE configuration, make sure that the NRPE process is started. 
Use the options your distribution’s runlevels offer to make sure that it will be started 
automatically when your server reboots.
Configuring the Nagios Server to Use NRPE
The Nagios server should already contain the NRPE  plug- in. On Ubuntu Server, it is 
installed in the directory +qon+he^+j]ceko+lhqcejo by default. You should now check that 
you can really use it to contact the managed server. If the managed server has IP address 
-5.*-24*-*1-, the following command will do the test:
+qon+he^+j]ceko+lhqcejo+_da_g[jnla)D-5.*-24*-*1-
The command should output the version of the NRPE process on the remote server. 
If that worked, next add the _da_g[jnla command to the +ap_+j]ceko.+_kii]j`o*_bc file. 
This file should contain a section that defines _da_g[jnla that looks like the following:
`abeja_kii]j`w
_kii]j`[j]ia_da_g[jnla
_kii]j`[heja+qon+he^+j]ceko+lhqcejo+_da_g[jnla)D±
 DKOP=@@NAOO )_ =NC- 
y
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
155
Now that you have defined the command, it’s time to add a section to the oanre_ao*
_bc file. In this section you will use the generic _da_g[jnla command, with the particular 
command you want to execute on the remote host as its argument. For instance, to exe-
cute the _da_g[`eog command on all remote hosts, define the following section in +ap_+
j]ceko.+oanre_ao*_bc:
`abejaoanre_aw
qoacajane_)oanre_a
dkopcnkql[j]ia]hh
oanre_a[`ao_nelpekj_da_gol]_a
_da_g[_kii]j`_da_g[jnla_da_g[`eog
y
You have now finished the configuration of the NRPE  plug- in that makes it possible 
to monitor remote hosts as well. So far, we’ve talked about Linux hosts only. If you like 
Nagios, however, you can extend it to other hosts as well. There are NRPE versions avail-
able for all major operating systems, including Windows and NetWare. Check the Web for 
more information on how to configure these. 
Managing Nagios
Not that your Nagios server is up and running, you are ready to manage and monitor it 
using the web interface. In this section, you’ll get a quick tour of the web interface. The 
first window that you should check out is the Tactical Monitoring Overview, shown in 
 Figure 6-2. Especially when managing many nodes with Nagios, this view gives the fastest 
insight into what is happening on your network. The right part of the window shows you 
a performance summary, and the bottom part of the window shows you which hosts and 
services are up and how many problems have been discovered. 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
156
 Figure 6-2. The Tactical Monitor Overview window shows you in one view what critical 
events have happened on your network recently.
If you observe that something may be wrong, you’ll want to get more details about 
what is happening. The Monitoring section of Nagios offers different ways of displaying 
this information. In fact, all options look at the same information, but filter it differently. 
A very useful window is the Service Detail window, shown in  Figure 6-3. From here, you 
can monitor in detail all the different parameters that are monitored. You can see what is 
happening both for services that have reached a status of CRITICAL and for services that 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
157
are still OK. For instance, the disk space module will show you not only that it is OK, but 
also how much available disk space it has found on monitored nodes. There is just one 
disadvantage to the Service Detail window: if you monitor many hosts, a lot of informa-
tion is presented, so it isn’t easy to locate the information you need. 
 Figure 6-3. The Service Detail window provides detailed information on service performance 
parameters.
Especially if your Nagios environment is set up to monitor lots of hosts, you are going 
to like the Host Detail window. This window gives an overview of all hosts that Nagios is 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
158
monitoring, and indicates per host whether or not there are problems. If problems are 
found, you can easily analyze what exactly is going wrong by clicking the hyperlink next 
to the host. This brings you to a status screen that shows  in- depth information about the 
host. From this interface, an example of which is shown in  Figure 6-4, you can also see all 
management options available for the host. From the Host Commands list, it is easy to 
switch options on or off. Also useful in this list is the Locate Host on Map option, which 
gives you a graphical representation of the host in the Nagios monitoring network.
 Figure 6-4. The individual host view allows you to see exactly what is happening on a host. 
www.it-ebooks.info

CHAPTER 6 N   NETWORK MONITORING
159
The last options from the Monitoring section that I want to cover here are Service 
Problems, Host Problems, and Network Outages. Each of these gives you an overview of 
current problems, sorted by category. This interface helps you in solving critical issues. 
You can see status information, which attempts to describe what exactly is happening, 
and, more important, an overview of the duration of a problem. This helps you in solving 
the  longest- existing problem first.
Below the Monitoring section of the Nagios web interface is the Reporting section. 
The information available here helps you in analyzing historical data. It may not be too 
shocking that a service has been unavailable for a couple of minutes. As an administrator, 
you probably want to know how often that has happened; structural problems deserve 
more attention than occasional problems.
To generate a report from the Reporting section, select Trends. You’ll see a simple 
wizard, the first step of which asks you to indicate if you want to generate a trend report 
for a service or for a host. Select Service and next click Continue to Step 2. You now see 
a list of all services that are monitored on the different hosts in your network. For exam-
ple, if you want to monitor disk space usage on local host, select Localhost;Disk space. 
Next, continue to step 3 and modify the report options as required. By default, you’ll see 
a report over a period of the last 7 days, but if you want to show a report for the last year, 
that is equally possible. Next click Create Report and you will see the report displayed in 
the browser window.
Summary
In this chapter you have learned how to set up a Nagios server for network monitoring. 
You have learned how Nagios helps you to monitor critical parameters, including both 
parameters on the individual host that you are monitoring and network parameters. 
You have also learned how to enable NRPE, which allows you to monitor parameters on 
a remote host, even a Windows host. When configured the right way, Nagios will notify 
you when things go wrong. This is useful, but will not automatically restart a service after 
things go wrong. Heartbeat high availability is needed to do that, as described in the next 
chapter.
www.it-ebooks.info

161
C H A P T E R  7
Creating an Open Source SAN
Configuring a DRBD and 
Heartbeat on Ubuntu Server
In a modern network, a shared storage solution is indispensable. Using shared storage 
means that you can make your server more redundant. Data is stored on the shared 
storage, and the servers in the network simply access this shared storage. To prevent 
the shared storage from becoming a single point of failure, mirroring is normally 
applied. That means that the shared storage solution is configured on two servers: if 
one goes down, the other takes over. To implement such a shared storage solution, 
some people spend thousands of dollars on a proprietary storage area network (SAN) 
solution. That isn’t necessary. In this chapter you will learn how to create a shared stor-
age solution using two server machines and Ubuntu Server software, what I refer to as 
an open source SAN.
There are three software components that you’ll need to create an open source SAN:
 s  Distributed Replicated Block Device (DRBD): This component allows you to cre-
ate a replicated disk device over the network. Compare it to RAID 1, which is disk 
mirroring but with a network in the middle of it (see Chapter 1). The DRBD is the 
storage component of the open source SAN, because it provides a storage area. If 
one of the nodes in the open source SAN goes down, the other node will take over 
and provide seamless storage service without a single bit getting lost, thanks to 
the DRBD. In the DRBD, one node is used as the primary node. This is the node to 
which other servers in your data center connect to access the shared storage. The 
other node is used as backup. The Heartbeat cluster (see the third bullet in this 
list) determines which node is which.  Figure 7-1 summarizes the complete setup.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
162
 Figure 7-1. For best performance, make sure your servers have two network 
interfaces.
 s  iSCSI target: To access a SAN, there are two main solutions on the market: Fibre 
Channel and iSCSI. Fibre Channel requires a fiber infrastructure to access the 
SAN. iSCSI is just SCSI, but over an IP network. There are two parts in an iSCSI 
solution. The iSCSI target offers access to the shared storage device. All servers 
that need access use an iSCSI initiator, which is configured to make a connection 
with the iSCSI target. Once that connection is established, the server that runs the 
initiator sees an additional storage device that gives it access to the open source 
SAN.
 s  Heartbeat: Heartbeat is the most important open source  high- availability cluster 
solution. The purpose of such a solution is to make sure that a critical resource 
keeps on running if a server goes down. Two critical components in the open 
source SAN are managed by Heartbeat. Heartbeat decides which server acts as the 
DRBD primary node, and ensures that the iSCSI target is activated on that same 
server.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
163
Preparing Your Open Source SAN
To prepare your open source SAN, you need to make sure that you have everything 
necessary to set up the open source SAN. Specifically, you need to make sure that your 
hardware meets the requirements of a SAN configuration, so that you can install the soft-
ware needed to create the solution.
Hardware Requirements
The hardware requirements are not extraordinary. Basically, any server that can run 
Ubuntu Server will do, and because the DRBD needs two servers, you must have two 
such servers to set this up. You need a storage device to configure as the DRBD, though. 
For best performance, I recommend using a server that has a dedicated hard disk for 
operating system installation. This can be a small disk—a basic 36 GB SCSI disk is large 
enough—and if you prefer, you can use SATA as well. 
Apart from that, it is a good idea to have a dedicated device for the DRBD. Ideally, 
each server has a RAID 5 array to use as the DRBD, but if you can’t provide that, a dedi-
cated disk is good as well. If you can’t use a dedicated disk, make sure that each of the 
servers has a dedicated partition to be used in the DRBD setup. The storage devices that 
you are going to use in the DRBD need to be of equal size.
You also need decent networking. Because you are going to synchronize gigabytes of 
data, gigabit networking is indispensable. I recommend using a server with at least two 
network cards, one card to use for synchronization between the two block devices, and 
the other to access the iSCSI target.
Installing Required Software
Before you start to set up the open source SAN, it’s a good idea to install all software that 
is needed to build this solution. The following procedure describes how to do that:
 
1. Make sure that the software repositories are up to date, by using the ]lp)cap
ql`]pa command.
 
2. Use ]lp)capejop]hh`n^`4)qpeho to install the DRBD software.
 
3. Use ]lp)capejop]hheo_oep]ncap to install the iSCSI target.
 
4. Use ]lp)capejop]hhda]np^a]p). to install the Heartbeat software.
All required software is installed now, so it’s time to start creating the DRBD.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
164
Setting Up the Distributed Replicated Block Device
It’s time to take the first real step in the SAN configuration and set up the DRBD. Make 
sure that you have a storage device available on each of the servers involved in setting 
up the SAN. In this chapter, I’ll assume that the name of the storage device is +`ar+o`^. 
To configure the DRBD, you have to create the file +ap_+`n^`*_kjb, an example of which 
is shown in  Listing 7-1. You can remove its contents and replace it with your own 
configuration.
 Listing 7-1. The DRBD Is Configured from /etc/drbd.conf
o]j-6+ap__]p`n^`*_kjb
^acejnaokqn_a`n^`,
naokqn_a`n^`,w
lnkpk_kh?7
op]npqlw`acn)sb_)peiakqp-.,7y
`eogwkj)ek)annkn`ap]_d7y
japwy
ouj_anw
n]pa-,,i7
]h)atpajpo.137
y
kjo]j-w
`are_a+`ar+`n^`,7
`eog+`ar+o`^7
]``naoo-5.*-24*-*./,633447
iap])`eogejpanj]h7
y
kjo]j.w
`are_a+`ar+`n^`,7
`eog+`ar+o`^7
]``naoo-5.*-24*-*.0,633447
iap])`eogejpanj]h7
y
y
aj`naokqn_a`n^`,
In this example configuration file, one DRBD is configured, named +`ar+`n^`,. The 
configuration file starts with the definition of the resource `n^`,. If you would like to add 
another resource that has the name `n^`-, you would add the naokqn_a`n^`-w***y 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
165
specification later in the file. Each resource starts with some generic settings, the first of 
which is always the protocol setting. There are three protocols, A, B, and C, and of the 
three, protocol C offers the best performance. Next, there are four generic parts in the 
configuration:
 s  op]npql: Defines parameters that play a role during the startup phase of the DRBD. 
As you can see, there is just one parameter here, specifying that a timeout of 120 
seconds is used. After this timeout, if a device fails to start, the software assumes 
that it is not available and tries periodically later to start it.
 s  `eog: Specifies what has to happen when a disk error occurs. The current setting 
kn)ek)annkn`ap]_d makes sure that the disk device is no longer used if there is an 
error. This is the only parameter that you’ll really need in this section of the setup. 
 s  jap: Contains parameters that are used for tuning network performance. If you 
really need the best performance, using i]t)^qbbano.,04 makes sense here. This 
parameter makes sure that the DRBD is capable of handling 2048 simultaneous 
requests, instead of the default of 32. This allows your DRBD to function well in an 
environment in which lots of simultaneous requests occur.
 s  ouj_an: Defines how synchronization between the two nodes will occur. First, the 
synchronization rate is defined. In the example shown in  Listing 7-1, synchroniza-
tion will happen at 100 MBps (note the setting is in megabytes, not megabits). To 
get the most out of your gigabit connection, you would set it to -,,i (i.e., almost 
1 Gbps), but you should only do this if you have a dedicated network card for syn-
chronization. The parameter ]h)atpajpo.13 defines the  so- called active group, 
a collection of storage that the DRBD handles simultaneously. The syncer works 
on one active group at the same time, and this parameter defines an active group 
of 257 extents of 4 MB each. This creates an active group that is 1 GB, which is fine 
in all cases. You shouldn’t have to change this parameter.
After the generic settings in +ap_+`n^`*_kjb comes the part where you define 
 node- specific settings. In the example shown in  Listing 7-1, I used two nodes, o]j- and 
o]j.. Each node has four lines in its definition: 
 s  The name of the DRBD that will be created: It should be +`ar+`n^`, in all cases for 
the first device that you configure. 
 s  The name of the device that you want to use in the DRBD setup: This example uses 
+`ar+o`^, to make sure that on your server you are using the device that you have 
dedicated to this purpose.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
166
 s  The IP address and port of each of the two servers that participate in the DRBD con-
figuration: Make sure that you are using a fixed IP address here, to eliminate the 
risk that the IP address could suddenly change. Every DRBD needs its own port, 
so if you are defining a +`ar+`n^`- resource later in the file, it should have a unique 
port. Typically, the first DRBD has port 7788, the second device has 7789, and so 
on. 
 s  The parameter that defines how to handle metadata : You should use the param-
eter iap])`eogejpanj]h. This parameter does well in most cases, so you don’t need 
to change it.
This completes the configuration of the DRBD. Now you need to copy the +ap_+`n^`*
_kjb file to the other server. The following command shows you how to copy the `n^`*_kjb 
file from the current server to the +ap_ directory on the server o]j.:
o_l+ap_+`n^`*_kjbo]j.6+ap_+
Now that you have configured both servers, it’s time to start the DRBD for the first 
time. This involves the following steps:
 
1. Make sure that the DRBD resource is stopped on both servers. Do this by entering 
the following command on both servers:
+ap_+ejep*`+`n^`opkl
 
2. Create the device and its associated metadata, on both nodes. To do so, run the 
`n^`]`i_na]pa)i``n^`, command.  Listing 7-2 shows an example of its output.
 Listing 7-2. Creating the DRBD
nkkp<o]j-6z`n^`]`i_na]pa)i``n^`,
r,4I]ce_jqi^anjkpbkqj`
i`[kbboap/55551.452,
]h[kbboap/5555052-5.
^i[kbboap/5554.3-044
Bkqj`okia`]p]
99:Pdeoiecdp`aopnkuateopejc`]p]899
@kukqs]jppklnk_aa`;
Wjaa`pkpula#uao#pk_kjbeniYuao
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
167
r,3I]ce_jqi^anjkpbkqj`
r,3I]ce_jqi^anjkpbkqj`
r,4I]ce_jqi^anjkpbkqj`
Snepejciap]`]p]***
ejepe]heoejc]_perepuhkc
JKPejepe]heva`^epi]l
Jas`n^`iap]`]p]^hk_goq_aoobqhhu_na]pa`*
))99?na]pejciap]`]p]99))
=osepdjk`aosa_kqjppdapkp]hjqi^ankb`are_aoiennkna`^u@N>@]p
]pdppl6++qo]ca*`n^`*knc*
Pda_kqjpanskngo_kilhapahu]jkjuikqo*=n]j`kijqi^ancapo_na]pa`bkn
pdeo`are_a(]j`pd]pn]j`kianjqi^an]j`pda`are_aooevasehh^aoajp*
dppl6++qo]ca*`n^`*knc+_ce)^ej+ejoanp[qo]ca*lh;jq9.,0,,.,120-1.2.20,-"nq±
9-,45/240/43225-5/342"no9/55551/220,
Ajpan#jk#pkklpkqp(knfqoplnaooWnapqnjYpk_kjpejqa6
oq__aoo
 
3. Make sure the `n^` module is loaded on both nodes, and then associate the DRBD 
resource with its backing device:
ik`lnk^a`n^`
`n^`]`i]pp]_d`n^`,
 
4. Connect the DRBD resource with its counterpart on the other node in the setup:
`n^`]`i_kjja_p`n^`,
 
5. The DRBD should run properly on both nodes now. You can verify this by using 
the +lnk_+`n^` file.  Listing 7-3 shows an example of what it should look like at this 
point.
 Listing 7-3. Verifying in /proc/drbd that the DRBD Is Running Properly on Both Nodes
o]j-6z_]p+lnk_+`n^`
ranoekj6,*3*..$]le635+lnkpk630%
ORJNareoekj6.13.^qeh`^uhi^<`]ha(.,,2)-,).1-46-36.-
,6_o6?kjja_pa`op6Lnei]nu+Oa_kj`]nuh`6?kjoeopajp
jo6,jn6,`s6,`n6,]h6,^i6,hk6,la6,q]6,]l6,
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
168
 
6. As you can see, the DRBD is set up now, but both nodes at this stage are config-
ured as secondary in the DRBD setup, and no synchronization is happening yet. 
To start synchronization and configure one node as primary, use the following 
command on one of the nodes:
`n^`]`i))))kransnepa)`]p])kb)laanlnei]nu`n^`,
 
 This starts synchronization from the node where you enter this command to the 
other node. 
NCaution At this point, you will start erasing all data on the other node, so make sure that this is really 
what you want to do.
 
7. Now that the DRBD is set up and has started its synchronization, it’s a good idea to 
verify that this is really happening, by looking at +lnk_+`n^` once more.  Listing 7-4 
shows an example of what it should look like at this point. It will take some time 
for the device to synchronize completely. Up to that time, the device is marked as 
inconsistent. That doesn’t really matter at this point, as long as it is up and works. 
 Listing 7-4. Verify Everything Is Working Properly by Monitoring /proc/drbd
nkkp<o]j-6z_]p+lnk_+`n^`
ranoekj64*,*--$]le642+lnkpk642%
CEP)d]od6^/ba.^`b`/^5b3_.b5./-4244/a^5a.],`/]1^-^^qeh`^uldeh<iao_]h(±
.,,4),.)-.--61260/
,6_o6Ouj_Okqn_aop6Lnei]nu+Oa_kj`]nu`o6QlPk@]pa+Ej_kjoeopajp?n)))
jo62.-00jn6,`s6,`n62.-00]h6,^i6/hk6,la6,q]6,]l6,
W:********************Youj_#a`6,*.!$/4,40+/4-01%I
bejeod6-46,/6-3olaa`60,,$/.,%G+oa_
naouj_6qoa`6,+/-depo6/44,ieooao60op]nrejc6,`enpu6,_d]jca`60
]_p[hkc6qoa`6,+.13depo6,ieooao6,op]nrejc6,`enpu6,_d]jca`6,
In the next section you’ll learn how to configure the iSCSI target to provide access to 
the DRBD from other nodes. 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
169
NTip At this point it’s a good idea to verify that the DRBD starts automatically. Reboot your server to 
make sure that this happens. Because you haven’t configured the cluster yet to make one of the nodes 
 primary automatically, on one of the nodes you have to run the `n^`]`i))))kransnepa)`]p])kb)laan
lnei]nu`n^`, command manually, but only after rebooting. At a later stage, you will omit this step 
because the cluster software ensures that one of the nodes becomes primary automatically.
Accessing the SAN with iSCSI
You now have your DRBD up and running. It is time to start with the second part of 
the configuration of your open source SAN, namely the iSCSI target configuration. The 
iSCSI target is a component that is used on the SAN. It grants other nodes access to 
the shared storage device. In the iSCSI configuration, you are going to specify that the 
+`ar+`n^`, device is shared with the iSCSI target. After you do this, other servers can use 
the iSCSI initiator to connect to the iSCSI target. Once a server is connected, it will see 
a new storage device that refers to the shared storage device. In this section you’ll first 
read how to set up the iSCSI target. The second part of this section explains how to set 
up the iSCSI initiator. 
Configuring the iSCSI Target
You can make access to the iSCSI target as complex as you want. The example configura-
tion file +ap_+eap`*_kjb gives an impression of the possibilities. If, however, you want to 
create just a basic setup, without any authentication, setting up an iSCSI target is not too 
hard. The first thing you need is the iSCSI Qualified Name (IQN) of the target. This name 
is unique on the network and is used as a unique identifier for the iSCSI target. It typically 
has a name like emj*.,,4),4*_ki*o]j`anr]jrqcp6`n^``esk. This name consists of four dif-
ferent parts. The IQN of all iSCSI targets starts with emj, followed by the year and month 
in which the iSCSI target was configured. Next is the inverse DNS domain name, and the 
last part, just after the colon, is a unique ID for the iSCSI target. 
The second part of the configuration file that you will find in each iSCSI target refers 
to the disk device that is shared. It is a simple line, like Hqj,L]pd9+`ar+o`_(Pula9behaek. 
This line gives a unique logical unit number (LUN) ID to this device, which in this case is 
hqj,. Following that is the name of the device that you are sharing. When sharing devices 
the way I demonstrate in this section, the type will always be behaek. You can configure 
one LUN, which is what we need in this setup, but if there are more devices that you want 
to share, you can configure a LUN for each device.  Listing 7-5 gives an example of a setup 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
170
in which two local hard disks are shared with iSCSI (don’t use it in your setup of the open 
source SAN—it’s just for demonstration purposes!).
 Listing 7-5. Example of an iSCSI Target that Gives Access to Two Local Disk Devices
P]ncapemj*.,,4),4*_ki*o]j`anr]jrqcp6iup]ncap
Hqj,L]pd9+`ar+o`^(Pula9behaek
Hqj-L]pd9+`ar+o`_(Pula9behaek
The last part of the iSCSI target configuration is optional and may contain param-
eters for optimization. The example file gives some default values, which you can increase 
to get a better performance. For most scenarios, however, the default values work fine, so 
there is probably no need to change them.  Listing 7-6 shows the default parameters that 
are in the example file.
 Listing 7-6. The Example ietd.conf Gives Some Suggestions for Optimization Parameters
I]t?kjja_pekjo-
Ejepe]hN.PUao
Eiia`e]pa@]p]Jk
I]tNa_r@]p]OaciajpHajcpd4-5.
I]tTiep@]p]OaciajpHajcpd4-5.
I]t>qnopHajcpd.2.-00
Benop>qnopHajcpd211/2
@ab]qhpPeia.S]ep.
@ab]qhpPeia.Nap]ej.,
I]tKqpop]j`ejcN.P4
@]p]L@QEjKn`anUao
@]p]Oamqaj_aEjKn`anUao
AnnknNa_kranuHarah,
Da]`an@ecaop?N?/.?(Jkja
@]p]@ecaop?N?/.?(Jkja
r]nekqop]ncapl]n]iapano
Spdna]`o4
As the preceding discussion demonstrates, iSCSI setup can be really simple. Just 
provide an IQN for the iSCSI target and then tell the process to which device it should 
offer access. In our open source SAN, this is the DRBD. Note, however, that there is one 
important item that you should be careful with: iSCSI target should always be started on 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
171
the node that is primary in the DRBD setup. Later you will configure the cluster to do that 
automatically for you, but at this point, you should just take care that it happens manu-
ally. To determine which of the nodes is running as primary, check +lnk_+`n^`. The node 
that shows the line Ouj_Okqn_aop6Lnei]nu+Oa_kj`]nu is the one on which you should start 
the iSCSI target.
Configuring the iSCSI target at this point is simple:
 
1. Create the +ap_+eap`*_kjb file. It should exist on both nodes and have exactly the 
same contents. The example file in  Listing 7-7 shows what it should look like.
 Listing 7-7. Use This Configuration to Set Up the ISCSI Target
P]ncapemj*.,,4),4*_ki*o]j`anr]jrqcp6klajokqn_ao]j
Hqj,L]pd9+`ar+`n^`,(Pula9behaek
 
2. On installation, the iSCSI target script was added to your runlevels automatically. 
You should now stop and restart it. To do this, run the +ap_+ejep*`+eo_oep]ncap
opkl command. Next run +ap_+ejep*`+eo_oep]ncapop]np, and it should all work.
Now that your iSCSI target apparently is up and running, you should  double- check 
that indeed it is. To do that, you need to know about the iSCSI target ID. You can get that 
from the file +lnk_+jap+eap+rkhqia. If at a later stage you want to find out about session 
IDs, check the +lnk_+jap+eap+oaooekj file for those.  Listing 7-8 shows what the +lnk_+jap+
eap+rkhqia file looks like.
 Listing 7-8. Getting Information About Currently Operational iSCSI Targets from /proc/net/
iet/volume
nkkp<o]j-6z_]p+lnk_+jap+eap+rkhqia
pe`6-j]ia6emj*.,,4),4*_ki*o]j`anr]jrqcp6klajokqn_ao]j
hqj6,op]pa6,ekpula6behaekekik`a6spl]pd6+`ar+`n^`,
As you can see, the target ID (pe`) of the iSCSI target device that you’ve just config-
ured is 1. Knowing that, you can display status information about that target with the 
eap]`i command. To do that, use eap]`i))klodks))pe`=1. The output of this command 
will be similar to the output shown in  Listing 7-9.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
172
 Listing 7-9. Use ietadm to Get More Details About a Particular iSCSI Target
nkkp<o]j-6zeap]`i))klodks))pe`9-
Spdna]`o94
Pula9,
Mqaqa`?kii]j`o9/.
At a later stage, you can also use eap]`i to get more information about currently exist-
ing sessions. 
Before you continue, there is one item that you should take care of. Once the Heart-
beat cluster is configured, Heartbeat will decide where the iSCSI target software has 
started and is running. Therefore, it may not be started automatically from the runlevels. 
The following procedure shows you how to switch it off using the optional ouor_kjbec 
tool:
 
1. Use ]lp)capejop]hhouor_kjbec to install the ouor_kjbec tool on both nodes. 
 
2. Start ouor_kjbec and, from the main interface, select enable/disable service.
 
3. As shown in  Figure 7-2, browse to the eo_oep]ncap service and switch it off by 
pressing the spacebar on your keyboard.
 Figure 7-2. Select the iscsitarget service to switch it off.
 
4. Quit the ouor_kjbec editor. 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
173
Configuring the iSCSI Initiator
The purpose of an iSCSI initiator is to access shared storage offered by an iSCSI target. 
This shared storage can be nodes in a  high- availability cluster or  stand- alone nodes. In 
this section I’ll explain how to configure the iSCSI initiator on a third node, which will 
allow you to test that everything is working as expected. Once configured properly, the 
iSCSI initiator will give a new storage device to the server that is accessing the iSCSI SAN. 
So if your server just had a +`ar+o`] device before connecting to the iSCSI target, after 
making connection, it will have a +`ar+o`^ device as well.  Figure 7-3 gives a schematic 
overview of what you are going to do in this section.
 Figure 7-3. The iSCSI initiator will provide a new SCSI device on the nodes that use it.
Every operating system has its own solutions to set up an iSCSI initiator. If you want 
to set it up on Linux, the klaj)eo_oe solution is the most appropriate. First, make sure that 
it is installed, by running the following command:
]lp)capejop]hhklaj)eo_oe
Once installed, you can start its configuration. To do this, use the eo_oe]`i command. 
First, you need to discover all available iSCSI targets with this command. After you dis-
cover them, you need to use the same command to make a connection. The following 
procedure shows you how to do this:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
174
 
1. From the node that needs to access the storage on the SAN, use the eo_oe]`i com-
mand as displayed in  Listing 7-10. This gives you an overview of all iSCSI targets 
offered on the IP address that you query.
 Listing 7-10. Use iscsiadm to Discover All Available Targets
nkkp<iah6zeo_oe]`i))ik`a`eo_kranu))pulaoaj`p]ncapo))lknp]h± -5.*-24*-*./,
-5.*-24*-*./,6/.2,(-emj*.,,4),4*_ki*o]j`anr]jrqcp6klajokqn_ao]j
 
2. Now that you have located an available iSCSI target, use the eo_oe]`i command to 
log in to it. The following command shows how to do that:
eo_oe]`i))ik`ajk`a))p]ncapj]iaemj*.,,4),4*_ki*o]j`anr]jrqcp6klajokqn_ao]j±
))lknp]h-5.*-24*-*./,6/.2,))hkcej
 
3. If it succeeds, this command will tell you that you are now connected. If you want 
to verify existing connections, use the eo_oe]`i)i oaooekj command to display 
a list of all current iSCSI sessions.  Listing 7-11 shows an example of its output; you 
can now recognize the iSCSI device, which is marked as the IET device type.
 Listing 7-11. Use lsscsi to Check Whether the New iSCSI Device Was Properly Created
nkkp<iah6zhoo_oe
W.6,6,6,Y`eog=P=OP/1,,2/,=O/*==+`ar+o`]
W/6,6,6,Y`eog=P=OP/1,,2/,=O/*==+`ar+o`^
W16,6,6,Y_`+`r`HEPA)KJ@R@NSHD).,=-O5H,3+`ar+o_`,
W26,6,6,Y`eogCajane_OPKN=CA@ARE?A52,.+`ar+o`_
W26,6,6-Y`eogCajane_OPKN=CA@ARE?A52,.+`ar+o``
W26,6,6.Y`eogCajane_OPKN=CA@ARE?A52,.+`ar+o`a
W26,6,6/Y`eogCajane_OPKN=CA@ARE?A52,.+`ar+o`b
W36,6,6,Y`eogEAPRENPQ=H)@EOG,+`ar+o`c
The advantage of the iSCSI initiator configuration with eo_oe]`i is that the configu-
ration settings are automatically written to configuration files at the moment you apply 
them. This, however, also has a disadvantage: the same iSCSI connection will always be 
reestablished. If after a change of configuration you need to change which iSCSI connec-
tion is automatically restored, you need to use eo_oe]`i to manually remove your iSCSI 
connection. If you wanted to do that for the iSCSI connection that was just established, 
the following command would do the job:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
175
eo_oe]`i))ik`ajk`a))p]ncapj]iaemj*.,,4),4*_ki*o]j`anr]jrqcp6klajokqn_ao]j±
))lknp]h-5.*-24*-*./,6/.2,))hkckqp
You now have verified your iSCSI configuration and that everything is working fine. 
The next step is to configure the Heartbeat cluster.
Setting Up Heartbeat
At this stage, you have a DRBD configuration that works, but in which you have to assign 
the primary server manually. You also have configured the iSCSI target, but it doesn’t 
start automatically. The goal of this section is to install the Heartbeat  high- availability 
clustering software and configure it to automatically assign the primary DRBD node and 
start the iSCSI target service.
The main goal of Heartbeat is to ensure that vital services are restarted automatically 
when the node currently hosting such a service goes down. To do this, Heartbeat sends 
protocol packets (the Heartbeats) to the other nodes in the cluster periodically. If a node 
seems to be down, the resources are migrated over automatically. In an open source SAN 
(just as in an expensive proprietary SAN), that doesn’t mean the service will be uninter-
rupted. There will be a short period of interruption, with the advantage that the service 
automatically restarts. In this section you will learn how to set up Heartbeat so that there 
will always be a primary DRBD node and an iSCSI target.
Configuring Heartbeat involves three important elements. The first is the d]*_b con-
figuration file, which contains a list of all nodes available in the cluster. When Heartbeat 
starts, it reads this configuration file to determine what exactly it has to start. The second 
important element is the cluster configuration base itself. This is stored in a file named 
_e^*tih. As an administrator, never manually edit this file. Instead, use the d^[cqe graphi-
cal user interface to set it up in a more  user- friendly way. Last, you need to configure 
STONITH, which ensures that no data corruption will occur in your cluster. In the follow-
ing subsections, you’ll learn how to configure all of these.
Setting Up the Base Cluster from /etc/ha.d/ha.cf
In the first part of the cluster setup, you must tell the cluster which nodes it contains. 
To do that, you use the +ap_+d]*`+d]*_b configuration file. This can be a very simple con-
figuration file, mentioning not much more than the names of the nodes in the cluster, 
because the rest of the configuration is stored in an XML file that is maintained by the 
cluster.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
176
NCaution You must set up hostname resolution properly; otherwise, the configuration discussed here is 
not going to work. The hostnames of all nodes in the cluster as used in DNS or +ap_+dkopo must be the 
same as the hostnames given by the command qj]ia)j.
 Listing 7-12 shows an example of a very simple d]*_b configuration file.
 Listing 7-12. Example /etc/ha.d/ha.cf Configuration File
q`llknp250
]qpkfkej]ju
_nipnqa
^_]opapd,
jk`ao]j.
jk`ao]j-
In this configuration file, the following options are used:
 s  q`llknp: This option tells Heartbeat which UDP port to use for its communication. 
694 is the default port, and there is no good reason to change it. 
 s  ]qpkfkej: This parameter enables nodes to join the cluster automatically, without 
a jk`a directive in d]*_b. Basically, this practice is bad and unsecure, so disable it 
by using the ]qpkfkejjkja option.
 s  _ni: In the old Heartbeat, version 1, all resources in the cluster were created from 
a configuration file. In the newer Heartbeat, version 2, the cluster resource man-
ager (CRM) is used. The option _nipnqa enables the CRM. There is no reason 
whatsoever to use anything other than _nipnqa.
 s  ^_]opapd,: This line tells Heartbeat to send its protocol packets over network 
interface apd,. For redundancy purposes, it is a good idea to add another network 
interface as well. For instance, ^_]opapd,apd- would use both apd, and apd- to 
broadcast Heartbeat protocol packets. 
After configuring the d]*_b file, you need to create a second file, ]qpdgauo, in the direc-
tory +ap_+d]*`. You use this file to enable or disable authentication between hosts. If you 
are in a trusted network environment, no authentication is needed. If that’s the case, you 
just use a cyclic redundancy check (CRC) on arriving packets to see if any errors have 
occurred.  Listing 7-13 shows an example of the ]qpdgauo file.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
177
 Listing 7-13. /etc/ha.d/authkeys Tells the Nodes How to Handle Node Authentication
]qpd-
-_n_
In the last step to create the foundation of the cluster, you need to make sure that 
the +ap_+d]*`+]qpdgauo file has the proper permissions, which is permissions 600. So use 
_dik`2,,+ap_+d]*`+]qpdgauo to set them.
Now that you have created the basic configuration, you should copy it to the other 
node. Heartbeat provides a tool to do that, d][lnkl]c]pa, which is in the +qon+he^+
da]np^a]p directory (+qon+he^20+da]np^a]p if you are using  64- bit Ubuntu Server). Because 
its directory is not in the search path, you have to run it with its complete path reference:
+qon+he^+da]np^a]p+d][lnkl]c]pa
Now that the configuration is available on both nodes, you can start Heartbeat to see 
if it’s working properly. On both nodes, use the following two commands to start it:
+ap_+ejep*`+da]np^a]popkl
+ap_+ejep*`+da]np^a]pop]np
This should bring up the Heartbeat software. To verify that it runs, use the _ni[ikj
)e- command. This will give you  real- time status information about the current state of 
your Heartbeat cluster.  Listing 7-14 gives an example of its output. 
 Listing 7-14. Use crm_mon -i 1 to Check Whether the Cluster Is Up and Running
nkkp<o]j-6z_ni[ikj)e-
Nabnaodej-o***
999999999999
H]opql`]pa`6Sa`Fqh/,-,6-26-0.,,4
?qnnajp@?6o]j-$`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0%
.Jk`ao_kjbecqna`*
,Naokqn_ao_kjbecqna`*
999999999999
Jk`a6o]j-$`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0%6kjheja
Jk`a6o]j.$a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a%6kjheja
If you see output similar to this, that means the Heartbeat cluster is running and 
a very basic _e^*tih file has been created. For the moment, this _e^*tih file contains 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
178
only information about the nodes that are present in the cluster and their current state. 
If you’re interested in what the configuration currently looks like, use the _e^]`iej)M 
command (see  Listing 7-15 for an example).
 Listing 7-15. cibadmin -Q Shows the Current Configuration of the Cluster
nkkp<o]j-6z_e^]`iej)M
8_e^cajan]pa`9pnqa]`iej[alk_d9,alk_d9.jqi[ql`]pao90d]ra[mqknqi9pnqa±
ecjkna[`p`9b]hoa__i[pn]joepekj9.jqi[laano9._e^[ba]pqna[nareoekj9.*,±
`_[qqe`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0:
8_kjbecqn]pekj:
8_ni[_kjbec:
8_hqopan[lnklanpu[oape`9_e^)^kkpopn]l)klpekjo:
8]ppne^qpao:
8jrl]ene`9_e^)^kkpopn]l)klpekjo)`_)ranoekjj]ia9`_)ranoekj±
r]hqa9.*-*/)jk`a611./,12-.15--4/^-2.4^]]1^_2a5,/a,b-a.2]/+:
8+]ppne^qpao:
8+_hqopan[lnklanpu[oap:
8+_ni[_kjbec:
8jk`ao:
8jk`ae`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0qj]ia9o]j-pula9jkni]h+:
8jk`ae`9a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31aqj]ia9o]j.pula9jkni]h+:
8+jk`ao:
8naokqn_ao+:
8_kjopn]ejpo+:
8+_kjbecqn]pekj:
8op]pqo:
8jk`a[op]pae`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0qj]ia9o]j-±
_ni`9kjheja_ni)`a^qc)knecej9`k[hni[mqanuodqp`ksj9,ej[__i9pnqa±
d]9]_perafkej9iai^anatla_pa`9iai^an:
8pn]joeajp[]ppne^qpaoe`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0:
8ejop]j_a[]ppne^qpaoe`9op]pqo)`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0:
8]ppne^qpao:
8jrl]ene`9op]pqo)`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0)lnk^a± [_kilhapa±
j]ia9lnk^a[_kilhapar]hqa9pnqa+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
8+pn]joeajp[]ppne^qpao:
8hnie`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0:
8hni[naokqn_ao+:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
179
8+hni:
8+jk`a[op]pa:
8jk`a[op]pae`9a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31aqj]ia9o]j.±
d]9]_pera_ni)`a^qc)knecej9`k[hni[mqanu_ni`9kjhejaodqp`ksj9,ej±
[__i9pnqafkej9iai^anatla_pa`9iai^an:
8hnie`9a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a:
8hni[naokqn_ao+:
8+hni:
8pn]joeajp[]ppne^qpaoe`9a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a:
8ejop]j_a[]ppne^qpaoe`9op]pqo)a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a:
8]ppne^qpao:
8jrl]ene`9op]pqo)a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a)lnk^a± [_kilhapaj]ia9lnk^a[_kilhapar]hqa9pnqa+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
8+pn]joeajp[]ppne^qpao:
8+jk`a[op]pa:
8+op]pqo:
8+_e^:
In the _e^*tih file, you’ll find the complete configuration of the cluster. This con-
figuration consists of two main parts: _kjbecqn]pekj and op]pqo. Everything between 
8_kjbecqn]pekj: and 8+_kjbecqn]pekj: represents the resources that you have created in 
the cluster. This is useful information, because you can save it to a file, modify that file, 
and tune it later on in the process. Everything between the tags 8op]pqo: and 8+op]pqo: is 
current status information about the cluster. This is mainly needed by the cluster itself 
and you won’t normally need to change this information.
The _kjbecqn]pekj section includes the following four parts:
 s  _ni[_kjbec: Contains generic parameters for your cluster. 
 s  jk`ao: Enables you to see which nodes currently are in the cluster. This should 
reflect the two jk`a lines in d]*_b. 
 s  naokqn_ao: Lists resources. This section is still empty in  Listing 7-15 because no 
resources have been configured yet. 
 s  _kjopn]ejpo: Enables you to create rules to tell the cluster which nodes can service 
which resources and in what order the resources should be loaded.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
180
Configuring Cluster Resources
The good news is that at this point you are done with the most difficult work. The cluster 
is operational and ready for the resources you are about to create. Consider the resources 
to be the services that you want the cluster to manage for you. In this case, we need three 
resources:
 s  ! RESOURCE THAT AUTOMATICALLY CONFIGURES ONE OF THE NODES AS THE $2"$ PRIMARY node
 s  ! RESOURCE FOR THE I3#3) TARGET
 s  !N )0 ADDRESS THAT WILL BE USED BY THE I3#3) TARGET
The IP address resource warrants some explanation. This resource is needed because 
the iSCSI target will roam from one server to another and back from time to time. You do 
want to configure the iSCSI initiators, however, with an IP address that never changes. 
For that reason, you are going to configure an IP address resource, and make sure that 
resource is started whenever the iSCSI target is started. This allows the servers that run an 
iSCSI initiator simply to connect to the IP address that is offered by the cluster, irrespec-
tive of which particular server the iSCSI target is currently served by. 
To create cluster resources, Heartbeat provides a graphical user interface named 
d^[cqe. By default, this GUI is not installed, so use ]lp)capejop]hhda]np^a]p)cqe to 
install it now. If you prefer not to run graphical applications from your server, you can 
install d^[cqe on a graphical desktop. It doesn’t really matter where it runs, because you 
can connect from a client running d^[cqe to any server running the Heartbeat cluster 
software. Assuming that you have installed the da]np^a]p)cqe package on a graphical 
desktop, the following procedure describes how to configure cluster resources:
 
1. On the cluster server you want to connect to, you have to give a password to user 
d]_hqopan, so use l]oos`d]_hqopan (preferably on both nodes) and give this user 
a password.
 
2. From the computer where you have installed d^[cqe, open a terminal window and 
enter the command d^[cqe" to start the Heartbeat GUI.
 
3. From the d^[cqe interface, select Connection ° Login to open a Login dialog box. 
Enter the following information:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
181
  s  Server(:port): The IP address of one of the cluster nodes
  s  User Name: The username d]_hqopan
  s  Password: The password that you just assigned to user d]_hqopan
 
 Click OK to log in, and wait a few seconds for d^[cqe to read the configuration from 
the server. You should then see the Linux HA Management Client window (see 
 Figure 7-4).
 Figure 7-4. The hb_gui interface shows the current cluster configuration after logging in.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
182
 
4. At this point you are ready to create the first resource. Select Resources ° Add 
New Item (or just click the + button). In the small dialog box that asks you what 
Item Type you want to create, choose Native and click OK to open the Add Native 
Resource window (see  Figure 7-5).
 Figure 7-5. In this window, you can configure the resources in your cluster.
 
5. Create the resource that you want to be loaded first. This must be the resource 
that manages the DRBD, because without the DRBD, you cannot start the iSCSI 
initiator. In the Resource ID field, provide the name of the resource (I used `n^` 
in this example). In the Belong to Group field, create a resource group (I used 
klajokqn_ao]j). The three resources that you are going to create in this example 
depend on each other, and assigning them to a group ensures that they are always 
loaded on the same server and in the order in which they appear in the group. 
Next, in the Type box, select the `n^``eog resource type, as shown in the example 
in  Figure 7-6.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
183
 Figure 7-6. You need the drbddisk resource type to manage which DRBD is going to 
be the master. 
 
6. Click Add Parameter. In the Name field, enter the name of the DRBD that you have 
created. If you’ve followed the instructions from the beginning of this chapter, this 
should be set to `n^`,, in which case you don’t need to enter a value here. Click 
Add to add the resource. You will see it immediately in the d^[cqe interface, added 
as a part of the group in which you have created it. Its current status is jkpnqjjejc. 
To see if it works,  right- click it and select Start. You should see that the d^[cqe 
interface marks it as op]npa` and indicates on which node it is running. You can get 
the same information from the output of the _ni[ikj )e- command, an example 
of which is shown in  Listing 7-16.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
184
 Listing 7-16. crm_mon -i 1 Shows Whether a Resource Is Up and, if So, on Which 
Node It Is Started
nkkp<o]j.6z_ni[ikj)e-
Nabnaodej-o***
999999999999
H]opql`]pa`6Sa`Fqh/,-/610614.,,4
?qnnajp@?6o]j.$a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a%
.Jk`ao_kjbecqna`*
-Naokqn_ao_kjbecqna`*
999999999999
Jk`a6o]j-$`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0%6kjheja
Jk`a6o]j.$a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31a%6kjheja
Naokqn_aCnkql6klajokqn_ao]j
`n^`$da]np^a]p6`n^``eog%6Op]npa`o]j-
 
7. Now that you’ve verified the DRBD resource is running from the cluster per-
spective, it is a good idea to look at the +lnk_+`n^` file to determine which node 
currently is the primary DRBD from the DRBD perspective. The output of this 
command should show you that one of the nodes is running as primary, as you 
can see in  Listing 7-17. If everything is still okay, it’s time to go back to the d^[cqe 
interface. 
 Listing 7-17. /proc/drbd Should Show One Node Is Designated as the Primary DRBD
nkkp<o]j.6z_]p+lnk_+`n^`
ranoekj64*,*--$]le642+lnkpk642%
CEP)d]od6^/ba.^`b`/^5b3_.b5./-4244/a^5a.],`/]1^-^^qeh`^uldeh<iao_]h(±
.,,4),.)-.--61260/
,6_o6?kjja_pa`op6Oa_kj`]nu+Lnei]nu`o6QlPk@]pa+QlPk@]pa?n)))
jo6,jn63143-04`s63143-04`n6,]h6,^i6020hk6,la6,q]6,]l6,
naouj_6qoa`6,+/-depo603/3/0ieooao6020op]nrejc6,`enpu6,± _d]jca`6020
]_p[hkc6qoa`6,+.13depo6,ieooao6,op]nrejc6,`enpu6,_d]jca`6,
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
185
 
8. Now that the DRBD is working properly, it’s time to set up the next resource in the 
cluster: the IP address that the iSCSI target is going to use.  Right- click the resource 
group you have just created, select Add New Item, choose the Item Type Native, 
and click OK. This opens the Add Native Resource window, in which you can 
specify the properties of the resource that you want to add. For the Resource ID, 
enter iSCSI_target_IP and make sure the resource belongs to the group you’ve just 
created. Next, in the Type box, select EL]``n.. In the Parameters box, you can see 
that a parameter with the name el and the description “IPv4 address” is automati-
cally added. Click in the Value column in that same row to enter an IP address for 
this resource. This is the unique IP address that will be used to contact the iSCSI 
target, so make sure to choose an IP address that is not in use already. You’ll now 
see a screen similar to the example shown in  Figure 7-7 (but with iSCSI_target_IP 
in this Resource ID field).
 Figure 7-7. In the Resource ID field, make sure to enter the name of the resource as 
you want it to appear in the cluster.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
186
 
9. With the properties of the IP address resource still visible, click Add Parameter 
and open the Name  drop- down list. You’ll see a list of preconfigured options 
that you can use to configure the IP address. Typically, you’ll want to specify 
_e`n[japi]og to contain the netmask, and specify je_ to identify to which network 
card the IP address should be bound. When specifying the netmask, make sure to 
use the CIDR notation—not 255.255.255.0, but 24, for example. Click Add to add 
the resource to the cluster configuration. You’ll see that the resource is added to 
the group, but is not started automatically. To start it from the d^[cqe interface, 
 right- click it and select Start. The d^[cqe interface should now look something like 
 Figure 7-8.
 Figure 7-8. hb_gui now shows the DRBD and the iSCSI_target_IP resources as both started. 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
187
 
10. You now need to add one more resource, so from the d^[cqe interface,  right- click 
the resource group that you created earlier, select Add New Item, select the Native 
Item Type, and click OK. Give the resource the Resource ID iSCSItarget and make 
sure it belongs to your resource group. Select the eo_oep]ncap resource type in the 
Type box and click Add. This adds iSCSItarget to the resource group. You can now 
start the iSCSI target as well, which will activate all the resources in the resource 
group. Your open source SAN is now fully operational!
Backing Up the Cluster Configuration
Now that you have an operational open source SAN, it is a good idea to make a backup 
of the configuration that you have so far. You can do this by writing the results of the 
_e^]`iej)M command to a file, which you will learn how to do in this section. You’ll also 
learn how, based on the backup, you can easily remove a resource from the cluster and 
add it again. In my daily practice as a  high- availability consultant, this has saved my skin 
more than once after a cluster configuration has suddenly disappeared for no apparent 
reason. To make the backup, run the following command:
_e^]`iej)M:+nkkp+_hqopan*tih
Now that you have created the backup, it’s time to open the XML file. In this file, 
which will be rather large, you’ll see lots of information. The information between the 
8_kjbecqn]pekj: and 8+_kjbecqn]pekj: tags contains the actual cluster configuration as it 
has been written to the XML file when you configured resources using d^[cqe. Using your 
favorite text editor, remove everything else from the backup file. This should leave you 
with a result that looks like  Listing 7-18.
 Listing 7-18. Backup of the Current Cluster Configuration
nkkp<o]j.6z_]p_hqopan*tih
8_kjbecqn]pekj:
8_ni[_kjbec:
8_hqopan[lnklanpu[oape`9_e^)^kkpopn]l)klpekjo:
8]ppne^qpao:
8jrl]ene`9_e^)^kkpopn]l)klpekjo)`_)ranoekjj]ia9`_)ranoekj±
r]hqa9.*-*/)jk`a611./,12-.15--4/^-2.4^]]1^_2a5,/a,b-a.2]/+:
8+]ppne^qpao:
8+_hqopan[lnklanpu[oap:
8+_ni[_kjbec:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
188
8jk`ao:
8jk`ae`9`]_-b^/3)b`._)0b^0)^44`),/-_b^4/35b0qj]ia9o]j-pula9jkni]h+:
8jk`ae`9a^_0_2,,)0_2/)05^-)4_0`).2354]a5_31aqj]ia9o]j.pula9jkni]h+:
8+jk`ao:
8naokqn_ao:
8cnkqle`9klajokqn_ao]j:
8iap][]ppne^qpaoe`9klajokqn_ao]j[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9klajokqn_ao]j[iap]]ppn[p]ncap[nkhaj]ia9p]ncap[nkha±
r]hqa9opklla`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8lneieperae`9`n^`_h]oo9da]np^a]ppula9`n^``eog±
lnkre`an9da]np^a]p:
8iap][]ppne^qpaoe`9`n^`[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9`n^`[iap]]ppn[p]ncap[nkhaj]ia9p]ncap±
[nkhar]hqa9op]npa`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8+lneiepera:
8lneieperae`9eO?OE[p]ncap[EL_h]oo9k_bpula9EL]``n.±
lnkre`an9da]np^a]p:
8ejop]j_a[]ppne^qpaoe`9eO?OE[p]ncap[EL[ejop]j_a[]ppno:
8]ppne^qpao:
8jrl]ene`9.,-4a45a)0_a`)0b52)5,42)10]050-^.`_3j]ia9el±
r]hqa9-5.*-24*-*./1+:
8jrl]ene`94]3.342/)`,2`)01.1)4``2)]_^`05_^`]/aj]ia9je_±
r]hqa9apd,+:
8jrl]ene`93b,4^211),524)0423)^5`0)a.,`3^-a5^/5j]ia9_e`n±
[japi]ogr]hqa9.0+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
8iap][]ppne^qpaoe`9eO?OE[p]ncap[EL[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9eO?OE[p]ncap[EL[iap]]ppn[p]ncap[nkhaj]ia9p]ncap±
[nkhar]hqa9op]npa`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8+lneiepera:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
189
8lneieperae`9eO?OEp]ncap_h]oo9ho^pula9eo_oep]ncap±
lnkre`an9da]np^a]p:
8iap][]ppne^qpaoe`9eO?OEp]ncap[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9eO?OEp]ncap[iap]]ppn[p]ncap[nkhaj]ia9p]ncap±
[nkhar]hqa9op]npa`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8+lneiepera:
8+cnkql:
8+naokqn_ao:
8_kjopn]ejpo+:
8+_kjbecqn]pekj:
Now it’s time to have a closer look at what exactly you have written to the backup file. 
You will see that in the cluster configuration, there are the following four different parts. 
Because the output of this command gives you the contents of the _e^*tih file, it has the 
same parts as the _e^*tih file in  Listing 7-15, discussed earlier in the chapter.
 s  _ni[_kjbec: Contains  time- out values and other generic settings for your cluster. 
You haven’t configured any yet, so you shouldn’t see much here. 
 s  jk`ao: List the nodes that currently are in the cluster. It should contain both nodes 
you’ve added and a unique node ID for each of them. 
 s  naokqn_ao: Contains the resources that you’ve just created with d^[cqe. This is the 
most interesting part of the cluster configuration.
 s  _kjopn]ejpo: Contains rules that specify where and how resources can be used. 
Because you haven’t created any constraints yet, this part should be empty as well. 
You can manage each of these parts by using the _e^]`iej command. Have a look 
at several examples of this command to get a better understanding of what it does. First 
consider this example:
_e^]`iej)@)knaokqn_ao)teo_oep]ncap*tih
In this example, _e^]`iej is used to manage the cluster information base (CIB), 
which is in the “untouchable” file _e^*tih. The option )@ indicates that a part of this 
configuration has to be deleted. The option )knaokqn_ao tells _e^]`iej it should work on 
the naokqn_ao section of the CIB. Similarly, you could have used )k_ni[_kjbec, )kjk`ao, 
or )k_kjopn]ejpo to work on those respective sections. Lastly, )teo_oep]ncap*tih tells 
_e^]`iej what exactly it has to do. In order to do it, _e^]`iej has to apply the contents of 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
190
the file eo_oep]ncap*tih. This XML file should contain the exact definition of the iSCSI tar-
get resources, which are the IP address and the iSCSI target itself. To create this file, you 
should edit the _hqopan*tih file that you’ve just created once more. Considering that the 
definition of each resource starts with 8lneiepera: and ends with 8+lneiepera:, the con-
tents of this file should look as shown in  Listing 7-19.
 Listing 7-19. An XML File Containing the Exact Definition of the iSCSI Target Resources 
nkkp<o]j-6z_]peo_oep]ncap*tih
8naokqn_ao:
8cnkqle`9klajokqn_ao]j:
8iap][]ppne^qpaoe`9klajokqn_ao]j[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9klajokqn_ao]j[iap]]ppn[p]ncap[nkhaj]ia9p]ncap±
[nkhar]hqa9opklla`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8lneieperae`9eO?OEp]ncap_h]oo9ho^pula9eo_oep]ncap±
lnkre`an9da]np^a]p:
8iap][]ppne^qpaoe`9eO?OEp]ncap[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9eO?OEp]ncap[iap]]ppn[p]ncap[nkhaj]ia9p]ncap±
[nkhar]hqa9op]npa`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8+lneiepera:
8lneieperae`9eO?OE[p]ncap[EL_h]oo9k_bpula9EL]``n.±
lnkre`an9da]np^a]p:
8ejop]j_a[]ppne^qpaoe`9eO?OE[p]ncap[EL[ejop]j_a[]ppno:
8]ppne^qpao:
8jrl]ene`9-0-,^2]-),10a)04`3)4_40)4-,1.-20.b-4j]ia9el+:
8jrl]ene`9-]a4^3^_),/]-)0b5,)^-05)1a4]]/0,]]03j]ia9je_±
r]hqa9apd,+:
8jrl]ene`9_1],5_3,)^a/])0//5)^/]`)`]_]1b0^0322±
j]ia9_e`n[japi]ogr]hqa9.0+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
191
8iap][]ppne^qpaoe`9eO?OE[p]ncap[EL[iap][]ppno:
8]ppne^qpao:
8jrl]ene`9eO?OE[p]ncap[EL[iap]]ppn[p]ncap[nkha±
j]ia9p]ncap[nkhar]hqa9opklla`+:
8+]ppne^qpao:
8+iap][]ppne^qpao:
8+lneiepera:
8+cnkql:
NCaution When making an XML file of resources that are part of a group, make sure to include the group 
information as well, as in  Listing 7-19. If you omit this information, the resources will not be placed in the 
group automatically when you restore them. 
Now that you have this XML file, try the second _e^]`iej)@ command:
_e^]`iej)@)knaokqn_ao)teo_oep]ncap*tih
If you still have the d^[cqe interface open, or look at the result of _ni[ikj)e-, you’ll 
see that the resources you’ve created earlier are removed immediately. Want to return 
them to your cluster configuration? Use the following command:
_e^]`iej)?)knaokqn_ao)teo_oep]ncap*tih
This will restore the cluster to its original state. I recommend that you always create 
a backup of your cluster after you are satisfied with the way it functions. Do this by using 
the following command:
_e^]`iej)M:z+_hqopan^]_gql*tih
This allows you to restore the cluster fast and easily, which you will be happy to know 
how to do just after you’ve accidentally removed the complete cluster configuration.
Configuring STONITH
So far so good. The cluster is up and running and the resources are behaving fine. There 
is one more thing that you need to know how to do to ensure that your cluster contin-
ues to function properly. Imagine a situation in which the synchronization link between 
your two servers gets lost. In that case, each node might think that the other node is 
dead, decide that it is the only remaining node, and therefore start servicing the cluster 
resources. Such a situation may lead to severe corruption on the DRBD and must be 
avoided at all times. 
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
192
The solution to avoid this situation is STONITH, which stands for “Shoot The Other 
Node In The Head.” On typical servers, STONITH functions by using the management 
boards that are installed in most modern servers, such as HP Integrated  Lights- Out 
(iLO) or Dell Remote Assistant Card (DRAC). The idea is that you configure a resource 
in the cluster that talks to such a management board. Only after a server has been 
“STONITHed” is it safe to migrate resources to another node in the network. You should 
in all cases create a STONITH configuration for your cluster. 
It would take an entire book to describe the configuration of all the STONITH 
devices. Thus, to enable you to set up STONITH even if you don’t have a specialized 
device, I’ll explain how to configure the SSH resource. This resource uses a network link 
to send an SSH odqp`ksj command to the other server. In real life you would never use 
this device, because it wouldn’t work in many cases in which it is needed (for instance, 
if the network connection is down), but for testing purposes and to get some STONITH 
experience, it is good enough. 
The following procedure shows you how to create the SSH STONITH device by using 
the _e^]`iej command and XML files. Alternatively, you could do the same using the 
d^[cqe interface. 
 
1. Make sure the ]p` process is installed and running. This is normally the case on 
Ubuntu Server. 
 
2. To use STONITH, you need to use some generic properties in your cluster. Create 
a file named _e^^kkpopn]l*tih and add the contents shown in  Listing 7-20.
 Listing 7-20. To Use STONITH, Your Cluster Needs Some Generic Properties
8_hqopan[lnklanpu[oape`9_e^^kkpopn]l:
8]ppne^qpao:
8jrl]ene`9^kkpopn]l),-j]ia9pn]joepekj)e`ha)peiakqpr]hqa92,+:
8jrl]ene`9^kkpopn]l),0j]ia9opkjepd)aj]^ha`r]hqa9pnqa+:
8jrl]ene`9^kkpopn]l),1j]ia9opkjepd)]_pekjr]hqa9na^kkp+:
8jrl]ene`9^kkpopn]l),2j]ia9ouiiapne_)_hqopanr]hqa9pnqa+:
8jrl]ene`9^kkpopn]l),3j]ia9jk)mqknqi)lkhe_ur]hqa9opkl+:
8jrl]ene`9^kkpopn]l),4j]ia9opkl)knld]j)naokqn_aor]hqa9pnqa+:
8jrl]ene`9^kkpopn]l),5j]ia9opkl)knld]j)]_pekjor]hqa9pnqa+:
8jrl]ene`9^kkpopn]l)-,j]ia9eo)i]j]ca`)`ab]qhpr]hqa9pnqa+:
8jrl]ene`9^kkpopn]l)--j]ia9`ab]qhp)naokqn_a)ope_gejaoo± r]hqa9EJBEJEPU+:
8+]ppne^qpao:
8+_hqopan[lnklanpu[oap:
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
193
 
3. You need another XML file that defines the STONITH resources. Create a file 
named opkjepd_hkjaoap*tih and add the contents shown in  Listing 7-21.
 Listing 7-21. The XML File that Defines the STONITH Resources
8_hkjae`9opkjepd[_hkjaoapchk^]hhu[qjemqa9b]hoa:
8ejop]j_a[]ppne^qpaoe`9opkjepd[_hkjaoap:
8]ppne^qpao:
8jrl]ene`9opkjepd[_hkjaoap),-j]ia9_hkja[jk`a[i]tr]hqa9-+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
8lneieperae`9opkjepd[_hkja_h]oo9opkjepdpula9atpanj]h+ood±
lnkre`an9da]np^a]p:
8klan]pekjo:
8klj]ia9ikjepknejpanr]h91opeiakqp9.,olnanam9jkpdejc±
e`9opkjepd[_hkja)kl),-+:
8klj]ia9op]nppeiakqp9.,olnanam9jkpdejce`9opkjepd[_hkja)kl),.+:
8+klan]pekjo:
8ejop]j_a[]ppne^qpaoe`9opkjepd[_hkja:
8]ppne^qpao:
8jrl]ene`9opkjepd[_hkja),-j]ia9dkopheopr]hqa9o]j-(o]j.+:
8+]ppne^qpao:
8+ejop]j_a[]ppne^qpao:
8+lneiepera:
8+_hkja:
 
4. You need to add the contents of these two XML files to the cluster. This causes 
the configuration to be written to the _e^*tih file, which is the heart of the clus-
ter and contains the complete configuration. Do this by using the following two 
commands:
_e^]`iej)?)k_ni[_kjbec)t^kkpopn]l*tih
_e^]`iej)?)knaokqn_ao)topkjepd_hkjaoap*tih
At this point your cluster is fully operational and well protected. Congratulations, you 
have successfully created an open source SAN!
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
194
Heartbeat Beyond the Open Source SAN
In this chapter you have learned how to set up an open source SAN using Heartbeat 
and a DRBD. This open source SAN is a good replacement for a SAN appliance. In many 
enterprise environments, such a SAN is used as the storage back end for a cluster. That 
means that you can very well end up with another cluster talking to your open source 
SAN. Such a cluster could, for example, guarantee that your  mission- critical Apache Web 
Servers are always up.  Figure 7-9 shows an example of what such a setup could look like.
 Figure 7-9. Example of a cluster using the open source SAN
The following procedure gives you a basic idea of what you need to do to set up such 
a  high- availability solution for your Apache Web Server. Just the general steps that you 
have to complete are provided here, not the specific details. Based on the information 
that you have read in this chapter, you should be able to configure such a cluster solution 
without too many additional details.
www.it-ebooks.info

CHAPTER 7 N   CREATING AN OPEN SOURCE SAN
195
 
1. Configure an iSCSI initiator on all nodes in the Apache cluster. This iSCSI initiator 
gives each node a new storage device, which, based on the existing configura-
tion that you have, could have the name +`ar+o`^. The interesting part is that the 
devices on both nodes refer to the same storage, so it really is a shared storage 
environment. 
 
2. From one node, create a partition on the shared storage device and put a file sys-
tem on it. For a busy Apache Web Server, XFS might be a very good choice (see 
Chapter 4 of Beginning Ubuntu Server for more information on file systems). On 
the other node, use the l]nplnk^a command to make sure that this node can see 
the new partition also.
 
3. Create the cluster by creating the +ap_+d]*`+d]*_b and +ap_+d]*`+]qpdgauo files. 
Use +qon+he^W20Y+da]np^a]p+d][lnkl]c]pa to copy the configuration to the other 
nodes, and start the cluster on both nodes. 
 
4. Start d^[cqe and configure a file system resource. You need this file system to be 
mounted on the directory that contains your Apache document root. The clus-
ter will make sure that the shared file system is mounted only on the server that 
also runs the Apache resource. Make sure that you specify the device that is used 
for the shared file system, the mount point as well as the file system type, when 
configuring this file system resource. You should also put it in a resource group, 
to ensure that it is bundled with the other resources you need to create for the 
Apache  high- availability solution.
 
5. Create an IPaddr2 resource, as described earlier in this chapter. This resource 
should provide an IP address to be used for the Apache cluster resource.
 
6. On both nodes, make sure that the Apache software is locally installed. You should 
also make sure that it is not started automatically from your server’s runlevel. 
 
7. Make a cluster resource for the Apache Web Server as well. The LSB resource type 
is easiest to configure, so I recommend using that. Start your cluster, and you will 
have a  high- availability Apache Web Server as well. 
Summary
In this chapter you have learned how to use  high- availability clustering on Ubuntu 
Server. This subject merits its own book, but at least you now should be able to set up an 
open source SAN using a DRBD, iSCSI, and Heartbeat. You should even be able to use 
this open source SAN for yet another cluster. In the next chapter you’ll start to do some 
advanced networking, by learning how to set up an LDAP server on Ubuntu Server. 
www.it-ebooks.info

197
C H A P T E R  8
Configuring OpenLDAP
Centralizing User Management
You can use the Lightweight Directory Access Protocol (LDAP) to manage user, group, 
and other configuration information in a centralized way. Centralized user management 
is the purpose for which LDAP is most commonly used. In such a configuration, one 
server is used as the LDAP server and contains all information that users need to log on to 
the network. From the client computers, users send their credentials to the LDAP server 
in order to authenticate. 
To set up an LDAP Directory server, you need to configure the LDAP Directory. This 
Directory contains all information that is required for users to log on to the network. The 
advantage of the LDAP Directory is that it is compatible with the X.500 standard, which is 
used by other Directory services as well. Some Directory services that use the X.500 stan-
dard are Microsoft Active Directory and Novell eDirectory. 
NNote To distinguish between an LDAP Directory and a directory in the file system, I’ll refer to an LDAP 
Directory with an uppercase D and to a file system directory with a lowercase d. 
Using the LDAP Directory
LDAP gives access to the Directory, a hierarchically structured database in which you 
can store different kinds of configuration data. In an  e-mail environment, for example, 
you can use the LDAP Directory to store usernames and their corresponding  e-mail 
addresses, thus setting up LDAP as a service to look up the  e-mail address for a given 
user. You can also store different configuration information in the LDAP, such as the con-
figuration of your DHCP servers or your DNS database. All this information is stored in 
a hierarchical structure.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
198
The LDAP hierarchy is created by using container objects, which are comparable to 
directories used in a computer file system. These containers are also referred to as Direc-
tory Components (DCs). These DCs are comparable to the domains in a DNS hierarchy, 
as in sss*o]j`an*bn, except the way you refer to them is a little different in LDAP. Whereas 
you would refer to sss*o]j`an*bn in DNS, you would refer to `_9sss(`_9o]j`an(`_9bn in 
LDAP. You’ll learn more about this later in this chapter.
In the Directory, you’ll find data about different items. In LDAP terminology, user-
names, group names, and printer records are referred to as entries, also known as objects 
or classes. For example, for each user that is created in the Directory, there is a user 
object. These objects are the building blocks of the LDAP Directory. Each has its own 
unique name, called the Distinguished Name (DN). This DN consists of the object name 
(Common Name = _j) and the names of the containers in which the object is stored. If, 
for example, the container `_9o]j`an(`_9bn includes a user object with the name hej`], 
the DN of this user would be _j9hej`](`_9o]j`an(`_9bn. 
All objects in LDAP have attributes. Each object has at least one attribute, which is 
the _j, but in almost all cases, objects have more than one attribute. For a user object, for 
example, these attributes could be the username, the  e-mail address, the telephone num-
ber, and a password. To be able to find attributes in LDAP, it is important that each has 
a correct value. For instance, you would expect an  e-mail address to have an  at- sign (<) in 
it, whereas this would not be the case for a telephone number. 
Some attributes are mandatory, whereas other attributes are not. For instance, if you 
want an LDAP user to be able to log in to a Linux server, that user would need all user 
properties that normally are in +ap_+l]oos` in the LDAP Directory.
All the information about user objects and their attributes is in the LDAP schema. 
This schema defines the object classes and their associated attributes. In a schema file, 
every object also gets its place in the ASN.1 structure. This structure, which is also used 
by the Simple Network Management Protocol (SNMP), gives every object a unique place 
in a management environment, thus making it possible to manage LDAP objects in a uni-
form way.  Listing 8-1 gives a partial example of the o_dai] file that is used to include user 
information in the LDAP Directory.
 Listing 8-1. In the Schema File, You Can Define Objects and Their Attributes
nkkp<iah6+ap_+h`]l+o_dai]_]pejapknclanokj*o_dai]
ejapknclanokj*o_dai]))EjapKncLanokj$NB?.354%
 KlajH@=L6lgc+h`]l+oanrano+oh]l`+o_dai]+ejapknclanokj*o_dai](r±
-*-4*.*/.,,4+,.+--./6.2605gqnpAtl 
Pdeoskngeol]npkbKlajH@=LOkbps]na8dppl6++sss*klajh`]l*knc+:*

?klunecdp-554).,,4PdaKlajH@=LBkqj`]pekj*
=hhnecdponaoanra`*

www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
199
Na`eopne^qpekj]j`qoaejokqn_a]j`^ej]nubknio(sepdknsepdkqp
ik`ebe_]pekj(]nalanieppa`kjhu]o]qpdkneva`^updaKlajH@=L
Lq^he_He_ajoa*

=_klukbpdeohe_ajoaeo]r]eh]^haejpdabehaHE?AJOAejpda
pkl)harah`ena_pknukbpda`eopne^qpekjkn(]hpanj]perahu(]p
8dppl6++sss*KlajH@=L*knc+he_ajoa*dpih:*

EjapKncLanokj$NB?.354%

@alaj`oqlkj
@abejepekjkb]jT*1,,=ppne^qpaPula]j`]jK^fa_p?h]oopkDkh`
QjebkniNaokqn_aE`ajpebeano$QNEo%WNB?.,35Y
$_kna*o_dai]%

=Oqii]nukbpdaT*1,,$52%QoanO_dai]bknqoasepdH@=Lr/WNB?..12Y
$_kna*o_dai]%

Pda?KOEJA]j`EjpanjapT*1,,O_dai]WNB?-.30Y$_koeja*o_dai]%
_]nHe_ajoa
Pdeoiqhper]hqa`beah`eoqoa`pkna_kn`pdar]hqaokbpdahe_ajoakn
naceopn]pekjlh]pa]ook_e]pa`sepd]jej`ere`q]h*
]ppne^qpapula$.*-2*40,*-*--/3/,*/*-*-
J=IA#_]nHe_ajoa#
@AO?#NB?.3546rade_hahe_ajoaknnaceopn]pekjlh]pa#
AMQ=HEPU_]oaEcjknaI]p_d
OQ>OPN_]oaEcjknaOq^opnejcoI]p_d
OUJP=T-*/*2*-*0*-*-022*--1*-.-*-*-1%
`al]npiajpJqi^an
?k`abkn`al]npiajppksde_d]lanokj^ahkjco*Pdeo_]j]hok^a
opne_phujqiane_$a*c*(-./0%kn]hld]jqiane_$a*c*(=>?+-./%*
]ppne^qpapula$.*-2*40,*-*--/3/,*/*-*.
J=IA#`al]npiajpJqi^an#
@AO?#NB?.3546e`ajpebeao]`al]npiajpsepdej]jknc]jev]pekj#
AMQ=HEPU_]oaEcjknaI]p_d
OQ>OPN_]oaEcjknaOq^opnejcoI]p_d
OUJP=T-*/*2*-*0*-*-022*--1*-.-*-*-1%
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
200
`eolh]uJ]ia
Sdaj`eolh]uejc]jajpnu(aola_e]hhusepdej]kja)hejaoqii]nuheop(ep
eoqoabqhpk^a]^hapke`ajpebu]j]iapk^aqoa`*Oej_akpdan]ppne)
^qpapulaooq_d]o#_j#]naiqhper]hqa`(]j]``epekj]h]ppne^qpapulaeo
jaa`a`*@eolh]uj]iaeo`abeja`bknpdeolqnlkoa*
]ppne^qpapula$.*-2*40,*-*--/3/,*/*-*.0-
J=IA#`eolh]uJ]ia#
@AO?#NB?.3546lnabanna`j]iapk^aqoa`sdaj`eolh]uejcajpneao#
AMQ=HEPU_]oaEcjknaI]p_d
OQ>OPN_]oaEcjknaOq^opnejcoI]p_d
OUJP=T-*/*2*-*0*-*-022*--1*-.-*-*-1
OEJCHA)R=HQA%
ailhkuaaJqi^an
Jqiane_kn]hld]jqiane_e`ajpebean]ooecja`pk]lanokj(pule_]hhu^]oa`
kjkn`ankbdenakn]ook_e]pekjsepd]jknc]jev]pekj*Oejchar]hqa`*
]ppne^qpapula$.*-2*40,*-*--/3/,*/*-*/
J=IA#ailhkuaaJqi^an#
@AO?#NB?.3546jqiane_]hhue`ajpebeao]jailhkuaasepdej]jknc]jev]pekj#
AMQ=HEPU_]oaEcjknaI]p_d
OQ>OPN_]oaEcjknaOq^opnejcoI]p_d
OUJP=T-*/*2*-*0*-*-022*--1*-.-*-*-1
OEJCHA)R=HQA%
***
When you install LDAP on Ubuntu Server, the schema is stored in different files. 
These files are stored in +ap_+h`]l+o_dai]. After installing a basic LDAP server, you’ll have 
a basic schema. If support for additional objects is required, you can extend this schema 
by installing additional schema files and loading them in LDAP. Later in this chapter you 
will learn how to do that.  Listing 8-2 shows the schema files that are installed by default. 
 Listing 8-2. The Schema Is Stored in Configuration Files Installed in /etc/ldap/schema
nkkp<iah6+ap_+h`]l+o_dai]ho
_khha_pera*o_dai]_koeja*o_dai]f]r]*o_dai]klajh`]l*h`eb
_kn^]*o_dai]`q]_kjb*o_dai]ieo_*o_dai]klajh`]l*o_dai]
_kna*h`eb`ujcnkql*o_dai]j]`b*o_dai]llkhe_u*o_dai]
_kna*o_dai]ejapknclanokj*h`ebjeo*h`ebNA=@IA
_koeja*h`ebejapknclanokj*o_dai]jeo*o_dai]
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
201
A generic file format is used to work with information in an LDAP environment. This 
format is known as the LDAP Data Interchange Format (LDIF). As an administrator, you 
will use LDIF to add information to the LDAP Directory. You’ll learn later in this chapter 
how to use a command as h`]lqoan]`` with an LDIF file as its input to add information to 
the LDAP Directory.
Introducing OpenLDAP
The LDAP implementation that is used on Ubuntu Server is OpenLDAP (dppl6++sss*
klajh`]l*knc). After you install OpenLDAP, several configuration files, commands, and 
daemons are copied to your server. Before you perform the actual installation, it’s a good 
idea to have an idea of the different components that are installed. 
The most important component of OpenLDAP is the oh]l` daemon (oh]l` stands for 
 stand- alone LDAP daemon). You have to start oh]l` to begin working with LDAP. Basically, 
oh]l` is your LDAP server. If more than one LDAP server is used in your network, you can 
choose to set up one of them as the master server and the other as the slave server. Addi-
tionally, you need to set up synchronization between these servers. This synchronization is 
implemented by using the ohqnl` daemon. Synchronization in such an environment is initi-
ated by the master server, and the ohqnl` process makes sure that changes applied on the 
master server are copied to all slave servers. 
To configure LDAP, you need to modify several configuration files located in the 
directory +ap_+h`]l. The most important configuration file is oh]l`*_kjb. In this file, you 
define all aspects of the oh]l` process. Apart from this file, +ap_+h`]l+o_dai] includes 
numerous files that comprise the LDAP schema.
Finally, as an administrator, there are various commands that you can use to work 
with LDAP. As said, all of these use LDIF as the input file format to change information in 
the Directory. The most important commands and their purpose are listed here (they are 
explained in more detail later in this chapter):
 s  h`]l]``: Add data to the Directory
 s  h`]lik`ebu: Change data in the Directory
 s  h`]l`ahapa: Remove data from the Directory
 s  h`]loa]n_d: Look for information in the Directory
On a Linux LDAP client, some additional modules are needed as well. First, there is 
joo[h`]l, the module that is installed to make it possible to refer to the LDAP server from 
the +ap_+joosep_d*_kjb configuration file. Another important module is l]i[h`]l, which 
is used by the Pluggable Authentication Modules (PAM) mechanism to refer to the LDAP 
user. Both modules are required to set up user authentication on LDAP.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
202
Configuring OpenLDAP
Following are the general configuration steps that you must follow to configure Open-
LDAP. Each step is described in detail in the subsections that follow.
 
1. Install the LDAP software.
 
2. Configure the LDAP server by modifying the +ap_+h`]l+oh]l`*_kjb file.
 
3. Start oh]l`.
 
4. Create an LDIF file and use h`]l]`` to add information to the LDAP database.
 
5. Use h`]loa]n_d to verify that your LDAP server is working.
 
6. (Optional) Set up replication using ohqnl` (not covered in this book).
Installing OpenLDAP
To install OpenLDAP, you need to install two packages: oh]l` and h`]l)qpels. Using root 
permissions, use the following command to install them:
]lp)capejop]hhoh]l`h`]l)qpeho
After installing the required software packages, this command also asks you to enter 
a password for the LDAP administrator. If you want to distinguish between local user 
administration and LDAP administration, make sure to use a different password as the 
root password (see  Figure 8-1).
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
203
 Figure 8-1. For LDAP administration, you can set up an LDAP administrator with its own 
password.
Configuring the Server
On Ubuntu Server, it is easy to create an initial configuration for your LDAP server. If you 
use the command `lgc)na_kjbecqnaoh]l`, a  menu- driven configuration procedure is 
started automatically. This configuration procedure makes sure that the appropriate con-
figuration is written to +ap_+h`]l+oh]l`*_kjb. This section first covers the configuration as 
performed with `lgc)na_kjbecqna and then goes into details about the oh]l`*_kjb file.
Using  dpkg- reconfigure for Initial Configuration
A very convenient way to start the initial OpenLDAP configuration is to use `lgc, as 
follows:
 
1. As root, enter the command `lgc)na_kjbecqnaoh]l` to start the  menu- driven con-
figuration procedure that helps you to create the +ap_+h`]l+oh]l`*_kjb file in an 
easy way.
 
2. The configuration program first asks if you want to omit OpenLDAP configuration. 
If you choose Yes here, the configuration program stops immediately and nothing 
will be changed, so choose No.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
204
 
3. Every LDAP configuration needs a base DN. This base DN typically uses the DNS 
name of your server and is the starting point of the LDAP configuration. You are 
not required to use the DNS name of your server here, but if you want integration 
between LDAP and DNS, entering your server’s DNS domain name here makes it 
a lot easier. By default, the configuration program reads the DNS domain name of 
your server automatically and applies that (see  Figure 8-2).
 Figure 8-2. To make LDAP use easier, the LDAP configuration is connected to the 
DNS configuration.
 
4. Next, you need an Organization Name. By default, the DNS domain name from the 
preceding step is used as the Organization Name, which typically is a good idea. 
So just press Enter to continue here. 
 
5. Enter the password for the LDAP administrator again. Use the same password that 
you used before and press Enter to proceed.
 
6. The configuration utility asks you which database back end you want to use (see 
 Figure 8-3). This is a rather important configuration step. The configuration util-
ity gives you a choice between two advanced databases types: Berkeley Database 
(BDB) and Hierarchical Database (HDB). Both are  transaction- based databases 
that use  write- ahead logging for optimal protection of the data. The only differ-
ence between the two is that HDB is a hierarchically structured database, whereas 
BDB is not. Because LDAP is also created in a hierarchical structure, it is a good 
idea to use the HDB format here. Both databases use a configuration file named 
+r]n+he^+h`]l+@>[?KJBEC in which you can put database configuration settings. 
These settings allow you to optimize performance of your database.  Listing 8-3 
gives the default contents of this file.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
205
 Listing 8-3. Add Configuration Parameters in /var/lib/ldap/DB_CONFIG to Optimize 
Performance of the LDAP  Back- end Database
nkkp<iah6+r]n+he^+h`]l_]p@>[?KJBEC
oap[_]_daoeva,.,53-1.,
oap[hg[i]t[k^fa_po-1,,
oap[hg[i]t[hk_go-1,,
oap[hg[i]t[hk_gano-1,,
 
 The default settings in this file do well for an LDAP server that doesn’t have too 
many objects. For instance, the basic cache size is 2 MB, and it can cache a maxi-
mum number of 1,500 objects. You will never reach these values if you create an 
LDAP server to handle authentication of 500 users. If, however, your LDAP server 
is used in an environment in which huge amounts of data have to be managed, 
you may benefit from increasing these values. See also i]j$1%oh]l`)d`^ for more 
information about database optimization.
 Figure 8-3. For optimal performance, LDAP uses a hierarchical  back- end database.
 
7. Next you are asked what you want to do with the LDAP database if you remove 
the oh]l`*_kjb file (see  Figure 8-4). Because the database makes sense only if 
a database configuration refers to it, it is a good idea to purge the database when 
the oh]l`*_kjb file is purged. In order to purge the LDAP configuration from your 
server, as root use ]lp)caplqncaoh]l`.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
206
 Figure 8-4. It is a good idea to purge the database when you purge the slapd 
configuration.
 
8. Because you have just specified how to create the new LDAP database, the con-
figuration utility needs to  re- create the database. Therefore, it now tells you that 
it has already found an old database (the one that was created when installing 
OpenLDAP) and warns you that this will be moved if you proceed. Because this is 
exactly what you want to happen, select Yes to continue. The old database will be 
moved to +r]n+^]_gqlo.
 
9. Specify whether or not you want to enable LDAP version 2 protocol support (see 
 Figure 8-5). By default, for security reasons, you don’t want to do that, unless you 
have an application that can’t handle LDAP version 3. If you don’t know, just dis-
able it here—you can always enable it again later. 
 
10. This completes the configuration of your oh]l` server. The configuration is now 
written to its configuration files and LDAP is restarted. 
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
207
 Figure 8-5. For security reasons, it is a good idea to disable LDAP version 2 support.
Tuning the slapd.conf Configuration File
You now have a decent oh]l` configuration in place. However, some aspects of the con-
figuration have not been handled yet. Take a look at the configuration file itself, shown in 
 Listing 8-4, to understand all that is happening in it. 
 Listing 8-4. The /etc/ldap/slapd.conf Configuration File
nkkp<iah6+ap_+h`]l_]poh]l`*_kjb
Pdeoeopdai]ejoh]l`_kjbecqn]pekjbeha*Oaaoh]l`*_kjb$1%bknikna
ejbkkjpda_kjbecqn]pekjklpekjo*

Chk^]h@ena_perao6
Ba]pqnaopklaniep
]hhks^ej`[r.
O_dai]]j`k^fa_p?h]oo`abejepekjo
ej_hq`a+ap_+h`]l+o_dai]+_kna*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+_koeja*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+jeo*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+ejapknclanokj*o_dai]
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
208
Sdanapdale`behaeolqp*Pdaejep*`o_nelp
sehhjkpopklpdaoanranebukq_d]jcapdeo*
le`beha+r]n+nqj+oh]l`+oh]l`*le`
Heopkb]ncqiajpopd]psanal]ooa`pkpdaoanran
]ncobeha+r]n+nqj+oh]l`+oh]l`*]nco
Na]`oh]l`*_kjb$1%bknlkooe^har]hqao
hkcharahjkja
Sdanapda`uj]ie_]hhuhk]`a`ik`qhao]naopkna`
ik`qhal]pd+qon+he^+h`]l
ik`qhahk]`^]_g[d`^
Pdai]teiqijqi^ankbajpneaopd]peonapqnja`bkn]oa]n_dklan]pekj
oevaheiep1,,
Pdapkkh)pdna]`ol]n]iapanoapopda]_pq]h]ikqjpkb_lq#opd]peoqoa`
bknej`atejc*
pkkh)pdna]`o-

Ola_ebe_>]_gaj`@ena_peraobknd`^6
>]_gaj`ola_ebe_`ena_perao]llhupkpdeo^]_gaj`qjpeh]jkpdan
#^]_gaj`#`ena_perak__qno
^]_gaj`d`^

Ola_ebe_>]_gaj`@ena_peraobkn#kpdan#6
>]_gaj`ola_ebe_`ena_perao]llhupkpdeo^]_gaj`qjpeh]jkpdan
#^]_gaj`#`ena_perak__qno
^]_gaj`8kpdan:

Ola_ebe_@ena_peraobkn`]p]^]oa-(kbpulad`^6
@]p]^]oaola_ebe_`ena_perao]llhupkpdeo`]p]^]ooaqjpeh]jkpdan
#`]p]^]oa#`ena_perak__qno
`]p]^]oad`^
Pda^]oakbukqn`ena_pknuej`]p]^]oa-
oqbbet`_9o]j`anr]jrqcp(`_9jh
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
209
nkkp`j`ena_perabknola_ebuejc]oqlanqoankjpda`]p]^]oa*Pdeoeojaa`a`
bknouj_nalh*
nkkp`j_j9]`iej(`_9o]j`anr]jrqcp(`_9jh
Sdanapda`]p]^]oabeha]nalduoe_]hhuopkna`bkn`]p]^]oa-
`ena_pknu+r]n+he^+h`]l
Pda`^_kjbecoappejco]naqoa`pkcajan]pa]@>[?KJBECbehapdabenop
peiaoh]l`op]npo*Pdau`kJKPkranne`aateopejc]jateopejc@>[?KJBEC
beha*Ukqodkqh`pdanabkna_d]jcapdaoaoappejcoej@>[?KJBEC`ena_phu
knnaikra@>[?KJBEC]j`naop]npoh]l`bkn_d]jcaopkp]gaabba_p*
Bknpda@a^e]jl]_g]casaqoa.I>]o`ab]qhp^qp^aoqnapkql`]papdeo
r]hqaebukqd]ralhajpukbN=I
`^_kjbecoap[_]_daoeva,.,53-1.,
OrajD]npcanalknpa`pd]pdad]`pkoappdeor]hqaej_na`e^hudecd
pkcapoh]l`nqjjejc]p]hh*Oaadppl6++^qco*`a^e]j*knc+/,/,13bknikna
ejbkni]pekj*
Jqi^ankbk^fa_popd]p_]j^ahk_ga`]ppdao]iapeia*
`^_kjbecoap[hg[i]t[k^fa_po-1,,
Jqi^ankbhk_go$^kpdnamqaopa`]j`cn]jpa`%
`^_kjbecoap[hg[i]t[hk_go-1,,
Jqi^ankbhk_gano
`^_kjbecoap[hg[i]t[hk_gano-1,,
Ej`atejcklpekjobkn`]p]^]oa-
ej`atk^fa_p?h]ooam
O]rapdapeiapd]ppdaajpnucapoik`ebea`(bkn`]p]^]oa-
h]opik`kj
?da_glkejppda>angahau@>`]p]^]oalanek`e_]hhuej_]oakbouopai
b]ehqna]j`pkolaa`oh]l`odqp`ksj*
_da_glkejp1-./,
Sdanapkopknapdanalhe_]hkcobkn`]p]^]oa-
nalhkcbeha+r]n+he^+h`]l+nalhkc
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
210
PdaqoanL]ooskn`^u`ab]qhp_]j^a_d]jca`
^updaajpnuksjejcepebpdau]na]qpdajpe_]pa`*
Kpdanoodkqh`jkp^a]^hapkoaaep(at_alppda
]`iejajpnu^ahks
Pdaoa]__aoohejao]llhupk`]p]^]oa-kjhu
]__aoopk]ppno9qoanL]ooskn`(od]`ksH]op?d]jca
^u`j9_j9]`iej(`_9o]j`anr]jrqcp(`_9jhsnepa
^u]jkjuikqo]qpd
^uoahbsnepa
^u&jkja
Ajoqnana]`]__aoopkpda^]oabknpdejcohega
oqllknpa`O=OHIa_d]jeoio*Sepdkqppdeoukqi]u
d]ralnk^haiosepdO=OHjkpgjksejcsd]p
ia_d]jeoio]na]r]eh]^ha]j`pdahega*
Jkpapd]ppdeoeo_krana`^upda#]__aoopk&#
=?H^ahkspkk^qpebukq_d]jcapd]p]olaklha
]naskjppk`kukq#hhopehhjaa`pdeoebukq
s]jpO=OH$]j`lkooe^hakpdanpdejco%pkskng
d]llehu*
]__aoopk`j*^]oa9^u&na]`
Pda]`iej`jd]obqhhsnepa]__aoo(aranukjaahoa
_]jna]`aranupdejc*
]__aoopk&
^u`j9_j9]`iej(`_9o]j`anr]jrqcp(`_9jhsnepa
^u&na]`
BknJapo_]laNk]iejcoqllknp(a]_dqoancapo]nk]iejc
lnkbehabknsde_dpdaud]rasnepa]__aoopk
]__aoopk`j9*&(kq9Nk]iejc(k9iknojap
^u`j9_j9]`iej(`_9o]j`anr]jrqcp(`_9jhsnepa
^u`j]ppn9ksjansnepa

Ola_ebe_@ena_peraobkn`]p]^]oa.(kbpula#kpdan#$_]j^ad`^pkk%6
@]p]^]oaola_ebe_`ena_perao]llhupkpdeo`]p]^]ooaqjpeh]jkpdan
#`]p]^]oa#`ena_perak__qno
`]p]^]oa8kpdan:
Pda^]oakbukqn`ena_pknubkn`]p]^]oa.
oqbbet`_9`a^e]j(`_9knc
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
211
As you can see, there are many comment lines that explain what happens in the 
oh]l`*_kjb file. Let’s go through the most important sections of it. 
Configuring Schema and Process Files
First, there are four lines that refer to the schema files that your LDAP server is going to 
use. You may notice that not all the files in +ap_+h`]l+o_dai] are referred to here. If there 
are additional files that you want to include in the schema, make sure to create an ej_hq`a 
line for all of them. 
Next, there are two lines that refer to status files your LDAP server maintains. Both 
files are in +r]n+nqj+oh]l`. The oh]l`*le` file maintains the current PID of your oh]l` 
server, and the oh]l`*]nco file contains a list of arguments that were passed to the Samba 
server when it was started. oh]l`*]nco may be useful for troubleshooting if your oh]l` 
server doesn’t behave the way it should. For example, your oh]l` server might be missing 
a required argument, in which case you can check oh]l`*]nco to find out which argu-
ments were used when starting the Samba server.  Listing 8-5 shows what the file should 
look like on a default installation of OpenLDAP.
 Listing 8-5. /var/run/slapd/slapd.args Shows with Which Parameters slapd Was Started
nkkp<iah6+r]n+nqj+oh]l`_]poh]l`*]nco
+qon+o^ej+oh]l`)cklajh`]l)qklajh`]l)b+ap_+h`]l+oh]l`*_kjb
Modifying Startup Parameters in /etc/init.d/slapd
To know which parameters it should start by default, the +ap_+ejep*`+oh]l` script, which 
is executed when your server boots to start the LDAP server, reads the configuration file 
+ap_+`ab]qhp+oh]l`. As you can see in  Listing 8-6, this file contains variables that define 
with which parameters the oh]l` service should be started.
 Listing 8-6. To Determine Its Startup Parameters, slapd Reads /etc/default/slapd
nkkp<iah6+ap_+`ab]qhp_]poh]l`
@ab]qhphk_]pekjkbpdaoh]l`*_kjbbeha*Ebailpu(qoapda_kileha`)ej
`ab]qhp$+ap_+h`]l+oh]l`*_kjb%*Ebqoejcpda_j9_kjbec^]_gaj`pkopkna
_kjbecqn]pekjejH@EB(oappdeor]ne]^hapkpda`ena_pknu_kjp]ejejcpda
_j9_kjbec`]p]*
OH=L@[?KJB9
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
212
Ouopai]__kqjppknqjpdaoh]l`oanranqj`an*Ebailpupdaoanran
sehhnqj]onkkp*
OH=L@[QOAN9klajh`]l
Ouopaicnkqlpknqjpdaoh]l`oanranqj`an*Ebailpupdaoanransehh
nqjejpdalnei]nucnkqlkbepoqoan*
OH=L@[CNKQL9klajh`]l
L]pdpkpdale`behakbpdaoh]l`oanran*Ebjkpoappdaejep*`o_nelp
sehhpnupkbecqnaepkqpbnki OH=L@[?KJB$+ap_+h`]l+oh]l`*_kjb^u
`ab]qhp%
OH=L@[LE@BEHA9
oh]l`jkni]hhuoanraoh`]lkjhukj]hhP?L)lknpo/45*oh]l`_]j]hok
oanre_anamqaopokjP?L)lknp2/2$h`]lo%]j`namqaopore]qjet
ok_gapo*
At]ilhaqo]ca6
OH=L@[OANRE?AO9h`]l6++-.3*,*,*-6/45+h`]lo6+++h`]le6+++
EbOH=L@[JK[OP=NPeooap(pdaejepo_nelpsehhjkpop]npknnaop]np
oh]l`$^qpopklsehhopehhskng%*Qj_kiiajppdeoebukq]na
op]npejcoh]l`re]okiakpdania]joknebukq`kj#ps]jpoh]l`jkni]hhu
op]npa`]p^kkp*
OH=L@[JK[OP=NP9-
EbOH=L@[OAJPEJAH[BEHAeooappkl]pdpk]beha]j`pd]pbehaateopo(
pdaejepo_nelpsehhjkpop]npknnaop]npoh]l`$^qpopklsehhopehh
skng%*Qoapdeobknpailkn]nehu`eo]^hejcop]npqlkboh]l`$sdaj`kejc
i]ejpaj]j_a(bknat]ilha(knpdnkqcd]_kjbecqn]pekji]j]caiajpouopai%
sdajukq`kj#ps]jppka`ep]_kjbecqn]pekjbeha*
OH=L@[OAJPEJAH[BEHA9+ap_+h`]l+jkoh]l`
BknGan^anko]qpdajpe_]pekj$re]O=OH%(oh]l`^u`ab]qhpqoaopdaouopai
gaup]^beha$+ap_+gn^1*gaup]^%*Pkqoa]`ebbanajpgaup]^beha(
qj_kiiajppdeoheja]j`_d]jcapdal]pd*
atlknpGN>1[GPJ=IA9+ap_+gn^1*gaup]^
=``epekj]hklpekjopkl]oopkoh]l`
OH=L@[KLPEKJO9
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
213
Configuring Logging
Next in oh]l`*_kjb, the line hkcharahjkja determines how logging should take place. 
As you can guess, by default, no logging happens at all. This is fine if your LDAP server 
works well, but if it doesn’t, you probably want to configure some more verbose logging. 
If you do, make sure to enable logging only periodically and switch it off if you don’t 
need it anymore. LDAP logging can be very verbose and eat up available disk space fast. 
 Table 8-1 provides an overview of available options.
 Table 8-1. Available loglevel Options
Option 
Use
pn]_a 
Traces function calls.
l]_gapo 
Debugs packet handling.
]nco 
 Enables heavy trace debugging. Also shows arguments of the different functions that 
are used. 
_kjjao 
Logs information about connection management.
>AN 
Prints out all packets sent and received.
behpan 
Gives information about search filter processing.
_kjbec 
Displays information about configuration file processing.
=?H 
 Shows what happens with regard to access control list processing. More information 
about LDAP ACLs is provided later in this section.
op]po 
 Shows information about connections, LDAP operations, and results. If you want to 
enable logging, this is the recommended log level. 
op]po. 
Shows what stats log entries were sent.
odahh 
Prints communication with shell back end.
l]noa 
 Gives information about LDAP entry parsing. This is useful if you need to debug why 
certain information cannot be provided by the LDAP server.
ouj_ 
Provides information about LDAP synchronization.
jkja 
Disables logging completely.
Following the log lines in oh]l`*_kjb are the ik`qhal]pd and ik`qhahk]` lines, which 
you can use to load additional modules (which I do not cover in this book). The next two 
lines in oh]l`*_kjb are of interest with regard to the performance of your LDAP server:
oevaheiep1,,
pkkh)pdna]`o-
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
214
oevaheiep1,, limits the number of entries returned for a search operation. If you 
want to export your LDAP database to LDIF files, this limit can be really annoying, 
because it doesn’t allow all the records in your database to be shown. Make sure to 
increase it as needed to get a complete list of all records. pkkh)pdna]`o- tells oh]l` to run 
one thread only, in which case you can’t benefit from a multicore environment if you 
have one. On a heavily used LDAP server that runs on a multicore architecture, increase 
the number of threads to the number of cores that you want to use simultaneously.
After the two lines that specify which database to use, the oqbbet line specifies the 
suffix your LDAP server should use. This is the base location in the hierarchical Directory 
where oh]l` will expect to see the entries in the database. By default, it has the name of 
the DNS container your server is in.
Next are a few settings that relate to the database that LDAP maintains. First, `^_kjbec
oap[_]_daoeva,.,53-1., defines the size of the LDAP cache, with a maximum of 2 MB. 
This is rather limited, and will cause performance problems if you are using a large LDAP 
database. If your server has enough RAM, make sure to update it. For instance, use the 
following to set it to 16 MB: `^_kjbecoap[_]_daoeva,-2333.-2,. 
Next, there are three lines that relate to locking: 
`^_kjbecoap[hg[i]t[k^fa_po-1,,
`^_kjbecoap[hg[i]t[hk_go-1,,
`^_kjbecoap[hg[i]t[hk_gano-1,,
These three lines set the number of objects that can be locked, or opened, simulta-
neously to a maximum of 1500. If that causes any problems, make sure to increase these 
parameters to something higher. The exact number you need depends on the use of your 
LDAP server.
Next in oh]l`*_kjb is another important  performance- related parameter, ej`at
k^fa_p?h]ooam. This option ensures that an index is created based on the object names 
in use. If you need to find objects based on a specific attribute on a regular basis, make 
sure to add an index entry for that attribute. For instance, ej`at_jam would add an index 
based on the common name of objects. 
Configuring ACLs
The last relevant part of the oh]l`*_kjb configuration file defines some ACLs. These 
specify which users can do what on your LDAP database. For instance, the line ]__aoopk
`j*^]oa9^u&na]` makes sure that anyone can read entries from the LDAP database. 
This default setting makes your LDAP server usable, but it also poses a potential security 
risk. To avoid that, make sure to configure your firewall in a way that only authorized 
users can connect to your LDAP server. 
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
215
Using ACLs in LDAP is not too hard. Each ACL has the following form:
]__aoopksd]pgej`]j`n]jcakb`]p]^usdkaraneo]hhksa`]__aoo*
In this example, first you specify the kind and range of data, which represents the 
objects you are giving rights to. For example, you can use an asterisk (&) here to allow 
access to everything, or use something like kq9Laklha(`_9o]j`anr]jrqcp(`_9jh to limit 
access. Second, you have to indicate who gets the access. You do this by using the LDAP 
name of the object you are granting access to. Third, you need to specify what type of 
access you are granting. The following types of access are available:
 s  jkja: No access is allowed.
 s  ]qpd: The specified user can use the object for authentication only.
 s  _kil]na: The specified user can compare property values of the object with a spe-
cific search string.
 s  oa]n_d: The specified user can search for information.
 s  na]`: The specified user can read all data.
 s  snepa: The specified user can modify all data.
When specifying to which data you want to give access, you can grant  object- level 
access or  attribute- level access. For instance, the following example gives user accounts 
rights to modify some properties of their account:
]__aoopk`j9*&(`_9o]j`anr]jrqcp(`_9jh]ppno9_j(oj(`ao_nelpekj(ca_ko
^uoahbsnepa
At this point, make sure that your LDAP server is up and running. Just by installing 
it, you have already ensured that it is started automatically when you boot your server. 
To make sure all new settings are used as well, use the following command to restart the 
oh]l` server: +ap_+ejep*`+oh]l`naop]np.
Adding Information to the LDAP Database
Now that the LDAP server is up and running, it’s time to add some information to the 
database. The way to do that is by creating an LDIF file. In this LDIF file, you define 
not only the objects that you want to create, but also all the properties these objects 
should have. Generally, that means a lot of typing to create something like a simple user. 
 Listing 8-7 shows a sample configuration file in which a user is created.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
216
 Listing 8-7. To Add Objects to the Database, Create and Import an LDIF File
nkkp<iah6z_]pat]ilha*h`eb
`j6kq9laklha(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6knc]jev]pekj]hQjep
kq6laklha
`j6kq9cnkqlo(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6knc]jev]pekj]hQjep
kq6cnkqlo
`j6qe`9hej`](kq9laklha(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6ejapKncLanokj
k^fa_p?h]oo6lkoet=__kqjp
k^fa_p?h]oo6od]`ks=__kqjp
qe`6hej`]
oj6pdkioaj
cerajJ]ia6hej`]
_j6hej`]pdkioaj
`eolh]uJ]ia6hej`]pdkioaj
qe`Jqi^an6-,,,
ce`Jqi^an6-,,,,
qoanL]ooskn`6l]ooskn`
ca_ko6
hkcejOdahh6+^ej+^]od
dkia@ena_pknu6+dkia+hej`]
od]`ksAtlena6)-
od]`ksBh]c6,
od]`ksS]njejc63
od]`ksIej64
od]`ksI]t6555555
od]`ksH]op?d]jca6-,433
i]eh6hej`]*pdkioaj<o]j`anr]jrqcp*jh
lkop]h?k`a6-./0
h6=iopan`]i
k6o]j`an
ik^eha6'/-$,%2tttttttt
dkiaLdkja6'/-$,%.tttttttt
pepha6Ouopai=`iejeopn]pkn
lkop]h=``naoo6
ejepe]ho6HP
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
217
`j6_j9at]ilha(kq9cnkqlo(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6lkoetCnkql
_j6at]ilha
ce`Jqi^an6-,,,,
Because this is the very first LDIF file that you are using, creating only the user 
account is insufficient. It is a good habit to put users and groups in their own container, 
so in this LDIF the containers are created first. Creating the containers first is mandatory, 
because otherwise there is no place in which to put the user and group accounts. You 
have to do this only in your first LDIF file, because once the containers are created, you 
can just use them in all upcoming LDIF files. 
After you define the LDIF file, you have to define the properties of the user object. 
The properties in the example LDIF file shown in  Listing 8-7 are  self- explanatory. In the 
last part of the LDIF file, you see that a group with the name at]ilha is added as well. 
Now that the LDIF file is created, it’s time to add its contents to the database. This is 
a simple  three- step procedure:
 
1. Stop slapd: +ap_+ejep*`+oh]l`opkl.
 
2. Add the content of the LDIF file: oh]l]``)hat]ilha*h`eb.
 
3. Restart the LDAP process: +ap_+ejep*`+oh]l`op]np.
The LDIF file is now imported. In the next section you’ll read how you can verify 
whether this worked properly. 
Using ldapsearch to Verify Your Configuration
Now that you have added a user to the LDAP Directory, it’s time to see if you can retrieve 
this information via a search. The h`]loa]n_d command from the package h`]l)qpeho will 
do that for you. In  Listing 8-8, h`]loa]n_d is used to get an overview of all information that 
is currently stored in the LDAP Directory.
 Listing 8-8. Use ldapsearch to Search the LDAP Directory
nkkp<iah6zh`]loa]n_d)t)^`_9o]j`anr]jrqcp(`_9jh
atpaj`a`H@EB

H@=Lr/
^]oa8`_9o]j`anr]jrqcp(`_9jh:sepdo_klaoq^pnaa
behpan6$k^fa_p_h]oo9&%
namqaopejc6=HH

www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
218
o]j`anr]jrqcp*jh
`j6`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6pkl
k^fa_p?h]oo6`_K^fa_p
k^fa_p?h]oo6knc]jev]pekj
k6o]j`anr]jrqcp*jh
`_6o]j`anr]jrqcp
]`iej(o]j`anr]jrqcp*jh
`j6_j9]`iej(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6oeilhaOa_qnepuK^fa_p
k^fa_p?h]oo6knc]jev]pekj]hNkha
_j6]`iej
`ao_nelpekj6H@=L]`iejeopn]pkn
laklha(o]j`anr]jrqcp*jh
`j6kq9laklha(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6knc]jev]pekj]hQjep
kq6laklha
cnkqlo(o]j`anr]jrqcp*jh
`j6kq9cnkqlo(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6knc]jev]pekj]hQjep
kq6cnkqlo
hej`](laklha(o]j`anr]jrqcp*jh
`j6qe`9hej`](kq9laklha(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6ejapKncLanokj
k^fa_p?h]oo6lkoet=__kqjp
k^fa_p?h]oo6od]`ks=__kqjp
qe`6hej`]
oj6pdkioaj
cerajJ]ia6hej`]
_j6hej`]pdkioaj
`eolh]uJ]ia6hej`]pdkioaj
qe`Jqi^an6-,,,
ce`Jqi^an6-,,,,
ca_ko6
hkcejOdahh6+^ej+^]od
dkia@ena_pknu6+dkia+hej`]
od]`ksAtlena6)-
od]`ksBh]c6,
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
219
od]`ksS]njejc63
od]`ksIej64
od]`ksI]t6555555
i]eh6hej`]*pdkioaj<o]j`anr]jrqcp*jh
lkop]h?k`a6-./0
h6=iopan`]i
k6o]j`an
ik^eha6'/-$,%2tttttttt
dkiaLdkja6'/-$,%.tttttttt
pepha6Ouopai=`iejeopn]pkn
lkop]h=``naoo6
ejepe]ho6HP
at]ilha(cnkqlo(o]j`anr]jrqcp*jh
`j6_j9at]ilha(kq9cnkqlo(`_9o]j`anr]jrqcp(`_9jh
k^fa_p?h]oo6lkoetCnkql
_j6at]ilha
ce`Jqi^an6-,,,,
oa]n_dnaoqhp
oa]n_d6.
naoqhp6,Oq__aoo
jqiNaolkjoao63
jqiAjpneao62
As you can see from this example, the h`]loa]n_d command returns not only the 
user account we’ve created, but also the name of the administrator, the group, and the 
containers that exist. The reason so much information is returned is that no filter has 
been applied. You can use h`]loa]n_d in a more restrictive way by applying a filter. For 
instance, in the example in  Listing 8-9, a filter is used so that only three properties are dis-
played for user hej`].
 Listing 8-9. Use ldapsearch to Display Specific Information Only
nkkp<iah6zh`]loa]n_d)t)^`_9o]j`anr]jrqcp(`_9jhqe`9hej`]ojcerajJ]ia_j
atpaj`a`H@EB

H@=Lr/
^]oa8`_9o]j`anr]jrqcp(`_9jh:sepdo_klaoq^pnaa
behpan6qe`9hej`]
namqaopejc6ojcerajJ]ia_j

www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
220
hej`](laklha(o]j`anr]jrqcp*jh
`j6qe`9hej`](kq9laklha(`_9o]j`anr]jrqcp(`_9jh
oj6pdkioaj
cerajJ]ia6hej`]
_j6hej`]pdkioaj
oa]n_dnaoqhp
oa]n_d6.
naoqhp6,Oq__aoo
jqiNaolkjoao6.
jqiAjpneao6-
When using h`]loa]n_d, you can use different  command- line options. The examples 
in Listings  8- 8 and  8- 9 show the most important options: 
 s  )t: Tells h`]loa]n_d not to make a Simple Authentication and Security Layer 
(SASL) connection, but rather to send information in plain text. I recommend 
using this option at all times, so that you don’t have to apply a complicated SASL 
configuration. 
 s  )^: Refers to the LDAP search base. This is the name of the container in which you 
have created all objects. 
Other options are not necessary, but, as you can see in the example from  Listing 8-9, 
may be useful anyway. To filter the output provided by h`]loa]n_d, just enter on the com-
mand line the names of the properties for which you want to see output.
Using LDAP Management Commands
There are a number of utilities that you can use in an OpenLDAP environment.  Table 8-2 
lists and describes all the utilities. Following that, you’ll find some examples of the most 
useful utilities (other than oh]l]`` and h`]loa]n_d, which you’ve already read about).
 Table 8-2. OpenLDAP Utilities
Utility 
Description
oh]l]_h 
 Tests whether ACLs are working by testing whether certain attributes are available, 
based on the ACL specifications that are applied in +ap_+h`]l+oh]l`*_kjb.
oh]l]`` 
Adds information from an LDIF file to an LDAP database.
oh]l]qpd 
 Tests whether a user can authenticate to LDAP with given authentication 
credentials.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
221
Utility 
Description
oh]l_]p 
 Converts information from the LDAP database to LDIF format. You can do the 
same using the h`]loa]n_d tool.
oh]l`j 
 Compares the LDAP DNs provided as a  command- line argument to see if they 
comply with the definitions in the LDAP schema.
oh]lej`at 
 Reindexes the indexes of your LDAP server. This is a very useful utility that you 
should apply after every major update to the contents of the LDAP database. 
oh]ll]oos` 
 Prompts the user for a password and then encrypts that password in such a way 
that it can be used with the h`]lik`ebu command, or as the nkkpls setting in oh]l`*
_kjb.
oh]lpaop 
Checks the sanity of the oh]l`*_kjb file.
h`]l]`` 
 Adds the contents of an LDIF file to the LDAP database. You can do the same using 
oh]l]``. 
h`]l_kil]na 
 Compares an entry in the LDAP database with entry information that is provided 
on the command line. 
h`]l`ahapa 
 Deletes information from the LDAP database. This command uses LDIF files as 
input.
h`]lik`ebu 
Modifies the contents of an LDAP database, based on LDIF input files.
h`]lik`n`j 
 Changes the relative DN, which normally is merely the object name in the LDAP 
database.
h`]ll]oos` 
Changes the password of an LDAP entry.
h`]loa]n_d 
Queries the LDAP database for information.
h`]lsdk]ie 
 Opens a connection to an LDAP server, binds, and then performs a sdk]ie 
operation. One of the interesting features of this command is that you do need 
to provide a username to authenticate to the LDAP server, which assumes that 
you already know who you are. 
Modifying Entries in the LDAP Database
This section describes how to modify information in the LDAP database, using h`]lik`)
ebu. This command needs an LDIF file as its input. This time, however, it refers to an LDIF 
entry that already exists. It is pretty easy to generate such an LDIF file, using h`]loa]n_d. 
Suppose you want to change the password of user hej`], created earlier in the 
chapter. The first step is to get the current definition of hej`] in LDIF format from the 
Directory and redirect that to a file. You can do this with the following command:
h`]loa]n_d)tHHH)^`_9o]j`anr]jrqcp(`_9jhqe`9hej`]:hej`]*h`eb
Next, change the contents you’ve just created in the LDIF file. Then, use h`]lik`ebu to 
apply the new information to the LDAP Directory:
h`]lik`ebu)t)@_j9=`iejeopn]pkn(`_9o]j`anr]jrqcp(`_9jh)S)bhej`]*h`eb
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
222
The option )t tells LDAP that you don’t want to use SASL secured authentication, )@
_j9=`iejeopn]pkn(`_9o]j`anr]jrqcp(`_9jh tells LDAP what administrator credentials you 
want to use, )S causes h`]lik`ebu to prompt for a password, and )bhej`]*h`eb makes sure 
the content of the file hej`]*h`eb is applied to the LDAP database.
Deleting Entries from the LDAP Database
The h`]l`ahapa command allows you to delete information from the LDAP database. The 
command accepts both LDIF files and  command- line arguments to indicate what exactly 
you want to remove. 
Suppose that you want to remove the user fkdj from your LDAP database. That 
would work with h`]l`ahapa)@_j9=`iejeopn]pkn(`_9o]j`anr]jrqcp(`_9jh)t)Sqe`9
fkdj(kq9laklha(`_9o]j`anr]jrqcp(`_9jh. Alternatively, instead of referring to the object 
you want to remove from the command line, you can create an LDIF file that contains 
a list of all objects that you want to remove, and then use )bukqn*h`eb to remove them all 
from the LDAP database. 
Changing a Password
Changing a password in an LDAP environment is not as easy as it is in a  stand- alone envi-
ronment, because the password must be stored in an encrypted way and you must tell 
the LDAP server exactly for whom you want to change the password and what credentials 
you want to use for that.  Listing 8-10 shows how h`]ll]oos` is used to change the pass-
word for user hej`].
 Listing 8-10. Use ldappasswd to Change a User Password
nkkp<iah6zh`]ll]oos`)t)@_j9]`iej(`_9o]j`anr]jrqcp(`_9jhX
)S)Oqe`9hej`](kq9laklha(`_9o]j`anr]jrqcp(`_9jh
Jasl]ooskn`6
Na)ajpanjasl]ooskn`6
AjpanH@=LL]ooskn`6
You can see that several options are used with h`]ll]oos` in this example. First, the 
option )t is used to tell LDAP you don’t want SASL. Next, )@_j9]`iej(`_9o]j`anr]jrqcp
(`_9jh is used to specify the name of the user whose credentials are used to change the 
password. As you can see, in this case I’m using the ]`iej user for that. Next, )S causes 
h`]ll]oos` to prompt for the password of user ]`iej, and )O causes h`]ll]oos` to prompt 
for the password of the user. Following that, you see the complete LDAP name of the user 
you want to change the password for. A very common mistake is to use the incorrect user 
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
223
ID, thereby causing an error. You can avoid errors by looking up the user ID you want to 
use with h`]loa]n_d first.
NNote A user can change their own password as well by using h`]ll]oos`. Just replace the ]`iej name 
as specified with the )@ option with the name of the user account. Every user by default has enough permis-
sions to change their own password.
Logging In to an LDAP Server
You can use LDAP for authentication. To do so, you first set up one LDAP server and pop-
ulate it with user accounts. Next, you tell all workstations that they have to authenticate 
with the LDAP server. To do this, you need to configure PAM. To enable other services 
to search the LDAP server as well when looking for information, you need to configure 
the +ap_+joosep_d*_kjb file. In this section, you’ll first learn how to set up PAM for LDAP 
authentication, and then learn how to configure joosep_d*_kjb.
Configuring PAM for LDAP Authentication
When authenticating, PAM is used. This is a system that tells all  authentication- related 
processes where they have to look for user accounts. The only condition is that the pro-
cess in question has to be linked against the he^l]i modules, which is the case for most 
utilities that work with user accounts.  Listing 8-11 shows how you can request this infor-
mation using the h`` command. In this example you can see that +^ej+hkcej uses the 
he^l]i and he^l]i[ieo_ libraries. That means that it is PAM enabled, which is good.
 Listing 8-11. Use ldd to Check Whether a Utility Works with PAM 
nkkp<iah6zh``+^ej+hkcej
hejqt)c]pa*ok*-9:$,t^3b,_,,,%
he^_nulp*ok*-9:+he^+pho+e242+_ikr+he^_nulp*ok*-$,t^3a`-,,,%
he^l]i*ok*,9:+he^+he^l]i*ok*,$,t^3a_3,,,%
he^l]i[ieo_*ok*,9:+he^+he^l]i[ieo_*ok*,$,t^3a_/,,,%
he^_*ok*29:+he^+pho+e242+_ikr+he^_*ok*2$,t^3`30,,,%
he^`h*ok*.9:+he^+pho+e242+_ikr+he^`h*ok*.$,t^3`3,,,,%
+he^+h`)hejqt*ok*.$,t^3b,`,,,%
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
224
If a utility is PAM enabled, it typically has a configuration file in +ap_+l]i*`. In this 
configuration file, the utility learns where it has to look for  authentication- related infor-
mation.  Listing 8-12 gives an overview of all configuration files that are installed on 
Ubuntu Server.
 Listing 8-12. To Tell PAM Where to Look for Authentication Sources, Each Service Can Have 
Its Own Configuration File
nkkp<iah6+ap_+l]i*`ho
]p`_kiikj)]__kqjp_kiikj)oaooekjhkcejlllood`
_dbj_kiikj)]qpd_nkjkpdanmq]cc]oq
_dod_kiikj)l]ooskn`d^icip`l]oos`o]i^]oq`k
The default configuration file for +^ej+hkcej is +ap_+l]i*`+hkcej, so it is in this con-
figuration file that you have to tell PAM to look for additional authentication sources. 
 Listing 8-13 shows its default contents.
 Listing 8-13. Use /etc/pam.d/login to Tell the Login Program Which Authentication Sources 
to Use
nkkp<iah6+ap_+l]i*`_]phkcej

PdaL=I_kjbecqn]pekjbehabknpdaOd]`ks\hkcej#oanre_a

Kqplqpo]jeooqabehalneknpka]_dhkcejlnkilp$Nalh]_aopda
EOOQA[BEHAklpekjbnkihkcej*`abo%*Qj_kiiajpbknqoa
]qpdnamqena`l]i[eooqa*okeooqa9+ap_+eooqa
@eo]hhksonkkphkcejoat_alpkjppu#oheopa`ej+ap_+oa_qnappu
$Nalh]_aopda\?KJOKHA#oappejcbnkihkcej*`abo%
]qpdnamqeoepal]i[oa_qnappu*ok
@eo]hhksokpdanpd]jnkkphkcejosdaj+ap_+jkhkcejateopo
$Nalh]_aopda\JKHKCEJO[BEHA#klpekjbnkihkcej*`abo%
]qpdnamqeoepal]i[jkhkcej*ok
OAHejqtjaa`opk^apdabenopoaooekjnqha*Pdeoajoqnaopd]p]ju
hejcanejc_kjpatpd]o^aaj_ha]na`*Sepdkqpkqppdeoepeolkooe^ha
pd]p]ik`qha_kqh`ata_qpa_k`aejpdasnkjc`ki]ej*$SdajOAHejqt
eo`eo]^ha`(pdeonapqnjooq__aoo*%
oaooekjnamqena`l]i[oahejqt*ok_hkoa
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
225
Pdeoik`qhal]noaoajrenkjiajp_kjbecqn]pekjbeha$o%
]j`]hok]hhksoukqpkqoa]jatpaj`a`_kjbec
beha+ap_+oa_qnepu+l]i[ajr*_kjb*

l]noejc+ap_+ajrenkjiajpjaa`ona]`ajr9-
oaooekjnamqena`l]i[ajr*okna]`ajr9-
hk_]har]ne]^hao]na]hokgalpejpk+ap_+`ab]qhp+hk_]haejap_d
na]`ejcpdeobeha&ej]``epekjpk+ap_+ajrenkjiajp&`kaojkpdqnp
oaooekjnamqena`l]i[ajr*okna]`ajr9-ajrbeha9+ap_+`ab]qhp+hk_]ha
Op]j`]n`Qj&t]qpdajpe_]pekj*
<ej_hq`a_kiikj)]qpd
Pdeo]hhkso_anp]ejatpn]cnkqlopk^acn]jpa`pk]qoan
^]oa`kjpdejcohegapeiakb`]u(ppu(oanre_a(]j`qoan*
Lha]oaa`ep+ap_+oa_qnepu+cnkql*_kjbpkbepukqnjaa`o
$Nalh]_aopda\?KJOKHA[CNKQLO#klpekjejhkcej*`abo%
]qpdklpekj]hl]i[cnkql*ok
Qj_kiiajp]j`a`ep+ap_+oa_qnepu+peia*_kjbebukqjaa`pkoap
peianaopn]ejopkjhkcejo*
$Nalh]_aopda\LKNPPEIA[?DA?GO[AJ=>#klpekjbnkihkcej*`abo
]osahh]o+ap_+lknppeia%
]__kqjpnamqeoepal]i[peia*ok
Qj_kiiajp]j`a`ep+ap_+oa_qnepu+]__aoo*_kjbebukqjaa`pk
oap]__aooheiepo*
$Nalh]_ao+ap_+hkcej*]__aoobeha%
]__kqjpnamqena`l]i[]__aoo*ok
Oapoqlqoanheiepo]__kn`ejcpk+ap_+oa_qnepu+heiepo*_kjb
$Nalh]_aopdaqoakb+ap_+heiepoejkh`hkcej%
oaooekjnamqena`l]i[heiepo*ok
Lnejpopdah]ophkcejejbkqlkjoq__aobqhhkcej
$Nalh]_aopda\H=OPHKC[AJ=>#klpekjbnkihkcej*`abo%
oaooekjklpekj]hl]i[h]ophkc*ok
Lnejpopdaikp`qlkjoq__aobqhhkcej
$Nalh]_aopda\IKP@[BEHA#klpekjejhkcej*`abo%
oaooekjklpekj]hl]i[ikp`*ok
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
226
Lnejpopdaop]pqokbpdaqoan#oi]eh^ktqlkjoq__aobqhhkcej
$Nalh]_aopda\I=EH[?DA?G[AJ=>#klpekjbnkihkcej*`abo%*

Pdeo]hok`abejaopdaI=EHajrenkjiajpr]ne]^ha
Dksaran(qoan`ah]hokjaa`oI=EH[@EN]j`I=EH[BEHAr]ne]^hao
ej+ap_+hkcej*`abopki]gaoqnapd]pnaikrejc]qoan
]hoknaikraopdaqoan#oi]eholkkhbeha*
Oaa_kiiajpoej+ap_+hkcej*`abo
oaooekjklpekj]hl]i[i]eh*okop]j`]n`
Op]j`]n`Qj&t]__kqjp]j`oaooekj
<ej_hq`a_kiikj)]__kqjp
<ej_hq`a_kiikj)oaooekj
<ej_hq`a_kiikj)l]ooskn`
OAHejqtjaa`opkejpanraja]phkcejpeiapkajoqnapd]ppdalnk_aoo
op]npoejpdalnklan`ab]qhpoa_qnepu_kjpatp*Kjhuoaooekjosde_d]na
ejpaj`a`pknqjejpdaqoan#o_kjpatpodkqh`^anqj]bpanpdeo*$Sdaj
OAHejqteo`eo]^ha`(pdeonapqnjooq__aoo*%
oaooekjnamqena`l]i[oahejqt*okklaj
In a PAM configuration file, there are four different kinds of modules that you 
can use:
 s  ]qpd: Handle validation of user accounts (authentication)
 s  ]__kqjp: Ensure that when a user tries to access certain resources, PAM checks if 
the user is authorized to access those resources at that time
 s  l]ooskn`: Relate to passwords
 s  oaooekj: Used to connect a user to authorized resources once the login procedure 
has been completed
Each of these module types can be used in four different ways:
 s  namqena`: Conditions in this module have to be met. If this is not the case, the rest 
of the PAM file will be processed, but access is denied anyway.
 s  namqeoepa: Like namqena`, but access is denied immediately.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
227
 s  oqbbe_eajp: If conditions in this module are met, the user gets access and other 
modules from the same module category will be ignored. Therefore, if you’re using 
oqbbe_eajp in one of the module categories, make sure that you first mention all 
modules that must be passed in all cases.
 s  klpekj]h: This module is not important for the authentication process. It is used to 
display the contents of text files.
The last part of a module configuration line refers to the module itself. These mod-
ules are in the directory +he^+oa_qnepu and each of them has its own meaning. (In my 
book Beginning Ubuntu Server Administration, I list the most important of these modules 
and their meaning.) To teach PAM about LDAP, you need to install the he^l]i)h`]l pack-
age, using ]lp)capejop]hhhe^l]i)h`ap. This enables a short configuration wizard that 
puts the right options in the file +ap_+h`]l*_kjb. This file is used as the default client con-
figuration file for LDAP.
The first screen of the configuration wizard asks you what the URI (Uni-
verse Resource Identifier) is for your LDAP server. This URI should look similar to 
h`]l6++-5.*-24*-*.,, to enable default nonsecure access to the LDAP server. Next, the 
wizard asks which LDAP protocol version you want to use. Following that, it asks if you 
want to allow password utilities to talk to LDAP, and if you want to make the local user 
root the administrator for LDAP as well. It’s a good idea to answer Yes to both questions. 
Next, the wizard asks if you have to log in to the database (which is LDAP) to get 
information from it. Because the basic ACLs that are installed by default don’t require 
this, you can safely answer No here. Following that, the wizard asks which LDAP 
account you want to use for management purposes. By default, this is the account 
_j9i]j]can(`_9at]ilha(`_9jap. You have to change this to match the current base DN of 
your LDAP server, so in the example in this chapter, it would be _j9]`iej(`_9o]j`anr]jrq
cp(`_9jh. Next, enter the password that you want to use for the root account, to complete 
the configuration. As a result, the client configuration file +ap_+h`]l*_kjb is created to 
redirect clients to the LDAP server.
Once the client file has been written, you can look at the PAM configuration files. 
As you may have noticed, PAM uses four files that contain common configuration set-
tings, one for each of the four kinds of modules. The names of these are _kiikj)]qth, 
_kiikj)]__kqnt, _kiikj)l]ooskrd, and _kiikj)oaooeon. Basically, these files are pretty sim-
ple.  Listing 8-14 gives an example of the contents of _kiikj)]qth, without the comment 
lines that are added by default.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
228
 Listing 8-14. Contents of the  common- auth PAM Configuration File
]qpdnamqeoepal]i[qjet*okjqhhkg[oa_qna
]qpdklpekj]hl]i[oi^l]oo*okiecn]paieooejckg
To have PAM look in LDAP as well, you should include a line that refers to LDAP in 
all four of the common files. In the files, you want to make sure that PAM first tries to 
connect to LDAP. If that is successful, PAM doesn’t need to look any further; if for some 
reason LDAP is not available, PAM next should try local authentication mechanisms. So, 
after modification, the _kiikj)]qpd file would look as shown in  Listing 8-15.
 Listing 8-15. Add a Line in All Four of the PAM Common Files to Check LDAP as Well
]qpdoqbbe_eajpl]i[h`]l*ok
]qpdnamqeoepal]i[qjet*okjqhhkg[oa_qna
]qpdklpekj]hl]i[oi^l]oo*okiecn]paieooejckg
After modifying all four of the PAM common files in +ap_+l]i*`, all services that use 
these files will be LDAP aware. An easy test to see if it works is to use oq to switch to one 
of the user accounts that does exist in LDAP, but doesn’t exist locally. If that works, your 
LDAP authentication works as well. 
Setting Up nsswitch.conf to Find LDAP Services
The joosep_d*_kjb file is used in the same specific  login- related situations in which PAM 
is used, but in a more generic way. The joo[h`]l package, installed earlier, enables you to 
include LDAP entries in joosep_d*_kjb. To make sure that via this mechanism the LDAP 
database is searched as well, you need to change the l]oos`, cnkql, and od]`ks lines as 
shown in  Listing 8-16.
 Listing 8-16. Change nsswitch.conf to Search LDAP
l]oos`6_kil]ph`]l
cnkql6_kil]ph`]l
od]`ks6_kil]ph`]l
These lines tell the operating system to look in the l]oos`, cnkql, and od]`ks files first 
and then, if the required information is not found there, to check LDAP next. It is com-
mon to modify joosep_d to look for user information only in LDAP, but all other search 
entries from joosep_d can be modified likewise. For example, you can also tell joosep_d to 
look in LDAP for  host- based information. 
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
229
After setting up joosep_d, you need to modify the +ap_+h`]l*_kjb file to tell the 
service where in LDAP it should look for the specific kinds of information you are refer-
ring to.  Listing 8-17 shows the sample lines that you can modify to reflect your specific 
configuration.
 Listing 8-17. In /etc/ldap.conf, Tell nsswitch Where in LDAP to Find Specific Information
NB?./,3^eoj]iejc_kjpatpo
Oujp]t6
joo[^]oa[TTT^]oa;o_kla;behpan
sdanao_klaeow^]oa(kja(oq^y
]j`behpaneo]behpanpk^a"#`sepdpda
`ab]qhpbehpan*
Ukq_]jkieppdaoqbbetac6
joo[^]oa[l]oos`kq9Laklha(
pk]llaj`pda`ab]qhp^]oa@J^qppdeo
i]uej_qn]oi]hhlanbkni]j_aeil]_p*
joo[^]oa[l]oos`kq9Laklha(`_9l]`h(`_9_ki;kja
joo[^]oa[od]`kskq9Laklha(`_9l]`h(`_9_ki;kja
joo[^]oa[cnkqlkq9Cnkql(`_9l]`h(`_9_ki;kja
joo[^]oa[dkopokq9Dkopo(`_9l]`h(`_9_ki;kja
joo[^]oa[oanre_aokq9Oanre_ao(`_9l]`h(`_9_ki;kja
joo[^]oa[japskngokq9Japskngo(`_9l]`h(`_9_ki;kja
joo[^]oa[lnkpk_khokq9Lnkpk_kho(`_9l]`h(`_9_ki;kja
joo[^]oa[nl_kq9Nl_(`_9l]`h(`_9_ki;kja
joo[^]oa[apdanokq9Apdano(`_9l]`h(`_9_ki;kja
joo[^]oa[japi]ogokq9Japskngo(`_9l]`h(`_9_ki;ja
joo[^]oa[^kkpl]n]iokq9Apdano(`_9l]`h(`_9_ki;kja
joo[^]oa[]he]oaokq9=he]oao(`_9l]`h(`_9_ki;kja
joo[^]oa[japcnkqlkq9Japcnkql(`_9l]`h(`_9_ki;kja
NNote There are two h`]l*_kjb files: +ap_+h`]l*_kjb is used by joosep_d*_kjb, and +ap_+h`]l+
h`]l*_kjb is used by PAM. By default, these two files do not have the same content. To avoid problems, 
I recommend putting all required settings in one of these files and creating in the other file a symbolic link to 
refer to that file.
www.it-ebooks.info

CHAPTER 8 N   CONFIGURING OPENLDAP
230
Testing LDAP Client Connectivity
Now that your LDAP client is set up properly, you can test whether it’s working. To do 
this, you can use the capajp command. By using this command, you can get information 
from a specific database source. For instance, if you use the command capajpl]oos`, the 
command shows you user accounts from all l]oos` sources. Because you have just set 
up joosep_d to look in +ap_+l]oos` as well as LDAP, the command displays user accounts 
from both sources. Comparing the output from the capajp command carefully with the 
output from +ap_+l]oos`, you will see that more is listed than just the contents of the 
+ap_+l]oos` file (provided that you have added user accounts to LDAP successfully).
Summary
In this chapter you have learned how to set up OpenLDAP. This service provides useful 
functionality, because it is a centralized solution for management of user accounts and 
other configuration. You have also learned how to set up OpenLDAP to enable LDAP user 
authentication. In the next chapter you’ll learn about Samba, another service that you 
can hook up to LDAP. 
www.it-ebooks.info

231
C H A P T E R  9
Integrating Samba
Making It Work with Windows
You may already have a Samba server up and running in your network. Many people 
do, because it’s such an easy and convenient solution to offer file sharing to Windows 
clients. Few people, however, have a Samba server that is integrated with other operat-
ing systems used in their environment. Achieving such integration is the focus of this 
chapter. In this chapter you’ll first read a short section on how to quickly and easily set 
up a simple Samba server that offers file sharing and nothing more. In that section you 
will use the oi^l]oos` command to add individual user accounts. Sure, that works, but 
it’s not a very sophisticated solution if you have many users to manage, because you 
need to create every user account twice.
Following the short introduction, there are three sections that explain how to truly 
integrate Samba in your network. The first section explains how to integrate Samba with 
LDAP, which is useful because it provides one centralized location from which you can 
manage user accounts. Next, you’ll read how to set up your Samba server as a Windows 
NT 4–style Primary Domain Controller (PDC). This solution explains how you can replace 
a current Windows NT 4 server with Samba without your users even noticing the change. 
The last section explains how to integrate Samba in Active Directory. It teaches you how 
to set up Samba as a member server in Active Directory. Currently, making it more than 
a member server still isn’t possible, because Samba version 4, which is supposed to make 
that possible, is not in a stable state yet.
Setting Up Samba the Easy Way
In this section you’ll learn the easy way to set up Samba. It explains how you can define 
a share and create a Samba user that has access to this share. At the end of this section, 
you’ll learn how to test whether this share is working properly. 
Setting up Samba the easy way involves the following general steps, each of which is 
explained in detail in the sections that follow:
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
232
 
1. Create a local directory to share.
 
2. Set permissions on this directory.
 
3. Configure oi^*_kjb to define the share.
 
4. Create a Samba user account.
 
5. Test access to the share.
Creating a Local Directory to Share
So what exactly is a share? Basically, it is a directory on the local Linux file system that 
is accessible over the network. To create such a share, the first step is to create a local 
directory. This is as easy as applying the ig`en command. So, assuming you want to 
share a local directory with the name +od]na, simply use ig`en+od]na to create the local 
directory.
Applying Permissions to the Local Directory
When working with Samba, you need to make sure that the appropriate permissions are 
applied to the share. These permissions are granted to a local user account. You can grant 
permissions the easy way, by just entering the command _dik`333+od]na, but I don’t 
recommend doing that. It is much better to create a dedicated group in Linux and make 
members of that group all users to whom you want to give access to the share. Assuming 
that the name of this group is o]i^]cnkql, you use _dcnlo]i^]cnkql+od]na to make that 
group the share owner. Once that is done, apply the permissions, granting full permis-
sions to the user owner and group owner and no permissions to others: _dik`33,+od]na. 
This creates a situation that is much more secure, because it ensures that other users can-
not access the share.
Defining the Share
Now that you have set up everything that is necessary on the local file system, you need 
to define the share in Samba. Before you can start setting it up, you must install it first. 
There are several packages that relate to the Samba file server. You can get a list of them 
by using the ]lpepq`aoa]n_do]i^] command.  Listing 9-1 shows the result of this com-
mand when applied to my test server.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
233
 Listing 9-1. aptitude search samba Provides an Overview of Available Samba Packages
nkkp<iah6z]lpepq`aoa]n_do]i^]
l`lou_k)o]i^])=qpki]pa]`iejeopn]pekjkb]__aoopko]i^]
la^kt)o]i^])a^kt)Behaod]nejc
lacnkqls]na)o]i^]]`iej)aCnkqlS]naO]i^]]`iejeopn]pekj]llhe_]pek
lco]i^]`)CPG'_kjbecqn]pekjpkkhbkno]i^]
eo]i^])]H]jI]j]can)hegabeha]j`lnejpanoanran
ro]i^])_heajp)
e=o]i^])_kiikj)O]i^]_kiikjbehaoqoa`^u^kpdpdaoanran
lo]i^])`^c)O]i^]`a^qccejcoui^kho
lo]i^])`k_)O]i^]`k_qiajp]pekj
lo]i^])`k_)l`b)O]i^]`k_qiajp]pekj$L@Bbkni]p%
louopai)_kjbec)o]i^])CQEbkni]j]cejco]i^]od]nao]j`qoano
To make sure that all packages are installed, use the following command:
]lp)capejop]hho]i^]`lou_k)o]i^]a^kt)o]i^]acnkqls]na)o]i^]]`iejco]i^]`±
oi^_heajpo]i^])_kiikjo]i^])`^co]i^])`k_o]i^])`k_)l`bouopai)_kjbec)o]i^]
NNote The preceding command is not appropriate for my server, because the base packages o]i^] and 
o]i^])_kiikj are already installed. However, it will install, in all situations, everything that is needed to 
operate a Samba server. I have also replaced the o]i^])_heajp package with oi^_heajp, because other-
wise the installer would tell me that two Samba client packages are available and ask which one I want to 
install. 
Now that all Samba packages have been installed, you can edit the general Samba 
configuration file +ap_+o]i^]+oi^*_kjb to define the share. In oi^*_kjb, there are two 
types of sections. The first type is the section Wchk^]hY, which contains global settings for 
your server. The second type consists of the different sections in which the individual 
shares are defined. You can recognize them by the name of the share, written between 
square brackets. For instance, to define a share for your directory +od]na, the section 
header would be Wod]naY. The definition of this share can be really simple, as shown in 
 Listing 9-2.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
234
 Listing 9-2. Defining a Share Isn’t Complicated
Wod]naY
_kiiajp9od]na``ena_pknu
na]`kjhu9jk
l]pd9+od]na
Of course, there are lots of other options that you can add to the share to make it fan-
cier, but basically, if you define the share in this fashion it will work. So save your settings, 
and the share will be accessible. It takes a maximum of one minute before the share will 
automatically appear.
You’ve now set up basic access to the share. Before continuing, it’s a good idea to 
check if it really works. You can do that by using the oi^_heajp)Hhk_]hdkop command, 
which shows a list of all available shares on the local machine. It prompts for a user pass-
word as well, but because no user credentials are needed to display a list of shares, you 
can just press Enter to proceed.  Listing 9-3 shows the output of this command.
 Listing 9-3. Use smbclient -L localhost to Get an Overview of All Available Shares
nkkp<iah6zoi^_heajp)Hhk_]hdkop
L]ooskn`6
@ki]ej9WIAHYKO9WQjetYOanran9WO]i^]/*,*.4]Y
Od]naj]iaPula?kiiajp
))))))))))))))))))))
lnejp @eogLnejpan@nerano
od]na@eogod]na``ena_pknu
EL? EL?EL?Oanre_a$iahoanran$O]i^](Q^qjpq%%
@ki]ej9WIAHYKO9WQjetYOanran9WO]i^]/*,*.4]Y
Oanran?kiiajp
))))))))))))))))
SkngcnkqlI]opan
))))))))))))))))
SKNGCNKQL
At this point, your share is up and running and available, so it’s time to proceed to 
the next step and create a Samba user account.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
235
Creating a Samba User Account
So why does a user need a Samba user account if they already have a Linux user account? 
To access a share, the user, who typically works on a Windows machine, needs to enter 
his credentials. When doing this from a Windows machine, the password that he enters is 
encrypted in the Windows way. The problem is that the Linux authentication mechanism 
doesn’t know how to handle this encryption. For that reason, the user needs a Samba 
user account that has a password that is encrypted the Windows way. 
The Samba user account must match an existing Linux user account. That means 
that you first have to create the Linux account and then create the Samba account. Yes, 
that means creating the same user twice. If you don’t like that solution, you need one 
of the advanced solutions, such as Samba integration with LDAP, described later in this 
chapter. 
To create a Samba account, you need to use the oi^l]oos` command. For instance, to 
create a user with the name hej`], use oi^l]oos`)]hej`]. The command will ask you to 
enter the Samba password twice, after which the Samba user account is created. 
Testing Access to the Share
Now that you have created the Samba user account, it’s time for a small test. Sure, you 
can do the test from Windows and make a connection to the share by entering the share 
name in the ++oanranj]ia+od]naj]ia format, but by doing that, you are introducing other 
factors that may fail as well. For instance, the Windows test may fail because of a mis-
configured firewall. At this point, we just want to know whether the Samba server is 
functioning the right way. Test it by using the ikqjp command: 
ikqjp)poi^bo)kqoanj]ia9hej`]++hk_]hdkop+od]na+ijp
If this command succeeds in mounting the Samba share on the +ijp directory, you 
have established that the Samba server is working. 
As an alternative way to test access to your share, you may use the oi^_heajp 
command. This command offers an interface that is pretty similar to the FTP cli-
ent  command- line interface; you can use lqp and cap to transfer files from and to the 
Samba shared directory from the oi^_heajp shell interface. To perform the same test on 
++hk_]hdkop+od]na, use oi^_heajp))qoan9hej`]++hk_]hdkop+od]na. If successful, this com-
mand opens a shell interface to the directory. Try for example the ho command to get 
a list of all files in the share.  Listing 9-4 shows an example of a short oi^_heajp session. 
In this example, user hej`] authenticates, uses ho to show a list of existing files, uses cap 
to download the file to her current directory, and finally uses mqep to close the oi^_heajp 
interface.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
236
 Listing 9-4. The smbclient Tool Is Similar to the FTP Client Interface
nkkp<iah6zoi^_heajp))qoan9hej`]++hk_]hdkop+od]na
L]ooskn`6
@ki]ej9WIAHYKO9WQjetYOanran9WO]i^]/*,*.4]Y
oi^6X:ho
*@,Sa`=qc-/,06/56/2.,,4
**@,Sa`=qc-/,06-16//.,,4
beha-,Sa`=qc-/,06/56/0.,,4
beha.,Sa`=qc-/,06/56/2.,,4
1,352^hk_gokboeva.,53-1.*0/5/5^hk_go]r]eh]^ha
oi^6X:capbeha-
cappejcbehaXbeha-kboeva,]obeha-$,*,g^+o%$]ran]caj]jg^+o%
oi^6X:mqep
With your Samba server up and running, now it’s time to integrate it with LDAP. 
Integrating Samba with LDAP
There are three tasks to accomplish if you want to integrate Samba with LDAP. First, you 
need to prepare Samba to talk to LDAP. Next, you have to prepare LDAP as well. Finally, 
you can tell Samba to use LDAP. 
Preparing Samba to Talk to LDAP
The major difference between the Samba configuration just discussed and integration 
with LDAP is in one line in the Wchk^]hY section of oi^*_kjb. The following line defines 
that, by default, passwords are stored in the Trivial Database (TDB) that Samba uses by 
default:
l]oo`^^]_gaj`9p`^o]i
This method works fine if you are using only one Samba server or if you are using 
Samba as a domain controller in an environment in which no backup domain control-
lers are available. If you are using Samba in a  larger- scale environment, you can write 
user account information to an LDAP database. To do that, you need to change the l]oo`^
^]_gaj` parameter to refer to an LDAP server. The following example would do that:
l]oo`^^]_gaj`9h`]lo]i
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
237
You have now prepared Samba to talk to LDAP. In the next section you’ll learn how to 
configure LDAP to talk to Samba as well.
Preparing LDAP to Work with Samba
To store Samba user information in the LDAP Directory, you have to prepare the LDAP 
Directory first. LDAP needs to know about the new Samba object classes that you are 
going to store in it, and you can teach OpenLDAP that by including the o]i^]*o_dai] file. 
After installing the Samba packages as explained in the preceding section, you will find 
this file in the directory +qon+od]na+a^kt)o]i^]+o]i^]*o_dama. Follow these steps to add 
this file to the LDAP environment:
 
1. Use _l+qon+od]na+a^kt)o]i^]+o]i^]*o_dai]+ap_+h`]l+o_dai] to copy the schema 
file to the directory in which LDAP expects it to be.
 
2. Open +ap_+h`]l+oh]l`*_kjb with an editor and make sure the following schema 
files are included:
O_dai]]j`k^fa_p?h]oo`abejepekjo
ej_hq`a+ap_+h`]l+o_dai]+_kna*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+_koeja*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+jeo*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+ejapknclanokj*o_dai]
ej_hq`a+ap_+h`]l+o_dai]+o]i^]*o_dai]
 
3. Restart the LDAP service, using +ap_+ejep*`+oh]l`naop]np.
At this point, you have extended the LDAP schema. By doing that, three different 
classes have been added:
 s  o]i^]@ki]ej: Used to store information that is used between Samba domain con-
trollers. You only need this class when setting up an environment with several 
domain controllers (see the section “Using Samba as a Primary Domain Control-
ler” later in the chapter).
 s  o]i^]O]i=__kqjp: Used to extend the user properties in LDAP to include Samba 
properties as well.
 s  o]i^]CnkqlI]llejc: Used to add properties that are necessary to make a normal 
Linux group a Samba group as well. 
By default, the Samba user has two password hashes that are stored in LDAP. If you 
do nothing, both of them are readable as plain text passwords. Therefore, when using 
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
238
LDAP as the password back end for Samba, you should make sure that only the Samba 
service has access to these passwords, by adding an ACL to LDAP. You can accomplish 
this by including the following code in +ap_+h`]l+oh]l`*_kjb:
]__aoopk]ppn9o]i^]JPL]ooskn`(O]i^]HIL]ooskn`
^u_j9]`iej(`_9o]j`anr]jrqcp(`_9jhsnepa
^u&jkja
Also, to increase performance, you should add some indexes to LDAP. This allows 
LDAP to find required information much faster. Make sure that the following indexes are 
added in +ap_+h`]l+oh]l`*_kjb:
ej`atqe`(_j(`eolh]uJ]ia(iai^anQe`am
ej`atqe`Jqi^an(ce`Jqi^anam
ej`ato]i^]OE@am(oq^
Finally, restart the LDAP service, using +ap_+ejep*`+oh]l`naop]np.
Telling Samba to Use LDAP
Now that the LDAP service is all prepared, you have to apply some modifications to 
+ap_+o]i^]+oi^*_kjb to tell it that it has to use LDAP. You need to explain where it can 
find the LDAP server, and you need to secure communications.
Connecting Samba to LDAP
First and foremost, you need to use the l]oo`^]_gaj` global parameter to tell Samba 
where to go for password information. This option takes a URI as an argument, telling 
Samba where it can find LDAP. For example, if the LDAP server is available at IP address 
-5.*-24*-*.,,, the parameter looks as follows:
l]oo`^^]_gaj`9h`]lo]i6h`]l6++-5.*-24*-*.,,+
This option tells Samba to go to the specified IP address to get password information, 
but what happens if this LDAP server goes down? There are two approaches to provide 
more redundancy:
 s  #ONFIGURE ,$!0 AS A RESOURCE IN A (EARTBEAT CLUSTER SEE #HAPTER  FOR MORE DETAILS ON (EARTBEAT	 )N SUCH A CONFIGURATION YOU STILL HAVE ONE ,$!0 SERVER ONLY BUT (EARTBEAT WILL MANAGE WHERE IT RUNS AND WILL MAKE SURE THAT IT IS HIGHLY AVAIL-
ABLE )F THE SERVER THAT CURRENTLY HOSTS ,$!0 GOES DOWN (EARTBEAT WILL START ,$!0 www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
239
somewhere else. The only implementation requirement is that you have to put 
the LDAP Directory and its configuration files on a shared storage device, so that 
another server, when it takes over the LDAP service, can still access the database 
and configuration. This is the solution that I prefer.
 s  )MPLEMENT ,$!0 REPLICATION USING THE ohqnl` process. When doing this, changes 
that are applied to the master LDAP server are replicated to the replica LDAP serv-
ers automatically. This could work also, but there is a disadvantage: the replica 
LDAP server is  read- only and therefore of limited use. If you choose this solution, 
you can refer to both LDAP servers using the l]oo`^^]_gaj` definition in oi^*_kjb:
l]oo`^^]_gaj`9h`]lo]i6h`]l6++-5.*-24*-*.,,h`]l6++-5.*-24*-*.-,
Configuring Secure Connections
Basically, your Samba server is now capable of connecting to LDAP, but there is a prob-
lem still: connections from Samba to LDAP are all in plain text. So if the LDAP Directory 
is not on the same server as the Samba daemon, you should apply security. The preferred 
method to do that is by including the h`]looh parameter in oi^*_kjb:
h`]looh9op]np[pho
Next, you need to tell Samba the identity of the administrator who has write per-
missions in LDAP. To do this, use the h`]l]`iej`j parameter in oi^*_kjb. You already 
created an ACL in LDAP to give the appropriate rights to manage user passwords to a user 
with the name ]`iej, so it makes sense to tell Samba as well that this ]`iej user is the 
administrator for all  LDAP- related stuff:
h`]l]`iej`j9_j9]`iej(`_9o]j`anr]jrqcp(`_9jh
At this point you must make sure that Samba knows what password to use for this 
LDAP administrator. To create a password, first restart Samba to enforce all changes so 
far, and then use oi^l]oos`)S to write the password. As this is the Samba password that 
is needed to connect to the LDAP server, the password is not written to LDAP, but rather 
to the +ap_+o]i^]+oa_napo*p`^ file. Make sure this file is not readable by normal users; the 
password is stored in a readable way in this file. In  Listing 9-5 you can see what happens 
when writing this password.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
240
 Listing 9-5. Use smbpasswd -W to Write the Password of the LDAP Administrator
nkkp<iah6zoi^l]oos`)S
Oappejcopkna`l]ooskn`bkn_j9]`iej(`_9o]j`anr]jrqcp(`_9jhejoa_napo*p`^
JasOI>l]ooskn`6
NapulajasOI>l]ooskn`6
Specifying Where to Put the Objects in LDAP
At this point, Samba knows all it has to know to get to LDAP for administration tasks. 
It’s time to proceed to the next part, in which you specify where in the LDAP Directory 
you want to create  Samba- related objects. Four parameters are required and the last is 
optional:
 s  h`]loqbbet: The base container in LDAP that you are working from.
 s  h`]lqoanoqbbet: The base container for user accounts. Like all following parame-
ters, the name of this container is written as a name that is relative to the container 
specified with h`]loqbbet.
 s  h`]li]_dejaoqbbet: The base container for machine accounts.
 s  h`]lcnkqloqbbet: The base container for group accounts.
 s  h`]le`i]loqbbet: Required if you want to use Winbind to get user infor-
mation from a Windows environment. Winbind creates SIDs, which in an 
 LDAP- integrated environment are stored in the container specified here.
At this point, you should have in the Wchk^]hY section of oi^*_kjb the information 
shown in  Listing 9-6.
 Listing 9-6. Summary of Parameters Required in smb.conf for LDAP Integration 
l]oo`^^]_gaj`9h`]l
h`]l]`iej`j9_j9]`iej(`_9o]j`anr]jrqcp(`_9jh
h`]loqbbet9`_9o]j`anr]jrqcp(`_9jh
h`]lqoanoqbbet9kq9laklha
h`]li]_dejaoqbbet9kq9i]_dejao
h`]lcnkqloqbbet9kq9cnkql
h`]le`i]loqbbet9kq9e`i]l
At this point you can restart your Samba server. It is now integrated with LDAP.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
241
Using Samba As a Primary Domain Controller
In a Windows environment, a domain is used to manage users for a group of computers. 
The only option to do this in a centralized way in NT 4 is to use domains. Since Windows 
2000, Active Directory has been introduced as a system that sits above domains. Samba 
cannot be configured as an Active Directory environment yet, so the best thing you can 
do if you want to work with a  domain- like environment is to configure Samba as an 
NT 4–style domain controller. This section gives some tips on how to do that. Be aware 
that setting up a  well- tuned, scalable domain environment requires extensive knowledge 
of the working of Microsoft networks. This goes far beyond the scope of this book, so 
in this section you’ll learn just about the basic requirements needed to set up a Samba 
domain. Consider this section an introduction to the subject matter only; for more infor-
mation consult the man pages or the documentation at dppl6++sss*o]i^]*knc.
Changing the Samba Configuration File
The first step in setting up a domain environment is to change the Samba configuration 
FILE PROPERLY  ,ISTING  SHOWS THE SETTINGS REQUIRED IN THE +ap_+o]i^]+oi^*_kjbWchk^]hY 
section.
 Listing 9-7. Samba Domain Controller Settings
Wchk^]hY
jap^ekoj]ia9OPJ
skngcnkql9QG
oa_qnepu9qoan
l]oo`^^]_gaj`9h`]lo]i6h`]l6++-5.*-24*-*.,,
hkckjo_nelp9!Q*^]p
`ki]eji]opan9uao
koharah91,
hk_]hi]opan9uao
lnabanna`i]opan9uao
`ki]ejhkckjo9uao
hkckjl]pd9XX!JXlnkbehaoX!Q
hkckj`nera9D6
hkckjdkia9XX!JX!Q
hkcejo_nelp9hkckj*_i`
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
242
WjaphkckjY
_kiiajp9JapskngHkckjOanre_a
l]pd9+dkia+o]i^]+japhkckj
cqaopkg9uao
na]`kjhu9uao
od]naik`ao9jk
WlnkbehaoY
_kiiajp9Qoanlnkbehao
l]pd9+dkia+o]i^]+lnkbehao
cqaopkg9jk
^nksoa]^ha9jk
_na]pai]og92,,
`ena_pknui]og9,3,,
 Table 9-1 summarizes the relevant parameters from the Wchk^]hY section of  Listing 
 -AKE SURE TO INCLUDE THE PARAMETERS FROM THE WjaphkckjY and WlnkbehaoY sections as 
THEY APPEAR IN  ,ISTING  BECAUSE YOU NEED THEM TO MAKE YOUR 3AMBA SERVER FUNCTION AS a PDC.
 Table 9-1. Parameters Specific for Domain Configuration
Parameter 
Description
jap^ekoj]ia 
 This parameter is the name that your server will have in the Microsoft network. 
oa_qnepu 
 This parameter specifies how security should be handled. If you want to con-
figure your server as a domain controller, set it to oa_qnepu9qoan. 
l]oo`^^]_gaj` 
 Use this parameter to specify in what kind of database you want to store user 
and group information. The most common values for this parameter are 
oi^l]oos`, p`^o]i, and h`]lo]i. The easiest way to configure your server is to 
use the p`^o]i option, which creates a local database on your Samba server. 
The most flexible way to configure it is to use the h`]lo]i option, although 
this does require the configuration of an LDAP server and makes things more 
complicated. If you want to set up your Samba environment with PDCs as well 
as BDCs, make sure to use the h`]lo]i option. 
hkckjo_nelp 
 For Windows users, you can create a Windows logon script in Samba. This 
parameter refers to the logon script, which is a batch file that is executed 
automatically when the user logs in. In this example, the Samba server checks 
if there is a script for your user that has the name of the user account, followed 
by *^]p. This script should be placed in the directory specified with the l]pd 
parameter in the WjaphkckjY share. 
`ki]eji]opan 
 This parameter tells the ji^` naming process that this server must be respon-
sible for maintaining browse lists in the complete network. These browse 
lists allow others in the network to view a complete list of all members of the 
Windows network. A domain controller should always be the domain master 
for your network.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
243
Parameter 
Description
hk_]hi]opan 
 This parameter defines which server is used as the local master browser. 
A domain master browser communicates with local master browsers, which 
are servers that are responsible for maintaining browse lists on local network 
segments. Apart from being the domain master, your Samba servers should be 
local master browsers as well.
koharah 
 Even if you specify that your server should be local master and domain master, 
this doesn’t really guarantee that it also will be the master browser. In a Win-
dows network, the master browser is selected by election. To increase the 
chances that your server will be the master browser, make sure to you use 
a value higher than /. for the koharah parameter. The highest value is the 
most likely to win the browser elections.
lnabanna`i]opan 
 Normally, browser elections happen only occasionally. Use this parameter to 
force a new browser election immediately when the Samba server comes up.
`ki]ejhkcejo 
Set this parameter to uao to make this server a domain controller. 
hkcejl]pd 
 This parameter specifies where the user’s profile directory is found. To make 
this work, make sure that the WlnkbehaoY share is properly set up. In this 
para meter, the variable !J is used to refer to the local server name, and !Q is 
used to refer to the home directory of the current user.
hkckj`nera 
 This parameter provides for the user a drive letter that can be used as the 
logon drive.
hkckjdkia 
Use this parameter to specify where the home directory is located.
As you can see, you need to use many parameters to make sure that the Samba server 
is elected to be the master browser for your network. To configure a master browser, you 
need the ji^` service, which handles Windows naming to be started as well. This service 
is started automatically when you start Samba.
Creating Workstation Accounts
Now that you have your domain environment, you should add workstations to it. For 
every workstation that is going to be a member of a domain, you need a workstation 
account on the Samba server. Setting up a workstation account is similar to setting up 
a user account. First you need to add the account to the local user database on your 
server, and then you need to add the workstation account as a workstation to the Samba 
user database. Notice that the name of the workstation should end with a   sign, to indi-
cate that it is a workstation. To create a workstation with the name so-,, for example, first 
use qoan]``so-,  to create it in +ap_+l]oos`. Next, add the workstation to the oi^l]oos` 
file by using the oi^l]oos`)])iso-, command. Notice that in the oi^l]oos` command, 
there is no need to use the   to specify that it is a workstation; this is handled automati-
cally by the )i option. 
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
244
Integrating Samba in Active Directory
In its current version, you can’t make a Samba server an Active Directory domain control-
ler. Although the people in the Samba project team are working very hard to make this 
possible, they haven’t been successful yet. You can, however, make Samba a member 
server in an Active Directory (AD) domain. That means you still need Windows 200x serv-
ers to fulfill the role of domain controllers. 
The advantage of making Samba a member server in an AD domain is that users can 
log on to Active Directory and get access to all resources that are offered by the Samba 
server. There are two methods to connect Samba to Active Directory. The first method is 
to make Samba a member of the Active Directory domain, using simple passwords; the 
second method is to make Samba a member server in AD, using Kerberos authentication. 
Making Samba a Member of the Active Directory Domain
To integrate Samba with Active Directory, the first step is to make it a member of the 
domain. This is a relatively easy procedure that you have to accomplish partly on a Win-
dows server and partly on the Samba server:
 
1. Create user accounts for your users in Active Directory. Samba offers the 
resources, but in this setup, authentication is handled by Active Directory. So 
make sure that all users exist in Active Directory.
 
2. Create the Samba user as a Linux user and apply permissions for this user. So, you 
need one general Samba user on Linux, and you need to grant this user access 
permissions to the shared resources. You can grant these by using _dik`33, on the 
directory you want to share.
 
3. Modify the oi^*_kjb configuration file. The following options are required in the 
Wchk^]hY section to connect Samba to Active Directory:
Wchk^]hY
skngcnkql9J=IA[KB[=@[@KI=EJ
l]ooskn`oanran9EL[=@@NAOO[KB[=[.,,T[OANRAN
oa_qnepu9=@O
 
4. Add the Samba server to Active Directory. To do this, you need a computer 
account in Active Directory. Use the jap command on the Samba server to create 
this user account in Active Directory: jap]`ofkej)Q=`iejeopn]pkn!l]ooskn` will 
do the job for you (replace l]ooskn` with the actual password of the Active Direc-
tory administrator). The Samba account now appears in Active Directory. 
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
245
Using Kerberos to Make Samba a Member of Active Directory
In recent Windows versions, Microsoft has been focusing more on Kerberos authentica-
tion. Therefore, it is a good idea to use Kerberos on Samba as well. For more information 
about Kerberos, read Chapter 13. The advantage of using Kerberos is that it is never nec-
essary to send passwords over the wire; instead, authentication tickets are used, which is 
a much more secure method. Follow this procedure to set up Kerberos authentication:
 
1. Tell Samba that it should use Kerberos, by modifying the oi^*_kjb configuration 
file as follows:
Wchk^]hY
skngcnkql9UKQN[=@[@KI=EJ
na]hi9UKQN[=@[@KI=EJ*IOBP
]`ooanran9UKQN[=@[OANRAN
oa_qnepu9]`o
 
2. Get the initial Kerberos tickets. Use the gejep command, followed by the name 
of the Kerberos realm in the Active Directory environment: gejep]`iejeopn]pkn<
UKQN[=@[@KI=EJ*IOBP.
 
3. Add the Samba server to Active Directory. Use jap]`ofkej)Q
=`iejeopn]pkn!l]ooskn`. This adds your server to Active Directory, and because 
your server now knows how to use Kerberos, Kerberos will be used for secure 
communications. 
Authenticating Linux Users on Windows 
with Winbind
Up to now, I have assumed that your Linux users are defined in the Linux environment. 
This is not the most practical solution if you run a mainly Windows environment with 
some Linux users. In such an environment, it would be useful to maintain user accounts 
in Windows and redirect Linux users to Windows for authentication. Winbind helps 
you to do exactly that. The following procedure shows you how to set up a Winbind 
environment: 
 
1. Install the sej^ej` package by using ]lp)capejop]hhsej^ej`.
 
2. Create in Active Directory the user accounts you want to be able to authenticate 
on Linux.
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
246
 
3. On Linux, modify the +ap_+joosep_d*_kjb configuration file. In this file, you have to 
tell Linux that it should use Winbind before trying to authenticate locally on Linux. 
The following two lines will do that for you:
l]oos`6sej^ej`_kil]p
cnkql6sej^ej`_kil]p
 
4. Modify the PAM configuration. You should make sure that before getting to nor-
mal  Linux- based authentication, the user tries to authenticate on Windows. To 
make this happen, make sure that the line ]qpdoqbbe_eajpl]i[sej^ej`*ok is 
inserted as the first line in the files _kiikj)]qpd, _kiikj)]__kqjp, _kiikj)l]ooskrd, 
and _kiikj)oaooekj in +ap_+l]i*`.
 
5. Modify the oi^*_kjb configuration file. Because Winbind is related to Samba, 
it gets its configuration from oi^*_kjb. The code in  Listing 9-8 makes sure that 
a complete environment is created for users that come in through Winbind.
 Listing 9-8. Winbind Parameters in /etc/samba/smb.conf
Wchk^]hY
sej^ej`oal]n]pkn9'
sej^ej`_]_dapeia9-1
pailh]paodahh9+^ej+^]od
e`i]lqe`9-,,,,).,,,,
e`i]lce`9-,,,,).,,,,
pailh]padkia`en9+dkia+!Q
sej^ej`qe`9-,,,,).,,,,
sej^ej`ce`9-,,,,).,,,,
skngcnkql9UKQN[=@[@KI=EJ
 
6. Restart Winbind by running +ap_+ejep*`+sej^ej`naop]np.
 
7. Winbind should do its work now. To test if it works well, you can log in at the 
Linux prompt with a Windows user account. To do this, at the login prompt, use 
the full username, including the name of the Windows Domain. That means that 
you would log in with a username such as @KISEJ'hej`] (which is what user hej`] 
would use to log in to the domain @KISEJ). To separate the domain name and user-
name, you must use a ' sign between the two. 
www.it-ebooks.info

CHAPTER 9 N   INTEGRATING SAMBA
247
Summary
In this chapter you learned how to integrate Samba with Windows. After a short introduc-
tion on generic Samba basics, you read how to integrate Samba with LDAP. Basically, this 
offers a very nice solution in which Samba uses a hierarchical replicated database as its 
user configuration back end. Next, you read how Samba can offer PDC functionality to 
replace a Windows NT 4–style domain controller. In the last part of this chapter, you read 
more about the integration between Samba and Active Directory. You read how to make 
Samba a member server in Active Directory, and how to set up Winbind, which allows 
you to manage Linux users from Active Directory. In the next chapter you’ll learn how to 
set up Ubuntu Server as a mail server. 
www.it-ebooks.info

249
C H A P T E R  1 0
Configuring Ubuntu Server  
As a Mail Server
Sending and Receiving  
Mail Easily
One of the most common functions of a Linux system is to serve mail. Several 
 Linux- based mail server programs are available for this purpose. Several programs are 
available to accomplish this task. In this chapter you will learn what is necessary to build 
a solution to send and receive  e-mail on a network. Because Ubuntu Server uses the 
Postfix mail server by default to send mail to other networks, this chapter covers Postfix. 
Different solutions are available to allow users to connect to their mailboxes to fetch mail. 
One of the easiest to use of these solutions is Qpopper, so that is the solution of choice in 
this chapter. 
Understanding the Components of a Mail Solution
If you want to understand what is needed to build a mail server that can handle  e-mail for 
a complete network, you need to understand the three different agents that are used to 
process Internet  e-mail:
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
250
 s  Mail transfer agent (MTA): This is the software that sends  e-mail. This  e-mail is 
sent by the client that the user has used to compose and send the message. This 
recipient MTA sends the  e-mail to an MDA (defined next). Some  well- known 
MTAs are Postfix, Sendmail, and qmail. SMTP is an example of a protocol that can 
be used by an MTA to deliver  e-mail.
 s  Mail delivery agent (MDA): The MDA works together with the MTA on the server 
that is used by the recipient. The MDA makes sure the  e-mail is stored in a location 
in which the user can access it. Postfix comes with an integrated MDA as well.
 s  Mail user agent (MUA): After the mail is stored by the MDA, the MUA is the pro-
gram that the user uses to read the mail. The MUA can retrieve mail in several 
ways: by using a protocol such as IMAP or POP, remotely by using a file access 
protocol, or through access to local files. When the MUA uses IMAP or POP, there 
always is a server component (for example, Qpopper) and a client component that 
is used by the client. 
The core component of a mail solution is the MTA. This component makes sure that 
mail can be exchanged by hosts on the Internet. When sending mail on the Internet, the 
MTA analyzes the mail address of the recipient. This mail address includes a reference to 
the DNS domain used by the client. The MTA then contacts the authoritative DNS server 
of the recipient to find out which server is used as the MTA (“mail exchanger”) in that 
domain. When the MTA knows which server to contact, it sends the mail over to the MTA 
of the recipient’s domain. Once it arrives there, the MTA of the recipient checks whether 
the recipient is a user that exists on the local machine. If so, the mail is handed over to 
the MDA, which stores the mail in the mailbox of that user. If not, the MTA sends it to 
another MTA that helps to deliver the message to the mailbox of the recipient.
When the mail has been stored by the MDA in the mailbox of a local user, the user 
can access it in one of several ways, the most common of which is to use POP or IMAP. 
If the user uses POP, the mail is transferred to the user, but the user can choose to keep 
the message on the server instead. If IMAP is used, all messages are stored on the server 
and are not transferred to the client computer. When setting up a mailbox for a user, an 
administrator can choose to make it either a POP mailbox or an IMAP mailbox. In the fol-
lowing section you’ll read how to configure the Postfix MTA. After that, you’ll learn how 
to set up Qpopper and Cyrus IMAPd to receive mail messages.
Configuring the Postfix MTA
Postfix is a very modular mail server, comprising several programs that work together 
to make the Postfix mail server function. This is in contrast to Sendmail, an alternative 
UNIX MTA. The advantage of Postfix being a modular mail server is that it is easier for the 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
251
administrator to manage all individual programs that comprise the Postfix mail server. 
The disadvantage is that, as an administrator, you need to know how all these separate 
programs function. Wietse Venema originally developed Postfix as a mail server that 
would be easier to administer and more secure than Sendmail. Because it is monolithic, 
Sendmail is in general much harder to secure properly. Postfix also is a very rich mail 
server that has many features. 
NTip You can find a complete list of all Postfix features and instructions on how to configure them at 
dppl6++sss*lkopbet*knc+`k_qiajp]pekj*dpih. 
How Postfix works as a modular mail server becomes clearer from a discussion of 
how mail traffic is handled by Postfix, so that is presented first. After that, you will learn 
how to install and configure Postfix.
Handling Inbound and Outbound Mail
Generally speaking, Postfix can handle two kinds of mail: inbound mail and outbound 
mail. The inbound mail that Postfix handles may be messages sent from a local user to 
another local user or messages sent over the network to a local user. The outbound mail 
that Postfix handles may be messages intended for a recipient on the same server as the 
sender, messages intended for a recipient on a remote server, or undeliverable messages.
Processing Inbound Mail from a Local User to Another Local User
The following list explains how Postfix processes inbound mail, a graphical representa-
tion of which is shown in  Figure 10-1:
 
1. When Postfix receives mail that is sent by another local user, Postfix uses the 
lkop`nkl command to place the mail in the maildrop queue, to ensure that the 
mail stays on the same machine.
 
2. The le_gql daemon picks up the mail from the maildrop queue and checks 
whether the mail matches given rules regarding such things as the content, size, 
and other factors. 
 
3. The le_gql daemon passes the  e-mail to the _ha]jql daemon, which makes sure 
the mail is formatted in the proper way, by doing the following: 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
252
  s  2EPLACES MISSING HEADER LINES IN THE  EMAIL IF THE MAIL PROGRAM OF THE END USER didn’t do that already
  s  $ELETES DOUBLE RECIPIENT ADDRESSES
  s  5SES THE pnere]h)nasnepa daemon to convert the  e-mail address in the header 
into a name in the proper qoan<okia`ki]ej format, using the lookup tables 
found at +ap_+lkopbet+_]jkje_]h and +ap_+lkopbet+renpq]h (as covered in 
“Tuning Postfix with Lookup Tables” later in this chapter)
  s  2EFORMATS DATA IN THE HEADER ACCORDING TO ALL RULES THAT APPLY
 
4. The _ha]jql daemon copies the  e-mail to the incoming queue and sends a mes-
sage to the queue manager (micn) to notify it that this mail has arrived.
 Figure 10-1. Handling mail sent by a local user to another local user
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
253
Processing Inbound Mail Sent over the Network to a Local User
If incoming mail was received over the network, the process is slightly different from 
that presented in the preceding section, mainly because Postfix doesn’t need to use the 
lkop`nkl and le_gql daemons to handle mail sent over the network to a local user. The 
procedure is as follows (see  Figure 10-2):
 
1. Postfix first uses the oipl` process to handle mail coming in over the network. This 
process performs some basic checks on the  e-mail before handing it over to the 
_ha]jql daemon. 
 
2. The _ha]jql daemon performs the same tasks as when processing local mail (see 
the bulleted list in step 3 in the preceding section).
 
3. After the pnere]h)nasnepa daemon has done its work, the mail is placed in the 
incoming queue, where the queue manager takes further care of it. 
 Figure 10-2. Handling inbound mail coming from the same network
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
254
Processing Outbound Mail Intended for a Local User
Being the MTA, Postfix is responsible as well for processing outbound mail. Basically, all 
outbound messages are placed in the incoming queue first. From there, the procedure is 
as follows for outbound mail intended for a local user (see  Figure 10-3):
 
1. The queue manager (micn) picks up the mail from the incoming queue and places 
it in the active queue as soon as no other mail is in that queue. 
 
2. The pnere]h)nasnepa daemon determines where the mail should go: to a local user 
(the case here), to a user over the Internet, or to a UNIX user that uses UUCP to 
retrieve the mail (the latter method is somewhat primitive, so I don’t discuss it 
here). 
 
3. The pnere]h)nasnepa daemon kicks the mail back to the queue manager, which 
orders the local delivery service +qon+he^+lkopbet+hk_]h to put it in the mailbox of 
the local user. Before doing that, the local delivery service takes into account all 
aliases and forwarding rules that apply to the mail. 
 
4. The hk_]h daemon decides where to send the mail. It can, for example, send it to 
the lnk_i]eh system, which analyzes the mail and puts it in the right folder. 
 Figure 10-3. Processing mail for a local user
Processing Outbound Mail Intended for a User on a Remote System
When the mail is intended for a user on a remote system, the procedure is as follows (see 
 Figure 10-4):
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
255
 
1. Again, the queue manager fetches the mail from the incoming queue and copies it 
to the active queue as soon as it is empty. 
 
2. The pnere]h)nasnepa daemon checks whether the mail is for a local user (see the 
previous section) or a remote user (as in this example). If the mail is intended for 
a remote user, all lookup tables that apply to that user are checked and then the 
mail is passed to the queue manager.
 
3. The queue manager activates the SMTP service that delivers the  e-mail to the 
other server. 
 
4. The oipl` process uses DNS to find the MTA for the target host and delivers it that 
MTA.
 Figure 10-4. Delivering mail to remote users
Processing Undeliverable Mail
Finally, there is always a possibility that an  e-mail cannot be delivered by the queue man-
ager to either a local or a remote user. If that’s the case, micn puts the mail in the deferred 
queue. When it is in there, the queue manager copies it back to the active queue at regu-
lar intervals and tries again to deliver it, until either a defined threshold is reached or the 
mail is delivered successfully.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
256
Installing Postfix and Configuring the Initial Settings
To install Postfix, use ]lp)capejop]hhlkopbet. This command also launches a configura-
tion program in which you can enter the most important settings for your mail server. 
The following procedure describes the steps that this configuration program guides you 
through:
 
1. Specify what kind of mail server you want to configure. The following choices are 
available (see  Figure 10-5):
  s  No configuration: This option makes sure your current configuration is not 
touched.
  s  Internet Site: Use this option if your mail server is directly connected to the 
Internet and no intermediate mail servers are used.
  s  Internet with smarthost: Use this option if you don’t send out mail directly to 
THE )NTERNET BUT RATHER USE AN INTERMEDIATE HOST TO DO THAT 2ECEIVING MAIL CAN happen directly via SMTP or by using fetchmail.
  s  Satellite system: With this option, all mail goes through a smarthost, which 
handles the Internet connection for you.
  s  Local only: Use this option if there is no network connection and mail is han-
dled for local users only.
 Figure 10-5. To make configuring Postfix easier, the configuration program asks you 
what kind of mail server you are configuring.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
257
 
2. Enter the DNS domain name that should be used in the mail addresses of your 
users (see  Figure 10-6). For example, if you want the mail address of some user to 
be hej`]<at]ilha*_ki, the name you enter here should be example.com.
 Figure 10-6. Enter the DNS domain name for your mail server.
 
3. The Postfix files are copied to your server and the basic configuration is written. 
Once completed, your Postfix mail server is ready for further configuration.
Configuring Postfix Further
The initial configuration that you set up when installing Postfix works fine, but it isn’t 
very comprehensive. Therefore, right after you finish the initial configuration, I recom-
mend continuing the configuration by running `lgc)na_kjbecqnalkopbet. The following 
procedure describes how to configure Postfix from that interface:
 
1. The first two steps are exactly the same as the first two steps of the installation pro-
gram. Accept the values that you entered earlier.
 
2. The third screen asks you what to do with mail for the user’s lkopi]opan, nkkp, and 
other system accounts (see  Figure 10-7). It is a good idea to forward this mail, and 
you have to do that to an existing user. So enter the name of a user account here.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
258
 Figure 10-7. Mail for system accounts such as root and postmaster should be 
forwarded to an existing user account.
 
3. Specify for which mail domains this mail server should consider itself the final 
destination (see  Figure 10-8). Only domain names entered here will be accepted 
in user mail addresses. If your server is responsible for several domain names, you 
should enter all of them here. Also make sure to list hk_]hdkop, because you need it 
to handle mail between local users.
 Figure 10-8. Enter the DNS domain names of all domains your mail server is 
responsible for.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
259
 
4. If you are on a slow Internet connection, it is a good idea to force synchronous 
mail updates. Mail takes longer to come through, but less bandwidth is wasted. If 
mail is not processed synchronously and you are not using a journaling file sys-
tem, there is a chance you will lose mail. If you have a fast Internet connection 
and your server is using a journaling file system (which is true in almost all cases), 
select No, as shown in  Figure 10-9.
 Figure 10-9. If you are using a journaling file system on your server, choose No.
 
5. Tell Postfix for which networks it is allowed to forward (relay)  e-mail. By default, 
it does so only for its own IP address. If you are configuring this server as the local 
mail server for your network, make sure that you enter the IP address and subnet 
mask for that network in the screen shown in  Figure 10-10. So, for example, if you 
are on the local network -5.*-24*-*,, enter 192.168.1.0/24 here, to allow relaying 
for every IP address that starts with -5.*-24*-.
 
6. If you want to put a limit on the maximum size of local mailboxes, enter that limit, 
in bytes, in the screen shown in  Figure 10-11. If you don’t need a limit, keep the 
default value of 0.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
260
 Figure 10-10. Enter the IP address of your local network here to allow relaying.
 Figure 10-11. If you want to limit mailboxes to a maximum size, enter that limit here, 
specifying it in bytes. 
 
7. If you want to add an extension to the name of local recipients, add that extension 
in the screen shown in  Figure 10-12. By default, a + sign is added. If you don’t need 
such an extension, you can leave this field blank.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
261
 Figure 10-12. If you don’t need to use local address extensions, leave this field blank.
 
8. Specify which Internet protocols you want to use in Postfix (see  Figure 10-13). By 
default, it takes all protocols that are enabled on your server. If you just want to 
use IPv4, select only that protocol.
 Figure 10-13. By default, Postfix will use all enabled Internet protocols.
 
9. The settings you’ve specified are written to the Postfix configuration files and Post-
fix is restarted.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
262
You now have a functioning Postfix mail server. However, there are many options 
that you can still configure. In the following sections you’ll learn which options are avail-
able and which configuration file to change to modify these options.
Managing Postfix Components
The Postfix mail server consists of several components. First, on Ubuntu Server, you 
find the ejep script in +ap_+ejep*`, which you can use to start to the server, among other 
things. This script listens to all common arguments that can be used on most ejep scripts:
 s  op]np: Starts the server
 s  op]pqo: Displays the current status of the server
 s  nahk]`: Tells Postfix to reread its configuration files after changes have been 
applied
 s  naop]np: Stops and then restarts Postfix
 s  opkl: Stops the server
To troubleshoot a Postfix server, you must be aware of all the different components 
that are written to your server when Postfix is installed. Following is a list of all files and 
default directories that are created when installing Postfix (more details on the compo-
nents mentioned in this list are provided later in this chapter):
 s  +ap_+]he]oao: Contains aliases for local mail addresses. These aliases can be used 
to redirect to some other address mail that comes in on a given address. The initial 
configuration program has made sure that all mail that comes in for user nkkp is 
forwarded to the user account that you have specified.
 s  +ap_+lkopbet+: Contains all configuration files used by the Postfix mail server. 
Among them are the most important files, i]ej*_b and i]opan*_b, which contain 
all generic settings necessary to operate the Postfix mail server.
 s  +qon+he^+lkopbet+: Contains all binary components of the Postfix mail server. 
Some components mentioned in the section “Handling Inbound and Outbound 
Mail,” such as hk_]h and micn, are in this directory. The binaries in this direc-
tory are started when needed; there is no need for an administrator to start them 
manually.
 s  +qon+o^ej+: Contains all programs needed by the administrator to manage the 
Postfix mail server.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
263
 s  +qon+^ej+: Contains two symbolic links, i]ehm and jas]he]oao. Both refer to the 
+o^ej+atei0 program. They allow an administrator who is used to managing the 
Exim MTA to manage Postfix in an  Exim- like style.
 s  +r]n+olkkh+lkopbet+: Contains all queues used by Postfix. Also, if Postfix runs in 
a _dnkkp)f]il, this directory contains the subdirectories ap_ and he^ that contain 
necessary configuration files.
 s  +qon+od]na+`k_+lkopbet+: Contains some documentation for Postfix. 
Configuring the Master Daemon
Postfix is a modular service. In this modular service, one daemon is used to manage all 
other components of the Postfix server: the i]opan daemon +qon+he^+lkopbet+i]opan. This 
is the first process that is started when you activate the Postfix script from +ap_+ejep*`. To 
do its work, the i]opan daemon reads its configuration file +ap_+lkopbet+i]opan*_b, which 
includes for every Postfix process an entry that specifies how it should be managed. 
 Listing 10-1 provides an example of the top lines from this configuration file.
 Listing 10-1. Example Lines from /etc/postfix/master.cf

999999999999999999999999999999999999999999999999999999999999999999
oanre_apulalner]paqjlner_dnkkps]gaqli]tlnk__kii]j`']nco
$uao%$uao%$uao%$jaran%$-,,%

999999999999999999999999999999999999999999999999999999999999999999
oiplejapj)j))oipl`
oq^ieooekjejapj)j))oipl`
)koipl`[apnj[naopne_pekjo9nafa_p
)koipl`[_heajp[naopne_pekjo9laniep[o]oh[]qpdajpe_]pa`
***
le_gqlbebkj)j2,-miml`
_ha]jqlqjetj)j),le_gql
micnbebkj)j/,,-micn
***
nasnepaqjet))j))pnere]h)nasnepa
In the i]opan*_b file, all services that are a part of Postfix are specified by using some 
predefined fields. Following is a list of all fields and a summary of the values that you can 
use for these fields. Note that not all field options can be chosen randomly for the Postfix 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
264
components; if you are not absolutely sure of what you are doing, changing them is not 
recommended. The default values ensure that the processes will normally work just fine.
 s  oanre_a: Specifies the name of the process. Normally, just the name of the service 
is mentioned.
 s  pula: Specifies the connection type. The possible values are ejap if a TCP/UDP 
socket is used, qjet if a local UNIX domain socket is used for communication 
within the system, or bebk if it is a named pipe. 
 s  lner]pa: Specifies how the service can be accessed. Use u if the service must be 
accessible only from within the mail system; use j if you want to allow external 
access as well. Choosing j is required if the service is of the type ejap, because 
other wise you wouldn’t be able to access it.
 s  qjlner: Specifies whether or not the service will run with nkkp privileges. Use u to 
tell the component it should run with the privileges of the Postfix user account; 
use j to let the service run as nkkp.
 s  _dnkkp: Specifies whether or not the service should run in a _dnkkp environment. If 
set to u, the root path is normally set to +r]n+olkkh+lkopbet+, but an alternative root 
path can be set from +ap_+lkopbet+i]ej*_b.
 s  s]gaql: This option is relevant for only the le_gql daemon and the queue man-
ager, because they have to become active at regular intervals. For these daemons, 
provide a number. All other processes have the value ,, which disables the s]gaql 
feature. 
 s  i]tlnk_: Gets its value from the `ab]qhp[lnk_aoo[heiep value in +ap_+lkopbet+i]ej*
_b and determines the maximum number of instances of this process that can run 
simultaneously. The default is normally set to -,,.
 s  _kii]j`']nco: Defines what command must be activated with what arguments 
to run this component. The name of this command is relative to the directory in 
which the Postfix binaries are installed (+qon+he^+lkopbet). If you want the com-
mand to be verbose, make sure to include the )r option. 
Configuring Global Settings
Most of the settings that determine how Postfix does its work are set in the file +ap_+
lkopbet+i]ej*_b.  Listing 10-2 provides an example of its contents.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
265
 Listing 10-2. main.cf Defines How Postfix Should Do Its Work
nkkp<q^qjpq6+ap_+lkopbet_]pi]ej*_b
Oaa+qon+od]na+lkopbet+i]ej*_b*`eopbkn]_kiiajpa`(ikna_kilhaparanoekj
@a^e]jola_ebe_6Ola_ebuejc]behaj]iasehh_]qoapdabenop
hejakbpd]pbehapk^aqoa`]opdaj]ia*Pda@a^e]j`ab]qhp
eo+ap_+i]ehj]ia*
iuknecej9+ap_+i]ehj]ia
oipl`[^]jjan9 iudkopj]iaAOIPL i]eh[j]ia$Q^qjpq%
^ebb9jk
]llaj`ejc*`ki]ejeopdaIQ=#ofk^*
]llaj`[`kp[iu`ki]ej9jk
Qj_kiiajppdajatphejapkcajan]pa`ah]ua`i]ehs]njejco
`ah]u[s]njejc[peia90d
na]`ia[`ena_pknu9jk
PHOl]n]iapano
oipl`[pho[_anp[beha9+ap_+ooh+_anpo+ooh)_anp)oj]gakeh*lai
oipl`[pho[gau[beha9+ap_+ooh+lner]pa+ooh)_anp)oj]gakeh*gau
oipl`[qoa[pho9uao
oipl`[pho[oaooekj[_]_da[`]p]^]oa9^pnaa6 w`]p][`ena_pknuy+oipl`[o_]_da
oipl[pho[oaooekj[_]_da[`]p]^]oa9^pnaa6 w`]p][`ena_pknuy+oipl[o_]_da
Oaa+qon+od]na+`k_+lkopbet+PHO[NA=@IA*cvejpdalkopbet)`k_l]_g]cabkn
ejbkni]pekjkjaj]^hejcOOHejpdaoipl_heajp*
iudkopj]ia9q^qjpq*dkia*jh
]he]o[i]lo9d]od6+ap_+]he]oao
]he]o[`]p]^]oa9d]od6+ap_+]he]oao
iuknecej9+ap_+i]ehj]ia
iu`aopej]pekj9o]j`anr]jrqcp*_ki(hk_]hdkop
nah]udkop9
iujapskngo9-.3*,*,*,+4-5.*-24*-*,+.0
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
266
i]eh^kt[oeva[heiep9,
na_eleajp[`aheiepan9
ejap[ejpanb]_ao9]hh
ejap[lnkpk_kho9]hh
You can use many parameters in i]ej*_b. Some of the most useful parameters are 
listed and described here:
 s  _kii]j`[`ena_pknu: Specifies the directory in which the Postfix Administration tools 
are located. The default value is +qon+o^ej.
 s  `]aikj[`ena_pknu: Specifies the directory in which the Postfix daemon is located.
 s  ejap[ejpanb]_ao: Specifies where Postfix listens for incoming mail. The default value 
for this setting is the loopback UP address. If you want Postfix to listen on external 
interfaces as well, you must specify either the IP address to listen on or ]hh, the latter 
of which makes sure Postfix listens on all interfaces for incoming mail. 
 s  i]eh[ksjan: Specifies the user who is owner of the mail queue. By default, this is 
the user lkopbet.
 s  iu`aopej]pekj: Specifies a list of domains for which the server accepts incoming 
mail. If incoming mail is sent to a domain not listed here, it will be rejected.
 s  iujapskngo: Specifies which network is used as the local network. This setting is 
important, because other parameters (such as oipl`[na_eleajp[naopne_pekjo) rely 
on it.
 s  iu`ki]ej: Specifies the DNS domain of the computer that runs Postfix.
 s  iuknecej: Specifies the domain that appears as sender for  e-mails sent locally. By 
default, the fully qualified domain name (FQDN) of the host sending the mail is 
used. 
 s  mqaqa[`ena_pknu: Specifies the location of the directory in which the mail queues 
are held. The default location is +r]n+olkkh+lkopbet. 
 s  oipl`[na_eleajp[naopne_pekjo: Specifies which is the trusted network. Normally, 
the networks defined with the iujapskngo variable are considered trusted networks. 
Mail clients from this network are allowed to relay mail through your Postfix mail 
server, whereas other clients are not. 
 s  oipl`[oaj`an[naopne_pekjo: Specifies which senders should always be ignored, to 
prevent your server from accepting spam. The default value for this parameter is 
nafa_p[i]lo[n^h, which contains a default list of senders to reject.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
267
Configuring a Simple Postfix Mail Server
Enough settings, parameters, and variables for now. The interesting question is, what 
work do you really need to do to enable a simple Postfix mail server? We’ve already gone 
through the configuration module, so let’s see now if we can configure the mail server 
from the configuration files as well. In the scenario presented in this section, the simple 
mail server needs to send mail to the Internet for local users only. It also needs to be able 
to receive mail from the Internet, destined for users on the local domain. 
Sending Mail to Other Servers on the Internet
To make this procedure as easy as possible, the following instructions show how to for-
ward mail to the mail server of the Internet provider, which is a very common scenario:
 
1. Stop the Postfix server by using +ap_+ejep*`+lkopbetopkl.
 
2. Open +ap_+lkopbet+i]ej*_b in an editor and edit the following settings. Make sure 
to use the settings that are appropriate for your network.
  s  ejap[ejpanb]_ao9]hh: This line allows Postfix to work on all network interfaces of 
your server.
  s  iujapskngo9-5.*-24*-*,+.0: This line is an important security measure, because 
it tells Postfix which networks it should service.
  s  oipl[na_eleajp[naopne_pekjo9laniep[iujapskngo(nafa_p: This line tells Postfix 
to accept recipients only from the networks specified in the iujapskngo line.
  s  i]omqan]`a[`ki]ejo9ukqn`ki]ej*_ki: This line is used to make sure that all the 
names of all subdomains in your mail domain are linked to your DNS domain 
name.
  s  nah]udkop9dkop*ejpanjaplnkre`an*_ki: If you want to forward mail to the 
mail host of an Internet provider, this line identifies the host that is used for this 
purpose.
 
3. Save the file, close the editor, and restart Postfix by using the +ap_+ejep*`+lkopbet
op]np command. 
Accepting Mail from Other Servers on the Internet
Often, your mail server also needs to accept mail coming from the Internet that is sent 
to local users on your network. In such a configuration, it is very important that you set 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
268
up some basic protection. You want to prevent your mail server from being misused as 
an open relay by spammers. Also, the DNS system must know that your mail server is the 
responsible mail server for your domain. You can do this by adding an MX record in the 
DNS database. After you make the required modifications to DNS, you have to configure 
your mail server for (at least) three extra tasks:
 s  !CCEPT INCOMING MAIL THAT IS ADDRESSED TO YOUR DOMAIN
 s  2EJECT INCOMING MAIL THAT IS NOT ADDRESSED TO YOUR DOMAIN
 s  2EJECT MAIL FROM KNOWN SPAM SOURCES
To configure your mail server to receive mail from the Internet, follow this procedure:
 
1. Stop the Postfix server by using +ap_+ejep*`+lkopbetopkl.
 
2. Open +ap_+lkopbet+i]ej*_b with your favorite editor and edit the following set-
tings. Make sure to use the proper settings for your environment.
  s  ejap[ejpanb]_ao9]hh: Allows Postfix to receive and send mail on all network 
interfaces.
  s  iujapskngo9-5.*-24*-*,+.0(-.3*,*,*,+4: Specifies the IP addresses of the 
network(s) you are on.
  s  iudkopj]ia9iuoanran*iu`ki]ej*_ki: Specifies the fully distinguished DNS 
name of your host.
  s  iu`ki]ej9iu`ki]ej*_ki: Specifies the name of the DNS domain that your 
Postfix server is servicing.
  s  iu`aopej]pekj9 iudkopj]ia(hk_]hdkop* iu`ki]ej( iu`ki]ej: Identifies the 
hosts that should be handled by the MTA as its destinations. All other destinations 
will be rejected.
  s  i]lo[n^h[`ki]ejo9n^h)`ki]ejo*iu`ki]ej*_om: Works as very primitive spam 
protection to identify unauthorized servers.
  s  oipl`[oaj`an[naopne_pekjo9nafa_p[i]lo[n^h: Allows you to work with black lists, 
which are lists of servers that always should be denied use of this MTA for mail transfer.
  s  oipl`[na_eleajp[naopne_pekjo9laniep[iujapskngo(nafa_p[qj]qpd[
`aopej]pekj: Makes sure that only mail going to trusted networks, and to no other 
networks, is handled by your MTA.
 
3. Save the modifications you have made to the i]ej*_b file and start the Postfix pro-
cess again by using +ap_+ejep*`+lkopbetop]np. Your mail server is now ready to 
receive mail from the Internet. 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
269
Tuning Postfix with Lookup Tables
The main task of the Postfix mail server is to process mail. Based on the configuration you 
have created so far, your Postfix mail server is capable of doing so. You can also enhance 
the functionality of Postfix by applying rules. For this purpose, you can configure Postfix 
to use lookup tables. Many lookup tables are available, but none are created by default. 
For every lookup table that you want to use, you have to define it as a separate file in the 
directory +ap_+lkopbet and activate it from variables in the file +ap_+lkopbet+i]ej*_b. After 
defining the lookup table, you need to convert it to the proper format by using the lkopi]l 
command. In general, applying settings from a lookup table is a  three- step procedure:
 
1. 2EFER TO THE LOOKUP TABLE IN +ap_+lkopbet+i]ej*_b. For example, to indicate what 
file should be used for the oaj`an[_]jkje_]h lookup table, in +ap_+lkopbet+i]ej*_b, 
you would create the following line:
oaj`an[_]jkje_]h[i]lo9d]od6+ap_+lkopbet+oaj`an[_]jkje_]h
 
2. Edit the lookup table file (for example, +ap_+lkopbet+oaj`an[_]jkje_]h) with an edi-
tor and make all required modifications.
 
3. Use the lkopi]l command to write the lookup table in the appropriate format; for 
example, lkopi]ld]od6+ap_+lkopbet+oaj`an[_]jkje_]h.
All lookup tables are created according to the same syntax rules. It may not surprise 
you that a line starting with a  is not interpreted as a command line. Less obvious is that 
a line that begins with a space is regarded as a continuation of the previous line. You 
should therefore be very careful not to include any spaces in a line by accident. You can 
use the following lookup tables:
 s  ]__aoo: Use to deny or accept mail from given hosts.
 s  _]jkje_]h: Use to specify an address mapping for local and nonlocal addresses.
 s  na_eleajp[_]jkje_]h: Use to specify address mappings for the address of the recipi-
ent of a message. 
 s  nahk_]pa`: Use to provide information about a new location a user has moved to. 
 s  oaj`an[_]jkje_]h: Use to specify address mappings for the address of the sender of 
an outgoing or incoming mail message.
 s  pn]jolknp: Use to specify a mapping from a mail address to a message delivery or 
relay host. 
 s  renpq]h: Use to rewrite recipient addresses for all local, virtual, and remote mail 
destinations. This is not like the ]he]oao table, described next, which is used for 
local destinations only.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
270
The ]he]oao lookup table is the only lookup table that does not have a configuration 
file in +ap_+lkopbet; it is in the +ap_ directory instead. The purpose of the ]he]oao lookup 
table is to rewrite recipient addresses for local destinations. 
The following sections provide more information on the use of all these lookup 
tables. 
The access Lookup Table
You can use the ]__aoo lookup table to reject or allow messages from a list of defined 
senders. This table is evaluated by the oipl` daemon for all incoming messages. To 
activate this table, add the line oipl`[oaj`an[naopne_pekjo9d]od6+ap_+lkopbet+]__aoo 
to i]ej*_b. Then, in the +ap_+lkopbet+]__aoo file, you specify a list of mail addresses (in 
the first column) and an action for each mail address (in the second column). You can 
specify the  e-mail addresses as patterns. You can refer to an actual  e-mail address (okia)
kja<okiasdana*_ki), but you also can refer to complete or partial IP addresses or domain 
names. The following are the possible actions that you can specify for each mail address:
 s  jjjiaoo]ca: The  e-mail is rejected with a numerical code (jjj	 AS DEFINED IN 2&# 821, followed by the text message specified here.
 s  NAFA?P: The  e-mail is rejected with a generic error message.
 s  KG: The message is accepted.
 s  @EO?=N@: The message is discarded and no information is sent to the sender. 
An example of the contents of the ]__aoo lookup table follows:
iu`ki]ej*_kKG
ol]i<`nqco*_ki11,JkOl]i]hhksa`kjpdeooanran
-5*-01*,*-,NAFA?P
-*.*/NAFA?P
-*.*/*0KG
The canonical Lookup Table
The _]jkje_]h lookup table is very powerful: it rewrites both sender and recipient 
addresses of both incoming and outgoing mail. These addresses are rewritten not only 
in the header of your message, but also in the envelope. The _]jkje_]h lookup table is 
processed by the _ha]jql daemon. To activate this table, add the following line to +ap_+
lkopbet+i]ej*_b:
_]jkje_]h[i]lo9d]od6+ap_+lkopbet+_]jkje_]h
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
271
In the first column of the _]jkje_]h table, you specify addresses or domain names 
that should be rewritten. The second column of the _]jkje_]h table specifies the  e-mail 
address to which the mail has to be routed. An example of the contents of the _]jkje_]h 
table follows:
o]hao<iu`ki]ej*_kif`ka<iu`ki]ej*_ki
<saop*iu`ki]ej*_kiokiakja<iu`ki]ej*_ki
You should be aware that the _]jkje_]h lookup table works on both  e-mail recipients 
and senders. If you want to rewrite only recipient addresses or only sender addresses, use 
the na_eleajp[_]jkje_]h or oaj`an[_]jkje_]h lookup table, respectively, instead.
The recipient_canonical Lookup Table
The na_eleajp[_]jkje_]h table is used in the same way as the _]jkje_]h table to rewrite 
 e-mail addresses. Whereas the _]jkje_]h table works on both recipient and sender 
addresses, the na_eleajp[_]jkje_]h table is used just on recipient addresses of incoming 
and outgoing mail. The syntax of this table is exactly the same as the syntax of the _]jkje)
_]h table. To activate it, use the following entry in +ap_+lkopbet+i]ej*_b:
na_eleajp[_]jkje_]h[i]lo9d]od6+ap_+lkopbet+na_eleajp[_]jkje_]h
The sender_canonical Lookup Table
Whereas the na_eleajp[_]jkje_]h table is used to rewrite recipient addresses, the oaj`an[
_]jkje_]h table is used to rewrite sender addresses of incoming and outgoing mail. This 
table is read as well by the _ha]jql daemon, and you can activate the table by including 
the following in i]ej*_b:
oaj`an[_]jkje_]h[i]lo9d]od6+ap_+lkopbet+oaj`an[_]jkje_]h
The relocated Lookup Table 
When a user is no longer valid on your mail system, you can choose to just let the mail 
messages to that user bounce. As an alternative, you can send a reply to the sender of an 
incoming mail to that user, informing the sender where the user currently can be found. 
To activate the nahk_]pa` lookup table, add the following to i]ej*_b:
nahk_]pa`[i]lo9d]od6+ap_+lkopbet+nahk_]pa`
When processing mail, the oipl` daemon checks the nahk_]pa` file to see if there is 
a matching line. The first column in this file contains a reference to the  e-mail address 
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
272
of the former user. This may be the plain mail address of this user, or it may be a regu-
lar expression that makes sure that a series of mail addresses is matched. In the second 
column, there is an informational message. This can be just the new  e-mail address, but 
it can also include other information on how to contact the user. An example of the con-
tents of the nahk_]pa` table follows:
niehho<okiasdana*_kiniehho<jksdana*od
<jksdana*_kiPdeo_kil]ju`kaoj#pateop]juikna
hpdki]ooaj<okiasdana*_ki@kaoj#pskngdana]juikna
The transport Lookup Table
The main purpose of the pn]jolknp table is to route  e-mail messages. It makes a decision 
on incoming mail: is this message going to be processed by the local mail server, or by 
another mail server? To use this table, add the following to i]ej*_b:
pn]jolknp[i]lo9d]od6+ap_+lkopbet+pn]jolknp
The first column provides a description of the recipient address in the message. This 
can be a user (okiakja<okia`ki]ej*_ki) or a domain. If a domain is used, there is a differ-
ence between okia`ki]ej and *okia`ki]ej. The former is for messages that are sent just to 
that domain, whereas the latter includes its subdomains as well. Including information 
on subdomains is the default behavior, so it is normally not necessary to include them. 
The second column indicates how the message should be handled, using the notation 
pn]jolknp6jatpdkl. For pn]jolknp, possible values are hk_]h, oipl, or qq_l, specifying the 
method to use to contact the next hop. jatpdkl refers to the machine that should be con-
tacted to process this message. An example of the pn]jolknp table follows:
]saokia`ki]ej*_kioipl6it-*]saokia`ki]ej*_ki
jk`ki]ejqq_l6it-,
The virtual Lookup Table
To make sending messages to the right person easier to understand, the administrator 
can choose to use virtual domains. These can be considered subdomains of a real DNS 
domain. The virtual domain is a domain that does not really exist in DNS; it only exists on 
the MTA. When mail comes in for a user in the virtual domain, the renpq]h table makes 
sure it is delivered to the correct user in the real domain. To activate the renpq]h domain 
table, add the following to i]ej*_b:
renpq]h[i]lo9d]od6+ap_+lkopbet+renpq]h
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
273
The first line of the renpq]h domain file can be considered a header for the rest of 
the file. The first column of the first line lists the name of the virtual domain itself. In the 
second column, you can put a random description. In the subsequent lines, users in the 
virtual domain are specified in the first column. The second column mentions the name 
of the real user to whom the mail has to be forwarded. An example of the contents of 
a renpq]h domain table follows:
renpq]h`ki]ej*_kiokiapatp
fkdj<renpq]h`ki]ej*_kifkdj
qoan-<renpq]h`ki]ej*_kiguhea
qoan.<renpq]h`ki]ej*_kifqhea
The aliases Lookup Table
The ]he]oao lookup table is used to define aliases in the file +ap_+]he]oao; it is the only 
table that is not in +ap_+lkopbet, probably to maintain compatibility with the Send-
mail mail server, which can use the same file. To activate this table, add the following 
to i]ej*_b:
]he]o[i]lo9d]od6+ap_+]he]oao
The following is an example of the contents of the +ap_+]he]oao file. The use of X 
in front of the name of the user nkkp ensures that the mail is delivered to a local user, 
whereas all other names can exist on a network system like NIS or LDAP as well. Also note 
that the use of multiple aliases in the same aliases file is possible, which allows you to 
make the system more flexible. 
nkkp6Xnkkp(bn]j_g
i]ehan)`]aikj6nkkp
lkopi]opan6nkkp
sa^i]opan6nkkp
o]hao6fei<okia`ki]ej*_ki
sssnqj6sa^i]opan
If changes are made to the ]he]oao file, make sure these changes are processed. 
You can use either of two commands to do that: lkop]he]o+ap_+]he]oao, to process the 
changes in the Postfix style, or jas]he]oao, to process the changes in the Sendmail style. 
Using Postfix Management Tools
Managing Postfix is not only about creating the configuration files with the correct syn-
tax. Some management tools are available as well. These administration tools all run from 
the command line. The following is an overview of the most important tools:
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
274
 s  jas]he]oao: Used to generate the database file +ap_+]he]oao*`^ from the file +ap_+
]he]oao.
 s  i]ehm: Lists all  e-mail in the mail queue that has not yet been sent.
 s  lkop]he]o: Same as jas]he]oao.
 s  lkop_]p: Displays in a readable form the contents of a file in the queue directories. 
 s  lkop_kjb: Used to change the content of Postfix variable. If you run it without argu-
ments, an overview is provided of the current configuration of all variables. 
 s  lkopbet: Used as a troubleshooting command. Use lkopbet_da_g to find any con-
figuration errors. Use lkopbetbhqod to force all  e-mail from the deferred queue to 
be sent immediately. After making changes to the Postfix configuration files, use 
lkopbetnahk]` to reload configuration files.
 s  lkopi]l: Used to convert the lookup tables in the +ap_+lkopbet directory to hash 
files.
 s  lkopoqlan: An important maintenance command. lkopoqlan)o removes all 
unneeded files and directories; running this command before starting the  
Postfix server is always recommended. If after a system crash old files still remain, 
lkopoqlan)l removes all unneeded old files. 
Receiving  E-mail Using IMAP or POP3
Postfix is the MTA that makes sure that mail is sent over the Internet. When this mail 
arrives at the destination server, a mechanism is needed to retrieve the  e-mail and 
deliver it to the computer of the end user. Basically, two methods are available: If using 
IMAP, the user establishes a connection to the server and interacts with their mail 
directly on the server. This is a good solution if the end user always has a connection to 
the mail server. If that isn’t the case, it is more useful to use POP3, which transfers all 
mail to the computer of the client. Be aware, however, that a client using POP3 has the 
option to keep the mail messages on the mail server, and that most IMAP mail clients 
offer an option to store mail offline.
Ubuntu Server offers different solutions to receive  e-mail. In this chapter we’ll cover 
the following:
 s  Cyrus IMAPd: A complete solution that allows users to access mail by using either 
IMAP or POP3
 s  Procmail: A solution that allows you to filter incoming mail.
 s  Qpopper: An easy solution that offers POP3 functionality only
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
275
Fetching  E-mail Using Cyrus IMAPd
Cyrus IMAPd is a very flexible service that can be used to get incoming mail. In this sec-
tion, you will learn how to install and configure this MDA.
Installing Cyrus IMAPd
The first step is to install Cyrus IMAPd. For this purpose, you need the _unqo)ei]l` pack-
age; use ]lp)capejop]hh_unqo..)ei]l` to install it. To install the management utilities as 
well, use ]lp)capejop]hh_unqo..)]`iin. Once the package is installed, you have to con-
figure Postfix to provide  e-mail through Cyrus IMAPd. Include the following in the Postfix 
i]opan*_b file:
_unqoqjet)jj))lela
qoan9_unqo]ncr9+qon+he^+_unqo+^ej+`aheran)a)n woaj`any)i
 watpajoekjy wqoany
From i]opan*_b, Postfix calls the `aheran program, which delivers all  e-mail to recipi-
ents on the system. This program replaces the Postfix hk_]h program. In order for Cyrus 
IMAPd to do this, all recipients must exist as local users in +ap_+l]oos` on the server 
where Postfix is used. Another task you need to perform to make Cyrus IMAPd respon-
sible for all incoming mail is to modify +ap_+lkopbet+pn]jolknp. In the pn]jolknp lookup 
table, you enter a line in which specify your domain and specify that _unqo is the respon-
sible handler for incoming mail:
okia`ki]ej*_ki_unqo6
After you make this modification, generate the corresponding lookup table with the 
command lkopi]ld]od6+ap_+lkopbet+pn]jolknp.
Understanding Cyrus IMAPd
To implement Cyrus IMAPd successfully, you first need to understand all the compo-
nents that are written to your system when installing Cyrus IMAPd:
 s  +ap_+_unqo*_kjb: This is the basic configuration file Cyrus works with. The file con-
tains generic settings that define how Cyrus will work. Normally, it is not necessary 
to make changes to this file.
 s  +ap_+ei]l`*_kjb: In this file, the working of the IMAP protocol is defined. Some 
important settings are made in this file, as you can read later in this chapter.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
276
 s  +r]n+he^+_unqo+: In this directory, you find several important files that Cyrus works 
with. These include log files, database files, and files that contain information 
about mailboxes of users on your system.
 s  +r]n+he^+_unqo+i]eh^ktao*`^: This file includes all mailboxes. Make sure you back 
it up on a regular basis. 
 s  +r]n+he^+_unqo+hkc+: If you are using the Cyrus mechanism for logging, its log files 
are stored here. In this directory, a file is created that has a name that is equivalent 
to the PID of the Cyrus IMAPd process. 
 s  +r]n+he^+_unqo+mqkp]+: In this directory, you can add quotas for the accounts on 
your server.
 s  +r]n+he^+_unqo+odqp`ksj: If you need to shut down the system, create this file. In 
the file, you can include a line that will be sent to connected clients. Normally this 
line would be a warning telling the clients to disconnect. Also, when this file exists, 
no new connections can be made, thus allowing you to shut down the system for 
maintenance. 
 s  +r]n+he^+_unqo+ioc+ikp`: Use this file to send a message to clients when they con-
nect. The first line in this file will be displayed to connecting clients.
Configuring /etc/imapd.conf
The main configuration file for the Cyrus server is +ap_+ei]l`*_kjb. This file contains sev-
eral settings that define how the server is to be used. Some of the most important settings 
are listed and described next:
 s  _kjbec`ena_pknu: Specifies the directory that contains the working environment 
and important configuration files for your server. By default, it is set to +r]n+he^+
ei]l.
 s  l]npepekj)`ab]qhp: Specifies the location in which the mailboxes are stored. By 
default, it is set to +r]n+olkkh+ei]l.
 s  ]`iejo: Lists users with administrative permissions for the Cyrus IMAPd server. 
By default, only the user _unqo has administrative permissions.
 s  ]hhks]jkjuikqohkcej: Specifies whether a user is allowed to connect without pro-
viding a username and password. This is very bad practice with regard to security, 
so always make sure this is set to jk.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
277
 s  ]qpk_na]pamqkp]: Specifies the maximum amount of  e-mail data that can be stored 
in a user’s mailbox. By default, it is set to -,,,,, which equals 10 MB; you probably 
want to increase that. If set to ,, the user is not allowed to create new mail folders, 
and if set to )-, no quota is applied. 
 s  mqkp]s]nj: Specifies when the user should get a warning that he is running out of 
available disk space. By default, this parameter is set to 5,!.
 s  peiakqp: Specifies the number of minutes after which an inactive client is discon-
nected automatically.
 s  o]oh[ls_da_g[iapdk`: Specifies the authentication method that should be used. 
By default, o]oh]qpd` is used for this purpose. This makes sure that passwords are 
transmitted over the network with some basic encryption applied to them. 
After making modifications to the ei]l`*_kjb file, you should restart the IMAPd 
server. If o]oh]qpd` is used for secure transmission of authentication data over the net-
work, two processes are needed: first start o]oh]qpd`, and then use +ap_+ejep*`+_unqo
op]np to start the Cyrus mail server as well. To make sure that o]oh]qpd` is started, edit the 
configuration file +ap_+`ab]qhp+o]oh]qpd` and set the parameter OP=NP9uao.
Managing User Mailboxes
The first step in managing user mailboxes is to add users to the system. These users are 
normal Linux users that you add to +ap_+l]oos`. These users don’t need a home directory, 
because all they use is their mailboxes that are stored in +r]n+he^+_unqo. Also, no shell is 
needed. However, the users do need the ability to reset their passwords. Therefore, make 
sure +qon+^ej+l]oos` is specified as the default shell.
After you install the mail server and add users to your system, you can start adminis-
tration. To perform administration tasks, you need the user account _unqo. Be aware that 
no default password is added for this user, so you need to set it manually. After setting it, 
you can use the _un]`i command for administration of the Cyrus server. This command 
opens an interactive shell in which you can use several administration commands. To 
activate this shell, use the _un]`i)qoan_unqo)]qpdhkcejhk_]hdkop command. Next, you 
can start administration tasks. A summary of the most important commands that you can 
use follows:
 s  heopi]eh^kt: Lists the names of all mailboxes.
 s  _na]pai]eh^kt: Creates a mailbox. The user for whom you are creating the mailbox 
must have a valid account in +ap_+l]oos`.
 s  `ahapai]eh^kt: Deletes a mailbox.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
278
 s  naj]iai]eh^kt 2ENAMES A MAILBOX
 s  oapmqkp]: Sets a quota on a mailbox.
 s  heopmqkp]: Gives an overview of quotas that are applied currently.
If, for example, you want to create a mailbox for user ]hat, follow these steps:
 
1. Make sure that user ]hat exists in +ap_+l]oos`.
 
2. Open the _un]`i tool using _un]`i)qoan_unqo)]qpdhkcejhk_]hdkop.
 
3. From the _un]`i interactive shell, use _na]pai]eh^ktqoan*]hat to create a mailbox 
for your user. Make sure the username is specified as qoan*]hat. This also sets 
default permissions to the mailbox, which allows the user to use his own mailbox. 
 
4. Use heopi]eh^kt to check that the mailbox has been created successfully. 
 
5. Close the interactive interface, using the atep command. 
Basically, this is everything you need to create a mailbox for users. Of course, many 
more options are available from the _un]`i interface. You can get an overview of all 
options by using the dahl command from within the administration interface. 
Filtering Incoming  E-mail with procmail
When mail is coming in to your server, you can filter this mail and determine where the 
mail needs to be stored by using the lnk_i]eh MDA. Use ]lp)capejop]hhlnk_i]eh to 
install it. lnk_i]eh can sort  e-mail automatically, forward it to other recipients, or delete 
it automatically according to some criteria the user has specified. This can be useful as 
a kind of primitive spam filter.
To use lnk_i]eh, you have to call it from the +ap_+lkopbet+i]ej*_b file. This is normally 
done with the following line, so make sure it exists:
i]eh^kt[_kii]j`9+qon+^ej+lnk_i]eh
When it is activated, you can use lnk_i]eh to set up automatic  e-mail filtering and 
redistribution. By default,  e-mail is delivered to the user mailboxes in +r]n+olkkh+i]eh+. 
You can change this default behavior by creating a *lnk_i]eh file in the home directory 
of the individual user.  Listing 10-3 provides an example of automatic mail filtering per-
formed by lnk_i]eh.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
279
 Listing 10-3. Example of .procmail Mail Filtering File
L=PD9+^ej6+qon+^ej
I=EH@EN9 DKIA+I]eh
HKCBEHA9 I=EH@EN+i]eh*hkc
6,
&ZBnki*&okia`ki]ej
 I=EH@EN+Okia`ki]ej
6,ZOq^fa_p*&re]cn]
 I=EH@EN+ol]i
6,
&
 I=EH@EN+Ej^kt
In this example, after some specific variables have been set that specify where mail 
binaries can be found, three rules are applied. The first rule specifies that data in the Bnki 
field will be compared to &okia`ki]ej. If there is a match, the mail is automatically for-
warded to the Somedomain folder in the mailbox of the user. The second rule specifies 
that all messages that have “viagra” in the message subject line are forwarded automati-
cally to the spam folder. This is a very primitive way of handling spam. The third rule 
specifies that all other mail (matching the & criterion) is placed in the folder Inbox.
Getting  E-mail with POP3 Using Qpopper
Qpopper is an excellent choice if you want to set up a simple POP3 server. To install it, 
use ]lp)capejop]hhmlkllan. This adds a line to +ap_+ejap`*_kjb to start it automatically. 
Since using ejap` is not a recommended method, I suggest starting Qpopper through 
tejap`. To do this, use ]lp)capejop]hhtejap` first to install it, and then create a file 
with the name +ap_+tejap`*`+mlkllan that has the same contents as the example file in 
 Listing 10-4.
NNote Running Qpopper through tejap` is a viable solution if the mail server is not too busy. If it is, you 
should make sure that it is started as a real daemon that is available at all times. If not, Qpopper will suffer 
from bad performance.
www.it-ebooks.info

CHAPTER 10 N   CONFIGURING UBUNTU SERVER AS A MAIL SERVER 
280
 Listing 10-4. Example of the /etc/xinetd.d/qpopper Configuration File

mlkllan)lkl/i]eh`]aikj

oanre_alkl/
w

`eo]^ha9jk
ok_gap[pula9opna]i
lnkpk_kh9p_l
s]ep9jk
qoan9nkkp
oanran9+qon+o^ej+mlkllan
oanran[]nco9)o
bh]co9ELr0
y
In this example, the most important line is `eo]^ha9jk. This line makes sure the 
Qpopper service is started automatically when a POP request is incoming. After you make 
the required modifications to this file, make sure to (re)start tejap` by using +ap_+ejep*`+
tejap`WnaYop]np. After you make sure that Qpopper is started, just one task remains. 
As an end user, you have to configure your favorite POP client and connect to the POP3 
server. You will see that  e-mail automatically starts coming in to your mailbox.
Summary
This chapter explained the basics of how to set up Ubuntu Server as a mail server. You 
learned how to configure Postfix as an  easy-to- maintain MTA that exchanges mail with 
other servers on the Internet and makes sure users in your network can be reached from 
everywhere. You also learned how to set up Cyrus IMAPd as an IMAP mail server and 
how to use Qpopper as a very easily configured POP mail client. This chapter didn’t cover 
every aspect of setting up a successful mail server, only the basics. You should be aware 
that setting up a mail server involves more than just making the processes work. For 
example, you should configure spam and virus protection, which goes beyond the scope 
of this chapter.
www.it-ebooks.info

281
C H A P T E R  1 1
Managing Ubuntu Server 
Security
Configuring Cryptography and 
AppArmor
Ubuntu Server offers some powerful security options. In this chapter you’ll learn how 
to set up two important security solutions. First, you’ll learn how to create and manage 
a PKI environment and certificate authority, using OpenSSL cryptography. Next, you’ll 
be introduced to AppArmor, a new feature in Ubuntu Server 8.04 that helps you to secure 
individual applications.
Managing Cryptography
In the age of the Internet, cryptography has become increasingly important. When data is 
sent across insecure networks, you need to make sure the data is protected. When com-
municating with a host on the other side of the world, you need to make sure that the 
host really is the host you think it is (authentication). To do this, cryptography can help. 
In this section you will learn how to use OpenSSL to implement a secure cryptographic 
infrastructure. The following subjects are discussed:
 s  )NTRODUCTION TO 33,
 s  0UBLIC AND PRIVATE KEYS
 s  4HE NEED FOR A CERTIFICATE AUTHORITY
 s  #REATING A CERTIFICATE AUTHORITY AND SERVER CERTIFICATES
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
282
Introduction to SSL
Before Netscape invented the Secure Sockets Layer (SSL) protocol in 1994, there was no 
good way to protect data against the eyes of interceptors when the data traveled across 
the Internet. With SSL, data can be encrypted and clients and servers can be authenti-
cated using digital certificates. These digital certificates are based on the X.509 standard 
and contain not only the public key of any party on the Internet, but also a digital signa-
ture that guarantees the authenticity of that public key. 
Netscape wanted SSL to become an Internet standard, so it released enough infor-
mation to enable others to create SSL libraries as well. The OpenSSL suite that is used in 
Linux environments is a direct result of that. In 1999, SSL’s successor was introduced, 
Transport Layer Security (TLS). The only fundamental difference between SSL and TLS is 
that TLS is standardized by the Internet Engineering Task Force (IETF).
Public and Private Keys
SSL works with public/private key pairs. These can be used for two purposes: to prove 
identity and to encrypt messages. In an SSL environment, every host must have its own 
public/private key pair. 
As an example of how SSL works, imagine that Linda wants to send an encrypted 
 e-mail message to Kylie. To send an encrypted message, a user always needs the public 
key of the user to whom they want to send the encrypted message, so Linda first needs to 
get Kylie’s public key. To make sure that everyone has easy access to a copy of her public 
key, Kylie can, for example, publish her public key on a web site, put it in an LDAP Direc-
tory server, or attach it to every  e-mail she sends out. After Linda has obtained Kylie’s 
public key, she can use it to encrypt the  e-mail message that she subsequently sends to 
Kylie. Because Kylie’s public key is directly related to the private key that only Kylie has 
access to, only Kylie, using her private key, is able to decrypt the message. 
Public/private key pairs can also be used to establish identity. An example of this 
is Secure Shell (SSH)  key- based authentication. (SSH is covered in my book Beginning 
Ubuntu LTS Server Administration, Second Edition, also published by Apress in 2008.) In 
such a scenario, the user who wants to authenticate makes sure that a copy of his public 
key is stored on the server on which he wants to authenticate. Next, on authentication, 
the server sends a random message to the user asking him to sign it with his private key. 
The client then sends the signed data to the sever and the server decrypts the data with 
the client’s public key. If the decrypted data matches the previously sent data, the client is 
authenticated, because he has proven his identity.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
283
The Need for a Certificate Authority
The scenario described in the preceding section is realistic and works well, but there is 
one problem: when Linda receives Kylie’s public key, how can she be sure that it is Kylie’s 
public key and not the public key of someone pretending to be Kylie? That’s where the 
CERTIFICATE AUTHORITY #!	 COMES IN ! #! GUARANTEES THE AUTHENTICITY OF PUBLIC KEYS OF users and servers. It does so by signing this public key with its own private key. The result 
of this is a public key certificate in which the public key of the user is present, together 
WITH THE SIGNATURE OF THE #! 4HE USER APPLICATION WHICH SHOULD HAVE A COPY OF THE PUBLIC KEY OF THE #! CAN VERIFY AUTOMATICALLY THAT THE SIGNATURE IS VALID AND THEREFORE CAN USE this guaranteed public key certificate without consulting the user. If on the other hand 
A CERTIFICATE IS SIGNED BY A #! OF WHICH THE PUBLIC KEY IS UNKNOWN ON THE LOCAL HOST THE user application notifies the user about the issue and allows the user to decide what to do 
with that certificate. Of course, the user can decide to trust that the public key in the cer-
tificate is authentic, but there is no way to guarantee that. 
4HE MAIN PURPOSE OF A #! IS TO GUARANTEE THE AUTHENTICITY OF A PUBLIC KEY BUT WHO IN THIS CASE IS THERE TO GUARANTEE THE AUTHENTICITY OF THE #! 4HIS IS WHERE THE TRUSTED ROOT COMES IN 'ENERALLY SPEAKING THERE ARE TWO DIFFERENT KINDS OF #!S  s  Local CAs #!S THAT run within a company and are used to create certificates for 
keys of individual servers.
 s  Trusted root CAs #!S that are trusted by everyone and used to create keys for 
OTHER #!S )N OTHER WORDS THE TRUSTED ROOT IS A #! THAT GUARANTEES THE AUTHENTICITY OF OTHER #!S
The reason the trusted root is trusted is that most applications already have the pub-
LIC KEY OF SUCH A TRUSTED ROOT #! BY DEFAULT 4HEREFORE THE APPLICATIONS WILL AUTOMATICALLY accept the certificate signed by such a trusted root. It is, however, not necessary for every 
USER TO GO TO THE TRUSTED ROOT DIRECTLY WITHIN A COMPANY YOU CAN CREATE YOUR OWN #! AND CHOOSE WHETHER OR NOT TO CREATE A CERTIFICATE FOR THAT #! )F YOU WANT A CERTIFICATE THAT guarantees the authenticity of the public key in your certificate, you need to get it signed 
by a trusted root instance. VeriSign is a  well- known example of a company that can do 
that for you. By using a trusted root, a chain of trust is created. 
In a chain of trust, the certificate of the end user is signed by your own  in- company 
#! 4HE CERTIFICATE OF THIS #! IN TURN IS SIGNED BY A TRUSTED ROOT SUCH AS 6ERI3IGN OR IF THE certificate is for use within your company only, by a trusted root that you have created for 
your company. When a user receives this certificate, she will not be able to verify the cer-
TIFICATE OF THE #! THAT SIGNED THE CERTIFICATE BUT BECAUSE THIS CERTIFICATE IN TURN IS SIGNED by a trusted root that is well known, an encrypted session can be established without 
problems. The bottom line is that when a certificate is signed by a trusted root, it is safe. 
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
284
!S A COMPANY YOU CAN CHOOSE TO SIGN EVERY CERTIFICATE THAT IS USED BY AN EXTERNAL #! BUT THIS IS EXPENSIVE ! CHEAPER SOLUTION IS TO CREATE YOUR OWN #! WHICH IN TURN HAS ITS CERTIFICATE SIGNED BY AN EXTERNAL #! 4HAT WAY YOU HAVE A CERTIFICATE THAT IS TRUSTED BY ALL external parties. If trust with external parties is not a requirement, as an alternative, you 
CAN CHOOSE TO CREATE A #! WITH A  SELF SIGNED CERTIFICATE /F COURSE THIS SOLUTION IS NOT AS good as a solution in which trust is guaranteed by an external party, but if you have the 
option to manage within your network all workstations that work with this certificate, the 
guarantee of an external party isn’t necessary. Just copy the public key certificate of your 
#! TO ALL THESE WORKSTATIONS AND IT WILL WORK ANYWAY )N THE NEXT SECTION YOU WILL LEARN HOW TO SET UP YOUR OWN #! AND THEN CREATE CERTIFICATES
NTip If someone is able to steal the private key from your CA, all keys signed by that CA are compromised. 
Therefore, you should make sure the private key cannot be stolen. A good method to ensure that does not 
happen is to create a dedicated CA and isolate it from the network. The CA only needs to sign public keys, 
and it doesn’t need a network connection to do so.
Creating a Certificate Authority and Server Certificates
To CREATE A #! AND CERTIFICATES ON 5BUNTU 3ERVER YOU CAN USE THE klajooh command. 
In this section you’ll learn how to use the klajooh command to create a certificate and 
A  SELF SIGNED #! "ECAUSE THE  SELF SIGNED #! IS THE HIGHEST LEVEL IN THE #! HIERARCHY IN THIS EXAMPLE IT WILL BE A ROOT #! The following steps explain how to proceed:
 
1. Decide where you want to create the directory structure in which you want to 
PUT THE #! 4HIS SHOULD BE A DIRECTORY STRUCTURE THAT CANT BE ACCESSED BY OTHER users. The home directory of the user nkkp, for example, might be a good location, 
because no ordinary users have access to this directory. From the directory of your 
choice, start with ig`ennkkp)?= TO CREATE A SUBDIRECTORY IN WHICH THE #! WILL STORE its files. 
 
2. Next, some subdirectories must be created in this nkkp)?= directory. The names of 
these subdirectories are predefined in the configuration file +ap_+ooh+klajooh*_jb, 
so don’t try anything creative unless you are willing to change all settings in this 
configuration file as well. The command ig`en_anpojas_anpolner]pa_nh creates 
these subdirectories for you. The following list describes the purpose of each of 
these subdirectories:
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
285
  s  _anpo: Stores all signed public key certificates. This directory can be publicly 
accessible.
  s  jas_anpo: Stores all new certificates that haven’t been signed yet. 
  s  lner]pa: Stores the private key of your server. Protect it like the crown jewels! 
The least you should do is give this directory permission mode 700 (_dik`3,,
lner]pa). 
  s  _nh 3TORES #ERTIFICATE 2EVOCATION ,ISTS IF ANY ARE NEEDED IN YOUR ENVIRONMENT  
3. To make creating the certificate FOR THE ROOT #! A BIT EASIER OPEN THE CONFIGURA-
tion file +ap_+ooh+klajooh*_jb. In this file you will find some default settings that 
ARE USED WHEN YOU CREATE NEW CERTIFICATES 2EAD THE FILE AND MODIFY ALL SETTINGS AS required. You at least need to make sure that all directory paths are accurate, by 
modifying the DKIA and `en variables. Also, it is a good idea to set the names of the 
certificates to the correct value.  Listing 11-1 shows an example of what this should 
look like. All nonessential parameters have been omitted from the listing.
 Listing 11-1. Some Important Settings from openssl.cnf
DKIA9+nkkp+nkkp)?=
`en9+nkkp+nkkp)?=
***
_anpebe_]pa9 `en+_]_anp*lai
***
lner]pa[gau9 `en+lner]pa+lnergau*lai
***
 
4. Now that you have properly tuned the configuration file, you can create 
A  SELF SIGNED CERTIFICATE FOR THE ROOT #! 4HE FOLLOWING COMMAND CREATES THE CER
TIFICATE WITH A   BIT 23! KEY THAT IS VALID FOR  YEARS klajoohnam)jasgauno]6-,.0)t1,5)`]uo/21,)gaukqp±
lner]pa+lnergau*lai)kqp_]_anp*lai
 
 The main command used here is klajooh. This command has several parameters 
that can be used as if they were independent commands. The parameter nam is 
used to create the  self- signed certificate (check its man page to see everything 
it can be used for). To make clear where these keys should be created, )gaukqp is 
used to specify where to put the private key, and )kqp is used to define the location 
of the public key. All the other options are used to specify with what parameters 
the key must be created. 
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
286
 
5. #REATING THE KEY STARTS AN INTERFACE IN WHICH SEVERAL QUESTIONS ARE ASKED SEE  Listing 11-2). The most important is the prompt for a pass phrase. Using a pass 
PHRASE IS MANDATORY ESPECIALLY IN THIS EXAMPLE BECAUSE WE ARE CREATING A ROOT #! without a pass phrase, it would be possible for anyone accessing your machine 
TO CREATE PUBLIC KEY CERTIFICATES SIGNED BY THIS #! WHICH WOULD MAKE THIS #! worthless. You will also be prompted to enter a Distinguished Name, which is the 
complete name of the server using the key. Often it is similar to the fully qualified 
DNS domain name.
 Listing 11-2. Creating the Public/Private Key Pair for the CA
nkkp<iah6z+nkkp)?=klajoohnam)jasgauno]6-,.0)t1,5)`]uo/21,)kqp±
_]_anp*lai)gaukqplner]pa+lnergau*lai
Cajan]pejc]-,.0^epNO=lner]pagau
****''''''
*********************''''''
snepejcjaslner]pagaupk#lner]pa+lnergau*lai#
AjpanLAIl]ooldn]oa6
Ranebuejc)AjpanLAIl]ooldn]oa6
)))))
Ukq]na]^kqppk^a]oga`pkajpanejbkni]pekjpd]psehh^aej_knlkn]pa`
ejpkukqn_anpebe_]panamqaop*
Sd]pukq]na]^kqppkajpaneosd]peo_]hha`]@eopejcqeoda`J]iakn]@J*
Pdana]namqepa]basbeah`o^qpukq_]jha]raokia^h]jg
Bknokiabeah`opdanasehh^a]`ab]qhpr]hqa(
Ebukqajpan#*#(pdabeah`sehh^ahabp^h]jg*
)))))
?kqjpnuJ]ia$.happan_k`a%W=QY6JH
Op]paknLnkrej_aJ]ia$bqhhj]ia%WOkia)Op]paY6
Hk_]hepuJ]ia$ac(_epu%WY6
Knc]jev]pekjJ]ia$ac(_kil]ju%WEjpanjapSe`cepoLpuHp`Y6
Knc]jev]pekj]hQjepJ]ia$ac(oa_pekj%WY6
?kiikjJ]ia$ac(UKQNj]ia%WY6Iuoahb
Ai]eh=``naooWY6iuoahb<at]ilha*_ki
NNote You should always check the output of the klajooh commands carefully. It’s not easy to see errors, 
but it is easy to make them through small typing mistakes. You should fix all errors before proceeding to the 
next step.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
287
 
6. 9OU NOW HAVE YOUR OWN ROOT #! WHICH MEANS YOU CAN CREATE YOUR OWN CERTIFI-
cates, used for any purpose. For example, you can create server certificates for 
secure  e-mail or create client certificates to connect a notebook to a VPN gate-
way. Before you can start creating your own certificates, you need to create the 
OpenSSL database. This database consists of two files in which OpenSSL keeps 
track of all the certificates that it has issued; you need to create these two files 
manually before you start. To create this simple database, change to the home 
DIRECTORY OF YOUR ROOT #! USE pkq_dej`at*ptp, and then use a_dk,-:oane]h. 
 
7. Now that you have the database index files, you need to create the key pair and the 
associated key signing request. To do this, first use _`+nkkp+nkkp)?= to go to the 
ROOT DIRECTORY THAT IS USED BY YOUR #! .EXT ENTER THE COMMAND
klajoohnam)jas)gaukqplner]pa+i]ehoanrangau*lai±
)kqp_anpo+i]ehoanran[nam*lai)`]uo/21
 
 This example uses the name i]ehoanrangau, which makes it easy to identify what 
the key is used for; you can use any name you like here. With this command, you 
have created a new key pair, of which the private key is stored in +nkkp+nkkp)?=+
lner]te, and the public key is dropped in +nkkp+nkkp)?=+_ants.  Listing 11-3 shows 
the process of creating these keys.
 Listing 11-3. Creating a Public/Private Key Pair for Your Server
nkkp<iah6z+nkkp)?=klajoohnam)jas)gaukqplner]pa+i]ehoanrangau*lai±
)kqp_anpo+i]ehoanran[nam*lai)`]uo/21
Cajan]pejc]-,.0^epNO=lner]pagau
******************''''''
*************''''''
snepejcjaslner]pagaupk#lner]pa+i]ehoanrangau*lai#
AjpanLAIl]ooldn]oa6
Ranebuejc)AjpanLAIl]ooldn]oa6
)))))
Ukq]na]^kqppk^a]oga`pkajpanejbkni]pekjpd]psehh^aej_knlkn]pa`
ejpkukqn_anpebe_]panamqaop*
Sd]pukq]na]^kqppkajpaneosd]peo_]hha`]@eopejcqeoda`J]iakn]@J*
Pdana]namqepa]basbeah`o^qpukq_]jha]raokia^h]jg
Bknokiabeah`opdanasehh^a]`ab]qhpr]hqa(
Ebukqajpan#*#(pdabeah`sehh^ahabp^h]jg*
)))))
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
288
?kqjpnuJ]ia$.happan_k`a%W=QY6JH
Op]paknLnkrej_aJ]ia$bqhhj]ia%WOkia)Op]paY6J>
Hk_]hepuJ]ia$ac(_epu%WY6=iopan`]i
Knc]jev]pekjJ]ia$ac(_kil]ju%WEjpanjapSe`cepoLpuHp`Y6Okia?kil]ju
Knc]jev]pekj]hQjepJ]ia$ac(oa_pekj%WY6okiasdana
?kiikjJ]ia$ac(UKQNj]ia%WY6Ia
Ai]eh=``naooWY6ia<okia_kil]ju*_ki
Lha]oaajpanpdabkhhksejc#atpn]#]ppne^qpao
pk^aoajpsepdukqn_anpebe_]panamqaop
=_d]hhajcal]ooskn`WY6
=jklpekj]h_kil]juj]iaWY6
 
8. You NOW HAVE CREATED THE #! AND A KEY PAIR THAT YOU WANT TO GET SIGNED )F UNLIKE IN THIS SIMPLE EXAMPLE SETUP THE #! THAT NEEDS TO SIGN THE KEY DOES NOT RUN ON your own server, you would now copy it to the server that does the signing. In this 
SIMPLE SETUP BECAUSE THE #! IS ON THE SAME SERVER YOU CAN SIGN THE #! USING THE following command: 
klajooh_])lkhe_ulkhe_u[]jupdejc)jkpatp)kqp_anpo+i]ehoanran_anp*lai±
)ejbehao_anpo+i]ehoanran[nam*lai
 
 -AKE SURE THAT YOU RUN THIS COMMAND FROM THE ROOT DIRECTORY OF THE #! AS WELL In this command, for signing the key, the default policy is used, lkhe_u[]jupdejc, 
which is defined as the default setting in the klajooh*_jb configuration file. The 
option )jkpatp is used to limit the amount of output produced by this command. 
Then the name of the resulting certificate is given: _anpo+i]ehoanran_anp*lai. This 
certificate can be created only because earlier you created a signing request with 
the name i]ehoanran[nam*lai. This i]ehoanran[nam*lai request is in the _anpo direc-
tory. In a situation in which you need to sign a public key that is generated on 
another server, you only have to make sure that this public key is copied to this 
directory; the signing request would find it and the public key certificate would 
be created without any problem.  Listing 11-4 shows the output that is generated 
when signing this certificate.
 Listing 11-4. Signing the Certificate Just Created
nkkp<iah6z+nkkp)?=klajooh_])lkhe_ulkhe_u[]jupdejc)jkpatp)kqp±
_anpo+i]ehoanran_anp*lai)ejbehao_anpo+i]ehoanran[nam*lai
Qoejc_kjbecqn]pekjbnki+qon+he^+ooh+klajooh*_jb
Ajpanl]ooldn]oabkn+nkkp+nkkp)?=+lner]pa+lnergau*lai6
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
289
?da_gpd]ppdanamqaopi]p_daopdaoecj]pqna
Oecj]pqnakg
?anpebe_]pa@ap]eho6
Oane]hJqi^an6-$,t-%
R]he`epu
Jkp>abkna6=qc-1,56/.6-..,,4CIP
Jkp=bpan6=qc-1,56/.6-..,,5CIP
Oq^fa_p6
_kqjpnuJ]ia9JH
op]paKnLnkrej_aJ]ia9Okia)Op]pa
hk_]hepuJ]ia9Nkkoaj`]]h
knc]jev]pekjJ]ia9Iu?kil
_kiikjJ]ia9IuJ]ia
ai]eh=``naoo9iuj]ia<iu_kil*_ki
T1,5r/atpajoekjo6
T1,5r/>]oe_?kjopn]ejpo6
?=6B=HOA
Japo_]la?kiiajp6
KlajOOHCajan]pa`?anpebe_]pa
T1,5r/Oq^fa_pGauE`ajpebean6
>@6-364?6@/6>@6/56A46156>260360=6=06BB6=-60,64?6/,63/6?@6>.
T1,5r/=qpdknepuGauE`ajpebean6
gaue`64/6>16356B-63/6./61260.6B-6-36>464=6=@6?=6>26?56A26356@?
61A
?anpebe_]paeopk^a_anpebea`qjpeh=qc-1,56/.6-..,,5CIP$/21`]uo%
Oecjpda_anpebe_]pa;Wu+jY6u
-kqpkb-_anpebe_]panamqaopo_anpebea`(_kiiep;Wu+jYu
Snepakqp`]p]^]oasepd-jasajpneao
@]p]>]oaQl`]pa`
You now have created the public/private key pair for your mail server and you have 
SIGNED IT WITH YOUR OWN  SELF SIGNED ROOT #! &OR MORE DETAILS ON HOW TO USE THE klajooh 
command, check i]jklajooh$-%. Also note that each option, such as nam and _], has its 
own man page. 
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
290
Securing Applications with AppArmor
Installing a firewall is one important element in ensuring the security of servers and 
networks. A firewall, however, won’t protect you if there is a security hole in your applica-
tion. For example, a  buffer- overflow problem could give an intruder nkkp access to your 
system without any limitation. Therefore, you need a solution to secure applications 
on a  per- application basis. AppArmor is such a solution and it is integrated in Ubuntu 
Server. AppArmor uses the security framework in the Linux kernel to make sure that an 
application can only perform tasks defined in an AppArmor profile, no matter what the 
name is of the user account that the application is started with. In this section you’ll learn 
how to configure AppArmor. 
NNote An alternative to AppArmor is SELinux, which is used by other Linux distributions, such as Red Hat. 
On Ubuntu Server, AppArmor is used because it is much easier to configure and offers the same level of pro-
tection.
AppArmor Components
Before you start to install and use AppArmor, it is useful to understand how it works. The 
core component of AppArmor is the profile. You can create a profile for every applica-
tion, and in that profile you can define exactly what the application can and cannot do. 
The functionality of AppArmor profiles is based on two Linux kernel modules, ]ll]nikn 
and ]]i]p_d[l_na, that hook in directly to the Linux Security Modules (LSM) framework of 
the kernel. These modules, which load as soon as you start working with AppArmor, work 
together to make it possible to use POSIX capabilities to define exactly what an applica-
tion can and cannot do. 
You can consider the set of POSIX capabilities to be an addition to the Linux per-
missions system. Whereas a permission defines what a user can do to a file, a capability 
defines what actions the user can perform on the system as a whole, including files. For 
example, the ?=L[=Q@EP[SNEPA capability allows users to write to the audit log, and the 
?=L[?DKSJ capability allows users to change UIDs and GIDs. Normal users by default 
have limited capabilities, whereas user nkkp has all of them. That is also why user nkkp is 
 all- powerful on your Linux server and has no real limitations.
NNote The POSIX standard defines common standards for Linux and UNIX operating systems. POSIX capa-
bilities include all actions that can happen on a Linux (and UNIX) system.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
291
Basically, if an application is started as nkkp and has an AppArmor profile as well, the 
AppArmor profile determines what the application can do, regardless of the fact that the 
user is logged in as nkkp. That means that with AppArmor, you can even create limitations 
for nkkp.
An AppArmor profile defines an application’s capabilities and  file- access permis-
sions.  Listing 11-5 gives an example of how these capabilities and permissions are applied 
in the default profile for jpl`. You can find this example profile in +ap_+]ll]nikn*`+qon*
o^ej*jpl`.
 Listing 11-5. Example Profile for ntpd
nkkp<iah6+ap_+]ll]nikn*`_]pqon*o^ej*jpl`
H]opIk`ebea`6Pdq=qc.-06/36,/.,,3
 E`6qon*o^ej*jpl`5-1.,,3),4)-1-46/-6.2Voapd[]njkh` 
))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))

?klunecdp$?%.,,.).,,1Jkrahh+OQOA

Pdeolnkcn]ieobnaaokbps]na7ukq_]jna`eopne^qpaep]j`+kn
ik`ebuepqj`anpdapaniokbranoekj.kbpdaCJQCajan]hLq^he_
He_ajoalq^heoda`^updaBnaaOkbps]naBkqj`]pekj*

))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))
ej_hq`a8pqj]^hao+chk^]h:
+qon+o^ej+jpl`bh]co9$_kilh]ej%w
ej_hq`a8]^opn]_pekjo+^]oa:
ej_hq`a8]^opn]_pekjo+j]iaoanre_a:
ej_hq`a8]^opn]_pekjo+t]`:
_]l]^ehepuel_[hk_g(
_]l]^ehepujap[^ej`[oanre_a(
_]l]^ehepuoapce`(
_]l]^ehepuoapqe`(
_]l]^ehepuouo[_dnkkp(
_]l]^ehepuouo[naokqn_a(
_]l]^ehepuouo[peia(
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
292
japskngejap`cn]i(
japskngejapopna]i(
japskngejap2opna]i(
+`nebp+jpl*`nebpnsh(
+`nebp+jpl*`nebp*PAILnsh(
+ap_+jpl*_kjbn(
+ap_+jpl+`nebp&nsh(
+ap_+jpl+gauon(
+ap_+jpl+opal)pe_ganon(
+ap_+jpl`*_kjbn(
+ap_+jpl`*_kjb*piln(
+pil+jpl&nsh(
+qon+o^ej+jpl`niet(
+r]n+he^+jpl+`nebpnsh(
+r]n+he^+jpl+`nebp*PAILnsh(
+r]n+he^+jpl+`nebp+jpl*`nebpns(
+r]n+he^+jpl+`nebp+jpl*`nebp*PAILns(
+r]n+he^+jpl+ap_+&n(
+r]n+he^+jpl+jpl*`nebpns(
+r]n+he^+jpl+jpl*`nebp*PAILns(
+r]n+he^+jpl+r]n+nqj+jpl+jpl`*le`s(
+r]n+hkc+jpls(
+r]n+hkc+jpl*hkcs(
+r]n+hkc+jplop]po+hkklop]po&hns(
+r]n+hkc+jplop]po+laanop]po&hns(
+r]n+klp+jkrahh+t]`+nl_+t]`o`ns(
+r]n+nqj+jo_`+oanre_aon(
+r]n+nqj+jpl`*le`s(
+r]n+pil+jpl&nsh(
<wLNK?y+jap+eb[ejap2n(
y
NNote The reason that SUSE and Novell are referenced in this example AppArmor profile is that AppArmor 
is open source technology owned by Novell. Some elements, such as the profiles that are used, are applied 
on Ubuntu without any modifications.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
293
 Listing 11-5 first includes some additional configuration files. Next, the POSIX 
capabilities that are needed for this program are defined. If the program would run as 
nkkp, it would have access to all 31 capabilities defined in the POSIX standard. Together, 
these capabilities allow for complete access to the system. In this case, you can see that 
the number of capabilities is limited to seven. For a complete list of all capabilities, 
consult i]j3_]l]^ehepeao. Following the capabilities, a list of files and directories is 
provided, and for each of these files and directories, the profile defines the permissions 
that the process has.  Table 11-1 gives an overview of all permissions that you can use in 
AppArmor. 
 Table 11-1. Overview of AppArmor Permissions
Permission 
Use
n 
Gives read access to the resource.
s 
Gives write access to the file. This also allows the program to remove the file.
h 
Gives link access to a file. This allows a process to create or remove links.
i 
Allows executable files to be loaded in memory (known as executable mapping).
et 
 Sets the mode to inherit execute, which allows a program that is executed by this 
program to inherit the current profile settings for execution.
lt 
 Sets the mode to discrete profile execute, which indicates that a program needs its 
own AppArmor profile.
Lt 
 Indicates that the program needs its own profile, but is allowed to load its envi-
ronment variables without that.
qt 
 Allows the program to run without any AppArmor profile restrictions being 
applied to it. Don’t use this permission, because it is insecure. 
Qt 
 Allows the program to run without any AppArmor profile restrictions being 
applied to it in its own environment. Don’t use this permission, because it is 
insecure.
Installing and Starting AppArmor
Installing AppArmor is easy: it is installed by default. Also, many applications that have an 
AppArmor profile will automatically install this profile. I recommend installing the avail-
able additional profiles as well, by using the following command: 
]lp)capejop]hh]ll]nikn)lnkbehao
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
294
To start AppArmor, some services are needed. You can start these services manu-
ally with the +ap_+ejep*`+]ll]niknop]np command. To stop AppArmor, use +ap_+ejep*`+
]ll]niknopkl, or use +ap_+ejep*`+]ll]nikngehh if you want to unload the AppArmor ker-
nel modules also. If AppArmor is installed, you don’t need to include AppArmor services 
in the startup procedure, because AppArmor will load automatically when your server 
boots. AppArmor also has a restart/reload option, which you activate with +ap_+ejep*`+
]ll]niknnaop]np or +ap_+ejep*`+]ll]niknnahk]`. There is no difference between these 
two commands; both force AppArmor to reread its configuration. Be aware, however, that 
if you reload the AppArmor configuration, all applications that are confined by AppArmor 
should be reloaded as well. Therefore, it may be a better idea just to restart your complete 
server, using the na^kkp command as nkkp.
Creating and Managing AppArmor Profiles 
To create and manage profiles, several  command- line tools are available. The most useful 
command is cajlnkb, short for generate profile. This section shows you how use this com-
mand to create an AppArmor profile for the s/i application.
NNote w3m is a  text- based web browser. It doesn’t offer the same functionality as a  full- scale graphical 
browser, but it is useful anyway. Use ]lp)capejop]hhs/i to install it on your server if necessary.
The following steps show how to create a profile for w3m with cajlnkb:
 
1. From a terminal window, use the cajlnkb command, followed by the name of 
the application that you want to profile. For example, use cajlnkbs/i to create 
a profile for the w3m browser. If no current profile for this program exists on your 
server and this is the first time you have started the profiling application for this 
program, cajlnkb asks whether you want to access the online profile repository 
to see if a profile for your application exists in there. In general, it is a good idea 
to download profiles from the online profile repository, but to teach you how you 
can create a profile yourself, do not select this option in this procedure. Instead, 
press D to tell cajlnkb that you don’t want to go to the online profile directory. 
 Listing 11-6 shows the output produced by cajlnkb at this stage.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
295
 Listing 11-6. Use genprof to Tell AppArmor You Want to Create Another Profile
nkkp<iah6zcajlnkbs/i
Lha]oaop]nppda]llhe_]pekjpk^alnkbeha`ej
]jkpdansej`ks]j`atan_eoaepobqj_pekj]hepujks*
Kj_a_kilhapa`(oaha_ppdaO_]j^qppkj^ahksej
kn`anpko_]jpdaouopaihkcobkn=ll=niknarajpo*
Bkna]_d=ll=niknarajp(ukqsehh^acerajpda
kllknpqjepupk_dkkoasdapdanpda]__aooodkqh`^a
]hhksa`kn`ajea`*
Lnkbehejc6+qon+^ej+s/i
W$O%_]jouopaihkcbknOq^@ki]ejarajpoY+$B%ejeod
NNote You could use a plain text console as well to run cajlnkb, but for multitasking reasons, it is much 
more convenient to run it from a terminal window in a graphical session. If you don’t have a graphical envi-
ronment available, you can use virtual consoles, which are activated with the Alt+<Function key> keystroke.
 
2. Leave the cajlnkb command running in a console and start the program for which 
you want to create the profile (see  Listing 11-7). Make sure that you use as much 
as possible of its functionality. For a web browser like w3m, that means you have 
to visit several web pages (make sure to visit some that start scripts as well), open 
a file, and so on. 
 Listing 11-7. To Create a Reliable Profile, Use As Much of the Program Functionality 
As Possible
nkkp<IUH6zs/isss*bob*knc
BnaaOkbps]naBkqj`]pekj
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
296
=^kqp
?]il]ecjo
Rkhqjpaan
@kj]pa
Fkej
Odkl
Oej_a-541sa#ra^aajbecdpejcbknaooajpe]hbnaa`kiobkn_kilqpanqoano
Bnaa`kiBnu
OpaldajBnu
In*OpaldajBnuejpnk`q_aoukqpkbnaaokbps]na(]j`naiej`oukqkb]ranu
ola_e]h^enpd`]u*
P]ga]_pekj6Bn]j_alh]jopk]`klp]h]s(sde_dskqh`lqjeodlaklhasdkb]eh
pk
#naola_p#_klunecdpkjpdaEjpanjap*
Bej`kqpikna]^kqpkqn_]il]ecjo(]_pereoi]j`h]paopjaso
CJQ)]_kilhapabnaaokbps]naklan]pejcouopai
·Reasejc8Sah_kia)BnaaOkbps]naBkqj`]pekj:
 
3. 
When you are finished using the application, press S in the terminal where cajlnkb 
is running, to start scanning the log file to analyze what exactly the application 
needs to do its work. The cajlnkb command next asks you what to do for each 
event it has detected for your application (see  Listing 11-8 for some examples). 
 Listing 11-8. When Creating the Profile, Authorize Every Part of Your Application
nkkp<iah6zcajlnkbs/i
Snepejcql`]pa`lnkbehabkn+qon+^ej+s/i*
Oappejc+qon+^ej+s/ipk_kilh]ejik`a*
Lha]oaop]nppda]llhe_]pekjpk^alnkbeha`ej
]jkpdansej`ks]j`atan_eoaepobqj_pekj]hepujks*
Kj_a_kilhapa`(oaha_ppdaO_]j^qppkj^ahksej
kn`anpko_]jpdaouopaihkcobkn=ll=niknarajpo*
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
297
Bkna]_d=ll=niknarajp(ukqsehh^acerajpda
kllknpqjepupk_dkkoasdapdanpda]__aooodkqh`^a
]hhksa`kn`ajea`*
Lnkbehejc6+qon+^ej+s/i
W$O%_]jouopaihkcbknOq^@ki]ejarajpoY+$B%ejeod
Na]`ejchkcajpneaobnki+r]n+hkc+iaoo]cao*
Ql`]pejc=ll=niknlnkbehaoej+ap_+]ll]nikn*`*
Lnkbeha6+qon+^ej+s/i
Ata_qpa6+^ej+`]od
Oaranepu6qjgjksj
W$E%jdanepY+$L%nkbeha+$Q%j_kjbeja`+$@%aju+=^k$n%p+$B%ejeod
?kilh]ej)ik`a_d]jcao6
Lnkbeha6+qon+^ej+s/i
L]pd6+`ar+lpo+-
Ik`a6ns
Oaranepu65
-)ej_hq`a8]^opn]_pekjo+_kjokhao:
W.)+`ar+lpo+-Y
W$=%hhksY+$@%aju+$C%hk^+Chk^s+$A%tp+$J%as+=^k$n%p+$B%ejeod
=``ejc+`ar+lpo+-nspklnkbeha*
Lnkbeha6+qon+^ej+s/i
L]pd6+ap_+dkopo
Ik`a6n
Oaranepu6qjgjksj
-)ej_hq`a8]^opn]_pekjo+j]iaoanre_a:
W.)+ap_+dkopoY
W$=%hhksY+$@%aju+$C%hk^+Chk^s+$A%tp+$J%as+=^k$n%p+$B%ejeod
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
298
Lnkbeha6+qon+^ej+s/i
L]pd6+ap_+dkopo
Ik`a6n
Oaranepu6qjgjksj
-)ej_hq`a8]^opn]_pekjo+j]iaoanre_a:
.)+ap_+dkopo
W/)+ap_+&Y
W$=%hhksY+$@%aju+$C%hk^+Chk^s+$A%tp+$J%as+=^k$n%p+$B%ejeod
=``ejc+ap_+&npklnkbeha*
Lnkbeha6+qon+^ej+s/i
L]pd6+ap_+s/i+_kjbec
Ik`a6n
Oaranepu6qjgjksj
W-)+ap_+s/i+_kjbecY
W$=%hhksY+$@%aju+$C%hk^+Chk^s+$A%tp+$J%as+=^k$n%p+$B%ejeod
 
 
To create the profile, cajlnkb calls the hkclnkb command in the background; 
hkclnkb is specially designed to analyze the AppArmor log file +r]n+hkc+]q`ep+
]q`ep*hkc. If the profiled application needs to access a program, cajlnkb gives you 
the following possibilities:
  s Inherit: The executed program inherits the permissions of its parent program.
  s Profile 2EQUIRES THAT A PREVIOUSLY DEFINED PROFILE ALREADY EXIST FOR THE EXECUTED program.
  s Unconfined: Allows the program to run without a security profile. 
  s Deny: Denies access to the program that is called by the program you are creat-
ing the profile for. For instance, in  Listing 11-8 you can see that w3m calls the 
`]od shell. If at this point you deny access, that would mean that your program 
would never be able to start this subshell. This would probably break the func-
tionality of your program.
 
 
In the profiled application needs to access a file, you have the following options:
  s Allow: Gives access to the file.
  s Deny: Prevents the program from accessing this file.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
299
  s Glob: Selecting Glob once replaces the filename with an asterisk, including all 
files in the directory. Selecting Glob a second time allows your application to 
access files in the parent directory of the directory in which the file is located.
  s Glob w/Ext: Selecting this option once gives the program access to all files that 
have the same extension as the selected file. Selecting this option a second 
time gives the program access to all files with the same extension in the parent 
directory of the directory in which the file is located.
 
4. After you have indicated for each event what you want to do with it, from the 
cajlnkb window, press the F key. This terminates cajlnkb activity and creates the 
profile. 
 
5. 2ESTART YOUR APPLICATION TO ENABLE !PP!RMOR TO PROTECT IT 7HEN IT STARTS IT WILL behave according to the rules that you have just created in the profile in /ap_+
]ll]nikn*`/lnkbehao.
Updating a Profile
If a profile already exists for your application, you can update it using a specific proce-
dure. In this procedure, you first have to put your application in complain mode, by using 
the ]])_kilh]ej command. By doing this, you activate learning mode for the program 
that is specified. To activate this mode for the program w3m, you could use ]])_kilh]ej
s/i. You can also refer directly to its profile file: ]])_kilh]ej+ap_+]ll]nikn*`+qon*^ej*s/i. 
It’s even possible to apply a generic update on all profiles that currently exist, by using 
]])_kilh]ej+ap_+]ll]nikn*`+&. Once the programs are in complain mode, you can start 
using them. If you have used enough functionality to update the program, you can now 
update the profile. Use ]])hkclnkb)`+ap_+]ll]nikn*` to update all profiles, or ]])hkclnkb
)b+ap_+]ll]nikn*`+ukqn*lnkcn]i to update the profile of a specific application.
Monitoring AppArmor’s Status
This section introduces several commands that you can use to monitor AppArmor’s sta-
tus from the command line. 
The +ap_+ejep*`+]ll]niknop]pqo command gives you a generic overview of current 
AppArmor activity, as shown in the example in  Listing 11-9.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
300
 Listing 11-9. apparmor status Displays Current AppArmor Activity
nkkp<iah6+ap_+ejep*`*+]ll]niknop]pqo
]ll]niknik`qhaeohk]`a`*
-0lnkbehao]nahk]`a`*
/lnkbehao]naejajbkn_aik`a*
+qon+o^ej+iuomh`
+qon+o^ej+oh]l`
+qon+o^ej+]r]de)`]aikj
--lnkbehao]naej_kilh]ejik`a*
+qon+o^ej+jpl`
+qon+o^ej+e`ajp`
+qon+o^ej+ji^`
+o^ej+ghkc`
+o^ej+ouohkc`
+qon+o^ej+oi^`
+o^ej+ouohkc)jc
+qon+o^ej+pn]_ankqpa
+qon+o^ej+jo_`
+qon+o^ej+i`jo`
+^ej+lejc
2lnk_aooaod]ralnkbehao`abeja`*
.lnk_aooao]naejajbkn_aik`a6
+qon+o^ej+iuomh`$44-4%
+qon+o^ej+oh]l`$1/45%
,lnk_aooao]naej_kilh]ejik`a*
0lnk_aooao]naqj_kjbeja`^qpd]ra]lnkbeha`abeja`*
+o^ej+ouohkc`$1.,.%
+o^ej+ghkc`$1.02%
+qon+o^ej+ji^`$2,4/%
+qon+o^ej+jpl`$2.,0%
When you see that AppArmor is protecting some processes (as indicated in the 
lines that specify processes are in enforce mode), you probably want to find out what 
processes these are. To do this, have a look at the +ouo+ganjah+oa_qnepu+]ll]nikn+lnk)
behao file. This shows a complete list of all process files that currently are protected by 
AppArmor. For an example of its contents, see  Listing 11-10.
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
301
 Listing 11-10. /sys/kernel/security/apparmor/profiles Lists All Process Files Currently 
Protected by AppArmor
nkkp<iah6+_]p+ouo+ganjah+oa_qnepu+]ll]nikn+lnkbehao
+qon+o^ej+pn]_ankqpa$_kilh]ej%
+qon+o^ej+oi^`$_kilh]ej%
+qon+o^ej+oh]l`$ajbkn_a%
+qon+o^ej+jpl`$_kilh]ej%
+qon+o^ej+jo_`$_kilh]ej%
+qon+o^ej+ji^`$_kilh]ej%
+qon+o^ej+iuomh`$ajbkn_a%
+qon+o^ej+i`jo`$_kilh]ej%
+qon+o^ej+e`ajp`$_kilh]ej%
+qon+o^ej+]r]de)`]aikj$ajbkn_a%
+o^ej+ouohkc`$_kilh]ej%
+o^ej+ouohkc)jc$_kilh]ej%
+o^ej+ghkc`$_kilh]ej%
+^ej+lejc$_kilh]ej%
A third command that is pretty useful to monitor the current status of AppArmor 
is qj_kjbeja`. This command shows you a list of all processes that currently are active 
but do not have an AppArmor profile loaded. In other words, these are the unprotected 
commands for which you should consider creating and loading a profile as well. See 
 Listing 11-11 for an example.
 Listing 11-11. unconfined Generates a List of All Running Programs Not Protected by 
AppArmor
nkkp<iah6+_]p+ouo+ganjah+oa_qnepu+]ll]nikn+lnkbehao
+qon+o^ej+pn]_ankqpa$_kilh]ej%
+qon+o^ej+oi^`$_kilh]ej%
+qon+o^ej+oh]l`$ajbkn_a%
+qon+o^ej+jpl`$_kilh]ej%
+qon+o^ej+jo_`$_kilh]ej%
+qon+o^ej+ji^`$_kilh]ej%
+qon+o^ej+iuomh`$ajbkn_a%
+qon+o^ej+i`jo`$_kilh]ej%
+qon+o^ej+e`ajp`$_kilh]ej%
+qon+o^ej+]r]de)`]aikj$ajbkn_a%
www.it-ebooks.info

CHAPTER 11 N   MANAGING UBUNTU SERVER SECURITY
302
+o^ej+ouohkc`$_kilh]ej%
+o^ej+ouohkc)jc$_kilh]ej%
+o^ej+ghkc`$_kilh]ej%
+^ej+lejc$_kilh]ej%
Summary
Security is an important feature on every server. In this chapter you learned about 
two important  security- related items. First, you learned how to use klajooh to create 
a certificate authority and sign your own public key certificates. In the second part 
of this chapter, you learned how to use AppArmor to add an additional layer of secu-
rity to your applications. In the next chapter, you will learn how to configure Ubuntu 
Server as a VPN server.
www.it-ebooks.info

303
C H A P T E R  1 2
Configuring Ubuntu Server  
As a VPN Server
Networking Securely over  
the Internet
If you need to connect securely to a server that is not on your site, one option is to 
purchase a dedicated line. Unfortunately, dedicated lines are expensive. A cheap and 
very common alternative is to configure a Virtual Private Network (VPN), a connection 
between two sites or two computers that goes over the Internet. VPNs are available as 
hardware appliances, but it is relatively easy to configure Linux as a VPN server. 
Because the Internet by nature is an unsecured network, you have to implement 
security measures when setting up a VPN. These security measures are applied by using 
encryption. Several solutions are available to create a VPN. You are probably already 
familiar with one of them: when you establish an SSH session with your server and start 
a program on your server that displays its output on the local workstation, basically you 
are using a VPN. However, an SSH VPN is not the most versatile VPN solution. A very 
popular and versatile Linux VPN solution is OpenVPN, which uses functionality from the 
OpenSSL package to ensure its security. In this chapter you’ll learn how to set up a VPN 
that is based on OpenVPN. 
Installing and Configuring OpenVPN
As with most software on Ubuntu Server, installing OpenVPN is not too hard: just run 
]lp)capejop]hhklajrlj to download and install the software. The installation process 
installs all software and also starts the klajrlj daemon. You can manipulate the process 
from its ejep scripts as well. For example, you can start it with +ap_+ejep*`+klajrljop]np 
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
304
and stop it with +ap_+ejep*`+klajrljopkl. Unfortunately, the ejep script doesn’t provide 
an option to get the current status of the klajrlj software.
Before you set up the VPN itself, as covered later in this section, you need a clear 
understanding of the way in which a VPN normally is configured, as described next.
VPN Networking
In most VPN solutions, a dedicated network interface is created and maintained by the 
VPN. In OpenVPN, this is the pqj interface, instead of the apd, interface you normally see 
for an Ethernet network card. Working with two interfaces makes configuring the VPN 
slightly complex. The node on which the VPN is configured has to distinguish between 
traffic that must be sent through the VPN to the other site and traffic that can be sent 
straight to the Internet or to other nodes in the same local network.  Figure 12-1 gives 
an overview of this situation. To make sure the node does this, you have to configure 
routing. 
 Figure 12-1. Schematic overview of a VPN configuration
Before going any further, you should determine if you want to use a routed VPN or 
a bridged VPN. OpenVPN offers both options. However, in most situations you will use 
routing. Routing is easier to set up and offers better flexibility with regard to access con-
trol. Bridging is useful only if you need to use very specific features of your VPN, such as 
in the following cases:
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
305
 s  4HE 60. NEEDS TO HANDLE PROTOCOLS OTHER THAN )0 SUCH AS )08
 s  9OU ARE RUNNING APPLICATIONS THAT RELY ON ,!. BROADCASTS OVER THE 60.
 s  9OU WANT TO BROWSE TO 7INDOWS SHARES WITHOUT SETTING UP A 3AMBA OR 7).3 nam-
ing server.
Generating Certificates
OpenVPN heavily relies on the use of certificates, so before you start to configure the 
VPN, you should set up a public key infrastructure (PKI). Before the mutual trust that is 
required on the VPN can be established, the server and client must exchange their PKI 
certificates. 
NNote Although this chapter refers to a client/server VPN setup, a VPN can also be established between 
sites, in which case one site is configured as the client and the other is configured as the server.
In Chapter 11 you learned how to set up a certificate authority (CA). Because 
OpenVPN has its own scripts to set up the complete PKI infrastructure, this chapter also 
covers setting up the CA. If you already have a CA, you can skip this configuration and 
proceed to creating certificates for the client and the server.
Configuring the Certificate Authority
By default, you’ll find the OpenVPN scripts that help you to build the CA and its keys in 
the directory +qon+od]na+`k_+klajrlj+at]ilhao+a]ou)no]+..0. Copy these scripts to +ap_+
klajrlj+a]ou)no] to prevent them from being overwritten when you’re updating software 
on your server.
When setting up a CA and associated certificates, you need to specify what country, 
province, and city you are in. You also need to enter other personal parameters, such as 
the name of your organization and the administrator  e-mail address. In OpenVPN, you 
enter these details in the file +ap_+klajrlj+a]ou)no]+r]rs.  Listing 12-1 provides an exam-
ple of this file. Most of the lines in this example file can be used as displayed. You need to 
modify only the last four lines, which refer to your specific information.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
306
 Listing 12-1. vars Makes Passing the Appropriate Parameters Easier when Generating the CA
nkkp<iah6+ap_+klajrlj+a]ou)no]_]pr]no
a]ou)no]l]n]iapanoappejco
JKPA6Ebukqejop]hha`bnki]jNLI(
`kj#pa`eppdeobehaejlh]_aej
+qon+od]na+klajrlj+a]ou)no]))
ejopa]`(ukqodkqh`_klupdasdkha
a]ou)no]`ena_pknupk]jkpdanhk_]pekj
$oq_d]o+ap_+klajrlj%okpd]pukqn
a`eposehhjkp^asela`kqp^u]bqpqna
KlajRLJl]_g]caqlcn]`a*
Pdeor]ne]^haodkqh`lkejppk
pdapklharahkbpdaa]ou)no]
pnaa*
atlknpA=OU[NO=9\ls`\

Pdeor]ne]^haodkqh`lkejppk
pdanamqaopa`ata_qp]^hao

atlknpKLAJOOH9klajooh
atlknpLG?O--PKKH9lg_o--)pkkh
atlknpCNAL9cnal
Pdeor]ne]^haodkqh`lkejppk
pdaklajooh*_jbbehaej_hq`a`
sepda]ou)no]*
atlknpGAU[?KJBEC9\ A=OU[NO=+sde_dklajooh_jb A=OU[NO=\
A`eppdeor]ne]^hapklkejppk
ukqnokkj)pk)^a)_na]pa`gau
`ena_pknu*

www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
307
S=NJEJC6_ha]j)]hhsehh`k
]ni)nbkjpdeo`ena_pknu
oki]gaoqnaukq`abeja
ep_knna_phu
atlknpGAU[@EN9 A=OU[NO=+gauo
Eooqani)nbs]njejc
a_dkJKPA6Ebukqnqj*+_ha]j)]hh(Esehh^a`kejc]ni)nbkj GAU[@EN
Ej_na]oapdeopk.,04ebukq
]nal]n]jke`*Pdeosehhohks
`ksjPHOjackpe]pekjlanbkni]j_a
]osahh]opdakja)peia@Dl]nio
cajan]pekjlnk_aoo*
atlknpGAU[OEVA9-,.0
Ejdksi]ju`]uoodkqh`pdankkp?=gauatlena;
atlknp?=[ATLENA9/21,
Ejdksi]ju`]uoodkqh`_anpebe_]paoatlena;
atlknpGAU[ATLENA9/21,
Pdaoa]napda`ab]qhpr]hqaobknbeah`o
sde_dsehh^alh]_a`ejpda_anpebe_]pa*
@kj#pha]ra]jukbpdaoabeah`o^h]jg*
atlknpGAU[?KQJPNU9QO
atlknpGAU[LNKREJ?A9?=
atlknpGAU[?EPU9O]jBn]j_eo_k
atlknpGAU[KNC9Bknp)Bqjopkj
atlknpGAU[AI=EH9ia<iudkop*iu`ki]ej
After making sure that the r]no file contains the appropriate parameters, you can 
create the CA. You do this by executing three scripts from the +ap_+klajrlj+a]ou)no] 
directory:
okqn_a*+r]no
*+_ha]j)]hh
*+^qeh`)_]
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
308
Of these commands, the first two just clean up the current configuration and pass 
to your current environment the variables you’ve set in +ap_+klajrlj+a]ou)no]+r]rs. The 
latter command generates the CA for you.  Listing 12-2 gives an example of the output of 
these commands.
 Listing 12-2. Generating the Certificate Authority with the  easy- rsa Scripts
nkkp<iah6+ap_+klajrlj+a]ou)no]okqn_a*+r]no
JKPA6Ebukqnqj*+_ha]j)]hh(Esehh^a`kejc]ni)nbkj+ap_+klajrlj+a]ou)no]+gauo
nkkp<iah6+ap_+klajrlj+a]ou)no]*+_ha]j)]hh
nkkp<iah6+ap_+klajrlj+a]ou)no]*+^qeh`)_]
Cajan]pejc]-,.0^epNO=lner]pagau
*************************************''''''
****************************************''''''
snepejcjaslner]pagaupk#_]*gau#
)))))
Ukq]na]^kqppk^a]oga`pkajpanejbkni]pekjpd]psehh^aej_knlkn]pa`
ejpkukqn_anpebe_]panamqaop*
Sd]pukq]na]^kqppkajpaneosd]peo_]hha`]@eopejcqeoda`J]iakn]@J*
Pdana]namqepa]basbeah`o^qpukq_]jha]raokia^h]jg
Bknokiabeah`opdanasehh^a]`ab]qhpr]hqa(
Ebukqajpan#*#(pdabeah`sehh^ahabp^h]jg*
)))))
?kqjpnuJ]ia$.happan_k`a%WJHY6
Op]paknLnkrej_aJ]ia$bqhhj]ia%WJ>Y6
Hk_]hepuJ]ia$ac(_epu%WNkkoaj`]]hY6
Knc]jev]pekjJ]ia$ac(_kil]ju%Wo]j`anY6
Knc]jev]pekj]hQjepJ]ia$ac(oa_pekj%WY6
?kiikjJ]ia$ac(ukqnj]iaknukqnoanran#odkopj]ia%Wo]j`an?=Y6
Ai]eh=``naooWi]eh<o]j`an*bnY6
Creating Server Keys
At this point the CA is available and you can generate keys. The following command 
creates the keys for the server (replace ukqnoanran with the actual name of your server):
*+^qeh`)gau)oanranukqnoanran
Executing this command starts an interactive command sequence. When it asks if 
you want to sign the keys as well, enter uao. This makes sure that you can start using the 
keys immediately.  Listing 12-3 shows the output of the ^qeh`)gau)oanran command.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
309
 Listing 12-3. Use  build-key- server to Create Keys for Your Server
nkkp<iah6+ap_+klajrlj+a]ou)no]*+^qeh`)gau)oanraniah
Cajan]pejc]-,.0^epNO=lner]pagau
*****''''''
**************************************************''''''
snepejcjaslner]pagaupk#iah*gau#
)))))
Ukq]na]^kqppk^a]oga`pkajpanejbkni]pekjpd]psehh^aej_knlkn]pa`
ejpkukqn_anpebe_]panamqaop*
Sd]pukq]na]^kqppkajpaneosd]peo_]hha`]@eopejcqeoda`J]iakn]@J*
Pdana]namqepa]basbeah`o^qpukq_]jha]raokia^h]jg
Bknokiabeah`opdanasehh^a]`ab]qhpr]hqa(
Ebukqajpan#*#(pdabeah`sehh^ahabp^h]jg*
)))))
?kqjpnuJ]ia$.happan_k`a%WJHY6
Op]paknLnkrej_aJ]ia$bqhhj]ia%WJ>Y6
Hk_]hepuJ]ia$ac(_epu%WNkkoaj`]]hY6
Knc]jev]pekjJ]ia$ac(_kil]ju%Wo]j`anY6
Knc]jev]pekj]hQjepJ]ia$ac(oa_pekj%WY6
?kiikjJ]ia$ac(ukqnj]iaknukqnoanran#odkopj]ia%WiahY6
Ai]eh=``naooWi]eh<o]j`an*bnY6
Lha]oaajpanpdabkhhksejc#atpn]#]ppne^qpao
pk^aoajpsepdukqn_anpebe_]panamqaop
=_d]hhajcal]ooskn`WY6
=jklpekj]h_kil]juj]iaWY6
Qoejc_kjbecqn]pekjbnki+ap_+klajrlj+a]ou)no]+klajooh*_jb
?da_gpd]ppdanamqaopi]p_daopdaoecj]pqna
Oecj]pqnakg
PdaOq^fa_p#o@eopejcqeoda`J]iaeo]obkhhkso
_kqjpnuJ]ia6LNEJP=>HA6#JH#
op]paKnLnkrej_aJ]ia6LNEJP=>HA6#J>#
hk_]hepuJ]ia6LNEJP=>HA6#Nkkoaj`]]h#
knc]jev]pekjJ]ia6LNEJP=>HA6#o]j`an#
_kiikjJ]ia6LNEJP=>HA6#iah#
ai]eh=``naoo6E=1OPNEJC6#i]eh<o]j`an*bn#
?anpebe_]paeopk^a_anpebea`qjpeh=qc.0,360260..,-4CIP$/21,`]uo%
Oecjpda_anpebe_]pa;Wu+jY6u
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
310
-kqpkb-_anpebe_]panamqaopo_anpebea`(_kiiep;Wu+jYu
Snepakqp`]p]^]oasepd-jasajpneao
@]p]>]oaQl`]pa`
Creating Client Keys
Now that the server keys have been created, you can create keys for your client as well. 
Creating client keys is almost the same procedure as creating the server keys, but you use 
*+^qeh`)gau_heajp, still from the +ap_+klajrlj+a]ou)no] directory. Replace _heajp with the 
actual name of the client you are creating the keys for.  Listing 12-4 shows the output of 
this command. When you run this command, answer yes to the questions that are asked.
 Listing 12-4. Use  build- key to Create Keys for Your Clients
nkkp<iah6+ap_+klajrlj+a]ou)no]*+^qeh`)gauiuh
Cajan]pejc]-,.0^epNO=lner]pagau
**''''''
***********************************''''''
snepejcjaslner]pagaupk#iuh*gau#
)))))
Ukq]na]^kqppk^a]oga`pkajpanejbkni]pekjpd]psehh^aej_knlkn]pa`
ejpkukqn_anpebe_]panamqaop*
Sd]pukq]na]^kqppkajpaneosd]peo_]hha`]@eopejcqeoda`J]iakn]@J*
Pdana]namqepa]basbeah`o^qpukq_]jha]raokia^h]jg
Bknokiabeah`opdanasehh^a]`ab]qhpr]hqa(
Ebukqajpan#*#(pdabeah`sehh^ahabp^h]jg*
)))))
?kqjpnuJ]ia$.happan_k`a%WJHY6
Op]paknLnkrej_aJ]ia$bqhhj]ia%WJ>Y6
Hk_]hepuJ]ia$ac(_epu%WNkkoaj`]]hY6
Knc]jev]pekjJ]ia$ac(_kil]ju%Wo]j`anY6
Knc]jev]pekj]hQjepJ]ia$ac(oa_pekj%WY6
?kiikjJ]ia$ac(ukqnj]iaknukqnoanran#odkopj]ia%WiuhY6
Ai]eh=``naooWi]eh<o]j`an*bnY6
Lha]oaajpanpdabkhhksejc#atpn]#]ppne^qpao
pk^aoajpsepdukqn_anpebe_]panamqaop
=_d]hhajcal]ooskn`WY6
=jklpekj]h_kil]juj]iaWY6
Qoejc_kjbecqn]pekjbnki+ap_+klajrlj+a]ou)no]+klajooh*_jb
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
311
?da_gpd]ppdanamqaopi]p_daopdaoecj]pqna
Oecj]pqnakg
PdaOq^fa_p#o@eopejcqeoda`J]iaeo]obkhhkso
_kqjpnuJ]ia6LNEJP=>HA6#JH#
op]paKnLnkrej_aJ]ia6LNEJP=>HA6#J>#
hk_]hepuJ]ia6LNEJP=>HA6#Nkkoaj`]]h#
knc]jev]pekjJ]ia6LNEJP=>HA6#o]j`an#
_kiikjJ]ia6LNEJP=>HA6#iuh#
ai]eh=``naoo6E=1OPNEJC6#i]eh<o]j`an*bn#
?anpebe_]paeopk^a_anpebea`qjpeh=qc.0,46-/6,1.,-4CIP$/21,`]uo%
Oecjpda_anpebe_]pa;Wu+jY6u
-kqpkb-_anpebe_]panamqaopo_anpebea`(_kiiep;Wu+jYu
Snepakqp`]p]^]oasepd-jasajpneao
@]p]>]oaQl`]pa`
Generating  Diffie- Hellman Parameters
You now have a public/private key pair for your server and for your client. Next, you 
need to generate the  Diffie- Hellman parameters that are required for the key exchange 
between client and server. Use the *+^qeh`)`d command from +ap_+klajrlj+a]ou)no] to 
generate these parameters.  Listing 12-5 shows the output of this command.
NNote The  Diffie- Hellman key exchange is a cryptographic protocol that is needed to exchange two sym-
metric keys over a unsecured channel. You need these keys to establish a secure channel over which you 
can continue building the VPN.
 Listing 12-5. Use  build- dh to Generate the  Diffie- Hellman Parameters
nkkp<iah6+ap_+klajrlj+a]ou)no]*+^qeh`)`d
Cajan]pejc@Dl]n]iapano(-,.0^ephkjco]balneia(cajan]pkn.
Pdeoeockejcpkp]ga]hkjcpeia
**********************************************************************
**********************************************************************
**********************************************************************
*****'****************************************************************
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
312
**********************************************************************
**********************************************************************
**********************************************************************
*'******************************************'**********************'**
************************************'*'*******************************
**********************************************************************
*************'*****'**************************************************
******************************'***'***********************************
*************''&''&''&
At this point, a set of keys is created in the directory +ap_+klajrlj+a]ou)no]+gays. 
 Table 12-1 gives an overview of the keys and their use.
 Table 12-1. Overview of Keys Generated
Filename 
Needed By 
Purpose
_]*_np 
Server and all clients 
Root CA certificate
_]*gau 
Server 
Root CA key
`d*lai 
Server 
Diffie-Hellman parameters
oanran*_np 
Server 
Server certificate
oanran*gau 
Server 
Server key
_heajp*_np 
Client 
Client certificate
_heajp*gau 
Client 
Client key
Copying the Keys to the Client
Now that you have created all the keys, it is time to copy the client keys to the client. The 
following procedure summarizes how to do this:
 
1. Use ood to open a session to your client, and then create a directory in which you 
can store the keys, using ig`en+ap_+klajrlj+gauo. 
 
2. Close the SSH session to your client, using the atep command.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
313
 
3. From your server, use o_l to copy the client keys to the client. The name of the 
client key should reflect the name of the client, so if your client’s name is iuh, the 
keys should be named iuh*_np and iuh*gau. The following command (when used 
from the +ap_+klajrlj+a]ou)no]+gauo directory) copies the keys to the proper loca-
tion on the client:
o_liuh&nkkp<_heajp)el)kn)j]ia6+ap_+klajrlj+gauo
 
4. The client should have the certificate of your  in- company CA as well. You created 
this certificate earlier in this procedure, and it is stored in the file +ap_+klajrlj+
a]ou)no]+gau+_]*_rt. Copy this as well, using the following command:
o_l_]*_npnkkp<_heajp)el)kn)j]ia6+ap_+klajrlj+gauo
Configuring the VPN Server
Now that you have created the public and private keys, you can create the configuration 
files. Both the server and the client need a configuration file. (The next section covers 
the client configuration.) You can copy the sample files from +qon+od]na+`k_+klajrlj+
at]ilhao+o]ilha)_kjbec)behes, which is recommended, because the sample configuration 
files already contain everything that you need to set up the VPN. 
By default, the sample oanran*_kjb file creates a VPN in which a network interface 
with the name pqj is used for routing. This interface listens to client connections coming 
in on UDP port 1194 and distributes IP addresses from the -,*4*,*,+.0 subnet. In most 
situations, this configuration works fine. There is one piece of information you have to 
change, though: the sample oanran*_kjb file does not use the keys that you’ve just gener-
ated, so change the _], _anp, gau, and `d parameters to reflect the proper keys.  Listing 12-6 
shows the most important lines from the lengthy sample configuration file.
 Listing 12-6. Critical Parameters from server.conf
nkkp<iah6+ap_+klajrlj_]poanran*_kjb
lknp--50
lnkpkq`l
`arpqj
_]+ap_+klajrlj+gauo+_]*_np
_anp+ap_+klajrlj+gauo+oanran*_np
gau+ap_+klajrlj+gauo+oanran*gau
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
314
`d+ap_+klajrlj+gauo+`d-,.0*lai
oanran-,*4*,*,.11*.11*.11*,
eb_kjbec)lkkh)lanoeopell*ptp
gaal]hera-,-.,
_kil)hvk
lanoeop)gau
lanoeop)pqj
op]pqo+r]n+hkc+klajrlj)op]pqo*hkc
ran^/
Now that you have created the configuration file for the server, it is time to start the 
OpenVPN service. You would normally do that by executing the ejep script +ap_+ejep*`+
klajrljop]np, but because this is the first time you are starting it, you may want to see 
some more output. Therefore, run the following command:
klajrlj))_kjbec+ap_+klajrlj+oanran*_kjb
If anything is wrong in your configuration, this command identifies it in its output. 
An example of such an error message is provided in  Listing 12-7.
 Listing 12-7. Starting openvpn from the Command Line Outputs Any Error Messages
nkkp<iah6+ap_+klajrlj+a]ou)no]+gauoklajrlj))_kjbec+ap_+klajrlj+oanran*_kjb
Pqa=qc.2,061/6-1.,,4KlajRLJ.*-[n_3e042)l_)hejqt)cjqWOOHY±
WHVK.YWALKHHY^qehpkjFqj--.,,4
Pqa=qc.2,061/6-1.,,4@ebbea)Dahhi]jejepe]heva`sepd-,.0^epgau
Pqa=qc.2,061/6-1.,,4?]jjkphk]`_anpebe_]pabeha±
+ap_+klajrlj+a]ou)no]+gauo+oanran*_np6annkn6,.,,-,,.6ouopai±
he^n]nu6bklaj6Jkoq_dbehakn`ena_pknu6annkn6.,,30,,.6>EK±
nkqpejao6BEHA[?PNH6ouopaihe^6annkn6-0,=@,,.6OOH±
nkqpejao6OOH[?PT[qoa[_anpebe_]pa[beha6ouopaihe^
Pqa=qc.2,061/6-1.,,4Atepejc
As you can see in  Listing 12-7, the klajrlj program complains that it can’t find the 
oanran*_np file that the configuration file refers to. This complaint is valid, because the 
files of my server keys have the name of the server itself. So, in my case, I have to replace 
oanran*& in the oanran*_kjb file with iah*&. As  Listing 12-8 shows, the next attempt is more 
successful.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
315
 Listing 12-8. The Server Console Indicates a Successful Start of openvpn
nkkp<iah6+ap_+klajrljklajrlj))_kjbec+ap_+klajrlj+oanran*_kjb
Pqa=qc.2,0614604.,,4KlajRLJ.*-[n_3e042)l_)hejqt)cjqWOOHY±
WHVK.YWALKHHY^qehpkjFqj--.,,4
Pqa=qc.2,0614604.,,4@ebbea)Dahhi]jejepe]heva`sepd-,.0^epgau
Pqa=qc.2,0614604.,,4+qon+^ej+klajooh)rqhjgau)m)^-,.0)i8ik`qhqokieppa`:
Pqa=qc.2,0614604.,,4PHO)=qpdIPQl]nioWH6-10.@6-/4AB6/4A>6,AP6,AH6,Y
Pqa=qc.2,0614604.,,4PQJ+P=L`are_apqj,klaja`
Pqa=qc.2,0614604.,,4PQJ+P=LPTmqaqahajcpdoappk-,,
Pqa=qc.2,0614604.,,4eb_kjbecpqj,-,*4*,*-lkejpklkejp-,*4*,*.ipq-1,,
Pqa=qc.2,0614604.,,4nkqpa]``)jap-,*4*,*,japi]og.11*.11*.11*,cs-,*4*,*.
Pqa=qc.2,0614604.,,4@]p]?d]jjahIPQl]nioWH6-10.@6-01,AB60.±
A>6-/1AP6,AH6,=B6/+-Y
Pqa=qc.2,0614604.,,4Ok_gap>qbbano6N9W-,04132):-/-,3.YO9W-,04132):-/-,3.Y
Pqa=qc.2,0614604.,,4Q@Lr0hejghk_]h$^kqj`%6Wqj`abY6--50
Pqa=qc.2,0614604.,,4Q@Lr0hejgnaikpa6Wqj`abY
Pqa=qc.2,0614604.,,4IQHPE6iqhpe[ejep_]hha`(n9.12r9.12
Pqa=qc.2,0614604.,,4EB?KJBECLKKH6^]oa9-,*4*,*0oeva92.
Pqa=qc.2,0614604.,,4EB?KJBECLKKHHEOP
Pqa=qc.2,0614604.,,4Ejepe]hev]pekjOamqaj_a?kilhapa`
You now can use Ctrl+C to interrupt the klajrlj service, and then restart it, but using 
the ejep script this time: +ap_+ejep*`+klajrljop]np. As you can see, no comments are 
output to your computer monitor, but when you use eb_kjbec, you can see that a new 
device is added to your server. The VPN uses the pqj device to route all VPN traffic to the 
other side.  Listing 12-9 shows what it looks like.
 Listing 12-9. After a Successful Start of the VPN, a tun Device Is Added to the Server
nkkp<iah6+ap_+klajrljeb_kjbecpqj,
pqj,Hejgaj_]l6QJOLA?DS]``n,,),,),,),,),,),,),,),,),,),,),,),,),,),,),,),,
ejap]``n6-,*4*,*-L)p)L6-,*4*,*.I]og6.11*.11*.11*.11
QLLKEJPKLKEJPNQJJEJCJK=NLIQHPE?=OPIPQ6-1,,Iapne_6-
NTl]_gapo6,annkno6,`nklla`6,krannqjo6,bn]ia6,
PTl]_gapo6,annkno6,`nklla`6,krannqjo6,_]nnean6,
_khheoekjo6,ptmqaqahaj6-,,
NT^upao6,$,*,>%PT^upao6,$,*,>%
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
316
Configuring a Linux VPN Client
Now that the server is configured successfully, it’s time to create the client configura-
tion. Let’s start with a Ubuntu desktop client first. Before you configure it, make sure that 
the required software is installed. Install the KlajRLJ package just as you have done on 
the server. For instance, you can use oq`k]lp)capejop]hhklajrlj to install it from the 
command line. There is no need to do anything with the keys, because you have already 
copied them to the client.
NNote In this procedure, you have created the client keys on the server. An alternative method is to cre-
ate them on the client and then issue a certificate signing request from the client to the server. This requires 
more work, but because the private key is created on the client computer and never leaves the client 
computer, it is also considered a more secure method. Consult Chapter 11 for more information about this 
procedure.
As on the server, you can use the sample _heajp*_kjb file from +qon+od]na+`k_+
klajrlj+at]ilhao+o]ilha)_kjbec)behes. In this sample file, you must change the names of 
the key files you are referring to. Also, you should include the correct address of the VPN 
server. Normally, this is a public IP address that can be reached on the Internet. Before 
the client sets up the VPN connection, the client must contact this public address to set 
up the connection.  Figure 12-2 gives an overview of how the public IP address is used to 
set up the VPN connection.
 Figure 12-2. To initialize the VPN connection, the client first contacts the public IP address 
of the server.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
317
 Listing 12-10 shows an example of what the client configuration file looks like. In this 
file, I used an IP address from the private address range to contact the server. I did this 
because, in my test environment, I created the VPN connection over my private network. 
This can be useful if for some reason you don’t completely trust the private network. Nor-
mally, however, this would be the public IP address of the server.
 Listing 12-10. Example Client Configuration File
nkkp<IUH6+ap_+klajrlj_]p_heajp*_kjb
_heajp
naikpa-5.*-24*-*55
lknp--50
lnkpkq`l
`arpqj
naokhr)napnuejbejepa
jk^ej`
_]+ap_+klajrlj+gauo+_]*_np
_anp+ap_+klajrlj+gauo+iuh*_np
gau+ap_+klajrlj+gauo+iuh*gau
gaal]hera-,-.,
qoanjk^k`u
cnkqljkcnkql
lanoeop)gau
lanoeop)pqj
op]pqo+r]n+hkc+klajrlj)op]pqo*hkc
ran^/
iqpa.,
_kil)hvk
Now use the klajrlj command to test the connection:
klajrlj))_kjbec+ap_+klajrlj+_heajp*_kjb
In its verbose output, this command shows whether it has been successful. An exam-
ple is provided in  Listing 12-11.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
318
 Listing 12-11. Starting the Client Manually on the First Attempt Shows Whether It Was 
Successful
nkkp<IUH6+ap_+klajrlj+gauoklajrlj))_kjbec+ap_+klajrlj+_heajp*_kjb
Pqa=qc.2--6/.60/.,,4KlajRLJ.*-[n_3e042)l_)hejqt)cjqWOOHY±
WHVK.YWALKHHY^qehpkjFqj--.,,4
Pqa=qc.2--6/.60/.,,4S=NJEJC6Jkoanran_anpebe_]paranebe_]pekj±
iapdk`d]o^aajaj]^ha`*Oaadppl6++klajrlj*jap+dkspk*dpihiepibkniknaejbk*
Pqa=qc.2--6/.60/.,,4+qon+^ej+klajooh)rqhjgau)m)^-,.0)i8ik`qhqokieppa`:
Pqa=qc.2--6/.60/.,,4HVK_kilnaooekjejepe]heva`
Pqa=qc.2--6/.60/.,,4?kjpnkh?d]jjahIPQl]nioWH6-10.@6-/4±
AB6/4A>6,AP6,AH6,Y
Pqa=qc.2--6/.60/.,,4@]p]?d]jjahIPQl]nioWH6-10.@6-01,AB60.±
A>6-/1AP6,AH6,=B6/+-Y
Pqa=qc.2--6/.60/.,,4Hk_]hKlpekjod]od$RAN9R0%6#0-25,5-5#
Pqa=qc.2--6/.60/.,,4Atla_pa`NaikpaKlpekjod]od$RAN9R0%6#1/,b``a`#
Pqa=qc.2--6/.60/.,,4JKPA6QE@+CE@`ksjcn]`asehh^a`ah]ua`±
^a_]qoakb))_heajp())lqhh(kn))ql)`ah]u
Pqa=qc.2--6/.60/.,,4Ok_gap>qbbano6N9W--,15.):-/-,3.YO9W--,15.):-/-,3.Y
Pqa=qc.2--6/.60/.,,4Q@Lr0hejghk_]h6Wqj`abY
Pqa=qc.2--6/.60/.,,4Q@Lr0hejgnaikpa6-5.*-24*-*556--50
Pqa=qc.2--6/.60/.,,4PHO6Ejepe]hl]_gapbnki-5.*-24*-*556--50(±
oe`9].//4b3_/.5`]__4
Pqa=qc.2--6/.60/.,,4RANEBUKG6`alpd9-(±
+?9JH+OP9J>+H9Nkkoaj`]]h+K9o]j`an+?J9o]j`an[?=+ai]eh=``naoo9i]eh<o]j`an*bn
Pqa=qc.2--6/.60/.,,4RANEBUKG6`alpd9,(±
+?9JH+OP9J>+H9Nkkoaj`]]h+K9o]j`an+?J9iah+ai]eh=``naoo9i]eh<o]j`an*bn
Pqa=qc.2--6/.60/.,,4@]p]?d]jjahAj_nulp6?eldan#>B)?>?#±
ejepe]heva`sepd-.4^epgau
Pqa=qc.2--6/.60/.,,4@]p]?d]jjahAj_nulp6Qoejc-2,^epiaoo]ca±
d]od#OD=-#bknDI=?]qpdajpe_]pekj
Pqa=qc.2--6/.60/.,,4@]p]?d]jjah@a_nulp6?eldan#>B)?>?#±
ejepe]heva`sepd-.4^epgau
Pqa=qc.2--6/.60/.,,4@]p]?d]jjah@a_nulp6Qoejc-2,^epiaoo]ca±
d]od#OD=-#bknDI=?]qpdajpe_]pekj
Pqa=qc.2--6/.60/.,,4?kjpnkh?d]jjah6PHOr-(_eldanPHOr-+OOHr/±
@DA)NO=)=AO.12)OD=(-,.0^epNO=
Pqa=qc.2--6/.60/.,,4WiahYLaan?kjja_pekjEjepe]pa`sepd-5.*-24*-*556--50
Pqa=qc.2--6/.600.,,4OAJP?KJPNKHWiahY6#LQOD[NAMQAOP#$op]pqo9-%
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
319
Pqa=qc.2--6/.600.,,4LQOD6Na_aera`_kjpnkhiaoo]ca6±
#LQOD[NALHU(nkqpa-,*4*,*-(pklkhkcujap/,(lejc-,(lejc)naop]np±
-.,(eb_kjbec-,*4*,*2-,*4*,*1#
Pqa=qc.2--6/.600.,,4KLPEKJOEILKNP6peiano]j`+knpeiakqpoik`ebea`
Pqa=qc.2--6/.600.,,4KLPEKJOEILKNP6))eb_kjbec+qlklpekjoik`ebea`
Pqa=qc.2--6/.600.,,4KLPEKJOEILKNP6nkqpaklpekjoik`ebea`
Pqa=qc.2--6/.600.,,4PQJ+P=L`are_apqj,klaja`
Pqa=qc.2--6/.600.,,4PQJ+P=LPTmqaqahajcpdoappk-,,
Pqa=qc.2--6/.600.,,4eb_kjbecpqj,-,*4*,*2lkejpklkejp-,*4*,*1ipq-1,,
Pqa=qc.2--6/.600.,,4nkqpa]``)jap-,*4*,*-japi]og.11*.11*.11*.11cs-,*4*,*1
Pqa=qc.2--6/.600.,,4CE@oappkjkcnkql
Pqa=qc.2--6/.600.,,4QE@oappkjk^k`u
Pqa=qc.2--6/.600.,,4Ejepe]hev]pekjOamqaj_a?kilhapa`
If the client has started successfully, use Ctrl+C to stop it again. Next, you can start 
it using its ejep script: +ap_+ejep*`+klajrljop]np. After a successful start, you now have 
a pqj, interface at the client as well. By monitoring this interface, you can get more details 
about the VPN connection, such as the IP address of the server and the number of pack-
ets sent over the VPN connection (see  Listing 12-12).
 Listing 12-12. The tun0 Interface on the Client Shows Status Information About the VPN 
Connection
nkkp<IUH6+ap_+klajrlj+gauoeb_kjbecpqj,
pqj,Hejgaj_]l6QJOLA?DS]``n,,),,),,),,),,),,),,),,),,),,),,),,),,),,),,),,
ejap]``n6-,*4*,*2L)p)L6-,*4*,*1I]og6.11*.11*.11*.11
QLLKEJPKLKEJPNQJJEJCJK=NLIQHPE?=OPIPQ6-1,,Iapne_6-
NTl]_gapo6,annkno6,`nklla`6,krannqjo6,bn]ia6,
PTl]_gapo6,annkno6,`nklla`6,krannqjo6,_]nnean6,
_khheoekjo6,ptmqaqahaj6-,,
NT^upao6,$,*,>%PT^upao6,$,*,>%
By initializing the VPN connection, your routing configuration has also been 
changed. Changing the routing configuration makes sure that all packets destined for the 
VPN host are sent to the VPN host, whereas packets destined for the Internet or other net-
works follow the default route to your normal gateway.  Listing 12-13 shows what routing 
looks like after initializing a VPN connection on the client.
www.it-ebooks.info

CHAPTER 12 N   CONFIGURING UBUNTU SERVER AS A VPN SERVER 
320
 Listing 12-13. By Initializing the VPN, Routing Is Modified Automatically
nkkp<IUH6+ap_+klajrlj+gauonkqpa)j
GanjahELnkqpejcp]^ha
@aopej]pekjC]pas]uCaji]ogBh]coIapne_NabQoaEb]_a
-,*4*,*1,*,*,*,.11*.11*.11*.11QD,,,pqj,
-,*4*,*--,*4*,*1.11*.11*.11*.11QCD,,,pqj,
-5.*-24*-*,,*,*,*,.11*.11*.11*,Q,,,apd,
-25*.10*,*,,*,*,*,.11*.11*,*,Q-,,,,,apd,
,*,*,*,-5.*-24*-*.10,*,*,*,QC,,,apd,
Configuring Windows Clients
OpenVPN is available for Windows clients as well. First, you need to create keys for this 
client as well. To do this, follow the procedure described earlier in this chapter in the 
section “Generating Certificates.” To get the Windows client, download the graphical 
installer from dppl6++klajrlj*oa. Install the program and then copy keys and certificates 
to the directory _6Xlnkcn]ibehaoXKlajRLJXgauo. In this directory, you should also create 
the client configuration file for your Windows machine. The name _heajp*klrj is fine. 
You can see an example of its contents in  Listing 12-14.
NNote On Windows, some of the extensions that OpenVPN uses are different. 
 Listing 12-14. Example Contents for client.opvn on Windows
_]r6XXLnkcn]iXBehaoXXklajrljXgauoXX_]*_np
_anp_6XXLnkcn]iXBehaoXXklajrljXgauoXX_heajp*_np
gau_6XXLnkcn]iXBehaoXXklajrljXXgauoXX_heajp*gau
jo)_anp)pulaoanran
pho)]qpd_6XXLnkcn]iXBehaoXXklajrljXXgauoXXp]*gau-
_kil)hvk
ran^/
After you create the configuration file on Windows,  right- click the OpenVPN icon in 
the taskbar (the red icon depicting two computers). 
Summary
In this chapter you have learned how to set up a VPN connection, using the popular 
OpenVPN package. In the next chapter, you will learn how to set up Kerberos and NTP.
www.it-ebooks.info

321
C H A P T E R  1 3
Configuring Kerberos and NTP  
on Ubuntu Server
Using an Alternative Method  
to Handle Authentication
The preceding two chapters explained how to use a public key infrastructure (PKI) to 
secure services. A PKI protects network traffic very well and can also be used for authen-
tication. Kerberos was developed purely as an authentication service and not to protect 
network traffic. Kerberos has become an increasingly popular choice for authentica-
tion, particularly because Microsoft uses it in Active Directory environments, including 
in Linux implementations of Active Directory. In this chapter, you’ll read how to set up 
Kerberos version 5 on Ubuntu Server. Because Kerberos heavily depends on proper time 
synchronization, I’ll first explain how to set up an NTP time server.
Configuring an NTP Time Server
To use Kerberos for authentication, the nodes involved must agree on the time that is 
used. If there is too much time difference between the Kerberos server and the Kerberos 
client, authentication will be refused. Therefore, it is a good idea to set up an NTP time 
server first. Once you have done that, you need to choose between the two Kerberos ver-
sions that are available: MIT Kerberos, which is the original Kerberos that was developed 
by the Massachusetts Institute of Technology, and Heimdal Kerberos, which was meant 
to be an improvement on MIT Kerberos but has never become very popular on Linux. 
For that reason, this chapter covers how to set up MIT Kerberos, version 5 in particular, 
which is the current version. Version 4 has some major security problems, so you should 
not use that version; use version 5 only.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
322
For many networked applications (Heartbeat clustering, for example, introduced in 
Chapter 7), knowing the correct time is essential for proper operation. On the Internet, 
the Network Time Protocol (NTP) is the de facto standard for time synchronization. In 
this section, you’ll learn how to configure your server as an NTP time server as well as an 
NTP client. This section covers the following subjects:
 s  (OW .40 WORKS
 s  #ONFIGURING A  STAND ALONE .40 TIME SERVER
 s  #ONFIGURING YOUR SERVER TO FETCH ITS TIME FROM A  TIME REFERENCE SOURCE
 s  4UNING .40 OPERATION
How NTP Works
The basic idea of NTP is that all servers on the Internet can synchronize time with one 
another. In this way, a global time can be established so that only minimal differences 
exist in the time setting on different servers. To reach this goal, all servers agree upon the 
same time, no matter what time zone they are in. This time is known as Universal Time 
Coordinated (UTC): a server receives its time in UTC and then calculates its local time 
from that by using its time zone setting.
Synchronizing time with other servers in an NTP hierarchy relies on the concept 
of stratums. Every server in the NTP hierarchy has a stratum setting between 1 and 15, 
inclusive, or 16 if the clock is not currently synchronized at all. The highest stratum level 
that a clock can use is 1. Typically, this is a server that’s connected directly to an atomic 
clock that has a very high degree of accuracy. The stratum level that is assigned to a server 
that’s directly connected to an external clock depends on the type of clock that’s used. In 
general, though, the more reliable the clock is, the higher the stratum level will be.
A server can get its time in two different ways: by synchronizing with another NTP 
time server or by using a reference clock. If a server synchronizes with an NTP time 
server, the stratum used on that server will be determined by the server it’s synchroniz-
ing with: if a server synchronizes with a stratum 3 time server, it automatically becomes 
a stratum 4 time server.
To specify what time your server is using, you have to edit the +ap_+`ab]qhp+n_O con-
figuration file, in which you’ll find the QP?9 setting. To use UTC on your server, make sure 
its value is set to uao; if you don’t want to use UTC, set it to QP?9jk. The latter choice is rea-
sonable only in an environment in which all servers are in the same local time zone.
The local time zone setting is maintained in the +ap_+hk_]hpeia binary file, which 
is created upon installation and contains information about your local time zone. To 
change it afterward, you need to create a link to the configuration file that contains infor-
mation on your local time zone. You can find these configuration files in +qon+od]na+
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
323
vkjaejbk. Next, link the appropriate file to the +ap_+hk_]hpeia file. For example, oq`khj
)ob+qon+od]na+vkjaejbk+IAP+ap_+hk_]hpeia changes your local time zone setting to 
Middle European Time (MET).
If, on the other hand, a reference clock is used, a server does not get its time from 
a server on the Internet but instead determines its own time. Again, the default stratum 
used is determined by the type and brand of reference clock that’s used. If it’s a very reli-
able clock, such as one synchronized via GPS, the default stratum setting will be high. If 
a less reliable clock (such as the local clock in a computer) is used, the default stratum will 
be lower.
If a server gets its time from the Internet, it makes sense to use Internet time and use 
a very trustworthy time server. If no Internet connection is available, use an internal clock 
and set the stratum accordingly (which means lower). If you’re using your computer’s 
internal clock, for example, it makes sense to use a low stratum level, such as 5.
Configuring a  Stand- Alone NTP Time Server
Just two elements are needed to make your own NTP time server: the configuration file 
and the daemon process. First, make sure that all required software is installed, by run-
ning ]lp)capejop]hhjpl)oanran as nkkp. Next, start the daemon process, jpl`, by using 
the +ap_+ejep*`+jpl` startup script. After you change the settings in the daemon’s config-
uration file, +ap_+jpl*_kjb, to make the daemon work properly in your environment, you 
can start the daemon process manually by using +ap_+ejep*`+jplop]np.
The content of the NTP configuration file +ap_+jpl*_kjb really doesn’t have to be very 
complex. Basically, you just need three lines to create an NTP time server, as shown in 
 Listing 13-1.
 Listing 13-1. Example ntp.conf Configuration
oanran-.3*-.3*-*,
bq`ca-.3*-.3*-*,opn]pqi-,
oanranjpl*ukqnlnkre`an*okiasdana
The first line in  Listing 13-1 specifies what server the NTP daemon should use if 
the connection with the NTP time server is lost for a long period of time (specified 
in advanced settings); this line makes sure that the local clock in your server will not 
drift too much, by making a reference to a local clock. Every type of local clock has its 
own IP address from the range of loopback IP addresses. The format of this address is 
-.3*-.3*8p:*8e:, where the third byte refers to the type of local clock that is used and the 
fourth byte refers to the instance of the clock your server is connected to. The default 
address to use to refer to the local computer clock is -.3*-.3*-*,. Notice that all clocks 
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
324
that can be used as an external reference clock connected locally to your server have their 
own IP address. The documentation for your clock tells you what address to use.
NTip Even if your server is connected to an NTP server that’s directly on the Internet, it makes sense to use 
at least one local external reference clock on your network as well, to ensure that time synchronization con-
tinues if the Internet connection fails for a long period of time.
The second line in  Listing 13-1 defines what should happen if the server falls back to 
the local external reference clock specified in the first line. This line starts with the key-
word bq`ca to indicate an abnormal situation. Here, the local clock should be used, and 
the server sets its stratum level to 10. By using this stratum, the server indicates that it’s 
not very trustworthy but that it can be used as a time source if necessary.
The last line in  Listing 13-1 shows what should happen under normal circumstances. 
This line normally refers to an IP address or a server name on the network of the Inter-
net service provider. As long as the connection with the NTP time server is fine, this line 
specifies the default behavior.
Pulling or Pushing the Time
An NTP time server can perform its work in two different ways: by pushing (broadcast-
ing) time across the network, or by allowing other servers to pull the time from it. In the 
default setting, the NTP server that gets its time from somewhere else regularly asks this 
server what time is used. When both nodes have their times synchronized, this setting 
will be incremented to a default value of 1,024 seconds. As an administrator, you can 
specify how often time needs to be synchronized by using the iejlkhh and i]tlkhh argu-
ments on the line in +ap_+jpl*_kjb that refers to the NTP time server, as shown in the 
example in  Listing 13-2.
 Listing 13-2. Configuring the Synchronization Interval
oanran-.3*-.3*-*,
bq`ca-.3*-.3*-*,opn]pqi-,
oanranjpl*lnkre`an*okiasdanaiejlkhh0i]tlkhh-1
The iejlkhh setting determines how often a client should try to synchronize its time 
if time is not properly synchronized, and the i]tlkhh value indicates how often synchro-
nization should occur if time is properly synchronized. The values for the iejlkhh and 
i]tlkhh parameters are kind of weird logarithmically: they refer to the power of 2 that 
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
325
should be used. Therefore, iejlkhh0 is actually 24 (which equals 16 seconds), and the 
default value of 1,024 seconds can be noted as iejlkhh-, (210). Any value between 4 and 
17, inclusive, can be used.
If you are configuring an NTP node as a server, you can use the broadcast mechanism 
as well. This makes sense if your server is used as the NTP time server for local computers 
that are on the same network (because broadcast packets are not forwarded by routers). 
If you want to do this, make sure the line ^nk]`_]op-5.*-24*,*.11 (use the broadcast 
address for your network) is included in the jpl*_kjb file on your server and that the 
^nk]`_]op_heajp setting is used on the client computer.
If you want to configure a secure NTP time server, you should think twice before con-
figuring the ^nk]`_]op setting. Typically, a broadcast client takes its time from any server 
in the network, as long as it broadcasts NTP packets on the default NTP port 123. There-
fore, to change the time on all computers in your network, someone could introduce 
a bogus NTP time server with a very high stratum configured.
Configuring an NTP Client
The first thing to do when configuring a server to act as an NTP client is to make sure 
that the time is more or less accurate. If the difference is greater than 1,024 seconds, NTP 
considers the time source to be bogus and refuses to synchronize with it. Therefore, it’s 
recommended that you synchronize time on the NTP client manually before continuing. 
To manually synchronize the time, the jpl`]pa command is very useful: use it to get time 
only once from another server that offers NTP services. To use it, specify the name or IP 
address of the server you want to synchronize with as its argument:
jpl`]pajpl*ukqnlnkre`an*okiasdana
By using this command, you’ll make a  once- only time adjustment on the client 
computer. After that, you can set up jpl` for automatic synchronization on the client 
computer.
NCaution Too often, jpl`]pa is used only for troubleshooting purposes, after the administrator finds out 
that jpl` isn’t synchronizing properly. In this case, the administrator is likely to see a “socket already in 
use” error message. This happens because jpl` has already claimed port 123 for NTP time synchroniza-
tion. You can verify this with the japop]p)lh]pqjaxcnal-./ command, which displays the application 
currently using port 123. Before jpl`]pa can be used successfully in this scenario, the administrator should 
make sure that jpl` is shut down on the client by using +ap_+ejep*`+jplopkl.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
326
If the time difference between server and client is not greater than 1,000 seconds, 
jpl*_kjb can be configured on the NTP client. A typical NTP client configuration is very 
simple—you just need to specify the server you want to get the time from, as in the fol-
lowing example:
oanran-5.*-24*,*-,
You may also prefer to set a backup option by using the bq`ca option, but this is 
optional. Normally, I recommend that you don’t set this option on every single server in 
the network that’s using NTP. As an administrator, you might prefer to set this on one 
server in your network only and let all other NTP clients in your network get the time 
from that server. So, to create an NTP hierarchy, I recommend letting one or two servers 
in the network get their time from a reliable time source on the Internet, such as lkkh*
jpl*knc. Next, to ensure that an NTP time source is still available when the Internet con-
nection goes down, use the bq`ca option on the same servers. Doing so ensures that they 
will still be the servers with the highest stratum level in your network, and time services 
will not be interrupted.
Checking NTP Synchronization Status
After you’ve started the NTP service on all computers in your network, you probably want 
to know whether it’s working correctly. The first tool to use is the jplpn]_a command, 
which provides an overview of the current synchronization status. When using jplpn]_a, 
you should be aware that it will always take some time to establish NTP synchronization. 
The delay occurs because an NTP client normally synchronizes only every 16 seconds, 
and it may fail to establish correct synchronization the first time it tries. Normally, how-
ever, it should take no longer than a few minutes to establish NTP time synchronization.
Another tool to tune the working of NTP is the jplm command, which offers its own 
interactive interface from which the status of any NTP service can be requested. As 
when using the FTP client, you can use a couple of commands to “remotely control” 
the NTP server. In this interface, you can use the dahl command to see a list of available 
commands.
As an alternative, you can run jplm with some  command- line options. For example, 
the jplm)l command gives an overview of current synchronization status.  Listing 13-3 
provides an example of the result, in which several parameters are displayed:
 s  naikpa: The name of the other server
 s  nabe`: The IP address of the server you are synchronizing with
 s  op: The stratum used by the other server
 s  p: The type of clock used on the other server (H stands for local clock; q for an Inter-
net clock) 
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
327
 s  sdaj: The number of seconds since the last poll
 s  lkhh: The number of seconds used between two polls
 s  na]_d: The number of times the other server has been contacted successfully
 s  `ah]u: The time between an NTP request and the answer
 s  kbboap: The difference, in seconds, between the time on your local computer and 
that on the NTP server
 s  feppan: The error rate in your local clock, expressed in seconds
 Listing 13-3. Use ntpq -p to Slow the Current Synchronization Status on Your Server
nkkp<NJ=6zjplm)l
naikpanabe`oppsdajlkhhna]_d`ah]ukbboapfeppan
9999999999999999999999999999999999999999999999999999999999999999999999
bekn`h]j`*q^qjp-5.*/2*-//*-3.q-,20-.*.03)/13045,*,,.
Customizing Your NTP Server
Thus far, I have explained the basic NTP time configuration, but you can also  fine- tune 
the configuration to guarantee a higher degree of precision. There are several files that 
you can use for this purpose. First are the files that are created automatically by the 
NTP daemon. Next, there are some security settings in jpl*_kjb that you can use to limit 
which servers are allowed to get time from your server. In this section, you’ll read about 
 fine- tuning the NTP drift file and NTP log file and applying NTP security.
Configuring the NTP Drift File
No matter how secure the local clock on your computer is, it’s always going to be slightly 
off: either too fast or too slow. For example, a clock might lag behind NTP time by 2 sec-
onds every hour. This difference is referred to as the clock’s drift factor, and it’s calculated 
by comparing the local clock with the clock on the server that provides NTP time to the 
local machine. Because NTP is designed also to synchronize time when the connection to 
the NTP time server is lost, the NTP process on your local computer must know what this 
drift factor is. So, to calculate the right setting for the drift factor, it’s very important that 
an accurate time is being used on the server with which you are synchronizing.
Once NTP time synchronization has been established, a drift file is created automati-
cally. On Ubuntu Server, this file is created in +r]n+he^+jpl+jpl*`nebp, and the local NTP 
process uses it to calculate the exact drifting of your local clock, which thus allows it to 
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
328
compensate for the drift. Because the drift file is created automatically, you don’t need to 
worry about it. However, you can choose where the file is created by using the `nebpbeha 
parameter in jpl*_kjb:
`nebpbeha+r]n+he^+jpl+jpl*`nebp
NNote Remember that NTP is a daemon. Like most daemons, it reads its configuration file only when it’s 
first started. So, after all modifications, use +ap_+ejep*`+jpl`naop]np to make sure that the modifica-
tions are applied to your current configuration.
Configuring the NTP Log File
The NTP log file is another file that’s created automatically for you. Like all other log files, 
this file is very important because it allows you to see exactly what has happened when 
something goes awry. If time is synchronized properly, it’s not the most interesting log 
file on your system: it just tells you that synchronization has been established and what 
server is used for synchronization. After installation, Ubuntu Server is not set up to cre-
ate an individual log file for time services, but you can change that by using the hkcbeha 
statement in +ap_+jpl*_kjb. This may be a good idea if you want to change the messages 
generated by the time server from the generic messages in +r]n+hkc+iaoo]cao.
hkcbeha+r]n+hkc+jpl
Applying NTP Security
If your NTP server is connected to the Internet, you may want to restrict access to it. If no 
restrictions are applied, the entire world can access your NTP server. If you don’t like that 
idea, add some lines to jpl*_kjb, as shown in  Listing 13-4.
 Listing 13-4. Applying Security Restrictions to Your NTP Time Server
naopne_p`ab]qhpjkmqanujkpnqopjkik`ebu
naopne_p-.3*,*,*-
naopne_p-5.*-24*,*,i]og.11*.11*.11*,
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
329
NNote Some Linux distributions configure their NTP service in such a way that no one can access it. 
Having problems getting time from a server? Make sure that at least some minimal restrictions are in place 
that allow other servers to use the server in question as an NTP server.
The naopne_p settings prevent inappropriate conduct of clients. The first line of 
 Listing 13-4 specifies what exactly is considered inappropriate. First, it allows the default 
settings for accessing the server. Next, it disallows three types of packets, using jkmqanu, 
jkpnqop, and jkik`ebu. Disallowing these packets ensures that no contact whatsoever 
is allowed for NTP clients. In the second and third lines of  Listing 13-4, exceptions to 
these settings are created for the local NTP service and all computers in the network 
-5.*-24*,*,. Add a similar naopne_p line for every IP address or range of IP addresses that 
has to be allowed to use your NTP server.
Understanding Kerberos
Before you start to configure Kerberos, you need to know more about how it functions. 
Too many people try to configure it without understanding what they are doing, and that 
simply doesn’t work. When MIT developed Kerberos, it had three design goals in mind:
 s  &IND AN ALTERNATIVE FOR PASSWORDS CIRCULATING ON THE NETWORK
 s  -ANAGE ACCESS RIGHTS TO SERVICES
 s  $EAL WITH USER DATABASES
Kerberos version 5 fulfills all three design goals. Of these, the most interesting is how 
Kerberos deals with passwords. No passwords are ever stored locally on a machine, no 
matter whether that machine is a server or a workstation. This greatly reduces your risks 
when your machine gets hacked, and that is also the most important reason why many 
Linux services currently are available in a Kerberized version, which is a version that uses 
Kerberos instead of the normal authentication mechanism. 
In a Kerberos environment, three parties play a role:
 s  #LIENT
 s  3ERVICE
 s  +EY $ISTRIBUTION #ENTER +$#	
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
330
These three parties mutually trust one another, because they are in the same realm, 
a trusted environment set up by an administrator. A Kerberos session always begins 
with the user logging in to the KDC. The KDC has a database with password hashes (so it 
doesn’t know the actual user passwords). When authenticating, the user creates a hash 
that is based on his password. By comparing the hashes, the KDC can verify that the 
user has entered the correct password. If this is the case, the KDC gives the user a Ticket 
Granting Ticket (TGT).
Next, the user uses the TGT to get access to services. The KDC again plays an impor-
tant role, because it grants a session ticket for each of the services the user wants to 
connect to. Once this session ticket is obtained, the user can access related services for as 
long as he remains logged in. 
NNote The goal of this chapter is to help you configure Kerberos, not to make you an expert in Kerberos 
cryptography. Therefore, I have simplified this section a bit to make it easier to understand what is happen-
ing. You can find a good detailed explanation of Kerberos cryptography at dppl6++aj*segela`e]*knc+
sege+Gan^anko[lnkpk_kh.
Installing and Configuring Kerberos
To install Kerberos on Ubuntu Server, you have to install several packages. Use ]lp)cap
ejop]hh to install the packages gn^1)]`iej)oanrer, gn^1)gdc, gn^1)_kjbig, gn^1)qoer, and 
gn^1)_heajts. When you install the packages using ]lp)capejop]hhgn^1)]`iej)oanran
gn^1)g`_gn^1)_kjbecgn^1)qoangn^1)_heajts, the installation program automati-
cally starts a configuration program to create a realm and add servers to it. (Again, the 
Kerberos realm is the trusted environment shared by the different users and servers 
involved in Kerberos.) As the name of the realm, the installer takes your DNS suffix. If 
you don’t like that choice, no problem, because you can change it later. The installer next 
asks you to list the servers you want to add to the realm (see  Figure 13-1). You just need to 
enter the names of servers that you want to be KDC servers in this interface. You probably 
just want one server name here. Enter the name of this server and then proceed to the 
next screen.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
331
 Figure 13-1. The installation program helps you to set up a Kerberos realm.
In the realm, you will have one server that is used as the administrative server. Enter 
the name of the server that you want to use for that purpose (see  Figure 13-2) and then 
proceed to the next screen.
 Figure 13-2. One of the servers in the realm is used as the administrative server.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
332
While the installer is finishing the software installation, you may see an error gener-
ated by g]`iej`, complaining that it is missing a file. For now, ignore this error; you will fix 
it later when you are setting up Kerberos. The software installation is now completed and 
you have a basic working configuration. In the next section you’ll read how to tune this 
configuration.
Configuring the Kerberos Server
There are two configuration files involved in configuring a Kerberos server: +ap_+gn^1*
_kjb, which contains generic Kerberos configuration settings, and +ap_+gn^1g`_+g`_*_kjb, 
in which you’ll find the configuration of the KDC. In this section, you’ll first tune these 
two Kerberos configuration files. After that, you’ll create the Kerberos database and the 
stash file; set up a Kerberos administrative user account for authentication purposes; 
add user accounts; and, finally, verify that the KDC is operating properly.
Configuring Generic Kerberos Settings
 Listing 13-5 shows the contents of +ap_+gn^1*_kjb after installation of the Kerberos pack-
ages (for readability, I have removed some of the default sections that you probably don’t 
need to see anyway).
 Listing 13-5. The krb5.conf Configuration File Just After Kerberos Installation
nkkp<q^qjpq6+ap__]pgn^1*_kjb
Whe^`ab]qhpoY
`ab]qhp[na]hi9O=J@ANR=JRQCP*JH
Pdabkhhksejcgn^1*_kjbr]ne]^hao]nakjhubknIEPGan^anko*
gn^0[_kjbec9+ap_+gn^*_kjb
gn^0[na]hio9+ap_+gn^*na]hio
g`_[peiaouj_9-
__]_da[pula90
bkns]n`]^ha9pnqa
lnkte]^ha9pnqa
Pdabkhhksejcaj_nulpekjpulaola_ebe_]pekjsehh^aqoa`^uIEPGan^anko
ebqj_kiiajpa`*Ejcajan]h(pda`ab]qhpoejpdaIEPGan^anko_k`a]na
_knna_p]j`kranne`ejcpdaoaola_ebe_]pekjokjhuoanraopk`eo]^hajas
aj_nulpekjpulao]opdau]na]``a`(_na]pejcejpanklan]^ehepulnk^haio*
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
333
`ab]qhp[pco[aj_pulao9]ao.12)_po]n_bkqn)di]_)i`1`ao/)di]_)od]-X
`ao)_^_)_n_`ao)_^_)i`1
`ab]qhp[pgp[aj_pulao9]ao.12)_po]n_bkqn)di]_)i`1`ao/)di]_)od]-X
`ao)_^_)_n_`ao)_^_)i`1
lanieppa`[aj_pulao9]ao.12)_po]n_bkqn)di]_)i`1`ao/)di]_)od]-X
`ao)_^_)_n_`ao)_^_)i`1
Pdabkhhksejche^`ab]qhpol]n]iapano]nakjhubknDaei`]hGan^anko*
r0[ejop]j_a[naokhra9b]hoa
r0[j]ia[_kjranp9w
dkop9w
n_i`9dkop
bpl9bpl
y
lh]ej9w
okiapdejc9okiapdejc)ahoa
y
y
b__)iep)pe_gapbh]co9pnqa
Wna]hioY
O=J@ANR=JRQCP*JH9w
g`_9iah
g`_9iuh
g`_9q^qjpq
]`iej[oanran9iah
y
=PDAJ=*IEP*A@Q9w
g`_9gan^anko*iep*a`q644
g`_9gan^anko)-*iep*a`q644
g`_9gan^anko).*iep*a`q644
]`iej[oanran9gan^anko*iep*a`q
`ab]qhp[`ki]ej9iep*a`q
y
IA@E=)H=>*IEP*A@Q9w
***
?O*?IQ*A@Q9w
g`_9gan^anko*_o*_iq*a`q
g`_9gan^anko).*onr*_o*_iq*a`q
]`iej[oanran9gan^anko*_o*_iq*a`q
y
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
334
@AIAJPE=*KNC9w
g`_9gan^anko*`aiajpe]*knc
g`_9gan^anko.*`aiajpe]*knc
]`iej[oanran9gan^anko*`aiajpe]*knc
y
op]jbkn`*a`q9w
g`_9gn^1]qpd-*op]jbkn`*a`q
g`_9gn^1]qpd.*op]jbkn`*a`q
g`_9gn^1]qpd/*op]jbkn`*a`q
]`iej[oanran9gn^1)]`iej*op]jbkn`*a`q
`ab]qhp[`ki]ej9op]jbkn`*a`q
y
W`ki]ej[na]hiY
*iep*a`q9=PDAJ=*IEP*A@Q
iep*a`q9=PDAJ=*IEP*A@Q
*ia`e]*iep*a`q9IA@E=)H=>*IEP*A@Q
ia`e]*iep*a`q9IA@E=)H=>*IEP*A@Q
*_o]eh*iep*a`q9?O=EH*IEP*A@Q
_o]eh*iep*a`q9?O=EH*IEP*A@Q
*sdke*a`q9=PDAJ=*IEP*A@Q
sdke*a`q9=PDAJ=*IEP*A@Q
*op]jbkn`*a`q9op]jbkn`*a`q
WhkcejY
gn^0[_kjranp9pnqa
gn^0[cap[pe_gapo9b]hoa
The following are the sections that you might want to edit in the default configura-
tion file shown in  Listing 13-5:
 s  Whe^`ab]qhpoY: Defines the name of your realm. If you want to change the name, 
change it here. 
 s  Wna]hioY: Defines the realm itself, based on the name that is used in Whe^`ab]qhpoY. 
By default, you’ll find two different kinds of lines: the g`_ lines are used to define 
the servers that can be used as KDC servers, and the ]`iej[oanran line defines 
which of the servers has administrative privileges. If you need to add new servers 
to your Kerberos configuration, do it here. As you can see, some default realms are 
included as well. You don’t need them, so you can remove them if you prefer. 
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
335
 s  W`ki]ej[na]hiY: Contains a list of DNS domains and their corresponding Kerberos 
realms. This section is useful to connect realms that are not in your own company. 
As you see, your current realm is not added here automatically. You should fix 
that, by adding two lines to the bottom of this section. In my case, I added the fol-
lowing two lines to make a mapping between DNS and the Kerberos realm:
o]j`anr]jrqcp*jh9O=J@ANR=JRQCP*JH
*o]j`anr]jrqcp*jh9O=J@ANR=JRQCP*JH
 s WhkcejY: Contains some default settings that are used in the authentication pro-
cedure. Of all these parameters, normally you don’t need to change many. Just 
make sure that the realm name is the name you want to use and that all KDC 
servers are listed.
Configuring the KDC Settings
The second configuration file, +ap_+gn^1g`_+g`_*_kjb, contains default settings for the 
KDC.  Listing 13-6 shows its default configuration right after installation of the Kerberos 
packages on Ubuntu Server.
 Listing 13-6. kdc.conf Contains Default Settings for the KDC
nkkp<q^qjpq6+ap_+gn^1g`__]pg`_*_kjb
Wg`_`ab]qhpoY
g`_[lknpo931,(44
Wna]hioY
O=J@ANR=JRQCP*JH9w
`]p]^]oa[j]ia9+r]n+he^+gn^1g`_+lnej_el]h
]`iej[gaup]^9BEHA6+ap_+gn^1g`_+g]`i1*gaup]^
]_h[beha9+ap_+gn^1g`_+g]`i1*]_h
gau[op]od[beha9+ap_+gn^1g`_+op]od
g`_[lknpo931,(44
i]t[heba9-,d,i,o
i]t[najas]^ha[heba93`,d,i,o
i]opan[gau[pula9`ao/)di]_)od]-
oqllknpa`[aj_pulao9`ao/)di]_)od]-6jkni]h`ao)_^_)_n_6jkni]h±
`ao6jkni]h`ao6r0`ao6jkna]hi`ao6kjhuna]hi`ao6]bo/
`ab]qhp[lnej_el]h[bh]co9'lna]qpd
y
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
336
In the g`_*_kjb file, the Wna]hioY section defines settings for each of your realms, with 
the name of your realm in all uppercase letters. All particular settings for that realm are 
listed between curly brackets. As you can see in  Listing 13-6, basically they are just lists of 
where to find certain files. In this file also, you normally don’t have to change much to get 
a working Kerberos server.
Creating the Kerberos Database and the Stash File
After you have set up the configuration files properly, it’s time to create the Kerberos 
database and the stash file. The stash file contains a local encrypted copy of the master 
key and is used to automatically authenticate the KDC when your server boots. To pro-
tect the stash file, you need to enter a password twice when creating it. 
 Listing 13-7 shows an example of creating the configuration using the g`^1[qpeh
_na]pa)o command. If you want to create the configuration files for a different realm, 
use )nna]hi to specify the name of the realm you want to create them for. For instance, 
g`^1[qpeh)niuna]hi)o would initialize the configuration for a realm with the name 
iuna]hi.
 Listing 13-7. To Initialize the Kerberos Configuration, Use krdb5_util create -s
nkkp<q^qjpq6zg`^1[qpeh_na]pa)o
Hk]`ejcn]j`ki`]p]
Ejepe]hevejc`]p]^]oa#+r]n+he^+gn^1g`_+lnej_el]h#bknna]hi#O=J@ANR=JRQCP*JH#(
i]opangauj]ia#G+I<O=J@ANR=JRQCP*JH#
Ukqsehh^alnkilpa`bknpda`]p]^]oaI]opanL]ooskn`*
Epeoeilknp]jppd]pukqJKPBKNCAPpdeol]ooskn`*
AjpanG@?`]p]^]oai]opangau6
Na)ajpanG@?`]p]^]oai]opangaupkranebu6
As the result of this command, various files are created in the directory +r]n+he^+
gn^1g`_: the Kerberos database in the files lnej_el]h*`^ and lnej_el]h*kg, the adminis-
trative database in lnej_el]h*g]`i1, the database lock file in lnej_el]h*g]`i1*hk_g, and 
the stash file in *g1op]od. One file is not created automatically, g`]`i*]_h, which contains 
access control lists for your Kerberos configuration. Create it in +ap_+gn^1g`_ and give it 
the following contents:
&+]`iejUKQNNA=HI*SD=PARAN
For instance, in my case, this would be &+]`iejO=J@ANR=JRQCP*JH.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
337
Starting Kerberos and Creating an Administrative User Account
Now that you have set up Kerberos, make sure that it is started. On Ubuntu Server, 
Kerberos is managed with two scripts in +ap_+ejep*`: gn^1)]`iej)oanran and gn^1)gdc. If 
your server is both a KDC server and the administrative server, restart both of these ser-
vices, as follows. If your server is just a KDC server, you only need the last of these two 
lines.
+ap_+ejep*`+gn^1)]`iej)oanrannaop]np
+ap_+ejep*`+gn^1)g`_naop]np
One of the first things you need to configure is a Kerberos administrative user 
account that you can use for authentication purposes. To create this account, you’ll use 
the ]``lnej_ command from the g]`iej*hk_]h interface. So at this point, first enter the 
command g]`iej*hk_]h. Make sure that the user you create is added to the ]`iej group. 
You can do that by using a slash between the user and the group name when creating it; 
]``lnej_o]j`an+]`iej would create a user with the name o]j`an and put that user in the 
]`iej group.  Listing 13-8 shows all commands that are required to set up such an admin-
istrative user account.
NNote In Kerberos, you don’t create “user accounts,” you create “principals.” A principal is something 
that can log in. Principals can be users or workstations. In this discussion, I prefer to stick with the traditional 
Linux terminology, “user accounts.”
 Listing 13-8. Setting Up an Administrative User Account
nkkp<q^qjpq6+ap_+ejep*`g]`iej*hk_]h
=qpdajpe_]pejc]olnej_el]hnkkp+]`iej<O=J@ANR=JRQCP*JHsepdl]ooskn`*
g]`iej*hk_]h6]``lnej_o]j`an+]`iej
S=NJEJC6jklkhe_uola_ebea`bkno]j`an+]`iej<O=J@ANR=JRQCP*JH7±
`ab]qhpejcpkjklkhe_u
Ajpanl]ooskn`bknlnej_el]ho]j`an+]`iej<O=J@ANR=JRQCP*JH6
Na)ajpanl]ooskn`bknlnej_el]ho]j`an+]`iej<O=J@ANR=JRQCP*JH6
Lnej_el]ho]j`an+]`iej<O=J@ANR=JRQCP*JH_na]pa`*
g]`iej*hk_]h6mqep
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
338
Adding User Accounts
Now that the Kerberos server is configured and operational, it’s time to add user accounts. 
This is something that you must do for all users you want to be capable of using Kerberos. 
To do this, you can use the g]`iej*hk_]h command.  Listing 13-9 shows how this command 
is used to add an account for user o]j`an. This account must be added in order to use the 
administrative user o]j`an (created in  Listing 13-8) for administration purposes. 
 Listing 13-9. Use kadmin.local to Add User Accounts to Your Kerberos Configuration
nkkp<q^qjpq6+ap_+gn^1g`_g]`iej*hk_]h
=qpdajpe_]pejc]olnej_el]hnkkp+]`iej<O=J@ANR=JRQCP*JHsepdl]ooskn`*
g]`iej*hk_]h6]``lnej_o]j`an
S=NJEJC6jklkhe_uola_ebea`bkno]j`an<O=J@ANR=JRQCP*JH7`ab]qhpejcpkjklkhe_u
Ajpanl]ooskn`bknlnej_el]ho]j`an<O=J@ANR=JRQCP*JH6
Na)ajpanl]ooskn`bknlnej_el]ho]j`an<O=J@ANR=JRQCP*JH6
Lnej_el]ho]j`an<O=J@ANR=JRQCP*JH_na]pa`*
g]`iej*hk_]h6m
Verifying that the KDC Is Operational
So far, you have set up your Kerberos server, but you haven’t tested whether it really 
works. That’s going to change now. First, you are going to use the gejep command, fol-
lowed by your username, to get a Ticket Granting Ticket from the KDC. Next, you are 
going to use the gheop command to see if you have obtained this TGT.  Listing 13-10 shows 
the result of these two commands.
 Listing 13-10. Use kinit and klist to Verify Your KDC Is Operational
nkkp<iah6zgejepo]j`an
L]ooskn`bkno]j`an<O=J@ANR=JRQCP*JH6
nkkp<iah6zgheop
Pe_gap_]_da6BEHA6+pil+gn^1__[,
@ab]qhplnej_el]h6o]j`an<O=J@ANR=JRQCP*JH
R]he`op]npejcAtlenaoOanre_alnej_el]h
,5+,-+,4,36/16.,,5+,-+,4-36/16.,gn^pcp+O=J@ANR=JRQCP*JH<O=J@ANR=JRQCP*JH
najasqjpeh,5+,.+,4,36/16-4
Gan^anko0pe_gap_]_da6+pil+pgp,
gheop6Ukqd]rajkpe_gapo_]_da`
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
339
Configuring the Kerberos Client
Now that you’ve set up the Kerberos server, it is time to configure the client. A “client” 
in this context is a service that uses Kerberos services. Basically, that means that the 
Kerberos client uses some application that talks to the KDC to handle authentication. 
First, I explain how to configure the nod and nhkcej services as Kerberos clients. Because 
I intend simply to demonstrate how configuring a Kerberos client works, I’ve chosen two 
 easy-to- configure applications. After that, you’ll read how to handle authentication with 
a Kerberos server.
Configuring Simple Kerberos Applications
Setting up a simple Kerberos application requires the following steps:
 
1. Make sure that each client has a gn^1*_kjb configuration file that contains valid 
settings and shows the client where to find the realm and its associated KDC serv-
ers. Normally, this is the same file as the gn^1*_kjb file on the KDC, so you can just 
copy and use that.
 
2. Install the Kerberos packages on the client. Use the package manager on your 
client to set this up. On Ubuntu Desktop Edition, it is a good start to install the 
gn^1)qoan and gn^1)_heajp packages. 
NTip For an initial Kerberos test, it is a good idea to use the Remote Shell (nod) service. This service is 
easy to configure and completely Kerberized (and therefore secure). Make sure that on your server the pack-
age gn^1)nod)oanran is installed, and install gn^1)qoan on the client to configure this service.
 
3. To start the Kerberized versions of your software (nod and nhkcej in this example), 
start them with tejap`.
 
4. On the server, you need to add an account for your server. Assuming the name of 
your server is ^h]d*at]ilha*_ki, use the following command from the g]`iej*hk_]h 
interface on your KDC server:
]``lnej_)n]j`gaudkop+^h]d*at]ilha*_ki
 
5. Start all services on your server that use Kerberos. They will use the Kerberos 
configuration automatically.
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
340
Logging In with Kerberos
Okay, you likely haven’t set up Kerberos to use a Kerberized version of nod, have you? 
Let’s talk about the real work now and see what you need to do to enable a workstation 
to log in using Kerberos. Because I can’t possibly provide a generic login procedure that 
works on all Linux distributions, you may encounter differences with regard to the names 
of files and services as you work through the following procedure, which describes how to 
use Kerberos for login authentication on Ubuntu Desktop Edition. The steps in this sec-
tion assume that you have already performed a basic Kerberos configuration on the client 
computer, as described in the preceding section. 
 
1. Make a connection between the PAM login service and Kerberos, by including in 
+ap_+gn^1*_kjb an W]ll`ab]qhpoY section that defines how to use PAM.  Listing 13-11 
shows an example.
 Listing 13-11. PAM Settings in krb5.conf
W]ll`ab]qhpoY
l]i9w
`a^qc9b]hoa
pe_gap[hebapeia9/2,,,
najas[hebapeia9/2,,,
bkns]n`]^ha9pnqa
dkopo9iah*o]j`anr]jrqcp*jh
i]t[peiakqp9/,
peiakqp[odebp9.
ejepe]h[peiakqp9-
y
 
2. Install the PAM modules for Kerberos support if they not already installed. On 
Ubuntu Desktop Edition, the name of the module is he^l]i)gnb5. Use your favorite 
package manager to install it (for instance, ]lp)capejop]hhhe^l]i)gnb5).
 
3. To make sure that Kerberos handles authentication for all  PAM- enabled services, 
add a line to each of the four PAM files that are used by almost all authentication 
processes, as follows:
  s  _kiikj)]qpd: Add the following line:
]qpdoqbbe_eajp+he^+oa_qnepu+l]i[gn^1*ok
  s  _kiikj)]__kqjp: Add the following line:
]__kqjpoqbbe_eajp+he^+oa_qnepu+l]i[gn^1*ok
www.it-ebooks.info

CHAPTER 13 N   CONFIGURING KERBEROS AND NTP ON UBUNTU SERVER 
341
  s  _kiikj)oaooekj: Add the following line:
oaooekjklpekj]h+he^+oa_qnepu+l]i[gn^1*ok
  s  _kiikj)l]ooskn`: Add the following line:
l]ooskn`oqbbe_eajp+he^+oa_qnepu+l]i[gn^1*okqoa[]qpdpkg
 
 These changes make sure that Kerberos is always tried first in all steps of the 
authentication process. If authentication using Kerberos fails, your server will fail 
back to normal l]oosd- based authentication.
 
4. At this point, your workstation can authenticate against the Kerberos KDC. You 
should now first try to authenticate without logging out (that makes troubleshoot-
ing easier if it fails). For instance, you could use the oodhk_]hdkop command for 
a quick and easy test. Use the Kerberos accounts that you created earlier on your 
server.
 
5. Did it work? Good! At this point, you have to create Kerberos accounts for all user 
accounts. Unfortunately, there is no good automated method to do this yet. On 
the Kerberos administrative server, use g]`iej*hk_]h, and from there use ]``lnej_ 
to add your Kerberos user accounts.
Summary
Kerberos is an important technology that you can use for authentication purposes. In this 
chapter you read how to set up NTP (which is a requirement for Kerberos to work prop-
erly) and the Kerberos server. You also learned how to configure a Kerberos client and use 
some basic services that are Kerberos enabled. In the final and last chapter of this book, 
you’ll learn how to troubleshoot Ubuntu Linux.
www.it-ebooks.info

343
C H A P T E R  1 4
Ubuntu Server Troubleshooting
Fixing the Most Common 
Problems
Although Ubuntu Server is an extremely stable server operating system, you might 
encounter problems occasionally, ranging from a  Linux- related issue to a simple hard-
ware failure. In this chapter you’ll learn how to troubleshoot some of the most common 
problems. 
Some say troubleshooting is difficult and requires years of experience. Experience 
indeed helps, but a good analytical mind is the most important troubleshooting tool. In 
 day-to- day troubleshooting, you first have to determine where exactly a given problem 
has occurred. If, for example, you have a problem with a kernel module, it doesn’t make 
much sense to troubleshoot your web server. 
After determining the location and scope of the problem as well as you can, you can 
apply your skills to fix the problem. This requires that you have a good understanding of 
how the erratic system component is supposed to function and can choose the correct 
tool to repair it. This chapter first explains how to determine where exactly a problem has 
occurred. Next, it introduces you to some of the best troubleshooting tools to use. Finally, 
this chapter identifies some of the most common problems and explains how to fix them. 
NNote This chapter assumes that you are familiar with basic principles of Ubuntu system administration. 
If you want to refresh your knowledge, try Beginning Ubuntu LTS Server Administration, Second Edition, in 
which I explain essential concepts such as the boot procedure and kernel management.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
344
Identifying the Problem
The most common first step when trying to identify a problem is to reboot your server 
and wait until the problem occurs. Most problems reveal themselves as your server 
boots, because most services are activated during the boot process. Therefore, knowing 
the different stages of the boot process is very important. If you succeed in determining 
the stage in which a problem occurs, you have made a good start in troubleshooting the 
problem. The following list summarizes the different phases in the boot process:
 
1. Hardware initialization: Hardware initialization occurs during the Power On Self 
Test (POST). During this phase, your computer reads the BIOSes of the different 
hardware components and performs a check to see if all devices can initialize 
properly. If any of them can’t initialize properly, you will not see the Grub prompt 
appear on your server and your server will warn you with clear error messages or 
beeps. If that happens, consult the documentation of your server to find out how 
to fix the hardware issue. 
 
2. Grub loading: After initializing the hardware, the server accesses the boot device 
and reads the boot loader in the master boot record (MBR), which is the first sec-
tor of 512 bytes at the beginning of the bootable hard drive. The MBR includes 
two important components. First is the Grub boot loader. This system component 
is installed in the first 446 bytes of the MBR and makes sure that the operating 
system on your server can load. To do this, Grub accesses its configuration in the 
directory +^kkp+cnq^. Second in the MBR is the partition table. This component is 
essential for accessing all files on your server. If in this stage there is an error, you 
typically get a Grub error and, most important, the kernel will not start to load. If 
there is no error, you can access the Grub menu, displayed in  Figure 14-1. So if you 
see that the kernel has started to load (see  Figure 14-2), you know that your server 
has passed stages 1 and 2 successfully.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
345
 Figure 14-1. If you see the Grub menu, the first 446 bytes of the MBR have been read.
 Figure 14-2. The kernel has started to load, which indicates the first two stages of your 
server’s boot procedure have completed successfully. 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
346
 
3. Kernel and initrd loading: If you see that the kernel starts loading, that doesn’t 
guarantee success with regard to the kernel and the ramfs image that contains 
some required drivers. It’s possible that either the kernel itself or some of the driv-
ers associated with the kernel still may not load. If that is the case, you will see the 
message “kernel panic” in most cases, or sometimes the kernel just stops load-
ing, as in the example shown in  Figure 14-3. Either way, you know for sure that 
the error is related to the kernel. You might get a kernel panic if you have tried to 
recompile the kernel and failed, or if one of the parameters that you have passed 
to Grub is wrong. A kernel panic can also be caused by a failing kernel module, but 
this is rare. So, if you’ve just recompiled your kernel and then get a kernel panic 
when you attempt to reboot, you know what is wrong (you did keep a copy of 
your old kernel, didn’t you?). If you didn’t recently recompile your kernel, check 
whether something has changed recently with regard to Grub parameters. If not, 
you may have a failing driver, or initrd. 
NTip Grub by default is configured not to show information about the kernel initialization. To make trouble-
shooting easier, I recommend removing the line that reads mqeap from the +^kkp+cnq^+iajq*hop file. If 
you see a olh]od9 statement, remove that as well. 
 Figure 14-3. If the kernel just stops loading, the problem is definitely in phase 3 of the boot 
procedure.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
347
 
4. Upstart: On Ubuntu Server, Upstart is responsible for starting the ejep process 
and associated essential services. To do this, Upstart executes all scripts it finds in 
the directory +ap_+arajp*` (see  Listing 14-1). You will rarely see messages that are 
related to Upstart itself, because it is just the service that is responsible for loading 
other services. If, however, none of the services on your server can initialize, or you 
get an error related to ejep (such as you can see in  Figure 14-2), something may 
be wrong with Upstart. Make sure that its configuration directory, +ap_+arajp*`, is 
readable.
 Listing 14-1. To Start Important System Services, Upstart Reads the Configuration 
Files in /etc/event.d
nkkp<IUH6+ap_+arajp*`ho
_kjpnkh)]hp)`ahapan_-n_0n_)`ab]qhpoqhkcejppu/ppu2
hkc`n_.n_1n_Oppu-ppu0
n_,n_/n_2n_O)oqhkcejppu.ppu1
 
5. Essential services: Once Upstart has loaded, it starts executing the scripts it finds in 
+ap_+arajp*`. Basically, these scripts don’t execute anything, but just redirect you 
to other scripts that are in the directory +ap_+ejep*` and executed from the direc-
tory that corresponds to the current runlevel. For example, if you are currently in 
runlevel 3, the services that are started are started from the directory +ap_+n_/*` 
(see  Listing 14-2).
 
 There is such a directory for every runlevel between 0 and 6, inclusive, deter-
mining exactly what should be started when entering a runlevel. As you can 
see in  Listing 14-2, the runlevel directories don’t contain real files, but instead 
contain symbolic links to files that are located in the directory +ap_+ejep*`. 
Here the system finds the real services that it should start. If one of these script 
fails, you typically see an error. Because these are essential services, such as 
the service that loads file systems, your system will most likely stop, giving you 
a clear indication of what is wrong. If the problem is obvious, you can just fix 
the problem. In some cases, the problem might not be obvious, in which case 
you should look at the order in which the scripts are started and try to deduce 
from that order which script failed. For instance, if you notice that the SSH 
process never gets loaded, it is obvious that the problem is in one of the scripts 
executed just before that.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
348
 Listing 14-2. The Order of the Runlevel Scripts May Help You to Find Which Script Failed
nkkp<iah6+ap_+n_/*`ho)h
pkp]h0
)ns)n))n))-nkkpnkkp112.,,4),0)-5,-6,1NA=@IA
hnstnstnst-nkkpnkkp-4.,,4),0).5-061.O-,ouoghkc`):**+ejep*`+ouoghkc`
hnstnstnst-nkkpnkkp/0.,,4),1),-,26-1O-,toanran)tknc)ejlqp)s]_ki):±
**+ejep*`+toanran)tknc)ejlqp)s]_ki
hnstnstnst-nkkpnkkp-1.,,4),0).5-061.O--ghkc`):**+ejep*`+ghkc`
hnstnstnst-nkkpnkkp-0.,,4),2)..-0604O-.`^qo):**+ejep*`+`^qo
hnstnstnst-nkkpnkkp-3.,,4),4).1-060.O-2klajrlj):**+ejep*`+klajrlj
hnstnstnst-nkkpnkkp-0.,,4),0)/,-0611O-2ood):**+ejep*`+ood
hnstnstnst-nkkpnkkp./.,,4),4)-1,1613O-3iuomh)j`^)ici):±
**+ejep*`+iuomh)j`^)ici
hnstnstnst-nkkpnkkp-3.,,4),1)-3--6/0O-3lknpi]l):**+ejep*`+lknpi]l
hnstnstnst-nkkpnkkp-5.,,4),4)-1,1613O-4iuomh)j`^):**+ejep*`+iuomh)j`^
hnstnstnst-nkkpnkkp-0.,,4),1)-3--6/0O-4jeo):**+ejep*`+jeo
hnstnstnst-nkkpnkkp-1.,,4),4)-1,1613O-5iuomh):**+ejep*`+iuomh
hnstnstnst-nkkpnkkp.0.,,4),1),--061.O-5lkopcnaomh)4*/):±
**+ejep*`+lkopcnaomh)4*/
hnstnstnst-nkkpnkkp-1.,,4),4)--,.61/O-5oh]l`):**+ejep*`+oh]l`
hnstnstnst-nkkpnkkp.-.,,4),2)--,56..O.,`d_l/)nah]u):**+ejep*`+`d_l/)nah]u
hnstnstnst-nkkpnkkp-0.,,4),1),--061.O.,a^kt):**+ejep*`+a^kt
hnstnstnst-nkkpnkkp-1.,,4),3),5,/6,1O.,atei0):**+ejep*`+atei0
hnstnstnst-nkkpnkkp-3.,,4),1).3-16/1O.,eblhqc`):**+ejep*`+eblhqc`
hnstnstnst-nkkpnkkp.-.,,4),3)/,,06,5O.,eo_oep]ncap):**+ejep*`+eo_oep]ncap
hnstnstnst-nkkpnkkp-0.,,4),2).,-16,.O.,gri):**+ejep*`+gri
hnstnstnst-nkkpnkkp.-.,,4),4)---,602O.,he^joo)h`]l):**+ejep*`+he^joo)h`]l
hnstnstnst-nkkpnkkp.-.,,4),2).,-16,.O.,he^renp)^ej):**+ejep*`+he^renp)^ej
hnstnstnst-nkkpnkkp.,.,,4),1)-3--6/0O.,jbo)_kiikj):**+ejep*`+jbo)_kiikj
hnstnstnst-nkkpnkkp.3.,,4),1)-3--6/0O.,jbo)ganjah)oanran):±
**+ejep*`+jbo)ganjah)oanran
hnstnstnst-nkkpnkkp./.,,4),1)-3--6/0O.,klaj^o`)ejap`):±
**+ejep*`+klaj^o`)ejap`
hnstnstnst-nkkpnkkp-2.,,4),2)./,56-.O.,mq]cc]):**+ejep*`+mq]cc]
hnstnstnst-nkkpnkkp-1.,,4),0).5-06,-O.,nouj_):**+ejep*`+nouj_
hnstnstnst-nkkpnkkp-1.,,4),0)/,-2614O.,o]i^]):**+ejep*`+o]i^]
hnstnstnst-nkkpnkkp-3.,,4),1)-3-46.5O.,ouoop]p):**+ejep*`+ouoop]p
hnstnstnst-nkkpnkkp-5.,,4),1)-3--6/0O.,pbpl`)dl]):**+ejep*`+pbpl`)dl]
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
349
hnstnstnst-nkkpnkkp-3.,,4),4)-0,56/2O.,sej^ej`):**+ejep*`+sej^ej`
hnstnstnst-nkkpnkkp-2.,,4),2)--,560,O.,tejap`):**+ejep*`+tejap`
hnstnstnst-nkkpnkkp-4.,,4),4)-0,06,4O.-mqkp]nl_):**+ejep*`+mqkp]nl_
hnstnstnst-nkkpnkkp-0.,,4),1)-3--6/0O./jpl):**+ejep*`+jpl
hnstnstnst-nkkpnkkp-1.,,4),0).5-061.O.1i`]`i):**+ejep*`+i`]`i
hnstnstnst-nkkpnkkp-3.,,4),3),5,/6,1O/,j]ceko.):**+ejep*`+j]ceko.
hnstnstnst-nkkpnkkp-1.,,4),2).1-06.4O/,omqe`):**+ejep*`+omqe`
hnstnstnst-nkkpnkkp...,,4),1)-3--6/0O0,`d_l/)oanran):±
**+ejep*`+`d_l/)oanran
hnstnstnst-nkkpnkkp.2.,,4),1)-3-261-O0,`n^h)_heajpo)j]p):±
**+ejep*`+`n^h)_heajpo)j]p
hnstnstnst-nkkpnkkp-0.,,4),3)/,,06,.O3,`n^`):**+ejep*`+`n^`
hnstnstnst-nkkpnkkp-5.,,4),3)/,,06,.O31da]np^a]p):**+ejep*`+da]np^a]p
hnstnstnst-nkkpnkkp-0.,,4),0).5-06,,O45]p`):**+ejep*`+]p`
hnstnstnst-nkkpnkkp-0.,,4),0).5-06,,O45_nkj):**+ejep*`+_nkj
hnstnstnst-nkkpnkkp-3.,,4),1),--061-O5-]l]_da.):**+ejep*`+]l]_da.
hnstnstnst-nkkpnkkp-4.,,4),0).5-061.O55n_*hk_]h):**+ejep*`+n_*hk_]h
hnstnstnst-nkkpnkkp-5.,,4),0).5-061.O55nijkhkcej):**+ejep*`+nijkhkcej
 
6. Networking: Among the most important of the nonessential services is network-
ing. If networking fails, many other services will fail as well. So if you see that many 
services that depend on networking fail, check your network configuration. The 
network is started from the script +ap_+ejep*`+japskngejc. This script reads in +ap_+
japskng+ejpanb]_ao which network configuration it should start (see  Listing 14-3). 
If something is wrong with your network, the most likely problem is an error in 
this script. Test network connectivity after you think you have fixed a network 
problem; ping is still the best utility to perform such tests.
 Listing 14-3. The /etc/init.d/networking Script Learns from /etc/network/interfaces 
Which Configuration to Initialize
nkkp<iah6+ap_+japskng_]pejpanb]_ao
Pdeobeha`ao_ne^aopdajapskngejpanb]_ao]r]eh]^hakjukqnouopai
]j`dkspk]_per]papdai*Bkniknaejbkni]pekj(oaaejpanb]_ao$1%*
Pdahkkl^]_gjapskngejpanb]_a
]qpkhk
eb]_ahkejaphkkl^]_g
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
350
Pdalnei]nujapskngejpanb]_a
]qpkapd,
eb]_aapd,ejapop]pe_
]``naoo-5.*-24*-*55
japi]og.11*.11*.11*,
japskng-5.*-24*-*,
^nk]`_]op-5.*-24*-*.11
c]pas]u-5.*-24*-*.10
`jo)&klpekjo]naeilhaiajpa`^updanaokhr_kjbl]_g]ca(eb±
ejop]hha`
`jo)j]iaoanrano-5/*35*./3*/5
`jo)oa]n_do]j`anr]jrqcp*jh
]qpk^n,
eb]_a^n,ejapop]pe_
]``naoo-5.*-24*-*55
japskng-5.*-24*-*,
japi]og.11*.11*.11*,
^nk]`_]op-5.*-24*-*.11
c]pas]u-5.*-24*-*.10
^ne`ca[lknpoapd,
^ne`ca[b`,
^ne`ca[dahhk.
^ne`ca[i]t]ca-.
^ne`ca[opklkbb
]qpkapd-
eb]_aapd-ejapop]pe_
]``naoo-,*,*,*-,
japi]og.11*.11*.11*,
japskng-,*,*,*,
^nk]`_]op-,*,*,*.11
 
7. Nonessential services: If you have made it this far, basically, your server is opera-
tional. You still might have a service fail, though. If one of your services fails, the 
most likely problem is a configuration error in the service script. Check the docu-
mentation about your service and try to repair the script. Once you have arrived at 
this stage, at least you know for sure that the problem exists in a particular service, 
so you can start troubleshooting at the right location.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
351
Troubleshooting Tools
There are some very useful tools that you must have available before you start a trouble-
shooting session: 
 s  ejep9+^ej+^]od: This Grub option enables you to load a shell immediately after the 
kernel has loaded successfully. 
 s  Rescue a Broken System option: This option on the Ubuntu Server installation 
CD takes you to an environment in which you can apply your troubleshooting 
techniques. 
 s  A Linux live CD: One of my personal favorites, and thus covered in this section, is 
Knoppix (dppl6++sss*gjkllet*_ki), a live CD that contains lots of useful utilities 
that help you to troubleshoot a failing server. If you choose a different live CD, find 
one that doesn’t have restrictions and takes you to an unlimited root shell as fast 
as possible.
Working with init=/bin/bash
The tool that is easiest to use is the option ejep9+^ej+^]od that you can pass to Grub when 
booting. It takes you to the end of the third stage of the boot procedure, right after the 
kernel and initrd have been loaded. This option is useful in cases where you have found 
that the kernel can load successfully, but there is an essential problem later in the boot 
procedure. Here is how you can activate it:
 
1. Reboot your server. During the three seconds that Ubuntu Server by default shows 
the Grub prompt, press Escape to access the options available in the Grub menu, 
an example of which is shown in  Figure 14-4.
 
2. Select the line that has the kernel image you want to start (typically, this is the first 
line) and press e to edit the commands that are in this boot loader menu option. 
This shows you the lines in the +^kkp+cnq^+iajq*hop file that are defined for this 
section (see  Figure 14-5).
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
352
 Figure 14-4. From the Grub menu, you can pass options to the boot loader.
 Figure 14-5. By selecting the section you want to start, you see the different lines that 
comprise that section.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
353
 
3. Select the line that starts with ganjah and press e to edit this line. You’ll now see 
a new window in which you can edit this line. Go to the end of its text and add 
the option init9+^ej+^]od. Next, press Enter, followed by b to boot the kernel with 
this option. This takes you to a bash shell prompt from which you can start your 
troubleshooting session (see  Figure 14-6).
 
4. You are now in a bash shell, without anything being mounted or started for you. 
This offers you an excellent starting point for troubleshooting. Mount your file sys-
tems and execute all services that you want to test by hand. 
 Figure 14-6. Using the option init=/bin/bash is the quickest way to access 
a troubleshooting shell.
Rescue a Broken System
The Ubuntu Server installation CD includes an option named Rescue a Broken System. 
This option is useful if you find that you can no longer boot your normal kernel image. 
Its main advantage is that it has its own kernel. Therefore, if for whatever reason ejep9+
^ej+^]od doesn’t work for you, use this option. The following procedure describes how it 
works:
 
1. Put the Ubuntu Server installation CD in your server’s optical drive and reboot 
your server. Make sure it boots from the optical drive. 
 
2. When you see the installation interface shown in  Figure 14-7, select Rescue 
a Broken System and press Enter.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
354
 Figure 14-7. On the Ubuntu Server installation CD, you’ll find an option to rescue 
a broken system.
 
3. You now see a few screens asking for your language and related settings. Enter the 
required information to make sure that your server loads the correct code table 
and keyboard settings.
 
4. After loading the appropriate keyboard settings, if your server has multiple net-
work cards, you have to specify which network card you want to use. Your server 
then tries to get an IP address from the DHCP server on your network. Next, enter 
a temporary hostname. It doesn’t really matter what you choose here, so the 
default hostname Ubuntu is fine (see  Figure 14-8).
 
5. After asking you for time zone information, the rescue system tries to detect your 
hard disk layout. If it succeeds, it gives you a list of partitions (see  Figure 14-9) and 
you have to tell it which partition you want to use as the root file system. It doesn’t 
matter if you don’t know which one to use; if you make an error here, you can just 
try another partition.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
355
 Figure 14-8. Using the option Rescue, a Broken System gives you a temporary 
hostname and network configuration.
 Figure 14-9. To initialize the root file system, you have to tell the rescue system which 
partition it should use to mount it.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
356
 
6. At this point, you get an overview of the different rescue operations that are avail-
able (see  Figure 14-10). You can choose from the following options:
 s  Execute a shell in +`ar+ukqnnkkp`are_a: Use this option to launch a shell in 
which your root file system is mounted already. 
 s  Execute a shell in the installer environment: Use this option to launch a shell 
without anything mounted yet. This allows you to perform all mounts 
manually.
 s  Reinstall GRUB boot loader: If you know that your Grub boot loader is faulty, 
use this option to reinstall it. 
 s  Choose a different root file system: If you want to try a different root file system 
and mount that automatically, use this option.
 s  Reboot the system: Select this option to reboot your server.
 Figure 14-10. In rescue mode you have five different options.
 
7. After you select the rescue option that you want to use, you are dropped in a shell 
in which you can repair your system. Once you are done with that, press Exit to 
return to the Rescue Operations menu (see  Figure 14-10) and choose to reboot 
your server.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
357
NNote When I wrote this, there was a bug that takes you back to the main installation menu, in which the 
next step allows you to partition your disks. When you see this menu, you can select the option Finish the 
Installation or just hard reset your server. Both options restart your server.
Working with a Knoppix Rescue CD
If you choose to work from a generic rescue disk, Knoppix is a good choice that offers you 
complete flexibility in repairing your server. You can download Knoppix from dppl6++
sss*gjkllet*_ki. In this section you’ll read how to boot from Knoppix and how to enter 
a _dnkkp environment in which you can troubleshoot your Linux server. 
Troubleshooting goes much better from a _dnkkp environment because you don’t 
work with your Ubuntu Server file system from a mounted directory; instead, you actu-
ally change the root of the rescue disk to this directory. The advantage of this is that all 
utilities will work with their native paths. For instance, if a command like cnq^)ejop]hh 
expects its iajq*hop file to be in +^kkp+cnq^+iajq*hop, the utility is not going to work if, due 
to the fact that you have mounted your server disks somewhere else, the path to this file 
has become +ijp+^kkp+cnq^+iajq*hop. By using _dnkkp, you can change root to the +ijp 
directory, with the advantage that your commands will find all configuration files at the 
right location. 
The following procedure describes how to activate such a _dnkkp environment from 
the Knoppix live CD:
 
1. Boot your server from the Knoppix CD. You’ll see the Knoppix welcome screen 
(see  Figure 14-11). Press Enter to start loading Knoppix.
 
2. During the load procedure, Knoppix prompts you to choose the language that you 
want to use. (In this procedure, I assume that you have started in English.) You 
next see the Knoppix desktop from which you start your work.
 
3. Click the terminal screen icon in the icon bar. This opens the Shell Konsole, with 
a prompt at which you have only user permissions. Enter oq`koq to get nkkp 
permissions. 
 
4. Enter the ikqjp command. The output of this command shows that you don’t 
yet have any file system mounted on your server and that you are working com-
pletely from RAM file systems that have been initialized from the Knoppix CD 
(see  Figure 14-12).
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
358
 Figure 14-11. From the Knoppix desktop, you can start repairing your server.
 Figure 14-12. Knoppix doesn’t load your server’s file systems automatically.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
359
 
5. Identify which partition is the root partition. You may not know exactly how your 
server is organized, so a good command to start with is b`eog)h. This shows you 
a list of all partitions that exist on your server. There are two possibilities here. You 
may see disk devices only, or you may also see dm devices (which refer to LVM 
logical volumes). If the latter is true, you are using LVM and need to take some 
extra steps; the section “Problems with LVM Logical Volumes,” later in this chap-
ter, explains how to initialize logical volumes manually. The present procedure 
assumes that you are working with local disk devices only, in which case b`eog)h 
may give you a result similar to the output shown in  Listing 14-4.
 Listing 14-4. fdisk -l Enables You to Check the Partition Layout of Your Server
nkkp<Gjkllet6zb`eog)h
@eog+`ar+o`]64145I>(41455/015.^upao
.11da]`o(2/oa_pkno+pn]_g(-,00_uhej`ano
Qjepo9_uhej`anokb-2,21&1-.94..1.4,^upao
@are_a>kkpOp]npAj`>hk_goE`Ouopai
+`ar+o`]-&-55/3532.0-4/Hejqt
+`ar+o`].550-,000,5213'1Atpaj`a`
+`ar+o`]1550-,000,52.24.Hejqtos]l+Okh]neo
 
 In the example in  Listing 14-4, there isn’t much doubt about which is the root par-
tition. The +`ar+o`]- partition is the only one that has Id 83, so it is the only one 
that contains a Linux file system. If you have more than one Linux partition, you 
just have to try to mount all of them one by one to find out which contains the root 
file system.
 
6. Mount the partition that you think is the root partition. Use the +ijp directory in 
the Knoppix file system as the temporary mount point:
ikqjp+`ar+o`]-+ijp
 
7. Before you go into the _dnkkp environment, it is a good idea to make sure your 
+lnk_ and +`ar directories are working. These directories are generated dynami-
cally and will be needed by many of the tools you use. To make sure these 
tools still work, you should mount both directories, by using the following two 
commands:
ikqjp)k^ej`+`ar+ijp+`ar
ikqjp)plnk_lnk_+ijp+lnk_
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
360
 
8. Go to the +ijp directory using _`+ijp. At this point, you still see the prompt 
nkkp<Gjkllet6+ijp. Enter _dnkkp* to change the current directory to be pre-
sented as the root directory. You are in the _dnkkp environment now, as shown in 
 Listing 14-5, and can start troubleshooting.
 Listing 14-5. Use chroot for Troubleshooting
nkkp<Gjkllet6+ijp_dnkkp*
nkkp<Gjkllet6+
At this point you are ready to use your troubleshooting environment. In the next sec-
tion you will read about some scenarios in which a rescue environment like the Knoppix 
Live CD is useful.
NNote There is no fundamental difference between using the Knoppix Live CD and using the Ubuntu Server 
Installation CD for your rescue operations. I prefer Knoppix, though, because the Knoppix CD offers many 
useful utilities. In the next section, use whichever solution you prefer.
Common Problems and How to Fix Them
Although Ubuntu Server is a fairly stable server platform, you may encounter some 
problems. This section gives you some hints for troubleshooting the following common 
problems:
 s  'RUB ERRORS
 s  .O MASTER BOOT RECORD
 s  0ARTITION PROBLEMS
 s  ,6- LOGICAL VOLUME PROBLEMS
 s  +ERNEL PROBLEMS
 s  &ILE SYSTEM PROBLEMS
 s  ,OST ADMINISTRATOR PASSWORD
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
361
Grub Errors
The very first thing that happens on your computer is Grub initialization. In some situ-
ations you may find that Grub simply tells you that it cannot load. You may encounter 
different results from Grub errors:
 s  'RUB IS COMPLETELY WIPED
 s  'RUB GIVES A 'RUB ERROR MESSAGE
 s  'RUB GIVES A  MISSING FILE ERROR
The following sections explain how you can reinstall Grub if it is completely wiped, 
and how you can manually load Grub if you see a Grub error or a missing file error 
message.
Reinstalling Grub
If Grub is completely wiped, you will see nothing but a blinking cursor when your server 
boots; no Grub message is displayed. If this happens, it is likely that you have lost the 
complete MBR of your server, so there is no way that you can boot it. Take a rescue 
CD and boot your server from there. Then, activate a _dnkkp environment and enter 
cnq^)ejop]ll, followed by the name of the device on which you want to install Grub (for 
instance, cnq^)ejop]hh+`ar+o`], as shown in  Listing 14-6). This will read +^kkp+cnq^+iajq*
hop (make sure that you have mounted it if boot is on a separate partition!) and reinstall 
Grub for you.
 Listing 14-6.  grub- install Offers an Easy Solution to Reinstall Grub
nkkp<Gjkllet6+cnq^)ejop]hh+`ar+o`]
Ukqodkqh`j#p_]hh+o^ej+cnq^)ejop]hh*Lha]oa_]hh+qon+o^ej+cnq^)ejop]hhejopa]`
Oa]n_dejcbknCNQ>ejop]hh]pekj`ena_pknu***bkqj`6+^kkp+cnq^
Ejop]hh]pekjbejeoda`*Jkannknnalknpa`*
Pdeoeopda_kjpajpokbpda`are_ai]l+^kkp+cnq^+`are_a*i]l*
?da_gebpdeoeo_knna_pknjkp*Eb]jukbpdahejaoeoej_knna_p(
betep]j`na)nqjpdao_nelp\cnq^)ejop]hh#*
$d`,%+`ar+o`]
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
362
Loading Grub Manually
cnq^)ejop]hh offers a good solution if the Grub code in the MBR doesn’t work anymore. 
It may also fix some of the cases in which Grub gives you an error message and refuses to 
load any further. In some situations, you may encounter a problem in the Grub configu-
ration file. If that happens, troubleshooting from the Grub prompt is useful, because you 
can manually load all lines that normally are loaded automatically from iajq*hop. The 
advantage? You will see exactly where the problem occurs and thus be able to fix it easily. 
The following procedure shows how to load the Grub configuration from the Grub 
prompt:
 
1. Restart your server. When it shows you that Grub is loading, press Escape to dis-
play the Grub menu, listing all available boot options from +^kkp+cnq^+iajq*hop.
 
2. From the menu, press c to get to the Grub  command- line interface, shown in 
 Figure 14-13.
 Figure 14-13. The Grub  command- line interface enables you to manually load the 
complete Grub configuration.
 
3. At this point, it is a good idea to type help at the command prompt, just to get an 
idea of the commands that are available from within the Grub command line (see 
 Figure 14-14 for an example).
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
363
 Figure 14-14. The Grub  command- line interface offers its own commands to 
troubleshoot Grub.
 
4. To load Grub manually, you now have to execute all lines from the iajq*hop file. 
Fortunately, you don’t have to remember them, but instead can display the iajq*
hop file by using _]p+^kkp+cnq^+iajq*hop. Normally, at the end of the file you can 
read the boot information that your server uses (see  Figure 14-15 for an example).
 Figure 14-15. Read the menu.lst file for an example of the options your server 
normally uses when booting.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
364
 
5. Enter the nkkp, ganjah, and ejepn` lines from your default section in iajq*hop. Then, 
type boot to start booting your server. Observe your server at the same time to 
make sure that no error messages are displayed. Because your server didn’t start 
automatically from this configuration, there is probably an error in the configura-
tion it uses. If there is, read the error code and fix the problem. This may require 
that you mount your server’s file system from a rescue CD first to see the exact file-
names and device names you are using.
 
6. Found the error? Then your server will boot completely. If you fixed the wrong 
part, it will stop while loading the kernel. In the latter case, try again until you have 
found and fixed the error.
NTip Ubuntu Server uses the UUID of your root partition to boot. If that doesn’t work, replace the UUID with 
the normal device name (for example, +`ar+o`]-). It is a lot easier to type and will show you immediately 
whether or not the error is in the UUID part.
No Master Boot Record
If you don’t have a backup of the MBR, restoring it requires that you first fix your parti-
tion table and then restore Grub. These procedures are covered elsewhere in this chapter, 
so I won’t repeat them here. The next section explains how to fix your partition table. 
After restoring the partition table, you’ll be able to access your disk partitions and logical 
volumes again, enabling you to restore Grub. You learned how to do that in the previous 
section. 
Of course, you can avoid going through the complex process of restoring your MBR 
by creating a backup MBR before you encounter trouble. This is a relatively simple pro-
cedure. As nkkp, from the command line enter the following command (replace +`ar+o`] 
with the actual name of your server’s boot device):
``eb9+`ar+o`]kb9+^kkp+i^n[^]_gql^o91-._kqjp9-
This command makes a copy of the first 512 bytes on your hard drive (the MBR) and 
copies that to a file named i^n[^]_gql in +^kkp. Repeat this command after every change 
you make to the partition table or Grub code. If some day you run into troubles with your 
MBR, you just have to boot your server from the rescue CD and restore the MBR using the 
following command:
``eb9+^kkp+i^n[^]_gqlkb9+`ar+o`]^o91-._kqjp9-
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
365
Partition Problems
Generally speaking, you may encounter two different kinds of partition problems. You 
may have lost the complete partition table, or you may have a problem with the file sys-
tem on a partition. If the latter is the case, read the section “File System Problems” later 
in this chapter. If you have lost all partitions, you need a rescue CD and cl]np to find the 
exact information about the beginning and end of the partitions on your server’s hard 
disk. Once you’ve found that, use b`eog to  re- create the partitions, as follows:
 
1. Start your server from the rescue CD and make sure that you open a console in 
which you have nkkp permissions.
 
2. Type gpart /dev/sda to scan your hard drive for all partitions. This may take quite 
some time (count on anything from 5 seconds to an hour). Once the scan is fin-
ished, you will see your partition information, as in the example in  Listing 14-7.
 Listing 14-7. Use gpart to Help Find Lost Partitions
nkkp<Gjkllet6zcl]np+`ar+o`]
>acejo_]j***
Lkooe^hal]npepekj$Hejqtatp.%(oeva$3345i^%(kbboap$,i^%
Lkooe^haatpaj`a`l]npepekj]pkbboap$3345i^%
Lkooe^hal]npepekj$Hejqtos]l%(oeva$0,,i^%(kbboap$3345i^%
Aj`o_]j*
?da_gejcl]npepekjo***
L]npepekj$Hejqtatp.behaouopai%6lnei]nu
L]npepekj$Hejqtos]lknOkh]neo+t42%6lnei]nu
Kg*
Cqaooa`lnei]nul]npepekjp]^ha6
Lnei]nul]npepekj$-%
pula6-0-$,t4/%$Hejqtatp.behaouopai%
oeva63345i^o$-151.04,%o$2/)-151.10.%
_do6$,+-+-%)$55.+.10+2-%`$,+-+-%)$55.+.10+2-%n
Lnei]nul]npepekj$.%
pula6-0,$,t4.%$Hejqtos]lknOkh]neo+t42%
oeva60,,i^o$4-5.04%o$-151.2,4)-233-411%
_do6$55/+-+-%)$-,./+.10+2/%`$55/+-+-%)$-,0/+.10+15%n
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
366
Lnei]nul]npepekj$/%
pula6,,,$,t,,%$qjqoa`%
oeva6,i^o$,%o$,),%
_do6$,+,+,%)$,+,+,%`$,+,+,%)$,+,+,%n
Lnei]nul]npepekj$0%
pula6,,,$,t,,%$qjqoa`%
oeva6,i^o$,%o$,),%
_do6$,+,+,%)$,+,+,%`$,+,+,%)$,+,+,%n
 
 Evaluate the information that cl]np gives you carefully; after all, cl]np stands for 
Guess Partition. It guesses—nothing more, nothing less. For instance, on my 
example server I have swap in a logical partition +`ar+o`]1. As you can see, cl]np 
did find the swap partition with its correct size, beginning, and end on disk, but 
it couldn’t determine that it is a logical partition. Based on this information, 
you would try to  re- create the swap partition on +`ar+o`].. Your server would 
boot with that, but would give errors as well. That doesn’t really matter, though, 
because once your server has booted, you can check system files like +ap_+bop]^ to 
find on what partition your swap originally was, and then repair the partitions. 
 
3. Now that you have found the original partition boundaries, write them down and 
start b`eog using b`eog+`ar+o`]. Ignore the message about your disk’s size and 
press n to start the interface to create a new partition. Next, press p to create the 
first primary partition. When it asks what partition number you want to assign, 
press 1. 
 
4. Next comes the important part: you have to specify where the partition originally 
started and ended. To find this information, you need the _do (cylinder, heads, 
sector) line in the cl]np output for this partition. Consider the following line:
_do6$,+-+-%)$55.+.10+2-%`$,+-+-%)$55.+.10+2-%n
 
 In this line, the first number between brackets indicates the original starting cyl-
inder, which in this example is cylinder 0. The second series of numbers between 
brackets tells you where the partition originally ended, in this case on cylinder 992. 
There is one catch, though: in b`eog the first cylinder is cylinder 1. That means that 
all other cylinders as displayed with cl]np need to be incremented by 1. So, you 
have to create a partition now that starts at cylinder 1 and ends on cylinder 993. 
Repeat steps 3 and 4 to  re- create your other partitions as well and then close b`eog 
by pressing w. You’ll probably see a message stating that the new partition table 
can be used only after a reboot.  Listing 14-8 shows you what has happened so far. 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
367
 Listing 14-8.  Re- creating a Partition Using fdisk
nkkp<Gjkllet6zb`eog+`ar+o`]
Pdajqi^ankb_uhej`anobknpdeo`eogeooappk-,00*
Pdanaeojkpdejcsnkjcsepdpd]p(^qppdeoeoh]ncanpd]j-,.0(
]j`_kqh`ej_anp]ejoapqlo_]qoalnk^haiosepd6
-%okbps]napd]pnqjo]p^kkppeia$a*c*(kh`ranoekjokbHEHK%
.%^kkpejc]j`l]npepekjejcokbps]nabnkikpdanKOo
$a*c*(@KOB@EOG(KO+.B@EOG%
?kii]j`$ibkndahl%6j
?kii]j`]_pekj
aatpaj`a`
llnei]nul]npepekj$-)0%
l
L]npepekjjqi^an$-)0%6-
Benop_uhej`an$-)-,00(`ab]qhp-%6-
H]op_uhej`ankn'oevakn'oevaIkn'oevaG$-)-,00(`ab]qhp-,00%655/
?kii]j`$ibkndahl%6j
?kii]j`]_pekj
aatpaj`a`
llnei]nul]npepekj$-)0%
l
L]npepekjjqi^an$-)0%6.
Benop_uhej`an$550)-,00(`ab]qhp550%6
Qoejc`ab]qhpr]hqa550
H]op_uhej`ankn'oevakn'oevaIkn'oevaG$550)-,00(`ab]qhp-,00%6
Qoejc`ab]qhpr]hqa-,00
?kii]j`$ibkndahl%6s
Pdal]npepekjp]^had]o^aaj]hpana`
?]hhejcek_ph$%pkna)na]`l]npepekjp]^ha*
S=NJEJC6Na)na]`ejcpdal]npepekjp]^hab]eha`sepdannkn-26@are_akn± naokqn_a^qou*
Pdaganjahopehhqoaopdakh`p]^ha*
Pdajasp]^hasehh^aqoa`]ppdajatpna^kkp*
Ouj_ejc`eogo*
 
5. Reboot your server to activate the changes.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
368
You now have recovered your partitions. It may work, it may not. If it doesn’t work, 
I recommend starting by  re- creating the first partition first. Try to mount it from the res-
cue CD, and if that works, continue from there,  re- creating all other partitions you need. 
Once you have successfully reconstructed the root partition, read +ap_+bop]^, because it 
gives you invaluable information about the original device names that you’ve used. 
NTip LVM, extended, and swap partitions use another partition type. In b`eog, press l to get an overview 
of available partition types, and press t to change the type of a partition. Don’t forget to reboot after changing 
your partition table. 
LVM Logical Volume Problems
If your server is configured with LVM, troubleshooting is slightly more difficult. You may 
encounter the following problems with LVM volumes:
 s  /N BOOTUP THE SERVER DOESNT FIND ,6- LOGICAL VOLUMES
 s  3CANNING A DEVICE FOR ,6- PROBLEMS CAUSES PROBLEMS ON THAT DEVICE
 s  ! DEVICE IS NOT ACTIVATED AUTOMATICALLY
Fixing LVM Boot Problems
When your server boots, it scans for LVM volumes. It does this by executing the lro_]j 
command from the startup scripts. If something is wrong, the lro_]j process will fail and, 
as a result, you’ll have to initialize LVM yourself. This is not too hard if you understand 
how LVM works. The bottom layer in LVM consists of physical devices. These are storage 
devices that have an LVM signature added to them (they can also be partitions). Not every 
storage device is a physical device. You need to initialize these storage devices by using 
the lr_na]pa command before you can use them. 
The second layer in LVM consists of volume groups. A volume group is a collection of 
storage devices (or only one storage device) from which logical volumes can be created. 
During your configuration of LVM, you created one or more volume groups, using the 
rc_na]pa command. Your server uses rco_]j to activate the volume groups when booting.
Logical volumes are the storage devices that you will create a file system on and 
mount on your server. You use hr_na]pa to create them, and hro_]j to scan them. 
 Figure 14-16 gives an overview of the LVM setup.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
369
 Figure 14-16. Overview of the LVM structure
The following procedure explains how to troubleshoot LVM logical volumes:
 
1. Before you start to troubleshoot, it is good to get an overview of your logical vol-
umes. The best way to do that is by using hr`eolh]u. If it encounters a problem, it 
will tell you “No volume groups found,” in which case you need to check the LVM 
chain to see if everything is set up right. 
 
2. If your LVM structure has never worked, start by checking the storage devices 
themselves. If you’ve added partitions to the LVM setup, the partition should be 
marked as partition type 8e. Use b`eog)h+`ar+o`] to confirm this. If it isn’t set to 
type 8e, use b`eog+`ar+o`] to open b`eog on your server’s hard drive, press t, and 
then enter the number of the partition whose type you want to change. Next enter 
8e, save the settings, and reboot. It might work now.
 
3. If your LVM structure still doesn’t work, use lr`eolh]u to check whether the stor-
age devices are marked as LVM devices. If they are not, but you are sure that you 
have set them up as LVM devices earlier, use lro_]j+`ar+o`]. If this also doesn’t 
work, use lr_na]pa+`ar+o`] to set up your storage device as an LVM device. 
 Listing 14-9 shows the result that lr`eolh]u and lro_]j would normally give you.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
370
 Listing 14-9. Use pvscan and pvdisplay to Initialize Existing Physical Volumes
nkkp<iah6zlro_]j+`ar+i`,
LR+`ar+i`,RCouopaihri.W5-.*25C>+-,*25C>bnaaY
Pkp]h6-W5-.*25C>Y+ejqoa6-W5-.*25C>Y+ejjkRC6,W,Y
nkkp<iah6zlr`eolh]u
)))Lduoe_]hrkhqia)))
LRJ]ia+`ar+i`,
RCJ]iaouopai
LROeva5-.*25C>+jkpqo]^ha-*25I>
=hhk_]p]^hauao
LAOeva$G>upa%0,52
Pkp]hLA.//204
BnaaLA.3/2
=hhk_]pa`LA./,5-.
LRQQE@V,mJeP)VSD/)Umbd)4fie)f`S3)lJN0)EU2FS-
 
4. Repeat the preceding steps, but this time for the volume groups on your server. 
So, first use rc`eolh]u to see your current volume groups. If that doesn’t give you 
a result, use rco_]j to tell your server to scan for volume groups on your storage 
devices.  Listing 14-10 shows the result of these commands.
 Listing 14-10. vgscan and vgdisplay Can Be Very Helpful When Fixing Volume Group 
Problems
nkkp<iah6zrco_]j
Na]`ejc]hhlduoe_]hrkhqiao*Pdeoi]up]ga]sdeha***
Bkqj`rkhqiacnkqlouopaiqoejciap]`]p]pulahri.
nkkp<iah6zrc`eolh]u
)))Rkhqiacnkql)))
RCJ]iaouopai
OuopaiE@
Bkni]phri.
Iap]`]p]=na]o-
Iap]`]p]Oamqaj_aJk2
RC=__aoona]`+snepa
RCOp]pqonaoev]^ha
I=THR,
?qnHR1
KlajHR1
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
371
I]tLR,
?qnLR-
=_pLR-
RCOeva5-.*25C>
LAOeva0*,,I>
Pkp]hLA.//204
=hhk_LA+Oeva./,5-.+5,.*,,C>
BnaaLA+Oeva.3/2+-,*25C>
RCQQE@5RaDFN)jg?T).Kbc)/>Qm)h1.D)SmBS)/>.Os3
 
5. Now that both your physical volumes and your volume groups are available, you 
may still have to scan your logical volumes (use hr`eolh]u first to see if they were 
activated automatically). The command sequence repeats itself: first use hro_]j 
to scan for available volumes and then use hr`eolh]u to see whether the volumes 
came up successfully.  Listing 14-11 shows you the result of these two commands.
 Listing 14-11. Use lvscan and lvdisplay to Initialize Your Logical Volumes
nkkp<iah6zhro_]j
=?PERA#+`ar+ouopai+nkkp#W-,,*,,C>Yejdanep
=?PERA#+`ar+ouopai+os]l#W.*,,C>Yejdanep
=?PERA#+`ar+ouopai+r]n#W-,,*,,C>Yejdanep
=?PERA#+`ar+ouopai+onr#W-,,*,,C>Yejdanep
=?PERA#+`ar+ouopai+_hkjavehh]#W2,,*,,C>Yejdanep
nkkp<iah6zhr`eolh]u
)))Hkce_]hrkhqia)))
HRJ]ia+`ar+ouopai+nkkp
RCJ]iaouopai
HRQQE@?.M?L>)rpPF)A/MJ)dkVA)`bVA)_>eV)vvK2iJ
HRSnepa=__aoona]`+snepa
HROp]pqo]r]eh]^ha
klaj-
HROeva-,,*,,C>
?qnnajpHA.12,,
Oaciajpo-
=hhk_]pekjejdanep
Na]`]da]`oa_pkno,
>hk_g`are_a.106,
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
372
)))Hkce_]hrkhqia)))
HRJ]ia+`ar+ouopai+os]l
RCJ]iaouopai
HRQQE@-JU4cs)PVcp)5Ttl)2Bj=).DA])DQir)pjmjE1
HRSnepa=__aoona]`+snepa
HROp]pqo]r]eh]^ha
klaj.
HROeva.*,,C>
?qnnajpHA1-.
Oaciajpo-
=hhk_]pekjejdanep
Na]`]da]`oa_pkno,
>hk_g`are_a.106-
)))Hkce_]hrkhqia)))
HRJ]ia+`ar+ouopai+r]n
RCJ]iaouopai
HRQQE@,uvrlJ)Q-q?)/Dn])3eKj)Ohfv)lsad)-F4BoK
HRSnepa=__aoona]`+snepa
HROp]pqo]r]eh]^ha
klaj.
HROeva-,,*,,C>
?qnnajpHA.12,,
Oaciajpo-
=hhk_]pekjejdanep
Na]`]da]`oa_pkno,
>hk_g`are_a.106.
)))Hkce_]hrkhqia)))
HRJ]ia+`ar+ouopai+onr
RCJ]iaouopai
HRQQE@vQs^TN)3P-P).u=F)/0Ne)BeBb)Snq_)mh1MpO
HRSnepa=__aoona]`+snepa
HROp]pqo]r]eh]^ha
klaj-
HROeva-,,*,,C>
?qnnajpHA.12,,
Oaciajpo-
=hhk_]pekjejdanep
Na]`]da]`oa_pkno,
>hk_g`are_a.106/
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
373
)))Hkce_]hrkhqia)))
HRJ]ia+`ar+ouopai+_hkjavehh]
RCJ]iaouopai
HRQQE@vd-fHi)g/qp)Qfs@)b>gd)C=np)DtEE)e1/0.`
HRSnepa=__aoona]`+snepa
HROp]pqo]r]eh]^ha
klaj-
HROeva2,,*,,C>
?qnnajpHA-1/2,,
Oaciajpo-
=hhk_]pekjejdanep
Na]`]da]`oa_pkno,
>hk_g`are_a.1060
 
6. Make sure that all LVM logical volumes are marked as available. You can see 
this in the HROp]pqo line of the output of hr`eolh]u. If the status is anything 
other than ]r]eh]^ha, read the upcoming subsection “A Device Is Not Activated 
Automatically.”
Excluding Devices for LVM
Imagine a situation in which you are working with virtualization. Your host server uses 
LVM, and you decide that your virtual servers should each get an LVM logical volume 
as the storage back end. In the virtual servers, you want to use LVM as well. When your 
virtual machine boots, it can’t initialize LVM volumes. It complains that the devices are 
already being used. 
The problem in the preceding scenario occurs if you don’t exclude your LVM devices 
from being scanned for LVM volumes on bootup of the host server. Therefore, the host 
server will find LVM volumes within the LVM devices and just activate them. The result is 
that the virtual server that is supposed to use these volumes finds that they are already in 
use and concludes that it can’t use them. The solution is to exclude the LVM devices from 
being scanned for LVM volumes when the host server boots. 
To exclude LVM devices, you have to modify the LVM configuration file +ap_+hri+hri*
_kjb.  Listing 14-12 provides some example lines that you can use to exclude devices. 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
374
 Listing 14-12. Some Example Lines to Exclude Devices from lvm.conf
>u`ab]qhpsa]__alparanu^hk_g`are_a6
behpan9W]+*&+Y
At_hq`apda_`nki`nera
behpan9Wnx+`ar+_`nkixY
SdajpaopejcEhegapkskngsepdfqophkkl^]_g`are_ao6
behpan9W]+hkkl+(n+*&+Y
Kni]u^a]hhhkklo]j`e`a`neraoat_alpd`_6
behpan9W]xhkklx(nx+`ar+d`_x(]x+`ar+e`ax(nx*&xY
As you can see, the behpan statement uses regular expressions both to include and 
exclude devices. All devices that you want to include start with ]x and all devices that you 
want to exclude start with nx. So, for example, if you want to make sure that while booting 
your +`ar+`n^`, device is not scanned by lro_]j, rco_]j, or hro_]j, include the following 
line somewhere in the configuration file:
behpan9Wnx+`ar+`n^`,Y
Next, restart your server to activate the new configuration. The newly designated 
devices should now be excluded.
NTip Personally, I don’t like all the comments in the +ap_+hri+hri*_kjb file, because I want to see very 
clearly which devices I’m including and which devices I’m excluding in the LVM setup. Thus, I recommend 
removing all comment lines so that you have a configuration file that is easy to read and in which it is easy to 
identify any mistakes that you’ve accidentally made.
A Device Is Not Activated Automatically
Another problem that you might encounter is that LVM volumes are all discovered fine 
but their status remains inactive. If that happens, you can use hr_d]jca to change their 
state to active. Consider the following example line:
hr_d]jca)]u+`ar+ouopai+onr
This command changes the state of the volume from inactive to active. This normally 
works, but in some particular cases, it doesn’t. I have seen a situation in which a snapshot 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
375
volume was linked to the original volume, but the snapshot volume was completely filled 
up and therefore deactivated automatically. That’s good, you would think, because it 
can’t do any harm that way, but it also deactivates the original volume. If the original vol-
ume is deactivated because of a failing snapshot, there is no way to get it up again with 
hr_d]jca. In that case, you would first have to remove the snapshot, using a command like
hrnaikra+`ar+ouopai+oj]lodkp
Once the snapshot volume has been removed properly, you can change the state of 
the original volume back to active.
NTip Always remember that a snapshot is for temporary use only. Remove it immediately if you don’t need 
it anymore.
Kernel Problems
Fortunately, serious kernel problems are relatively rare, but they do occur. Typically, 
when the kernel has a problem on a machine that has been functional for quite some 
time, the machine will just hang. If this happens, the first thing to do is to find out what 
kind of “hang” it is. There are interruptible hangs and noninterruptible hangs. To find out 
which kind of hang your server is experiencing, press the Caps Lock key. If the Caps Lock 
light switches on or off, you have an interruptible hang. If it doesn’t, you have a noninter-
ruptible hang.
Interruptible Hang
The best thing to do when you have an interruptible hang is to dump a stack trace of the 
responsible process. To do this, you must have Magic SysRq enabled. Check if this is the 
case in the file +lnk_+ouo+ganjah+ouonm. If it is not enabled, use v_]p+lnk_+_kjbec*cvx
cnalOUONM to see whether or not this feature is compiled. If it is enabled, it has the value -; 
if it’s not, it has the value ,. On Ubuntu Server, it is enabled by default. If on your server it 
is not enabled for some reason, put the following line in +ap_+ouo_ph*_kjb and reboot your 
server to make sure that ouonm is enabled by default (see Chapter 4 for more information 
on ouo_ph):
ganjah*ouonm9-
Now when the server hangs, press Alt+Print Screen+t to tell your system to dump 
a stack trace to the console. Next, use the `iaoc command to dump the stack trace on 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
376
your server’s screen. You can also reboot, and after the reboot read +r]n+hkc+iaoo]cao, 
because the stack trace is dumped there as well.  Listing 14-13 shows partial output of the 
stack trace.
 Listing 14-13. A Stack Trace Can Help Troubleshoot Interruptible Hangs
W-01-*/-015.YW8_,-]25-4:Y`k[ek_ph',t34+,t5,
W-01-*/-0152YW8_,-]2^1a:Yrbo[ek_ph',t..a+,t.^,
W-01-*/-0155YW8_,../,a`:Ynsoai[s]ga',t0`+,t--,
W-01-*/-02,/YW8_,-]2_/2:Youo[ek_ph',t12+,t3,
W-01-*/-02,3YW8_,-,4/5]:Youoajpan[l]op[aol',t2^+,t]-
W-01-*/-02-2Y99999999999999999999999
W-01-*/-02-3Y_kjokha)gep)`Ob/``^`a4,2340-
W-01-*/-02-5Yb/`20^4,,,,,,,42,,,,,,,.b/``^`a4b/``^`a,,,,,,,,,±
_,054,a,_,05^04,
W-01-*/-02./Y_,05^04,_,05^04,b/``^`a_b/`20__0_/1]/04,bbbb`.1/±
,,,,,,,,,,,,,,bb
W-01-*/-02.2Y,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,/],,,,,,,-_/1]],,,±
,,,,12,3_,.3414]
W-01-*/-02/,Y?]hhPn]_a6
W-01-*/-020,YW8_,.3414]:Yrp[s]ep]_pera',t1]+,t^,
W-01-*/-020/YW8_,-.^,_,:Y`ab]qhp[s]ga[bqj_pekj',t,+,t-,
***
W-01-*/-0-./Y*febbeao6--0,/5
W-01-*/-0-.0Y*jatp[^]h]j_a6,*--0,.,
W-01-*/-0-.2Y*_qnn):le`6,
W-01-*/-0-.3Y*_hk_g6.0351,*,4.//,
W-01-*/-0-.4Y*e`ha[_hk_g6,*,,,,,,
W-01-*/-0-0,Y*lnar[_hk_g[n]s6-01-.20*-41/55
W-01-*/-0-0-Y*_hk_g[s]nlo6,
W-01-*/-0-0.Y*_hk_g[kranbhkso65.,24
W-01-*/-0-0/Y*_hk_g[`aal[e`ha[arajpo6,
W-01-*/-0-01Y*_hk_g[i]t[`ahp]65*555034
W-01-*/-0-02Y*_lq[hk]`W,Y6,
W-01-*/-0-03Y*_lq[hk]`W-Y6,
W-01-*/-0-04Y*_lq[hk]`W.Y6,
W-01-*/-0-05Y*_lq[hk]`W/Y6,
W-01-*/-0-0,Y*_lq[hk]`W0Y6,
W-01-*/-0-0-Y
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
377
W-01-*/-0-0-Y_bo[nm
W-01-*/-0-0.Y*ata_[_hk_g6,*,,,,,,
W-01-*/-0-0/Y*IEJ[rnqjpeia6,*,,,,,-
W-01-*/-0-01Y*iej[rnqjpeia6513-*.4//4.
W-01-*/-0-02Y*i]t[rnqjpeia6,*,,,,,-
W-01-*/-0-03Y*olna]`6,*,,,,,,
W-01-*/-0-05Y*olna]`,6)/.32*5,2--4
W-01-*/-0-1,Y*jn[nqjjejc6,
W-01-*/-0-1-Y*hk]`6,
W-01-*/-0-1.Y*jn[olna]`[kran6,
W-01-*/-0-1/Y
W-01-*/-0-1/Y_bo[nm
W-01-*/-0-10Y*ata_[_hk_g6,*,,,,,,
W-01-*/-0-12Y*IEJ[rnqjpeia6,*,,,,,-
W-01-*/-0-13Y*iej[rnqjpeia6513-*.4//4.
W-01-*/-0-14Y*i]t[rnqjpeia6,*,,,,,-
W-01-*/-0-2,Y*olna]`6,*,,,,,,
W-01-*/-0-2-Y*olna]`,6)/.32*5,2--4
W-01-*/-0-2.Y*jn[nqjjejc6,
W-01-*/-0-2/Y*hk]`6,
W-01-*/-0-20Y*jn[olna]`[kran6,
W-01-*/-0-22Y
W-01-*/-0-22Ynqjj]^hap]ogo6
W-01-*/-0-23Yp]ogLE@pnaa)gauosep_daolnek
ata_)nqjpeia±
oqi)ata_oqi)ohaal
W-01-*/-0-24Y))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))
)))))))))))))))))))))))
W-01-*/-0-3.Y
The best thing to do with this stack trace is to have it reviewed by someone who spe-
cializes in this kind of troubleshooting. Doing it yourself requires extensive knowledge 
of the C programming language and goes far beyond the scope of this book. If you have 
purchased support with Canonical, send the stack trace to them for analysis. They will be 
able to find the offending process and tell you why it caused a system to hang. 
NTip In many cases, system hangs are caused by tainted (unsupported) kernel modules. It is easy to find 
out whether your kernel is tainted: _]p+lnk_+ouo+ganjah+p]ejpa` gives the value - if your kernel is 
tainted. Basically, all kernel modules that come from commercial organizations and do not fall under the GPL 
license are considered tainted modules. Try to avoid such modules as much as possible.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
378
Noninterruptible Hang
If you have an interruptible hang, consider yourself lucky. At least you can make a stack 
trace dump and send that to your support organization. If you have a hang and your 
server doesn’t reply to anything anymore (noninterruptible), that is a much worse situa-
tion, because it is hard to get debugging information. 
If your system experiences noninterruptible hangs often, you can force your kernel to 
generate an Kklo (which is an error message that it generates when it stops) and dump its 
stack trace to STDOUT. To obtain this information, you need to pass the boot option jie[
s]p_d`kc to the kernel when booting the kernel with Grub. This will poll your CPU every 
5 seconds. If the CPU responds, nothing happens. If it doesn’t respond, the NMI handler 
kernel component generates an Kklo and dumps information to STDOUT. To obtain this 
information, it is useful to connect a serial console to your server (you don’t want to write 
down all this information manually, do you?).
NTip If a noninterruptible hang has never occurred but suddenly occurs after you’ve added a new piece 
of hardware, the new hardware likely is causing the hang. Try to configure your server without this piece of 
hardware to avoid the problems.
File System Problems
Normally, you won’t encounter too many problems with your server’s file systems. How-
ever, in some cases, if things do go wrong, you may end up with a damaged file system. In 
this section you’ll learn how to still access a damaged Ext3 file system and how to repair 
a ReiserFS file system that has problems.
Accessing a Damaged Ext3 File System
If after an error you apparently can no longer access your Ext2 or Ext3 file system, you still 
might be able to access it. This section presents advanced ikqjp options that allow you to 
access data that you might have considered lost.
In order to access a file system, you need the superblock, a 1 KB block that contains 
all metadata about the file system. This data is needed to mount the file system. It nor-
mally is the second 1 KB block on an Ext3 file system.  Listing 14-14 shows part of the 
contents of the superblock as displayed with the `a^qcbo utility. 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
379
 Listing 14-14. A Superblock As Displayed with debugfs
Behaouopairkhqiaj]ia68jkja:
H]opikqjpa`kj68jkp]r]eh]^ha:
BehaouopaiQQE@6,5535-,-)52a,)01//)]3b/),].`^5^,3],/
Behaouopaii]ce_jqi^an6,tAB1/
Behaouopainareoekj6-$`uj]ie_%
Behaouopaiba]pqnao6d]o[fkqnj]hatp[]ppnbehapulajaa`o[na_kranuol]noa[oqlanh]nca[
beha
@ab]qhpikqjpklpekjo6$jkja%
Behaouopaiop]pa6_ha]j
Annkno^ad]rekn6?kjpejqa
BehaouopaiKOpula6Hejqt
Ejk`a_kqjp61.0455.
>hk_g_kqjp6-,0420.4
Naoanra`^hk_g_kqjp61.0/.-
Bnaa^hk_go6/444.,.
Bnaaejk`ao604.1.-0
Benop^hk_g6,
>hk_goeva60,52
Bn]ciajpoeva60,52
>hk_golancnkql6/.324
Bn]ciajpolancnkql6/.324
Ejk`aolancnkql6-2/1.
Ejk`a^hk_golancnkql61--
Problems with your file system arise if, due to some error, the superblock isn’t acces-
sible anymore. Fortunately, some backup copies of the superblock are written on the Ext2 
and Ext3 file systems by default. You can use these backup copies to mount a file system 
that you may have considered lost. 
The actual position on disk of the first backup of the superblock depends on the size 
of the file system. On modern, large file systems, you will always find it at block 32768. 
To access it, you can use the ikqjp option )ko^. The issue, however, is that ikqjp expects 
you to specify the position of the superblock in  1024- byte blocks, whereas the default 
block size for a modern Ext3 volume or partition is 4096 bytes. Therefore, to tell the ikqjp 
command where it can find the superblock, you have to multiply the position of the 
superblock by 4, which would result in the block value 141072 in most cases. For example, 
if your +`ar+o`]1 file system has a problem, you can try mounting it with the command 
ikqjp)ko^9-0-,3.+`ar+d`]1+okiasdana. 
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
380
Now that you have mounted the problematic file system and thus limited the scope 
of the problem to the superblock, it is time to fix the problem. You can do so by copying 
the backup superblock to the location of the old superblock, using ``eb9+`ar+d`]1kb9+
`ar+d`]1^o9-,.0ogel9-0-,3._kqjp9-oaag9-. Once finished, your file system should be 
accessible again just as it was before the problem occurred.
Repairing ReiserFS
The best and at the same time worst thing about ReiserFS is the database it uses to store 
files. The database makes ReiserFS a very fast file system that deals with lots of small files 
especially well, but when it breaks, it seriously breaks and you risk losing all your data. 
Fortunately, the Ubuntu Server version of naeoanbo_g does a decent job of repairing data-
base problems. 
At the moment the database seriously goes wrong and a normal bo_g can’t save 
you anymore, you need its power options. Before using them, you should always try 
naeoanbo_g))bet)bet]^le. This is a nondestructive option in which you don’t risk losing 
your data. If that doesn’t help, there are two advanced options. If you suspect that the 
problem is in the superblock, use naeoanbo_g))na^qeh`)sb. This option analyzes informa-
tion in the file system and tries to rebuild the superblock. In some situations, just using 
this option is not enough, and you need to use naeoanbo_g))na^qeh`)pnaa after that. This 
option completely rebuilds the database tree based on information in the file system. 
Note, however, that this may seriously go wrong; I have started this option on a damaged 
file system that had thousands of files in hundreds of directories, only to end up with one 
large directory named +hkop'bkqj`. If that happens to you, you really do need your backup 
tape, but anyway, it is worth a try.
NCaution Before using naeoanbo_g))na^qeh`)pnee, make sure that you have a decent backup of your 
file system.
Lost Administrator Password
To administer your server, you need administrative privileges. If you didn’t change any 
defaults, the first user you created while installing the server has permissions to use the 
oq`k command to perform administration tasks. (This isn’t true for any of the subsequent 
users you created.) If you delete this user account by accident, you have a problem. In 
this section you’ll learn how to fix it.
www.it-ebooks.info

CHAPTER 14 N   UBUNTU SERVER TROUBLESHOOTING
381
If you subsequently lose the password for the user account that can use the oq`k 
command, just log in as nkkp and grant this user a new password. If you can’t log in as 
nkkp, the following procedure explains how to log in as nkkp using a rescue CD and then 
 re- create a user that has administrative permissions on your server:
 
1. Boot from a rescue CD as described in the section “Working with a Knoppix Res-
cue CD” earlier in this chapter. Make sure to mount the +`ar and +lnk_ directories 
and establish a _dnkkp environment that points to your server’s root directory.
 
2. You are now nkkp on your server’s file system. Use the l]oos` command to reset 
the password for the user nkkp. You have reestablished access to the nkkp account.
 
3. Reboot your server without the Knoppix CD and verify that you can log in as nkkp, 
using the password that you’ve just set.
 
4. Re-create an administrative user account that is not nkkp. If, for example, the name 
of this user account is hej`], use qoan]``)ihej`]. To be able to use oq`k to exe-
cute commands as nkkp, you must make sure that this user account is a member of 
the group ]`i. To make user hej`] a member of the group ]`i, use qoanik`)C]`i
hej`].
 
5. Use l]oos`hej`] to give the user you’ve just created a password. You have now 
reestablished a user account that can be used to perform administration tasks on 
your server.
NTip A good precautionary measure to take before you lose the administrator password it to give the user 
nkkp a password (by default, this user doesn’t have a password). Use oq`koq to become nkkp, and then 
use the l]oos` command to set a password for nkkp. Use a complex password, but one that you will be 
sure to remember.
Summary
In this chapter you learned how to troubleshoot Ubuntu Server. You have read how to fix 
some common issues that may arise when working with Ubuntu Server. Of course, cover-
ing all possible problems in one chapter is impossible, but the knowledge that you have 
acquired from this chapter should help you to fix quite a few common problems. 
This is the last chapter in this book. I certainly hope you have enjoyed it!
www.it-ebooks.info

383
Symbols
64-bit version of Ubuntu Server, 7
A
aa-complain command, 299
accepting mail from servers on Internet, 
267–268
accessing damaged Ext3 file system, 
378–380
access lookup table, configuring Postfix to 
use, 270
ACLs, slapd.conf file, 214–215
Active Directory and Samba
Kerberos authentication, setting up, 245
making Samba member of domain, 244
overview of, 241, 244
active memory, 58
administrative user account for Kerberos 
server, creating, 337–338
administrator password, lost, dealing with, 
380–381
aliases lookup table, configuring Postfix to 
use, 273
allocating files in file systems, 111
allocation groups, 112, 125
allocsize option (XFS), 126
analyzing Ext2/Ext3 file system
debugfs utility, 122–124
dumpe2fs and tune2fs utilities, 120–122
e2fsck utility, 120
Anticipatory scheduler (I/O scheduler), 97
Apache Web Server, high-availability solu-
tion for, 194
AppArmor
components of, 290–291
creating and managing profiles, 
294–299
installing and starting, 293–294
monitoring status of, 299–302
overview of, 290
permissions, 293
updating profiles, 299
apparmor status command, 299
apt command, 31
apt-get command, 163
apt-get install drbl command, 31
apt-get purge slapd command, 205
apt-get update command, 163
aptitude search samba command, 232
assigning directory for Clonezilla, 35–36
attributes of LDAP objects, 198
authentication
See also Kerberos
for enterprise network installation, 3
of Linux users, 245–246
using LDAP for
nsswitch.conf file, 228–229
PAM, configuring, 223–228
testing client connectivity, 230
authkeys file, 176
B
backing up
cluster configuration, 187–191
files, snapshot technology for, 5
balanced trees (b-trees), 115
barrier option (XFS), 127
barriers, to avoid reordering in journal file 
systems, 114
Beginning Ubuntu Server Administration 
(van Vugt), 131
bitmaps, inode and block, 112–113
blocked process, 51
boot partition, creating, 12
boot problems of LVM logical volumes, 
368–373
Index
www.it-ebooks.info

NINDEX
384
boot process, phases in, 344–350
/boot/grub/menu.lst file, 351
C
caching, types of, 91
canonical lookup table, configuring Post-
fix to use, 270
certificate authority (CA)
creating, 284–289
need for, 283–284
OpenVPN, configuring, 305–308
cfg_file statements (Nagios), 136
changing password in LDAP environment, 
223
check command (Nagios), 148–149
check_disk plug-in (Nagios), output from, 
144–147
checking NTP synchronization status, 
326–327
check_nrpe command (Nagios), 154
chroot environment
activating from Knoppix Rescue CD, 
357
listing, 360
troubleshooting and, 357
cibadmin command, 189–191
cibadmin -Q command, 177, 179, 187
cib.xml file, 177–179
cleanup daemon, 251
client keys (OpenVPN)
copying, 312
creating, 310–311
clients
See also Kerberos client
cloning, 39–43
configuring for cloning, 36–38
NTP, configuring, 325–326
Clonezilla imaging server
assigning directory for, 35
cloning clients, 39–43
configuring, 36
configuring for cloning, 36–38
Diskless Remote Boot in Linux
configuring software, 32–33
DHCP server, setting up, 33–35
installing software, 31–32
setting up, 30
setting up, 29
cluster configuration, backing up, 187–191
cluster resources, configuring, 180–187
commands
aa-complain, 299
apparmor status, 299
apt, 31
apt-get, 163
apt-get install drbl, 31
apt-get update, 163
aptitude search samba, 232
check, 148–149
check-nrpe, 154
cibadmin, 189–191
cibadmin -Q, 177, 179, 187
crm_mon -i 1, 177, 183
debugfs utility
help, 124
ls, 122
lsdel, 123
dpkg-reconfigure postfix, 257–262
fdisk, 366–367
fdisk -l, 359
free -m, 57
gpart, 365–366
help, 326
ietadm, 171
ifconfig, 73–74
ipcs -m, 95
iscsiadm, 173
iscsiadm -m session, 174
kadmin.local, 337, 338
kinit, 338
klist, 338
LDAP
apt-get purge slapd, 205
dpkg-reconfigure slapd, 203–206
for management, 220–221
getent, 230
ldapadd, 201
ldapdelete, 201, 222
ldapmodify, 201, 221
ldappasswd, 223
ldapsearch, 201, 217–220
ldd, 223
www.it-ebooks.info

NINDEX
385
ls -i, 110
lsof, 71
lsscsi, 174
lvchange, 374
lvdisplay, 369–373
lvscan, 371–373
mkdir /share, 232
mount, 235
Nagios tool, 135, 148–149, 154
netstat -tulpn, 78
nice, adjusting process priority with, 
89–90
ntpdate, 325
ntpq, 326
ntpq -p, 326
ntptrace, 326
OpenLDAP, 201
openssl, 284
openvpn, 314
/opt/drbl/sbin/drbl-client-switch, 
37–38
/opt/drbl/sbin/drblpush -i, 32
/opt/drbl/sbin/select-in-client, 38
pmap, 63, 65
ps aux, 62
postdrop, 251
pvdisplay, 369
pvscan, 368
reiserfsck, 380
smbclient, 235
smbclient -L localhost, 234
smbpasswd, 231, 235
smbpasswd -W, 239
stat, 110
stats, 112
sysctl, 84, 85
taskset, 90, 91
time, 80
unconfined, 301
vgdisplay, 370
vgscan, 370
vmstat -d, 67
vmstat -s
CPU performance and, 52, 58
memory performance and, 59
xfsdump, 127
xfs_freeze, 128
xfs_growfs, 125–127
xfs_info, 125
xfs_repair, 127
xfs_rtcp, 127
common-auth configuration file (PAM)
contents of, 227
modified, 228
Complete Fair Queueing (I/O scheduler), 
97
components
Cyrus IMAPd, 275–276
Postfix MTA, 262–263
configuration file
storing settings in, 84
configuration files
for Nagios tool
contacts.cfg, 139
contacts group, defining, 140
creating, 138–139
hosts and host groups, defining, 
141–143
services.cfg, 144–148
timeperiods_nagios2.cfg, 149–151
OpenLDAP, 201
configuring
See also configuration files
clients for cloning in Clonezilla imaging 
server, 36–38
Clonezilla imaging server, 35–36
cluster resources, 180–187
Cyrus IMAPd, 276–277
Diskless Remote Boot in Linux software, 
32–33
DRBD, 164–165
Heartbeat, 175–179
huge pages, 92–93
iSCSI initiator, 173–175
iSCSI target, 169–172
Kerberos, 330–332
Kerberos client, 339
Kerberos server
administrative user account, 337–338
database and stash file, 336
generic settings, 332–335
KDC settings, 335–336
user accounts, adding, 338
verifying KDC is operational, 338–339
www.it-ebooks.info

NINDEX
386
Nagios server to use NRPE, 154–155
Nagios tool
location of configuration files, 
135–136
master configuration file, 136–138
restarting with configuration, 151
NRPE on monitored server, 152–154
nsswitch.conf file to find LDAP services, 
228–229
NTP client, 325–326
NTP time server
drift file, 327
log file, 328
security restrictions, applying, 
328–329
OpenLDAP
database, adding information to, 
215–217
overview of, 202
server, 203–215
slapd server, 203–206
verifying configuration with 
ldapsearch command, 217–220
OpenVPN
certificate authority, 305–308
client keys, 310–311
copying keys to client, 312
Diffie-Hellman parameters, 311–312
server keys, 308–310
PAM for LDAP authentication, 223–228
Postfix MTA
components, 262–263
dpkg-reconfigure command, 257–262
global settings, 264–266
initial settings, 256–257
master daemon, 263–264
overview of, 250–251
simple mail server, 267–268
to handle inbound and outbound 
mail, 251–255
to use lookup tables, 269–273
Samba servers
applying permissions to local direc-
tory, 232
defining share, 232–234
local directory to share, creating, 232
as primary domain controllers, 
241–243
testing access to share, 235–236
user account, creating, 235
workstation accounts, creating, 243
stand-alone NTP time server, 323–324
STONITH, 191–193
Ubuntu Server as mail server, 249
VPN server
Linux VPN client, 316–319
overview of, 313–316
Windows VPN client, 320
connection to SAN for enterprise network 
installation, 2–3
contacts file for Nagios tool, creating, 139
contacts group for Nagios tool, defining, 
140
container objects, 198
contents of inodes, showing, 110–111
context switches, performance and, 52
copying keys to client (OpenVPN), 312
CPU
analyzing performance of, 51– 57
monitoring with top utility, 46– 49
tuning
adjusting process priority using nice 
command, 89–90
overview of, 87– 89
SMP environments, 90–91
thread scheduler, 87–88
crm_mon -i 1 command, 177, 183–184
cryptography
certificate authority
creating, 284–289
need for, 283–284
key pairs, 282
overview of, 281
SSL and, 282
Cyrus IMAPd
components, 275–276
installing, 275
main configuration file, 276–277
managing user mailboxes, 277–278
www.it-ebooks.info

NINDEX
387
D
database
for Kerberos server, creating, 336
LDAP
adding information to, 215–217
deleting entries from, 222
modifying entries in, 221
Deadline scheduler (I/O scheduler), 97
debugfs utility
Ext2/Ext3 file system, 122–124
overview of, 378
showing contents of inodes with, 
110–111
debugreiserfs tool, 129–130
default page size, in memory, 57
default schema files of LDAP, 200–201
deleting entries from LDAP database, 222
device-device option (Clonezilla), 39
device-image option (Clonezilla), 39
devices for LVM logical volumes, 374–375
DHCP server, setting up, 33–35
Diffie-Hellman parameters, generating, 
311–312
digital certificates, 282
directory
See also LDAP Directory
assigning for Clonezilla, 35–36
description of, 111–112
/etc/event.d, 347
/etc/init.d, 347
Directory Components (LDAP), 198
disabling LDAP version 2 support, 206
disk activity, and storage performance, 66
disk layout
blueprint of, 6–7
file system, choosing, 5–6
RAID, setting up, 4–5
Diskless Remote Boot in Linux (DRBL), 
setting up
configuring software, 32–33
DHCP server, 33–35
installing software, 31–32
overview of, 30
disk mirroring (RAID method), 4
disk striping (RAID method), 4
Distinguished Name (LDAP), 198
Distributed Replicated Block Device 
(DRBD)
monitoring, 168–169
SAN and, 161
setting up, 164–165
starting, 166–167
dpkg-reconfigure postfix command, 
257–262
dpkg-reconfigure slapd command, 
203–206
drbddisk resource type, 182
DRBL (Diskless Remote Boot in Linux), 
setting up
configuring software, 32–33
DHCP server, 33–35
installing software, 31–32
overview of, 30
drift file, NTP, configuring, 327
dual-core server, monitoring performance 
on, 47
dumpe2fs utility, 120–122
E
e2fsck utility, 120
easy-rsa scripts, generating certificate 
authority with, 308
editing Samba configuration file, 233
e-mail, receiving
Cyrus IMAPd, using, 275–278
overview of, 274
procmail, using, 278–279
Qpopper, using, 279–280
e-mail, sending. See Postfix MTA
enterprise network installation
64-bit version of, 7
authentication handling, 3
completing, 22–23
connection to SAN, 2–3
file system, choosing, 5–7
LVM logical volumes, creating, 16–22
overview of, 1
post-installation tasks
multipathing, setting up, 26–27
NIC bonding, setting up, 24–26
preparing for, 3–4
RAID, setting up, 4–5
server hardware, 2
www.it-ebooks.info

NINDEX
388
software-based RAID, setting up, 9–16
starting, 8
entries in LDAP, 198
using, 25
/etc/defaults/slapd file, 211–213
/etc/event.d directory, 347
/etc/ha.d/authkeys file, 176
/etc/ha.d/ha.cf file, 175–179
/etc/ietd.conf file, 169
/etc/imapd.conf file, 276–277
/etc/init.d directory, 347
/etc/init.d/networking script, 349–350
/etc/lvm/lvm.conf file, 373
/etc/mke2fs.conf configuration file
contents of, 116
options, 117–119
/etc/modprobe.d/aliases, loading correct 
kernal modules using, 25
/etc/modprobe.d/arch/i386 file, contain-
ing correct bonding options
/etc/nagios2/apache2.conf file, contents 
of, 132
/etc/nagios2/cgi.cfg file, contents of, 132
/etc/nagios2/commands.cfg file, contents 
of, 135
/etc/network/interfaces, creating bond() 
devices using, 26
/etc/pam.d/login file contents, 224
/etc/postfix/main.cf file, parameters, 266
/etc/postfix/master.cf file
listing, 263
predefined fields and default values, 
264
/etc/ssl/openssl.cnf file, 285
/etc/xinetd.d/qpopper configuration file, 
279
ethtool utility, 74, 75
Ext2/Ext3 file system
accessing damaged, 378–380
analyzing and repairing
debugfs utility, 122–124
dumpe2fs and tune2fs utilities, 
120–122
e2fsck utility, 120
creating, 116–119
description of, 6, 116
mounting, 119
extents, description of, 112
F
fdisk command, 366–367
fdisk -l command, 359
Fibre Channel, 162
files, backing up, snapshot technology for, 
5
file systems
accessing damaged Ext3, 378–380
analyzing Ext2/Ext3, 119–124
choosing at installation, 5–7
description of, 6, 109
indexing, 115
inodes and directories, 110–112
journaling, 114–115
mounting, 112–113, 119
optimizing
Ext2/Ext3, 116–119
ReiserFS, 128–130
XFS, 124–128
repairing
Ext2/Ext3, 119–124
ReiserFS, 380
superblocks, inode bitmaps, and block 
bitmaps, 112–113
troubleshooting, 378
filtering incoming e-mail, 278–279
fork() system call, 91
forwarding mail to servers on Internet, 267
free -m command, 57
measuring performance, 86
fsck.reiserfs tool, 128–129
G
generic network performance optimiza-
tion, 106–107
getent command, 230
global settings for Postfix, configuring, 
264–266
gpart command, 365
Grub
boot loader, 344
configuring huge pages with, 92
command-line interface, 362
www.it-ebooks.info

NINDEX
389
loading, 362–364
reinstalling, 361
troubleshooting, 361
Grub menu, 344, 351
H
ha.cf file, 175–179
hardware initialization, 344
hardware interrupts, performance and, 52
hardware requirements for SAN, 163
hb_gui interface (Heartbeat), 180–183
Heartbeat
configuring ha.cf file, 175–179
hb_gui interface, 180–183
SAN and, 162
Heimdal Kerberos, 321
help command, 326
help command (debugfs utility), 124
hierarchical structure of LDAP, 197
high-availability solution for Apache Web 
Server, 194
high memory, 59
hi performance category (top utility), 49
Host Detail window (Nagios), 157
hosts and host groups for Nagios tool, 
defining, 141–143
huge pages, configuring, 92–93
I
id performance category (top utility), 48
identifying problem for troubleshooting, 
344–350
ietadm command, 171
ifconfig command, 73–74
imaging network, schematic overview of, 
32
imaging server (Clonezilla)
assigning directory for, 35
clients for cloning, configuring, 36–38
cloning client, 39–43
configuring, 36
Diskless Remote Boot in Linux
configuring software, 32–33
DHCP server, setting up, 33–35
installing software, 31–32
setting up, 30
setting up, 29
inactive memory, 58
inbound mail
from local user to local user, processing, 
251–252
Postfix and, 251
sent over network to local user, process-
ing, 253
indexing, description of, 115
init=/bin/bash tool, 351–353
initrd loading, 346
init script (Postfix), 262
inode bitmaps, 112–113
inodes, 110–112
installation
See also installing
64-bit version of Ubuntu Server, 7
completing, 22–23
LVM logical volumes, creating, 16–22
on enterprise network
authentication handling, 3
connection to SAN, 2–3
file system, choosing, 5–7
overview of, 1
preparing for, 3–4
RAID, setting up, 4–5
server hardware, 2
post-installation tasks
multipathing, setting up, 26–27
NIC bonding, setting up, 24–26
software-based RAID, setting up, 9–16
starting, 8
installing
See also installation
AppArmor, 293
Cyrus IMAPd, 275
Diskless Remote Boot in Linux software, 
31–32
Kerberos, 330–332
Nagios tool, 131
NRPE service on Linux servers, 152–153
OpenLDAP, 202
OpenVPN, 303
Postfix, 256
software for SAN, 163
integrating Samba server
in Active Directory
www.it-ebooks.info

NINDEX
390
Kerberos authentication, setting up, 
245
making Samba member of domain, 
244
with LDAP
configuring secure connections, 239
connecting Samba to LDAP, 238–239
preparing LDAP, 237–238
preparing Samba, 236–237
specifying where to put objects, 240
Internet time, 323
inter-process communication, optimizing, 
94–96
interrupt counter, 53
interruptible hang, 375–377
I/O scheduler
description of, 96
optimizing, 97–98
iostat utility
disk performance and, 69
-x option, 70, 71
ipcs -lm command, 94
IPTraf tool
Additional Ports option, 75
description of, 75
interface, 77
LAN station monitor, 77
IQN (iSCSI Qualified Name) of target, 169
iscsiadm command, 173
iscsiadm -m session command, 174
iSCSI initiator, configuring, 173–175
iSCSI Qualified Name (IQN) of target, 169
iSCSI target
configuring, 169–172
SAN and, 162
iscsitarget resource type, 187
J
Journaled File System (JFS), 6
journaling
modes of, 114–115
ReiserFS and, 128
K
kadmin.local command, 337, 338
kdc.conf file listing, 335–336
KDC (Kerberos Distribution Center), 330, 
338–339
Kerberos
See also Kerberos server; NTP time 
server
authentication, setting up for Samba 
servers, 245
client
configuring, 339
logging in with, 340–341
description of, 321
design goals for, 329
installing and configuring, 330–332
versions of, 321
Kerberos Distribution Center (KDC), 330, 
338–339
Kerberos server
configuring
database and stash file, 336
generic settings, 332–335
KDC settings, 335–336
starting and creating administrative 
user account, 337–338
user accounts, adding, 338
verifying KDC is operational, 338–339
kernel panic, 346
kernel
interruptible hang, 375–377
loading, 346
noninterruptible hang, 378
parameters, tuning, 98–100
symmetric multiprocessing, 88
troubleshooting, 375
kinit command, 338
klist command, 338
Knoppix Rescue CD, 357–360
krb5.conf file
after installation, 332–335
PAM settings, 340
L
ldapadd command (LDAP), 201
ldap.conf files, 229
ldapdelete command (LDAP), 201, 222
LDAP (Lightweight Directory Access Pro-
tocol)
See also OpenLDAP
back-end database, 205
Data Interchange Format, 201
default schema files, 200–201
www.it-ebooks.info

NINDEX
391
hierarchical structure of, 197
integrating Samba with
configuring secure connections, 239
connecting Samba to LDAP, 238–239
preparing LDAP, 237–238
preparing Samba, 236–237
specifying where to put objects, 240
object attributes, 198
schema, 198–200
using for authentication
nsswitch.conf file, 228–229
PAM, configuring, 223–228
testing client connectivity, 230
LDAP Directory
default schema files, 200–201
schema file, 198–200
using, 197
ldapmodify command, 201, 221
ldappasswd command, 223
ldapsearch command, 201, 217–220
ldap-utils package, 217
ldd command, 223
libpam-ldap package, 227
Lightweight Directory Access Protocol. See 
LDAP
Linux
open-iscsi solution, 173
servers, installing NRPE service on, 
152–153
users, authenticating, 245–246
VPN client, configuring, 316–319
load average for system, 46
load balancing, 88
local certificate authority, 283
local time zone setting, 322
log file, NTP, configuring, 328
logging in with Kerberos client, 340–341
logging slapd.conf file, 213–214
logical blocks, and file systems, 109
logical partitions for RAID setup, 5
lookup tables, configuring Postfix to use
access, 270
aliases, 273
canonical, 270
overview of, 269–270
recipient_canonical, 271
relocated, 271
sender_canonical, 271
transport, 272
virtual, 272
lost administrator password, dealing with, 
380–381
low memory, 59
ls command (debugfs utility), 122
lsdel command (debugfs utility), 123
ls -i command, 110
lsof command, 71, 73
lsscsi command, 174
lvchange command, 374
lvdisplay command, 369–373
LVM logical volumes
boot problems, fixing, 368–373
creating on top of software RAID device, 
16–22
device not activated automatically, 
374–375
excluding devices for, 374
troubleshooting, 368
lvscan command, 371–373
M
mail delivery agent (MDA)
description of, 250
procmail, 278–279
mail server
configuring simple, 267–268
configuring Ubuntu Server as, 249
mail solution
components of, 249–250
receiving e-mail
Cyrus IMAPd, using, 275–278
overview of, 274
procmail, using, 278–279
Qpopper, using, 279–280
mail transfer agent (MTA)
description of, 250
Postfix, configuring
components, 262–263
dpkg-reconfigure command, 257–262
global settings, 264–266
initial settings, 256–257
master daemon, 263–264
overview of, 250–251
simple mail server, 267–268
www.it-ebooks.info

NINDEX
392
to handle inbound and outbound 
mail, 251–255
to use lookup tables, 269–273
Postfix management tools, 273–274
mail user agent (MUA), 250
management tools, Postfix MTA, 273–274
managing
AppArmor profiles, 294–299
Nagios tool, 155–159
user mailboxes, 277–278
XFS file system, 126
man -k xfs utility (XFS), 127
master boot record (MBR)
in boot process, 344
troubleshooting, 364
master daemon, 263–264
MDA (mail delivery agent)
description of, 250
procmail, 278–279
memory
analyzing performance of, 57– 65
configuring huge pages, 92–93
inter-process communication, optimiz-
ing, 94–96
optimizing usage of, 92–96
overview of, 91
write cache, optimizing, 93–94
memory monitoring with top utility, 49–50
mirroring, and shared storage, 161
MIT Kerberos, 321
mkdir /share command, 232
modifying entries in LDAP database, 221
modules (OpenLDAP), 201
monitoring
AppArmor status, 299–302
DRBD, 168–169
monitoring network. See Nagios tool
mount command, 235
mounting
Ext2/Ext3 file system, 119
file systems, 112–113
moving processes to other CPU cores, 88
MTA (mail transfer agent)
description of, 250
Postfix, configuring
components, 262–263
dpkg-reconfigure command, 257–262
global settings, 264–266
initial settings, 256–257
master daemon, 263–264
overview of, 250–251
simple mail server, 267–268
to handle inbound and outbound 
mail, 251–255
to use lookup tables, 269–273
Postfix management tools, 273–274
MUA (mail user agent), 250
multi core environment
benefits of, 88
symmetric multiprocessing kernel, 88
Multidisk utility, 15
multipathing, setting up, 26–27
multitasking system, performance in, 52
N
Nagios tool
check_disk plug-in, output from, 
144–147
commands, 148–149
configuration files, creating
contacts.cfg, 139
contacts group, defining, 140
hosts and host groups, defining, 
141–143
overview of, 138–139
services.cfg, 144–148
timeperiods_nagios2.cfg, 149–151
configuring
location of configuration files, 
135–136
master configuration file, 136–138
Nagios server to use NRPE, 154–155
installing, 131
managing
Host Detail window, 157
Reporting section, 159
Service Detail window, 156
Tactical Monitor Overview window, 
155
restarting with configuration, 151
user authentication, 132–134
netstat tool
options, 80
-tulpn option, 78
www.it-ebooks.info

NINDEX
393
network
monitoring performance of, 73–80
optimizing performance
generic network, 106
kernel parameters, tuning, 98, 100
overview of, 98
Samba and NFS, 105–106
TCP acknowledgements, 102–103
TCP read and write buffers, 101–102
TCP Syn queue, 103–105
TCP tunables, 100
network card, second, setting up, 30
networking in boot process, 349
network monitoring. See Nagios tool
Network Time Protocol (NTP), 322
NFS performance optimization, 105
NIC bonding, setting up, 24–26
NIC teaming, and installation program, 8
nice command, adjusting process priority 
with, 89–90
ni performance category (top utility), 48
noatime option (XFS), 126
noninterruptible hang, 378
Noop scheduler (I/O scheduler), 97
normal processes, priority of, 88–89
notail option (ReiserFS), 128
nr_pdflush_threads parameter, 93
NRPE
configuring Nagios server to use, 
154–155
configuring on monitored server, 
152–154
nss_ldap module (LDAP), 201, 228
nsswitch.conf file, configuring to find 
LDAP services, 228–229
ntp.conf file
driftfile parameter, 328
listing, 323
logfile statement, 328
restrict settings, 328
synchronization interval, configuring, 
324
ntpdate command, 325
ntpd (NTP daemon), 291–292, 327–328
NTP (Network Time Protocol), 322
ntpq command, 326
ntpq -p command, 326
NTP time server
client, configuring, 325–326
customizing
drift file, 327
log file, 328
security restrictions, applying, 
328–329
description of, 321–323
pulling or pushing time, 324–325
stand-alone, configuring, 323–324
synchronization status, checking, 
326–327
ntptrace command, 326
O
open-iscsi solution (Linux), 173
OpenLDAP
commands, 201
configuration files, 201
configuring, 202
database, adding information to, 
215–217
installing, 202
modules, 201
server, configuring
apt-get purge slapd command, 205
dpkg-reconfigure slapd command, 
203–206
slapd.conf file, 207–215
slapd daemon, 201
slurpd daemon, 201
utilities
ldapdelete command, 222
ldapmodify command, 221
ldappasswd command, 223
overview of, 220–221
verifying configuration with ldapsearch 
command, 217–220
open source SAN. See SAN
openssl command, 284
OpenVPN
certificate authority, configuring, 
305–308
client keys, creating, 310–311
copying keys to client, 312
Diffie-Hellman parameters, generating, 
311–312
www.it-ebooks.info

NINDEX
394
installing, 303
server keys, creating, 308–310
openvpn command, 314
/opt/drbl/sbin/drbl-client-switch com-
mand, 37–38
/opt/drbl/sbin/drblpush -i command, 32
/opt/drbl/sbin/select-in-client command, 
38
optimizing file systems
Ext2/Ext3
analyzing and repairing, 119–124
creating, 116–119
mounting, 119
overview of, 116
ReiserFS, 128–130
XFS
management of, 126
organization of, 124–125
setting properties, 125–126
utilities, 127–128
optimizing performance. See performance 
optimization
outbound mail
for local user, processing, 254
Postfix and, 251
for remote system user, processing, 254
undeliverable, processing, 255
P
page size, default, in memory, 57
pam_ldap module (LDAP), 201
PAM (Pluggable Authentication Modules), 
configuring for LDAP authentica-
tion, 223–228
parameters for Samba configuration as 
primary domain controller, 242
Partition Disk screen, 13
Partition Disks interface, 17, 21
partitions
boot, creating, 12
logical, for RAID setup, 5
troubleshooting, 365–368
passwords
for LDAP administrator, 202
in LDAP environment, changing, 223
lost administrator, dealing with, 
380–381
performance baselining, 80
performance monitoring
CPU, analyzing performance of, 51–57
memory problems, finding, 57– 65
network, 73– 80
overview of, 45
storage, 65–73
top utility
CPU monitoring with, 46 –49
memory monitoring with, 49–50
output from, 45
process monitoring with, 50–51
performance optimization
CPU
adjusting process priority with nice 
command, 89–90
overview of, 87– 89
SMP environments, 90–91
thread scheduler, 87, 88
memory
configuring huge pages, 92–93
inter-process communication, 94– 96
overview of, 91–92
write cache, 93–94
network
generic, 106
kernel parameters, tuning, 98–100
overview of, 98
Samba and NFS, 105–106
TCP acknowledgements, 102–103
TCP read and write buffers, 101–102
TCP Syn queue, 103–105
TCP tunables, 100–101
overview of, 83
storage
I/O scheduler, 96– 98
overview of, 96
read requests, tuning, 98
testing changes to settings before ap-
plying, 85–87
permissions, applying to local directory 
for Samba, 232
pickup daemon, 251
PKI (public key infrastructure)
advantages of, 321
for VPN, 305
www.it-ebooks.info

NINDEX
395
Pluggable Authentication Modules (PAM), 
configuring for LDAP authentica-
tion, 223–228
plug-ins available in Nagios, 144
pmap command, 63–65
POP3 server, setting up, 279–280
POSIX standard, 290
postdrop command, 251
Postfix MTA
configuring
components, 262–263
dpkg-reconfigure command, 257–262
global settings, 264–266
for handling inbound and outbound 
mail, 251–255
initial settings, 256–257
master daemon, 263–264
overview of, 250–251
simple mail server, 267–268
for using lookup tables, 269–273
management tools, 273–274
post-installation tasks
multipathing, setting up, 26–27
NIC bonding, setting up, 24–26
primary domain controllers, Samba serv-
ers as, 241–243
problem, identifying, 344–350
/proc/drbd file, 184
process files, slapd.conf file, 211
process monitoring with top utility, 50–51
process priority, adjusting with nice com-
mand, 89–90
procmail MDA, 278–279
/proc/net/iet/volume file, 171
ps utility, 62
public IP address, and VPN connection, 
316
public key infrastructure (PKI)
advantages of, 321
for VPN, 305
public/private key pairs, 282
pulling time, 324–325
purging database and slapd configuration, 
205
pushing time, 324–325
pvdisplay command, 369
pvscan command, 368
Q
Qpopper, 279–280
R
RAID
setting up at installation, 4–5
software-based
creating at installation, 9–16
creating LVM logical volumes on top 
of, 16–22
read requests, 
reordering, 114
tuning, 98
realm, 330
real-time processes, priority of, 88
receiving e-mail
Cyrus IMAPd, 275–278
overview of, 274
procmail, 278–279
Qpopper, 279–280
recipient_canonical lookup table, config-
uring Postfix to use, 271
redundancy
See also RAID
in enterprise environment, 2
NIC bonding and, 24
in storage area network, 2
reference clocks, 324
reinstalling Grub, 361
reiserfsck command, 380
ReiserFS file system
description of, 6, 116, 128–130
repairing, 380
relocated lookup table, configuring Postfix 
to use, 271
remounting file system, 110
reordering read and write requests, 114
repairing
Ext2/Ext3 file system
debugfs utility, 122–124
dumpe2fs and tune2fs utilities, 
120–122
e2fsck utility, 120
ReiserFS file system, 380
Reporting section (Nagios), 159
Rescue a Broken System option, 353–356
www.it-ebooks.info

NINDEX
396
restarting Nagios tool with configuration, 
151
restoredisk option (Clonezilla), 40
runlevel scripts, order of, 347–349
runnable process, 51
run queue, 51
S
Samba performance optimization, 
105–106
Samba servers
integrating in Active Directory, 244–245
integrating with LDAP
configuring secure connections, 239
connecting Samba to LDAP, 238–239
preparing LDAP, 237–238
preparing Samba, 236–237
specifying where to put objects, 240
overview of, 231
as primary domain controllers, 241–243
setting up
applying permissions to local direc-
tory, 232
defining share, 232–234
local directory to share, creating, 232
overview of, 231
testing access to share, 235–236
user account, creating, 235
SAN (storage area network)
accessing with iSCSI, 169
cluster configuration, backing up, 
187–191
cluster resources, configuring, 180–187
connection to, 2–3
DRBD
monitoring, 168–169
setting up, 164–165
starting, 166–167
hardware requirements for, 163
Heartbeat, configuring, 175–179
iSCSI, configuring, 169–172
iSCSI initiator, configuring, 173–175
software components needed for creat-
ing, 162
software for, installing, 163
STONITH, configuring, 191–193
savedisk option (Clonezilla), 40
scheduling process of CPU, 87–88
schema files, slapd.conf file, 211
schema of LDAP, 198–200
Secure Sockets Layer (SSL) protocol
certificate authority
creating, 284–289
need for, 283–284
key pairs, 282
security options
See also authentication
AppArmor
components of, 290–291
creating and managing profiles, 
294–299
installing and starting, 293–294
monitoring status of, 299–302
overview of, 290
permissions, 293
updating profiles, 299
cryptography
certificate authority, creating, 
284–289
certificate authority, need for, 
283–284
key pairs, 282
overview of, 281
SSL and, 282
for VPN, 303
security restrictions, applying to NTP time 
server, 328–329
SELinux, 290
sender_canonical lookup table, configur-
ing Postfix to use, 271
Sendmail, Postfix mail server compared 
to, 250
server certificates, creating, 284–289
server hardware for enterprise network 
installation, 2
server keys (OpenVPN), creating, 308–310
servers
See also Samba servers
Clonezilla imaging
assigning directory for, 35
clients for cloning, configuring, 36–38
cloning clients, 39–43
configuring, 36
Diskless Remote Boot in Linux, 30–35
setting up, 29
www.it-ebooks.info

NINDEX
397
DHCP, setting up, 33–35
Kerberos
configuring, 332–336
starting and creating administrative 
user account, 337–338
user accounts, adding, 338
verifying KDC is operational, 338–339
mail, configuring, 249, 267–268
NTP time
client, configuring, 325–326
customizing, 327–329
description of, 321–323
pulling or pushing time, 324–325
stand-alone, configuring, 323–324
synchronization status, checking, 
326–327
POP3, setting up, 279–280
synchronizing time between, 322–323
VPN, 304–305
web, and Nagios tool, 131
Service Detail window (Nagios), 156
services for Nagios tool to monitor, defin-
ing, 144–148
shared memory, 94–96
shared storage. See SAN
shmall setting, 95
shmmax setting, 95
shmmni setting, 95
si performance category (top utility), 49
slab memory, 60
slabtop utility, 61
slapd.conf file
ACLs, 214–215
contents of, 207–211
description of, 201
logging, 213–214
schema and process files, 211
startup parameters, 211–213
slapd daemon (OpenLDAP), 201
slurpd daemon (OpenLDAP), 201
smbclient command, 235
smbclient -L localhost command, 234
smbpasswd command, 231, 235
smbpasswd -W command, 239
SMP environment. See  symmetric 
multiprocessing (SMP) kernel 
environment
smtpd process, 253–255
snapshot technology for backing up files, 5
software
Diskless Remote Boot in Linux
configuring, 32–33
installing, 31–32
RAID
creating at installation, 9–16
creating LVM logical volumes on top 
of, 16–22
implementing, 4–5
virtualization, creating installation con-
figuration using, 4
SSH VPN, 303
SSL (Secure Sockets Layer) protocol
certificate authority
creating, 284–289
need for, 283–284
key pairs, 282
stack trace, dumping
interruptible hangs, 375–377
noninterruptible hangs, 378
stand-alone NTP time server, configuring, 
323–324
starting
AppArmor, 294
DRBD, 166–167
installation, 8
iSCSI target, 170
Kerberos server, 337–338
startup parameters, slapd.conf file, 
211–213
stash file for Kerberos server, creating, 336
stat command, 110
stats command, 112
STONITH, configuring, 191–193
storage
I/O scheduler
description of, 96
optimizing, 97–98
monitoring performance of, 65–73
optimizing performance of, 96
read requests, tuning, 98
storage area network. See SAN
st performance category (top utility), 49
stratums, 322–323
superblocks, 112–113
www.it-ebooks.info

NINDEX
398
swap memory, 57
switching off barriers, 114
symmetric multiprocessing (SMP) kernel 
environment
description of, 88
optimizing, 90–91
synchronization status, NTP, checking, 
326–327
synchronizing time between servers, 
322–323
sy performance category (top utility), 48
sysctl command, 84, 85
/sys/kernel/security/apparmor/profiles 
file, 300
sysvconfig tool, 172
sysvconfig utility, 89
T
Tactical Monitor Overview window 
(Nagios), 155
target ID of iSCSI target, 171
taskset command, 90–91
TCP acknowledgements, 102–103
tcp_keepalive_intvl parameter, 104
tcp_keepalive_time parameter, 104
tcp_max_syn_backlog parameter, 103
TCP read and write buffers, 101–102
tcp_synack_retries parameter, 104
TCP Syn queue, 103–105
TCP tunables, 100–101
testing
access to Samba share, 235–236
changes to settings before applying, 
85–87
LDAP client connectivity, 230
thread scheduler, 87–88
Ticket Granting Ticket (TGT), 330
tickless kernel, 52
time command, 80, 86
time periods for Nagios tool, defining, 
149–151
TLS (Transport Layer Security), 282
top utility
CPU cycles and, 89
CPU monitoring with, 46–49
Last used cpu (SMP) option, 54
memory monitoring with, 49–50
output from, 45
process monitoring with, 50–51
tools
See also Nagios tool; troubleshooting 
tools
debugfs, 110–111, 122–124, 378
debugreiserfs, 129–130
dumpe2fs, 120–122
e2fsck, 120
fsck.reiserfs, 128
management, Postfix MTA, 273–274
man –k xfs, 127
Multidisk, 15
OpenLDAP
ldapdelete command, 222
ldapmodify command, 221
ldappasswd command, 223
overview of, 220–221
sysvconfig, 172
tune2fs, 120–122
XFS file system, 127–128
Transport Layer Security (TLS), 282
transport lookup table, configuring Postfix 
to use, 272
trivial-rewrite daemon, 253–255
troubleshooting
chroot environment and, 357
file systems
Ext3, accessing damaged, 378–380
ReiserFS, 380
Grub
loading manually, 362–364
reinstalling, 361
identifying problem, 344–350
kernel
interruptible hang, 375–377
noninterruptible hang, 378
lost administrator password, 380–381
LVM logical volumes
boot problems, 368–373
device not activated automatically, 
374–375
excluding devices for, 374
master boot record, 364
overview of, 343
partitions, 365–368
troubleshooting tools
www.it-ebooks.info

NINDEX
399
init=/bin/bash, 351–353
Knoppix Rescue CD, 357–360
overview of, 351
Rescue a Broken System option, 
353–356
trusted root certificate authority, 283
tun device, adding to VPN server, 315
tune2fs utility, 120–122
tuning CPU
adjusting process priority using nice 
command, 89–90
overview of, 87–89
SMP environments, 90–91
thread scheduler, 87–88
U
unconfined command, 301
Universal Time Coordinated (UTC), 322
updating AppArmor profiles, 299
Upstart, 347
user accounts
for Kerberos server, adding, 338
for Samba, creating, 235
user authentication for Nagios tool, 
132–134
user mailboxes, managing, 277–278
us performance category (top utility), 48
UTC= setting, 322
UTC (Universal Time Coordinated), 322
utilities. See tools
V
van Vugt, Sander, Beginning Ubuntu 
Server Administration, 131
/var/lib/ldap/DB_CONFIG file, 204
/var/run/slapd/slapd.args file, 211
Venema, Wietse, 251
versions of Ubuntu Server, 64- compared 
to 32-bit, 7
vgdisplay command, 370
vgscan command, 370
virtualization software, creating installa-
tion configuration using, 4
virtual lookup table, configuring Postfix to 
use, 272
virtual memory, 91
Virtual Private Network server. See VPN 
server
vmstat -s command
CPU performance and, 52, 57
vmstat utility
active and inactive memory informa-
tion, 58
cpu section, 55
disk performance and, 67– 69
sample mode, 55, 57, 68
swap information, 58
VPN
See also VPN server
normal configuration of, 304–305
public key infrastructure for, 305
VPN server
See also OpenVPN
configuring, 313–316
description of, 303
Linux VPN client, configuring, 316–319
Windows VPN client, configuring, 320
W
wa parameter (top utility), 90
wa performance category (top utility), 48
web servers, and Nagios tool, 131
winbind package, 245–246
Windows VPN client, configuring, 320
workstation accounts for Samba, creating, 
243
write cache, optimizing, 93–94
write requests, reordering, 114
X
X.509 standard, 282
xfsctl function, 125
xfsdump command, 127
XFS file system
description of, 6, 124
management of, 126
organization of, 124–125
setting properties, 125–126
utilities, 127–128
xfs_freeze command, 128
xfs_growfs command, 125–127
xfs_info command, 125
xfs_repair command, 127
xfs_rtcp command, 127
xinetd, running Qpopper through, 279
www.it-ebooks.info

