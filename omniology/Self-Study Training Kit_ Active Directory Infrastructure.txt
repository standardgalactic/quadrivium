
Active Directory Infrastructure
Self-Study Training Kit
Windows Server 2012 and R2
2 Full-length Personal Training Guides in 1 Convenient Kit!
William Stanek Training Solutions

PUBLISHED BY
Stanek & Associates
PO Box 362
East Olympia, WA 98540-0362
Copyright © 2015 William Stanek
All rights reserved. No part of the contents of this book may be reproduced, stored or
transmitted in any form or by any means without the express written permission of the
publisher.
United States of America
The Personal Trainer and Stanek & Associates are trademarks of William Stanek. All
other marks are property of their respective owners.
The example names for companies, organizations, persons and other named elements used
in the book are fictitious. No association with any real company, organization, person or
other named element is intended or should be inferred.
This book expresses the author’s views and opinions. The information contained herein is
provided without any express, statutory or implied warranties. Neither the authors, the
publishers, the resellers nor distributors will be held liable for any damages caused or
alleged to be caused either directly or indirectly by this book.

Cover Design: Creative Designs Ltd.
Editorial Development: Andover Publishing Solutions
Technical Review: L & L Technical Content Services
You can provide feedback related to this book by emailing the author at
williamstanek@aol.com. Please use the name of the book as the subject line.



Training Kit Contents
Active Directory Administration: The Personal Trainer
Contents at a Glance
Introduction
Chapter 1. Active Directory Essentials
Chapter 2. Installing New Forests, Domain Trees, and Child Domains
Chapter 3. Deploying Writeable Domain Controllers
Chapter 4. Deploying Read-Only Domain Controllers
Chapter 5. Configuring, Maintaining, and Troubleshooting Global Catalog Servers
Chapter 6. Configuring, Maintaining, and Troubleshooting Operations Masters
Chapter 7. Managing Active Directory Sites, Subnets, and Replication
Chapter 8. Managing Trusts and Authentication
Chapter 9. Maintaining and Recovering Active Directory
Windows Group Policy: The Personal Trainer
Contents at a Glance
Introduction
Chapter 1. Introducing Group Policy
Chapter 2. Deploying Group Policy
Chapter 3. Group Policy Management
Chapter 4. Advanced Group Policy Management
Chapter 5. Searching and Filtering Group Policy
Chapter 6. Maintaining the SYSVOL
Chapter 7. Managing Group Policy Processing
Chapter 8. Maintaining and Restoring Group Policy
Appendix A. Installing Group Policy Tools



Training Kit Contents: Detailed
Active Directory Administration: The Personal Trainer
Table of Contents
Introduction
What’s This Book About?
What Do I Need to Know?
How Is This Book Organized?
What Conventions Are Used in This Book?
Other Resources
Chapter 1. Active Directory Essentials
Understanding Directory Services
Introducing Active Directory
Active Directory Domains
DNS Domains
Domain Controllers
Active Directory Objects
Active Directory Schema
Active Directory Components
Physical Components
Logical Components
Managing Active Directory
Working with Active Directory
Active Directory Administration Tools
Graphical Administration Tools
Command-Line Tools
Chapter 2. Installing New Forests, Domain Trees, and Child Domains
Preparing for Active Directory Installation
Working with Directory Containers and Partitions
Establishing or Modifying Your Directory Infrastructure
Establishing Functional Levels

Active Directory Enhancements for Windows Server 2008 and R2
Active Directory Enhancements for Windows Server 2012 and R2
Deploying Windows Server 2012 and R2
Creating Forests, Domain Trees, and Child Domains
Installing the AD DS Binaries
Creating New Forests
Creating New Domain Trees
Creating New Child Domains
Chapter 3. Deploying Writeable Domain Controllers
Preparing to Deploy or Decommission Domain Controllers
Adding Writeable Domain Controllers
Installing Additional Writeable Domain Controllers
Adding Writeable Domain Controllers Using Replication
Adding Writeable Domain Controllers Using Installation Media
Decommissioning Domain Controllers
Preparing to Remove Domain Controllers
Global catalog server
Bridgehead server
Operations master
Removing Additional Domain Controllers
Removing the Last Domain Controller
Forcing the Removal of Domain Controllers
Stopping Active Directory Domain Services
Restarting a Domain Controller in Directory Services Restore Mode
Performing Forced Removal of Domain Controllers
Cleaning Up Metadata in the Active Directory Forest
Cleaning Up Server Metadata
Cleaning Up DNS Records
Confirming Removal of Deleted Server Objects
Chapter 4. Deploying Read-Only Domain Controllers
Preparing to Deploy Read-Only Domain Controllers
Understanding RODC Installation Options

Adding RODCs Without Staging
Using Staged Installations
Stage 1: Creating the RODC Account and Preparing for Installation
Stage 2: Attaching the RODC and Finalizing Installation
Performing Staged Installations Using Windows PowerShell
Decommissioning RODCs
Forcing the Removal of RODCs
Setting Password Replication Policy
Password Replication Policy Essentials
Allowing and Denying Accounts
Managing Credentials on RODCs
Identifying Allowed or Denied Accounts
Resetting Credentials
Delegating Administrative Permissions
Chapter 5. Configuring, Maintaining, and Troubleshooting Global Catalog Servers
Working with Global Catalog Servers
Deploying Global Catalog Servers
Adding Global Catalog Servers
Monitoring and Verifying Global Catalog Promotion
Identifying Global Catalog Servers
Restoring Global Catalog Servers
Removing Global Catalog Servers
Controlling SRV Record Registration
Managing and Maintaining Universal Group Membership Caching
Universal Group Membership Caching Essentials
Enabling Universal Group Membership Caching
Monitoring and Troubleshooting Universal Group Membership Caching
Managing and Maintaining Replication Attributes
Understanding Global Catalog Search and the Partial Attribute Set
Designating Replication Attributes
Searching and Indexing Attributes in the Directory
Configuring Deferred Index Creation

Monitoring and Troubleshooting Replication Attributes
Managing and Maintaining Name Suffixes
Configuring User Principal Name Suffixes
Configuring Name Suffix Routing
Chapter 6. Configuring, Maintaining, and Troubleshooting Operations Masters
Operations Master Essentials
Introducing Operations Masters
Identifying Operations Masters
Planning for Operations Masters
Changing Operations Masters
Working with Operations Masters
Managing Domain Naming Masters
Managing Infrastructure Masters
Managing PDC Emulators
Managing Relative ID Masters
Managing Schema Masters
Maintaining Operations Masters
Preparing Standby Operations Masters
Decommissioning Operations Masters
Reducing Operations Master Workload
Seizing Operations Master Roles
Preparing to Seize Operations Master Roles
Seizing Operations Master Roles
Troubleshooting Operations Masters
Chapter 7. Managing Active Directory Sites, Subnets, and Replication
Implementing Sites and Subnets
Working with Sites
Setting Site Boundaries
Replication Essentials
The Replication Model
Replication with Multiple Sites
SYSVOL Replication

Essential Services for Replication
Intrasite Versus Intersite Replication
Intrasite Replication
Intersite Replication
Developing Your Site Design
Mapping Your Network Structure
Designing Your Sites
Designing Your Intersite Replication Topology
Configuring Sites and Subnets
Creating Sites
Creating Subnets
Adding Domain Controllers to Sites
Ensuring Clients Find Domain Controllers
Configuring Site Links and Intersite Replication
Understanding Site Links
Creating Site Links
Configuring Link Replication Schedules
Bridging Sites
Locating and Designating Bridgehead Servers
Locating ISTGs
Optimizing Site Link Configurations
Monitoring, Verifying, and Troubleshooting Replication
Monitoring Replication
Troubleshooting Replication
Generating Replication Topology
Verifying and Forcing Replication
Chapter 8. Managing Trusts and Authentication
Active Directory Authentication and Trusts
Trust Essentials
Authentication Essentials
Authentication Across Domain Boundaries
Authentication Across Forest Boundaries

Working with Domain and Forest Trusts
Examining Trusts
Establishing Trusts
Creating External Trusts
Creating a One-Way Incoming External Trust
Creating a One-Way Outgoing External Trust
Creating a Two-Way External Trust
Creating Shortcut Trusts
Creating a One-Way Incoming Shortcut Trust
Creating a One-Way Outgoing Shortcut Trust
Creating a Two-Way Shortcut Trust
Creating Forest Trusts
Creating a One-Way Incoming Forest Trust
Creating a One-Way Outgoing Forest Trust
Creating a Two-Way Forest Trust
Creating Realm Trusts
Creating a One-Way Incoming Realm Trust
Creating a One-Way Outgoing Realm Trust
Creating a Two-Way Realm Trust
Removing Manually Created Trusts
Verifying and Troubleshooting Trusts
Configuring Selective Authentication
Enabling or Disabling Selective Authentication for External Trusts
Enabling or Disabling Selective Authentication for Forest Trusts
Granting the Allowed To Authenticate Permission
Chapter 9. Maintaining and Recovering Active Directory
Protecting Objects from Accidental Deletion
Starting and Stopping Active Directory Domain Services
Setting the Functional Level of Domains and Forests
Configuring the Windows Time Service
Understanding Windows Time
Working with W32tm

Checking the Windows Time Configuration
Configuring an Authoritative Time Source
Troubleshooting Windows Time Services
Configuring Windows Time Settings in Group Policy
Backing Up and Recovering Active Directory
Active Directory Backup and Recovery Essentials
Backing Up and Restoring the System State
Performing a Nonauthoritative Restore of Active Directory
Performing an Authoritative Restore of Active Directory
Restoring Sysvol Data
Recovering by Installing a New Domain Controller
Working with Active Directory Recycle Bin
Getting Schema Ready for the Recycle Bin
Enabling Active Directory Recycle Bin
Recovering Deleted Objects
Recovering Deleted Objects Using Administrative Center
Recovery Using Windows PowerShell
Maintaining the Directory Database
Understanding Directory Database Operations
Getting Statistics for the Directory Database
Checking for Free Space in the Directory Database
Performing Offline Defragmentation
Moving the Directory Database
Windows Group Policy: The Personal Trainer
Table of Contents
Introduction
What’s This Book About?
What Do I Need to Know?
How Is This Book Organized?
What Conventions Are Used in This Book?
Other Resources

Chapter 1. Introducing Group Policy
Group Policy Preferences and Settings
Understanding Group Policy Objects
Global Group Policy
Local Group Policy
Managing Group Policy
Working with Group Policy
Group Policy Administration Tools
Graphical Administration Tools
Command-Line Tools
Chapter 2. Deploying Group Policy
Keeping Group Policy Up to Date
Managing Policy Updates
Managing Changes with Template Files
Managing Changes with DFSR Replication
Applying and Linking Group Policy Objects
Policy Sets Within GPOs
GPO Types
GPO Links
Connecting to and Working with GPOs
Using Default Policies
Working with the Default Domain Policy GPO
Working with the Default Domain Controllers Policy GPO
Using Policy Preferences and Settings
Using Policy Settings for Administration
Using Policy Preference for Administration
Choosing Between Preferences and Settings
Controlling Device Installation
Controlling Files and Folders
Controlling Internet Explorer
Controlling Power Options
Controlling Printers

Controlling Registry Keys and Values
Controlling the Start Menu
Controlling System Services
Controlling Users and Groups
Chapter 3. Group Policy Management
Understanding Resultant Set of Policy
Managing Local Group Policies
Working with Top-Level LGPOs
Working with Other LGPOs
Managing Active Directory–Based Group Policy
Working with GPOs in Sites, Domains, and OUs
Accessing Additional Forests
Showing Sites in Connected Forests
Accessing Additional Domains
Setting Domain Controller Focus Options
Delegating Privileges for Group Policy Management
Determining and Assigning GPO Creation Rights
Determining Group Policy Management Privileges
Delegating Control for Working with GPOs
Delegating Authority for Managing Links and RSoP
Managing Your GPOs in Production
Using Starter GPOs
Creating and Linking GPOs
Creating and Linking GPOs for Sites
Creating and Linking GPOs for Domains
Creating and Linking GPOs for OUs
Determining Where a GPO Is Linked
Enabling and Disabling GPOs
Enabling and Disabling GPO Links
Removing a GPO Link
Deleting GPOs
Managing Group Policy Preferences

Configuring Management Actions and Editing States
Using the Create, Replace, Update, and Delete Actions
Managing Editing States
Controlling Preference Items
Managing Precedence and Processing
Setting the Security Context
Removing Preference Items
Applying Preference Items During Refresh
Using Item-Level Targeting
Chapter 4. Advanced Group Policy Management
Using Change Control
Connecting to and Using AGPM
Managing GPOs with Change Control
Delegating Change Control Privileges
Managing Workflow and E-mail Notification
Managing Controlled GPOs
Using GPO Templates
Creating GPO Templates
Managing GPO Templates
Delegating Privileges for GPO Templates
Creating Controlled GPOs
Creating GPOs with No Approval Required
Creating GPOs with Approval Required
Controlling GPOs
Controlling GPOs with Permissions
Controlling GPOs Without Permissions
Importing GPOs from Production
Checking Out, Editing, and Checking In Controlled GPOs
Deploying Controlled GPOs
Deploying a GPO with Permissions
Deploying a GPO Without Permissions
Identifying Differences in GPOs

Reviewing GPO Links
Labeling and Renaming Controlled GPOs
Uncontrolling GPOs
Deleting Controlled GPOs
Deleting a GPO with Permissions
Deleting a GPO Without Permissions
Restoring or Destroying Controlled GPOs
Restoring or Destroying Items with Permissions
Restoring or Destroying Items Without Permissions
Controlling GPO Versions and History
Working with GPO History
Preventing or Enabling Deletion of History Versions
Rolling Back to a Previous Version of a GPO
Chapter 5. Searching and Filtering Group Policy
Finding Policy Settings
Filtering Techniques for Policy Settings
Filtering Policy Settings
Searching for GPOs
Search Techniques for Policy Objects, Links, and Settings
Performing Searches for GPOs
Using Security Group Filters
Security Group Filtering
Examining Security Group Filters
Applying Security Group Filters
Using WMI Filters
Creating WMI Queries
Managing WMI Filters
Creating a WMI Filter
Viewing and Editing WMI Filters
Applying or Removing a WMI Filter
Chapter 6. Maintaining the SYSVOL
Maintaining the SYSVOL

Managing SYSVOL Storage
Managing Storage Quotas for DFS Replication
Relocating the Staging Area
Identifying Replication Partners
Rebuilding the SYSVOL
Generating Replication Diagnostics Reports
Generating Replication Health Reports
Performing Propagation Tests
Generating Propagation Reports
Troubleshooting Replication Issues
Chapter 7. Managing Group Policy Processing
Managing Group Policy Inheritance
Changing Link Order and Precedence
Overriding Inheritance
Blocking Inheritance
Enforcing Inheritance
Controlling Group Policy Processing and Refresh
Policy Processing and Refresh Essentials
Policy Processing and Refresh Exceptions
Refreshing Group Policy Manually
Changing the Refresh Interval
Modifying GPO Processing
Configuring Loopback Processing
Configuring Slow-Link Detection
Slow-Link Detection Essentials
Configuring Slow-Link Detection and Policy Processing
Configuring Slow-Link and Background Policy Processing
Planning Group Policy Changes
Testing Implementation and Configuration Scenarios
Determining Effective Settings and Last Refresh
Chapter 8. Maintaining and Restoring Group Policy
Growing Your Enterprise Policy Configuration

Policy Processing for Thin Clients, Terminal Services, and Cloud Computing
Policy Processing Across Forests
Maintaining GPO Storage
Examining Group Policy Containers
Examining Group Policy Templates
Understanding GPC and GPT Processing
Copying, Importing, and Migrating GPOs
Copying GPOs
Importing GPOs
Migrating GPOs
Backing Up and Restoring GPOs
Backing Up GPOs
Restoring GPOs
Backing Up and Restoring Starter GPOs
Backing Up and Restoring WMI Filters
Backing Up and Restoring the AGPM Archive
Recovering the Default GPOs
Troubleshooting Group Policy
Diagnosing Group Policy: The Basics
Common Problems with Group Policy
Diagnosing Group Policy Issues
Restoring the Default Policy GPOs
Appendix A. Installing Group Policy Tools
Installing the Remote Server Administration Tools
Configuring and Selecting Remote Server Administration Tools
Removing the Remote Server Administration Tools
Installing Advanced Group Policy Management
Performing a Server Installation of AGPM
Performing a Client Installation of AGPM
Making the Agpm.admx Template Available
Configuring Group Policy to Support AGPM
Installing Group Policy Templates and Add-ins for Microsoft Office

About the Author


Active Directory
Administration:
The Personal Trainer
William Stanek

PUBLISHED BY
Stanek & Associates
PO Box 362
East Olympia, WA 98540-0362
Copyright © 2015 William Stanek
All rights reserved. No part of the contents of this book may be reproduced, stored or
transmitted in any form or by any means without the express written permission of the
publisher.
United States of America
The Personal Trainer and Stanek & Associates are trademarks of William Stanek. All
other marks are property of their respective owners.
The example names for companies, organizations, persons and other named elements used
in the book are fictitious. No association with any real company, organization, person or
other named element is intended or should be inferred.
This book expresses the author’s views and opinions. The information contained herein is
provided without any express, statutory or implied warranties. Neither the authors, the
publishers, the resellers nor distributors will be held liable for any damages caused or
alleged to be caused either directly or indirectly by this book.

Cover Design: Creative Designs Ltd.
Editorial Development: Andover Publishing Solutions
Technical Review: L & L Technical Content Services
You can provide feedback related to this book by emailing the author at
williamstanek@aol.com. Please use the name of the book as the subject line.



Introduction
Active Directory Administration: The Personal Trainer for Windows Server 2012 &
Windows Server 2012 R2 is the authoritative quick reference guide to Active Directory
and is designed to be a key resource you turn to whenever you have questions about
Active Directory. To this end, the book zeroes in on the key aspects of Active Directory
that you’ll use the most.
Inside this book’s pages, you’ll find comprehensive overviews, step-by-step procedures,
frequently used tasks, documented examples, and much more. One of the goals is to keep
the content so concise that the book remains compact and easy to navigate while at the
same time ensuring that the book is packed with as much information as possible—
making it a valuable resource.


What’s This Book About?
Active Directory Administration: The Personal Trainer for Windows Server 2012 &
Windows Server 2012 R2 is designed to be used in the daily administration of Active
Directory. In this book, I teach you how features work, why they work the way they do,
and how to customize them to meet your needs. I also offer specific examples of how
certain features can meet your needs, and how you can use other features to troubleshoot
and resolve issues you might have. In addition, this book provides tips, best practices, and
examples of how to fine-tune all major aspects of Active Directory.


What Do I Need to Know?
This book covers Active Directory for small, medium, and large organizations. To get
practical and useful information into your hands without the clutter of a ton of background
material, I had to assume several things. If you are reading this book, I hope that you have
basic networking skills and a basic understanding of Windows Server operating systems,
and that Windows Server is already installed on your systems. With this in mind, I don’t
devote entire chapters to understanding Windows Server architecture, installing Windows
Server, or Windows networking. I do, however, provide complete details on the
components of Active Directory networks and how you can use these components. I cover
installing domain controllers, configuring Active Directory sites, and much more.


How Is This Book Organized?
Making this book easy to follow and understand was my number one goal! I really want
anyone, skill level or work schedule aside, to be able to learn how to effectively manage
Active Directory.
To make the book easy to use, I’ve divided it into 9 chapters. In Chapters 1 and 2, you’ll
roll up your sleeves and dive right in to the good stuff while also learning how Active
Directory works. Chapter 1 provides an overview of tools, techniques, and concepts
related to Active Directory. Chapter 2 discusses installing forests, domain trees, and child
domains.
Chapter 3 details techniques for deploying writeable domain controllers and the tasks
you’ll need to perform to set up domain controllers. Chapter 4 covers the deployment of
read-only domain controllers. Together, these chapters provide the detailed information
you need to configure domains and forests, whether you are deploying Active Directory
Domain Services for the first time or extending your existing infrastructure.
In addition to their standard roles, domain controllers can also act as global catalog servers
and operations masters. Chapter 5 explores techniques for configuring, maintaining, and
troubleshooting global catalog servers. Chapter 6 examines how you manage operations
masters. Chapter 7 describes your work with Active Directory sites, subnets, and
replication. You’ll learn the essentials for creating sites and associating subnets with sites.
You’ll also learn advanced techniques for managing site links and replication.
Chapter 8 describes how to manage trusts and authentication. You’ll learn how Active
Directory authentication works within domains, across domain boundaries, and across
forest boundaries. You’ll also learn how trusts are used and established. Chapter 9
provides techniques you can use to maintain, monitor, and troubleshoot Active Directory
infrastructure. In addition to learning techniques for backing up and recovering Active
Directory, you’ll also learn how to perform essential maintenance tasks and how to
configure related options and services, including Windows Time service.
Finally, Appendix A provides a quick reference for command-line utilities you’ll use when
working with Active Directory.


What Conventions Are Used in This Book?
I’ve used a variety of elements to help keep the text clear and easy to follow. You’ll find
code terms and listings in monospace type, except when I tell you to actually enter a
command. In that case, the command appears in bold type. When I introduce and define a
new term, I put it in italics.
This book also has notes, tips and other sidebar elements that provide additional details on
points that need emphasis.


Other Resources
Although some books are offered as all-in-one guides, there’s simply no way one book can
do it all. This book is intended to be used as a concise and easy-to-use resource. It covers
everything you need to perform core tasks for Active Directory, but it is by no means
exhaustive.
As you encounter new topics, take the time to practice what you’ve learned and read
about. Seek additional information as necessary to get the practical experience and
knowledge that you need.
I truly hope you find that Active Directory Administration: The Personal Trainer for
Windows Server 2012 & Windows Server 2012 R2 helps you manage Active Directory
successfully and effectively.
Thank you,
William R. Stanek
(williamstanek@aol.com)


Chapter 1. Active Directory Essentials
Whether you are a skilled administrator who has worked with Windows networks for
years or a novice with a basic understanding, your long-term success in the ever-changing
technology landscape increasingly depends on how well you understand Active Directory.
Active Directory is an extensible directory service that enables centralized management of
network resources. It allows you to easily add, remove, or relocate accounts for users,
groups, and computers as well as other types of resources. Nearly every administrative
task you perform affects Active Directory in some way. Active Directory is based on
standard Internet protocols and has a design that helps you clearly identify the physical
and logical components of your network’s structure.


Understanding Directory Services
Active Directory provides the necessary infrastructure for designing a directory that meets
the needs of your organization. A directory is a stored collection of information about
various types of resources. In a distributed computing environment such as a Windows
network, users must be able to locate and use distributed resources, and administrators
must be able to manage how distributed resources are used. This is why a directory service
is necessary.
A directory service stores all the information needed to use and manage distributed
resources in a centralized location. The service makes it possible for resources to work
together. It is responsible for authorizing access, managing identities, and controlling the
relationships between the resources. Because a directory service provides these
fundamental functions, it must be tightly integrated with the security and management
features of the network operating system.
A directory service provides the means to define and maintain the network infrastructure,
perform system administration, and control the user experience. Although users and
administrators might not know the exact resources they need, they should know some
basic characteristics of the resources they want to use. If so, they can use the directory
service to obtain a list of resources that match the known characteristics. As illustrated in
Figure 1-1, they can use the directory service to query the directory and locate resources
that have specific characteristics. For example, users can search the directory to find a
color printer in a particular location or to find a color printer that supports duplex
functionality.
Figure 1-1 Working with directory services.

Because a directory service is a tool for both administrators and standard users,
administrators can also use the directory to locate resources. For example, an
administrator could locate file servers running Windows Server 2012 R2. As an
organization grows and its network grows with it, there are more and more resources to
manage, and the directory service becomes increasingly important.


Introducing Active Directory
Active Directory is the directory service included with Windows Server. Active Directory
includes the directory that stores information about your distributed resources as well as
the services that make the information useful and available. All current versions of
Windows Server support Active Directory.

Active Directory Domains
Windows domains that use Active Directory are called Active Directory domains. In an
Active Directory domain, your data resides in a single, distributed data repository that
requires less administration to maintain while also allowing easy access from any location
on the network. Using the physical and logical structures provided by Active Directory,
you can scale the directory to meet your business and network requirements whether you
have hundreds, thousands, or millions of resources.
Active Directory is designed to interoperate with other directory services and to accept
requests from many different clients using a variety of interfaces, as shown in Figure 1-2.
The primary protocol Active Directory uses is Lightweight Directory Access Protocol
(LDAP) version 3, an industry-standard protocol for directory services. When working
with other Windows servers, Active Directory supports replication through the REPL
interface. When working with legacy messaging clients, Active Directory supports
Messaging Application Programming Interface (MAPI). Active Directory also supports
the Security Accounts Manager (SAM) interface.
Figure 1-2 Active Directory can interoperate with clients and other directory services.
Active Directory authentication and authorization services use Kerberos version 5 and
other industry-standard protocols to provide protection for data by default while
maximizing flexibility. For example, by default Active Directory signs and encrypts all
communications that use LDAP. Signing LDAP communications ensures data comes from
a known source and has not been modified.
Active Directory is integrated with Windows Server security. As with files and folders,
you can control access to distributed resources in the directory by using a granular set of
permissions. You also can control access to the properties of distributed resources.
Additionally, Active Directory provides security groups for administration at various

levels throughout the enterprise.
In Active Directory, group policies are used to define permitted actions and settings for
users and computers. Policy-based management simplifies many administration tasks.
Group policies can be applied in many different ways. One way is to use security
templates to configure the initial security of a computer.

DNS Domains
Active Directory uses the Domain Name System (DNS). DNS is a standard Internet
service that organizes groups into a hierarchical structure. Although implemented for
different reasons, Active Directory and DNS have the same hierarchical structure. The
DNS hierarchy is defined on an Internet-wide basis for public networks and an enterprise-
wide basis for private networks. The various levels within the DNS hierarchy identify
individual computers and the relationship between computers. The relationship between
computers is expressed by using domains. Computers that are part of the same DNS
domain are closely related. Domains used within organizations are organizational
domains. Domains at the root of the DNS hierarchy are top-level, or root, domains.
Active Directory clients use DNS to locate resources. DNS translates easily readable host
names to numeric Internet Protocol (IP) addresses. Each computer in a domain has a fully
qualified domain name (FQDN), such as server34.imaginedlands.com. Here, server34
represents the name of an individual computer, imaginedlands represents the
organizational domain, and com is the top-level domain.
Top-level domains (TLDs) are at the base of the DNS hierarchy. TLDs are organized
geographically by using two-letter country codes, such as CA for Canada; by organization
type, using codes such as com for commercial organizations; and by function, using codes
such as mil for U.S. military installations.
Like top-level domains, DNS domains within an organization can be structured in many
ways. Normal domains, such as imaginedlands.com, are also referred to as parent
domains. They have this name because they’re the parents of an organizational structure.
You can divide parent domains into subdomains, which you can then use for different
offices, divisions, or geographic locations. For example, the FQDN for a computer at
Imagined Land’s Denver office could be designated as
workstation11.denver.imaginedlands.com. Here, workstation11 is the computer name,
denver is the subdomain, and imaginedlands.com is the parent domain. Another term for a
subdomain is child domain.
Updates to DNS are handled through a single authoritative DNS server. This server is
designated as the primary DNS server for the particular domain or area within a domain
called the zone. The primary DNS server stores a master copy of DNS records and a
domain’s configuration files. Secondary DNS servers provide additional services for a
domain to help balance the workload. Secondary servers store copies of DNS records
obtained from a primary server through a process called a zone transfer. Secondary
servers obtain their DNS information from a primary server when they’re started, and they
maintain this information until the information is refreshed or expired.
In Figure 1-3, the primary DNS server is responsible for DNS domains
imaginedlands.com, data.imaginedlands.com, and recs.imaginedlands.com. Secondary
DNS servers in the data.imaginedlands.com and recs.imaginedlands.com domains obtain
their DNS information from this primary server through periodic zone transfers.
Active Directory depends so much on DNS that you should either configure DNS on the
network before you install Active Directory or allow the Active Directory Installation
wizard to install DNS for you. Configuring DNS requires installing and configuring DNS

clients and DNS servers. All Windows operating systems include DNS clients and can be
configured with fully qualified host names. Any computer running the Windows Server
operating system can be configured as a DNS server.
When you configure Active Directory on your network, you can automatically install DNS
as part of Active Directory installation. You can also specify whether DNS and Active
Directory should be integrated partially or fully. As integration with Active Directory
changes the way DNS works, understanding the integration options is very important.
Figure 1-3 A DNS environment with zones.
With partial integration, the domain uses standard file storage, and updates to DNS are
handled exactly as discussed previously. The domain has a single primary server and one
or more secondary DNS servers. Secondary DNS servers obtain their DNS information
from the primary DNS server.
With full integration, DNS information is stored directly in Active Directory. Because the
information is part of Active Directory, you gain all the benefits of Active Directory and
your domain uses Active Directory to update and maintain DNS information.

Domain Controllers
When you install Windows Server on a computer, you can configure the computer as a
stand-alone server, a member server, or a domain controller. A domain controller (DC) is a
computer that hosts an Active Directory directory. If you are using Windows Server 2012
or Windows Server 2012 R2, you install Active Directory in two stages. First you add the
Active Directory Domain Services role to the server by using the Add Roles And Features
option in Server Manager. This prepares the server by installing the AD DS binaries and
the related management tools. The AD DS binaries include the Windows components that
enable servers to act as domain controllers.
After you install the binaries, you can configure Active Directory Domain Services and
promote the server to a domain controller. In Server Manager, you’ll have a Notification
task labeled Promote This Server To A Domain Controller. Clicking the related link starts
the Active Directory Domain Services Configuration Wizard. If there isn’t an existing
domain, the wizard helps you create a domain and configure Active Directory in the new
domain. The wizard can also help you add child domains to existing domain structures.
Figure 1-4 Any domain controller can replicate changes.
Windows Server supports a multimaster replication model. In this model, as shown in
Figure 1-4, every domain controller is autonomous, with its own copy of the directory.
Any domain controller can process standard directory changes and then replicate those
changes to other domain controllers automatically.
Real World  Because some changes are impractical to perform in multimaster fashion,
Active Directory also uses single-master replication. Here, one or more domain
controllers, designated as operations masters, are assigned to perform operations that are
not permitted to occur at different places on the network at the same time.
Active Directory uses a multimaster approach to provide many performance and
availability benefits. Multimaster replication allows you to update the directory at any
domain controller. That domain controller in turn replicates the changes to other domain
controllers. When you have multiple domain controllers deployed, replication continues
even if any single domain controller fails.

Although Active Directory domains can function with only one domain controller, you
can and should configure multiple domain controllers in your domains. This way, if one
domain controller fails, you can rely on another domain controller to handle
authentication and other critical tasks.
Domain controllers manage all aspects of a user’s interaction with Active Directory
domains. They validate user logon attempts, locate objects, and much more. Within Active
Directory, directory information is logically partitioned. Each domain controller stores a
copy of all pertinent partitions. The pertinent partitions for a particular domain controller
are determined by where the domain controller is located and how the domain controller is
used.
Domain controllers manage changes for information they store and replicate changes to
other domain controllers as appropriate. Because of how replication works, a conflict can
occur if an attribute is modified on a domain controller, because a change to the same
attribute on another domain controller is propagated. Active Directory resolves the
conflict by comparing each attribute’s property version number (a value initialized when
an attribute is created and updated each time an attribute is changed) and replicating the
changed attribute with the higher property version number.
Normally domain controllers are readable and writeable. However, Windows Server 2012,
Windows Server 2012 R2 and later also support read-only domain controllers. A read-only
domain controller (RODC) is a domain controller that hosts a read-only replica of a
domain’s directory. By default, RODCs store no passwords or credentials besides those
used for their own computer account and the Kerberos Ticket Granting Target (krbtgt)
account. This makes RODCs ideal for branch offices where a domain controller’s physical
security cannot be guaranteed.
Figure 1-5 shows an RODC deployed to a branch office. Here the main office has multiple
domain controllers with writeable data. The branch office has an RODC with read-only
data. The RODC is placed at the branch office because the physical security of the server
cannot be guaranteed.
Figure 1-5 A read-only domain controller deployed to a branch office.

Tip  Except for passwords, RODCs store the same objects and attributes as
writeable domain controllers. These objects and attributes are replicated to RODCs
by using unidirectional replication from a writeable domain controller that acts as a
replication partner. Keep in mind that RODCs can pull updates of the domain
partition only from a writeable domain controller running Windows Server 2008 or
later in the same domain.
RODCs pull user and computer credentials from a writeable domain controller running
Windows Server 2008 or later. Then, if allowed by the Password Replication Policy that is
enforced on the writeable domain controller, RODCs cache credentials as necessary until
the credentials change. Because only subsets of credentials are stored on RODCs, the
credentials that can possibly be compromised are limited.


Active Directory Objects
Resources that you want to represent in Active Directory are created and stored as objects.
Objects have attributes that define the kinds of information you want to store about
resources. For example, the User object in Active Directory has attributes that help
describe users, including first name, middle initial, last name, and display name. The
Computer object in Active Directory has attributes that help describe computers, such as
the computer’s name, description, location, and security identifier.
Objects in the directory are either leaf objects or container objects. Objects that can’t
contain other objects are leaf objects, or simply leafs. Objects that hold other objects are
referred to as container objects, or simply containers. The directory itself is a container
that contains other containers and objects. In Figure 1-6, the Users object is a container
that contains User objects, the Computers object is a container that contains Computer
objects, and the Printers object is a container that contains Printer objects.
Each object created within the directory is of a particular class. The Active Directory
schema defines the available object classes and provides rules that determine how you can
create and use objects. Available object classes include User, Group, Computer, and
Printer.
Figure 1-6 Objects and attributes in Active Directory.

Active Directory Schema
Essentially, the schema is a list of definitions that determines object classes and the types
of information about the object classes that can be stored in the directory. The schema
definitions themselves are stored as one of two types of objects:
Schema class objects, or simply schema classes
Schema attribute objects, or simply schema attributes
As shown in Figure 1-7, schema class objects and attribute objects are defined separately
in the directory. You can refer to both sets of objects collectively as schema objects.
Figure 1-7 Objects within a schema.
Schema class objects describe the objects you can create. They function as templates for
creating new objects. Within a particular schema class, the schema attributes store the
information that describes related objects. For example, the User, Group, Computer, and
Printer classes are composed of many schema attributes. The User class has attributes that
describe users. The Group class has attributes that describe groups of users. The Computer
class has attributes that describe computers. The Printer class has attributes that describe
printers.
Tip  Each schema attribute is defined only once and can be used in multiple
schema classes. For example, the Description attribute is defined only once in the
schema but is used in the User, Group, Computer, and Printer classes as well as
other classes.
A core set of schema classes and attributes is included with Active Directory. Because the
directory is extensible, other application and server products can dynamically extend the
schema. For example, when you install Microsoft Exchange Server in the enterprise,

Exchange Server extension classes and attributes are added to the directory. Any new
extensions to the directory are replicated automatically as appropriate.
Note  Experienced developers and administrators can extend the schema as well.
However, extending the schema is an advanced procedure that should be planned
and tested carefully before it is implemented. Also, keep in mind that once defined,
the extended schema classes and attributes can be deactivated but cannot be deleted.
You cannot deactivate or delete schema objects that are part of the default schema
that ships with Active Directory.

Active Directory Components
You can use a variety of Active Directory components to define the structure of the
directory. These components are organized into physical and logical layers. Physical layer
components control how directory information is structured and stored. Logical layer
components control how users and administrators see information in the directory and also
control access to that information. The physical and logical layers are completely separate.
Physical Components
The physical components of Active Directory are sites and subnets. A site is a
combination of one or more IP subnets connected by highly reliable links. A subnet is a
group of network IP addresses. You use sites and subnets to create a directory structure
that mirrors the physical structure of your organization.
You use sites to map your network’s physical structure. As shown in Figure 1-8, a site
typically has the same boundaries as your local area networks (LANs). Because site
mappings are separate and independent from logical components in the directory, there’s
no necessary relationship between your network’s physical structures and the logical
structures in the directory.
Figure 1-8 Mapping sites to network structure.
Whereas sites can be associated with multiple IP address ranges, each subnet has a
specific IP address range. Subnet names are shown in the form network/bits-masked, such
as 10.1.11.0/24. Here, the network address 10.1.11.0 and network mask 255.255.255.0 are
combined to create the subnet name 10.1.11.0/24. Figure 1-9 shows the related subnets for
several LANs. Each LAN is associated with two subnets. For example, the St. Paul
network is associated with the 10.1.11.0/24 subnet and the 10.1.12.0/24 subnet.

Figure 1-9 LANs within a WAN and their related subnets.
Ideally, when you group subnets into sites, you should ensure that all subnets are well
connected. Well connected means that the subnets are connected by reliable, fast
connections. Generally, fast network connections are at least 512 kilobits per second
(Kbps). To also be reliable, the network connections must always be active, and there must
be available bandwidth for directory communications above the normal network traffic
load.
In Figure 1-10, the Detroit and St. Louis networks are connected to the Chicago network
using a 512 Kbps connection and therefore are considered to be well connected. Because
of this, all three networks can be part of the same site. On the other hand, the St. Paul
network is connected to the Chicago network with a 256 Kbps connection and to the St.
Louis network with a 128 Kbps connection. Because of this, the St. Paul network is not
considered well connected and should not be part of a site that includes the other
networks.
Figure 1-10 LANs within a WAN and the related connection speeds.

When you browse Active Directory, you see the logical components rather than the
physical components. The reason for this is that sites and subnets are not part of the
normal Active Directory namespace. Sites contain only computer objects and connection
objects. These objects are used to configure replication between sites. Computers are
assigned to sites based on their location in a subnet or a set of subnets.
As an administrator, you must create sites and subnets as appropriate for your
organization. You must place domain controllers within sites to optimize authentication
and replication.
Logical Components
The logical components of Active Directory are domains, domain trees, domain forests,
and organizational units (OUs). These components help you organize resources in a
logical structure. This logical structure is what is presented to users.
Domains
Domains are logical groupings of objects that share common directory databases. In the
directory, domains are represented as container objects. Within a domain, you can create
accounts for users, groups, and computers as well as for shared resources such as printers
and folders.
In Figure 1-11, a domain object is represented by a large triangle, and the objects it
contains are shown within it.
Figure 1-11 An Active Directory domain.
A domain can store millions of objects and is the parent object of all objects it stores.
Keep in mind, however, that a domain stores information only about the objects it contains
and that access to domain objects is controlled by security permissions. The security
permissions assigned to an object determine which users can gain access to an object and
what type of access any particular user has.
The directory can contain one domain or many domains. Each domain name must be

unique. If the domain is part of a private network, the name assigned to a new domain
must not conflict with any existing domain name on the private network. If the domain is
part of the public Internet, the name assigned to a new domain must not conflict with any
existing domain name throughout the Internet. Because of this, you must register public
domain names through a designated registrar before using them. You can find a current list
of designated registrars at InterNIC (http://www.internic.net).
Because a domain can span more than one physical location, a domain can span one or
more sites. A single site also can include resources from multiple domains. Each domain
has its own security policies and settings.
Domain functions are limited and controlled by the domain functional level. Several
domain functional levels are available, including the following:
Windows Server 2008 Supports domain controllers running Windows Server
2008 and later.
Windows Server 2008 R2 Supports domain controllers running Windows
Server 2008 R2 and later.
Windows Server 2012 Supports domain controllers running Windows Server
2012 and later.
Windows Server 2012 R2 Supports domain controllers running Windows
Server 2012 R2 and later.
You set the domain functional level when you install the first domain controller in a new
domain. Generally, once you raise the domain functional level, you cannot lower the
domain functional level. However, there are exceptions. For further discussion of domain
functional levels, see the section titled “Establishing Functional Levels” in Chapter 2,
“Installing New Forests, Domain Trees, and Child Domains.”
Trees
Although domains are important building blocks for implementing Active Directory
structures, they are not the only building blocks. Other important building blocks are
domain trees. Domain trees are logical groupings of domains.
Note  Within the directory, the tree structure represents a hierarchy of objects,
showing the parent-child relationships between the objects. The domain at the top of
the tree is the root domain. The root domain is the first domain created in a new
directory tree, and it is the parent of all other domains for that particular domain
tree. Other domains that you create in the domain tree are child domains.
As an administrator, you create domain trees to reflect your organization’s structure.
Domains in a tree share a contiguous namespace. The domain name of a child domain is
the relative name of the child name appended to the name of the parent domain.
In Figure 1-12, imaginedlands.com is the parent of tech.imaginedlands.com and
sales.imaginedlands.com. The tech.imaginedlands.com domain has related subdomains:
eng.tech.imaginedlands.com and dev.tech.imaginedlands.com. This makes
tech.imaginedlands.com the parent of the child domains eng.tech.imaginedlands.com and
dev.tech.imaginedlands.com.

Figure 1-12 A domain tree.
Forests
Domain forests are logical groups of domain trees. Domain trees in a domain forest are
separate and independent. As such, domain trees that are members of a forest do not share
a contiguous namespace. In fact, when you add a new domain to Active Directory that is
part of a different namespace, the domain is added as part of a new tree in the forest. For
example, if Active Directory has a single tree as shown in Figure 1-12, and you add the
domain reagentpress.com to the directory, the domain is added as part of a new tree in the
forest, as shown in Figure 1-13. This domain becomes the root domain for the new tree.
Figure 1-13 A domain forest with two domain trees.
As an administrator, you create domain forests to reflect your organization’s structure.
Domains in a forest operate independently but share a common schema. The forest
enables communication across member domains. Like domain trees, domain forests have

root domains. The first domain created in a new forest is the forest root domain. The first
domain created in any additional tree within the forest is the root domain only for the
additional tree. In Figure 1-14, imaginedlands.com and reagentpress.com are the root
domains for their respective domain trees, but because imaginedlands.com was the first
root domain created, it is the forest root domain.
Figure 1-14 An extended domain environment.
Tip  Domains in a forest are connected through implicit two-way transitive trusts.
A trust is a link between two domains in which one domain (referred to as the
trusting domain) honors the logon authentication of another domain (referred to as
the trusted domain). Trusts join parent and child domains in the same domain tree
and join the roots of domain trees. The default protocol used for trusts is Kerberos
version 5. For more information, see Chapter 8, “Managing Trusts and
Authentication.”
Forest functions are limited and controlled by the forest functional level. Several forest
functional levels are available, including:
Windows Server 2008 Supports domain controllers running Windows Server
2008 and later. When all domains within a forest are operating in this mode, you
see improvements in both intersite and intrasite replication throughout the
organization. Windows Server 2008 security principals are not created until the
primary domain controller (PDC) emulator operations master in the forest root
domain is running Windows Server 2008.
Windows Server 2008 R2 Supports domain controllers running Windows
Server 2008 R2 and later. When a forest is operating at this level and using
domain controllers running Windows Server 2008 R2 and later, domain controllers
support several functionality and performance enhancements specific to the R2
release, including Active Directory Recycle Bin, managed service accounts,
managed virtual accounts, and Authentication Mechanism Assurance. Other
improvements don’t require that you raise functional levels but they do require
using Windows Server 2008 R2 and later. These improvements include offline
domain join, Active Directory module for Windows PowerShell, Active Directory
Administrative Center, and Active Directory Web Services.
Windows Server 2012 Supports domain controllers running Windows Server
2012 and later. When a forest is operating at this level and using domain

controllers running Windows Server 2012 and later, domain controllers are able to
use the minor functionality and schema improvements provided. Kerberos with
Armoring requires updating schema for Windows Server 2012 but does not
require this forest functional level. Other improvements don’t require that you
raise functional levels but they do require using Windows Server 2012 and later.
These improvements include Active Directory-based activation, claims-based
policy controls, deferred index creation, group managed service accounts,
Kerberos constrained delegation across domains, Kerberos with Armoring, and
off-premises domain join. Although these enhancements don’t require the
Windows Server 2012 forest functional level, they do require using Windows
Server 2012 and later.
Windows Server 2012 R2 Supports domain controllers running Windows
Server 2012 R2 and later. When a forest is operating at this level and using
domain controllers running Windows Server 2012 R2 and later, domain controllers
are able to use the minor functionality and schema improvements provided.
Windows Server 2012 R2 also has several enhancements for Active Directory,
including Authentication policies and Protected Users. Both of these
enhancements require raising the domain functional level to at least the Windows
Server 2012 R2.
Organizational Units
Organizational units (OUs) are logical containers used to organize objects within a
domain. Because OUs are the smallest scope to which you can delegate authority, you can
use OUs to help manage administration of accounts for users, groups, and computers and
for administration of other resources such as printers and shared folders.
By adding OUs to other OUs, you can create a hierarchy within a domain. Because every
domain in a domain forest has its own OU hierarchy, the OU hierarchy of a domain is
independent from that of other domains.
Ideally, you create OUs to make administration easier. You can use OUs to:
Reflect the way resources and accounts are managed.
Reflect the department structure within the organization.
Reflect the geographic locations for business units.
Reflect cost centers within the organization.
Following this, you might create OUs for each division or business unit within the
organization. This would allow you to delegate authority to unit-level administrators who
would have permissions to manage accounts and resources only within a particular
business unit. If a unit-level administrator later needs permissions in another business unit,
you can grant the administrator the appropriate permissions for the additional OU.
By default, all child OUs inherit permissions from parent OUs. Because of this, an
administrator who has permissions for a parent OU can also manage the accounts and
resources of any child OUs of that parent. For example, if North America is the parent OU
and the child OUs are United States and Canada, an administrator who has permissions for
North America would by default also have permissions for United States and Canada.

Figure 1-15 Organizational units within a domain.
In Figure 1-15, the imaginedlands.com domain uses the organization of a sales and
services company with global operations in North America, Europe, and South America.
Sales and Services are top-level OUs. Sales has three nested OUs: NA, Europe, and SA.
Services has three nested OUs: NA, Europe, and SA. In this environment, administrators
can have several levels of responsibility.
Domain administrators have permissions for the domain and all OUs. Administrators for
the Sales OU have permissions for the Sales OU and its nested OUs but do not have
permissions for the domain, the Services OU, or any OUs nested within the Services OU.
Within the Sales OU, subadministrators for NA, Europe, or SA have permissions only for
that OU.


Managing Active Directory
Administrators spend a lot of time managing Active Directory. I discuss basic tools and
techniques in this section.

Working with Active Directory
When you establish domains and forests by installing domain controllers, Active
Directory creates default user accounts and groups to help you manage the directory and
configure access controls. Important default users and groups include:
Administrator A default user account with domainwide access and privileges.
By default, the Administrator account for a domain is a member of these groups:
Administrators, Domain Admins, Domain Users, Enterprise Admins, Group
Policy Creator Owners, and Schema Admins.
Administrators A local group that provides full administrative access to an
individual computer or a single domain, depending on its location. Because this
group has complete access, you should be very careful about adding users to it. To
make someone an administrator for a local computer or domain, all you need to do
is make that person a member of this group. Only members of the Administrators
group can modify this account. Default members of this group include
Administrator, Domain Admins, and Enterprise Admins.
Domain Admins A global group designed to help you administer all the
computers in a domain. Members of this group have administrative control over
all computers in a domain because they are members of the Administrators group
by default. To make someone an administrator for a domain, make that person a
member of this group.
Enterprise Admins A global or universal group designed to help you administer
all the computers in a domain tree or forest. Members of this group have
administrative control over all computers in the enterprise because the group is a
member of the Administrators group by default. To make someone an
administrator for the enterprise, make that person a member of this group.
Group Policy Creator Owners A global group designed to help you administer
group policies. Members of this group have administrative control over Group
Policy.
Protected Users A global group designed to be used in conjunction with
authentication policies. Membership in this group ensures that only Kerberos can
be used for authentication. (Only available with Windows Server 2012 R2 and
later.)
Schema Admins A global group designed to help you administer Active
Directory schema. Members of this group have administrative control over
schema.
Whenever you work with Active Directory, be sure that you are using a user account that
is a member of the appropriate group or groups.

Active Directory Administration Tools
You can manage Active Directory by using both graphical administration tools and
command-line tools. The graphical tools are the easiest to work with, but if you master the
command-line tools, you will often be able to accomplish tasks more quickly. When you
use the command-line tools with the Task Scheduler, you might even be able to automate
routine tasks.
Graphical Administration Tools
The graphical administration tools for working with Active Directory are provided as
snap-ins for the Microsoft Management Console (MMC). You can access these tools
directly on the Tools menu in Server Manager, or add them to any updateable MMC. If
you’re using another computer with access to a Windows Server domain, the tools won’t
be available until you install them. One technique for installing these tools is to use the
Add Roles And Features option on the Tools menu in Server Manager.
Graphical tools you can use to manage Active Directory include:
Active Directory Domains And Trusts Used to manage and maintain domains,
domain trees, and domain forests. See Figure 1-16.
FIGURE 1-16 Active Directory Domains And Trusts.
Active Directory Sites And Services Used to manage and maintain sites and
subnets. See Figure 1-17.
FIGURE 1-17 Active Directory Sites And Services.

Active Directory Users And Computers Used to manage and maintain
accounts for users, groups, and computers. Also used to manage and maintain
OUs. See Figure 1-18.
FIGURE 1-18 Active Directory Users And Computers.
Active Directory Schema Used to view and manage the schema in Active
Directory. You work with object classes and attributes separately. See Figure 1-19.
FIGURE 1-19 Active Directory Schema.

ADSI Edit Used to edit the ADSI (Active Directory Service Interfaces). This
low-level editor lets you manipulate objects and their attributes directly. See
Figure 1-20.
FIGURE 1-20 ADSI Edit.
Tip  ADSI Edit is a snap-in you can add to any Microsoft Management Console
(MMC). Open a new MMC by entering MMC in the Everywhere Search box and
then clicking the mmc entry in the search results. Next, use the Add/Remove Snap-
in option on the File menu to add the ADSI Edit snap-in to the MMC.
Active Directory Administrative Center also is available. Active Directory Administrative
Center allows you to perform common Active Directory administrative tasks using an
integrated console. Behind the scenes, the console uses PowerShell cmdlets to handle the
administrative tasks. The same cmdlets that the console uses are available for your use at a
Windows PowerShell prompt.
Although each tool has a different purpose, you can perform some common editing tasks
using similar techniques. You can:
Drag resources to new locations by selecting the objects you want to move and
then pressing and holding down the left mouse button while moving the mouse.
Edit and set properties of multiple resources by selecting the objects you want to
work with, right-clicking, and then selecting the operation, such as Add To Group,
Disable Account, or Properties.
Select a series of resources at once by holding down the Shift key, selecting the
first object, and then clicking the last object.
Select multiple resources individually by holding down the Ctrl key and then
clicking the left mouse button on each object you want to select.
Tip  Windows Firewall can affect remote administration with some MMC tools. If
Windows Firewall is enabled on a remote computer and you receive an error
message stating that you don’t have appropriate rights, the network path isn’t found,
or access is denied, you might need to configure an exception on the remote
computer for incoming Transmission Control Protocol (TCP) port 445. To resolve
this problem, you can enable the Windows Firewall: Allow Remote Administration
Exception policy setting within Computer Configuration\Administrative
Templates\Network\Network Connections\Windows Firewall\Domain Profile. For

more information, see Microsoft Knowledge Base Article 840634
(http://support.microsoft.com/default.aspx?scid=kb;en-us;840634).
Command-Line Tools
You also can manage Active Directory from the command line. Command-line tools you
can use include:
ADPREP Used to prepare a forest or domain for installation of domain
controllers. Use adprep /forestprep and adprep /domainprep to prepare a forest
or a domain, respectively. Use adprep /domainprep /gpprep to prepare Group
Policy for the domain.
DSADD Used to add computers, contacts, groups, organizational units, and
users to Active Directory. Enter dsadd objectname /? at the command line to
display Help information on using the command, such as dsadd computer /?.
DSGET Used to display properties of computers, contacts, groups,
organizational units, users, sites, subnets, and servers registered in Active
Directory. Enter dsget objectname /? at the command line to display Help
information on using the command, such as dsget subnet /?.
DSMOD Used to modify properties of computers, contacts, groups,
organizational units, users, and servers that already exist in Active Directory.
Enter dsmod objectname /? at the command line to display Help information on
using the command, such as dsmod server /?.
DSMOVE Used to move a single object to a new location within a single
domain or to rename the object without moving it. Enter dsmove /? at the
command line to display Help information on using the command.
DSQUERY Used to find computers, contacts, groups, organizational units,
users, sites, subnets, and servers in Active Directory using search criteria. Enter
dsquery /? at the command line to display Help information on using the
command.
DSRM Used to remove objects from Active Directory. Enter dsrm /? at the
command line to display Help information on using the command.
NETDOM Used to manage domain and trust relationships from the command
line.
NTDSUTIL Used to view site, domain, and server information; manage
operations masters; and perform database maintenance of Active Directory. Enter
ntdsutil /? at the command line to display Help information on using the
command.
REPADMIN Used to manage and monitor replication using the command line.


Chapter 2. Installing New Forests,
Domain Trees, and Child Domains
Whether you are implementing Active Directory Domain Services (AD DS) for the first
time or extending your existing Active Directory infrastructure, you should begin with a
detailed design plan. At a minimum, your plan should list any prerequisites, necessary
postinstallation changes, and overall impact on your network. Once you complete your
planning, you will be ready to modify your infrastructure as discussed in this chapter.
To ensure your success, you must familiarize yourself with the various installation and
removal methods available so that you can choose the method or methods that best meet
your needs in a particular situation. For example, when you are working with a Server
Core installation of Windows Server, you install from the command line or an answer file
instead of using the graphical interface. The command line and answer file options are
very different from the graphical interface options.
Verifying your work is a key part of the process as well. You’ll need to ensure the
installation or modification turned out the way you intended. If necessary, you must be
able to use the available tools to troubleshoot problems you encounter.


Preparing for Active Directory Installation
Preparing for your Active Directory implementation or modification is essential. When
you are adding domain controllers to install a new forest, domain tree, or domain, there
are some initial decisions you’ll have to make. The same is true when you are adding or
removing domain controllers within existing domain structures.

Working with Directory Containers and Partitions
In the Active Directory database, stored data is represented logically using objects. Every
object in the directory has a name relative to the parent container in which it is stored.
This relative name, which is simply the name of the object, is referred to as an object’s
common name (CN) and is stored as an attribute of the object. Because this name must be
unique for the container in which it is located, no two objects in a container can have the
same common name. However, two objects in different containers could have the same
common name. In this case, the CN of the two objects would be the same within their
respective domains, but the complete name in the directory would be different. Why?
Because in addition to a common name, directory objects also have a distinguished name
(DN).
An object’s DN describes the object’s place in the directory tree, from the highest
container of which it is a member to the lowest. As the name implies, DNs are used to
distinguish like-named objects. No two objects in the directory can have the same
distinguished name.
The root of the directory tree is referred to as the rootDSE. The rootDSE represents the top
of the logical namespace for a directory. Although the rootDSE itself has no parent, all
other objects in the directory have a parent. Because it specifically relates to the domain
controller on which the directory is stored, the rootDSE will have a slightly different
representation on each domain controller in a domain. Below the rootDSE, every directory
tree has a root domain. The root domain is the first domain created in a forest and is also
referred to as the forest root domain. After you establish the forest root domain, the root
never changes, even if you add new trees to the forest.
When you install Active Directory on the first domain controller in a new forest, three
containers are created below the rootDSE:
Forest Root Domain container, which is the container for the objects in the forest
root domain
Configuration container, which is the container for the default configuration and
all policy information
Schema container, which is the container for all objects, classes, attributes, and
syntaxes
Active Directory uses object names to group objects into logical categories that can be
managed and replicated as appropriate. The largest logical category is a directory partition.
All directory partitions are created as instances of the domainDNS object class. The Forest
Root Domain container, the Configuration container, and the Schema container each exist
in separate Active Directory partitions.
Within Active Directory, domains themselves are simply containers of objects that are
logically partitioned from other container objects. When you create a new domain in
Active Directory, you create a new container object in the directory tree, and that container
is in turn contained by a domain directory partition for the purposes of management and
replication.
Logically apportioning data using partitions simplifies the process of distributing

forestwide, domainwide, and application-specific data. Forestwide data is replicated to
every domain controller in a forest. Domainwide data is replicated to every domain
controller in a particular domain. Application-specific data is replicated to domain
controllers that maintain a particular application partition. For example, when you
integrate Active Directory with Domain Name System (DNS), domain controllers that are
also DNS servers will have the default application partitions used with your DNS zones.
When you need to make changes to Active Directory, you can do so on any domain
controller, and you can rely on the Active Directory built-in replication engine to replicate
the changes to other domain controllers as appropriate. You can do this because every
domain controller deployed in the organization is autonomous, with its own copy of the
directory.
At a minimum, every domain controller stores:
The domain directory partition for the domain of which it is a member
The schema partition for the forest of which it is a member
The configuration partition for the forest of which it is a member
Data in a domain directory partition is replicated to every domain controller in the domain
as a writeable replica. Forestwide data partitions are replicated to every domain controller
in the forest. The configuration partition is replicated as a writeable replica. The schema
partition is replicated as a read-only replica, and the only writeable replica is stored on a
domain controller that is designated as having the schema operations master role. Other
operations master roles are defined as well.
In addition to full replicas that are distributed within domains, Active Directory distributes
partial replicas of every domain in the forest to special domain controllers designated as
global catalog servers. The partial replicas stored on global catalog servers contain
information on every object in the forest and are used to facilitate searches and queries for
objects in the forest. Because only a subset of an object’s attributes is stored, the amount
of data replicated to and maintained by a global catalog server is significantly smaller than
the total size of all object data stored in all the domains in the forest.

Establishing or Modifying Your Directory Infrastructure
You install new forests, domain trees, and domains by installing domain controllers in the
desired namespace. Whether you are planning to establish or modify your organization’s
Active Directory infrastructure, there are some initial decisions you’ll have to make. The
same is true when you are adding or removing domain controllers within existing domain
structures. Start by reviewing your organization’s Active Directory infrastructure plan
with regard to:
Forests and domains
Organizational units (OUs)
Sites and subnets
Regarding forests and domains, it is important to keep in mind how trusts work. A trust is
a link between two domains, in which one domain (referred to as the trusting domain)
honors the logon authentication of another domain (referred to as the trusted domain).
Within a forest, two-way, implicit trusts join parent and child domains in the same domain
tree and join the roots of domain trees. Between forests, no default trusts exist. Every
forest is separate and distinct from every other forest by default, and you must explicitly
establish trusts between forests.
You’ll want to try to limit your Active Directory infrastructure to one forest. Otherwise,
you’ll have to maintain multiple schemas, configuration containers, global catalogs, and
trusts, and users will have additional required steps when working with the directory.
However, you might need multiple forests when your organization has autonomous
business units; when you need to isolate the schema, configuration container, or global
catalog; or when there is a need to limit the scope of trust relationships within the
organization. For example, you might want the members of your research and
development unit to be able to access resources in other business units but not want to
allow anyone outside the research and development unit to access its resources.
In some situations, you might not have control over whether your organization has
multiple forests. For example, as the result of a merger or acquisition, your organization
might gain one or more new forests. In this case, you’ll probably need to configure the
forests to work with each other by establishing the appropriate trust relationships between
the forests.
With multiple forests, you no longer have a single top-level unit for sharing and managing
resources. You have separate structures that are autonomous and isolated from one
another. By default, forests do not share schema, configuration information, trusts, global
catalogs, or forestwide administrators.
You can join forests using cross-forest trusts. Unlike interforest trusts, which are two way
and transitive by default, cross-forest trusts are either two way or one way. With a two-
way trust, users in either forest have access to resources in the other forest. With a one-
way trust, users in one forest have access to resources in the other forest but not vice
versa.
When you’re establishing a new forest, the first domain you install becomes the forest root
domain. The forest root domain can be either a nondedicated root or a dedicated root. A

nondedicated root is used as a normal part of the directory. It has user and group accounts
associated with it and is used to assign access to resources. A dedicated root, also referred
to as an empty root, is used as a placeholder to establish the directory base. No user or
group accounts are associated with it other than accounts created when the forest root is
installed and accounts that are needed to manage the forest. Because no additional user or
group accounts are associated with it, a dedicated root domain is not used to assign access
to resources.
When you plan to have multiple domains, using a dedicated root domain makes sense. An
empty root is easier to manage than a root domain that contains user accounts and
resources. It allows you to separate the root domain from the rest of the forest. This is
important because the forest root domain cannot be replaced. If the root domain is
destroyed and cannot be recovered, you must re-create the entire forest.
Tip  The forest root domain contains the forestwide administrator accounts
(Enterprise Admins and Schema Admins) and the forestwide operations masters
(domain naming master and schema master). It must be available when users log on
to domains other than their home domain and when users access resources in other
domains.
Within a forest, you define a domain hierarchy by determining the number of domain
trees, designating tree root domains, and defining the hierarchy of any required
subdomains. You name domains by assigning a DNS name to the forest root domain of
each forest, to the tree root domain of each tree, and to each remaining subdomain. Once
you create a domain and establish a new namespace, you cannot easily restructure or
rename it.
Real World  Using the Domain Rename utility (Rendom.exe), which is now
included with Windows Server, you can rename domains. However, you cannot use
the Domain Rename utility to change which domain is the forest root domain.
Although you can change the name of the forest root domain so that it is no longer
the forest root logically, the domain remains the forest root domain physically in
Active Directory.
Before adding a domain tree or child domain to an existing forest, you’ll want to consider
the increased overhead and hardware costs. The reason for using multiple domains should
not be based solely on the number of users, groups, and other objects. Although the
number of objects is a factor to consider from a manageability standpoint, a single domain
can have millions of objects.
To ensure availability and allow for disaster recovery, every domain should have two or
more domain controllers. Some reasons you might want to create additional domains are
to:
Establish distinct namespaces.
Optimize replication traffic.
Meet special security or administrative requirements.
Regardless of whether your forest uses a single namespace or multiple namespaces,
additional domains in the same forest have the following characteristics:

Share common forestwide administrators All domains in the forest have the
same top-level administrators: Enterprise Admins, who are the only administrators
with forestwide privileges; and Schema Admins, who are the only administrators
with the right to modify the schema.
Share a common global catalog All domains in the forest have the same global
catalog, and it stores a partial replica of all objects in the forest.
Share a common trust configuration All domains in the forest are configured
to trust all the other domains in the forest, and the trust is two way and transitive.
Share a common schema All domain controllers in the forest have the same
schema, and a single schema master is designated for the forest.
Share a common configuration directory partition All domain controllers
share the same configuration container, and it stores the default configuration and
policy information.
With multiple locations, domain changes need to be replicated to all domain controllers,
and geographic separation is often a deciding factor. Primarily, this is because there is less
replication traffic between domains than within domains (relatively speaking). Therefore,
if business locations are geographically separated, it makes sense to limit the replication
traffic between locations if possible, and one way to do this is to create multiple domains.
Even within a single business location, the need to limit replication traffic can be a
deciding factor for using multiple domains. For example, a large organization with users
in multiple buildings in a campus setting may find that the connection speed between
locations isn’t adequate, and it may be necessary to use multiple domains to limit
replication traffic.
As part of establishing forest and domain structures, you’ll also have to determine the
placement of DNS servers. To ensure proper name resolution, your Active Directory forest
will need to have authoritative DNS servers for each domain. If you allow DNS to be
configured automatically when you install Active Directory, the new domain controller is
automatically set to meet the DNS requirements for joining Active Directory. However, if
you installed DNS manually or if your architecture doesn’t allow dynamic DNS updates,
you’ll need to:
Ensure the _ldap._tcp.dc._msdcs.DNSDomainName (SRV) resource record exists
in DNS, where DNSDomainName is the DNS name of the Active Directory
domain.
Ensure a host (A) resource record for the DNS name of the domain controllers is
specified in the data field of the SRV resource record.
Before you install Active Directory, you should ensure the server has a static IP address. If
DNS is already set up and the server won’t also act as a DNS server, you’ll want to
designate preferred and alternate DNS servers. If the domain controller will also act as a
DNS server, you can set the preferred DNS server to the local loopback address 127.0.0.1
and remove any alternate DNS server (or allow the setup process to do this for you when
you install Active Directory).
After reviewing your organization’s forest and domain plans, you should review your
organizational unit (OU) plan. Within domains, you use OUs to help manage

administration of accounts for users, groups, and computers and for administration of
other resources such as printers and shared folders. The result of your planning should be
a diagram of OU structures for each domain and a list of user groups in each OU.
In a manner similar to the way you use OUs to group users and resources, you use sites to
group computers. However, whereas forests, domains, and OUs are logical groupings,
sites are physical groupings. Sites reflect the physical structure of your organization’s
network and are used to optimize network traffic. You define a site for each LAN or set of
LANs connected by a high-speed backbone. Any location that is not well connected or is
reachable only by SMTP e-mail should be in its own site.
Tip  As you design your sites, you also want to determine how other network
resources fit into this architecture. You should design sites with Domain Name
System (DNS), Dynamic Host Configuration Protocol (DHCP), Distributed File
System (DFS) file shares, certificate authorities, Microsoft Exchange servers, and
other essential services in mind. Ideally, you want to configure sites so that client
queries for a particular network resource can be answered within the site. If every
client query for a network resource has to be sent to a remote site, there could be
substantial network traffic between sites, which could be a problem over slow WAN
links. However, the ideal configuration isn’t always possible or practical, and you’ll
need to carefully evaluate the placement of each resource separately.
Within sites, you’ll want to place domain controllers strategically because the availability
of Active Directory depends on the availability of domain controllers. A domain controller
must always be available so users can be authenticated. For optimum availability and
response time, you’ll want to ensure the following:
Each site has at least one domain controller.
Each domain has at least two domain controllers.
Because replication between sites occurs over site links, you’ll want to ensure site links
are configured properly. An effective strategy ensures efficient replication and fault
tolerance. If a link to a site is unreliable, intermittent, or saturated, you’ll want to consider
placing additional domain controllers in the site.
Every domain must have at least one global catalog server. By default, the first domain
controller installed in a domain is set as that domain’s global catalog server. You can
change the global catalog server, and you can designate additional servers as global
catalog servers as necessary.
When you are configuring sites, designate global catalog servers as necessary to
accommodate forestwide directory searching and to facilitate domain client logons when
universal groups are available. When universal groups are available in a domain, a domain
controller must be able to locate a global catalog server to process a logon request.
For remote locations, you should determine whether read-only domain controllers
(RODCs) are appropriate. Additionally, if the wide area network (WAN) link between the
remote site and the hub site is limited, you can use universal group membership caching in
the remote site to accommodate the logon needs of users in the site. Do not place the
global catalog on a domain controller that hosts the infrastructure operations master role in
the domain (unless all domain controllers in the domain are global catalog servers or the

forest has only one domain).

Establishing Functional Levels
Functional levels affect the inner workings of Active Directory and are used to enable
features that are compatible with the installed server versions of the Windows operating
system. Each forest and each domain within a forest can be assigned a functional level.
The functional level for a domain within a forest is referred to as the domain functional
level. When you set a domain’s functional level, the level of functionality applies only to
that domain. Other domains in the forest can have a different functional level.
Domain functional levels available include:
Windows Server 2008 mode Supports domain controllers running Windows
Server 2008 and later. Also supports additional Active Directory features,
including Distributed File System Replication for SYSVOL, Advanced
Encryption Standard (AES), last interactive logon, and fine-grained passwords.
Windows Server 2008 R2 mode Supports domain controllers running Windows
Server 2008 R2 and later. Also supports additional Active Directory features,
including Active Directory Recycle Bin, managed service accounts, managed
virtual accounts, and Authentication Mechanism Assurance.
Windows Server 2012 mode Supports domain controllers running Windows
Server 2012 and later. Also supports Active Directory-based activation, claims-
based policy controls, deferred index creation, group managed service accounts,
Kerberos constrained delegation across domains, Kerberos with Armoring, and
off-premises domain join. Although these features don’t require the Windows
Server 2012 domain functional level, they do require using Windows Server 2012
and later.
Windows Server 2012 R2 mode Supports domain controllers running Windows
Server 2012 R2 and later. Also supports Authentication policies and Protected
Users. Both of these enhancements require raising the domain functional level to
at least the Windows Server 2012 R2.
Raising the functional level changes the operating systems that are supported for domain
controllers and supported Active Directory features. Generally, once you raise the domain
functional level, you cannot lower it. However, there are exceptions. When you are
working with Windows Server 2012 as the domain functional level, you can lower the
domain functional level to Windows Server 2008 R2. When you are working with
Windows Server 2012 R2 as the domain functional level, you can lower the domain
functional level to Windows Server 2012 or Windows Server 2008 R2.
If Active Directory Recycle Bin has not been enabled, you have additional options. You
can lower the domain functional level from Windows Server 2012 R2 to Windows Server
2012, Windows Server 2008 R2, or Windows Server 2008. You can lower the domain
functional level from Windows Server 2012 to Windows Server 2008 R2 or Windows
Server 2008.
The functional level for a forest is referred to as the forest functional level. Forest
functional levels available include:
Windows Server 2008 Supports domain controllers running Windows Server

2008 and later.
Windows Server 2008 R2 Supports domain controllers running Windows
Server 2008 R2 and later.
Windows Server 2012 Supports domain controllers running Windows Server
2012 and later.
Windows Server 2012 R2 Supports domain controllers running Windows
Server 2012 R2 and later.
As with the domain functional level, once you raise the forest functional level, you
generally cannot lower it. The specific exceptions are as follows: When you raise the
forest functional level to Windows Server 2012, you can lower it to Windows Server 2008
R2. When you raise the forest functional level to Windows Server 2012 R2, you can lower
it to Windows Server 2012 or Windows Server 2008 R2.
As with domain functional levels, if Active Directory Recycle Bin has not been enabled,
you have additional options. You can lower the forest functional level from Windows
Server 2012 R2 to Windows Server 2012, Windows Server 2008 R2, or Windows Server
2008. You can lower the forest functional level from Windows Server 2012 to Windows
Server 2008 R2 or Windows Server 2008.
When you raise the forest functional level, all domains using a lower domain functional
level are automatically raised to the equivalent domain functional level. For example, if
you were to raise the forest functional level to Windows Server 2012 R2, all domains
using a lower domain functional level are automatically raised to the Windows Server
2012 R2 domain functional level. Similarly, when you lower the forest functional level, all
domains using a higher domain functional level must be lowered to the equivalent domain
functional level.
Active Directory Enhancements for Windows Server 2008 and R2
When all domains within a forest are operating in Windows Server 2008 mode or higher,
domain controllers use Distributed File System (DFS) replication. Distributed File System
Replication for SYSVOL provides robust and granular replication of SYSVOL, including
replication of only the changes within files, bandwidth throttling, and improved replication
topology. In addition, Windows Server 2008 security principals are not created until the
primary domain controller (PDC) emulator operations master in the forest root domain is
running Windows Server 2008 or later.
Windows Server 2008 also supports Advanced Encryption Standard (AES), last
interactive logon, and fine-grained passwords. AES support allows user accounts to use
AES 128-bit or AES 256-bit encryption. Last interactive logon information displays the
time of the last successful interactive logon for a user, the number of failed logon attempts
since the last logon, and the time of the last failed logon. Fine-grained password policies
make it possible for password and account lockout policy to be specified for user and
global security groups in a domain.
Active Directory Domain Service in Windows Server 2008 R2 has many features that give
administrators additional options. When you have deployed Windows Server 2008 R2 or
later on all domain controllers throughout the domains in your Active Directory forest,
your domains can operate at the Windows Server 2008 R2 domain functional level, and

the forest can operate at the Windows Server 2008 R2 forest functional level. These
operating levels allow you to take advantage of Active Directory enhancements that
improve manageability, performance, and supportability, including:
Active Directory Recycle Bin Allows administrators to undo the accidental
deletion of Active Directory objects in much the same way as they can recover
deleted files from the Windows Recycle Bin.
Authentication Mechanism Assurance Improves the authentication process by
allowing administrators to control resource access based on whether a user logs on
using a certificate-based logon method. This allows an administrator to specify
that a user has one set of access permissions when logged on using a smart card
and a different set of access permissions when not logged on using a smart card.
Managed service accounts Introduces a special type of domain user account for
managed services that reduces service outages and other issues by having
Windows manage the account password and related Service Principal Names
(SPNs) automatically.
Managed virtual accounts Introduces a special type of local computer account
for managed services that provides the ability to access the network with a
computer identity in a domain environment.
Note Although you can use managed service accounts and managed virtual
accounts in a mixed-mode domain environment, there are several important caveats.
First, you must update the Active Directory schema for Windows Server 2008 R2.
Second, you must manually manage SPNs for managed service accounts.
Other improvements for Windows Server 2008 R2 don’t require that you raise domain or
forest functional levels, but they do require that you use Windows Server 2008 R2. These
improvements include:
Active Directory Administrative Center Provides a task-orientated interface
for managing Active Directory. A related option is on the Tools menu in Server
Manager.
Active Directory module for Windows PowerShell Provides cmdlets for
managing Active Directory when you are working with Windows PowerShell. A
related option is on the Tools menu in Server Manager.
Active Directory Web Services Introduces a Web service interface for Active
Directory domains.
Offline domain join Allows administrators to preprovision computer accounts
in the domain to prepare operating systems for deployment. This allows computers
to join a domain without having to contact a domain controller.
Active Directory Enhancements for Windows Server 2012 and R2
In Windows Server 2012 and Windows Server 2012 R2, there are many additional features
that give administrators more options for implementing and managing Active Directory.
As Table 2-1 shows, these features typically require that you update the Active Directory
schema in your forests and domains for Windows Server 2012 or later. You also might
need to update the domain, forest, or both functional levels to the Windows Server 2012 or
Windows Server 20212 R2 mode.

TABLE 2-1 Key Features in Active Directory for Windows Server 2012 and Windows
Server 2012 R2
Active Directory–based activation
Allows you to use Active Directory to automatically activate clients running
Windows 8, Windows 8.1, Windows Server 2012, and Windows Server 2012 R2.
Any client connected to the service is activated. Requires Volume Licensing.
Active Directory schema must be updated for at least Windows Server 2012.
Key is set using Volume Activation server role or command line.
Authentication policies
Allow you to specify access control conditions that restrict the devices that can
request Kerberos tickets for user, service, and computer accounts. Applies only
to users, computers, managed services accounts, and group managed service
accounts. Accounts must be members of the Protected Users group. Domain
controllers must run Windows Server 2012 R2 or later, and use Windows Server
2012 R2 domain functional level or higher.
Claims-based policy controls
Allow access and audit policies to be defined flexibly. Claims policy must be
enabled for Default Domain Controllers Policy. File servers must run at least
Windows Server 2012. Domain must have at least one domain controller running
Windows Server 2012 or later.
Deferred index creation
Allows deferring of index creation within the directory until UpdateSchemaNow
is received or the domain controller is rebooted. Domain controller must run at
least Windows Server 2012.
Enhanced Fine-Grained Password
Policy
Allows administrators to use Active Directory Administrative Center for
Windows Server 2012 RTM or R2 to create and manage Password Settings
objects (PSOs). Requires Windows Server 2008 or higher domain functional
level.
Enhanced Recycle Bin
Allows administrators to recover deleted objects by using Active Directory
Administrative Center for Windows Server 2012 RTM or R2. Domain must have
Recycle Bin enabled and must use Windows Server 2008 R2 or higher forest
functional level.
Group Managed Service Accounts
Allow multiple services to share a single managed service account. Active
Directory schema must be updated for at least Windows Server 2012.
Additionally, domains must have at least one domain controller running
Windows Server 2012 or later, and services must run on Windows Server 2012
or later.
Kerberos constrained delegation
across domains
Allows managed service accounts to act on behalf of users across domains and
forests. Each affected domain must have at least one domain controller running
Windows Server 2012 or later. Front-end server must run Windows Server 2012
or later.
Kerberos with Armoring

Improves domain security; allows a domain-joined client and domain controller
to communicate over a protected channel. Domain controllers must be running
Windows Server 2012 or later. Domains must use Windows Server 2012 or
higher domain functional level. On clients, you must enable Require FAST
policy. On domain controllers, you must enable Support CBAC And Kerberos
Armoring policy.
Off-premises domain join
Allows a computer to be domain-joined over the Internet. Domains must be
Direct Access–enabled, and domain controllers must run Windows Server 2012
or later.
Protected Users security group
Provides additional protections against authentication threats by requiring
accounts that are members of this group to use only Kerberos for authentication.
Domain controllers must run Windows Server 2012 R2 or later. You must use
Windows Server 2012 R2 domain functional level or higher.
Relative ID (RID) soft ceiling and
warnings
Adds warnings as global RID space is used up. Adds a soft ceiling of 900
million RIDs used that prevents RIDs from being issued until administrator
overrides. A domain controller with RID role must run Windows Server 2012 or
later, and domain controllers must run Windows Server 2012 or later.
Server Manager integration
Allows you to perform all the steps required to deploy local and remote domain
controllers. Requires Windows Server 2012 or later.
Virtual domain controller cloning
Allows you to safely deploy virtualized replicas of domain controllers. Also
helps maintain domain controller state. A domain controller with the PDC
emulator role must run Windows Server 2012 or later, and virtual domain
controllers must also run Windows Server 2012 or later.

Deploying Windows Server 2012 and R2
Before you deploy Windows Server 2012 or Windows Server 2012 R2 for the first time,
there are preparations you must make. First, as Windows Server 2012 and Windows
Server 2012 R2 only run on 64-bit hardware, you should ensure that you have appropriate
server hardware. This server hardware should have a relatively fast processor with
sufficient RAM. Generally, most domain controllers should have enough RAM so that the
entire Active Directory tree can reside in physical memory.
You can run Adprep to prepare the forest schema before you install the first domain
controller that runs Windows Server 2012 or Windows Server 2012 R2. After you prepare
the forest schema, you need to prepare the domain schema for any domain where you plan
to install a domain controller that runs Windows Server 2012 or Windows Server 2012 R2.
Unlike earlier releases of Windows Server, the domain and forest preparations required for
updating Active Directory schema don’t need to be performed manually. Instead, when
you use Server Manager for Windows Server 2012 or Windows Server 2012 R2, any
necessary preparations are done automatically when you deploy a domain controller
running Windows Server 2012 or Windows Server 2012 R2. This means the Configuration
Wizard automatically updates forest and domain schema.
Windows Server 2012 and Windows Server 2012 R2 support both writeable and read-only
domain controllers. If you plan to install an RODC in the forest after you install the initial
Windows Server 2012 or Windows Server 2012 R2 domain controller, you must also
prepare the forest for RODCs. However, as you only need to prepare a forest one time for
RODCs, you don’t need to do this if you previously prepared the forest for RODCs.
You can manually prepare a forest by completing the following steps:
1.                  Log on to the schema master using an account that is a member of
Enterprise Admins and Schema Admins. Additionally, the account must be a
member of Domain Admins for the domain that contains the schema master.
2.                  As appropriate, insert the Windows Server 2012 or Windows Server 2012
R2 DVD into the DVD drive.
3.                  Start an elevated, administrator command prompt. One way to do this is by
right-clicking the Windows logo, and then clicking Command Prompt (Admin).
4.                  Type the following command, and then press Enter:
D:\sources\adprep\adprep /forestprep where D: is the drive designator of the
DVD drive.
5.                  If you plan to install an RODC in any domain in the forest, type the
following, and then press Enter: D:\sources\adprep\adprep /rodcprep where D: is
the drive designator of the DVD drive.
6.                  Wait for the operation to complete, and then wait for the changes to
replicate throughout the forest before you prepare your domains.
Note  Unlike adprep /forestprep, which should be run on the schema master, you
can run adprep /rodcprep on any computer in the forest. Note any errors. If you
receive a message that says that not all application partitions have been updated,
you’ll need to rerun the adprep /rodcprep command.

You can manually prepare a domain by completing the following steps:
1.                  Log on to the infrastructure master using an account that is a member of
the Domain Admins group.
2.                  As appropriate, insert the Windows Server 2012 or Windows Server 2012
R2 DVD into the DVD drive.
3.                  Start an elevated, administrator command prompt. One way to do this is by
right-clicking the Windows logo, and then clicking Command Prompt (Admin).
4.                  Type the following command, and then press Enter:
D:\sources\adprep\adprep /domainprep where D: is the drive designator of the
DVD drive.
5.                  Wait for the operation to complete, and then wait for the changes to
replicate before you install your domain controllers.


Creating Forests, Domain Trees, and Child Domains
Any server running Windows Server can act as a domain controller. You configure a
server as a domain controller by installing the necessary binaries for the Active Directory
Domain Services (AD DS) and then configuring AD DS using the Active Directory
Domain Services Configuration Wizard.
When you are creating a domain controller in a new forest, domain tree, or domain, you
should log on to the local machine using either the local Administrator account or an
account that has administrator privileges on the local machine. Then start the installation.
The Administrator account will be created as a user account in the new domain, with full
administrator permissions. This means the account will be a member of the Users, Domain
Users, and Domain Admins groups.
As you are creating a new forest, the server should have a static IP address. After you
install DHCP servers in the new forest, you can assign the domain controller a dynamic IP
address. However, domain controllers that also act as DNS servers should not have
dynamic IP addresses. The reason for this is that the IP address of a DNS server should be
fixed to ensure reliable DNS operations.

Installing the AD DS Binaries
The AD DS binaries include the Windows components that enable servers to act as
domain controllers as well as the related administration tools. You can install the Active
Directory binaries by entering the following command at an elevated Windows
PowerShell prompt:
Install-WindowsFeature AD-DomainServices –IncludeManagementTools
Note  If Windows PowerShell is pinned to the taskbar, you can open an elevated,
administrator prompt, by right-clicking the taskbar shortcut and then selecting Run
As Administrator.
To install the AD DS binaries on another server, use the –ComputerName parameter to
specify the server you want to work with, such as:
Install-WindowsFeature AD-DomainServices –IncludeManagementTools
-ComputerName CorpServer25
You also can use the Add Roles And Features option in Server Manager to perform this
procedure. Follow these steps:
1.                  In Server Manager, the local server is added automatically for
management. If you want to install AD DS on another server, you need to add the
server for management using the Add Servers option. Typically, you must have
Domain Admin or other explicit permissions to add a server and remotely manage
it. To install a new Active Directory forest, you must be logged on as the local
Administrator for the computer. To install a new child domain or new domain tree,
you must be logged on as a member of the Enterprise Admins group. To install an
additional domain controller in an existing domain, you must be logged on as a
member of the Domain Admins group.
2.                  In Server Manager, click Manage and then click Add Roles And Features.
This starts the Add Roles And Features Wizard. If the wizard displays the Before
You Begin page, read the Welcome message and then click Next.
3.                  On the Select Installation Type page, select Role-Based Or Feature-Based
Installation and then click Next.
4.                  On the Select Destination Server page, the server pool shows servers
you’ve added for management. Click the server you are configuring and then click
Next.
5.                  On the Select Server Roles page, select Active Directory Domain Services
and then click Next twice. Click Install to run the Active Directory Domain
Services Configuration Wizard.
Real World  Before starting an Active Directory installation, you should examine
local accounts and check for encrypted files and folders. Because domain controllers
do not have local accounts or separate cryptographic keys, making a server a domain
controller deletes all local accounts and all certificates and cryptographic keys from
the server. Any encrypted data on the server, including data stored using the
Encrypting File System (EFS), must be decrypted before installing Active Directory,
or it will be permanently inaccessible. Keep in mind this isn’t an issue with

BitLocker Drive Encryption. With BitLocker Drive Encryption, you don’t need to
decrypt drives, but you should disable BitLocker before you install AD DS.

Creating New Forests
You create new forests when you want to establish a completely new Active Directory
environment. The new forest is separate from any existing Active Directory infrastructure.
For example, you would create a new forest when you are setting up directory services for
the first time or when you want to create infrastructure that is in no way connected to any
existing infrastructure.
You can create a new forest by installing a domain controller in the desired namespace by
using these steps:
1.                  After installing the AD DS binaries, click Promote This Server To A
Domain Controller to start the Active Directory Domain Services Configuration
Wizard. If you closed the Add Roles And Features Wizard window, you need to
click the Notifications icon in Server Manager and then click Promote This Server
To A Domain Controller.
Note Before you promote a server to a domain controller, you should check the
server’s IPv4 and IPv6 settings and make sure they’re configured appropriately.
Type ncpa.cpl in the Everywhere Search box, and then press Enter. In Network
Connections, double-click Local Area Connection. In Local Area Connection
Properties, click Properties and then double-click Internet Protocol Version 4
(TCP/IPv4), make any necessary changes, and then click OK. Next, double-click
Internet Protocol Version 6 (TCP/IPv6), make any necessary changes, and then click
OK.
2.                  On the Deployment Configuration page, shown in Figure 2-1, select Add
A New Forest and then enter the full DNS name for the first domain in the new
forest. This domain will be the root domain of the new forest. Domain names are
not case sensitive and use the letters A to Z, the numerals 0 to 9, and the hyphen (-)
character. Each component of the domain name must be separated by a dot (.) and
cannot be longer than 63 characters.
Real World  Typically, you’ll want to use a domain name that ends in the suffix
.local rather than an actual public domain suffix, such as .com. This approach
ensures that there is no conflict between your organization’s public Internet presence
and its private network. For example, if your public Internet domain is
ImaginedLands.com, you might want to use ImaginedLands.Local as the primary
domain for your private network.

FIGURE 2-1 Create a new domain in a new forest.
3.                  When you click Next, the wizard determines whether the name you’ve
entered is already in use on your network. If the name is already in use, you will
need to enter a different name or go back and make a different configuration
selection.
4.                  On the Domain Controller Options page, choose the desired functional
level for the new Active Directory forest, as shown in Figure 2-2. As discussed
previously in “Establishing Functional Levels,” you have many options for the
forest functional level, including: Windows Server 2008, Windows Server 2008 R2,
Windows Server 2012, or Windows Server 2012 R2.
5.                  Choose the desired functional level for the root domain in the forest. The
domain functional level can’t be set lower than the forest functional level. For
example, if you set the forest functional level to Windows Server 2012, you can set
the domain functional level to Windows Server 2012 or Windows Server 2012 R2
only.

FIGURE 2-2 Set primary options for the new forest and domain.
6. As permitted, select additional installation options. If the wizard detects that the
DNS Server service isn’t already available, DNS Server will be selected as an
additional option, and the domain controller will also act as a DNS server. A
primary DNS zone will be created as an Active Directory–integrated zone with the
same name as the new domain you are setting up.
7. The wizard will also update the server’s TCP/IP configuration so that its primary
DNS server is set to itself. Because the first domain controller in a new forest must
be a global catalog and cannot be a read-only domain controller, the global catalog
option is selected and cannot be cleared, and the read-only domain controller option
is dimmed.
8.                  Type and confirm the password that should be used when you want to start
the computer in Directory Services Restore mode. Be sure to track this password
carefully. This special password is used only in Restore mode and is different from
the Administrator account password. Click Next.
9.                  The next page you see depends on whether you are installing DNS Server.
If you are installing the DNS Server service as an additional option, the wizard next
attempts to register a delegation for the DNS server with an authoritative parent
zone. Because you are creating a new forest, there’s no existing DNS infrastructure
for this forest and you’ll see a warning that the wizard can’t create the DNS
delegation. You can ignore this warning. Click Next to continue.
10.             The wizard uses the domain name to generate a default NetBIOS name.
You can accept the wizard-generated name or enter a new NetBIOS name of up to
15 characters, as shown in Figure 2-3. Click Next to continue.

FIGURE 2-3 Set the NetBIOS name for the domain.
11.             On the Paths page, select a location to store the Active Directory database,
logs, and SYSVOL, as shown in Figure 2-4, and then click Next. The default
location for the database and log folders is a subfolder of %SystemRoot%\NTDS.
The default location for the SYSVOL folder is %SystemRoot%\Sysvol. You’ll get
better performance if the database and log folders are on two separate volumes,
each on a separate disk. Placement of the SYSVOL is less critical, and you can
accept the default in most cases. Although you can change the storage locations
later, the process is lengthy and complex. Keep in mind that if you specify directory
paths to use, those directories must exist. If they don’t, you’ll see an invalid paths
error and will need to create the directories before you can continue.
FIGURE 2-4 Configure storage locations for Active Directory data.

Note  Your organization should have a specific plan in place for sizing the server
hardware and designating Active Directory storage locations. You’ll want to ensure
the server you use is powerful enough to handle authentication, replication, and
other directory duties. The server’s hard disk configuration should be optimized for
storage of Active Directory data. Each storage volume should have at least 20
percent free storage space at all times. You may also want to use a redundant array
of independent disks (RAID) to protect against disk failure.
12.             On the Review Options page, review the installation options. Optionally,
click View Script to export the settings to a PowerShell script that you can use to
perform automated installation of other domain controllers.
13.             When you click Next, as shown in Figure 2-5, the wizard performs
preliminary checks to verify that the domain and forest are capable of supporting
the new domain controller. Any issues noted must be corrected before you can
continue. If you take corrective actions, click Rerun Prerequisites Checks to rerun
the checks and ensure that the changes you made successfully resolved any issues.
The wizard also displays information about security changes that could affect older
operating systems.
FIGURE 2-5 Review the results of the preliminary checks.
14.             When you click Install, the wizard uses the options you selected to install
and configure Active Directory. This process can take several minutes. If the DNS
Server service was selected for installation, the server will also be configured as a
DNS Server at this time.
15.             When the wizard finishes setting up Active Directory, the computer will be
restarted. After the server restarts, Active Directory will be completely configured
and the server can then act as a domain controller.
On a Full Server or Core Server installation of Windows Server, you also can add a new
forest using Windows PowerShell. You must be logged on as the local Administrator for
the computer and also must ensure the Administrator password isn’t blank. If the

password is blank, you can set the password to a desired value by entering net user
Administrator /passwordreq:yes at a command prompt and then entering a password
when prompted.
You create the new forest using the Install-ADDSForest cmdlet. The basic syntax is:
install-addsforest –domainname DomainName –DomainMode DomMode
–ForestMode ForMode –installdns
–SafeModeAdministratorPassword Password
The –DomainMode and –ForestMode parameters set the domain and forest functional
levels, respectively, which have acceptable values of Win2003, Win2008, Win2008R2,
Win2012, and Win2012R2. The –InstallDNS parameter installs DNS. The –
SafeModeAdministratorPassword parameter sets the recovery password. In the example
that follows, you set the functional level for the root domain to Windows Server 2012 R2
and the functional level for the new forest to Windows Server 2012 R2:
install-addsforest –domainname imaginedlands.local 
–DomainMode Win2012R2 –ForestMode Win2012R2
–SafeModeAdministratorPassword
(convertto-securestring “Str!F#789” –asplaintext -force)
Note  The recovery password must be provided as a secure string. The example
shows one way of converting a plaintext string to a secure string. The associated –
force parameter allows you to convert to a secure string from plain text.
The full syntax for Install-ADDSForest is:
Install-ADDSForest [-CreateDnsDelegation] [-DatabasePath Path]
[-DnsDelegationCredential Credential] [-DomainMode Mode]
[-DomainNetbiosName NetBiosName] [-Force] [-ForestMode Mode]
[-InstallDns] [-LogPath Path] [-NoDnsOnNetwork]
[-NoRebootOnCompletion] [-SafeModeAdministratorPassword SecureString]
[-SkipAutoConfigureDns] [-SkipPreChecks] [-SysvolPath Path]
-DomainName DomainName
A script using Install-ADDSForest to create a new forest follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Install-ADDSForest `
-CreateDnsDelegation:$false `
-DatabasePath “C:\Windows\NTDS” `
-DomainMode “Win2012R2” `
-DomainName “reagentpress.local” `
-DomainNetbiosName “REAGENTPRESS” `
-ForestMode “Win2012R2” `
-InstallDns:$true `
-LogPath “C:\Windows\NTDS” `
-NoRebootOnCompletion:$false `
-SysvolPath “C:\Windows\SYSVOL” `
-Force:$true
After installing Active Directory, you should verify the installation. Start by examining the
installation log, which is stored in the Dcpromo.log file in the %SystemRoot%\Debug

folder. The log is very detailed and takes you through every step of the installation
process, including the creation of directory partitions and the securing of the Registry for
Active Directory.
Note  As data is appended to any existing log, the Dcpromo log will contain
details regarding any previous installation of AD DS on that server. Because of this,
be sure to only review data logged at the date and time of the current installation.
Next, check the DNS configuration in the DNS console. DNS is updated to add SRV and
A records for the server. Because you created a new forest and an associated root domain,
DNS services are updated to include a Forward Lookup Zone for the root domain. You
may also need to add a Reverse Lookup Zone for the root domain.
Check for updates in Active Directory Users And Computers. Because you created a new
forest and an associated root domain, the following containers are created and populated
as appropriate:
Builtin contains the built-in accounts for administration, including Administrators
and Account Operators.
Computers contains computer accounts for the domain.
Domain Controllers contains the domain controller accounts and should have an
account for the domain controller you installed.
ForeignSecurityPrincipals is a container for security principals from other domain
trees.
Users is the default container for user accounts in the domain.

Creating New Domain Trees
After you create a forest and an associated root domain, you can create new domain trees
when there isn’t an existing parent domain with which you want to associate a new
domain. The new domain tree is separate from any existing trees in the existing Active
Directory forest. For example, you would create a new domain tree if the
imaginedlands.local domain already exists and you want to establish the reagentpress.local
domain in a new tree in the existing forest.
To create a new domain tree in an existing forest, you will be required to provide the
credentials for an account that is a member of the Enterprise Admins group in the forest of
which the domain will be a part. You can create a new domain tree by installing a domain
controller in the desired namespace with these steps:
1.                  After installing the AD DS binaries, click Promote This Server To A
Domain Controller to start the Active Directory Domain Services Configuration
Wizard. If you closed the Add Roles And Features Wizard window, you need to
click the Notifications icon in Server Manager and then click Promote This Server
To A Domain Controller.
Note Before you promote a server to a domain controller, you should check the
server’s IPv4 and IPv6 settings and make sure they’re configured appropriately.
Type ncpa.cpl in the Everywhere Search box, and then press Enter. In Network
Connections, double-click Local Area Connection. In Local Area Connection
Properties, click Properties and then double-click Internet Protocol Version 4
(TCP/IPv4), make any necessary changes, and then click OK. Next, double-click
Internet Protocol Version 6 (TCP/IPv6), make any necessary changes, and then click
OK.
2.                  On the Deployment Configuration page, shown in Figure 2-6, Choose Add
A New Domain To An Existing Forest and then choose Tree Domain as the domain
type. By selecting this option, you are specifying that the forest root domain already
exists but there currently isn’t any other suitable parent domain.
3.                  The wizard will then enumerate domains in the forest and attempt to
identify the forest root domain. The Forest Name text box is completed
automatically, based on the domain identified as the forest root. Before continuing
ensure the name shown is the fully-qualified name of the forest root domain, such
as imaginedlands.local.
4.                  Next, type the fully qualified name of the new tree domain in the New
Domain Name box. The domain name you use should not be a subdomain of an
existing parent domain in any tree of the forest. The name must have at least two
naming components. Each component of the domain name must be separated by a
dot (.) and can’t be longer than 63 characters. Use only the letters A to Z, the
numerals 0 to 9, and the hyphen (-) character.

FIGURE 2-6 Create a new domain tree.
5.                  If you are logged on to a domain in the forest in which you are installing
the new domain tree and the account is a member of the Enterprise Admins group,
you can use your current logged-on credentials to perform the installation.
Otherwise, select Change, enter the user name and password for an account that is a
member of the Enterprise Admins group, and then click OK.
6.                  When you click Next, the wizard:
Checks the forest configuration and attempts to contact a domain controller in the
forest root domain. If a logon error occurs, you may have specified an invalid
account or account password and will need to correct the credential settings. The
wizard also won’t be able to log onto the root domain if the name you provide is
invalid or if a domain controller in the root domain cannot be contacted. Thus, one
way you might be able to resolve this problem is by entering the correct name of the
root domain. You might also be able to resolve the problem by checking and
correcting the TCP/IP configuration of the server you are trying to promote. At a
minimum, the server should have a valid IPv4 address and a preferred DNS server
—both of which can be either statically or dynamically assigned. If the TCP/IPv4
settings are correct, you’ll need to examine the _ldap SRV records for the _tcp zone
on the authoritative DNS server. Ensure these records and the corresponding A
records are properly configured.
Validates the new domain name. If there is an existing domain in the forest with the
new name you specified, you will see a verification error message and will need to
provide a different domain name. If there isn’t an existing domain in the forest with
this name, the wizard will attempt to register the name. To do this, the wizard
requires that the user credentials you elected to use or provided previously are a
member of the Enterprise Admins group.
7.                  On the Domain Controller Options page, shown in Figure 2-7, select the
domain functional level that accommodates the domain controllers that you plan to

install in the domain. The domain functional level can’t be set lower than the forest
functional level. For example, if the forest functional level is set to Windows Server
2012, you can set the domain functional level to Windows Server 2012 or Windows
Server 2012 R2 only.
8. As permitted, select additional installation options. The DNS Server option is
selected by default so that the domain controller can function as a DNS server. A
DNS zone and a delegation for that zone will be automatically created for this
domain. The wizard will also update the server’s TCP/IP configuration so that its
primary DNS server is set to itself. Because you are configuring the first domain
controller in a new domain tree, the Global Catalog option is selected by default.
The read-only domain controller option is dimmed and cannot be selected.
Note Keep in mind that because this is the first domain controller in a new domain
tree, it will also host the domainwide operations master roles for the new domain,
including the infrastructure master role. Hosting the infrastructure master role on a
global catalog server in a child domain can cause problems unless all of the domain
controllers in the domain are global catalog servers.
FIGURE 2-7 Select options and place the domain controller in the appropriate site.
9.                  If there is a site that corresponds to the IP address of the server you are
promoting, this site is selected automatically on the Site Name list. If you want to
place the new domain controller in a different site or there isn’t an available subnet
for the current IP address, select the site in which you want to locate the domain
controller. After setup, you can move the domain controller to a new site at any
time.
10.             Type and confirm the password that should be used when you want to start
the computer in Directory Services Restore mode. Be sure to track this password
carefully. This special password is used only in Restore mode and is different from
the Administrator account password. Click Next.

11.             The next page you see depends on whether you are installing DNS Server.
If you are installing the DNS Server service as an additional option, the wizard next
attempts to register a delegation for the DNS server with an authoritative parent
zone. Because you are creating a new domain tree, there’s no existing DNS
infrastructure for this domain and you’ll see a warning that the wizard can’t create
the DNS delegation. You can ignore this warning. Click Next to continue.
12.             The wizard uses the domain name to generate a default NetBIOS name.
You can accept the wizard-generated name or enter a new NetBIOS name of up to
15 characters, as shown in Figure 2-8. Keep in mind the name must be unique in the
forest. Click Next to continue.
FIGURE 2-8 Specify the NetBIOS name for the new domain.
13.             On the Paths page, select a location to store the Active Directory database,
logs, and SYSVOL, as shown in Figure 2-9, and then click Next. The default
location for the database and log folders is a subfolder of %SystemRoot%\NTDS.
The default location for the SYSVOL folder is %SystemRoot%\Sysvol. You’ll get
better performance if the database and log folders are on two separate volumes,
each on a separate disk. Placement of the SYSVOL is less critical, and you can
accept the default in most cases. Although you can change the storage locations
later, the process is lengthy and complex. Keep in mind that if you specify directory
paths to use, those directories must exist. If they don’t, you’ll see an invalid paths
error and will need to create the directories before you can continue.

FIGURE 2-9 Specify the storage locations for Active Directory data.
Note  Your organization should have a specific plan in place for sizing the server
hardware and designating Active Directory storage locations. You’ll want to ensure
the server you use is powerful enough to handle authentication, replication, and
other directory duties. The server’s hard disk configuration should be optimized for
storage of Active Directory data. Each storage volume should have at least 20
percent free storage space at all times. You may also want to use a redundant array
of independent disks (RAID) to protect against disk failure.
14.             If Active Directory schema must be updated, you’ll see the Preparation
Options page. You see this page when you are installing the first Windows Server
2012 or Windows Server 2012 R2 domain controller in the forest because the forest
schema must be updated to support the operating system. When you click Next to
continue, the wizard doesn’t use Adprep.exe to extend the schema or update the
forest. Instead, the wizard does this during the installation phase, just before
promoting the domain controller.
Note  Keep in mind that if the forest must be prepared, the user credentials are
checked on the Preparation Options page. If the user isn’t a member of the
appropriate groups, you’ll see an error message. In this case, click Change. In the
Windows Security dialog box, provide the user name and password of an account
with sufficient permissions.
15.             On the Review Options page, review the installation options. Optionally,
click View Script to export the settings to a PowerShell script that you can use to
perform automated installation of other domain controllers. When you click Next,
as shown in Figure 2-10, the wizard performs preliminary checks to verify that the
forest is capable of supporting the new domain controller. Any issues noted must be
corrected before you can continue. If you take corrective actions, click Rerun
Prerequisites Checks to rerun the checks and ensure that the changes you made
successfully resolved any issues. The wizard also displays information about

security changes that could affect older operating systems.
16.             When you click Install, the wizard uses the options you selected to install
and configure Active Directory. This process can take several minutes. If the DNS
Server service was selected for installation, the server will also be configured as a
DNS Server at this time.
17.             When the wizard finishes setting up Active Directory, the computer will be
restarted. After the server restarts, Active Directory will be completely configured
and the server can then act as a domain controller in the new domain tree.
FIGURE 2-10 Confirm that the prerequisite checks passed successfully.
18.             Additionally, after installing AD DS, you need to configure DNS so that
name resolution works appropriately with any existing domains. To enable name
resolution for computers within the new domain, you typically need to create
secondary zones for all existing domains in the new domain and then set up zone
transfers. To enable name resolution into the new domain from existing domains,
you typically need to create a secondary zone in existing domains for the new
domain and then set up zone transfers.
On a Full Server or Core Server installation of Windows Server, you also can add a new
domain tree using Windows PowerShell. You must be logged on using an account that is a
member of the Enterprise Admins group in the forest.
You create the new domain tree using the Install-ADDSDomain cmdlet. The basic syntax
is:
install-addsdomain –newdomainname DomainName
–newdomainnetbiosname NetBiosName
–parentdomainname ParentDomain
–DomainMode DomMode –DomainType DomType
–installdns –SafeModeAdministratorPassword Password
The –NewDomainName parameter sets the name of the new domain, and the –
NewDomainNetBiosName sets the associated NetBios name. You also need to specify the

name of the parent domain to contact for authentication and registration of the new
domain and you use the –ParentDomainName parameter to do this. Make sure you set the
parent name to the name of the root domain in the forest.
The –DomainMode parameter sets the domain functional level, which has acceptable
values of Win2003, Win2008, Win2008R2, Win2012, and Win2012R2. The –DomainType
parameter sets the domain type as either ChildDomain or TreeDomain. Use TreeDomain
to install a new tree.
The –InstallDNS parameter installs DNS. To set the recovery password, use the –
SafeModeAdministratorPassword parameter.
In the example that follows, you set the functional level for the new domain to Windows
Server 2012 R2 and specify that you are creating a new domain tree:
install-addsdomain –newdomainname reagentpress.local
-newdomainnetbiosname reagentpress –parentdomainname
imaginedlands.local -domainmode Win2012R2 –domaintype treedomain
–SafeModeAdministratorPassword (read-host –prompt “Recovery
Password:” –assecurestring) –installdns
Note  The recovery password must be provided as a secure string. The example
shows how you can prompt for the password and then convert this value to a secure
string.
The full syntax for Install-ADDSDomain is:
Install-ADDSDomain [-ADPrepCredential Credential]
[-AllowDomainReinstall] [-CreateDnsDelegation] [-Credential
Credential] [-DatabasePath Path] [-DnsDelegationCredential
Credential] [-DomainMode DomainMode] [-DomainType DomainType]
[-Force] [-InstallDns] [-LogPath Path] [-NewDomainNetbiosName
NetBiosName] [-NoDnsOnNetwork] [-NoGlobalCatalog]
[-NoRebootOnCompletion] [-ReplicationSourceDC SourceDC]
[-SafeModeAdministratorPassword SecureString] [-SiteName SiteName]
[-SkipAutoConfigureDns] [-SkipPreChecks] [-SysvolPath Path]
-NewDomainName DomainName -ParentDomainName ParentDomain
A script using Install-ADDSDomain to create a new domain tree follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Install-ADDSDomain `
-NoGlobalCatalog:$false `
-CreateDnsDelegation:$false `
-DatabasePath “D:\NTDS” `
-DomainMode “Win2012R2” `
-DomainType “TreeDomain” `
-InstallDns:$true `
-LogPath “G:\LOGS” `
-NewDomainName “reagentpress.local” `
-NewDomainNetbiosName “REAGENTPRESS” `
-ParentDomainName “imaginedlands.local” `
-NoRebootOnCompletion:$false `
-SiteName “Default-First-Site-Name” `

-SysvolPath “C:\Windows\SYSVOL” `
-Force:$true
After installing Active Directory, you should verify the installation. Start by examining the
installation log, which is stored in the Dcpromo.log file in the %SystemRoot%\Debug
folder. The log is very detailed and takes you through every step of the installation
process, including the creation of directory partitions and the securing of the Registry for
Active Directory.
Next, check the DNS configuration in the DNS console. DNS is updated to add SRV and
A records for the server. Because you created a new domain, DNS services are updated to
include a Forward Lookup Zone for the domain. You may also need to add a Reverse
Lookup Zone for the domain.
Check for updates in Active Directory Users And Computers. Because you created a new
domain, the following containers are created and populated as appropriate:
Builtin contains the built-in accounts for administration, including Administrators
and Account Operators.
Computers contains computer accounts for the domain.
Domain Controllers contains the domain controller accounts and should have an
account for the domain controller you installed.
ForeignSecurityPrincipals is a container for security principals from other domain
trees.
Users is the default container for user accounts in the domain.

Creating New Child Domains
To create a new child domain in an existing forest, you will be required to provide the
credentials for an account that is a member of the Enterprise Admins group in the forest of
which the domain will be a part. For example, you would create a new child domain if the
parent domain imaginedlands.local had already been created and you wanted to create the
technology.imaginedlands.local domain as a child of this domain.
You can create a new child domain by installing a domain controller in the desired
namespace by using these steps:
1.                  After installing the AD DS binaries, click Promote This Server To A
Domain Controller to start the Active Directory Domain Services Configuration
Wizard. If you closed the Add Roles And Features Wizard window, you need to
click the Notifications icon in Server Manager and then click Promote This Server
To A Domain Controller.
Note Before you promote a server to a domain controller, you should check the
server’s IPv4 and IPv6 settings and make sure they’re configured appropriately.
Type ncpa.cpl in the Everywhere Search box, and then press Enter. In Network
Connections, double-click Local Area Connection. In Local Area Connection
Properties, click Properties and then double-click Internet Protocol Version 4
(TCP/IPv4), make any necessary changes, and then click OK. Next, double-click
Internet Protocol Version 6 (TCP/IPv6), make any necessary changes, and then click
OK.
2.                  On the Deployment Configuration page, shown in Figure 2-11, Choose
Add A New Domain To An Existing Forest and then choose Child Domain as the
domain type. These options will establish the first domain controller in a domain
that is a child domain of an existing domain. By selecting these options, you are
specifying that the necessary parent domain already exists in the current forest.
3.                  The wizard will then enumerate domains in the forest and attempt to
identify the current logon domain. For Parent Domain Name, type or select the
fully-qualified name of the parent domain, such as imaginedlands.local.

FIGURE 2-11 Create an additional domain in the forest.
4.                  Next, type the name of the new child domain in the New Domain Name
box. Be sure to provide a valid, single-label name for the child domain, such as eng
rather than eng.imaginedlands.local. The name must follow DNS domain name
requirements. This means the name can use the letters A to Z, the numerals 0 to 9,
and the hyphen (-) character.
5.                  If you are logged on to a domain in the forest in which you are installing
the new child domain and the account is a member of the Enterprise Admins group,
you can use your current logged-on credentials to perform the installation.
Otherwise, select Change, enter the user name and password for an account that is a
member of the Enterprise Admins group, and then click OK.
6.                  When you click Next, the wizard:
Checks the forest configuration and attempts to contact a domain controller in the
forest root domain. If a logon error occurs, you may have specified an invalid
account or account password and will need to correct the credential settings. The
wizard also won’t be able to log onto the root domain if the name you provide is
invalid or if a domain controller in the root domain cannot be contacted. Thus, one
way you might be able to resolve this problem is by entering the correct name of the
root domain. You might also be able to resolve the problem by checking and
correcting the TCP/IP configuration of the server you are trying to promote. At a
minimum, the server should have a valid IPv4 address and a preferred DNS server
—both of which can be either statically or dynamically assigned. If the TCP/IPv4
settings are correct, you’ll need to examine the _ldap SRV records for the _tcp zone
on the authoritative DNS server. Ensure these records and the corresponding A
records are properly configured.
Validates the new domain name. If there is an existing domain in the forest with the
new name you specified, you will see a verification error message and will need to
provide a different domain name. If there isn’t an existing domain in the forest with

this name, the wizard will attempt to register the name. To do this, the wizard
requires that the user credentials you elected to use or provided previously are a
member of the Enterprise Admins group.
7.                  On the Domain Controller Options page, shown in Figure 2-12, select the
domain functional level that accommodates the domain controllers that you plan to
install in the domain. The domain functional level can’t be set lower than the forest
functional level. For example, if the forest functional level is set to Windows Server
2012, you can set the domain functional level to Windows Server 2012 or Windows
Server 2012 R2 only.
FIGURE 2-12 Choose options for the child domain.
8. As permitted, select additional options for the domain controller. The DNS Server
option is selected by default so that the domain controller can function as a DNS
server. A DNS zone and a delegation for that zone will be automatically created for
this domain. The wizard will also update the server’s TCP/IP configuration so that
its primary DNS server is set to itself. Because you are configuring the first domain
controller in a new child domain, the Global Catalog option is selected by default.
The read-only domain controller option is dimmed and cannot be selected.
Note Keep in mind that because this is the first domain controller in a new
domain, it will also host the domainwide operations master roles for the new
domain, including the infrastructure master role. Hosting the infrastructure master
role on a global catalog server in a child domain can cause problems unless all of the
domain controllers in the domain are global catalog servers.
9.                  If there is a site that corresponds to the IP address of the server you are
promoting, this site is selected automatically on the Site Name list. If you want to
place the new domain controller in a different site or there isn’t an available subnet
for the current IP address, select the site in which you want to locate the domain
controller. After setup, you can move the domain controller to a new site at any

time.
10.             Type and confirm the password that should be used when you want to start
the computer in Directory Services Restore mode. Be sure to track this password
carefully. This special password is used only in Restore mode and is different from
the Administrator account password. Click Next.
11.             Because you are creating a child domain, the wizard will attempt to create a
DNS delegation in the authoritative parent zone. On the DNS Options page, shown
in Figure 2-13, confirm that the listed credentials are appropriate and have the
necessary permissions to create this delegation. To change the credentials, click
Change, enter the user name and password for an account that has appropriate
administrator permissions in the parent domain, and then click OK.
Real World When you install a domain controller that will also act as a DNS
server for a child domain, delegation records that point to the DNS server as
authoritative for the zone should be created in the parent zone. These delegation
records transfer name resolution authority to the domain controller and ensure other
DNS servers and clients consider this domain controller to be authoritative for the
related zone. The records created in the parent zone include a name server (NS)
resource record for the domain controller and host (A or AAAA) records. The name
server record identifies the domain controller as being authoritative for the zone.
The host records are used to resolve the domain controller’s host name to its IP
address. If for some reason, the wizard is unable to create the DNS delegation, you
can continue with the domain controller installation and create the delegation
manually later. To do this, you’ll need to know the fully-qualified domain name and
IP address of the domain controller. Next, in DNS Manager, expand Forward
Lookup Zones, right-click the parent domain and then select New Delegation. Use
the New Delegation Wizard to create the DNS delegation for the domain controller
in the child domain.
FIGURE 2-13 Confirm the DNS delegation options.

12.             When you click Next to continue, the wizard tries to use the domain name
you provided to generate a default NetBIOS name. You can accept the wizard-
generated name or enter a new NetBIOS name of up to 15 characters. Keep in mind
the name must be unique in the forest. Click Next to continue.
Note As you are creating a child domain, you might see a message stating “Error
determining NETBIOS name for the domain.” This error occurs when the wizard is
unable to generate an acceptable name. Simply enter a unique NetBIOS name to
clear the error and continue.
13.             On the Paths page, shown in Figure 2-14, select a location to store the
Active Directory database, logs, and SYSVOL. Click Next. The default location is
a subfolder of %SystemRoot%\NTDS. The default location for the SYSVOL folder
is %SystemRoot%\Sysvol. You’ll get better performance if the database and log
folders are on two separate volumes, each on a separate disk. Placement of the
SYSVOL is less critical, and you can accept the default in most cases.
Tip Although you can change the storage locations later, the process is lengthy
and complex. Additionally, keep in mind that if you specify directory paths to use,
those directories must exist. If they don’t, you’ll see an invalid paths error and will
need to create the directories.
FIGURE 2-14 Choose the storage locations for folders.
Note  Your organization should have a specific plan in place for sizing the server
hardware and designating Active Directory storage locations. You’ll want to ensure
the server you use is powerful enough to handle authentication, replication, and
other directory duties. The server’s hard disk configuration should be optimized for
storage of Active Directory data. Each storage volume should have at least 20
percent free storage space at all times. You may also want to use a redundant array
of independent disks (RAID) to protect against disk failure.
14.             If Active Directory schema must be updated, you’ll see the Preparation

Options page. You see this page when you are installing the first Windows Server
2012 or Windows Server 2012 R2 domain controller in the forest because the forest
schema must be updated to support the operating system. When you click Next to
continue, the wizard doesn’t use Adprep.exe to extend the schema or update the
forest. Instead, the wizard does this during the installation phase, just before
promoting the domain controller.
Note  Keep in mind that if the forest must be prepared, the user credentials are
checked on the Preparation Options page. If the user isn’t a member of the
appropriate groups, you’ll see an error message. In this case, click Change. In the
Windows Security dialog box, provide the user name and password of an account
with sufficient permissions.
15.             On the Review Options page, review the installation options. Optionally,
click View Script to export the settings to a PowerShell script that you can use to
perform automated installation of other domain controllers. When you click Next,
the wizard performs preliminary checks to verify that the forest is capable of
supporting the new domain controller. Any issues noted must be corrected before
you can continue. If you take corrective actions, click Rerun Prerequisites Checks
to rerun the checks and ensure that the changes you made successfully resolved any
issues. The wizard also displays information about security changes that could
affect older operating systems.
16.             When you click Install, the wizard uses the options you selected to install
and configure Active Directory. This process can take several minutes. If the DNS
Server service was selected for installation, the server will also be configured as a
DNS Server at this time.
17.             When the wizard finishes setting up Active Directory, the computer will be
restarted. After the server restarts, Active Directory will be completely configured
and the server can then act as a domain controller in the new child domain.
18.             Additionally, after installing AD DS, you need to configure DNS so that
name resolution works appropriately with any existing domains. To enable name
resolution for computers within the new domain, you typically need to create
secondary zones for all existing domains in the new domain and then set up zone
transfers. To enable name resolution into the new domain from existing domains,
you typically need to create a secondary zone in existing domains for the new
domain and then set up zone transfers.
On a Full Server or Core Server installation of Windows Server, you also can add a new
child domain using Windows PowerShell. You must be logged on using an account that is
a member of the Enterprise Admins group in the forest. You create the new child domain
using the Install-ADDSDomain cmdlet, which was discussed earlier in “Creating New
Domain Trees.” Because you are creating a child domain, be sure to set –DomainType to
ChildDomain and use –CreateDNSDelegation, as shown in the following example:
install-addsdomain –newdomainname eng
-newdomainnetbiosname engiml –parentdomainname
imaginedlands.local -domainmode Win2012R2 –domaintype childdomain
-creatednsdelegation –safemodeadministratorpassword
(read-host –prompt “Recovery Password:” –assecurestring) –installdns

A script using Install-ADDSDomain to create a new child domain follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Install-ADDSDomain `
-NoGlobalCatalog:$false `
-CreateDnsDelegation:$true `
-DatabasePath “C:\Windows\NTDS” `
-DomainMode “Win2012R2” `
-DomainType “ChildDomain” `
-InstallDns:$true `
-LogPath “C:\Windows\NTDS” `
-NewDomainName “eng” `
-NewDomainNetbiosName “ENG” `
-ParentDomainName “imaginedlands.local” `
-NoRebootOnCompletion:$false `
-SiteName “Default-First-Site-Name” `
-SysvolPath “C:\Windows\SYSVOL” `
-Force:$true
After installing Active Directory, you should verify the installation. Start by examining the
installation log, which is stored in the Dcpromo.log file in the %SystemRoot%\Debug
folder. The log is very detailed and takes you through every step of the installation
process, including the creation of directory partitions and the securing of the Registry for
Active Directory.
Next, check the DNS configuration in the DNS console. DNS is updated to add SRV and
A records for the server. Because you created a new child domain, DNS services are
updated to include a Forward Lookup Zone for the child domain. You may also need to
add a Reverse Lookup Zone for the child domain.
Check for updates in Active Directory Users And Computers. Because you created a new
child domain, the following containers are created and populated as appropriate:
Builtin contains the built-in accounts for administration, including Administrators
and Account Operators.
Computers contains computer accounts for the domain.
Domain Controllers contains the domain controller accounts and should have an
account for the domain controller you installed.
ForeignSecurityPrincipals is a container for security principals from other domain
trees.
Users is the default container for user accounts in the domain.


Chapter 3. Deploying Writeable Domain Controllers
In this chapter, I provide tips and techniques for adding and removing writeable domain
controllers. After setting up the initial domain controller in a domain, you deploy
additional domain controllers to increase fault tolerance and improve operational
efficiency. Just as you establish a server as a domain controller by installing Active
Directory Domain Services (AD DS), you decommission a domain controller by removing
AD DS. The decommissioned domain controller can then be taken out of service, or it can
act as a member server in the domain.


Preparing to Deploy or Decommission Domain Controllers
Before deploying or decommissioning domain controllers, you should create a plan that
lists any prerequisites, necessary postmodification changes, and overall impact on your
network. Create your plan by reviewing “Preparing for Active Directory Installation” in
Chapter 2, ”Installing New Forests, Domain Trees, and Child Domains.”
Domain controllers host the Active Directory database and handle related operations.
Active Directory uses a multimaster replication model that creates a distributed
environment where no single domain controller is authoritative with regard to logon and
authentication requests. This model allows any domain controller to be used for logon and
authentication. It also allows you to make changes to standard directory information
without regard to which domain controller you use.
Domain controllers also can have special roles as operations masters and global catalog
servers. As discussed in Chapter 5, “Managing Operations Masters,” operations masters
perform tasks that can be performed only by a single authoritative domain controller.
Global catalog servers store partial replicas of data from all domains in a forest to
facilitate directory searches for resources in other domains and to determine membership
in universal groups.
When you establish the first domain controller in a forest, the domain controller hosts the
forestwide and domainwide operations master roles and also acts as the global catalog
server for the domain. When you establish the first domain controller in a domain, the
domain controller hosts the domainwide operations master roles and also acts as the global
catalog server for the domain.
Every domain in the enterprise should have at least two domain controllers. If a domain
has only one domain controller, you could lose the entire domain and all related accounts
if disaster strikes. Although you may be able to recover the domain from a backup, you
will have significant problems until the restore is completed. For example, users may not
be able to log on to the domain or obtain authenticated access to domain resources.
Every site should have at least one domain controller. If a domain controller is not
available in a site, computers in the site will perform logon and authentication activities
with domain controllers in another site, which could significantly affect response times.
Every site should have a global catalog server. If a global catalog server is not available in
a site, computers in the site will query a global catalog server in another site when
searching for resources in other domains in the forest. Global catalog servers are also used
during logon and authentication because they store universal group membership
information for all domains in the forest. If a global catalog server isn’t available in the
site and the universal group membership has not been previously cached, the domain
controller responding to a user’s logon or authentication request will need to obtain the
required information from a global catalog server in another site.


Adding Writeable Domain Controllers
You establish a server as a domain controller by installing the necessary binaries for the
Active Directory Domain Services (AD DS) and then configuring the services using the
Active Directory Domain Services Configuration Wizard. If you are deploying Windows
Server 2012 or Windows Server 2012 R2 for the first time in an existing forest, you must
prepare Active Directory as discussed in “Deploying Windows Server 2012 and R2” in
Chapter 2.

Installing Additional Writeable Domain Controllers
Any computer running Windows Server can act as a domain controller. Essentially,
domain controllers are database servers with extensive directory, application, and
replication features. Because of this, the hardware you choose for the domain controllers
should be fairly robust. You’ll want to look carefully at the server’s processor, memory,
and hard disk configuration.
In many cases, you’ll want to install domain controllers on hardware with multiple, fast
processors. This will help ensure the domain controller can efficiently handle replication
requests and topology generation. When you install the second domain controller in a
forest, the Knowledge Consistency Checker (KCC) begins running on every domain
controller. Not only does the KCC generate replication topology, it also dynamically
handles changes and failures within the topology. By default, the KCC recalculates the
replication topology every 15 minutes. As the complexity of the replication topology
increases, so does processing power required for this calculation. You’ll need to monitor
processor usage and upgrade as necessary.
In addition to running standard processes, domain controllers must run processes related to
storage engine operations, knowledge consistency checking, replication, and garbage
collection. Most domain controllers should have at least 4 gigabytes (GB) of RAM as a
recommended starting point for full server installations and 2 GB of RAM for core server
installations. You’ll need to monitor memory usage and upgrade as necessary.
With regard to hard disks, you’ll want to closely examine fault tolerance and storage
capacity needs. Domain controllers should use fault-tolerant drives to protect against
hardware failure of the system volume and any other volumes used by Active Directory. I
recommend using a redundant array of independent disks (RAID), RAID 1 for system
volumes and RAID 5 for data. Hardware RAID is preferable to software RAID. Storage
capacity needs depend on the number of objects related to users, computers, groups, and
resources that are stored in the Active Directory database. Each storage volume should
have ample free disk space at all times to ensure proper operational efficiency.
When you add a domain controller to an existing domain, you should consider whether
you want to perform an installation from media rather than creating the domain controller
from scratch. With either technique, you will need to log on to the local machine using
either the local Administrator account or an account that has administrator privileges on
the local machine. Then start the installation. You also will be required to provide the
credentials for an account that is a member of the Domain Admins group in the domain of
which the domain controller will be a part. Because you will be given the opportunity to
join the domain controller to the domain if necessary, it is not necessary for the server to
be a member of the domain.

Adding Writeable Domain Controllers Using Replication
You can add a writeable domain controller to an existing domain by completing the
following steps:
1.                  Check the TCP/IP configuration of the server. The server must have a valid
IP address and must have properly configured DNS settings.
Note  Domain controllers that also act as DNS servers should not have dynamic IP
addresses, to ensure reliable DNS operations. Otherwise, the server can have a static
IP address or a dynamic IP address assigned by a DHCP server.
2.                  Install the Active Directory binaries. One way to do this is to enter the
following command at an elevated Windows PowerShell prompt: Install-
WindowsFeature AD-DomainServices –IncludeManagementTools. Installing
the AD DS binaries enables the Active Directory Domain Services role on the
server. You also can install the AD DS binaries using the Add Roles And Features
option in Server Manager. See “Installing the AD DS Binaries” in Chapter 2 for
more information.
3.                  Before starting an Active Directory installation, you should examine local
accounts to determine whether you need to take special steps to preserve any local
accounts. You should also check for encrypted files and folders.
Caution  Domain controllers do not have local accounts or separate cryptographic
keys. Making a server a domain controller deletes all local accounts and all
certificates and cryptographic keys from the server. Any encrypted data on the
server, including data stored using the Encrypting File System (EFS), must be
decrypted before Active Directory is installed, or it will be permanently
inaccessible. Keep in mind this isn’t an issue with BitLocker Drive Encryption. With
BitLocker Drive Encryption, you don’t need to decrypt drives, but you should
disable BitLocker before you install AD DS.
4.                  After installing the AD DS binaries, start the Active Directory Domain
Services Configuration Wizard by clicking the Notifications icon in Server
Manager and then clicking Promote This Server To A Domain Controller.
5.                  On the Deployment Configuration page, shown in Figure 3-1, Choose Add
A New Domain Controller To An Existing Domain. By choosing this option, you
specify that you are adding a domain controller to an existing domain in the Active
Directory forest.
6.                  Next, in the domain box, specify the domain to which the domain
controller will be added. The logon domain of the current user is listed by default.
To add the domain controller to a different domain, type the name of the domain.
Alternatively, click Select, choose the domain from a list of domains provided and
then click OK.
7.                  If you are logged on using an account that is a member of the Domain
Admins group in the target domain, you can use your current logged-on credentials
to perform the installation. Otherwise, select Change, enter the user name and
password for an account that is a member of the Domain Admins group, and then

click OK.
FIGURE 3-1 Specify that you want to add a domain controller to the domain.
8.                  When you click Next, the wizard checks the forest configuration and
attempts to contact a domain controller in the target domain. If a logon error occurs,
you may have specified an invalid account or account password and will need to
correct the credential settings. The wizard also won’t be able to log onto the domain
if the name you provide is invalid or if a domain controller in the domain cannot be
contacted. Thus, one way you might be able to resolve this problem is by entering
the correct name of the domain that you want to work with. You might also be able
to resolve the problem by checking and correcting the TCP/IP configuration of the
server you are trying to promote. At a minimum, the server should have a valid
IPv4 address and a preferred DNS server—both of which can be either statically or
dynamically assigned. If the TCP/IPv4 settings are correct, you’ll need to examine
the _ldap SRV records for the _tcp zone on the authoritative DNS server. Ensure
these records and the corresponding A records are properly configured.
9.                  On the Domain Controller Options page, shown in Figure 3-2, select
additional installation options, as permitted. The DNS Server option is selected by
default so that the domain controller can function as a DNS server. The wizard will
also update the server’s TCP/IP configuration so that its primary DNS server is set
to itself. Although the Global Catalog option is selected by default, you can clear
this option if you don’t want the domain controller to act as a global catalog server.

FIGURE 3-2 Specify the additional installation options.
10.             If there is a site that corresponds to the IP address of the server you are
promoting, this site is selected automatically on the Site Name list. If you want to
place the new domain controller in a different site or there isn’t an available subnet
for the current IP address, select the site in which you want to locate the domain
controller. After setup, you can move the domain controller to a new site at any
time.
11.             Type and confirm the password that should be used when you want to start
the computer in Directory Services Restore mode. Be sure to track this password
carefully. This special password is used only in Restore mode and is different from
the Administrator account password. The password complexity and length must
comply with the domain security policy.
12.             The next page you see depends on whether you are installing DNS Server.
If you are installing the DNS Server service as an additional option, the wizard next
attempts to register a delegation for the DNS server with an authoritative parent
zone. Typically, you’ll see a warning stating that a delegation cannot be created and
can ignore this warning. A delegation for the zone should already exist and doesn’t
typically need to be recreated. Click Next to continue.
Real World Delegation records transfer name resolution authority to a particular
domain controller and ensure other DNS servers and clients consider a domain
controller to be authoritative for the related zone. If there’s an existing authoritative
domain controller and you want the domain controller you are installing to be
authoritative instead, continue with the domain controller installation and create the
delegation manually later. To do this, you’ll need to know the fully-qualified domain
name and IP address of the domain controller. Next, in DNS Manager, expand
Forward Lookup Zones, right-click the parent domain and then select New
Delegation. Use the New Delegation Wizard to create the DNS delegation for the
domain controller in the child domain.

13.             On the Additional Options page, shown in Figure 3-3, select installation
and replication options. You can provide the location of installation media to be
used to create the domain controller and configure AD DS, or you can have all of
the replication done over the network. Even if you install from media, some data
will be replicated over the network from a source domain controller. For more
information about installing from media, see “Adding Writeable Domain
Controllers Using Installation Media.”
14.             By default, data is replicated from any available domain controller. If you
want data to be replicated from a specific domain controller in the designated
domain, choose this domain controller on the Replicate From list. Then click Next.
If you choose to install from media, only changes since the media was created will
be replicated from the source domain controller. If you choose not to install from
media, all data will be replicated from the source domain controller.
FIGURE 3-3 Specify the installation and replication options.
15.             On the Paths page, shown in Figure 3-4, select a location to store the
Active Directory database, logs, and SYSVOL. Click Next. The default location is
a subfolder of %SystemRoot%\NTDS. The default location for the SYSVOL folder
is %SystemRoot%\Sysvol. You’ll get better performance if the database and log
folders are on two separate volumes, each on a separate disk. Placement of the
SYSVOL is less critical, and you can accept the default in most cases.
Tip Although you can change the storage locations later, the process is lengthy
and complex. Additionally, keep in mind that if you specify directory paths to use,
those directories must exist. If they don’t, you’ll see an invalid paths error and will
need to create the directories.

FIGURE 3-4 Specify the storage locations for AD DS folders.
Note  Your organization should have a specific plan in place for sizing the server
hardware and designating Active Directory storage locations. You’ll want to ensure
the server you use is powerful enough to handle authentication, replication, and
other directory duties. The server’s hard disk configuration should be optimized for
storage of Active Directory data. Each storage volume should have at least 20
percent free storage space at all times. You may also want to use a redundant array
of independent disks (RAID) to protect against disk failure.
16.             If Active Directory schema for the domain must be updated, you’ll see the
Preparation Options page. You see this page when you are installing the first
Windows Server 2012 or Windows Server 2012 R2 domain controller in the
domain because the domain schema must be updated to support the operating
system. When you click Next to continue, the wizard doesn’t use Adprep.exe to
extend the schema or update the domain. Instead, the wizard does this during the
installation phase, just before promoting the domain controller.
Note  Keep in mind that if the domain must be prepared, the user credentials are
checked on the Preparation Options page. If the user isn’t a member of the
appropriate groups, you’ll see an error message. In this case, click Change. In the
Windows Security dialog box, provide the user name and password of an account
with sufficient permissions.
17.             On the Review Options page, review the installation options. Optionally,
click View Script to export the settings to a PowerShell script that you can use to
perform automated installation of other domain controllers.
18.             When you click Next, the wizard performs preliminary checks to verify
that the domain is capable of supporting the new domain controller. Any issues
noted must be corrected before you can continue. If you take corrective actions,
click Rerun Prerequisites Checks to rerun the checks and ensure that the changes
you made successfully resolved any issues. The wizard also displays information

about security changes that could affect older operating systems.
19.             When you click Install, the wizard uses the options you selected to install
and configure Active Directory. This process can take several minutes. If the DNS
Server service was selected for installation, the server will also be configured as a
DNS Server at this time.
20.             When the wizard finishes setting up Active Directory, the computer will be
restarted. After the server restarts, Active Directory will be completely configured
and the server can then act as a domain controller in the designated domain.
On a Full Server or Core Server installation of Windows Server, you also can add a new
writeable domain controller using Windows PowerShell. You must be logged on using an
account that is a member of the Domain Admins group in the domain. You create the
additional domain controller using the Install-ADDSDomainController cmdlet. The basic
syntax is:
install-addsdomaincontroller –domainname DomainName
–CreateDNSDelegation –installdns
–SafeModeAdministratorPassword Password
The –DomainName parameter specifies the domain to which the domain controller will be
added. The –SafeModeAdministratorPassword parameter sets the recovery password. The
–CreateDNSDelegation parameter creates a delegation for the domain in DNS, and the –
InstallDNS parameter installs DNS. In the example that follows, you create an additional
domain controller in the imaginedlands.local domain:
install-addsdomaincontroller –domainname imaginedlands.local
–CreateDNSDelegation –installdns –SafeModeAdministratorPassword
(convertto-securestring “Str!F#789” –asplaintext -force)
Note  The recovery password must be provided as a secure string. The example
shows one way of converting a plaintext string to a secure string. The associated –
force parameter allows you to convert to a secure string from plain text.
With writeable domain controllers, the full syntax for Install-ADDSDomainController is:
Install-ADDSDomainController –domainname DomainName
{AddtlParams1} {AddtlParams2}
Install-ADDSDomainController [-UseExistingAccount]
–domainname DomainName {AddtlParams1}
{AddtlParams1}
[-ADPrepCredential Credential] [-ApplicationPartitionsToReplicate Partition1,Partition2,…PartitionN] [-Credential
Credential]
[-CriticalReplicationOnly] [-DatabasePath Path] [-Force]
[-InstallationMediaPath Path]  [-LogPath Path] [-NoDnsOnNetwork]
[-NoRebootOnCompletion] [-ReplicationSourceDC SourceDC]
[-SafeModeAdministratorPassword SecureString]
[-SkipAutoConfigureDns] [-SkipPreChecks]
[-SystemKey SecureString] [-SysvolPath Path]
{AddtlParams2}
[-AllowDomainControllerReinstall] [-CreateDnsDelegation]
[-DnsDelegationCredential PSCredential] [-InstallDns]

[-MoveInfrastructureOperationMasterRoleIfNecessary]
[-NoGlobalCatalog] [-SiteName SiteName]
A script using Install-ADDSDomainController to create an additional domain controller
follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Install-ADDSDomainController `
-NoGlobalCatalog:$false `
-CreateDnsDelegation:$false `
-CriticalReplicationOnly:$false `
-DatabasePath “C:\Windows\NTDS” `
-DomainName “imaginedlands.local” `
-InstallDns:$true `
-LogPath “C:\Windows\NTDS” `
-NoRebootOnCompletion:$false `
-ReplicationSourceDC “CorpServer64.imaginedlands.local” `
-SiteName “Default-First-Site-Name” `
-SysvolPath “C:\Windows\SYSVOL” `
-Force:$true
After installing Active Directory, you should verify the installation. Start by examining the
installation log, which is stored in the Dcpromo.log file in the %SystemRoot%\Debug
folder. The log is very detailed and takes you through every step of the installation
process, including the creation of directory partitions and the securing of the Registry for
Active Directory.
Next, check the DNS configuration in the DNS console. DNS is updated to add SRV and
A records for the domain controller. You may also need to add a reverse lookup zone for
the domain controller.
Check for updates in Active Directory Users and Computers. The Domain Controllers OU
should have an account for the domain controller you installed.
Finally, verify that replication is working as expected. One way to show the replication
status is to enter repadmin /showrepl at a command prompt. You can also verify whether
the domain controller has any incoming replication requests to process. To do this, enter
repadmin /queue at an elevated command prompt.

Adding Writeable Domain Controllers Using Installation Media
Performing an Active Directory installation from media allows the Active Directory
Domain Services Configuration Wizard to get the initial data for the Configuration,
Schema, and Domain directory partitions, and optionally the SYSVOL, from the backup
media rather than through a full synchronization over the network. In this way, you
establish a domain controller using a media backup of another domain controller rather
than using replication over the network. Although not designed to be used to restore failed
domain controllers, this technique does help you rapidly establish additional domain
controllers by reducing the amount of network traffic generated, accelerating the process
of installing an additional domain controller, and getting the directory partition data
synchronized.
When installing Active Directory using a media backup, you’ll want to follow these
guidelines:
Use the most recent media backup to reduce the number of updates that must be
replicated.
Use a backup of a domain controller running the same operating system in the
same domain in which the new domain controller is being created.
Copy the backup to a local drive on the server you are configuring. You cannot
use backup media from Universal Naming Convention (UNC) paths or mapped
drives.
Don’t use backup media that is older than the deleted object lifetime of the
domain. The default value is 60 days. If you try to use backup media older than
the deleted object lifetime, the Active Directory installation will fail.
You can create installation media by completing the following steps:
1.                  Log on to a domain controller. On a writeable domain controller, the
account you use must be a member of the Administrators, Server Operators,
Domain Admins, or Enterprise Admins group. On a read-only domain controller, a
delegated user can create the installation media for another read-only domain
controller.
2.                  Right-click the Windows logo, click Command Prompt, and then click
Command Prompt (Admin)to open an elevated command prompt. At the command
prompt, enter ntdsutil. This starts the Directory Services Management tool.
3.                  At the ntdsutil prompt, enter activate instance ntds. This sets Active
Directory as the directory service instance to work with.
4.                  Enter ifm to access the install from media prompt. Then enter one of the
following commands, where FolderPath is the full path to the folder in which to
store the Active Directory backup media files:
Create Full FolderPath Creates a full writeable installation media backup of
Active Directory. You can use the media to install a writeable domain controller or a
read-only domain controller.
Create RODC FolderPath Creates a read-only installation media backup of
Active Directory. You can use the media to install a read-only domain controller.
The backup media does not contain security credentials, such as passwords.

5.                  Ntdsutil creates snapshots of Active Directory partitions. When it finishes
creating the snapshots, Ntdsutil mounts the snapshots as necessary and then
defragments the media backup of the Active Directory database. The progress of
the defragmentation is shown by percent complete.
6.                  Next, Ntdsutil copies registry data related to Active Directory. When it
finishes this process, Ntdsutil unmounts any snapshots it was working with. The
backup process should complete successfully. If it doesn’t, note and resolve any
issues that prevented successful creation of the backup media, such as the target
disk running out of space or insufficient permissions to copy to the folder path.
7.                  Enter quit at the ifm prompt and then enter quit at the ntdsutil prompt.
8.                  Copy the backup media, including the Active Directory/ntds.dit file, to a
local drive on the server for which you are installing Active Directory.
9.                  On the server you want to make a domain controller, install the AD DS
binaries and then start the Active Directory Domain Services Configuration Wizard.
Follow all the same steps you would if you were adding a domain controller to the
domain without media. After you select additional domain controller installation
options and get past any DNS prompts, you see the Additional Options page. On
this page, select Install From Media, and then enter the folder location of the
backup media files or click the options button to find the backup media files.
10.             You can now complete the rest of the installation as discussed in the section
titled “Adding Writeable Domain Controllers Using Replication” earlier in this
chapter. Continue with the rest of the steps and perform the postinstallation checks
as well.
Real World  Objects that were modified, added, or deleted since the installation media
was created must be replicated. If the installation media was created recently, the amount
of replication that is required should be considerably less than the amount of replication
required otherwise.
The only data that must be fully replicated from another domain controller is the
SYSVOL data. Although you can run Ntdsutil with an option to include the SYSVOL
folder in the installation media, the SYSVOL folder from the installation media cannot
be used because SYSVOL must be absent when the Active Directory Domain Services
server role starts on your server.


Decommissioning Domain Controllers
When you no longer need a domain controller, you can decommission it and remove it
from service. Running the Active Directory Domain Services Configuration Wizard on the
domain controller allows you to remove Active Directory Domain Services and demote
the domain controller to either a stand-alone server or a member server.
The process for removing an additional domain controller is different from the process for
removing the last domain controller. If the domain controller is the last in the domain, it
will become a stand-alone server in a workgroup. Otherwise, if other domain controllers
remain in the domain, the domain controller will become a member server in the domain.

Preparing to Remove Domain Controllers
Before you demote a domain controller, you should determine the functions and roles the
server has in the domain and plan accordingly. With regard to Active Directory Domain
Services, the functions and roles to check for are as follows:
Global catalog server
Don’t accidentally remove the last global catalog server from a domain. If you
remove the last global catalog server from a domain, you will cause serious
problems. Users won’t be able to log on to the domain, and directory search
functions will be impaired. To avoid problems, ensure another global catalog
server is available or designate a new one.
Don’t accidentally remove the last global catalog server from a site. If you remove
the last global catalog server from a site, computers in the site will query a global
catalog server in another site when searching for resources in other domains in the
forest, and a domain controller responding to a user’s logon or authentication
request will need to obtain the required information from a global catalog server in
another site. To avoid problems, ensure another global catalog server is available,
designate a new one, or verify the affected site is connected to other sites with fast,
reliable links.
Determine whether a domain controller is acting as a global catalog server by
entering the following at a Windows PowerShell prompt: get-
addomaincontroller –identity DCName | fl name, is* where DCName is the
name of the domain controller you want to examine. The resulting output lists
whether the domain controller is a global catalog as well as whether the domain
controller is read-only. Alternatively, enter: get-adforest | fl g*. The resulting
output lists all global catalog servers in the current logon forest.
Bridgehead server
Don’t accidentally remove the last preferred bridgehead server from a site. If you
remove the last preferred bridgehead server, intersite replication will stop until you
change the preferred bridgehead server configuration options. You can avoid
problems by (1) removing the preferred bridgehead server designation prior to
demoting the domain controller and thereby allowing Active Directory to select
the bridgehead servers to use, or (2) ensuring one or more additional preferred
bridgehead servers are available.
Determine whether a domain controller is acting as a bridgehead server by
entering the following at a command prompt: repadmin /bridgeheads
site:SiteName where SiteName is the name of the site, such as repadmin
/bridgeheads site:Seattle-First-Site. The resulting output is a list of bridgehead
servers in the specified site. If you omit the site:SiteName value, the details for the
current site are returned.
Operations master
Don’t accidentally demote a domain controller holding a forestwide or
domainwide operations master role. If you remove an operations master without

first transferring the role, Active Directory will try to transfer the role as part of
the demotion process, and the domain controller that ends up holding the role may
not be the one you would have selected.
Determine whether a domain controller is acting as an operations master by
entering the following at a Windows PowerShell prompt: get-
addomaincontroller –identity DCName | ft *roles where DCName is the name
of the domain controller you want to work with. The resulting output lists the
operation master roles for the domain controller, if any. Alternatively, list the
forest-wide role holders by entering get-adforest | fl *master and then list the
domain-wide role holders by entering get-addomain | fl *master.
Note  With Get-ADForest and Get-ADDomain, use the –Identity parameter to
specify a forest or domain to work with. For example, if you wanted to list
domainwide role holders for the ImaginedLands.local domain, you could enter get-
addomain –identity imaginedlands.local | fl *master or simply get-addomain
imaginedlands.local | fl *master.
Before you remove the last domain controller in a domain, you should examine domain
accounts and look for encrypted files and folders. Because the deleted domain will no
longer exist, its accounts and cryptographic keys will no longer be applicable, and this
results in the deletion of all domain accounts and all certificates and cryptographic keys.
You must decrypt any encrypted data on the server, including data stored using the
Encrypting File System (EFS), before removing the last domain controller, or the data will
be permanently inaccessible.
The credentials you need to demote a domain controller depend on the domain controller’s
functions and roles. Keep the following in mind:
To remove the last domain controller from a domain tree or child domain, you
must use an account that is a member of the Enterprise Admins group or be able to
provide credentials for an enterprise administrator account.
To remove the last domain controller in a forest, you must log on to the domain as
Administrator or use an account that is a member of the Domain Admins group.
To remove other domain controllers, you must use an account that is a member of
either the Enterprise Admins or Domain Admins group.

Removing Additional Domain Controllers
Removing an additional domain controller from a domain and removing the last domain
controller from a domain are different processes. You can remove an additional domain
controller from a domain by completing the following steps:
1.                  In Server Manager, click Manage and then click Remove Roles And
Features. This starts the Remove Roles And Features Wizard. If the wizard displays
the Before You Begin page, read the Welcome message and then click Next.
2.                  On the Select Destination Server page, the server pool shows servers
you’ve added for management. Click the server you are demoting and then click
Next.
3.                  On the Remove Server Roles page, clear Active Directory Domain
Services. An additional prompt is displayed warning you about dependent features,
such as Active Directory Administrative Center and other AD DS management
tools. If you click the Remove Features button, the wizard removes the dependent
features as well as Active Directory Domain Services. If you want to keep related
management tools, clear the Remove Management Tools check box and then click
Continue.
4.                  The wizard checks the status of the domain controller in Active Directory.
As the domain controller must be demoted before the AD DS role can be removed,
you see a prompt regarding this, as shown in Figure 3-5. Click Demote This
Domain Controller to start the Active Directory Domain Services Wizard.
FIGURE 3-5 Initiate Active Directory removal.
5.                  When the Active Directory Domain Services Configuration Wizard starts,
you’ll see the Credentials page shown in Figure 3-6. You must be logged on using
an account that is a member of the Domain Admins group to remove an additional
domain controller in a domain. If you are logged on with an account that has
appropriate permissions for uninstalling Active Directory, you can use your current
logged-on credentials. Otherwise, click Change and then use the options in the
Windows Security dialog box to enter the user name and password for an account

that does have the appropriate permissions.
Caution  Although you have the option of forcing the removal of the domain
controller, don’t select this option without reviewing the section of this chapter titled
“Forcing the Removal of Domain Controllers.” As explained in that section, forcing
removal of domain controllers is an action you perform only when you can’t remove
the domain controller using the standard approach.
FIGURE 3-6 Ensure that you have sufficient credentials.
6.                  When you are ready to continue, click Next. The Active Directory Domain
Services Configuration Wizard then examines the Active Directory forest, checking
the credentials you provided and attempting to determine related functions that the
domain controller performs, such as DNS Server and Global Catalog. If additional
functions are found, as shown in Figure 3-7, you must select Proceed With
Removal to continue.
7. Next, you are prompted to enter and confirm the password for the local
Administrator account on the server. You need to enter a password for the local
Administrator account because domain controllers don’t have local accounts but
member or stand-alone servers do, so the local Administrator account will be re-
created as part of the Active Directory removal process. Click Next.

FIGURE 3-7 Note the additional roles that will be removed.
8. On the Review Options page, review your selections. Or click View Script to export
the settings to a PowerShell script that you can use to perform an automated
demotion of other domain controllers. When you click Demote, the wizard uses the
options you selected to demote the domain controller. This process can take several
minutes. The server will be automatically restarted after the demotion so that the
role removal can be performed. Note that if there are updates to other domains in
the forest that have not been replicated, the domain controller replicates these
updates and then the wizard begins the demotion process.
The actions that the Active Directory Domain Services Configuration Wizard performs
depend on whether you are removing an additional domain controller or removing the
last domain controller from a domain. As you are removing an additional domain
controller from a domain, the wizard does the following:
Removes Active Directory and all related services from the server and makes it a
member server in the domain
Changes the computer account type and moves the computer account from the
Domain Controllers container in Active Directory to the Computers container
Transfers any operations master roles from the server to another domain controller
in the domain
Updates DNS to remove the domain controller SRV records
Creates a local Security Accounts Manager (SAM) account database and a local
Administrator account
Real World  When you remove a domain controller, the related server object is
removed from the domain directory partition automatically. However, the server
object representing the retired domain controller in the configuration directory
partition can have child objects and is therefore not removed automatically. For
more information on these objects, refer to “Confirming Removal of Deleted Server

Objects,” later in this chapter.
To remove an additional domain controller from a domain using Windows PowerShell,
you use the Uninstall-ADDSDomainController cmdlet and must be logged on using an
account that is a member of the Domain Admins groups. The basic syntax is:
Uninstall-ADDSDomainController [-Credential Credential]
–DemoteOperationMasterRole -LocalAdministratorPassword SecureString
[-Force]
The –DemoteOperationMasterRole parameter ensures that any operations master roles the
domain controller holds are transferred to another domain controller. The –
LocalAdministratorPassword parameter is used to specify the password for the local
Administrator account.
In the example that follows, you remove a domain controller and display a prompt for the
required password for the local administrator account:
Uninstall-ADDSDomainController –DemoteOperationMasterRole
-LocalAdministratorPassword (read-host –prompt “Recovery
Password:” –assecurestring)
The full syntax for Uninstall-ADDSDomainController is:
Uninstall-ADDSDomainController [-Credential Credential]
[-DemoteOperationMasterRole] [-Force] [-LocalAdministratorPassword
SecureString] [-NoRebootOnCompletion] [-SkipPreChecks] –ForceRemoval
Uninstall-ADDSDomainController [-Credential Credential]
[-DemoteOperationMasterRole] [-DnsDelegationRemovalCredential
Credential] [-Force] [-IgnoreLastDCInDomainMismatch]
[-IgnoreLastDnsServerForZone] [-LastDomainControllerInDomain]
[-LocalAdministratorPassword SecureString] [-NoRebootOnCompletion]
[-RemoveApplicationPartitions] [-RemoveDnsDelegation]
[-RetainDCMetadata] [-SkipPreChecks]
A script using Uninstall-ADDSDomainController to remove a domain controller from a
domain follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Uninstall-ADDSDomainController `
-DemoteOperationMasterRole:$true `
-LocalAdministratorPassword `
(convertto-securestring “Str!F#789” –asplaintext -force) `
-Force:$true

Removing the Last Domain Controller
After you remove the last domain controller in a domain, the affected domain will no
longer exist. Because the deleted domain no longer exists, its accounts and cryptographic
keys are no longer applicable, and this results in the deletion of all domain accounts and
all certificates and cryptographic keys from the server. You must decrypt any encrypted
data on the server, including data stored using the Encrypting File System (EFS), before
removing Active Directory or the data will be permanently inaccessible.
You can remove the last domain controller in a domain or forest by completing the
following steps:
1.                  In Server Manager, click Manage and then click Remove Roles And
Features. This starts the Remove Roles And Features Wizard. If the wizard displays
the Before You Begin page, read the Welcome message and then click Next.
2.                  On the Select Destination Server page, the server pool shows servers
you’ve added for management. Click the server you are demoting and then click
Next.
3.                  On the Remove Server Roles page, clear Active Directory Domain
Services. An additional prompt is displayed warning you about dependent features,
such as Active Directory Administrative Center and other AD DS management
tools. If you click the Remove Features button, the wizard removes the dependent
features as well as Active Directory Domain Services. If you want to keep related
management tools, clear the Remove Management Tools check box and then click
Continue.
4.                  The wizard checks the status of the domain controller in Active Directory.
As the domain controller must be demoted before the AD DS role can be removed,
you see a prompt regarding this, as shown in Figure 3-8. Click Demote This
Domain Controller to start the Active Directory Domain Services Wizard.
FIGURE 3-8 Start the Active Directory removal.
5.                  When the Active Directory Domain Services Configuration Wizard starts,

you’ll see the Credentials page shown in Figure 3-9. You must be logged on using
an account that is a member of the Enterprise Admins group to remove the last
domain controller from a domain. If you are logged on with an account that has
appropriate permissions for uninstalling Active Directory, you can use your current
logged-on credentials. Otherwise, click Change and then use the options in the
Windows Security dialog box to enter the user name and password for an account
that does have the appropriate permissions.
6.                  As part of its preliminary checks, the wizard tries to contact other domain
controllers in the domain. As you are removing the last domain controller, no other
domain controllers are available in the domain. You must select Last Domain
Controller In The Domain to clear the warning and allow the wizard to proceed
with the removal.
FIGURE 3-9 Ensure that you have sufficient credentials.
Caution  Although you have the option of forcing the removal of the domain
controller, don’t select this option without reviewing the section of this chapter titled
“Forcing the Removal of Domain Controllers.” As explained in that section, forcing
removal of domain controllers is an action you perform only when you can’t remove
the domain controller using the standard approach.
7.                  When you are ready to continue, click Next. The Active Directory Domain
Services Configuration Wizard then examines the Active Directory forest, checking
the credentials you provided and attempting to determine related functions that the
domain controller performs, such as DNS Server and Global Catalog. If additional
functions are found, as shown in Figure 3-10, you must select Proceed With
Removal to continue.

FIGURE 3-10 Related roles being hosted must be removed.
8.                  On the Removal Options page, you have several additional removal
options. If this domain controller is also hosting the last DNS Server for the zone,
you must select Remove This DNS Zone to force the removal of DNS Server. The
wizard also checks DNS to see if any zone delegations for the server need to be
removed. If so, the delegations for the server will be removed during the demotion
process.
9.                  Any domain controller hosting DNS server will also have application
partitions. If the application partitions are the last replicas in the domain, you must
select Remove Application Partitions to force removal of the partitions. Click View
Partitions to confirm which application partitions will be deleted.
Note  If the domain controller is also a DNS server, the DNS data in the
ForestDnsZones and DomainDnsZones partitions is removed. If the domain controller is
the last DNS server in the domain, this results in the last replica of the DNS information
being removed from the domain. All associated DNS records are lost and might need to
be re-created.
Real World  DNS Server isn’t the only application that stores data in Active Directory.
If other applications have stored data in the directory on the server and you want to retain
their application partitions, you will need to use the application that created the partition
to extract and save the partition data as appropriate. If the application does not provide
such a tool, you may want to reconsider demoting the domain controller.
9. Next, you are prompted to enter and confirm the password for the local
Administrator account on the server. You need to enter a password for the local
Administrator account because domain controllers don’t have local accounts but
member or stand-alone servers do, so the local Administrator account will be re-
created as part of the Active Directory removal process. Click Next.
10. On the Review Options page, review your selections. Or click View Script to export

the settings to a PowerShell script that you can use to perform an automated
demotion of other domain controllers. When you click Demote, the wizard uses the
options you selected to demote the domain controller and remove the domain. This
process can take several minutes. The server will be automatically restarted after
the demotion so that the role removal can be performed Note that if there are
updates to other domains in the forest that have not been replicated, the domain
controller replicates these updates and then the wizard begins the demotion process.
As you are removing the last domain controller from a domain, the wizard verifies that
there are no child domains of the current domain before performing the removal operation.
If child domains are found, removal of Active Directory fails, with an error telling you
that you cannot remove Active Directory.
When the domain being removed is a child domain, the wizard notifies a domain
controller in the parent domain that the child domain is being removed. For a parent
domain in its own tree, a domain controller in the forest root domain is notified. Either
way, the domain object is tombstoned or logically deleted, and this change is then
replicated to other domain controllers. The domain object and any related trust objects are
also removed from the forest.
As part of removing Active Directory from the last domain controller in a domain, all
domain accounts, all certificates, and all cryptographic keys are removed from the server.
The wizard creates a local SAM account database and a local Administrator account. It
then changes the computer account type to a stand-alone server and puts the server in a
new workgroup.
To remove the last domain controller from a domain using Windows PowerShell, you use
the Uninstall-ADDSDomainController cmdlet and must be logged on using an account
that is a member of the Enterprise Admins groups. The basic syntax is:
Uninstall-ADDSDomainController –DemoteOperationMasterRole
-IgnoreLastDnsServerForZone –LastDomainControllerInDomain
-LocalAdministratorPassword SecureString
-RemoveApplicationPartitions –Force
When you are working with the last domain controller, these parameters do the following:
–DemoteOperationMasterRole allows the domain controller to be removed even
though it holds operations master roles.
–IgnoreLastDnsServerForZone allows DNS Server to be removed even if the
domain controller is the last DNS server for the zone.
–LastDomainControllerInDomain allows the domain controller to be removed
even though it is the last in the domain.
–RemoveApplicationPartitions ensures any application partitions are removed
when the domain controller is demoted.
In the example that follows, you remove the last domain controller from a domain and set
a new password for the local administrator account:
Uninstall-ADDSDomainController –DemoteOperationMasterRole
-IgnoreLastDnsServerForZone –LastDomainControllerInDomain
-LocalAdministratorPassword (convertto-securestring “Str!F#789”
–asplaintext) -RemoveApplicationPartitions –Force -force)

As stated previously, the full syntax for Uninstall-ADDSDomainController is:
Uninstall-ADDSDomainController [-Credential Credential]
[-DemoteOperationMasterRole] [-DnsDelegationRemovalCredential
Credential] [-Force] [-IgnoreLastDCInDomainMismatch]
[-IgnoreLastDnsServerForZone] [-LastDomainControllerInDomain]
[-LocalAdministratorPassword SecureString] [-NoRebootOnCompletion]
[-RemoveApplicationPartitions] [-RemoveDnsDelegation]
[-RetainDCMetadata] [-SkipPreChecks]
A script using Uninstall-ADDSDomainController to remove the last domain controller
from a domain follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Uninstall-ADDSDomainController `
-DemoteOperationMasterRole:$true `
-IgnoreLastDnsServerForZone:$true `
–LastDomainControllerInDomain:$true `
-RemoveApplicationPartitions:$true `
-IgnoreLastDCInDomainMismatch:$true `
-LocalAdministratorPassword `
(convertto-securestring “Str!F#789” –asplaintext -force) `
-Force:$true


Forcing the Removal of Domain Controllers
A domain controller must have connectivity to other domain controllers in the domain or
forest in order to demote the domain controller and successfully remove Active Directory
Domain Services. If a domain controller has no connectivity to other domain controllers,
the standard removal process will fail, and you will need to connect the domain controller
to the domain and then restart the removal process. In a limited number of situations,
however, you might not want or be able to connect the domain controller to the domain
and instead might want to force the removal of the domain controller. For example, if the
domain controller has failed and is not coming back or if the domain controller is
corrupted and cannot be demoted in any other way.
Forcing the removal of a domain controller is a three-part process. You must:
1.                  Stop Active Directory Domain Services or restart the domain controller in
Directory Services Restore Mode.
2.                  Perform the forced removal of the domain controller.
3.                  Clean up the Active Directory forest metadata.
These tasks are discussed in the sections that follow.

Stopping Active Directory Domain Services
Although an option, you don’t need to restart a domain controller in Directory Services
Restore Mode to force removal of Active Directory. Instead, you can simply stop Active
Directory Domain Services. The easiest way to stop AD DS is to enter the following at a
PowerShell prompt:
stop-service ntds -force
NTDS is the name of the service. The –force parameter is required because NTDS has
dependent services that must also be stopped, including Kerberos Key Distribution Center,
Intersite Messaging, DNS Server and DFS Replication.
You also can stop AD DS by completing the following steps:
1.                  On the Tools menu in Server Manager, select Services.
2.                  In the Services console, right-click Active Directory Domain Services and
then select Stop.
3.                  When prompted to stop dependent services as well, click Yes.
Note  Normally, you can’t remove AD DS from a domain controller while AD DS
is stopped. However, here you are planning to forcefully remove AD DS.

Restarting a Domain Controller in Directory Services Restore Mode
Before you can forcibly remove Active Directory Domain Services, you must restart the
domain controller in Directory Services Restore Mode. Restarting in this mode takes the
domain controller offline, meaning it functions as a member server, not as a domain
controller. During installation of Active Directory Domain Services, you set the
Administrator password for logging on to the server in Directory Services Restore Mode.
You can restart a domain controller in Directory Services Restore Mode manually by
pressing the F8 key during domain controller startup. You must then log on by using the
Directory Services Restore Mode password for the local Administrator account. A
disadvantage of this technique is that if you accidentally restart the domain controller, you
might forget to put it back into Directory Services Restore Mode.
To ensure the domain controller is in Directory Services Restore Mode until you specify
otherwise, you can use the System Configuration utility or the Boot Configuration Data
(BCD) editor to set a Directory Repair flag. Once this flag is set, the domain controller
will always start in Directory Services Restore Mode, and you can be sure that you won’t
accidentally restart the domain controller in another mode.
Real World  A unique password is required to start a domain controller in
Directory Services Restore Mode. If you don’t know the restore mode administrator
password, you can change it, provided you have domain administrator privileges. To
change the password, follow these steps:
1. Open an elevated, administrator command prompt.
2. At the command prompt, enter ntdsutil.
3. At the ntdsutil prompt, enter set dsrm password.
4. At the Reset DSRM Administrator Password prompt, enter reset password on
server ServerName, where ServerName is the name of the domain controller on
which you want to reset the DSRM administrator password.
5. Enter the new restore mode administrator password.
6. Confirm the new administrator password by entering it again.
7. Enter quit twice to exit ntdsutil.
To restart a domain controller in Directory Services Restore Mode using the System
Configuration utility, complete the following steps:
1.                  On the Tools menu in Server Manager, click System Configuration.
2.                  On the Boot tab, in Boot Options, select Safe Boot, and then click Active
Directory Repair, as shown in Figure 3-11.
3.                  Click OK to exit the System Configuration utility and save your settings.
4.                  Restart the domain controller. The domain controller restarts in Directory
Services Restore Mode. Log on using the local admininistrator account and the
restore mode password.
When you have finished performing procedures in Directory Services Restore Mode,

restart the domain controller in normal mode by completing the following steps:
1.                  On the Tools menu in Server Manager, click System Configuration.
2.                  On the General tab, in Startup Selection, click Normal Startup, and then
click OK.
3.                  The domain controller restarts in normal mode.
FIGURE 3-11 Change the boot options.
To restart a domain controller in Directory Services Restore Mode using the BCD editor,
complete the following steps:
1.                  Right-click the Windows logo, and then click Command Prompt (Admin)
to open an elevated command prompt.
2.                  At the command prompt, enter the following command: bcdedit /set
safeboot disrepair. This configures the boot process to start in Directory Services
Restore Mode.
3.                  At the command prompt, enter the following command: shutdown -t 0 -r.
This shuts down the server and restarts it without delay.
4.                  When the server restarts, logon as the administrator, using the password
for Directory Services Restore Mode.
Tip  If you are working remotely with a Remote Desktop connection, you won’t be
able to use your saved credentials. Start the Remote Desktop Connection client and
then click Options. In the User Name box, type .\Administrator to specify that you
want to logon using the credentials of the local administrator account on the server
to which you are connecting, and then click Connect. When you are prompted for
the account credentials, enter the password for Directory Services Restore Mode.
When you have finished performing procedures in Directory Services Restore Mode,
restart the domain controller in normal mode by completing the following steps:
1.                  Right-click the Windows logo, and then click Command Prompt(Admin)
to open an elevated command prompt.

2.                  At the command prompt, you need to enter the following command:
bcdedit /deletevalue safeboot. This deletes the safeboot value and returns the boot
process to the previous setting.
3.                  At the command prompt, enter the following command: shutdown -t 0 -r.
This shuts down the server and restarts it without delay.

Performing Forced Removal of Domain Controllers
You can force the removal of a domain controller by completing the following steps:
1.                  In Server Manager, click Manage and then click Remove Roles And
Features. This starts the Remove Roles And Features Wizard. If the wizard displays
the Before You Begin page, read the Welcome message and then click Next.
2.                  On the Select Destination Server page, the server pool shows servers
you’ve added for management. Click the server you are demoting and then click
Next.
3.                  On the Remove Server Roles page, clear Active Directory Domain
Services. An additional prompt is displayed warning you about dependent features,
such as Active Directory Administrative Center and other AD DS management
tools. If you click the Remove Features button, the wizard removes the dependent
features as well as Active Directory Domain Services. If you want to keep related
management tools, clear the Remove Management Tools check box and then click
Continue.
4.                  The wizard checks the status of the domain controller in Active Directory.
As the domain controller must be demoted before the AD DS role can be removed,
you see a prompt regarding this. Click Demote This Domain Controller to start the
Active Directory Domain Services Wizard.
5.                  As part of its preliminary checks, the wizard tries to verify your current
credentials. As shown in Figure 3-12, this verification will fail (because you are
logged on as the local administrator and using Directory Services Restore Mode).
Select Force The Removal Of This Domain Controller and then click Next.
FIGURE 3-12 Confirm that you want to force the removal of the domain controller.
6.                  You are prompted to enter and confirm the password for the local
Administrator account on the server. Type a password for the local Administrator
account which will be re-created as part of the Active Directory removal process.

Click Next.
7.                  On the Review Options page, shown in Figure 3-13, the wizard confirms
that you are removing Active Directory Domain Services from the server without
updating forest metadata. When you click Demote, the wizard uses the options you
selected to demote the domain controller. This process can take several minutes.
The server will be automatically restarted after the demotion so that the role
removal can be completed.
FIGURE 3-13 Complete the demotion of the domain controller.
When forcibly removing a domain controller from a domain, the Active Directory Domain
Services Configuration Wizard does the following:
Removes Active Directory and all related services from the server
Changes the computer account type
Creates a local Security Accounts Manager (SAM) account database and a local
Administrator account
To force the removal of a domain controller using Windows PowerShell, you use a special
syntax of the Uninstall-ADDSDomainController cmdlet. That syntax is:
Uninstall-ADDSDomainController [-Credential Credential]
[-DemoteOperationMasterRole] -Force [-LocalAdministratorPassword
SecureString] [-NoRebootOnCompletion] [-SkipPreChecks] –ForceRemoval
The –Force parameter suppresses any warnings that would normally be displayed. The –
ForceRemoval parameter specifies that you want to remove the domain controller without
updating forest metadata.
In the example that follows, you force the removal a domain controller and display a
prompt for the required password for the local administrator account:
Uninstall-ADDSDomainController -ForceRemoval -Force
-LocalAdministratorPassword (read-host –prompt “Recovery
Password:” –assecurestring)

A script using Uninstall-ADDSDomainController to remove a domain controller from a
domain follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Uninstall-ADDSDomainController `
-ForceRemoval:$true `
-Force:$true

Cleaning Up Metadata in the Active Directory Forest
When you force the removal of a disconnected domain controller, the Active Directory
forest metadata is not updated automatically as it is when a domain controller is removed
normally. Because of this, you must manually update the forest metadata after you remove
the domain controller.
You perform metadata cleanup on a domain controller in the domain of the domain
controller that you forcibly removed. During metadata cleanup, Active Directory
automatically performs the following tasks:
Removes data from the directory that identifies the retired domain controller to the
replication system
Removes any related Distributed File System (DFS) Replication connections
Attempts to transfer or seize any operations master roles that the retired domain
controller holds
Cleaning Up Server Metadata
On domain controllers that are running Windows Server 2012 or Windows Server 2012
R2, you can use Active Directory Users and Computers to clean up server metadata.
Deleting the computer object in the Domain Controllers organizational unit (OU) initiates
the cleanup process, and all related tasks are performed automatically. Using Active
Directory Users and Computers, you can clean up metadata by completing the following
steps:
1.                  You must be logged on using an account that is a member of Domain
Admins. Open Active Directory Users and Computers by clicking Active Directory
Users And Computers in the Tools menu in Server Manager.
2.                  You must be connected to a domain controller in the domain of the domain
controller that you forcibly removed. If you aren’t or are unsure, right-click the
Active Directory Users And Computers node and then click Change Domain
Controller. In the Change Directory Server dialog box, you’ll then see the fully
qualified name of the current directory server, such as
CorpServer64.imaginedlands.local. If you want to connect to another domain
controller, under Change To, select This Domain Controller and then select the
name of a domain controller to which you want to connect. Click OK.
Note  When you right-click the Active Directory Users And Computers node, you
also have the option of selecting Change Domain. Use this option to connect to a
different domain in the current forest.
3.                  Expand the domain of the domain controller that you forcibly removed,
and then click Domain Controllers.
4.                  In the details pane, right-click the computer object of the retired domain
controller, and then click Delete.
5.                  You’ll see a warning message that you are attempting to delete a domain
controller without running the removal wizard. Select the Delete This Domain
Controller Anyway checkbox, and then click Delete.

6.                  If the domain controller was a global catalog server, in the Deleting
Domain Controller dialog box, click Yes to continue with the deletion.
7.                  If the domain controller currently holds one or more operations master
roles, click OK to move the role or roles to the domain controller that is shown.
Although you cannot change this domain controller at the present time, you can
move the role once the metadata cleanup procedure is completed.
You also can perform metadata cleanup by using the Ntdsutil command-line tool. Using
Ntdsutil, you can clean up server metadata by completing the following steps:
1.                  Open an elevated command prompt. One way to do thisis by right-clicking
the Windows logo, and then clicking Command Prompt (Admin).
2.                  At the command prompt, enter the following command: ntdsutil.
3.                  At the ntdsutil prompt, enter the following command: metadata cleanup.
4.                  At the metadata cleanup prompt, enter the following command if you are
logged on to the domain of the domain controller that you forcibly removed:
remove selected server RetiredServer where RetiredServer is the distinguished
name of the retired domain controller. Otherwise, enter the following command:
remove selected server RetiredServer on TargetServer where RetiredServer is the
distinguished name of the retired domain controller and where TargetServer is the
DNS name of a domain controller in the domain of the domain controller that you
forcibly removed.
Real World  This process initiates removal of objects that refer to the retired
domain controller and then removes those objects from a specified server. Once the
changes are replicated, the related objects will be removed throughout the Active
Directory forest. You must identify the retired server by its distinguished name, such
as “CN=CorpServer27,OU=Domain Controllers,DC=imaginedlands,DC=local”. If
you specify a target server, you must use the DNS name of the domain controller to
which you want to connect, such as “CorpServer27.Imaginedlands.local”. If you do
not specify a target server, the objects are removed from the domain controller to
which you are currently connected.
5.                  When prompted with the Server Remove Configuration dialog box, read
the details provided. Click Yes to remove the server object and related metadata.
Ntdsutil will then confirm that the server object and related metadata was removed
successfully. If you receive an error message that indicates that the object cannot be
found, the server object and related metadata might have been removed previously.
6.                  At the metadata cleanup prompt, enter the following command: quit.
7.                  At the ntdsutil prompt, enter the following command: quit.
Cleaning Up DNS Records
When you demote a domain controller using the standard technique, all DNS records are
removed from DNS automatically. However, this is not the case when you force removal
of a domain controller. To clean up DNS records, you need to remove all A, PTR, SRV
and CNAME records for the server from DNS. Specifically, you must:
Delete the A and PTR record from the DNS zone for which the server was a

domain controller.
Delete the A record for the domain for which the server was a domain controller.
Delete all SRV records for the domain controller in the originating zone and the
zone of the root domain.
Delete the CNAME record for the domain controller.
Delete the A record from the gc._msdcs.<FQDN> DNS zone of the root domain if
the domain controller was a global catalog.
Be sure to include SRV records that designate the computer as a domain controller and any
additional records that designate the computer as a global catalog server or PDC emulator,
if applicable.
Confirming Removal of Deleted Server Objects
When you remove a domain controller, the related server object is removed from the
domain directory partition automatically. You can confirm this using Active Directory
Users and Computers. However, the server object representing the retired domain
controller in the configuration directory partition can have child objects and is therefore
not removed automatically. You can confirm the status of the server object in the
configuration directory partition by using Active Directory Sites And Services.
You can confirm removal of server objects for a retired domain controller by completing
the following steps:
1.                  Open Active Directory Users and Computers by clicking Active Directory
Users And Computers on the Tools menu in Server Manager.
2.                  Expand the domain of the domain controller that you forcibly removed,
and then click Domain Controllers.
3.                  In the details pane, the computer object of the retired domain controller
should not appear. If it does, follow the steps in “Cleaning Up Server Metadata,”
earlier in this chapter, to remove the object using Active Directory Users and
Computers.
4.                  Open Active Directory Sites and Services by clicking Active Directory
Sites And Services on the Tools menu in Server Manager.
5.                  Any domain controllers associated with a site are listed in the site’s
Servers node. Select the site that the retired domain controller was previously
associated with and then expand the related Servers node.
6.                  Confirm that the server object for the retired domain controller does not
contain an NTDS Settings object. If no child objects appear below the server object,
you can delete the server object. Right-click the server object and then click Delete.
When prompted to confirm, click Yes.
Real World  Do not delete the server object if it has a child object. If an NTDS
Settings object appears below the server object, either replication on the domain
controller on which you are viewing the configuration container has not occurred or
the domain controller was not properly decommissioned. If a child object other than
NTDS Settings is listed, another application has published the object. You must
contact the appropriate application administrator and determine the required actions

to remove the child object.


Chapter 4. Deploying Read-Only Domain Controllers
Active Directory supports both writeable and read-only domain controllers. Writeable
domain controllers are the primary type of domain controllers you will use throughout the
enterprise. Read-only domain controllers (RODCs) host read-only replicas of a domain’s
Active Directory database and are designed to be placed in locations that require fast and
reliable authentication services but aren’t necessarily secure. As such, RODCs are ideally
suited to the needs of branch offices where a domain controller’s physical security cannot
be guaranteed.
Before you deploy RODCs in an Active Directory forest, you must perform some
preliminary tasks. These tasks include preparing the forest schema to use RODCs and
ensuring your writeable domain controllers are running the appropriate operating systems.
Because RODCs are managed differently than writeable domain controllers, there are
some administrative tasks that apply only to RODCs. Therefore in addition to detailing
how to add and remove RODCs, I discuss the unique tasks you’ll use to maintain RODCs.


Preparing to Deploy Read-Only Domain Controllers
Only computers running Windows Server can act as read-only domain controllers.
Typically, you do not need to make any changes to client computers to allow them to use
an RODC. Client computers running any current Windows and Windows Servers
operating systems are supported for use with RODCs.
RODCs support the same features as writeable domain controllers and can be used in both
Core Server and Full Server installations. RODCs by default do not store passwords or
credentials other than for their own computer accounts and the Kerberos Ticket Granting
Target (krbtgt) accounts. Instead, RODCs pull user and computer credentials from a
writeable domain controller. You must explicitly allow any other credentials to be cached
on an RODC by using Password Replication Policy.
Tip  After an RODC has cached the password for a user, it remains in the Active
Directory database until the user changes the password or the Password Replication
Policy for the RODC changes such that the user’s password should no longer be
cached. Accounts that will not have credentials cached on the RODC can still use
the RODC for domain logon. The RODC retrieves the credentials from its writeable
domain controller replication partner. The credentials, however, will not be cached
for subsequent logons using the RODC.
Except for passwords and designated, nonreplicated attributes, RODCs store the same
objects and attributes as writeable domain controllers. These objects and attributes are
replicated to RODCs using unidirectional replication from a writeable domain controller
acting as a replication partner.
Although Active Directory clients and applications can access the directory to read data,
the clients are not able to write changes directly to an RODC. Clients and applications that
need to write changes are referred to a writeable domain controller. This prevents changes
made by malicious users at branch locations from corrupting the Active Directory forest.
RODCs can host a global catalog but cannot act as bridgehead servers or as operations
master role holders. On an RODC, you can install the Domain Name System (DNS)
Server service. If you do, the RODC receives a read-only replica of all application
directory partitions that are used by DNS, including ForestDNSZones and
DomainDNSZones. Clients and applications can then query DNS on the RODC for name
resolution as they would query any other DNS server. As with Active Directory data, the
DNS server on an RODC does not support direct updates. Clients and applications that
need to make updates to DNS are referred to a writeable DNS server.
Because no changes are written directly to RODCs, replication is unidirectional, and
writeable domain controllers acting as replication partners do not have to pull changes
from RODCs. This reduces the workload of bridgehead servers and the scope of your
replication monitoring efforts. RODCs reduce the administration burden on the enterprise
by allowing any domain user to be delegated as a local administrator without granting any
other rights in the domain. This creates a clear separation between domain administrators
and delegated administrator users at branch offices.
RODCs are designed to be placed in sites that have no other domain controllers. Although

you cannot place RODCs from the same domain in the same site, you can
Place an RODC in the same site with writeable domain controllers from the same
domain.
Place an RODC in the same site with writeable domain controllers from different
domains.
Place RODCs from different domains in the same site.
You can install an RODC only in an existing domain. Before you install RODCs in any
domain, you must ensure at least one domain controller for the same domain must be
located in the site closest to the site that includes the RODC. To ensure the RODC can
replicate all directory partitions, this domain controller must be a global catalog server.
You also must ensure there is a bidirectional communications path open between the
RODC and the PDC emulator.
Like writeable domain controllers, RODCs have no local accounts or separate
cryptographic keys. Making a server a domain controller deletes all local accounts and all
certificates and cryptographic keys from the server. Any encrypted data on the server,
including data stored using the Encrypting File System (EFS), must be decrypted before
Active Directory is installed, or the data will be permanently inaccessible.
Because of this, you should examine local accounts to determine whether you need to take
special steps to preserve any local accounts before you install Active Directory Domain
Services. You should also check for encrypted files and folders.
To run the DNS Server service on an RODC, another domain controller must be running
in the domain and hosting the primary or Active Directory–integrated DNS domain zone.
A standard or Active Directory–integrated DNS zone on an RODC is always a read-only
copy of the zone file.
Finally, if you haven’t previously prepared the domain for RODCs, you must run the
adprep /rodcprep command. This ensures RODCs can replicate DNS partitions. You
only need to do this once ever for a domain. This is not required for new forests, or when
you are not using Active Directory–integrated DNS in the existing forest.


Understanding RODC Installation Options
You can install an RODC as an additional domain controller in a domain using a standard
deployment or a staged deployment. Both approaches allow you to, you can configure
Password Replication Policy, delegate administrative permissions, and install from media.
Password Replication Policy controls whether passwords are replicated to the RODC that
you are installing. As discussed in “Setting Password Replication Policy” later in this
chapter, you can configure denied accounts, for which passwords are never replicated, and
allowed accounts, for which passwords are always replicated.
Through delegation of administrative permissions, you allow a specified user or group to
act as the local administrator of the RODC while granting no other administrative
permissions in the domain. For ease of administration, you should create a new group for
this purpose before deploying an RODC. (For more information, see “Delegating
Administrative Permissions” later in this chapter.)
When you install from media, the RODC can get the required directory data from media
you previously created rather than from a full synchronization of directory data over the
network, which reduces directory-replication traffic over the network. You must create the
media before installing the RODC. Follow the technique discussed in “Adding Writeable
Domain Controllers Using Installation Media” in Chapter 3, “Deploying Writeable
Domain Controllers.”
You use the same technique as for writeable domain controllers to create installation
media for read-only domain controllers. In step 4, instead of entering create full, enter
create rodc. Because you’re creating installation media for an RODC, passwords are not
included in the data.
You can add an RODC to a domain by using a nonstaged or staged installation. When you
plan to deliver a ready-to-use RODC to a branch office or a single person is installing the
RODC in the branch office, you’ll typically want to use a nonstaged installation. With a
nonstaged installation, an administrator with domainwide administrative credentials
completes the entire installation process as with writeable domain controllers.
Staged installations are completed in two stages. In stage one, an administrator with
domainwide administrative credentials creates an account for the RODC in Active
Directory. In stage two, a delegated user installs the RODC. When two different people
are installing an RODC, you’ll want to use a staged installation.


Adding RODCs Without Staging
After you complete any necessary preliminary tasks, you can add an RODC to a domain
by using a nonstaged installation by completing the following steps:
1.                  Check the TCP/IP configuration of the server. The server must have a valid
IP address and must have properly configured DNS settings. To ensure reliable
DNS operations, domain controllers that also act as DNS servers should not have
dynamic IP addresses. Otherwise, the server can have a static IP address or a
dynamic IP address assigned by a DHCP server.
2.                  Install the Active Directory binaries by entering the following command at
an elevated Windows PowerShell prompt: Install-WindowsFeature AD-
DomainServices –IncludeManagementTools. Installing the AD DS binaries
enables the Active Directory Domain Services role on the server. You also can
install the AD DS binaries using the Add Roles And Features option in Server
Manager. See “Installing the AD DS Binaries” in Chapter 2 for more information.
3.                  Start the Active Directory Domain Services Configuration Wizard by
clicking the Notifications icon in Server Manager and then clicking Promote This
Server To A Domain Controller.
4.                  On the Deployment Configuration page, shown in Figure 4-1, Choose Add
A Domain Controller To An Existing Domain. By choosing this option, you specify
that you are adding a domain controller to an existing domain in the Active
Directory forest.
FIGURE 4-1 Specify that you want to add a domain controller to the domain.
5.                  Next, in the domain box, specify the domain to which the domain
controller will be added. The logon domain of the current user is listed by default.
To add the domain controller to a different domain, type the name of the domain.
Alternatively, click Select, choose the domain from a list of domains provided and
then click OK.

6.                  If you are logged on using an account is a member of the Domain Admins
group in the target domain, you can use your current logged-on credentials to
perform the installation. Otherwise, select Change, enter the user name and
password for an account that is a member of the Domain Admins group, and then
click OK.
7.                  When you click Next, the wizard checks the forest configuration and
attempts to contact a domain controller in the target domain. If a logon error occurs,
you may have specified an invalid account or account password and will need to
correct the credential settings. The wizard also won’t be able to log onto the domain
if the name you provide is invalid or if a domain controller in the domain cannot be
contacted. Thus, one way you might be able to resolve this problem is by entering
the correct name of the domain that you want to work with. You might also be able
to resolve the problem by checking and correcting the TCP/IP configuration of the
server you are trying to promote. At a minimum, the server should have a valid
IPv4 address and a preferred DNS server—both of which can be either statically or
dynamically assigned. If the TCP/IPv4 settings are correct, you’ll need to examine
the _ldap SRV records for the _tcp zone on the authoritative DNS server. Ensure
these records and the corresponding A records are properly configured.
8.                  On the Domain Controller Options page, shown in Figure 4-2, select the
Read-Only Domain Controller (RODC) check box as an additional installation
option for the domain controller. If you want the RODC to act as a read-only DNS
server, select the DNS Server check box. If you want the RODC to act as a global
catalog, select the Global Catalog check box.
FIGURE 4-2 Select Read-Only Domain Controller (RODC) as an option.
Note  If you choose to let the wizard install the DNS Server service, note that the
DNS Server service will be installed, and the RODC will also act as a DNS server
with a read-only replica of all application directory partitions that are used by DNS,
including ForestDNSZones and DomainDNSZones. The wizard will also update the

server’s TCP/IP configuration so that its DNS server is set to itself (using the local
loopback addresses 127.0.0.1 for IPv4 and ::1 for IPv6). If you’ve already entered a
primary DNS server, the alternate DNS server points to the server itself.
9.                  If there is a site that corresponds to the IP address of the server you are
promoting, this site is selected automatically on the Site Name list. If you want to
place the new domain controller in a different site or there isn’t an available subnet
for the current IP address, select the site in which you want to locate the domain
controller. After setup, you can move the domain controller to a new site at any
time.
10.             Type and confirm the password that should be used when you want to start
the computer in Directory Services Restore mode. Be sure to track this password
carefully. This special password is used only in Restore mode and is different from
the Administrator account password. The password complexity and length must
comply with the domain security policy. Click Next to continue.
11.             On the RODC Options page, shown in Figure 4-3, configure the initial
delegation settings. Click Select, use the Select User Or Group dialog box to
specify a delegated user or group, and then click OK. The delegated user or group
will have local administrative permissions on the RODC. (For more information,
see “Delegating Administrative Permissions” later in this chapter.)
FIGURE 4-3 Configure the RODC options.
12.             By default, only accounts that are members of the Allowed RODC
Password Replication Group are allowed to have their passwords replicate to the
RODC. As this group has no members initially, this means no account passwords
are replicated to the RODC. Although it is a best practice to manage accounts with
allowed passwords by adding them to or removing them from the Allowed RODC
Password Replication Group using Active Directory Users And Computers, you
can explicitly allow accounts using the related Add option. (For more information,
see “Setting Password Replication Policy” later in this chapter.)

13.             By default, security-sensitive accounts (such as members of the
Administrators, Account Operators, Server Operators and Backup Operators
groups) are explicitly denied from ever having their passwords replicated to the
RODC. Additionally, accounts that are members of the Denied RODC Password
Replication Group are denied from having their passwords replicate to the RODC.
As this group has no members initially, this means no other accounts are restricted.
Although it is a best practice to manage accounts with denied passwords by adding
them to or removing them from the Denied RODC Password Replication Group
using Active Directory Users And Computers, you can explicitly deny accounts
using the related Add option.
14.             Click Next when you are ready to continue. On the Additional Options
page, shown in Figure 4-4, you’ll be able to specify whether you want to replicate
over the network or use installation media. If you don’t want to install from media,
use the default selection to allow data to replicate over the network. If you want to
install from media, select Install From Media and then enter the relevant folder path
in the Location box. Alternatively, click the options button and then use the Browse
For Folder dialog box to locate the folder to use. Keep in mind the folder you
specify must be on one of the server’s local hard drives and must contain the Active
Directory\ntds.dit file.
FIGURE 4-4 Specify whether you are installing through replication or by using media.
Tip  You can let the wizard choose a replication partner for the installation of the
RODC or select a desired replication partner for the installation. When you install an
RODC and do not use installation media, all directory data is replicated from the
replication partner to the domain controller you are installing. Because this can be a
considerable amount of data, you typically want to ensure that both domain
controllers are located in the same site or connected over reliable, high-speed
networks. On the other hand, when you install from media, the RODC replicates
only the changes or the missing data over the network from the replication partner.

15.             Click Next when you are ready to continue. On the Paths page, select a
location to store the Active Directory database folder, log folder, and SYSVOL
folder. The default location for the database and log folders is a subfolder of
%SystemRoot%\NTDS. The default location for the SYSVOL folder is
%SystemRoot%\Sysvol. You’ll get better performance if the database and log
folders are on two separate volumes, each on a separate disk. Placement of the
SYSVOL folder is less critical, and you can accept the default in most cases.
Although you can change the storage locations later, the process is lengthy and
complex.
16.             If Active Directory schema for the domain must be updated for RODCs,
you’ll see the Preparation Options page. You see this page when you are installing
the first RODC in the domain because the domain schema must be updated to
support RODCs. When you click Next to continue, the wizard doesn’t use
Adprep.exe to extend the schema or update the domain. Instead, the wizard does
this during the installation phase, just before promoting the domain controller.
Note  Keep in mind that if the domain must be prepared, the user credentials are
checked on the Preparation Options page. If the user isn’t a member of the
appropriate groups, you’ll see an error message. In this case, click Change. In the
Windows Security dialog box, provide the user name and password of an account
with sufficient permissions.
17.             On the Review Options page, review the installation options. Optionally,
click View Script to export the settings to a PowerShell script that you can use to
perform automated installation of other domain controllers.
18.             When you click Next, the wizard performs preliminary checks to verify
that the domain is capable of supporting the new domain controller (see Figure 4-
5). Any issues noted must be corrected before you can continue. If you take
corrective actions, click Rerun Prerequisites Checks to rerun the checks and ensure
that the changes you made successfully resolved any issues. The wizard also
displays information about security changes that could affect older operating
systems.
19.             When you click Install, the wizard uses the options you selected to install
and configure Active Directory. This process can take several minutes. If the DNS
Server service was selected for installation, the server will also be configured as a
DNS Server at this time.
20.             When the wizard finishes setting up Active Directory, the computer will be
restarted. After the server restarts, Active Directory will be completely configured
and the server can then act as an RODC in the designated domain.

FIGURE 4-5 Review any warnings and the results of running the prerequisite checks.
On a Full Server or Core Server installation of Windows Server, you also can add an
RODC using Windows PowerShell. You must be logged on using an account that is a
member of the Domain Admins group in the domain. You create the RODC using the
Install-ADDSDomainController cmdlet.
When working with RODCs, the syntax you’ll want to use is as follows:
Install-ADDSDomainController -DomainName Domain -SiteName Site 
[-AllowPasswordReplicationAccountName @(“Domain\Account1“, “Domain\Account2“, …, “Domain\AccountN“)
[-Credential Credential] [-CriticalReplicationOnly]
[-DelegatedAdministratorAccountName “Domain\Account“]
[-DenyPasswordReplicationAccountName @(“Domain\Account1“, “Domain\Account2“, …, “Domain\AccountN“)] [-
Force]
[-InstallationMediaPath Path] [-InstallDns] 
[-ReadOnlyReplica] [-ReplicationSourceDC SourceDC]
[-SafeModeAdministratorPassword SecureString] 
{AddtlParams}
[-ADPrepCredential Credential] [-AllowDomainControllerReinstall]
[-DatabasePath Path] [-LogPath Path] [-SysvolPath Path]
[-NoDnsOnNetwork] [-NoGlobalCatalog] [-NoRebootOnCompletion]
[-SkipAutoConfigureDns] [-SkipPreChecks] [-SystemKey SecureString]
Because there are so many options, it’ll be easier to show an example with standard
settings than try to work through each option. Here, you specify that you are creating a
read-only replica for the imaginedlands.local domain in the Default-First-Site-Name site:
Install-ADDSDomainController -DomainName “imaginedlands.local”
-SiteName “Default-First-Site-Name” –ReadOnlyReplica $true
-AllowPasswordReplicationAccountName @(“IMAGINEDLANDS\Allowed RODC Password Replication Group”)
-DelegatedAdministratorAccountName “IMAGINEDLANDS\williams”

-DenyPasswordReplicationAccountName @(“BUILTIN\Administrators”, “BUILTIN\Server Operators”,
“BUILTIN\Backup Operators”, “BUILTIN\Account Operators”, “IMAGINEDLANDS\Denied RODC Password
Replication Group”) 
-NoGlobalCatalog $false –CriticalReplicationOnly $false 
-InstallDns $true –NoRebootOnCompletion $false 
-Force $true
You then specify the Allowed Password Replication accounts, the Delegated
Administrator account and the Deny Password Replication accounts. Note the syntax for
the string arrays for the replication accounts, which requires:
Using the @ symbol to designate the start of the array
Enclosing the array in ( )
Enclosing account names in quotation marks
Following the end quotation mark with a comma
Naming accounts in Domain\Account name format
A script using Install-ADDSDomainController to create an RODC follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Install-ADDSDomainController `
-AllowPasswordReplicationAccountName @(“IMAGINEDLANDS\Allowed RODC Password Replication Group”) `
-NoGlobalCatalog:$false `
-CriticalReplicationOnly:$false `
-DatabasePath “C:\Windows\NTDS” `
-DelegatedAdministratorAccountName “IMAGINEDLANDS\williams” `
-DenyPasswordReplicationAccountName @(“BUILTIN\Administrators”, “BUILTIN\Server Operators”,
“BUILTIN\Backup Operators”, “BUILTIN\Account Operators”, “IMAGINEDLANDS\Denied RODC Password
Replication Group”) `
-DomainName “imaginedlands.local” `
-InstallDns:$true `
-LogPath “C:\Windows\NTDS” `
-NoRebootOnCompletion:$false `
-ReadOnlyReplica:$true `
-SiteName “Default-First-Site-Name” `
-SysvolPath “C:\Windows\SYSVOL” `
-Force:$true
After installing Active Directory, you should verify the installation. Start by examining the
installation log, which is stored in the Dcpromo.log file in the %SystemRoot%\Debug
folder. The log is very detailed and takes you through every step of the installation
process, including the creation of directory partitions and the securing of the Registry for
Active Directory.
Note  As data is appended to any existing log, the Dcpromo log will contain
details regarding any previous installation of AD DS on that server. Because of this,
be sure to only review data logged at the date and time of the current installation.
Next, check the DNS configuration in the DNS console. DNS is updated to add SRV and
A records for the server. Because you created a new domain, DNS is updated to include a

forward lookup zone for the domain. You may also need to add a reverse lookup zone for
the domain.
Check for updates in Active Directory Users and Computers. The Domain Controllers OU
should have an account for the domain controller you installed.


Using Staged Installations
Rather than having a single person deploy an RODC, you can perform a staged installation
of an RODC that involves two people. In the first stage of the installation, an administrator
with domainwide administrative permissions uses the Active Directory Domain Services
Configuration Wizard to create an account for the RODC in Active Directory and record
all data about the RODC that will be stored in Active Directory, such as its domain
controller account name and the site in which it will be placed. The administrator must be
a member of the Domain Admins group for the domain in which the RODC will be
deployed. The administrator can also specify which users or groups can complete the next
stage of the installation.
The second stage of the installation can be performed in the branch office by any user who
was delegated the right to complete the installation when the RODC account was created
in Active Directory. The user does not need to be a member of any administrative groups
in the domain. However, if the administrator who created the RODC account did not
specify any delegate to complete the installation, only a member of the Domain Admins or
Enterprise Admins group can complete the installation.
During the second stage, the delegated user uses the Active Directory Domain Services
Installation Wizard to install Active Directory Domain Services on the server that will
become the RODC and attaches the server to the domain account that was previously
created for it. Data that resides locally, such as in the database, log files, and so on, is
created on the RODC in this stage and can be replicated to the RODC from another
domain controller over the network or from installation media.
The server that will become the RODC must not be joined to the domain before you try to
attach it to the RODC account. As part of the installation, the wizard automatically detects
whether the name of the server matches the names of any RODC accounts that have been
created in advance for the domain. When it finds a matching account name, the wizard
prompts the user to use that account to complete the RODC installation.

Stage 1: Creating the RODC Account and Preparing for Installation
You can create an RODC account and prepare for RODC installation by completing the
following steps:
1.                  Open Active Directory Users and Computers by selecting Active Directory
Users And Computers on the Tools menu in Server Manager.
2.                  Right-click the Domain Controllers organizational unit (OU) and then
click Pre-Create Read-Only Domain Controller Account. This starts the Active
Directory Domain Services Installation Wizard.
3.                  Select the Use Advanced Installation Mode check box before clicking
Next to continue.
4.                  On the Network Credentials page, under Specify The Account Credentials
To Use To Perform The Installation, click My Current Logged On Credentials or
click Alternate Credentials, and then click Set. In the Windows Security dialog box,
provide the user name and password for an account that can install the RODC
account. To install the RODC account, you must be a member of the Enterprise
Admins group or the Domain Admins group. When you are finished providing
credentials, click Next.
5.                  On the Specify The Computer Name page, enter the single-part name of
the server that will be the RODC, such as CorpServer55.
6.                  On the Select A Site page, you must specify the site for the RODC. When
you click Next, the wizard attempts to examines the DNS configuration, and
attempts to determine whether any authoritative DNS servers are available. If the
wizard cannot do this, you will not be able to continue.
7.                  On the Additional Domain Controller Options page, the Read-Only
Domain Controller check box is selected as an additional installation option for the
domain controller. If you want the RODC to act as a read-only DNS server, select
the DNS Server check box. If you want the RODC to act as a global catalog, select
the Global Catalog check box. Click Next when you are ready to continue.
8.                  On the Specify The Password Replication Policy page, configure the initial
Password Replication Policy for the RODC. By default, no account passwords are
replicated to the RODC, and security-sensitive accounts (such as members of the
Administrators, Account Operators, Server Operators, and Backup Operators
groups) are explicitly denied from ever having their passwords replicated to the
RODC. To add other accounts to the policy, click Add. If the accounts will be
allowed to have their passwords replicated to the RODC, click Allow Passwords
For The Account To Replicate To This RODC. If the accounts will be denied from
having their passwords replicated to the RODC, click Deny Passwords For The
Account From Replicating To This RODC. Then click OK. When you are done
adding other accounts, click Next. (For more information, see “Setting Password
Replication Policy” later in this chapter.)
9.                  On the Delegation Of RODC Installation And Administration page, enter
the name of the user or the group that will attach the server to the RODC account
that you are creating. You can enter the name of only one security principal. Click

Set, use the Select User Or Group dialog box to specify the security principal, and
then click OK. The delegated user or group also will have local administrative
permissions on the RODC. (For more information, see “Delegating Administrative
Permissions” later in this chapter.) Click Next to continue.
10.             On the Summary page, review the installation options. If desired, click
Export Settings to save these settings to an answer file that you can use to create an
RODC account and prepare for installation. When you click Next again, the wizard
will use the options you’ve selected to create the RODC account and prepare
Active Directory. When the wizard finishes configuring Active Directory, click
Finish.

Stage 2: Attaching the RODC and Finalizing Installation
After you create the account for the RODC and prepare the installation, the user or group
to whom you delegated installation and administration of the RODC can attach the RODC
and complete the installation by running the Active Directory Domain Services
Configuration Wizard on the server that will become the RODC. The server must not be
joined to the domain before the second stage.
To attach a server to an RODC account and complete the installation, complete the
following steps:
1.                  Log on as the local administrator to the server that will become the RODC.
2.                  Follow the steps for installing an RODC as listed in ”Adding RODCs
Without Staging” earlier in the chapter. In step 8, the Domain Controllers Options
page will have a notification that states, ”A pre-created account that matches the
name of the target server exists in the directory.” You’ll have options for using the
existing RODC account (the default) or to reinstall the domain controller. Because
you want to attach to the existing account, use the existing account.
3.                  You won’t be able to set the domain controller options for DNS or global
catalogs because these options are set when the RODC account is prestaged.
However, you will be able to install from media or replication. You also will be able
to set the directory paths.

Performing Staged Installations Using Windows PowerShell
On a Full Server or Core Server installation of Windows Server 2012 or later, you can
perform staged installations of RODCs using Windows PowerShell. As with GUI
installation, you must first create an RODC account and prepare the installation. Then you
must attach and finalize the RODC.
You create the RODC account and prepare the installation using the Add-
ADDSReadOnlyDomainControllerAccount cmdlet. With this cmdlet, you use:
–AllowPasswordReplicationAccountName to identify accounts that are allowed to
have their passwords replicated
–DenyPasswordReplicationAccountName to identify accounts that are restricted
from having their passwords replicated
-DelegatedAdministratorAccountName to specify the account that will install and
manage the RODC
The full syntax for Add-ADDSReadOnlyDomainControllerAccount follows:
Add-ADDSReadOnlyDomainControllerAccount -DomainName Domain
-SiteName Site -DomainControllerAccountName ComputerName
[-AllowPasswordReplicationAccountName @(“Domain\Account1“, “Domain\Account2“, …, “Domain\AccountN“)
[-DelegatedAdministratorAccountName “Domain\Account“]
[-DenyPasswordReplicationAccountName @(“Domain\Account1“, “Domain\Account2“, …, “Domain\AccountN“)]
[-Credential Credential] [-Force] [-InstallDns] [-NoGlobalCatalog]
[-ReplicationSourceDC SourceDC] [-SkipPreChecks]
In the following example, you create the RODC account for CorpServer55:
Add-ADDSReadOnlyDomainControllerAccount 
-DomainName “imaginedlands.local” -SiteName “Default-First-Site-Name”
-DomainControllerAccountName CorServer55
-AllowPasswordReplicationAccountName @(“IMAGINEDLANDS\Allowed RODC Password Replication Group”)
-DelegatedAdministratorAccountName “IMAGINEDLANDS\williams”
-DenyPasswordReplicationAccountName @(“BUILTIN\Administrators”, “BUILTIN\Server Operators”,
“BUILTIN\Backup Operators”, “BUILTIN\Account Operators”, “IMAGINEDLANDS\Denied RODC Password
Replication Group”) 
-NoGlobalCatalog $false -InstallDns $true -Force $true
Once you stage the account, you can use the Install-ADDSDomainController cmdlet to
promote the server to act as an RODC. To attach the server to the existing account, specify
the –UseExistingAccount parameter. Because you’ve already set the domain controller
options for replication accounts, delegation, DNS and global catalogs, you can’t use the
related parameters. However, you can use parameters for specifying media, replication and
directory paths. Thus, the core syntax for adding an RODC using an existing account is:

Install-ADDSDomainController -DomainName Domain –UseExistingAccount
[-DatabasePath Path] [-LogPath Path] [-SysvolPath Path]
[-SafeModeAdministratorPassword SecureString]
{AddtlParams}
[-Credential Credential] [-CriticalReplicationOnly]
[-Force] [-InstallationMediaPath Path]
[-NoDnsOnNetwork] [-NoRebootOnCompletion]
[-ReplicationSourceDC SourceDC] [-SkipAutoConfigureDns]
[-SkipPreChecks] [-SystemKey SecureString]
In the example that follows, you add the RODC to the ImaginedLands.local domain and
prompt for the required credentials:
Install-ADDSDomainController -DomainName “imaginedlands.local”
–CriticalReplicationOnly $false–NoRebootOnCompletion $false 
–UseExistingAccount $true -Force $true -credential (get-credential)


Decommissioning RODCs
In a domain, RODCs act as additional domain controllers. If you no longer need an
RODC, you can remove it from the domain by completing the following steps:
1.                  In Server Manager, click Manage and then click Remove Roles And
Features. This starts the Remove Roles And Features Wizard. If the wizard displays
the Before You Begin page, read the Welcome message and then click Next.
2.                  On the Select Destination Server page, the server pool shows servers
you’ve added for management. Click the server you are demoting and then click
Next.
3.                  On the Remove Server Roles page, clear Active Directory Domain
Services. An additional prompt is displayed warning you about dependent features,
such as Active Directory Administrative Center and other AD DS management
tools. If you click the Remove Features button, the wizard removes the dependent
features as well as Active Directory Domain Services. If you want to keep related
management tools, clear the Remove Management Tools check box and then click
Continue.
4.                  The wizard checks the status of the domain controller in Active Directory.
As the RODC must be demoted before the AD DS role can be removed, you see a
prompt regarding this, as shown in Figure 4-6. Click Demote This Domain
Controller to start the Active Directory Domain Services Wizard.
FIGURE 4-6 Initiate Active Directory removal.
5.                  When the Active Directory Domain Services Configuration Wizard starts,
you’ll see the Credentials page shown in Figure 4-7. You must be logged on using
an account that is a member of the Domain Admins group to remove an RODC
from a domain. If you are logged on with an account that has appropriate
permissions for uninstalling Active Directory, you can use your current logged-on
credentials. Otherwise, click Change and then use the options in the Windows
Security dialog box to enter the user name and password for an account that does

have the appropriate permissions.
FIGURE 4-7 Ensure that you have sufficient credentials.
Caution  Although you have the option of forcing the removal of the RODC, don’t
select this option without reviewing “Forcing the Removal of Domain Controllers”
in Chapter 3. As explained in that section, forcing removal of domain controllers is
an action you perform only when you can’t remove the domain controller using the
standard approach.
6.                  When you are ready to continue, click Next. The Active Directory Domain
Services Configuration Wizard then examines the Active Directory forest, checking
the credentials you provided and attempting to determine related functions that the
RODC performs, such as DNS Server and Global Catalog. If additional functions
are found, as shown in Figure 4-8, you must select Proceed With Removal to
continue.

FIGURE 4-8 Note the additional roles that will be removed.
7. Next, you are prompted to enter and confirm the password for the local
Administrator account on the server. You need to enter a password for the local
Administrator account because domain controllers don’t have local accounts but
member or stand-alone servers do, so the local Administrator account will be re-
created as part of the Active Directory removal process. Click Next.
8. On the Removal Options page, you have the option of retaining the domain
controller metadata. Select the related checkbox if you want to save the metadata so
that you can reinstall AD DS on this server later using the install from media
option. If you don’t choose this option and find that you subsequently need to
reinstall AD DS on this server, you’ll need to obtain installation media or replace
data over the network.
9. Next, you are prompted to enter and confirm the password for the local
Administrator account on the server. You need to enter a password for the local
Administrator account because domain controllers don’t have local accounts but
member or stand-alone servers do, so the local Administrator account will be re-
created as part of the Active Directory removal process. Click Next.
10. On the Review Options page, review your selections. Or click View Script to export
the settings to a PowerShell script that you can use to perform an automated
demotion of other RODCs. When you click Demote, the wizard uses the options
you selected to demote the RODC. This process can take several minutes. The
server will be automatically restarted after the demotion so that the role removal
can be performed.
As you are removing an RODC from a domain, the wizard does the following:
Removes Active Directory and all related services from the server and makes it a
member server in the domain

Changes the computer account type and moves the computer account from the
Domain Controllers container in Active Directory to the Computers container
Updates DNS to remove the domain controller SRV records
Creates a local Security Accounts Manager (SAM) account database and a local
Administrator account
Real World  When you remove an RODC, the related server object is removed
from the domain directory partition automatically. However, the server object
representing the retired RODc in the configuration directory partition can have child
objects and therefore may not be removed automatically. For more information on
these objects, refer to “Confirming Removal of Deleted Server Objects,” later in this
chapter.
To remove an RODC from a domain using Windows PowerShell, you use the Uninstall-
ADDSDomainController cmdlet and must be logged on using an account that is a member
of the Domain Admins groups. The basic syntax is:
Uninstall-ADDSDomainController –DemoteOperationMasterRole
-LocalAdministratorPassword SecureString –RetainDCMetadata -Force
The –LocalAdministratorPassword parameter is used to specify the password for the local
Administrator account. The –RetainDCMetadata parameter specifies that you want to
retain the AD metadata should you need to subsequently promote the server.
In the example that follows, you remove an RODC and set a new password for the local
administrator account:
Uninstall-ADDSDomainController –DemoteOperationMasterRole
–RetainDCMetadata –Force -LocalAdministratorPassword 
(convertto-securestring “Str!F#789” –asplaintext -force)
Uninstall-ADDSDomainController –DemoteOperationMasterRole
-LocalAdministratorPassword
(convertto-securestring “Str!F#789” –asplaintext -force)
A script using Uninstall-ADDSDomainController to remove an RODC from a domain
follows:
#
# Windows PowerShell script for AD DS Deployment
#
Import-Module ADDSDeployment
Uninstall-ADDSDomainController `
-DemoteOperationMasterRole:$true `
-LocalAdministratorPassword `
(convertto-securestring “Str!F#789” –asplaintext -force) `
-RetainDCMetadata:$true `
-Force:$true


Forcing the Removal of RODCs
An RODC must have connectivity to other domain controllers in the domain or forest in
order to demote the RODC and successfully remove Active Directory Domain Services. If
an RODC has no connectivity to other domain controllers, the standard removal process
will fail, and you will need to connect the domain controller to the domain and then restart
the removal process. In a limited number of situations, however, you might not want or be
able to connect the RODC to the domain and instead might want to force the removal of
the domain controller.
Forcing the removal of a domain controller is a three-part process. You must:
1.                  Stop Active Directory Domain Services or restart the domain controller in
Directory Services Restore Mode.
2.                  Perform the forced removal of the domain controller.
3.                  Clean up the Active Directory forest metadata.


Setting Password Replication Policy
When you deploy an RODC, you must configure the Password Replication Policy on the
writeable domain controller that will be its replication partner. The Password Replication
Policy acts as an access control list (ACL) and determines whether an RODC should be
permitted to cache a password for a particular user or group. After the RODC receives an
authenticated user or computer logon request, it refers to the Password Replication Policy
to determine whether it should cache the password for the account.

Password Replication Policy Essentials
You can configure Password Replication Policy in several ways:
Allow no accounts to be cached, for the strictest control, such as when the physical
security of the RODC cannot be guaranteed.
Allow few accounts to be cached, for strong control, such as when the physical
security of the RODC is good but cannot be reasonably assured at all times.
Allow many accounts to be cached, for less strict control, such as when the physical
security of the RODC can be reasonably assured at all times.
Note  The fewer account passwords replicated to RODCs, the less risk that
security could be breached in case an RODC is compromised. The more account
passwords replicated to RODCs, the greater the risk involved in case an RODC is
compromised. On RODCs, you may also want to configure TPM and BitLocker.
Password Replication Policy is managed on a per-computer basis. The computer object for
an RODC is updated to include the following multivalued directory attributes that contain
security principals (users, computers, and groups):
msDS-Reveal-OnDemandGroup, which defines the Allowed Accounts list
msDS-NeverRevealGroup, which defines the Denied Accounts list
msDS-RevealedUsers, which defines the Revealed Accounts list
msDS-AuthenticatedToAccountList, which defines the Authenticated To list
When you are using Active Directory Users And Computers in Advanced mode (by
selecting the Advanced Features option on the View menu), you can view these attributes
and their values on the Attribute Editor tab of the RODC’s Properties dialog box, as
shown in Figure 4-9. The RODC uses these attributes together to determine whether an
account password can be replicated and cached. The passwords for denied accounts are
never replicated and cached.

Figure 4-9 Review attributes related to Password Replication Policy.
Double-click an attribute to open an editor, which will list the attribute’s current values.
For example, the Denied Accounts list contains the security principals shown in Figure 4-
10 by default. These security principals are Account Operators, Administrators, Backup
Operators, Denied RODC Password Replication Group, and Server Operators.
Figure 4-10 View the default members of the Denied Accounts list.
The passwords for allowed accounts can always be replicated and cached. Whether a
password is cached doesn’t depend on whether a user or computer has logged on to the
domain via the RODC. At any time, an RODC can replicate the passwords for allowed

accounts, and administrators can also prepopulate passwords for allowed accounts using
Active Directory Users and Computers.
During an advanced installation of an RODC, you can configure the initial Password
Replication Policy settings. When you install the first RODC in a domain by using either a
nonstaged or a staged installation, the Active Directory Domain Services Installation
Wizard creates domain group accounts that are required for RODCs to function. These
groups are as follows:
Enterprise Read-Only Domain Controllers Every RODC in the Active Directory
forest is a member of this group automatically. Membership in this group is required
for proper operations.
Read-Only Domain Controllers Every RODC in the Active Directory domain is a
member of this group automatically. Membership in this group is required for proper
operations.
Allowed RODC Password Replication Group You can manage allowed accounts
by using the Allowed RODC Password Replication Group. Passwords for members
of this group are always replicated to RODCs.
Denied RODC Password Replication Group You can manage denied accounts
using the Denied RODC Password Replication Group. Passwords for members of
this group are never replicated to RODCs.
Figure 4-11 View members of the Denied RODC Password Replication Group.
By default, the Denied RODC Password Replication Group has the members shown in
Figure 4-11. The Allowed RODC Password Replication Group has no members by default
and is the only allowed account defined in Password Replication Policy.

Allowing and Denying Accounts
Each RODC has a separate Password Replication Policy. To manage the Password
Replication Policy, you must be a member of the Domain Admins group. The easiest way
to manage Password Replication Policy is to:
Add accounts for which passwords should not be replicated to the Denied RODC
Password Replication Group.
Add accounts for which passwords should be replicated to the Allowed RODC
Password Replication Group.
You can also edit Password Replication Policy settings directly. To edit the Password
Replication Policy for an RODC, follow these steps:
1.                  After you open Active Directory Users and Computers, ensure that Active
Directory Users and Computers points to a writeable domain controller that is
running Windows Server 2012 or later. Right-click the Active Directory Users And
Computers node and then select Change Domain Controller. The domain controller
to which you are connected should be a writeable domain controller; that is, it
should not list RODC under DC Type. If you are connected to an RODC, change to
a writeable domain controller. Click Cancel or OK as appropriate.
2.                  Expand the domain node and then select Domain Controllers. In the details
pane, right-click the RODC computer account and then choose Properties.
3.                  On the Password Replication Policy tab, shown in Figure 4-12, you’ll see
the current settings for Password Replication Policy on the RODC.
FIGURE 4-12 Review the Password Replication Policy settings.

4.                  Define allowed or removed accounts using the following techniques:
To define an allowed account, click Add, select Allow Passwords For The Account
To Replicate To This RODC, as shown in Figure 4-13, and then click OK. In the
Select Users, Contacts, Computers, Service Accounts, Or Groups dialog box, enter
an account name and then click Check Names. If the account name is listed
correctly, click OK to add it to the Password Replication Policy as an allowed
account.
FIGURE 4-13 Define an allowed account.
To define a denied account, click Add, select Deny Passwords For The Account To
Replicate To This RODC, and then click OK. In the Select Users, Contacts,
Computers, Service Accounts, Or Groups dialog box, enter an account name and
then click Check Names. If the account name is listed correctly, click OK to add it
to the Password Replication Policy as a denied account.
To remove an account from Password Replication Policy, select the account name
in the Groups, Users And Computers list and then click Remove. When prompted to
confirm, click Yes.

Managing Credentials on RODCs
You can review cached credentials or prepopulate credentials using the Advanced
Password Replication Policy dialog box. When you are prepopulating user accounts, you
should also consider prepopulating the passwords of computer accounts that the users will
be using.
You can view and work with the Advanced Password Replication Policy dialog box by
completing these steps:
1.                  In Active Directory Users and Computers, expand the domain node and
then select Domain Controllers.
2.                  In the details pane, right-click the RODC computer account and then
choose Properties.
3.                  On the Password Replication Policy tab, click Advanced to display the
Advanced Password Replication Policy dialog box, shown in Figure 4-14.
FIGURE 4-14 Review stored credentials and authenticated computers.
4.                  Review or manage cached credentials using the following techniques:
Accounts for which passwords are stored on the RODC are displayed by default. To
view accounts that have been authenticated to this RODC, on the Display Users
And Computers list, select Accounts That Have Been Authenticated To This Read-
Only Domain Controller.
To prepopulate passwords for an account, click Prepopulate Passwords. In the
Select Users Or Computers dialog box, enter an account name and then click Check
Names. If the account name is listed correctly, click OK to add a request that its
password be replicated to the RODC. When prompted to confirm, click Yes. The
password is then prepopulated. Click OK.

Identifying Allowed or Denied Accounts
You can determine whether a user or computer account is allowed or restricted by using
Resultant Set of Policy to examine all related group memberships and determine exactly
what rules apply. To generate Resultant Set of Policy, follow these steps:
1.                  In Active Directory Users and Computers, expand the domain node and
then select Domain Controllers.
2.                  In the details pane, right-click the RODC computer account and then
choose Properties.
3.                  On the Password Replication Policy tab, click Advanced to display the
Advanced Password Replication Policy dialog box.
4.                  On the Resultant Policy tab, click Add. In the Select Users Or Computers
dialog box, enter an account name and then click Check Names. If the account
name is listed correctly, click OK. Repeat for other accounts as necessary.
5.                  The Resultant Set of Policy for each account is displayed as shown in
Figure 4-15. If the user or computer is restricted, the Resultant Setting is Deny. If
the user or computer is permitted, the Resultant Setting is Allow.
FIGURE 4-15 Determine whether a user or computer is allowed or denied according to
the Password Replication Policy.

Resetting Credentials
In the event that an RODC is compromised or stolen, you can reset the passwords for all
accounts for which credentials were cached on the RODC. To do this, complete the
following steps:
1.                  After you open Active Directory Users and Computers, ensure that Active
Directory Users And Computers points to a writable domain controller. Right-click
the Active Directory Users And Computers node and then select Change Domain
Controller. The domain controller to which you are connected should be a writable
domain controller; that is, it should not list RODC under DC Type. If you are
connected to an RODC, change to a writable domain controller. Click Cancel or
OK as appropriate.
2.                  Expand the domain node and then select Domain Controllers. In the details
pane, right-click the RODC computer account and then choose Delete.
3.                  When prompted to confirm, click Yes. When prompted again, specify
whether you want to reset all passwords for user accounts, computer accounts, or
both that were cached on this RODC. If you reset user account passwords, the
affected users won’t be able to log on until they contact you or the help desk to
obtain a new password. If you reset computer account passwords, the affected
computers will be disjoined from the network and won’t be able to connect to the
domain until they are rejoined.
4.                  Select View List to view a list of the cached accounts. The password for
every user whose account is listed has been reset.
5.                  Select Export to export the accounts list to a file and then click Browse to
choose a save location for the file.
6.                  Click Delete. When prompted, confirm that you really want to delete all
metadata for the RODC by clicking OK.

Delegating Administrative Permissions
During configuration of an RODC, you have an opportunity to specify user or group
accounts that should be delegated administrative permissions. After the initial
configuration, you can add or remove administrative permissions by using Dsmgmt.
You can grant administrative permissions to an additional user by completing these steps:
1.                  Start an elevated, administrator command prompt by right-clicking, and
then clicking Command Prompt (Admin).
2.                  At the elevated command prompt, enter dsmgmt.
3.                  At the dsmgmt prompt, enter local roles.
4.                  At the local roles prompt, enter show role administrators to list current
administrators. In the default configuration, no users or groups are listed.
5.                  At the local roles prompt, enter add Domain\User administrators to grant
administrative permissions, where Domain is the domain in which the user account
is located and User is the account name, such as add IMAGINEDL\WilliamS
administrators.
6.                  Confirm the addition by entering show role administrators.
7.                  Enter quit twice to exit dsmgmt.
You can remove administrative permissions by following these steps:
1.                  At an elevated command prompt, enter dsmgmt.
2.                  At the dsmgmt prompt, enter local roles.
3.                  At the local roles prompt, enter show role administrators to list current
administrators. In the default configuration, no users or groups are listed.
4.                  At the local roles prompt, enter remove Domain\User administrators to
remove administrative permissions for a specified user, where Domain is the
domain in which the user account is located and User is the account name, such as
remove IMAGINEDL\WilliamS administrators.
5.                  Confirm the removal by entering show role administrators.
6.                  Enter quit twice to exit dsmgmt.


Chapter 5. Configuring, Maintaining, and Troubleshooting
Global Catalog Servers
Active Directory is a distributed directory service with a central repository at its core. In
this repository are account and resource objects with a full complement of attributes.
Active Directory stores directory data as replicas on multiple domain controllers and
maintains consistency through replication. Domain controllers are the workhorses in this
infrastructure. They store the domain data and provide the domainwide distribution of this
data.
In addition to their standard roles, domain controllers can also act as global catalog
servers. Global catalog servers provide the forestwide distribution of data in a multiple
domain forest. Because global catalog servers have unique architecture and configuration
requirements, the administrative tasks you use to manage and maintain them are different
from those for standard domain controllers. In this chapter, I provide tips and techniques
for configuring, maintaining, and troubleshooting global catalog servers.


Working with Global Catalog Servers
In an Active Directory forest with multiple domains, the global catalog provides a central
repository of domain information for the forest by storing partial replicas of all domain
directory partitions. In addition to its activities as a domain controller, a global catalog
server supports the following special activities in the forest:
Forestwide directory searches
User logon and authentication
Universal group membership caching and updates
Global catalog advertisement and replication
Domain controllers acting as global catalog servers and hosting global catalogs distribute
their partial replicas to all other global catalog servers in a forest. Because there is no
single master, any global catalog server can process and then replicate changes to other
global catalog servers. Because they store a partial attribute set for all objects in the forest
as well as universal group membership information, global catalog servers enable
forestwide search and authentication. When users or administrators search for resources in
the Active Directory forest, a global catalog server processes the query in the global
catalog and then returns the result. Without a global catalog, queries for forest resources
would have to be made separately in every domain in the forest.
Real World  Global catalog servers must either have replication partners for all
domains in the forest or be able to replicate with another global catalog server. The
replication topology for global catalogs is generated automatically by a built-in
process called the Knowledge Consistency Checker (KCC). The KCC implements
the replication topology required to distribute the contents of every directory
partition to every global catalog server. The KCC also generates a cost matrix for
locating the next-closest global catalog server according to site link cost settings.
Global catalog servers register global catalog–specific service (SRV) resource
records in DNS so that clients can locate them according to site. If no global catalog
server is available in the user’s logon site, a global catalog server is located in the
next-closest site, according to the cost matrix generated by the KCC from site link
cost settings.
During interactive user logon, the authenticating domain controller retrieves the security
identifiers (SIDs) that the user’s computer requires to build the user’s access token. To
retrieve the SIDs of all universal groups to which the user belongs, the authenticating
domain controller must contact a global catalog server. If a global catalog server is not
available in the site when a user logs on to a domain in which universal groups are
available, the computer can use cached credentials to log the user on, but only if caching is
enabled and if the user has previously logged on to the domain from the same computer. If
the user has not previously logged on to the domain from the same computer, the
computer cannot use cached credentials, and the user can log on to only the local
computer.
Note  Because the global catalog stores the membership information for groups in
the forest, access to a global catalog server is a requirement for authentication of
noncached credentials in a forest with multiple domains. Before users can use

cached credentials, you must enable universal group membership caching. When
caching is enabled, domain controllers cache group memberships and keep the cache
updated by contacting a global catalog server.
Additionally, if the user specifies a logon name in the form of a user principal name
(UPN), and the authenticating domain controller has no knowledge of the account, the
domain controller contacts a global catalog server to retrieve the domain of the user. The
reason for this is that the DNS domain suffix associated with a UPN is not necessarily the
user’s domain, and the identity of the user’s domain may need to be retrieved from a
global catalog server. For example, if a user’s account is located in
ny.tech.imaginedlands.com and the user logs on as williams@imaginedlands.com, the
domain name in the UPN suffix does not match the user’s domain, and the authenticating
domain controller must contact a global catalog server to retrieve the identity of the user’s
domain.
Regardless of whether a domain controller is a global catalog, the physical representation
of Active Directory data is as a single database file (Ntds.dit). On a writeable domain
controller that is not a global catalog server, Ntds.dit contains a full, writeable replica of
every object in the domain directory partition for its own domain, plus a writeable
configuration directory partition. On a writeable domain controller that is a global catalog
server, Ntds.dit contains a full, writeable replica of every object in the domain directory
partition for its own domain; a partial read-only replica of every object in the domain
directory partitions for all other domains in the forest; plus a writeable configuration
directory partition. In either case, if the domain controller is the schema operations master
for the forest, it also has a writeable schema directory partition. Otherwise, it has a read-
only schema directory partition.


Deploying Global Catalog Servers
In an Active Directory forest with multiple domains, global catalog servers are an
essential part of your Active Directory infrastructure. Before you deploy global catalog
servers, you should carefully plan their placement. Afterward, as with any other critical
server, you will need to manage and maintain the global catalog servers you’ve deployed
to ensure they are configured properly and are performing as expected.

Adding Global Catalog Servers
The first domain controller installed in a domain is automatically designated as a global
catalog server. When conditions in a site warrant adding a global catalog server, you can
designate additional domain controllers to be global catalog servers as well. However, do
not place the global catalog on a domain controller that hosts the infrastructure operations
master role in the domain unless all domain controllers in the domain are global catalog
servers or the forest has only one domain.
Generally speaking, each site in your organization should have a designated global catalog
server. However, you might not want to add a global catalog to a site when the WAN links
to the site cannot handle the related replication traffic. You might instead want to rely on
universal group membership caching. For more information, see “Managing and
Maintaining Universal Group Membership Caching” later in the chapter.
Real World  In a large enterprise, you should carefully monitor the number of
global catalog servers you’ve deployed and ensure that each additional global
catalog is needed before you deploy it. The reason for this is that each time you add
a global catalog, you increase the complexity of the replication topology. As you
deploy an increasing number of global catalogs, the KCC requires more and more
computational power to generate the related replication topology.
You configure a domain controller to act as a global catalog server by using Active
Directory Sites And Services to set the Global Catalog Server option for the domain
controller you want to be a global catalog server. The account you use must be a member
of the Domain Admins group in the domain for which you are configuring the global
catalog server. Follow these steps to establish a domain controller as a global catalog
server:
1.                  Start Active Directory Sites And Services from the Administrative Tools
menu.
2.                  Expand the site you want to work with, such as Default-First-Site-Name,
expand the related Servers node, and then select the server you want to designate as
a global catalog, as shown in Figure 5-1.
FIGURE 5-1 Select the domain controller you want to establish as a global catalog server.
3.                  In the right pane, right-click NTDS Settings and then select Properties.

This displays the NTDS Settings Properties dialog box.
4.                  If you want the selected server to be a global catalog server, select the
Global Catalog check box, as shown in Figure 5-2. When you click OK, Active
Directory immediately designates the domain controller as a global catalog server.
FIGURE 5-2 Designate the server as a global catalog server.

Monitoring and Verifying Global Catalog Promotion
When you designate a new global catalog server, the server will request a copy of the
global catalog from an existing global catalog server in the domain. Through replication, a
partial replica of each domain directory partition, other than the domain for which the
domain controller is authoritative, is then copied to the domain controller. This replication
occurs immediately within a site or at the next scheduled replication interval when Active
Directory is replicating between sites. The time it takes to replicate the global catalog
depends on the size of the catalog and the site configuration. Generally, the larger and
more extensive the Active Directory environment, the longer it takes to complete the
global catalog promotion process.
Note  When you add a global catalog server to a site, the Knowledge Consistency
Checker (KCC) updates the replication topology and then initiates replication.
Replication of partial domain directory partitions that are available within the site begins
immediately. Replication of partial domain directory partitions that are available only
from other sites begins at the next scheduled replication interval. When you add
subsequent global catalog servers to the same site, the existing global catalog server in
the site can act as the replication partner for all domain directory partitions that will be
replicated, and this reduces the replication burden across site links.
Tip  Microsoft Exchange Server is tightly integrated with Active Directory. Exchange
Server stores schema data, configuration data, domain data, and application data in the
directory. It also uses Active Directory replication topology to determine how to route
messages within the organization. To learn more about Exchange Server and Active
Directory, please refer to William Stanek’s Pocket Consultants for Microsoft Exchange
Server.
You can monitor inbound replication progress to track progress. Follow these steps:
1.                  Start an elevated, administrator command prompt by right-clicking  the
Windows logo, and then clicking Command Prompt (Admin).
2.                  At the command prompt, enter the following command: dcdiag
/s:ServerName /v | find “%”, where ServerName specifies the name of the global
catalog server that you want to monitor, and /v | find “%” finds the percentage of
replication.
3.                  Repeat as necessary to track progress. If the test shows no output,
replication has completed.
Using an elevated, administrator command prompt, you can verify successful replication
by entering repadmin /showrepl. If you are not running Repadmin on the domain
controller whose replication you are checking, you can specify a destination domain
controller in the command. For example, if you want to check DomainController17, you
enter the following command.
repadmin /showrepl DomainController17
As shown in Sample 5-1, Repadmin lists inbound neighbors for the current or specified
domain controller. These inbound neighbors identify the distinguished name of each
directory partition for which inbound directory replication has been attempted, the site and

name of the source domain controller, and whether replication succeeded.
SAMPLE 5-1. Confirming replication with neighbors.
LA-First-Site\CORPSERVER56
DSA Options: IS_GC DISABLE_OUTBOUND_REPL IS_RODC
Site Options: (none)
DSA object GUID: a465bbc1-c3d9-46ec-96fc
DSA invocationID: c045996c-b163-45b7-80d3
==== INBOUND NEIGHBORS ======================================
DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
 Last attempt @ 2015-09-06 11:56:16 was successful.
CN=Configuration,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
Last attempt @ 2015-09-06 11:56:16 was successful.
CN=Schema,CN=Configuration,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
 Last attempt @ 2015-09-06 11:56:16 was successful.
DC=DomainDnsZones,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e 
 Last attempt @ 2015-09-06 11:56:16 was successful.
DC=ForestDnsZones,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
 Last attempt @ 2015-09-06 11:56:16 was successful.
The example shows the replication status for five directory partitions:
DC=imaginedlands,DC=com A domain partition
CN=Configuration,DC=imaginedlands,DC=com The forestwide Configuration
partition
CN=Schema,CN=Configuration,DC=imaginedlands,DC=com The forestwide
Schema partition
DC=DomainDnsZones,DC=imaginedlands,DC=com The DNS application
partition for domain-level zones
DC=ForestDnsZones,DC=imaginedlands,DC=com The DNS application
partition for forest-level zones
Several conditions must be met before the global catalog server is locatable by clients.
These conditions are referred to as readiness levels. The lowest readiness level is 0. Newly
designated global catalog servers begin at level 0 and progress to level 6 as they
successfully complete replication of partial domain partitions. By default, domain
controllers require all readiness levels to be reached before a global catalog is ready for
use.

At level 6, all partial directory partitions have been successfully replicated to the global
catalog server, and the global catalog is ready to be used. The Net Logon service on the
global catalog server then registers DNS service (SRV) resource records that identify the
domain controller as a global catalog server in the site and in the forest. At this point, the
global catalog server begins accepting queries on ports 3268 and 3269.
When a global catalog server has satisfied all replication requirements, the global catalog
is ready to serve clients, and the isGlobalCatalogReady rootDSE attribute is set to True.
Therefore, you can verify global catalog readiness by checking this attribute’s current
value in the directory. Follow these steps:
1.                  Start Ldp.exe by clicking Start, typing Ldp in the Search box, and then
pressing Enter.
2.                  Connect to the target server whose global catalog readiness you want to
verify. On the Connection menu, click Connect. In the Connect dialog box, shown
in Figure 5-3, enter the domain name or the fully qualified name of the server
whose global catalog readiness you want to verify. In the Port box, enter 389 if this
isn’t already the default value. If the Connectionless check box is selected, clear it,
and then click OK.
FIGURE 5-3 Configure the server connection.
3.                  Ldp will then establish a connection to the server, retrieve the base
directory service information, and then write related information in the details pane,
as shown in Figure 5-4. In the details pane, verify that the isGlobalCatalogReady
attribute has a value of True. If it does, the global catalog server is ready.
4.                  On the Connection menu, click Disconnect to disconnect from the domain
controller.

FIGURE 5-4 Check the global catalog readiness status.
Another way to verify global catalog readiness is to use Nltest. At a command prompt,
enter the following command: nltest /server:ServerName /dsgetdc:DomainName, where
ServerName specifies the name of the domain controller that you have designated as a
global catalog server, and DomainName specifies the name of the domain to which the
server belongs. In the following example, you examine CorpServer65 in the
cs.imaginedlands.com domain.
nltest /server:corpserver65 /dsgetdc:imaginedlands.com
The output will look similar to the following.
DC: \CORPSERVER65.cs.imaginedlands.com
     Address: \192.168.1.200
    Dom Guid: 
    Dom Name: cs.imaginedlands.com
 Forest Name: imaginedlands.com
Dc Site Name: LA-First-Site
Our Site Name: LA-First-Site
       Flags: PDC GC DS LDAP KDC TIMESERV GTIMESERV WRITEABLE
DNS_FOREST CLOSE_SITE FULL_SECRET
The command completed successfully
In the Flags line of the output, if GC appears, as shown in the previous sample output, the
global catalog server has satisfied its replication requirements and is ready to be used.
You can verify that a server is advertised as a global catalog server by checking for a
related SRV resource record in Domain Name System (DNS). To verify global catalog
DNS registrations, follow these steps:
1.                  On the Tools menu in Server Manger click DNS.
2.                  Connect to a domain controller in the forest root domain. Right-click DNS,
click Connect To DNS Server, and then click The Following Computer. Enter the
name of the domain controller in the forest root domain and then click OK.
3.                  Expand Forward Lookup Zones and then expand the forest root domain.
4.                  Click the _tcp container.
5.                  The records that begin with _gc are global catalog service (SRV) resource
records. In the details pane, look for a _gc SRV record that has the name of the
global catalog server. Figure 5-5 shows an example.
FIGURE 5-5 Identify the global catalog SRV resource records.

Note  The data field lists three values and the name of the server to which the
resource record belongs. Respectively, these values are the priority, weight, and port
number assigned to the resource record.
6.                  Double-click the global catalog SRV resource record. The record should be
configured similarly to what is shown in Figure 5-6. The values assigned to the
record are used as follows:
FIGURE 5-6 Verify the global catalog SRV resource record.
Domain Specifies the fully qualified domain name for the domain to which the
resource record applies.
Service Specifies the universal symbolic name of the TCP/IP service to be served
by the record. Here, _gc indicates the related record is for global catalog services.
Protocol Specifies the transport protocol to be used by the TCP/IP service. Here,
the transport protocol is TCP.
Priority Specifies the relative priority of the host with respect to other hosts in the
domain that offer the same service. The highest priority goes to a host that has a
value of 0. If two or more hosts have the same priority, weighting can be used to
determine which host is used.
Weight Specifies the relative weighting of a host and is used to load-balance
services. If two or more hosts of a service have the same priority, the weighting can
set a preference for one host over another. Hosts with higher weights should be used
first.
Port Number Specifies the TCP/IP port on the host that offers the service. The
default TCP port for global catalog servers is 3268.
Host Offering This Service Identifies the host server by its fully qualified domain

name.
Real World  As an administrator, you typically will have responsibility for
ensuring proper operations of domain controllers and global catalog servers on a
daily basis. If you notice that a domain controller is getting overloaded and its
performance is being affected, you could use the priority and weight values to
reconfigure DNS so that some tasks are performed by other, less-used domain
controllers. By adjusting the domain controller’s weight with regard to a particular
service, such as LDAP or GC, you can configure the domain controller to receive
fewer client requests for this service than other domain controllers. Alternatively,
you can adjust the domain controller’s priority in the DNS environment so that it
processes client requests for a service only if other DNS servers are unavailable.
However, don’t modify service locator records without careful planning with regard
to the potential impact on your network and thorough documentation to detail the
configuration you’ve selected for other administrators.

Identifying Global Catalog Servers
One way to determine whether a domain controller is designated as a global catalog server
is to use Active Directory Sites And Services. In Active Directory Sites And Services,
expand the Sites container, expand the site of the domain controller that you want to
check, expand the Servers container, and then expand the Server object. Right-click the
NTDS Settings object and then click Properties. On the General tab, if the Global Catalog
box is selected, the domain controller is designated as a global catalog server.
Another way to determine whether a domain controller is designated as a global catalog
server is to use the DSQUERY command-line tool. Using this tool, you can locate the
global catalog servers in your logon domain by entering dsquery server -isgc. The
resulting output is a list of distinguished names for global catalogs, such as
“CN=CentraDC16,CN=Servers,CN=LA-First-Site,CN=Sites,CN=Configuration,DC=
imaginedlands,DC=com”
“CN=CentraDC23,CN=Servers,CN=LA-First-Site,CN=Sites,CN=Configuration,DC=
imaginedlands,DC=com”
Here, CentralDC16 and CentralDC23 are global catalog servers in your logon domain.
With the -Domain parameter, you can use DSQUERY SERVER to locate global catalog
servers in a specific domain. For example, if you want to locate global catalog servers in
the cs.reagentpress.com domain, you enter
dsquery server -domain cs.reagentpress.com -isgc
With the -Site parameter, you can use DSQUERY SERVER to locate global catalog
servers in a specific site. For example, if you want to locate a global catalog server in the
NY-First-Site site, you enter
dsquery server -site NY-First-Site -isgc
Tip  Being able to search site by site is important because you typically want at
least one global catalog server per site. If you search a site and don’t find a global
catalog, server you may want to add one.
You can search the entire forest as well by entering
dsquery server -forest -isgc

Restoring Global Catalog Servers
Restoring a global catalog server from a backup can result in lingering objects, which in
turn can cause replication inconsistencies. When restoring a global catalog server from
backup, keep in mind that a restored global catalog server contains not only restored data
from its domain but also some data from all other domains in the forest. Because of this,
restoring a global catalog server can possibly reintroduce previously deleted objects, and
these lingering objects can cause replication inconsistencies.
You can reduce the number of possible inconsistencies by restoring domain controllers
and global catalogs from backups that were made at the same time or as close in time as
possible. In this way, there will be less discrepancy between the authoritative domains and
their partial replicas in the restored global catalogs.
If lingering objects are reintroduced, you can forcibly remove them by running the
Repadmin /removelingeringobjects command. However, this approach should be a last
resort. Rather than forcibly removing the lingering objects, you should wait for them to be
removed through the normal replication update process.

Removing Global Catalog Servers
You might decide to remove the global catalog from a domain controller if universal group
membership caching is adequate to satisfy logon requirements in a site where WAN link
speeds are not adequate to handle the replication required to maintain global catalogs. If
you no longer want a domain controller to act as a global catalog server, you can remove
the global catalog by following these steps:
1.                  Start Active Directory Sites And Services from the Tools menu in Server
Manager.
2.                  Expand the site you want to work with, such as Default-First-Site-Name,
expand the related Servers node, and then select the server from which you want to
remove the global catalog.
3.                  In the right pane, right-click NTDS Settings and then select Properties.
This displays the NTDS Settings Properties dialog box. Clear the Global Catalog
check box.
4.                  When you click OK, Active Directory immediately removes the domain
controller’s designation as a global catalog server. The Net Logon service
immediately deregisters the SRV resource records that advertised the global catalog
server in DNS. The domain controller also stops accepting LDAP requests over
ports 3268 and 3269.
When you remove a global catalog from a domain controller, the global catalog removal is
not immediate. Instead, global catalog directory partitions are removed gradually in the
background. The KCC begins removing the read-only replicas one at a time using an
asynchronous process that removes objects gradually until no read-only objects remain.
Once the work is scheduled, the KCC tracks the progress of replica removal, continuing to
remove objects until either a replica is gone or a higher-priority replication operation is in
the queue. Because read-only replica removal receives the lowest possible priority, any
other replication work will interrupt it. Thus, removal work is preempted for the other
work and then resumed later.
In the Directory Service log, you’ll see related events that record when removal of a
partial replica is starting, resuming, and finishing. Event ID 1744 states that the local
domain controller is no longer a global catalog server. Event ID 1659 states that removal
of a directory partition from the local database has been resumed, including the
approximate number of objects remaining to be removed and the number of link values of
attributes remaining to be removed. Event ID 1660 states that a specified directory
partition has been removed from the domain controller.
You can verify that the global catalog has been removed from a domain controller by
using Event Viewer. When the global catalog has been removed successfully, the
Knowledge Consistency Checker (KCC) logs Event ID 1268 in the Directory Service log.
In an extended Active Directory environment, it can take hours or days to fully remove a
global catalog.

Controlling SRV Record Registration
DC Locator and GC Locator DNS SRV resource records are registered dynamically by the
Net Logon service and are used to locate domain controllers and global catalog servers. In
Group Policy, the following policies can be used to control exactly how registration and
deregistration of SRV records works:
Automated Site Coverage By The DC Locator DNS SRV Records Determines
whether domain controllers will dynamically register site-specific DC Locator SRV
resource records for the closest sites where no domain controller for the same domain
exists (or where no global catalog server for the same forest exists).
Sites Covered By The GC Locator DNS SRV Records Specifies the sites for
which the global catalog servers should register site-specific GC Locator SRV
resource records in DNS. These records are registered in addition to the site-specific
SRV resource records registered for the site where the global catalog server resides or
for the sites without a global catalog server in the same forest for which this global
catalog server is the closest global catalog server.
If a policy is not configured, it is not applied to any domain controller or global catalog
servers, and domain controllers and global catalog servers use their local configuration. If
a policy is enabled, its settings are used instead of a global catalog server’s local
configuration.


Managing and Maintaining Universal Group Membership
Caching
Universal group membership caching enables domain controllers to cache group
membership information after retrieving it the first time rather than having to retrieve
group membership information each time a user logs on. On domain controllers, the
universal group membership caching feature is available by default and can be enabled on
a per-site basis as needed. Although universal group membership caching is the name of
the feature, this name is somewhat of a misnomer because, technically speaking, both
security identifiers (SIDs) for global groups and universal groups can be cached.

Universal Group Membership Caching Essentials
Universal security groups can contain security principals from other domains. During
interactive user logon, the authenticating domain controller retrieves the SIDs that the
user’s computer requires to build the user’s access token. To retrieve the SIDs of all
universal groups to which the user belongs, the authenticating domain controller must
contact a global catalog server. If a global catalog server is not available in the site when a
user logs on to a domain in which universal groups are available, the computer will use
cached credentials to log the user on if the user has previously logged on to the domain
from the same workstation. If the user has not previously logged on to the domain from
the same computer, the user can log on to only the local computer.
Universal group memberships are cached primarily because they can contain individual
user accounts and global groups from any domain in the forest and because they can be
added to access control lists in any domain in the forest. Therefore, a user who is logging
on might have a membership in a universal group that exists in a different domain and
might have permissions on objects in this domain by virtue of membership in a universal
group that exists in a different domain.
In contrast, a domain controller can always determine a user’s membership in all domain
local and global groups that are required for authorization in its own domain. Whereas
domain local groups can have members from other domains, you can add domain local
groups to access control lists only in the domain in which they are created. Whereas you
can add global groups to access control lists in any domain, global groups can contain
only accounts from the domain in which they are created. That said, global groups can be
members of universal groups that exist in different domains, and being a member of a
global group that is itself a member of a universal group can give the user access to
resources other than those allowed by membership in the global group alone.
During the logon process, the authenticating domain controller retrieves a list of global
group SIDs from the user’s domain and then passes the list of global group SIDs to the
nearest global catalog server. The global catalog server enumerates the member attribute
of all universal groups in the forest, adds all universal groups that contain the user’s SID
as well as all universal groups that contain the SID of any of the global groups in the
user’s SID list, and then returns the list to the domain controller. The authenticating
domain controller caches the global group SIDs and the universal group SIDs that it
retrieves from the global catalog servers and then sends the list of SIDs to the user’s
computer, along with domain local group SIDs from the user’s domain. The user’s local
computer completes the authentication process by creating the access token for the user
and adding the returned SIDs to the access token. The access token is static until the user
logs off and logs on again.
Real World  Domain controllers cache group membership for both user accounts
and computer accounts. Although the term cache seems to imply storage in memory,
cached memberships actually are stored in a nonvolatile Active Directory value.
Therefore, cached memberships are not lost as a result of a restart or power outage.

Enabling Universal Group Membership Caching
You can use the Active Directory Sites And Services tool to configure universal group
membership caching. You enable caching on a per-site basis by completing these steps:
1.                  Start Active Directory Sites And Services from the Tools menu in Server
Manager .
2.                  Select the site in which you want to enable universal group membership
caching, as shown in Figure 5-7.
FIGURE 5-7 Select the site to configure.
3.                  In the right pane, right-click NTDS Site Settings and then select
Properties. This displays the NTDS Site Settings Properties dialog box, shown in
Figure 5-8.
4.                  To enable universal group membership caching for the site, select the
Enable Universal Group Membership Caching check box.
5.                  If the directory has multiple sites, you can replicate existing universal
group membership information from a specific site’s cache by selecting the site on
the Refresh Cache From list. With this option, universal group membership
information doesn’t need to be generated and then replicated; it is simply replicated
from the other site’s cache. If you specify a site, ensure that it has a working global
catalog server.
6.                  If the directory has only one site or you would rather get the information
from a global catalog server in the nearest site, accept the default setting <Default>.
With this option, universal group membership information is generated and then
replicated if no other global catalog servers are available.
7.                  When you finish configuring universal group membership caching, click
OK.

FIGURE 5-8 Configure universal group membership caching.

Monitoring and Troubleshooting Universal Group Membership Caching
When universal membership caching is enabled for a site, domain controllers in the site
cache universal group membership and, as appropriate, global group membership for first-
time logons. They keep the cache updated thereafter. When you configure caching, you
can specify the site from which to retrieve group membership information that has already
been cached. The msDS-Preferred-GC-Site attribute stores the distinguished name of the
specified site and controls this setting. If no site is specified, the closest-site mechanism
uses the cost setting on the site link to determine which site has the least-cost connection
to contact a global catalog server. Keep in mind that if a user has not logged on to the
domain previously and a global catalog server is not available, the user can log on to only
the local computer.
Whereas Active Directory Sites And Services lists only sites with domain controllers,
Active Directory does not check for the presence of a global catalog server in the preferred
site you designate. Therefore, it is possible to designate a refresh site that does not contain
a global catalog server. In this case, or in any case where a refresh site is designated but a
global catalog server does not respond, the authenticating domain controller uses the site
link cost matrix to determine which global catalog server can be contacted and logs event
ID 1668 in the Directory Service event log. This event indicates that the group
membership cache refresh task did not locate a global catalog in a preferred site, but it was
able to find a global catalog in another available site. The event lists the named preferred
site and the actual site that was used.
After a user or computer has logged on in a site that uses universal group membership
caching, the group cache for the account on the authenticating domain controller is
immediately populated. However, it can take up to eight hours for other domain
controllers in the same site to populate the group cache for this account. During this time,
if the account is authenticated by a domain controller that has not populated the account’s
group cache, a global catalog server must be contacted before the logon can proceed. After
eight hours, all domain controllers in the site can process all subsequent logons by using
the cached membership.
Keep in mind that by default, domain controllers update the membership cache for
accounts in a site every eight hours. As a result, changes to the global group or universal
group membership of an account can take up to eight hours to be reflected on domain
controllers in a site where universal group membership caching is enabled. Further,
although there is no limit to the number of accounts that can be cached, a maximum of
500 account caches can be updated during any single cache refresh. Finally, even though
the cache refresh is not a replication event, the process uses the site link schedule, and a
closed site link schedule postpones the cache refresh until the schedule opens.
You can restart Active Directory Domain Services on the domain controllers in a site to
reset the cache refresh interval and trigger a cache refresh. Or you can refresh cached
memberships on individual domain controllers by using Ldp.exe to modify the
updateCachedMemberships attribute on the rootDSE and set a value of 1. Adding a value
of 1 to this attribute instructs the local domain controller to refresh cached memberships.
If the site link schedule allows replication at the time you modify the attribute, this update
occurs right away.

To modify the updateCachedMemberships attribute, complete the following steps:
1.                  Start Ldp.exe on a server other than the one you want to configure by
clicking Start, typing Ldp in the Search box, and then pressing Enter.
2.                  Connect to the target domain controller where you want to reset the cache.
On the Connection menu, click Connect. In the Connect dialog box, shown in
Figure 5-9, enter the domain name or the fully qualified name of the server whose
global catalog readiness you want to verify. In the Port box, enter 389 if this isn’t
already the default value. If the Connectionless check box is selected, clear it and
then click OK.
FIGURE 5-9 Connect to the domain controller where the cache reset is to be performed.
3.                  When you first connect to a domain controller with Ldp, the default
location is rootDSE. You can view the attributes for rootDSE in the details pane.
However, you do not have a binding connection to the domain controller, and
operational attributes are not listed. To bind to the target domain controller so you
can make changes, you must provide authenticated credentials. On the Connection
menu, click Bind.
4.                  In the Bind dialog box, select Bind As Currently Logged On User, if you
currently are logged on using an account that is a member of Domain Admins or
Enterprise Admins, and then click OK. Otherwise, select Bind With Credentials,
provide the required credentials as shown in Figure 5-10, and then click OK.
FIGURE 5-10 Establish an authenticated bind to the domain controller.
5.                  On the Browse menu, click Modify. In the Modify dialog box, shown in
Figure 5-11, in the Edit Entry Attribute box, enter updateCachedMemberships. In
the Values box, enter 1.

6.                  Ensure the operation is set as Add. Do not enter a value in the DN box.
7.                  Click Enter and then click Run. Click Close. If the operation was
successful, Ldp will report “Modified” in the output. Otherwise, Ldp will report an
error such as “Insufficient Access Rights” or “Unwilling To Perform”.
Note  You might receive an insufficient access rights error when you are logged on
locally to the target domain controller rather than connecting remotely. In this case,
repeat this procedure, beginning with step 1, from another server. If you receive an
unwilling to perform error, repeat steps 4 to 6 and ensure you are entering the
correct attribute name.
FIGURE 5-11 Reset the universal group membership cache.


Managing and Maintaining Replication Attributes
Global catalog servers maintain a partial read-only replica of every object in the domain
directory partitions for all other domains in the forest. The attributes that are replicated are
set when you establish a global catalog and can be modified as necessary to customize the
way global catalogs are used on your network.

Understanding Global Catalog Search and the Partial Attribute Set
Clients use Lightweight Directory Access Protocol (LDAP) to query, create, update, and
delete information that is stored in Active Directory. The default TCP port 389 is used for
all domain-level read and write operations. When client queries target configuration,
application, schema, and the local domain directory partitions, the clients make the queries
through this port. LDAP can also run over User Datagram Protocol (UDP), such as for the
domain controller locator process or to query the rootDSE.
Global catalog clients can use LDAP to query Active Directory over a TCP connection
through the default TCP port 3268. If security using Secure Sockets Layer (SSL) is
implemented, the server listens on TCP port 3269 as well. These ports are used for all
global catalog search operations. When client queries target the global catalog directory
partitions, including the local domain or other domain partitions in the forest, the clients
make the queries over one of these ports.
Domain controllers use the replication (REPL) protocol not only for replication but also to
contact the global catalog server when retrieving universal group membership information
and when updating the group membership cache when universal group membership
caching is enabled.
The set of attributes marked for inclusion in the global catalog is referred to as the partial
attribute set (PAS). An attribute is marked for inclusion in the PAS as part of its schema
definition. If an object’s isMemberOfPartialAttributeSet attribute is set to True, the
attribute is replicated to the global catalog.
The attributes that are replicated by default include those that Microsoft determined are
most likely to be used in searches. As an administrator, you can specify additional
attributes that should be replicated by editing the properties of an attribute in the Active
Directory Schema snap-in, selecting the Replicate This Attribute To The Global Catalog
check box, and clicking OK. This sets the value of isMemberOfPartialAttributeSet to
True.
Note  When changes to the partial attribute set are made, domain controllers
replicate only the updated attributes.

Designating Replication Attributes
The contents of the global catalog are determined by the attributes that are replicated for
each object class. Schema administrators can configure additional attributes to be
replicated, and the primary reason for this is to add attributes for which users routinely
search. You shouldn’t add attributes for which users search infrequently. You should
rarely, if ever, remove attributes that are being replicated.
As a member of the Administrators, Domain Admins, or Enterprise Admins group, you
can view Active Directory schema using the Active Directory Schema snap-in for the
Microsoft Management Console (MMC). To change schema, you must be a member of the
Schema Admins group.
The Active Directory Schema snap-in is not available by default. You must install this tool
by registering its DLL. To do this, enter the following at an elevated command prompt.
regsvr32 schmmgmt.dll
Windows should confirm the registration by displaying a success message like the one
shown in Figure 5-12. If you receive an error, ensure you entered the DLL name correctly
and that you are using an elevated command prompt.
FIGURE 5-12 Windows confirms the registration.
After you install the required DLL, you can add the Active Directory Schema snap-in to a
custom console by following these steps:
1.                  Open a blank MMC in Author mode. Press the Windows key, type mmc,
and then press Enter.
2.                  In your MMC, choose Add/Remove Snap-In from the File menu in the
main window. This displays the Add Or Remove Snap-Ins dialog box.
3.                  The Available Snap-Ins list shows all the snap-ins that are available. As
shown in Figure 5-13, select Active Directory Schema and then click Add. The
Active Directory Schema snap-in is added to the Selected Snap-Ins list.
4.                  Now close the Add Or Remove Snap-Ins dialog box by clicking OK, and
return to the console you are creating. You can now use the Active Directory
Schema snap-in to work with directory schema.

FIGURE 5-13 Select the Active Directory Schema snap-in.
When you start the Active Directory Schema snap-in, it establishes a connection to the
schema master for the forest. You can then view and edit the schema for the object whose
attribute you want to replicate in the global catalog. Keep in mind that the snap-in doesn’t
check to ensure that you are a member of the Schema Admins group until you try to
change attribute settings. If you try to change attribute settings and aren’t a member of the
Schema Admins group, the snap-in states that you have insufficient permissions.
You can change replication attributes by completing these steps:
1.                  In Active Directory Schema, expand the Active Directory Schema node
and then select the Attributes node. A list of the attributes for all objects in the
directory appears in the right pane, as Figure 5-14 shows.
FIGURE 5-14 Display available attributes.
2.                  Double-click the attribute you want to replicate to the global catalog.
3.                  In the attribute’s Properties dialog box, you can specify whether the
attribute is replicated. To specify that the attribute should be replicated, select the
Replicate This Attribute To The Global Catalog check box, as shown in Figure 5-
15. To specify that the attribute should not be replicated, clear the Replicate This
Attribute To The Global Catalog check box.

4.                  If you are replicating the attribute and want the attribute to be indexed in
the database for faster search and retrieval, select the Index This Attribute check
box. Although indexing an attribute allows it to be found more quickly, each index
you create slightly increases the size of the Active Directory database.
5.                  Click OK to apply the change.
FIGURE 5-15 Select replication options.

Searching and Indexing Attributes in the Directory
In an attribute’s Properties dialog box, several options for indexing and search are
available, including:
Index This Attribute Indexes the value of the attribute. The index contains all
values of the attribute throughout the directory, and therefore allows searches for
the attribute against objects anywhere in the directory.
Index This Attribute For Containerized Searches Indexes the value of the
attribute relative to the name of the container its stored in and permits searching a
container rather than the entire directory. This improves lookup times for queries
against objects in a single container, as the index size is smaller and probably
faster. For example, if the container is the Engineering OU, a search of this
container for matching values is faster than searching the entire directory database
for matching values.
Ambiguous Name Resolution (ANR) Not in indexing option, instead this
option changes the way searches are performed. When enabled, the attribute is
added to the ANR list and searches requiring ANR will evaluate the queried value
against all attributes on the ANR list. As an example, with Exchange Server,
searches of the global address list using partial information and email lookups use
ANR queries against the global catalog.
Directory searches for attributes that are indexed are more efficient than searches for
attributes that are not indexed. Attributes are indexed in the directory when you select and
apply the Index This Attribute option. Applying this option adds the flag value 1 to the
searchFlags property of the attribute. This tells Active Directory to dynamically build an
index for the attribute, and a background thread on the directory server builds the index
automatically. Conversely, clearing the Index This Attribute option and applying the
change removes the flag value in the searchFlags property of the attribute. This causes
Active Directory to remove the index, and a background thread on the directory server
removes the index.
The values for indexed attributes are stored in a sorted list. This makes searching much
more efficient because Active Directory needs to search only until it locates the area in the
list where the value should be, based on the sort. If the value is not there, Active Directory
can assume it will not find the value anywhere else in the list, and it can terminate the
search. When attributes are not indexed, the entire list must be searched to determine
whether a particular value actually exists. Thus, although Active Directory requires more
storage to maintain indexed lists, indexing can make searching significantly more
efficient. Conversely, nonindexed attributes are less efficient to search, but they require
less storage to maintain.
Because of how indexing works, you should only index attributes that are frequently
referenced. Ideally, the attributes you choose to index will be single-valued attributes
rather than multivalued attributes. Although you can index multivalued attributes, building
the related index requires more storage and updating to maintain.
While indexing an attribute improves the performance of queries run against the attribute,
it doesn’t enable containerized searches. To enable both indexing and containerized

searches, you must first enable indexing by selecting and applying the Index This
Attribute option. Then you must select and apply the Index This Attribute For
Containerized Search option. Enabling both options in this way turns on the Index Over
Container And Attribute flag in the searchFlags property of the attribute. Note that
indexing the attribute for containerized searches will increase the size of the directory
database and also might initially slow down processing.
When you add indexing to an attribute, Active Directory will create the related index or
indexes. You can confirm the index creation using Event Viewer to examine the Directory
Services log. The related 1464 event typically states “A new index will be automatically
created.” In the additional data for the even, you’ll see an error, such as 1404
JET_errIndexNotFound, No Such Index. This is expected as the index hasn’t been created
yet.
Active Directory confirms the index creation is complete with event 1137. Depending on
the amount of data to be indexed, this process can take anywhere from a few seconds to a
few hours. Once the index creation is completed on the active domain controller, the index
modification has to be replicated so other domain controllers can be notified of the change
and build the index according to their own schedules. Thus, in a large AD environment, it
can take some time for the index to be fully available.
Note  Active Directory uses a third type of index for matching strings that contain
certain characters, the tuple index. Tuple indexes are optimized for medial searches,
which is a type of search that allows variations of a value. The variations of the value are
created with the index and as you might imagine, can increase the size of indexes
considerably.
A tuple index is only valid for search strings of four or more characters. Searches using
filters, such as *team*, is an example of a medial search that looks for strings that
contain the characters “team” anywhere in the string. Thus, we could find matches for
TestTeam, TeamOne and more.
When you are editing an attribute’s searchFlags property, you can enable tuple indexes
by adding 32 to the current value. To edit this property you need to connect to use ADSI
Edit and connect to the Schema partition. Keep in mind, the directory database grows
proportionally to the amount of indexed data and the index type—with tuple indexes
potentially requiring a substantial amount of data for storage.
Real World  When you encrypt entire volumes on a directory server with BitLocker
Drive Encryption, you might find that Active Directory detects that a new index is
needed for an encrypted VolumeGUID but is unable to create the index. This can occur
because the volume is encrypted and the directory service is unable to set the required
indexing flag. To resolve the issue, you typically would need to remove the containerized
search option. For more information, see Microsoft Knowledge Base Article 932862
(http://support.microsoft.com/kb/932862/en-us).

Configuring Deferred Index Creation
Windows Server 2012 and later allow you to defer index creation to a designated point in
time, rather than creating indexes as needed. This approach ensures that domain
controllers can perform related tasks during off-peak hours and reduce the impact of index
creation on standard operations. Deferring index creation is useful to prevent domain
controllers from becoming unavailable due to building indexes after schema updates,
especially in large Active Directory environments.
Before you can use deferred index creation, you must enable the feature in the forest root
domain. You do this using ADSI Edit to modify the DSHeuristics attribute of the
Directory Services object for the domain, as discussed in the following steps:
1. Open a new MMC by entering MMC in the Everywhere Search box and then
clicking the mmc entry in the search results.
2. Use the Add/Remove Snap-in option on the File menu to add the ADSI Edit snap-
in to the MMC.
3. In ADSI Edit, right-click the root node and then select Connect To.
4. Connect to the Configuration naming context for the domain. In the Connection
Settings dialog box, choose the Select A Well Known Naming Context option. On
the related selection list, select Configuration and then click OK.
5. In ADSI Edit, work your way down to the CN=Directory Service container by
expanding the Configuration naming context, the CN=Configuration container,
the CN=Services container, and the CN=Windows NT container.
6. Right-click CN=Directory Service and then select Properties.
7. In the Properties dialog box, select the dsHeuristics properties and then click Edit.
To enable deferred indexing, set the 18th bit of this attribute to 1. Because the
10th bit of this attribute typically also is set to 1, the attribute typically is set to
000000000100000001.
8. In the String Attribute Editor dialog box, type the desired value, such as
000000000100000001, and then click OK twice.
Once the change is replicated to all domain controllers in the forest, they will defer index
creation automatically. You must then trigger index creation manually either by restarting
domain controllers, which rebuilds the schema cache and deferred indexes automatically,
or by triggering a schema update for the RootDSE.
In ADSI Edit, you can trigger a schema update by completing the following steps:
1. Right-click the root node and then select Connect To.
2. In the Connection Settings dialog box, choose the Select A Well Known Naming
Context option. On the related selection list, select RootDSE and then click OK.
3. In ADSI Edit, right-click the RootDSE node and then select Update Schema Now.
Any attribute that is in a deferred index state will be logged in the Event log every 24
hours. Check for event IDs 2944 and 2945. When index creation is triggered, event ID
1464 is logged. Then when index creation is completed, event ID 1137 is logged.

Monitoring and Troubleshooting Replication Attributes
Every global catalog server in an Active Directory forest hosts a copy of every existing
object in that forest. For objects of their own domain, global catalog servers store
information related to all attributes that are associated with those objects. For objects in all
other domains, global catalog servers store only information attributes that are marked for
replication. As discussed previously, if you want to replicate an attribute, you do so by
adding the attribute to the partial attribute set.
When you change the partial attribute set on the domain controller that has the schema
operations master role, the writeable schema directory partition replicates, using standard
replication, to all domain controllers in the forest. Later, when a global catalog server
attempts to synchronize its read-only directory partition from a source replication partner,
the global catalog server receives the information that the replication attributes have been
updated and initiates replication of only the attributes that were added to the partial
attribute set. Because only the added attributes are replicated, there is limited network
impact from the replication activity.
As discussed in Chapter 9, “Maintaining and Recovering Active Directory,” you can use
Repadmin to view the replication information on domain controllers. Using Repadmin,
you can:
View directory metadata.
Determine the last successful replication of all directory partitions.
Identify inbound and outbound replication partners.
Identify domain controllers, global catalog servers, and bridgehead servers.
Manage Active Directory replication topology.
Force replication of an entire directory partition or of a single object.
To review the status of replication, enter repadmin /showrepl at an elevated command
prompt.
For each directory partition that the global catalog server hosts, the global catalog server
records related updates in the Directory Service log. Event ID 1704 states that in response
to the addition of one or more attributes to the partial attribute set, the global catalog
server has initiated replication of the partial attribute set for a specified directory partition
from a specified domain controller. Event ID 1703 states that synchronization was
initiated. Event ID 1702 states that synchronization of the partial attribute set was
completed successfully. If these and other related events are not being recorded on a
global catalog server, there is a problem.


Managing and Maintaining Name Suffixes
Active Directory uses name suffix routing for routing authentication between domains and
across forests that are joined by forest trusts. Within forests, global catalog servers resolve
names to enable cross-domain authentication. When a forest trust is created, all unique
name suffixes are routed by default to enable authentication across forests.

Configuring User Principal Name Suffixes
Every user account has a user principal name (UPN), which consists of the User Logon
Name joined with a UPN suffix by the at sign (@). The names of the current domain and
the root domain are set as the default UPN suffix. You can specify an alternate UPN suffix
to use to simplify logon or provide additional logon security. This name is used only
within the forest and does not have to be a valid DNS name. For example, if the UPN
suffix for a domain is it.seattle.imaginedlands.local, you could use an alternate UPN suffix
to simplify this to imaginedlands.local. This would allow the user Williams to log on using
williams@imaginedlands.local rather than williams@it.seattle.imaginedlands.local.
If you want alternate UPN suffixes to be available when you are creating accounts, you
can add them to Active Directory by using Active Directory Domains and Trusts. When
you add a UPN suffix, the suffix is available for all domains within the Active Directory
forest.
You can add or remove UPN suffixes by completing the following steps:
1.                  Start Active Directory Domains and Trusts from the Tools menu in Server
Manager.
2.                  Right-click the Active Directory Domains And Trusts node and then click
Properties.
3.                  As shown in Figure 5-16, the UPN Suffixes tab of the properties dialog
box will list all current UPN suffixes. To add a UPN suffix, enter the alternate
suffix in the box provided and then click Add. To remove a UPN suffix, click the
suffix in the list provided and then click Remove.
4.                  Click OK to apply your changes.
When you use UPN suffixes, you change the way authentication works. Because the
domain of the user is not necessarily the same as the UPN suffix, the authenticating
domain controller must determine whether the DNS name in the UPN suffix is the domain
for which the domain controller is authoritative.
If the domain name in the UPN suffix matches the domain of the domain controller, the
domain controller attempts to process the client authentication. Otherwise, the domain
controller contacts a global catalog server.

FIGURE 5-16 Review and modify UPN suffixes as necessary.
The global catalog server uses the userPrincipalName attribute of the user object to look
up the distinguished name of the user object and returns this value to the authenticating
domain controller. The authenticating domain controller extracts the domain name from
the distinguished name of the user and returns this value to the client. The client then
requests a domain controller for the user’s domain.

Configuring Name Suffix Routing
When a forest trust is created, all unique name suffixes are routed by default. These
include user principal name (UPN) suffixes and service principal name (SPN) suffixes as
well as Domain Name System (DNS) forest or domain tree names that are not subordinate
to any other name suffix. For example, the DNS forest name imaginedlands.com is a
unique name suffix within the imaginedlands.com forest.
All names that are subordinate to unique name suffixes are routed implicitly. For example,
if your forest uses imaginedlands.com as a unique name suffix, authentication requests for
all child domains of imaginedlands.com will be routed because the child domains are part
of the imaginedlands.com name suffix. If you want to exclude members of a child domain
from authenticating in the specified forest, you can disable name suffix routing for that
name. You can also disable routing for the forest name itself, if necessary.
You cannot enable a name suffix that is the same as another name in the routing list. If the
conflict is with a local UPN name suffix, you must remove the local UPN name suffix
from the list before you can enable the routing name. If the conflict is with a name that is
claimed by another trust partner, you must disable the name in the other trust before it can
be enabled for a particular trust.
If you want to prevent or allow authentication requests for all name suffixes that are
identified by a forest trust (such as any request for a domain in the reagentpress.com
forest) from being routed to a forest, you can disable routing for the forest name. You can
enable or disable routing for a name suffix by using the Active Directory Domains and
Trusts snap-in. Keep in mind that when you disable a name suffix, the DNS name and all
child names of that name will be disabled.
To modify routing for a forest name suffix, follow these steps:
1.                  Start Active Directory Domains and Trusts from the Tools menu in Server
Manager.
2.                  In the console tree, right-click the forest root domain for the forest trust
that you want to manage, and then click Properties.
3.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
forest trust that you want to administer, and then click Properties.
4.                  On the Name Suffix Routing tab, under Name Suffixes, do one of the
following:
To enable routing for a name suffix, click the suffix that you want to enable and
then click Enable. If the Enable button is unavailable, the name suffix is already
enabled.
To disable routing for a name suffix, click the suffix that you want to disable and
then click Disable. If the Disable button is unavailable, the name suffix is already
disabled.
Another way to control name suffix routing is to enable or disable a name suffix that is
subordinate to the name of a forest. For example, if the reagentpress.com forest trusts the
imaginedlands.com forest and the imaginedlands.com forest includes the child domain

sales.imaginedlands.com, you can enable or disable routing specifically for the child
domain name suffix.
To modify routing for an existing subordinate name suffix, follow these steps:
1.                  Start Active Directory Domains and Trusts from the Administrative Tools
menu.
2.                  In the console tree, right-click the forest root domain node for the forest
trust that you want to administer, and then click Properties.
3.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
forest trust that you want to manage, and then click Properties.
4.                  On the Name Suffix Routing tab, under Name Suffixes, click the forest
suffix whose subordinate name suffix you want to modify for routing and then click
Edit.
5.                  In Existing Name Suffixes, click the suffix that you want to modify, and
then click Enable or Disable.
You can exclude existing name suffixes from routing to a forest. When you exclude a
name suffix, the DNS name and all child names of that name will be excluded. To exclude
name suffixes from routing to a forest, follow these steps:
1.                  Start Active Directory Domains and Trusts from the Administrative Tools
menu.
2.                  In the console tree, right-click the domain that you want to administer and
then click Properties.
3.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
forest trust that you want to administer, and then click Properties.
4.                  On the Name Suffix Routing tab, under Name Suffixes, click the unique
name suffix whose subordinate name suffix you want to exclude from routing, and
then click Edit.
5.                  In Name Suffixes To Exclude From Routing, click Add, enter a DNS name
suffix that is subordinate to the unique name suffix, and then click OK.


Chapter 6. Configuring, Maintaining,
and Troubleshooting Operations Masters
Active Directory’s multimaster replication model creates a distributed environment that
allows any domain controller to be used for authentication and allows you to make
changes to standard directory information without regard to which domain controller you
use. The approach works well for most Active Directory operations—but not all.
Some Active Directory operations must be carefully controlled to maintain the integrity of
the directory structure and data. These operations can be performed only by a single
authoritative domain controller called an operations master. For example, you can make
schema changes only on the domain controller serving as the schema master; if that server
is unavailable, no changes can be made to the schema.
As an administrator, you have the responsibility to ensure that operations masters are
always available and configured appropriately to handle their respective tasks. In this
chapter, you will learn how operations masters are used as well as how to manage,
maintain, and troubleshoot operations masters.


Operations Master Essentials
Operations masters keep the directory functioning properly by performing specific tasks
that no other domain controllers are permitted to perform. A designated operations master
has a flexible single-master operations (FSMO) role.

Introducing Operations Masters
As Table 6-1 depicts, there are five designated operations master roles, which can be
organized into two broad categories. Forestwide roles are assigned on a per-forest basis.
This means that there is only one schema master and only one domain naming master in
an Active Directory forest. Domainwide roles are assigned on a per-domain basis. This
means there is only one infrastructure master, PDC emulator, and relative ID master for
each domain in an Active Directory forest.
TABLE 6-1 Available Operations Masters by Category
Forestwide
Domain naming master
Schema master
Domainwide
Infrastructure master
Primary domain controller (PDC) emulator
Relative Identifier (RID) master
In an Active Directory forest, the domain naming master and schema master perform
forest-level operations. The domain naming master controls domain creation and deletion,
guaranteeing that each domain is unique within the forest. The schema master manages
the schema and enforces schema consistency throughout the directory.
In an Active Directory domain, the infrastructure master, PDC emulator, and RID master
perform domain-level operations. The infrastructure master handles user-to-group
mappings, changes in group membership, and replication of those changes to other
domain controllers. The PDC emulator is responsible for processing and replicating
password changes and also must be available to reset and verify external trusts. The RID
master manages the pool of relative identifiers (RIDs). RIDs are numeric strings used to
construct security identifiers (SIDs) for security principals.
The first domain controller you install in the forest automatically receives the schema
master and domain naming master roles. It also hosts the global catalog. Because the roles
are compatible with the global catalog and moving the roles to other domain controllers
does not improve performance, you can leave the roles on the initial domain controller.
Note also that separating the roles creates additional administrative overhead when you
must identify the operations masters and when you implement backup and restore
procedures.
When you install the first domain controller in a new domain, it is assigned the three
domain-level roles. Generally, you will want to keep the domain-level roles together
unless the workload on your operations master justifies the additional management burden
of separating the roles. For this reason, in nonforest root domains, you will probably want
to leave the domain-level roles on the first domain controller (as long as you do not
configure the domain controller as a global catalog server).
For the forest root domain, however, the first domain controller created in the domain
hosts forest-level roles and all three domain-level roles, as well as the global catalog.

However, the infrastructure master role is incompatible with the global catalog. Because
of this, when you install the second domain controller in the forest root domain, the Active
Directory Domain Services Installation Wizard prompts you to allow the wizard to
transfer the infrastructure master role. If you transfer the role, you may also want to
consider transferring the PDC emulator and RID master roles to the second domain
controller after you install Active Directory Domain Services. This will keep the three
domain-level roles together for easy administration.

Identifying Operations Masters
You can determine the current operations masters for your logon domain by entering the
following at a command prompt.
netdom query fsmo
In the following example, the output lists each role owner by its fully qualified domain
name.
Schema master                CentralDC17.imaginedlands.com
Domain naming master           CentralDC17.imaginedlands.com
PDC                  CorpServer38.ny.imaginedlands.com
RID pool manager            CorpServer38.ny.imaginedlands.com
Infrastructure master        CorpServer15.ny.imaginedlands.com
From the output in this example, you can also determine that the forest root domain is
imaginedlands.com and the current logon domain is ny.imaginedlands.com. If you want to
determine the operations masters for a specific domain, use the following command.
netdom query fsmo /d:DomainName
Here, DomainName is the name of the domain, such as sales.imaginedlands.com.
For Windows PowerShell, use Get-ADDomain to get information about domains,
including the forest root domain, the domain mode, and the domain-level operations
masters. Use the –Identity parameter to specify the fully qualified name of the domain to
examine. If you don’t specify a domain, the cmdlet displays information about the current
logon domain.
When you use Get-ADDomain, you’ll get a lot of information. To get more focused
information about the domain, you can enter:
get-addomain | fl forest, *mode, *master, pdc*
The output will then look similar to the following:
forest               : imaginedlands.local
DomainMode           : Windows2012R2Domain
InfrastructureMaster : CorpServer64.imaginedlands.local
RIDMaster            : CorpServer64.imaginedlands.local
PDCEmulator          : CorpServer64.imaginedlands.local
Use Get-ADForest to get information about forests, including the forest mode, the forest-
level operations masters. Again, the output provides a lot of additional information. To get
more focused information about the forest, you can enter:
get-adforest | fl forestmode, root*, *master
The output will then look similar to the following:
forestmode         : Windows2012R2Forest
RootDomain         : imaginedlands.local
DomainNamingMaster : CorpServer64.imaginedlands.local
SchemaMaster       : CorpServer64.imaginedlands.local

Planning for Operations Masters
To perform their respective operations, the domain controllers that host operations master
roles must be consistently available and must be located in highly available areas of your
network. As you enlarge your Active Directory infrastructure by adding domains and sites,
the careful placement of your operations masters becomes more and more important.
Improper placement of operations master role holders can:
Prevent users and computers from maintaining their passwords.
Prevent administrators from being able to add domains and new objects.
Prevent administrators from making changes to schema.
Prevent updated group membership information from being replicated.
As your Active Directory infrastructure changes, you must work to avoid the problems
that are associated with improper operations master role placement, and you might need to
reassign the roles to other domain controllers. As you design any forest or domain,
consider how many domain controllers you need per domain and whether you need to
change operations masters after you install new domain controllers.

Changing Operations Masters
Operations master roles can be changed in several ways. If the current operations master is
online, you can perform a role transfer, gracefully shifting the role from one domain
controller to another. If the current operations master has failed and will not be coming
back online, you can seize the role and forcibly transfer it to another domain controller.
When you transfer a role, as discussed later in this chapter in “Working with Operations
Masters,” you move an operations master role from one domain controller to another.
During the role transfer, the two domain controllers exchange any unreplicated
information to ensure that no transactions are lost. If the two domain controllers are not
direct replication partners, a substantial amount of information might have to be replicated
before the domain controllers are completely synchronized with each other. If the two
domain controllers are direct replication partners, there should be fewer outstanding
transactions and the role transfer operation should complete faster. Once the transfer is
complete, the previous role holder no longer attempts to perform as the operations master,
and this eliminates the possibility of duplicate operations masters existing on the network.
Transferring a role is preferred to seizing a role. You reassign an operations master role by
seizing it as a last restore. If you must seize a role, never reattach the previous role holder
to the network without taking appropriate precautions to prevent the previous role holder
from being active. Otherwise, reattaching the previous role holder to the network
incorrectly can result in invalid data and corruption of data in the directory. For more
information, see “Seizing Operations Master Roles” later in this chapter.
The reasons for transferring the operations master roles depend on several factors. First,
you might want to transfer an operations master role to improve performance, as you
might do when a server has too heavy a workload and you need to distribute some of the
load. Second, you might need to transfer an operations master role if you plan to take the
server with that role offline for maintenance or if the server fails. Keep in mind that
although operations master roles can be placed on just about any writeable domain
controller, operations master roles cannot be placed on read-only domain controllers
(RODCs).
When determining placement of operations masters, you should place the forestwide roles,
schema master, and domain naming master on the same domain controller. There is very
little overhead associated with these roles, so placement on the same server adds little load
overall. However, it is important to safeguard this server because these are critical roles in
the forest. In addition, the server acting as the domain naming master should also be a
global catalog server.
You should place the relative ID master and PDC emulator roles on the same domain
controller. The reason for this is that the PDC emulator uses more relative IDs than most
other domain controllers. If the relative ID master and PDC emulator roles aren’t on the
same domain controller, the domain controllers on which they are placed should be in the
same Active Directory site, and the domain controllers should have a reliable connection
between them.
You should not place the infrastructure master on a domain controller that is also a global
catalog server. The reason for this is a bit complicated, and there are some important

exceptions to note. The infrastructure master is responsible for updating cross-domain
group membership and determines whether its information is current or out of date by
checking a global catalog and then replicating changes to other domain controllers as
necessary. If the infrastructure master and the global catalog are on the same server, the
infrastructure master doesn’t see that changes have been made and thus doesn’t replicate
them.
The exceptions are for a single-domain forest or a multidomain forest where all domain
controllers are global catalog servers. In the case of a single-domain forest, there are no
cross-group references to update, so it doesn’t matter where the infrastructure master is
located. In the case of a multidomain forest where all domain controllers are global
catalog servers, all the domain controllers know about all the objects in the forest already,
so the infrastructure master doesn’t really have to make updates.
Do not change the global catalog configuration of a domain controller that you intend to
assume an operations master role. Modifying the global catalog configuration can cause
changes within the directory that can take several days to complete, and the domain
controller might be unavailable during that time.


Working with Operations Masters
The key to successful management of operations masters is in knowing what each
operations master does and being able to readily diagnose problems that arise when an
operations master isn’t functioning properly. In addition to guidelines I provided
previously for placing operations masters, you may want to consider transferring the three
domain-level roles from the first domain controller that you installed in the forest root
domain to an additional domain controller that has a high performance level. In all other
domains, leave the domain-level roles on the first domain controller unless there is a
compelling reason to move the roles. Finally, you should prepare additional domain
controllers as standby operations masters and carefully monitor the workload of the
busiest operations master—the PDC emulator.

Managing Domain Naming Masters
The domain naming master is responsible for adding and removing domains from the
forest. Any time you create a domain, a remote procedure call (RPC) connection is made
to the domain naming master, which assigns the domain a globally unique identifier
(GUID). Any time you remove a domain, an RPC connection is made to the domain
naming master and the previously assigned GUID reference is removed. If you cannot
connect to the domain naming master when you are trying to add or remove a domain, you
will not be able to create or remove the domain.
You can locate the RID master for the current forest by entering the following command at
a Windows PowerShell prompt:
(Get-ADForest).DomainNamingMaster
You also can locate the domain naming master by following these steps:
1.                  Start Active Directory Domains And Trusts from the Tools menu in Server
Manager.
2.                  Right-click the Active Directory Domains And Trusts node, and then
select Operations Master.
The Operations Master dialog box, shown in Figure 6-1, shows the current domain
naming master.
FIGURE 6-1 Locate the domain naming master.
You can transfer the domain naming master role to another server by following these
steps:
1.                  Open Active Directory Domains And Trusts. Right-click the Active
Directory Domains And Trusts node, and then select Change Active Directory
Domain Controller.
2.                  In the Change Directory Server dialog box, select This Domain Controller
Or LDS Instance. Enter the forest root domain name in the Look In This Domain
field, and then press Tab.
3.                  Available domain controllers are listed by site, type, and operating system
version. Select an available domain controller to which you want to transfer the

domain naming master role, and then click OK.
4.                  Right-click the Active Directory Domains And Trusts node, and then
select Operations Master. The name of the current domain naming master appears
in the first text box. The domain controller to which you want to transfer the
domain naming master role should appear in the second text box. If this is not the
case, repeat this procedure, starting with step 1.
5.                  In the Change Operations Master dialog box, click Change, and then click
Close. When prompted, click Yes to confirm you want to transfer the role.
6.                  When the transfer is complete, you’ll see a message confirming this. Click
OK. Click Close to close the Operations Master dialog box.

Managing Infrastructure Masters
The infrastructure master is responsible for updating objects for any attribute values with
distinguished names that reference objects outside the current domain. These updates are
particularly important for cross-domain group-to-security-principal references where the
infrastructure master is responsible for ensuring that changes to the common name of
security principal objects are correctly reflected in the group membership information for
groups in other domains in the forest. The infrastructure master does this by comparing its
directory data to that of a global catalog. If the data is outdated, it updates the data and
replicates the changes to other domain controllers in the domain. If for some reason the
infrastructure master is unavailable, group-to-security-principal references will not be
updated, and cross-domain group membership may not accurately reflect the actual names
of security principal objects.
To see how this process works, consider the following example:
1.                  A user in domain A is a member of a group in domain B. The user gets
married, and her surname is changed in the first domain. This change affects name-
related attributes of the related user object, including the Full Name and Last Name,
and also typically changes the DN attribute value of the user object. (The
distinguished name (DN) is the value that is used in the member attribute of group
objects.)
2.                  Because domain controllers in one domain do not replicate security
principals to domain controllers in another domain, the second domain never
receives the change. As a result, an out-of-date value on the member attribute of a
group in another domain could result in denied privileges for the user whose name
has changed.
3.                  To ensure consistency between domains, the infrastructure master monitors
group memberships, looking for member attribute values that identify security
principals from other domains. If it finds a cross-domain reference, it compares its
stored distinguished name value with the distinguished name value in the
originating domain to determine if the information has changed. If the distinguished
name has changed, the infrastructure master performs an update and then replicates
the change to other domain controllers in its domain.
Tip  Except for the infrastructure master, you can assign operations master roles to any
domain controller regardless of any other directory functions that the domain controller
performs. Do not host the infrastructure master role on a domain controller that is also
acting as a global catalog server unless all the domain controllers in the domain are
global catalog servers or unless the forest has only one domain. If the domain controller
that hosts the infrastructure master role is configured to be a global catalog server, you
must transfer the infrastructure master role to another domain controller.
Real World  The infrastructure master is incompatible with the global catalog, and it
must not be placed on a global catalog server. However, if all the domain controllers in a
domain are global catalog servers, the domain controller that hosts the infrastructure
master role is inconsequential because global catalog servers replicate updated security
principal information to all other global catalog servers. If the forest has only one

domain, the infrastructure master role is inconsequential as well because security
principals from other domains do not exist.
You can locate the infrastructure master for the current logon domain by entering the
following command at a Windows PowerShell prompt:
(Get-ADDomain).InfrastructureMaster
You also can locate the infrastructure master by following these steps:
1.                  Start Active Directory Users And Computers from the Tools menu in
Server Manager.
2.                  If the domain you want to work with isn’t listed already, right-click the
Active Directory Users And Computers node, and then select Change Domain. In
the Change Domain dialog box, enter the DNS name of the domain you want to
work with, such as cs.imaginedlands.com, and then click OK.
3.                  Right-click the domain you want to work with and then select Operations
Masters.
4.                  The Operations Masters dialog box, shows the current infrastructure
master on the Infrastructure tab. (See Figure 6-2.)
You can transfer the infrastructure master role to another server by following these steps:
1.                  Open Active Directory Users And Computers. If the domain you want to
work with isn’t listed already, right-click the Active Directory Users And
Computers node, and then select Change Domain. In the Change Domain dialog
box, enter the DNS name of the domain you want to work with, such as
cs.imaginedlands.com, and then click OK.
2.                  Right-click the domain node, and then select Change Domain Controller.
In the Change Directory Server dialog box, select This Domain Controller. Select
an available domain controller to which you want to transfer the infrastructure
master role, and then click OK.
3.                  Right-click the domain node again, and then select Operations Masters. In
the Operations Masters dialog box, select the Infrastructure tab. The name of the
current infrastructure master appears in the first text box. The domain controller to
which you want to transfer the infrastructure master role should appear in the
second text box. If this is not the case, repeat this procedure, starting with step 1.
4.                  Click Change, and then click Close. When prompted, click Yes to confirm
you want to transfer the role.
5.                  When the transfer is complete, you’ll see a message confirming this. Click
OK. Click Close to close the Operations Masters dialog box.

FIGURE 6-2 Locate the infrastructure master.

Managing PDC Emulators
A domain controller with the PDC emulator role is responsible for processing password
changes. When a user changes a password, the change is first sent to the PDC emulator,
which in turn replicates the change to all the other domain controllers in the domain. This
makes the PDC emulator the definitive source for the latest password information
whenever a logon attempt fails as a result of a bad password.
Every domain controller in a domain knows which server has the PDC emulator role. If a
user tries to log on to the network but provides an incorrect password, the domain
controller checks the PDC emulator to see if it has a recent password change for this
account. If so, the domain controller retries the logon authentication on the PDC emulator.
This approach is designed to ensure that if a user has recently changed a password, he is
not denied logon with the new password.
As a result of this logon authentication activity, the PDC emulator operations master role
has the highest impact on the performance of the domain controller that hosts that role out
of all the operations master roles. Note that the PDC emulator in the forest root domain is
also the default Windows Time service (W32time) time source for the forest.
You can locate the PDC Emulator for the current logon domain by entering the following
command at a Windows PowerShell prompt:
(Get-ADDomain).PDCEmulator
You also can locate the PDC emulator by following these steps:
1.                  Open Active Directory Users And Computers from the Tools menu in
Server Manager. If the domain you want to work with isn’t listed already, right-
click the Active Directory Users And Computers node, and then select Change
Domain. In the Change Domain dialog box, enter the DNS name of the domain you
want to work with, such as cs.imaginedlands.com, and then click OK.
2.                  Right-click the domain node and then select Operations Masters.
3.                  The Operations Masters dialog box shows the current PDC emulator on
the PDC tab. (See Figure 6-3.)

FIGURE 6-3 Locate the PDC emulator.
You can transfer the PDC emulator role to another server by following these steps:
1.                  Open Active Directory Users And Computers. If the domain you want to
work with isn’t listed already, right-click the Active Directory Users And
Computers node, and then select Change Domain. In the Change Domain dialog
box, enter the DNS name of the domain, and then click OK.
2.                  Right-click the domain node, and then select Change Domain Controller.
In the Change Directory Server dialog box, select This Domain Controller. Select
an available domain controller to which you want to transfer the PDC emulator
role, and then click OK.
3.                  Right-click the domain node again, and then select Operations Master. In
the Operations Masters dialog box, select the PDC tab. The name of the current
PDC emulator appears in the first text box. The domain controller to which you
want to transfer the PDC emulator role should appear in the second text box. If this
is not the case, repeat this procedure, starting with step 1.
4.                  Click Change, and then click Close. When prompted, click Yes to confirm
you want to transfer the role.
5.                  When the transfer is complete, you’ll see a message confirming this. Click
OK. Click Close to close the Operations Masters dialog box.

Managing Relative ID Masters
The relative identifier (RID) master controls the creation of new security principals such
as users, groups, and computers throughout its related domain. Every domain controller in
a domain is issued a block of relative IDs by the RID master. These relative IDs are used
to build the security IDs that uniquely identify security principals in the domain. The
actual security ID generated by a domain controller consists of a domain identifier, which
is the same for every object in a domain, and a unique relative ID that differentiates the
object from any other objects in the domain.
The block of relative IDs issued to a domain controller is called an RID pool. Newly
promoted domain controllers must acquire an RID pool before they can advertise their
availability to Active Directory clients or share the SYSVOL. Existing domain controllers
require additional RID allocations in order to continue creating security principals when
their current RID pool becomes depleted. Since RIDs are 30 bits in length, a maximum of
1,073,741,824 (2^30) security principals can be created in an Active Directory domain.
After the domainwide RID pool is used up, no new security principals can be created in
the domain.
Typically, blocks of relative IDs are issued in lots of 500. A domain controller will start to
request a new pool when 250 (50 percent of 500) RIDs have been used. It is the job of the
RID master to issue blocks of RIDs, and it does so as long as it is running. If a domain
controller cannot connect to the RID master and for any reason runs out of RIDs, no new
objects can be created on the domain controller, and object creation will fail. Event 16645
and optionally event 16651 are logged in the Directory Service log on domain controllers
that cannot acquire new RID pools. The message text for the respective events are:
Event 16645 The maximum account identifier allocated to this domain controller
has been assigned. The domain controller has failed to obtain a new identifier pool. A
possible reason for this is that the domain controller has been unable to contact the
master domain controller. Account creation on this controller will fail until a new
pool has been allocated. There may be network or connectivity problems in the
domain, or the master domain controller may be offline or missing from the domain.
Verify that the master domain controller is running and connected to the domain.
Event 16651 The request for a new account-identifier pool failed. The operation
will be retried until the request succeeds. The error is %n “ %1“.
To resolve this problem, the RID master must be made available, or the RID master role
must be transferred to another server.
Real World  The RID Block Size setting in the registry can be used to increase the RID
pool size. Increasing the RID pool size makes it possible for each domain controller to
create a larger number of security principals without contacting the RID operations
master. Although you only need to make the change on the RID master, you may want to
configure the value on all domain controllers in case you later transfer the RID
operations master role to another domain controller.
The RID Block Size setting is used by the RID operations master to determine what size
RID pool to return to a requesting domain controller. The RID Block Size setting has a
REG_DWORD value and is located under

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\RID Values.
Windows Server creates the RID Block Size setting automatically and its default value is
0. In this state, the internal default of 500 is used. Setting this value to less than 500 has
no effect, and the default setting is still used. While no maximum block size is enforced,
a value that is too large can have a severe adverse affect on the domain. Why? If you
allocate RIDs in very large blocks, some domain controllers may run out of RIDs and
may not be able to get new RIDs, while other domain controllers may have a large
number of unused RIDs. Additionally, every time a domain controller is decommissioned
through graceful or forceful demotion or because of a hardware failure, its RIDs are all
lost. Similarly, every time a domain controller is restored from backup, its RIDs are all
invalidated to help prevent more than one user account from being assigned the same
RID.
You can locate the RID master for the current logon domain by entering the following
command at a Windows PowerShell prompt:
(Get-ADDomain).RIDMaster
You also can locate the RID master by following these steps:
1.                  Start Active Directory Users And Computers from the Tools menu in
Server Manager.
2.                  If the domain you want to work with isn’t listed already, right-click the
Active Directory Users And Computers node, and then select Change Domain. In
the Change Domain dialog box, enter the DNS name of the domain you want to
work with, such as cs.imaginedlands.com, and then click OK.
3.                  Right-click the domain you want to work with and then select Operations
Masters.
4.                  The Operations Masters dialog box shows the current RID master on the
RID tab. (See Figure 6-4.)

FIGURE 6-4 Locate the RID master.
You can transfer the RID master role to another server by following these steps:
1.                  Start Active Directory Users And Computers. If the domain you want to
work with isn’t listed already, right-click the Active Directory Users And
Computers node, and then select Change Domain. In the Change Domain dialog
box, enter the DNS name of the domain, and then click OK.
2.                  Right-click the domain node, and then select Change Domain Controller.
In the Change Directory Server dialog box, select This Domain Controller. Select
an available domain controller to which you want to transfer the RID master role,
and then click OK.
3.                  Right-click the domain node again, and then select Operations Masters. In
the Operations Masters dialog box, the RID tab is selected by default. The name of
the current RID master appears in the first text box. The domain controller to which
you want to transfer the RID master role should appear in the second text box. If
this is not the case, repeat this procedure, starting with step 1.
4.                  Click Change, and then click Close. When prompted, click Yes to confirm
you want to transfer the role.
5.                  When the transfer is complete, you’ll see a message confirming this. Click
OK. Click Close to close the Operations Masters dialog box.

Managing Schema Masters
The schema master is the only domain controller in the forest with a writeable copy of the
schema container. This means that it is the only domain controller in the forest on which
you can make changes to the schema. You make changes to the schema using the Active
Directory Schema snap-in. When you start the Active Directory Schema snap-in, it makes
a direct connection to the schema master, allowing you to view the schema for the
directory. To make changes to the schema, however, you must use an account that is a
member of the Schema Admins group.
By default, the schema master is the first domain controller installed in the forest root
domain. You can transfer this role using the Active Directory Schema snap-in or the
NTDSUTIL command-line utility.
You can locate the schema master for the current forest by entering the following
command at a Windows PowerShell prompt:
(Get-ADForest).SchemaMaster
You also can locate the schema master using the Active Directory Schema snap-in in a
custom console. (For tips on registering and using this snap-in, see the section
“Designating Replication Attributes” in Chapter 5, “Configuring, Maintaining, and
Troubleshooting Global Catalog Servers.”) After you open the snap-in, right-click the
Active Directory Schema node, and then select Operations Master. The Change Schema
Master dialog box, shown in Figure 6-5, shows the current schema master.
Figure 6-5 Locate the schema master.
You can transfer the schema master role to another server by following these steps:
1.                  Open the Active Directory Schema snap-in in a custom console. Right-
click the Active Directory Schema node, and then select Change Active Directory
Domain Controller.
2.                  In the Change Directory Server dialog box, select This Domain Controller
Or LDS Instance. Enter the forest root domain name in the Look In This Domain
field, and then press Tab.
3.                  Available domain controllers are listed by site, type, and operating system
version. Select an available domain controller to which you want to transfer the

schema master role, and then click OK.
4.                  Right-click the Active Directory Schema node, and then select Operations
Master. In the Change Schema Master dialog box, the name of the current schema
master appears in the first text box. The domain controller to which you want to
transfer the schema master role should appear in the second text box. If this is not
the case, repeat this procedure, starting with step 1.
5.                  Click Change, and then click Close. When prompted, click Yes to confirm
you want to transfer the role.
6.                  When the transfer is complete, you’ll see a message confirming this. Click
OK. Click Close to close the Operations Master dialog box.


Maintaining Operations Masters
As an administrator, you’ll perform a number of tasks to help maintain operations masters
throughout the Active Directory forest. To help recover operations masters quickly, you
may want to prepare standby operations masters. To ensure proper operations, you may
need to reduce an operations master’s workload. In the event of catastrophic failure, you
may need to forcibly transfer an operations master role.

Preparing Standby Operations Masters
Operations master roles are critical to proper forest and domain function. When you install
Active Directory and create the first domain controller in a new forest, all five roles are
assigned to that domain controller. As you add domains, the first domain controller you
install in a domain is automatically designated the RID master, infrastructure master, and
PDC emulator roles for that domain.
If an operations master becomes inoperable or unreachable, the functions that the
operations master performs will no longer be available, and this could cripple Active
Directory. To ensure you are ready to handle the failure of an operations master, you can
identify an additional domain controller as a standby operations master. A standby
operations master is simply a domain controller that you identify to assume the operations
master role if the role holder fails.
You will need to identify a standby for the forest roles in the forest root domain and a
standby for the domain roles in each domain. The standby should be optimally connected
to the current role holder, which ensures that role transfer can occur as quickly as possible
and that there is minimal data loss in the event of an outage.
Other than ensuring a standby is available and optimally connected to the current
operations master, you don’t need to take any other special steps. That said, you can create
a manual connection object between the standby domain controller and the operations
master to ensure direct replication between the two operations masters. In this scenario, a
manually created connection object is preferred to an automatically created one because
Active Directory can alter automatically created connection objects at any time whereas
manually created connections remain the same until you change them. Being directly
connected helps reduce the chance of data loss in the event of a role seizure and in turn
helps to reduce the chance of directory corruption.
Note  If you separate operations roles, you can still use a single standby operations
master for a forest and a single operations master for a domain. However, you
should ensure that the standby is a replication partner with all of the role holders.
Using an account that is a member of the Domain Admins or Enterprise Admins group,
you can manually create a connection object on the operations master and standby by
following these steps:
1.                  Start Active Directory Sites and Services from the Tools menu in Server
Manager.
2.                  Expand the site name in which the current operations master role holder is
located to display the related Servers folder.
3.                  Expand the related Servers folder to see a list of the servers in the selected
site.
4.                  Create an inbound connection object from the standby server on the
current operations master by doing the following:
1.             Expand the name of the operations master server on which you want to
create the connection object to display its NTDS Settings object.
2.             Right-click NTDS Settings, click New, and then click Connection.

3.             In the Find Active Directory Domain Controllers dialog box, select the
name of the standby server from which you want to create the connection object,
and then click OK.
4.             In the New Object-Connection dialog box, enter an appropriate name for
the connection object or accept the default name, and then click OK.
5.                  Expand the site name in which the standby is located to display the related
Servers folder.
6.                  Expand the related Servers folder to see a list of the servers in that site.
7.                  Create an inbound connection object from the current operations master on
the standby server by doing the following:
1.             Expand the name of the standby server on which you want to create the
connection object to display its NTDS Settings object.
2.             Right-click NTDS Settings, click New, and then click Connection.
3.             In the Find Active Directory Domain Controllers dialog box, select the
name of the current operations master from which you want to create the
connection object, and then click OK.
4.             In the New Object-Connection dialog box, enter an appropriate name for
the connection object or accept the default name, and then click OK.

Decommissioning Operations Masters
Before you take an operations master offline permanently, you should transfer any
operations master roles that it holds to another domain controller. When you use the
Active Directory Domain Services Installation Wizard to decommission a domain
controller that currently hosts one or more operations master roles, the wizard
automatically reassigns the roles to a different domain controller.
To see how this process works, consider the following example:
1.                  You run the Active Directory Domain Services Configuration Wizard on a
domain controller. When the wizard starts, it determines whether the domain
controller currently hosts any operations master roles.
2.                  If the wizard detects any operations master roles, it queries the directory
for other eligible domain controllers and then transfers the roles to one of the
eligible domain controllers. A domain controller is eligible to host the domain-level
roles if it is a member of the same domain. A domain controller is eligible to host a
forest-level role if it is a member of the same forest.
As you can see, the automated transfer process doesn’t allow you to specify the domain
controller to assume the operations master roles. Therefore, if you want the operations
master role or roles to be assigned to a specific domain controller, you must transfer the
roles before decommissioning the current role holder.

Reducing Operations Master Workload
Operations masters can become overloaded while attempting to service client requests on
the network, manage their own resources, and perform their unique operations master
tasks. If an operations master is overloaded and its performance is affected, you can
reconfigure the environment so that some tasks are performed by other, less-used domain
controllers. With fewer client requests to process, the operations master can use more
resources to perform its unique functions in the forest or domain.
To reduce the workload on an operations master, look for noncritical functions and move
these to other servers. If an overloaded operations master is also acting as a DNS server or
global catalog server, you can move these functions to other servers to reduce the
workload.
You could also adjust the domain controller’s weight in the DNS environment so that it
processes fewer client requests for a particular service. With fewer requests to process, the
domain controller can use more resources to perform operations master services for the
domain. For example, to configure the PDC emulator so that it receives only half as many
client requests as other domain controllers, set the weight on the LDAP SVR record to 50.
Assuming that other domain controllers have the same priority and use the default weight
value of 100, DNS would then determine the weight ratio for the PDC emulator to be
50/100 (50 for the PDC emulator and 100 for the other domain controllers). After you
reduce this ratio to 50/100, DNS refers clients to the other domain controllers twice as
often as it refers to the PDC emulator. When you reduce client referrals for LDAP, the
PDC emulator receives fewer client requests and has more resources for other tasks, such
as performing tasks related to its operations master role.
Real World  Don’t confuse weighting with priority. To prevent clients from sending all
requests to a single domain controller, domain controllers are assigned a priority value.
The default value is 0. A client uses the priority value to help determine to which domain
controller it sends requests. When a client uses DNS to discover a domain controller, the
priority value is returned to the client (as is the rest of the DNS information needed to
complete the request).
Clients always send requests to the domain controller that has the lowest priority value.
If more than one domain controller has the same value, the clients randomly choose from
the group of domain controllers with the same value. If no domain controllers with the
lowest priority value are available, the clients send requests to the domain controller with
the next-highest priority. Because of this, raising the priority value of the LDAP resource
record for the PDC emulator can reduce its chances of receiving client requests.
However, although changing the priority of a domain controller also reduces the number
of client referrals to it, the change can have an unintended consequence. Rather than
reducing access to the domain controller proportionally with regard to the other domain
controllers, changing the priority causes Domain Name System (DNS) to stop referring
all clients to this domain controller unless all domain controllers with a lower priority
setting are unavailable.
To modify the relative priority and weighting for an operations master service in DNS,
follow these steps:

1.                  Open the Tools menu in Server Manager, and then click DNS.
2.                  Connect to a domain controller in the forest root domain. Right-click DNS,
click Connect To DNS Server, and then click The Following Computer. Enter the
name of the domain controller in the forest root domain, and then click OK.
3.                  Expand Forward Lookup Zones, and then expand the forest root domain.
4.                  Click the _tcp container. The _ldap records control directory requests. The
_gc records control global catalog requests. In the details pane, look for an _ldap or
_gc SRV record that has the name of the operations master. The data field lists the
priority, weight, and port number assigned to the resource record as well as the
name of the server to which the record belongs.
5.                  Double-click the SRV resource record that you want to modify. This
displays a properties dialog box for the record, as shown in Figure 6-6.
6.                  As appropriate, use the Priority box to specify the relative priority of the
host with respect to other hosts in the domain that offer the same service. The
highest priority goes to a host that has a value of 0. If two or more hosts have the
same priority, weighting can be used to determine which host is used.
7.                  As appropriate, use the Weight box to specify the relative weighting of a
host and to load-balance the service. If two or more hosts of a service have the
same priority, the weighting can set a preference for one host over another. Hosts
with higher weights should be used first.
8.                  Click OK to save your changes. The changes will be disseminated to other
DNS servers during normal zone transfer operations. Depending on the DNS
configuration, this process can take several days.
FIGURE 6-6 Set the priority and weight as appropriate.

Caution  Don’t modify service locator records without careful planning with
regard to the potential impact on your network. After you modify service locator
records, you’ll need to carefully monitor your network to ensure proper operations.

Seizing Operations Master Roles
When an operations master fails, you must decide if you need to relocate the operations
master role to another domain controller or wait for the domain controller to be returned to
service. You can base your decision on the criticality of the role that the domain controller
hosts and the expected downtime.
When an operations master fails and is not coming back online, you need to seize the role
to forcibly transfer it to another domain controller. Seizing a role is a drastic step that you
should perform only when the previous role owner will never be available again. Don’t
seize an operations master role when you can transfer it gracefully using the normal
transfer procedure. Seize a role only as a last resort.
Preparing to Seize Operations Master Roles
Before you seize a role and forcibly transfer it, you should determine how up to date the
domain controller that will take over the role is with respect to the previous role owner.
Active Directory tracks replication changes using update sequence numbers (USNs).
Because of replication latency, domain controllers might not all be up to date. If you
compare a domain controller’s USN to that of other servers in the domain, you can
determine whether the domain controller is the most up to date with respect to changes
from the previous role owner. If the domain controller is up to date, you can transfer the
role safely. If the domain controller isn’t up to date, you can wait for replication to occur
and then transfer the role to the domain controller.
Windows Server 2012 and Windows Server 2012 R2 include Repadmin for working with
Active Directory replication. To display the highest sequence number for a specified
naming context on each replication partner of a designated domain controller, enter the
following at a command prompt.
repadmin /showutdvec DomainControllerName NamingContext
Here, DomainControllerName is the fully qualified domain name of the domain controller,
and NamingContext is the distinguished name of the domain in which the server is located,
as in the following code example.
repadmin /showutdvec corpserver52 dc=imaginedlands,dc=com
The following output shows the highest USN on replication partners for the domain
partition.
Main-Site\corpserver31    @ USN    678321 @ Time 2015-03-15 12:42:32
Main-Site\corpserver26    @ USN    681525 @ Time 2015-03-15 12:42:35
In this example, if CorpServer31 was the previous role owner and the domain controller
you are examining has an equal or higher USN for CorpServer31, the domain controller is
up to date. However, if CorpServer31 was the previous role owner and the domain
controller you are examining has a lower USN for CorpServer31, the domain controller is
not up to date, and you should wait for replication to occur before seizing the role. You
could also use Repadmin /Syncall to force the domain controller that is the most up to date
with respect to the previous role owner to replicate with all of its replication partners.
Seizing Operations Master Roles

You can seize an operations master role by following these steps:
1.                  Open a command prompt on the console of the server you want to assign
as the new operations master. You can do this locally or through Remote Desktop.
2.                  List current operations masters by entering netdom query fsmo.
3.                  Enter ntdsutil. At the ntdsutil prompt, enter roles.
4.                  At the fsmo maintenance prompt, enter connections.
5.                  At the server connections prompt, enter connect to server followed by the
fully qualified domain name of the domain controller to which you want to assign
the operations master role.
6.                  After you’ve established a connection to the domain controller, enter quit
to exit the server connections prompt.
7.                  At the fsmo maintenance prompt, enter one of the following:
seize pdc
seize rid master
seize infrastructure master
seize schema master
seize domain naming master
8.                  At the fsmo maintenance prompt, enter quit.
9.                  At the ntdsutil prompt, enter quit.
After seizing the operations master role, you will need to remove the related data from
Active Directory. (For more information, refer to the sections “Performing Forced
Removal of Domain Controllers” and “Cleaning Up Metadata in the Active Directory
Forest” in Chapter 3, “Deploying Writeable Domain Controllers.”)

Troubleshooting Operations Masters
All domain controllers, including operations masters, replicate directory data with each
other. Replication is how domain controllers stay up to date with directory changes. As
part of diagnosing and resolving problems with operations masters, you’ll want to ensure
replication is occurring normally. Generally, the larger and more extensive the Active
Directory environment, the longer it takes for changes to completely replicate to all
domain controllers.
You can perform a series of automated tests on an operations master using Dcdiag. Follow
these steps:
1.                  Start an elevated, administrator command prompt. One way to do this by
right-clicking  the Windows logo, and then clicking Command Prompt (Admin).
2.                  At the elevated command prompt, enter the following command: dcdiag
/s:ServerName where ServerName specifies the name of the operations master that
you want to test. If you are logged on to the operations master already, simply enter
dcdiag without any parameters.
3.                  Review the status of each test. If a test fails, note which test failed, and
take appropriate corrective steps.
Note  You can run Dcdiag without using an elevated, administrator command
prompt. However, if you do this, you’ll receive inaccurate test results because tests
that require elevation will fail.
Using an elevated, administrator command prompt, you can verify that the operations
master is successfully replicating with other domain controllers. At an elevated command
prompt, enter the following command: repadmin /showrepl ServerName where
ServerName specifies the name of the operations master that you want to test. If you are
logged on to the operations master already, simply enter repadmin /showrepl.
Repadmin will then list inbound neighbors for the current or specified domain controller.
These inbound neighbors identify the distinguished name of each directory partition for
which inbound directory replication has been attempted, the site and name of the source
domain controller, and whether replication succeeded.
Additionally, although the PDC emulator typically is the time server for the forest, any
administrator could modify this configuration. To determine if the PDC emulator is the
default Windows Time service (W32time) time source for the forest, you can use Nltest.
At a command prompt, enter the following command: nltest /server:ServerName
/dsgetdc:DomainName where ServerName specifies the name of the PDC emulator and
DomainName specifies the name of the domain to which the server belongs. In the
following example, you can examine CentralDC89 in the imaginedlands.com domain.
nltest /server:centraldc89 /dsgetdc:imaginedlands.com
The output will look similar to the following.
DC: \CENTRALDC89.imaginedlands.com
     Address: \192.168.15.122
    Dom Guid: 
    Dom Name: imaginedlands.com

 Forest Name: imaginedlands.com
Dc Site Name: Atlanta-First-Site
Our Site Name: NY-First-Site
       Flags: PDC GC DS LDAP KDC TIMESERV GTIMESERV WRITEABLE DNS_FOREST CLOSE_SITE
FULL_SECRET
The command completed successfully
In the Flags line of the output, if PDC appears, as in the previous sample output, the
domain controller is the PDC emulator. If GTIMESERV appears, the domain controller is
the global time server for the forest.


Chapter 7. Managing Active Directory Sites,
Subnets, and Replication
Understanding how sites, subnets, and replication work is essential to configuring and
managing Active Directory Domain Services. Sites and subnets are the physical
components of Active Directory, and as such, they typically mirror your organization’s
network structure. As part of creating a design plan for Active Directory, ongoing
maintenance, and planning for any expansion of your network, you should examine your
organization’s network topology and ensure it is represented effectively and efficiently in
Active Directory. Prior to changing your organization’s network topology, you should
consider whether you need to change the physical representation of the network in Active
Directory as well as whether your changes will affect critical logon, authentication, and
replication traffic.


Implementing Sites and Subnets
As discussed in “Active Directory Components” in Chapter 1, “Overview of Active
Directory,” a subnet is a subdivision of an IP network, and a site is a combination of one
or more IP subnets that are connected by fast, highly reliable links. You use sites and
subnets to create a directory structure that mirrors the physical structure of your
organization.

Working with Sites
The main purpose of a site is to physically group computers to optimize logon,
authentication, and replication traffic. Sites help facilitate logon and authentication by
determining the nearest domain controller according to site location when a user logs on.
Sites help facilitate replication by confining replication traffic to devices within a site as
appropriate and by providing mechanisms to control replication between sites.
Replication is handled differently between sites than it is within sites. Replication that
occurs within a site is referred to as intrasite replication. Replication between sites is
referred to as intersite replication. Each side of a site link has one or more designated
bridgehead servers. Bridgehead servers perform intersite replication with each other.
Although bridgehead servers are designated automatically by default, you can designate
preferred bridgehead servers in a site.
A key reason to create additional sites at the same physical location is to control
replication traffic. Replication traffic between sites is automatically compressed, reducing
the amount of traffic passed between sites by 85 to 90 percent. Because network clients try
to log on to network resources within their local site first, you can use sites to isolate
logon traffic as well.
Each site should have at least one domain controller and one global catalog for client
authentication. For name resolution and IP address assignment, each site should have at
least one Domain Name System (DNS) server and one Dynamic Host Configuration
Protocol (DHCP) server. Then, by creating multiple sites in the same physical location and
establishing a domain controller, global catalog, and DNS and DHCP server within each
site, you can closely control the logon process.
You might also want to design sites with other network resources in mind, including
Distributed File System (DFS) file shares, certificate authorities, and Microsoft Exchange
servers. Typically, you will want to configure sites so that clients’ network queries can be
answered within the site. If every client query for a network resource has to be sent to a
remote site, network traffic between sites can be substantial, which can be a problem over
slow wide area network (WAN) links.

Setting Site Boundaries
You should use the connectivity between network segments to determine where to locate
site boundaries. Any business locations connected over slow or unreliable links should be
part of separate sites. This means individual sites typically represent the individual local
area networks (LANs) within an organization, and the WAN links between business
locations typically mark the boundaries of these sites.
Tip  Generally, a fast network has a bandwidth of at least 512 kilobits per second
(Kbps). For you to reliably use a network segment within a site for Active Directory
replication, the available bandwidth must be at least 128 Kbps. Available bandwidth
refers to the amount of bandwidth that is usable during peak traffic after normal
network traffic is handled.
As you set site boundaries, you should determine whether placing domain controllers and
other network resources at that location is necessary. If you elect not to place a domain
controller at a remote location, you must establish the remote location as part of an
existing site. Doing this has several advantages because no Active Directory replication
will occur between the business locations, and there are no remote domain controllers or
additional site infrastructure to manage. However, there are also several disadvantages: all
logon traffic must cross the link between the business locations, and users may experience
slow logon and authentication to network resources.
In many cases, the decision to establish a separate site may come down to the user
experience and the available bandwidth. If you have fast, reliable connections between
sites, you may not want to establish a separate site for the remote business location. If you
have limited bandwidth between business locations and want to maintain the user
experience, you may want to establish a separate site and place domain controllers and
possibly other network resources at the site. This should provide better control over the
network traffic between sites and improve the logon and authentication processes.


Replication Essentials
Replication is handled differently between sites than it is within sites. Replication that
occurs within a site is referred to as intrasite replication. Replication between sites is
referred to as intersite replication.

The Replication Model
The Active Directory multimaster replication model is designed to ensure that there is no
single point of failure. In this model, every domain controller can access changes to the
database and can replicate those changes to all other domain controllers in the forest.
Although more replication is performed within a domain than between domains,
replication between domains occurs nonetheless. The smallest unit of replication is an
attribute’s updated value. With universal group membership, for example, this means that
only the users you’ve added or removed are updated, rather than the entire group
membership.
When any change is made to a domain partition in Active Directory, the change is
replicated to all domain controllers in the domain. If the change is made to an attribute of
an object tracked by the global catalog, the change is replicated to all global catalog
servers in all domains of the forest. Similarly, if you make a change to the forestwide
configuration or schema partitions, it is replicated to all domain controllers in all the
domains of the forest.
Authentication within and between domains is also handled by domain controllers. If a
user logs on to his or her home domain, the local domain controller authenticates the
logon. If a user logs on to a domain other than the home domain, the logon request is
forwarded through the trust tree to a domain controller in the user’s home domain.
The Active Directory replication model is designed for consistency, but at any given
moment the information on one domain controller can be different from the information
on a different domain controller. This can happen when one domain controller has not yet
replicated changes to another domain controller. Over time, however, the changes made to
one domain controller are replicated to all domain controllers.

Replication with Multiple Sites
When multiple sites are involved, the replication model is used to store and then forward
changes as necessary between sites. In this case, a domain controller in the site where the
changes were originally made forwards the changes to a domain controller in another site.
This domain controller in turn stores the changes and then forwards them to all the domain
controllers in the second site. In this way, the domain controller on which a change is
made doesn’t have to replicate directly with all the other domain controllers. It can instead
rely on the store-and-forward technique to ensure that the changes are replicated as
necessary.
Each side of a site connection has one or more designated bridgehead servers. Bridgehead
servers perform intersite replication with each other. Intersite replication traffic is
compressed, scheduled and load-balanced by default.
Compression significantly reduces the amount of traffic between sites while
simultaneously increasing the processing overhead required on the bridgehead servers to
replicate traffic between sites. Because of this, if high processor utilization on bridgehead
servers is a concern and you have adequate bandwidth connections between sites, you may
want to disable compression.
Scheduling controls the times of the day when replication traffic can flow across site links.
To do this, you can enable notification for intersite replication, which allows the
bridgehead server in a site to notify the bridgehead server on the other side of a site link
that changes have occurred. This allows the other bridgehead server to get more frequent
updates by pulling the changes across the site link.
When there are multiple bridgehead servers, load-balancing is used to help ensure inbound
connections are more evenly balanced, allowing inbound connections from sites to target
different bridgehead servers. As this load balancing occurs between two sites and doesn’t
extend outward in a spanning tree, the KCC doesn’t take into account other sites when
load-balancing connections between two sites.

SYSVOL Replication
The Active Directory system volume (SYSVOL) contains domain policy; scripts used for
logon, logoff, shutdown, and startup; and other related files. When a domain is running at
Windows Server 2008 or higher functional level, domain controllers replicate the
SYSVOL using Distributed File System (DFS).
DFS uses the Active Directory replication topology to replicate files and folders in the
SYSVOL shared folders on domain controllers. To replicate the SYSVOL, DFS checks
with the KCC to determine the current replication topology and then uses this replication
topology to replicate SYSVOL files to all the domain controllers in a domain. When used
with Active Directory, DFS supports automated recovery from database loss or corruption,
replication scheduling, compression and bandwidth throttling.

Essential Services for Replication
Active Directory replication depends on LDAP, DNS, Kerberos version 5 authentication,
and remote procedure call (RPC). These Windows services must be functioning properly
to allow directory updates to be replicated. Active Directory uses DFS to replicate files in
the system volume (SYSVOL) shared folders on domain controllers. Table 7-1
summarizes the ports that are used.

TABLE 7-1 Ports Used During Active Directory Replication
LDAP
 
 
UDP: 389, TCP: 389
LDAP Secure Sockets Layer (SSL)
 
 
TCP: 686
Global catalog (LDAP)
 
 
TCP: 3268
Kerberos version 5
 
 
UDP: 88, TCP: 88
DNS
 
 
UDP: 53, TCP: 53
RPC endpoint mapper
 
 
TCP: 135
Server Message Block (SMB) over IP
 
 
UDP: 445, TCP: 445
Additionally, note that for intersite replication, two transports are available: RPC over IP
and SMTP. SMTP uses TCP port 25.


Intrasite Versus Intersite Replication
When you are planning site structure, keep in mind that the two replication models are
handled differently. The intrasite replication model is optimized for high bandwidth
connections. The intersite replication model is optimized for limited bandwidth
connections.

Intrasite Replication
When replication occurs within a domain, the replication follows a specific model that is
very different from the replication model used for intersite replication. With intrasite
replication, the focus is on ensuring that changes are rapidly distributed. Intrasite
replication traffic is not compressed, and replication is designed so that changes are
replicated almost immediately after a change has been made. The main component in
Active Directory responsible for the replication structure is the KCC. One of the main
responsibilities of the KCC is to generate the replication topology.
As domain controllers are added to a site, the KCC configures a ring topology with pull
replication partners. With a ring topology, at least two paths between connected network
resources provide redundancy. This configuration ensures that changes can flow from one
domain controller to another. With pull replication, two servers are used. One is
designated as the push partner, the other as the pull partner. It is the responsibility of the
push partner to notify the pull partner that changes are available. The pull partner can then
request the changes. Creating push and pull replication partners allows for rapid
notification of changes and for updates after a request for changes has been made.
The KCC uses these models to create a replication ring. As domain controllers are added
to a site, the size and configuration of this ring changes. When a site includes at least three
domain controllers, each domain controller is configured with at least two incoming
replication connections.
When a domain controller is updated, it waits approximately 15 seconds before initiating
replication. This short wait is implemented in case additional changes are made. The
domain controller on which the change is made notifies one of its partners, using an RPC,
and specifies that changes are available. The partner can then pull the changes. After
replication with this partner completes, the domain controller waits approximately 3
seconds and then notifies its second partner of changes. The second partner can then pull
the changes. Meanwhile, the first partner is notifying its partners of changes as
appropriate. This process continues until all the domain controllers have been updated.
The 15-second replication delay can be overridden to allow immediate replication of
priority (urgent) changes. Priority replication means that there is no delay to initiate
replication. Priority replication is triggered if you perform one of the following actions:
Change a shared secret password used by the Local Security Authority (LSA) for
Kerberos authentication
Change the domain password policy
Change the password on a domain controller computer account
Change the relative ID master role owner
Lock out an account
Change the account lockout policy
Change object attributes in schema
Note  If an account is locked out automatically because of failed logon attempts, a
priority replication is triggered as well.
Real World  All nonpriority changes to user and computer passwords are handled by

the designated primary domain controller (PDC) emulator in a domain. When a user
changes a password, the domain controller to which that user is connected immediately
sends the change to the PDC emulator. This ensures the PDC emulator always has the
latest password for a user and is why the PDC emulator is checked for a new password if
a logon fails initially. After the new password is updated on the PDC emulator, the PDC
emulator replicates the change using normal replication. The only exception is when a
domain controller contacts the PDC emulator requesting a password for a user. In this
case, the PDC emulator immediately replicates the current password to the requesting
domain controller so that no additional requests are made for that password.

Intersite Replication
In contrast to intrasite replication, which focuses on speed, intersite replication focuses on
efficiency. Intersite replication is designed to transfer replication information between
sites while making the most efficient use of the available resources. To do this, Active
Directory uses designated bridgehead servers and a default configuration that is load-
balanced, scheduled and compressed rather than automatic and uncompressed.
The way load balancing works with multiple domains is slightly different from how it
works with a single domain environment. Here, an existing connection is always used
instead of a new one, even if the connection is for a different naming context.
Even when load-balancing is used, the KCC can have unbalanced connections. For
example, when domain controllers go offline for extended periods, an unbalance can occur
because the KCC does not rebalance connections when offline domain controllers come
back online. Instead, the KCC prefers to maintain a stable topology, rather than try to
rebalance the topology.
To manually force load balancing, you can do the following:
1. Delete the inbound intersite connections for a domain controller or site.
2. Either wait for the KCC to run automatically (which will occur within 15 minutes)
or manually run the KCC by entering repadmin /kcc at an elevated command
prompt.
3. Wait a few seconds between the time you start the KCC in each site. This ensures
the KCC doesn’t choose the same bridgehead server for inbound connections as
other servers.
With compression, replication traffic is compressed 85 to 90 percent, meaning that it is 10
to 15 percent of its uncompressed size, allowing replication to be used effectively even on
low-bandwidth links. Compression is triggered when the replication traffic is larger than
32 kilobytes (KB).
The main component in Active Directory responsible for the intersite replication structure
is the Intersite Topology Generator (ISTG). When you set up a site, Active Directory
designates the Knowledge Consistency Checker (KCC) on one of the site’s domain
controllers as the ISTG. Each site has only one ISTG. Its job is to determine the best way
to configure replication between sites.
A key responsibility of the ISTG is to limit the points of replication between sites. Instead
of allowing all the domain controllers in one site to replicate with all the domain
controllers in another site, the ISTG designates a limited number of domain controllers as
bridgehead servers. Replication between sites is always sent from a bridgehead server in
one site to a bridgehead server in another site. This ensures that information is replicated
only once between sites. As domain controllers are added and removed from sites, the
ISTG regenerates the topology automatically.
The ISTG also creates the connection objects that are needed to connect bridgehead
servers on either side of a site link. This is how Active Directory logically represents a site
link. The ISTG continuously monitors connections and creates new connections when a
domain controller acting as a designated bridgehead server is no longer available. In most

cases, there will be more than one designated bridgehead server.
Replication through bridgehead servers works like this: Changes made to the directory in
one site replicate to the other site via the designated bridgehead servers. The bridgehead
servers then initiate replication of the changes exactly (as discussed in the previous
section, titled “Intrasite Replication”) except that for intersite replication, two transports
are available: RPC over IP and SMTP. If you use SMTP as a transport, SMTP uses TCP
port 25 by default.
As you can see, intersite replication is really concerned with getting changes from one site
to another across a site link. With scheduled replication, you can set the valid times during
which replication can occur and the replication frequency within this scheduled interval.
By default, when you configure intersite replication, replication is scheduled to occur
every 180 minutes, 24 hours a day. In many cases, you will want to change the default
schedule to better accommodate the users who also use the link. For example, you might
want to set replication to occur every 60 minutes, from 4 A.M. to 7 A.M. and from 9 P.M.
to 3 A.M., Monday through Friday, while allowing replication to occur every 180 minutes,
24 hours a day on Saturday and Sunday. This would allow more bandwidth for users
during the week and more bandwidth for replication on the weekend.
You can optimize intersite replication in several ways:
Turn off automatic compression if you have sufficient bandwidth on a link and are
more concerned about the processing power used for compression. Turning off
compression reduces resource usage on bridgehead servers while substantially
increasing the bandwidth used for replication.
Enable automatic notification of changes to allow domain controllers on either side
of the link to indicate that changes are available. Automatic notification allows those
changes to be requested rather than making domain controllers wait for the next
replication interval.
Configure site link costs, configure connection objects manually, and designate
preferred bridgehead servers.
Each of these techniques optimizes intersite replication for specific usage scenarios,
as I’ll discuss in more detail later in the chapter. See the section entitled “Configuring
Site Links and Intersite Replication.”


Developing Your Site Design
Although site design is relatively independent from domain structure, the replication
topology depends on how available domain controllers are and how they are configured.
The KCC running on each domain controller monitors domain controller availability and
configuration, and it updates replication topology as changes occur. The designated ISTG
in a site performs similar monitoring to determine the best way to configure intersite
replication. This means that as you implement or change the domain controller
configuration, you will change the replication topology.
To develop or revise a site design, you should do the following:
1.                  Map your network structure and then map this structure to site structure.
2.                  Design your sites and then associate subnets with these sites.
3.                  Design the intersite replication topology while considering the impact of
site link bridging and planning the placement of servers in sites.

Mapping Your Network Structure
Start by mapping your existing network architecture as well as any planned changes.
Include all the business locations in the organization that are part of the forest or forests
for which you are developing a site plan.
You must consider whether separate sites are needed. If your organization has multiple
locations with limited bandwidth or unreliable connections between locations, you will
typically want to create additional sites. You also might want to create additional sites to
separate network segments even if they are connected with high-speed links; the reasons
for doing this were discussed previously and could include isolating replication traffic
between the network segments.
Document the IP subnets on each network segment. Each site in the organization will have
separate subnets. Although a single subnet can exist only in one site, a single site can have
multiple subnets associated with it. After you create sites, you will create subnet-to-site
associations by adding subnets to these sites.
Document the connection speed on the links connecting each network segment as well as
other applications that use a lot of bandwidth. The available bandwidth on a connection
affects the way you configure site links. Each site link is assigned a link cost, which
determines its priority order for replication. If there are several possible routes to a site,
the route with the lowest link cost is used first. In the event that a primary link fails, a
secondary link can be used.
To map the network structure to site structure, start by examining each network location
and the speed of the connections between those locations. In general, if you want to make
separate network locations part of the same site, the connections between locations should
have at least 512 Kbps of available bandwidth, with 1 Mbps recommended as a minimum.
Small organizations may be able to scale down to slower dedicated links. Large
organizations may need to scale up.
Note  Kbps and Mbps are bits not bytes. There are eight bits in a byte. A 1 Mbps
connection and a 1 MBps connection are very different things. A 1 Mbps connection
operates at speeds up to 1,048,576 bits per second while a 1 MBps connection
operates at speeds up to 8,388,608 bits per second.

Designing Your Sites
After you determine how many sites you will have, you next need to consider the design
of each site. A key part of the site design has to do with naming the sites and identifying
the subnets associated with each site.
Site names are used in locator records registered in Domain Name System (DNS).
Because of this, site names must use valid DNS names, which include the standard
characters A through Z, a through z, 0 through 9, and hyphen (-). Additionally, the name
of a site should reflect its physical location. For example, you might use the following site
names: NewYork-First-Site, Chicago-First-Site, and Seattle-First-Site.
Sites do not reflect the Active Directory namespace. Domain and site boundaries are
separate. Sites can contain a domain or a portion of a domain. A single site can have one
subnet or multiple subnets. However, a single subnet can be in only one site. Therefore,
the following rules apply to sites and subnets:
A single site can contain resources from multiple domains.
A single domain can have resources spread out among multiple sites.
A single site can have multiple subnets.
To determine the subnets that you should associate with each site, use the documentation
you developed previously. Simply note the IP subnet associations that are needed, and
update your site diagram to include the subnets.

Designing Your Intersite Replication Topology
After you name the sites and determine subnet associations, design the intersite replication
topology by determining the replication schedule, replication interval, and link cost for
each site link. Typically, replication should occur at least every 180 minutes, 24 hours a
day, 7 days a week. This is the default replication schedule. If you have limited bandwidth,
you may need to alter the schedule to allow user traffic to have priority during peak usage
times. Otherwise, if bandwidth isn’t a concern or if you have strong concerns about
keeping branch locations up to date, you might want to increase the replication frequency.
To ensure you understand what’s happening on the network, you should monitor site links
to get a sense of the bandwidth utilization and the peak usage periods.
When there are multiple links between locations, you need to determine the appropriate
cost of each link. Valid link costs range from 1, which assigns the highest possible
preference to a link, to 99999, which assigns the lowest possible preference to a link.
When you create a new link, the default link cost is set to 100. If you were to set all the
links to this cost, all the links would have equal preference for replication. However, low
bandwidth links should have different costs from high bandwidth links. Table 7-2 provides
an example of how you could use bandwidth to help determine link cost.

TABLE 7-2 Setting Link Cost Based on Link Bandwidth
10 gigabits per second (Gbps) to 2 Gbps
1
2 Gbps to 1 Gbps
2
1 Gbps to 512 megabits per second (Mbps)
4
256 Mbps to 100 Mbps
20
100 Mbps to 10 Mbps
40
10 Mbps to 1.544 Mbps
100
1.544 Mbps to 512 kilobits per second (Kbps)
200
512 Kbps 256 Kbps
400
256 Kbps to 128 Kbps
800
128 Kbps or less
1600
You can use the costs in the table to assign costs to each link you identified previously.
Even if there is only one link between all your sites now, you should set an appropriate
link cost to ensure that all the links are used in the most efficient way possible if links are
added later.
Next, consider the possible impact of site link bridging. By default, Active Directory
automatically configures site link bridges, which makes links transitive between sites in
much the same way that trusts are transitive between domains.
When a site is bridged, any two domain controllers can make a connection across any
consecutive series of links. The site link bridge cost is the sum of all the costs of the links
included in the bridge. For example, if the site link cost between Site A and Site B is 100
and the site link cost between Site B and Site C is 200, the link bridge cost using this route
from Site A to Site C is 300.
When you know the costs of links and link bridges, you can calculate the effects of a
network link failure. For example, if your organization has multiple sites, there may be
multiple possible paths between sites. If so, the path used is always the one with the
lowest link bridge cost. In case of an outage of a primary link, the path used is the one
with the next lowest cost.
Site link bridging can have unintended consequences when you have multiple hubs and
spokes on each hub. Here, the same replication traffic could go over the site links twice
because of the rule of three hops for optimizing replication topology. The repeat
replication over the hub links becomes worse as you add spokes. The solution to the
problem of repeat replication traffic is to disable automatic site bridging. Unfortunately, if
you disable automatic site link bridging, none of your organization’s sites will be able to

use this feature. In this case, to bridge site links, you must configure site link bridges
manually. You can enable, disable, and manually configure site link bridges as discussed
in “Configuring Site Links and Intersite Replication.”
Note  Another reason to disable automatic site link bridging is to reduce the
processing overhead on the designated ISTGs in each site. When you disable
bridging, the ISTGs no longer have to create and manage the site link bridges, and
this reduces the number of computations required to create the intersite replication
topology.
When you finish configuring site links, you should plan the placement of servers in the
sites. Consider types of domain controllers you will use and how many of each will be
located in a particular site. Determine whether any of the domain controllers host a global
catalog or DNS. Determine whether any of the domain controllers have operations master
roles and if so, what those roles will be. At minimum, each site should have a domain
controller and a global catalog server. This configuration allows intrasite replication to
occur without replication traffic having to go across site links. If there is a local DHCP
server, clients with dynamic IP addressing will be able to start up and get an IP address
assignment without having to go across a site link. If there is a local DNS server, clients
will be able to perform DNS queries without having to go across a site link.


Configuring Sites and Subnets
After you’ve developed a site design or determined how you want to modify your existing
site plan, you can use the Active Directory Sites And Services console to configure the
necessary sites and subnets as discussed in this section. All sites have one or more subnets
associated with them. IP addresses you assign to subnets determine where the site
boundaries are established. As you create additional sites, you should identify domain
controllers that will be part of the sites and then determine if you need to move the related
domain controller objects to the site containers with which they should be associated.
You can start Active Directory Sites And Services by clicking  theTools menu in Server
Manager, and then clicking Active Directory Sites And Services. Active Directory Sites
And Services connects to a domain controller in your logon domain and forest by default.
If your organization has multiple forests, you might need to connect to another forest. To
do this, right-click the Active Directory Sites And Services node in the console tree, and
then select Change Forest. In the Change Forest dialog box, enter the name of the root
domain in the forest to which you want to connect, and then click OK.

Creating Sites
When you install Active Directory Domain Services in a new forest, a new site called
Default-First-Site-Name is created. After you install the first domain controller in your
Active Directory forest, you can rename the default site. Although you’ve renamed this
site, it remains the default site for new domain controllers.
Domain controllers you introduce to the forest generally are added to the default site
automatically. However, if you have configured other sites and have associated subnets
with those sites, domain controllers are added to those additional sites if the IP address
you assign matches a subnet in one of the sites. Keep in mind that any domain controller
with an IP address that doesn’t match a subnet identifier of another previously defined site
will be added to the default site.
You can create a site by following these steps:
1.                  In Active Directory Sites And Services, right-click the Sites container in
the console tree and then select New Site.
2.                  In the New Object–Site dialog box, shown in Figure 7-1, enter a
descriptive name for the site. The site name should depict the purpose or physical
location of the site.
3.                  Specify which site link will be used to connect this site to other sites. If the
site link you want to use doesn’t exist, select the default site link
DEFAULTIPSITELINK for now, and then change the site link settings after you’ve
created the necessary site link or links.
4.                  Click OK. Next, you see a prompt that outlines the steps you must
complete to finish the site configuration. Review the recommended steps and then
click OK again. These steps include:
Ensuring that the site is linked to other sites with appropriate site links.
Adding subnets for the site to the Subnets container.
5. Installing one or more domain controllers in the site or moving existing domain
controllers into the site.

FIGURE 7-1 Use the New Object–Site dialog box to create a new site.
As the prompt states, you should ensure the links to the site are appropriate and, as
necessary, create the required site links. After you link the site, you’ll need to create
subnets and associate them with the site to tell Active Directory the IP addresses that
belong to the site. Because each site should have one or more domain controllers, you
should install one or more domain controllers in the site or move existing domain
controllers into the site.

Creating Subnets
You create subnets and associate them with sites to allow Active Directory to determine
the network segments that belong to a site. Any computer with an IP address on a network
segment associated with a site is considered to be located in the site. Although a site can
have one or more subnets associated with it, an individual subnet can be associated with
only one site.
Windows Server supports both IP version 4 (IPv4) and IP version 6 (IPv6) subnets. When
you create a subnet, you must specify the network address by using prefix notation. The
address prefix for a network address consists of the network ID address, followed by a
forward slash, followed by the number of bits in the network ID. When subnetting is not
used, the IPv4 subnet address ends with a 0, such as 192.168.15.0. For example, if the
IPv4 network address is 192.168.15.0 and the subnet mask is 255.255.255.0, you should
enter the address prefix as 192.168.15.0/24.
Note  When you use subnetting, nodes no longer follow the class rules for
determining which bits in the IPv4 address are used for the network ID and which
bits are used for the host ID. Instead, you set the 32 bits of the IPv4 address to be
either network ID bits or host ID bits based on the number of subnets you need, and
then you number nodes for each subnet.
You can create a subnet and associate it with a site by completing the following steps:
1.                  In Active Directory Sites And Services, right-click the Subnets container
in the console tree, and then select New Subnet. This displays the New Object–
Subnet dialog box, shown in Figure 7-2.
2.                  In the Prefix field, enter the address prefix for the subnet.
3.                  Select the site with which the subnet should be associated, and then click
OK.
After you create a subnet, you can change its site association. To do so, follow these steps:
1.                  In Active Directory Sites And Services, double-click the subnet in the
Subnets folder.
2.                  In the General tab of the Properties dialog box, use the Site selection menu
to change the site association.
3.                  Click OK.
Tip  If you associate a subnet with a different site, you’ll need to ensure the
domain controllers in that subnet are moved to the new site. Moving a domain
controller from one site to another involves moving the related object in Active
Directory from one site container to another. It does not involve installing or
demoting a domain controller or physically moving server hardware.

FIGURE 7-2 Use the New Object–Subnet dialog box to create a new subnet.

Adding Domain Controllers to Sites
After you associate subnets with a site, any domain controller you install will
automatically be located in the site whenever the domain controller’s IP address matches a
subnet’s network address. However, any domain controllers installed before you
established the site and associated subnets with the site will not be located in a site
automatically. In this case, you might need to manually move the domain controller to the
new site. Keep in mind that moving a domain controller from one site to another involves
moving the related object in Active Directory from one site container to another. It does
not involve installing or demoting a domain controller or physically moving server
hardware.
Don’t move a domain controller to a site arbitrarily. Move a domain controller to a site
only if it is on a subnet associated with the site. Before you can move a domain controller
from one site to another, you must determine in which site the domain controller is
currently located. In Active Directory Sites And Services, you can determine the servers
associated with a site by expanding the site node and then expanding the related Servers
node.
At a command prompt, you can determine the servers associated with a site by entering
the following command.
dsquery server -domain DomainName
Here, DomainName is the fully qualified name of the domain. Using the following
example, you obtain a list of all the domain controllers in the services.imaginedlands.com
domain.
dsquery server -domain services.imaginedlands.com
If you want a list of all domain controllers in the entire forest, simply enter dsquery
server -forest.
In either case, the resulting output is a list of distinguished names (DNs) for domain
controllers, which includes site configuration information such as the following.
“CN=CORPSVR65,CN=Servers,CN=LA-First-Site-Name,CN=Sites,CN=Configuration,
DC=imaginedlands,DC=com”
This additional information specifies the site associated with the server. In this example,
the associated site is LA-First-Site-Name.
Sometimes, you’ll want to find the domain controllers in a particular site. You can specify
a site to examine by using the -site parameter. In the following example, you look for all
domain controllers in a site called Seattle-First-Site.
dsquery server –site Seattle-First-Site
The output of this command is a list of DNs for domain controllers in the specified site.
Before you move a domain controller, you should ensure that the following TCP/IP client
values are appropriate for the new location. Check the IP address, including the subnet
mask and default gateway, and the DNS server addresses at a minimum. If the domain
controller that you are moving is also a DNS server, you must change the TCP/IP settings
on any clients that have static references to the domain controller as the preferred or

alternate DNS server. You must also update the IP address in any DNS delegations or
forwarders that reference the IP address. With dynamic update enabled, DNS updates host
(A), host (AAAA), and name server (NS) resource records automatically. However, you
must update delegations and forwarders manually:
Determine whether the parent DNS zone of any zone that is hosted by this DNS
server contains a delegation to this DNS server. If the parent DNS zone does contain
a delegation to this DNS server, update the IP address in the NS resource record in
the parent domain DNS zone that points to this DNS server.
Determine whether the server acts as a forwarder for any DNS servers. If a DNS
server uses this server as a forwarder, change the NS resource record for the
forwarder on that DNS server.
Before you move a domain controller, you should also determine whether the server is
acting as a preferred bridgehead server for the site, as discussed in “Locating and
Designating Bridgehead Servers” later in this chapter. If you move a preferred bridgehead
server to a different site, it becomes a preferred bridgehead server in the new site. If other
preferred bridgehead servers are not currently in use in this site, the ISTG behavior in this
site changes to support preferred bridgehead servers. Because of this, you should either
configure the server to not be a preferred bridgehead server or select additional preferred
bridgehead servers in the site.
If the server is the last preferred bridgehead server in the original site for its domain and
there are other domain controllers for the domain in the site, the ISTG selects a bridgehead
server for the site. If you use preferred bridgehead servers, always select more than one
server as the preferred bridgehead server for a site. If the server isn’t the last preferred
bridgehead server, and the move has left only one available preferred bridgehead server,
you should either configure the server to not be a preferred bridgehead server or select
additional preferred bridgehead servers in the site.
You can move a domain controller to a site by completing the following steps:
1.                  In Active Directory Sites And Services, domain controllers associated with
a site are listed in the site’s Servers node. To locate the domain controller that you
want to move, expand the site node, and then expand the related Servers node.
2.                  Right-click the domain controller that you want to work with, and then
select Move.
3.                  In the Move Server dialog box, select the site that should contain the
server, and then click OK.
In Windows Server, you can move a domain controller from one site to another by
dragging the related domain controller object from its current site to the Servers node of
the target site.
The Net Logon service running on the domain controller will register the new site
information in DNS within 60 minutes. Using the Event Viewer, you can review the
System log for NETLOGON errors regarding registration of service (SRV) resource
records in DNS that have occurred within the last hour. If there are no errors, the Net
Logon service has updated the related SRV resource records in DNS. Otherwise,
NETLOGON Event ID 5774 indicates that the dynamic registration of DNS resource

records has failed, and you will need to modify the records manually.

Ensuring Clients Find Domain Controllers
When a client requests a domain controller, the DC Locator process tries to locate a
domain controller in the site of the client. If no domain controller is available in the site,
DC Locator returns any available domain controller in the domain. If the domain
controller is located in another site instead of the current site, the client and domain
controller may not be able to communicate effectively. With Windows desktop operating
systems, the Try Next Closest Site Group Policy setting in the Default Domain Policy can
help ensure domain controllers selected are optimized for each site.
The Try Next Closest Site Group Policy setting affects the order in which domain
controllers are located and uses site link cost values to determine the next closest site to
the site of the client. Using this setting, you may be able to reduce Active Directory traffic
on the network by ensuring that clients fail over to the next closest site when they cannot
find a domain controller in their site.
With Windows desktop operating systems, you can use the Force Rediscovery Interval
Group Policy setting to find a new domain controller that might have been introduced
since the last domain controller was located for the client. This setting forces a new
domain controller location every 12 hours (43,200 seconds) by default. You can change
the time limit for rediscovery by enabling this setting and specifying a new time in
seconds.
Both settings are configured in Default Domain Policy. To enable clients to locate a
domain controller in the next closest site and modify the forced rediscovery settings,
follow these steps:
1.                  On the Tools menu in Server Manager, click Group Policy Management.
2.                  Double-click the forest node, double-click Domains, and then double-click
the domain you want to work with.
3.                  Right-click Default Domain Policy, and then click Edit.
4.                  In Group Policy Management Editor, double-click Try Next Closest Site
under Computer Configuration/Policies/Administrative Templates/System/Net
Logon/DC Locator DNS Records. Click Enabled, and then click OK.
5.                  In Group Policy Management Editor, double-click Force Rediscovery
Interval under Computer Configuration/Policies/Administrative
Templates/System/Net Logon/DC Locator DNS Records. Click Enabled, set the
desired interval in seconds, and then click OK.


Configuring Site Links and Intersite Replication
You use site links to connect two or more sites for the purpose of replication. When you
install Active Directory in a new forest, a new site link called the DEFAULTIPSITELINK
is created in the IP container for the first default site. You can separately create any
additional links that are needed. You create and manage site links by using the Active
Directory Sites And Services console.

Understanding Site Links
Sites you add are included in the default site link unless you have configured other site
links. If all of the network connections between sites are the same speed and priority, this
default configuration can work without your having to create additional site links. With
this configuration, all sites will have the same intersite replication properties. If you were
to change these properties, the changes would affect the replication topology for all sites.
To configure different replication properties when the network connections between sites
have different speeds and priorities, you can create additional site links. Both endpoints in
a site link must exist before you can create a site link. This means you’ll need to create the
sites at either end of a site link before you can create the site link, and then you can update
a site’s configuration to include that site link.
When you create additional site links, a site’s designated Intersite Topology Generator
(ISTG) uses the link properties to prioritize links and determine when a site link should be
used. The ISTG generates the intersite replication topology and designates bridgehead
servers automatically. Replication traffic between sites always flows from a bridgehead
server in one site to a bridgehead server in another site.
Two replication transports are available for site links: IP and Simple Mail Transfer
Protocol (SMTP). Bridgehead servers use these replication transports in different ways,
for different purposes.
With IP as the transport, domain controllers establish an RPC over IP connection with one
replication partner at a time and replicate Active Directory changes. During replication,
the bridgehead server establishes a connection using the RPC endpoint mapper port 135
and then determines which port is to be used for replication. The ports used for replication
are listed previously in Table 7-1. The same ports are also used for intrasite replication.
Because RPC over IP is synchronous, both replication partners must be available at the
time the connection is established. Because of the transitive nature of site links, you must
carefully configure site link schedules so that all potential RPC over IP replication
partners are available at the time the connection is established. You should use RPC over
IP when there are reliable, dedicated connections between sites.
With SMTP as the transport, all replication traffic is converted to e-mail messages that are
sent between the sites. Because SMTP replication is asynchronous, both replication
partners do not have to be available at the time the connection is established, and
replication transactions can be stored until a destination server is available. You should use
SMTP when links are unreliable or not always available. Before using SMTP, keep the
following in mind:
You can use SMTP only to replicate information between domain controllers in
different domains. Why? You can use SMTP only to replicate the configuration,
schema, and global catalog directory partitions. You cannot use SMTP to replicate
the domain partition.
SMTP messages are digitally signed and encrypted to ensure that replication traffic is
secure even if replication traffic is routed over the public Internet. All domain
controllers that will use SMTP for replication require additional components to

create, digitally sign, and then encrypt e-mail messages. Specifically, you must install
the SMTP Server feature on each domain controller, and you must install a Microsoft
certificate authority (CA) in your organization. The certificates from the CA are used
to digitally sign and encrypt the SMTP messages sent between the sites.
If you plan to use SMTP for replication, you must open related ports on the firewall
between sites. Port 25 is the default port used for SMTP.

Creating Site Links
You can create site links between sites to better manage intersite replication. Before you
create a site link, determine the transport you want to use. You cannot change the transport
after you create a site link; you can only delete the link and then recreate it using the
alternate transport.
Each site link must have at least two sites associated with it. These sites establish the
endpoints or transit points for the link. For example, after you create NY-First-Site and
Boston-First-Site, you can create the NY-Boston-Site-Link. When you do this, the NY and
Boston sites are the endpoints for the link, and the ISTG will use the link to create the
connection objects that are required to replicate traffic between these sites.
Each site link has a link cost, replication schedule, and replication interval. The cost for a
site link determines the priority of the link relative to other site links that might be
available. When there are multiple possible routes to a site, the route with the lowest total
link cost is used first. In the event a link fails, the route with the next lowest total link cost
is used. Typically, you will set the link cost relative to the bandwidth available for a
specific connection. However, if the organization has to pay a fee based on bandwidth
usage, you could also set the link cost to reflect the actual monetary cost of sending traffic
over a particular link.
The replication schedule determines the times during the day that the site link is available
for replication. The default replication schedule is 24 hours a day. If you have a limited-
bandwidth connection or you want user traffic to have priority at certain times of the day,
you might want to configure a different availability schedule.
The replication interval determines the intervals at which the bridgehead servers in each
site check to see if directory updates are available. The default interval is 180 minutes. For
example, if the replication schedule is configured to allow replication from 9 P.M. to 6
A.M. each day, the bridgehead servers will check for updates at 9 P.M., 12 A.M., 3 A.M.,
and 6 A.M. daily.
To create a site link between two or more sites, complete the following steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the Inter-Site Transports container. Right-click the container for the
transport protocol you want to use (either IP or SMTP), and then select New Site
Link.
2.                  In the New Object–Site Link dialog box, shown in Figure 7-3, enter a
descriptive name for the site link. The site name serves as a point of reference for
administrators and should clearly depict the sites the link connects.

FIGURE 7-3 Create the site link.
3.                  In the Sites Not In This Site Link list, select a site that should be included
in the link, and then click Add to add the site to the Sites In This Site Link list.
Repeat this process for each site you want to add to the link. The link must include
at least two sites.
4.                  Click OK to close the New Object–Site Link dialog box.
5.                  In Active Directory Sites And Services, the site link is added to the
appropriate transport folder (IP or SMTP). Select the transport folder in the console
tree, and then double-click the site link in the right pane.
6.                  In the Link Properties dialog box, shown in Figure 7-4, use the Cost
combo box to set the relative cost of the link. The default cost is 100. (For more
information on setting link cost, see “Designing Your Intersite Replication
Topology’ earlier in this chapter.
7.                  Use the Replicate Every combo box to set the replication interval. The
default interval is 180 minutes.
8.                  Click OK to close the site link’s Properties dialog box.

FIGURE 7-4 Set the site link properties.
Note  By default, the site link is available for replication 24 hours a day. You can
set a different schedule. (To learn more, see the following section, “Configuring
Link Replication Schedules.”)

Configuring Link Replication Schedules
You can manage the replication schedule for site links either globally or individually. The
default configuration for IP links and SMTP links is different. IP site links use individual
replication schedules and by default replicate within these schedules according to the
replication interval. SMTP site links ignore individual replication schedules and by default
replicate only according to the replication interval.
You can control whether global or individual schedules are used by following these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the Inter-Site Transports container. Right-click the container for the
transport protocol you want to work with (either IP or SMTP), and then select
Properties.
2.                  In the Properties dialog box, you can now configure global replication for
the selected transport by using one of the following techniques:
Select the Ignore Schedules check box to ignore individual replication schedules on
site links. With this option, bridgehead servers replicate at the designated intervals
but ignore any scheduled days or hours.
Clear the Ignore Schedules check box to use individual schedules. With this option,
bridgehead servers replicate according to the replication interval only during
scheduled days and hours.
3.                  Click OK to apply your settings.
When you use individual schedules, you can manage the times when replication is
permitted by setting a replication schedule for each site link. Before you schedule
replication hours, you’ll want to determine peak usage times and determine whether and
how you want to restrict replication. Rather than restrict replication entirely during the
workday or during peak usage times on a limited bandwidth link, you might want to allow
replication to occur at specific times during these periods. You might also want to create a
replication window of several hours to ensure replication can occur.
You can configure a site link’s replication schedule by following these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, expand
the Inter-Site Transports container, and then select the container for the transport
protocol you want to work with (either IP or SMTP).
2.                  In the details pane, right-click the site link you want to configure, and then
select Properties.
3.                  Click Change Schedule. As shown in Figure 7-5, use the Schedule For
dialog box to set the desired replication schedule. When you are finished, click OK.

FIGURE 7-5 Set the replication schedule.
In the Schedule For dialog box, each hour of the day or night is a field that you can turn on
or off. Hours that are allowed are filled in with a dark bar—you can think of these hours as
being turned on. Hours that are disallowed are blank—you can think of these hours as
being turned off.
To change the replication setting for a particular hour, click it. Then select either
Replication Not Available or Replication Available. Hold down Shift and use the arrow
keys to select multiple hours simultaneously. You can also click and drag to select an area.
Additionally, keep the following in mind:
Clicking All allows you to select all the time periods.
Clicking a “day of the week” button allows you to select all the hours in a particular
day.
Clicking Hourly buttons allows you to select a particular hour for all the days of the
week.

Bridging Sites
When more than two sites are linked for replication and use the same transport, all of the
site links are bridged by default. Bridging a site link in this way allows any two domain
controllers to make a connection across any consecutive series of links.
Active Directory automatically manages site link bridges, and the ISTG monitors for
changes and reconfigures the replication topology as necessary. Whenever there are
multiple possible routes between sites and a link goes out, the ISTG will allow replication
traffic to flow on the alternate route according to the site link bridge cost.
The site link bridge cost is the sum of all the links included in the bridge. When there are
multiple routes between linked sites, the site link bridge with the lowest cost is the
primary route. If this route becomes unavailable, the site link bridge with the next lowest
cost is used automatically as long as site link transitivity is enabled.
You can enable or disable site link bridges on a per-transport basis. By default, both the IP
and SMTP transports have site link bridging enabled. If you disable site link bridging,
Active Directory will no longer manage site link bridges for the transport. You must then
create and manage all site link bridges for that transport. Any sites you manually add to a
site link bridge are considered to be transitive with each other. Site links that are not
included in the site link bridge are not transitive. (For details on specific scenarios where
you might not want to use site link bridges, see “Designing Your Intersite Replication
Topology” earlier in this chapter.
To turn off automatic site link bridging and manually configure site link bridges, follow
these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the Inter-Site Transports container. Right-click the container for the
transport protocol you want to work with (either IP or SMTP), and then select
Properties.
2.                  In the Properties dialog box, clear the Bridge All Site Links check box,
and then click OK. If you later want to enable transitive links and have Active
Directory ignore the site link bridges you’ve created, you can select the Bridge All
Site Links check box.
After you disable automatic site link bridging, you can manually create site link bridges.
To create a site link bridge, you must have at least two site links configured for the
transport. A site link bridge must contain at least two site links.
You can create a site link bridge by following these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the Inter-Site Transports container. Right-click the container for the
transport protocol you want to use (either IP or SMTP), and then select New Site
Link Bridge.
2.                  In the New Object–Site Link Bridge dialog box, shown in Figure 7-6, enter
a descriptive name for the site link bridge. This name serves as a point of reference
for administrators and should clearly depict all the site links that are part of the
bridge.

Figure 7-6 Create a site link bridge.
3.                  In the Site Links Not In This Site Link Bridge list, select a site link that
should be included in the bridge, and then click Add to add the site link to the Site
Links In This Site Link Bridge list. Repeat this process for each site link you want
to add to the bridge. The bridge must include at least two site links.
4.                  Click OK to create the site link bridge.

Locating and Designating Bridgehead Servers
You can list the bridgehead servers in a site by entering the following command at a
command prompt.
repadmin /bridgeheads site:SiteName
Here, SiteName is the name of the site. In the following example, you obtain a list of all
the bridgehead servers in the NY-First-Site site.
repadmin /bridgeheads site:NY-First-Site
If you omit the site:SiteName values, the details for the current site are returned.
Operating as a bridgehead server can add a significant load to a domain controller. This
load increases with the number and frequency of replication changes. Because of this, the
designated bridgehead servers should also be closely monitored to make sure they don’t
become overloaded.
When a domain controller is overloaded or otherwise not properly equipped to handle the
additional load of being a bridgehead server, you might want to control which domain
controllers operate as bridgehead servers. You do this by designating preferred bridgehead
servers in a site.
After you designate a preferred bridgehead server, the ISTG will use only the preferred
bridgehead server for intersite replication. If you decide to designate bridgehead servers,
you can and should designate multiple preferred bridgehead servers. If you do not, and the
single domain controller acting as the bridgehead server goes offline or is unable to
replicate for any reason, intersite replication will stop until the server is again available for
replication or you change the preferred bridgehead server configuration options. To
change the preferred bridgehead server, you must do one of the following:
Remove the server as a preferred bridgehead server, and then allow the ISTG to
select the bridgehead servers that should be used.
Remove the server as a preferred bridgehead server, and then specify a different
preferred bridgehead server.
You can prevent this situation simply by specifying more than one preferred bridgehead
server. When there are multiple preferred bridgehead servers, the ISTG will choose one of
the servers you’ve designated as the preferred bridgehead server. If this server fails, the
ISTG chooses another server from the list of preferred bridgehead servers.
You must configure a bridgehead server for each directory partition that needs to be
replicated. If you don’t do this, replication of the partition will fail, and the ISTG will log
an event in the Directory Service event log detailing the failure. Therefore, to ensure
proper replication, you must configure at least one domain controller with a replica of
each directory partition as a bridgehead server. Active Directory has multiple directory
partitions, which are replicated in the following ways:
On a forestwide basis for configuration and schema directory partitions
On a domainwide basis for the domain directory partition
On a select basis for the partition containing global catalog data
On a select basis for application partitions

When DNS is integrated with Active Directory, a domain controller has ForestDnsZones
and DomainDnsZones application partitions. These partitions are used by DNS to store
DNS records and other related data.
To configure a domain controller as a preferred bridgehead server, complete the following
steps:
1.                  In Active Directory Sites And Services, domain controllers associated with
a site are listed in the site’s Servers node. To locate the domain controller you want
to work with, expand the site node, and then expand the related Servers node.
2.                  Right-click the server you want to designate as a preferred bridgehead
server, and then select Properties.
3.                  In the Properties dialog box, shown in Figure 7-7, you have the option of
configuring the server as a preferred bridgehead server for either IP or SMTP.
Select the appropriate transport in the Transports Available For Inter-Site Data
Transfer list, and then click Add. If you later want the server to stop being a
preferred bridgehead, select the transport in the This Server Is A Preferred
Bridgehead Server For The Following Transports list, and then click Remove.
4.                  Click OK.
FIGURE 7-7 Designating a preferred bridgehead server.

Locating ISTGs
Each site has an ISTG that is responsible for generating the intersite replication topology.
As your organization grows and you add domain controllers and sites, the load on the
ISTG can grow substantially because the ISTG must perform additional calculations to
determine and maintain the optimal topology. When it is calculating the replication
topology, its processor could reach 100 percent utilization. As the topology becomes more
and more complex, the process will stay near maximum utilization longer and longer.
Because the ISTG can become overloaded, you should monitor each site’s ISTG closely.
At the command line, you can determine the ISTG for a particular site by entering the
following command.
repadmin /istg “site:SiteName”
Here, SiteName is the name of the site to examine. In the following example, you list the
ISTG for the Denver-First-Site site.
repadmin /istg “site:Denver-First-Site”
You also can determine the ISTG by completing the following steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then select the site in which you want to locate the ISTG.
2.                  In the details pane, double-click NTDS Site Settings.
3.                  In the NTDS Site Settings Properties dialog box, the current ISTG is listed
in the Inter-Site Topology Generator panel (see Figure 7-8).

FIGURE 7-8 Locating the ISTG.

Optimizing Site Link Configurations
After you configure sites and site links, you’ll want to monitor the flow of traffic between
sites and might need to make changes to optimize the configuration. In addition to
techniques discussed previously, you can use the following steps to control how
compression, synchronization, and notification are used during replication:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the Inter-Site Transports container. In the container for the transport
protocol you want to work with (either IP or SMTP), right-click the site link you
want to modify, and then select Properties.
2.                  In the Properties dialog box, click the Attribute Editor tab, as in Figure 7-
9. Scroll through the list of attributes until you find the Options attribute. When you
find this attribute, select it, and then click Edit.
FIGURE 7-9 Locate the Options attribute and determine its current value.
3.                  In the Integer Attribute Editor dialog box, you can now do the following:
Enter 1 to enable notification for intersite replication. This means the bridgehead
servers on either side of the link can notify each other that changes have occurred.
This allows the bridgehead server receiving the notification to pull the changes
across the site link and thereby get more frequent updates.
Enter 2 to enable two-way synchronization for intersite replication. This means
bridgehead servers on either side of the link can synchronize changes at the same
time. This allows simultaneous synchronization in two directions for faster updates.

Use this setting only on links with sufficient bandwidth to handle two-way sync
traffic.
Enter 4 to turn off compression for intersite replication. This means the bridgehead
servers on either side of the link will no longer use compression. Use this option
only when you have sufficient bandwidth for a site connection and are concerned
about high processor utilization on the affected bridgehead servers.
Use combinations of the flag values to set multiple flags. For example, a value of 5
means compression will be turned off and notification for intersite replication will
be enabled.
Click Clear to reset the Options attribute to its default value of <not set>. When
Options is not set, notification for intersite replication is disabled and compression
is turned on.
4.                  Click OK twice.


Monitoring, Verifying, and Troubleshooting Replication
As part of routine maintenance, you need to monitor domain controllers, global catalog
servers, bridgehead servers, and site links. If you suspect problems with Active Directory,
you should begin your diagnostics and troubleshooting with replication in most cases. By
configuring monitoring of Active Directory intrasite and intersite replication, you can
diagnose and resolve most replication problems.

Monitoring Replication
Using the Performance Monitor, you can perform in-depth monitoring and analysis of
replication and all other Active Directory activities. You open the Performance Monitor by
clicking the related option on the  Tools menu in Server Manager. You can track the
performance of multiple domain controllers from a single monitoring server by using
Performance Monitor’s remote monitoring capabilities.
For monitoring Active Directory, the performance object you’ll use is DirectoryServices.
With this object, many performance counters are available for selection. Most of these
counters have prefixes that reflect the aspect of Active Directory to which the counter
relates. These prefixes include the following:
AB AB counters relate to the Address Book in Active Directory.
ATQ ATQ counters relate to the Asynchronous Thread Queue in Active Directory.
DRA DRA counters relate to the Directory Replication Agent in Active Directory.
DS DS counters relate to the Directory Service in Active Directory.
LDAP LDAP counters relate to the Lightweight Directory Access Protocol in Active
Directory.
SAM SAM counters relate to the Security Accounts Manager in Active Directory.
You can specify counters to monitor by following these steps:
1.                  In the Performance Monitor console, expand the Monitoring Tools node,
and then select the Performance Monitor node.
2.                  Click the Add (+) button on the toolbar or press Ctrl+I. In the Add
Counters dialog box, use the Select Counters From Computer list to select the
computer to monitor.
3.                  Double-click the DirectoryServices or other object to monitor. Specify
counters to track by selecting them in the Select Counters From Computer list and
then clicking Add. You can learn more about counters by selecting the Show
Description check box.
4.                  Click OK when you are finished adding counters.
Note   Distributed File System (DFS) is used to replicate the SYSVOL files
between domain controllers. You can monitor DFS by using the DFS Replicated
Folders, DFS Replication Connections, and DFS Replication Service Volumes
objects.
In addition to monitoring replication, you will want to check the event logs for specific
issues. Events related to Active Directory are logged in the event logs. Events related to
Active Directory, including NTDS replication events, are also logged in the Directory
Service log on the domain controller.
Note  Events related to DFS are recorded in the DFS Replication log on the
domain controller, and the primary source for events is DFSR, which is the DFS
Service itself.

Troubleshooting Replication
Active Directory replication has multiple service dependencies, including LDAP, Domain
Name System (DNS), Kerberos v5 authentication, and remote procedure call (RPC).
These important services must be functioning properly to allow directory updates to be
replicated. During replication, Active Directory relies on various TCP and UDP ports
being open between domain controllers. By default, the ports used by Active Directory are
those listed previously, in Table 7-1. For replication of files in the system volume
(SYSVOL) shared folders on domain controllers, Active Directory uses the DFS
Replication Service. This service must be running and properly configured to replicate the
SYSVOL.
Active Directory tracks changes using update sequence numbers (USNs). Any time a
change is made to the directory, the domain controller processing the change assigns the
change a USN. Each domain controller maintains its own local USNs and increments the
value each time a change occurs. The domain controller also assigns the local USN to the
object attribute that changed. Each object has a related attribute called uSNChanged,
which is stored with the object. The attribute identifies the highest USN that has been
assigned to any of the object’s attributes.
Each domain controller tracks its local USN and also the local USNs of other domain
controllers. During replication, domain controllers compare the received USN values to
what is stored. If the current USN value for a particular domain controller is higher than
the stored value, changes associated with that domain controller need to be replicated. If
the current value for a particular domain controller is the same as the stored value,
changes for that domain controller do not need to be replicated.
You can monitor replication from the command line by using the Replication
Administrator (Repadmin) utility. With Repadmin, most command-line parameters accept
DCList, which identifies the domain controllers you want to work with. You can specify
the values for DCList as follows:
The asterisk (*) is a wildcard that includes all domain controllers in the enterprise.
PartialName* is a partial server name that includes a wildcard to match the remainder
of the server name, such as DenverDC*.
Site:SiteName includes only domain controllers in the named site, such as
Site:Atlanta-First-Site.
Gc: includes all global catalog servers in the enterprise.
Using these values, you can perform many tasks with the Replication Administrator.
These tasks are summarized in Table 7-3.
TABLE 7-3 Key Replication Administrator Commands
repadmin /bridgeheads
DCList ] [/verbose]
Lists bridgehead servers.
repadmin /failcache DCList
Lists failed replication events that were detected by
the Knowledge Consistency Checker (KCC).
Lists the name of the ISTG for a specified site.

repadmin /istg DCList
[/verbose]
repadmin /kcc DCList
[/async]
Forces the KCC to recalculate the intrasite
replication topology for a specified domain
controller. By default, this recalculation occurs
every 15 minutes. Use the /async option to start the
KCC and not wait for it to finish the calculation.
repadmin /latency DCList
[/verbose]
Lists the amount of time between intersite
replications based on the ISTG Keep Alive time
stamp.
repadmin /queue DCList
Lists tasks waiting in the replication queue.
repadmin /replsummary
DCList
Displays a summary of the replication state.
repadmin /showcert DCList
Displays the server certificates loaded on the
specified domain controllers.
repadmin /showconn DCList
Displays the connection objects for the specified
domain controllers. Defaults to the local site.
repadmin /showctx DCList
Lists computers that have opened sessions with a
specified domain controller.
repadmin /showoutcalls
DCList
Lists calls made by the specified server to other
servers but that have not yet been answered.
repadmin /showrepl DCList
Lists the replication partners for each directory
partition on the specified domain controller.
repadmin /showtrust DCList
Lists all domains trusted by a specified domain.

Generating Replication Topology
The Knowledge Consistency Checker (KCC) generates the Active Directory replication
topology on every domain controller. The KCC runs by default every 15 minutes. You can
force the KCC to run on any domain controller. The topology that is generated depends on
the domain controller on which you run the command. You can:
Generate the intersite replication topology by running the KCC on the domain
controller in the site that holds the ISTG role.
Generate the intrasite replication topology by running the KCC on any domain
controller in the site that does not hold the ISTG role.
To generate the replication topology on the ISTG, follow these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the site that contains the ISTG on which you want to run the KCC.
2.                  Expand Servers, and then click the Server object for the ISTG.
3.                  In the details pane, right-click NTDS Settings, click All Tasks, and then
click Check Replication Topology.
4.                  Click OK to have the server generate the intersite replication topology.
To generate the replication topology on a KCC, follow these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the site that contains the non-ISTG domain controller on which you
want to run the KCC.
2.                  Expand Servers, and then click the Server object for the domain controller.
3.                  In the details pane, right-click NTDS Settings, click All Tasks, and then
click Check Replication Topology.
4.                  Click OK to have the server generate the intrasite replication topology.

Verifying and Forcing Replication
When you want changes to be replicated from one server to another sooner than the site
link schedule allows, you can force replication to occur. To force replication of changes
that you’ve made on a specific domain controller, follow these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the site containing the source server from which you want to replicate
changes.
2.                  Expand Servers, and then expand the Server object.
3.                  Click the server’s NTDS Settings object to display related connection
objects in the details pane.
4.                  In the details pane, right-click the connection object that has the updates
that you want to replicate, and then click Replicate Now.
5.                  When the Replicate Now message box appears, review the information
provided, and then click OK.
To force replication of configuration changes to a domain controller that is not receiving
replication as a result of configuration errors, follow these steps:
1.                  In Active Directory Sites And Services, expand the Sites container, and
then expand the site containing the domain controller that you want to receive
updates.
2.                  Expand Servers, and then expand the Server object.
3.                  Right-click the server’s NTDS Settings object, and then select Replicate
Configuration To The Selected DC.
4.                  When the Replicate Now message box appears, review the information
provided, and then click OK.
To synchronize replication with all replication partners of a domain controller, enter the
following command at a command prompt.
repadmin /syncall DomainControllerName /e /d /A /P /q
Here, DomainControllerName is the name of the domain controller for which you want to
synchronize replication with all partners. The /e parameter includes partners in all sites.
The /d parameter identifies servers by their distinguished names in messages. The /A
parameter synchronizes all directory partitions that are held on the source server. The /P
parameter pushes changes outward from the source server. The /q parameter runs the
command in quiet mode and suppresses callback messages.
Note  In the command output, watch for errors. For replication to complete
successfully, any errors must be corrected. If no errors occur, replication is
successful.
Using an elevated, administrator command prompt, you can verify successful replication
on a designated replication partner by entering repadmin /showrepl. If you are not
running Repadmin on the domain controller whose replication you are checking, you can
specify a destination domain controller in the command. For example, if you want to
check DomainController53, you enter the following command.

repadmin /showrepl DomainController53
Repadmin lists inbound neighbors for the current or specified domain controller. These
inbound neighbors identify the distinguished name of each directory partition for which
inbound directory replication has been attempted, the site and name of the source domain
controller, and whether replication succeeded.


Chapter 8. Managing Trusts and Authentication
A trust relationship is a link between two domains in which the trusting domain honors the
logon authentication of a trusted domain. Trust relationships can be created manually
(explicitly) or automatically (implicitly). Whereas trust relationships created manually
need to be managed, trust relationships created automatically do not need to be managed.
Both types of trust relationships, however, should be monitored and, as necessary,
optimized.


Active Directory Authentication and Trusts
Authentication and trusts are integral parts of Active Directory. Before you implement any
Active Directory design or try to modify your existing Active Directory infrastructure, you
should have a firm understanding of how both authentication and trusts work in an Active
Directory environment.

Trust Essentials
In Active Directory, two-way transitive trusts are established automatically between
domains that are members of the same forest. Trusts join parent and child domains in the
same domain tree and join the roots of domain trees. Because trusts are transitive, if
domain A trusts domain B and domain B trusts domain C, domain A trusts domain C as
well. As all trusts in Active Directory are two-way and transitive; by default, every
domain in a forest implicitly trusts every other domain. Further, resources in any domain
are available to users in every domain in the forest. For example, with the trust
relationships in place, a user in the sales.cohovineyard.com domain could access a printer
or other resources in the cohovineyard.com domain or even the cs.cohowinery.com
domain.
However, the creation of a trust doesn’t imply any specific permission. Instead, it implies
only the ability to grant permissions. No privileges are automatically implied or inherited
by the establishment of a trust relationship. The trust doesn’t grant or deny any
permission. It exists only to allow administrators to be able to grant permissions.
Note  A trust allows users in a trusted domain to access resources in a trusting
domain. However, users won’t necessarily have the appropriate security permissions
to access resources. Users are granted access to a resource when they are assigned
the appropriate permissions. That said, keep in mind that users in trusted domains
may have implicit access if the resources are accessible to members of the
Authenticated Users group.
Domains and forests that are part of trusts are described as being either trusted or trusting.
A trusting domain or forest is a domain or forest that establishes a trust. Trusting domains
or forests allow access by users from another domain or forest (the trusted domain or
forest). A trusted domain or forest is a domain or forest that trusts another domain or
forest. Users in trusted domains or forests have access to another domain or forest (the
trusting domain or forest).
The trust path defines the path that an authentication request must take between the two
domains. Authentication requests are passed from a domain controller in the trusted
domain to a domain controller in each domain between the trusted domain and the trusting
domain. The trust path flows up or down domain trees in the following ways:
If the trusting domain is below the trusted domain in the same domain tree,
authentication requests are passed down the tree through each child domain between
the trusted domain and the trusting domain.
If a trusting domain is above the trusted domain in the same domain tree,
authentication requests are passed up the tree through each child domain between the
trusted domain and the trusting domain.
If a trusting domain is in a different domain tree, the trust path flows up the
originating domain tree to the root domain of the domain tree. The trust path then
flows to the root domain of the target domain tree and then down this tree to the
trusting domain.
Thus, a domain controller in the user’s local domain would pass a request to a domain
controller in the next domain in the trust path. This domain controller would in turn pass

the request to a domain controller in the next domain in the trust path, and so on, until
finally the request would be passed to a domain controller in the trusting domain. This
domain controller would ultimately grant or deny access to the resource.
Because domain structure is separate from your network’s physical structure, a resource
could actually be located right beside a user’s desk, and the user’s request would still have
to go through this process. If you expand this scenario, you could potentially have many
hundreds of users whose requests have to go through a similar process to access resources
in a particular domain.
Omitting the fact that the domain design in this scenario is very poor—because if many
users are working with resources, those resources are ideally in their own domain or a
domain closer in the tree—one solution for this problem would be to establish a shortcut
trust between the user’s domain and the resource’s domain. With a shortcut trust, as long
as the domains are in different domain trees, you could specify that the trusted domain
explicitly trusts the trusting domain. From then on, when a user in the trusted domain
requests a resource in the trusting domain, the local domain controller knows about the
trusting domain and can submit the request for authentication directly to a domain
controller in the trusting domain.
Shortcut trusts are meant to help make more efficient use of resources on a busy network.
On a network with a lot of activity, the explicit trust can reduce the overhead on servers
and on the network as a whole. Shortcut trusts shouldn’t be implemented without careful
planning. They should be used only when resources in one domain will be regularly
accessed by users in another domain. They don’t need to be used between two domains
that have a parent-child relationship, because a default trust already exists explicitly
between a parent and a child domain.

Authentication Essentials
When a user logs on to a domain, Active Directory looks up information about the groups
of which the user is a member to generate a security token for the user. The security token
is needed as part of the normal authentication process and is used whenever a user
accesses resources on the network. To generate the security token, Active Directory
checks the domain local, global, and universal group memberships for the user.
Because of problems authenticating users when global catalog servers are not available,
Windows Server can be configured to cache group membership. After you enable caching,
the cache is where domain controllers store group membership information that they have
previously looked up. Domain controllers can use this cache for authentication the next
time the user logs on to the domain. The cache is maintained indefinitely and updated
periodically to ensure that it is current. By default, domain controllers check the
consistency of the cache every 8 hours.
The assignment of security tokens is only part of the logon process. The logon process
also includes authentication and the assignment of a user principal name (UPN) to the
user. Every user account has a UPN, which consists of the user logon name combined with
the at symbol (@) and a UPN suffix. The names of the current domain and the root
domain are set as the default UPN suffix. You can specify an alternate UPN suffix to use
to simplify logon or provide additional logon security.
Active Directory uses Kerberos version 5 as the default authentication protocol. Whenever
a client running Windows tries to authenticate with Active Directory, the client tries to use
Kerberos. Kerberos supports mutual authentication, which allows for two-way
authentication so that not only can a server authenticate a client but a client can also
authenticate a server. Thus, mutual authentication ensures that an authorized client is
trying to access the network and that an authorized server is the one responding to the
client request.
Kerberos uses the following three main components:
A client that needs access to resources
A server that manages access to resources and ensures that only authenticated users
can gain access to resources
A key distribution center (KDC) that acts as a central clearinghouse
All domain controllers run the Kerberos key distribution center service to act as KDCs.
With Kerberos authentication, a user password is never sent over the network. Instead,
Kerberos authentication uses a shared secret authentication model. In most cases, the
client and the server use the user’s password as the shared secret.
When a user logs on to the network, the client sends the KDC server a message containing
the user name, domain name, and a request for access to the network. The message
includes a packet of information that has been encrypted using the shared secret
information (the user’s password), which includes a time stamp.
When the KDC server receives the message, the server reads the user name and then
checks the directory database for its copy of the shared secret information (the user’s
password). The KDC server then decrypts the secret part of the message and checks the

message time stamp. As long as the message time stamp is within 5 minutes of the current
time on the server, the server can authenticate the user. If the decryption fails or the
message time stamp is more than 5 minutes off the current time, the authentication fails.
Five minutes is the default value; the allowable time difference can be modified through
domain security policy, using the Kerberos policy Maximum Tolerance For Computer
Clock Synchronization.
After the user is authenticated, the KDC server sends the client a message that is
encrypted with the shared secret information (the user’s password). The message includes
a session key, which the client will use when communicating with the KDC server from
now on, and a session ticket, which grants the user access to the domain controller. The
ticket is encrypted with the KDC server’s key, which makes it valid only for that domain
controller.
When the client receives the message, the client decrypts the message and checks the
message time stamp. As long as the message time stamp is within 5 minutes of the current
time on the server, the client can authenticate the server and assume that the server is
valid. The client then caches the session key so it can be used for all future connections
with the KDC server. The session key is valid until it expires or the user logs off. The
session ticket is cached as well, but it isn’t decrypted.
After initial authentication, the user is granted access to the domain. The only resource to
which the user has been granted access is the domain controller. When the user wants to
access another resource on the network, the client must request access by sending the
KDC server a session ticket request. The message contains the user’s name, the session
ticket the client was previously granted, the name of the network resource the client is
trying to access, and a time stamp that is encrypted with the session key.
When the KDC server receives the message, the server decrypts the session ticket using its
key. Afterward, it extracts the original session key from the session ticket and uses it to
decrypt the time stamp, which is then validated. The validation process is designed to
ensure that the client is using the correct session key and that the time stamp is valid.
If all is acceptable, the KDC server sends a session ticket to the client. The session ticket
includes two copies of a session key that the client will use to access the requested
resource. The first copy of the session key is encrypted using the client’s session key. The
second copy of the session key contains the user’s access information and is encrypted
with the resource’s secret key known only by the KDC server and the network resource.
The client caches the session ticket and then sends it to the network resource to gain
access. This request also contains an encrypted time stamp.
The network resource decrypts the second session key in the session ticket, using the
secret key it shares with the KDC server. If this is successful, the network resource has
validated that the session ticket came from a trusted KDC. It then decrypts the user’s
access information, using the session key, and checks the user’s access permissions. The
time stamp sent from the client is also decrypted and validated by the network resource.
If the authentication and authorization are successful (meaning that the client has the
appropriate access permissions), the user is granted the type of access to the network
resource that the particular permissions allow. The next time the user needs to access the

resource, the session ticket in cache is used, as long as it hasn’t expired. Using a cached
session ticket allows the client to send a request directly to the network resource. If the
ticket has expired, however, the client must start over and get a new ticket.

Authentication Across Domain Boundaries
Active Directory uses Kerberos security for server-to-server authentication and the
establishment of trusts, while allowing older clients and servers on the network to use NT
LAN Manager (NTLM) authentication if necessary. With Active Directory, trusts are
automatically configured between all the domains in a forest and are implemented as two-
way transitive trusts. As a result, users in one domain in the forest can automatically
access resources in any other domain in the forest. Because the trusts are automatically
established between all domains in the forest, no setup is involved.
As trusts join parent and child domains in the same domain tree and join the roots of
domain trees, the structure of trusts in a forest can be referred to as a trust tree. When a
user tries to access a resource in another domain, the trust tree is used, and the user’s
request has to pass through one domain controller for each domain that is located between
the user and the resource. This type of authentication takes place across domain
boundaries. Authentication across domain boundaries also applies when a user with an
account in one domain visits another domain in the forest and tries to log on to the
network from that domain.
A lengthy referral process can be avoided if you establish an explicit trust between two
domains. Technically, explicit trusts are one-way transitive trusts, but you can establish a
two-way explicit trust by creating two one-way trusts. Thus, unlike standard trusts within
the trust tree, which are inherently two-way and transitive, explicit trusts can be made to
be two-way if desired. Because they can be used to establish authentication shortcuts
between domains, they are also referred to as shortcut trusts.

Authentication Across Forest Boundaries
Active Directory supports two types of trusts across forest boundaries:
Realm trusts
Cross-forest transitive trusts
You can use realm trusts to connect Windows domains with interoperable Kerberos V5
realms. Realm trusts can be one-way, two-way, transitive or nontransitive. The most
common type of realm trust is a one-way nontransitive trust. Here, the trust is bounded by
the domain and the realm in the relationship. Users on one side of the trust can access
resources on the other side of the trust but cannot access any other domain or realm. The
reason for this limitation is that the trust doesn’t continue past the target domain or realm.
In contrast, a two-way nontransitive trust would allow users on both sides of the trusts to
access resources in the other domain or realm but again the trust doesn’t continue past the
source domain and target realm or vice versa. To create a realm trust that includes the
children of the domain and the realm in the relationship, the trust must be transitive.
You can use cross-forest transitive trusts, also referred to simply as forest trusts, to
establish a one-way or two-way transitive trust between forests to share resources and to
authenticate users. With a two-way trust, you enable cross-forest authentication and cross-
forest authorization that allows users in any domain in both forests to access resources in
any domain in both forests.
After you establish a two-way cross-forest trust, users get all the benefits of Active
Directory regardless of where they sign on to the network. With cross-forest
authentication, you ensure secure access to resources when the user account is in one
forest and the computer account is in another forest and when the user in one forest needs
access to network resources in another trusted forest. As part of cross-forest authorization,
administrators can select users and global groups from trusted forests for inclusion in local
groups. This ensures the integrity of the forest security boundary while allowing trust
between forests.
When you connect two or more forests using cross-forest trusts, the implementation is
referred to as a federated forest design. The federated forest design is most useful when
you need to join two separate Active Directory structures; for example, when two
companies merge, when one company acquires another, or when an organization has a
major restructuring. Consider the case in which two companies merge, and, rather than
migrate their separate Active Directory structures into a single directory tree, the staff
decides to link the two forests using cross-forest trusts. As long as the trusts are two way,
users in forest 1 can access resources in forest 2, and users in forest 2 can access resources
in forest 1.
Having separate forests with cross-forest trusts between them is also useful when you
want a division or group within the organization to have more autonomy but still have a
link to the other divisions or groups. By placing the division or group in a separate forest,
you ensure strict security and give that division or group ownership of the Active
Directory structure. If users in the forest need access to resources in another forest, you
can establish a one-way cross-forest trust between the forests. This allows users in the

secured forest to gain access to resources in the second forest but will not allow users in
the second forest to gain access to the secure forest. Organizations that contain groups or
divisions with rigorous security requirements could use this approach.


Working with Domain and Forest Trusts
You can work with trusts using Active Directory Domains and Trusts. To start this tool,
open the Tools menu in Server Manager, and then select Active Directory Domains And
Trusts.

Examining Trusts
To examine the existing trusts for a domain, start Active Directory Domains and Trusts,
right-click the domain entry, and then select Properties. In the domain’s Properties dialog
box, click the Trusts tab.
Figure 8-1 Review the existing trusts to determine the trusting and trusted domains for the
previously selected domain.
As shown in Figure 8-1, the Trust tab has two panels:
Domains Trusted By This Domain (Outgoing Trusts) This lists the domains that this
domain trusts (the trusted domains).
Domains That Trust This Domain (Incoming Trusts) This lists the domains that trust
this domain (the trusting domains).
The trust type and transitivity of each trust is listed on the Trusts tab. In Figure 8-1, the
trust between the imaginedlands.com domain and the tech.imaginedlands.com domain is a
transitive, child trust. This tells you imaginedlands.com is the parent domain and
tech.imaginedlands.com is the child domain and there is a transitive trust between them.
You can view information about a particular trust by selecting it and then clicking
Properties. As Figure 8-2 shows, the Properties dialog box contains the following
information:
This Domain The domain you are working with.
Other/Child Domain The domain with which the trust is established.
Trust Type The type of trust. By default, two-way transitive trusts are created
automatically when a new domain is added to a new domain tree within the forest or
a subdomain of a root domain. There are two default trust types: Tree Root, and
Parent-Child. When a new domain tree is added to the forest, the default trust that is

established automatically is a tree-root trust. When a new domain is a subdomain of a
root domain, the default trust that is established automatically is a Parent-Child trust.
Other trust types that may appear include the following:
External, which is a one-way or two-way nontransitive trust used to provide access
to a domain in a separate forest that is not joined by a forest trust
Forest, which is a one-way or two-way transitive trust used to share resources
between forests
Realm, which is a transitive or nontransitive trust that can be established as one way
or two way between a non-Windows Kerberos realm and a Windows Server domain
Shortcut, which is a one-way or two-way transitive trust used to speed up
authentication and resource access between domain trees
Figure 8-2 Review the properties of the trust to get detailed information.
Direction Of Trust The direction of the trust. All default trusts are established as
two-way trusts. This means that users in the domain you are working with can
authenticate in the other domain, and users from the other domain can authenticate in
the domain you are working with.
Transitivity Of Trust The transitivity of the trust. All default trusts are transitive,
which means that users from indirectly trusted domains can authenticate in the other
domain.

Establishing Trusts
All trusts, regardless of type, are established in the same way. All trusts have two sides: an
incoming trust and an outgoing trust. Both sides of a trust must be established before the
trust can be used.
For domain trusts, you need to use two accounts: one that is a member of the Domain
Admins group in the first domain and one that is a member of the Domain Admins group
in the second domain. If you don’t have appropriate accounts in both domains, you can
establish one side of the trust and allow an administrator in the other domain to establish
the other side of the trust.
For forest trusts, you will need to use two accounts: one that is a member of the Enterprise
Admins group in the first forest and one that is a member of the Enterprise Admins group
in the second forest. If you don’t have appropriate accounts in both forests, you can
establish one side of the two-way trust and allow an administrator in the other forest to
establish the other side of the trust.
For realm trusts, you will need to establish the trust separately for the Windows domain
and for the Kerberos realm. If you don’t have appropriate administrative access to both the
Windows domain and the Kerberos realm, you can establish one side of the trust and allow
another administrator to establish the other side of the trust.
You create trusts by using the New Trust Wizard, which is started from Active Directory
Domains and Trusts. The domain or forest where you start the New Trust Wizard is the
local domain or forest and is referred to as “this domain or forest.” The other domain or
forest that the local domain or forest will trust is referred to as the “specified domain or
forest.”
To start the New Trust Wizard, follow these steps:
1.                  On theTools menu in Server Manager, select Active Directory Domains
And Trusts.
2.                  Right-click the domain for which you want to establish a one-way
incoming, one-way outgoing, or two-way trust, and then choose Properties. For a
cross-forest trust, the domain you use must be the forest root domain in one of the
participating forests.
3.                  In the domain Properties dialog box, click the Trusts tab. Click the New
Trust button to start the New Trust Wizard, as shown in Figure 8-3, and then click
Next.

Figure 8-3 The New Trust Wizard.
4.                  On the Trust Name page, shown in Figure 8-4, you must specify the
domain name of the other domain. When you click Next, the wizard will attempt to
validate the domain name by contacting the domain.
Figure 8-4 Specify the DNS or NetBIOS name of the other domain.
5.                  If the wizard cannot contact the domain, you’ll see the Trust Type page,
shown in Figure 8-5, and will need to specify whether you are trying to create a
realm trust with an interoperable Kerberos v5 realm or a trust with a Windows
domain. With Windows domains, you can retype the domain name before clicking
Next to continue, or you can simply click Next to continue.

Figure 8-5 Specify the type of trust.
When working with the New Trust Wizard, keep in mind the terms listed in Table 8-1.
TABLE 8-1 Important Terms Used by the New Trust Wizard
Trust password
A password stored in the trusted domain object in Active
Directory. When you choose this option, a strong trust
password is generated automatically for you. You must use
the same password when you create a trust relationship
between domains.
Both sides of the trust
When you create trusts, you have the option to create each
side of the trust separately or both sides of the trust
simultaneously. If you choose to create each side of the
trust separately, you must run the New Trust Wizard twice
—once for each domain—and must supply the same trust
password for each domain. If you choose to create both
sides of the trust simultaneously, you run the New Trust
Wizard once, and the trust password you provide is applied
to both sides of the trust. All trust passwords should be
strong passwords.
One-way incoming
trust
A one-way trust relationship between two domains in
which the direction of the trust points toward the domain
from which you start the New Trust Wizard. When the
direction of the trust points toward a domain, users in that
domain can access resources in the specified domain. For
example, if you are logged on to domain A and you create
a one-way incoming trust to domain B, users in domain A
can access resources in domain B. Because this
relationship is one way, users in domain B cannot access
resources in domain A.
One-way outgoing
trust

A one-way trust relationship between two domains in
which the direction of the trust points toward the specified
target domain. When the direction of trust points toward a
specified domain, users in the specified domain can access
resources in the domain from which you start the New
Trust Wizard. For example, if you are logged on to domain
A and you create a one-way outgoing trust to domain B,
users in domain B can access resources in domain A.
Because this relationship is one way, users in domain A
cannot access resources in domain B.
Two-way trust
A trust relationship between two domains in which both
domains trust each other. For example, domain A trusts
domain B, and domain B trusts domain A. All parent-child
trusts are two-way trusts.
Domainwide
authentication
An authentication setting that permits unrestricted access
by any users in the specified domain to all available shared
resources that are located in the local domain. This is the
default authentication setting for external trusts.
Forestwide
authentication
An authentication setting that permits unrestricted access
by any users in the specified forest to all available shared
resources located in any of the domains in the local forest.
This is the default authentication setting for forest trusts.
Selective
authentication
An authentication setting that restricts access over an
external trust or forest trust to only those users in a
specified domain or specified forest who have been
explicitly given authentication permissions to resource
computers that reside in the local domain or the local
forest. This authentication setting must be enabled
manually.

Creating External Trusts
When users need to access resources that are located in a separate Active Directory forest
that is not joined by a forest trust, you can create an external trust to form a one-way or
two-way nontransitive trust between the domains. Although you can create an external
trust between two domains, external trusts cannot be extended implicitly to a third domain.
If you have the appropriate administrative credentials for each domain, you can create
both sides of an external trust at the same time. Otherwise, you will need to create each
side of the trust separately.
Real World  To create an external trust successfully, you must ensure DNS is
configured properly. If you have a root DNS server that you can make the root DNS
server for the DNS namespaces of both forests, you should make that server the root
DNS server by ensuring that the root zone contains delegations for each of the DNS
namespaces. You also should update the root hints of all DNS servers with the new
root DNS server. If you have no shared root DNS server, and the root DNS servers
for each forest DNS namespace are running Windows Server, configure DNS
conditional forwarders in each DNS namespace to route queries for names in the
other namespace. If you have no shared root DNS servers, and the root DNS servers
for each forest DNS namespace are not running Windows Server, configure DNS
secondary zones in each DNS namespace to route queries for names in the other
namespace.
Creating a One-Way Incoming External Trust
A one-way incoming external trust allows users in the domain or forest where you start the
New Trust Wizard to access resources in a domain outside your forest. With a one-way
incoming external trust, one side of a trust will be created, but the new trust will not
function until the administrator for the reciprocal domain uses his or her credentials to
create the outgoing side of the trust. If you have administrative credentials for both
domains involved in the trust, you can create both sides of the trust in one operation.
To create a one-way incoming external trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a one-way incoming external trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
external domain, and then click Next.
4.                  On the Trust Type page, click Trust with a Windows Domain, and then
click Next.
5.                  On the Direction Of Trust page, click One-Way: Incoming, and then click
Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Trust Password page, enter

and then confirm the trust password, and then click Next three times to begin the
trust creation process.
8.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next. Afterward, on the Outgoing Trust
Authentication Level–Specified Domain page, click Domain-Wide Authentication
or Selective Authentication as appropriate, and then click Next three times.
9.                  On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the domain administrator for the specified
domain or forest must create a one-way outgoing external trust. The same trust
password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
incoming trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
10.             On the Completing The New Trust Wizard page, click Finish.
Creating a One-Way Outgoing External Trust
A one-way outgoing external trust will allow resources in the domain or forest where you
start the New Trust Wizard to be accessed by users in a domain outside your forest. With a
one-way outgoing external trust, one side of a trust will be created, but the new trust will
not function until the administrator for the reciprocal domain uses his or her credentials to
create the incoming side of the trust. If you have administrative credentials for both
domains involved in the trust, you can create both sides of the trust in one operation.
To create a one-way outgoing external trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a one-way outgoing external trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
external domain, and then click Next.
4.                  On the Trust Type page, click Trust with a Windows Domain, and then
click Next.
5.                  On the Direction Of Trust page, click One-Way: Outgoing, and then click
Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Outgoing Trust
Authentication Level–Specified Domain page, click Domain-Wide Authentication
or Selective Authentication as appropriate, and then click Next. Afterward, on the
Trust Password page, enter and then confirm the trust password, and then click
Next three times to begin the trust creation process.

8.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next. Afterward, on the Outgoing Trust
Authentication Level–Specified Domain page, click Domain-Wide Authentication
or Selective Authentication as appropriate, and then click Next three times.
9.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the domain administrator for the specified
domain or forest must create a one-way incoming external trust. The same trust
password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
10.             On the Completing The New Trust Wizard page, click Finish.
Creating a Two-Way External Trust
A two-way external trust allows users in the domain or forest where you start the New
Trust Wizard and users in the reciprocal domain to access resources in either of the two
domains. When you create a two-way external trust, you can establish one or both sides of
the trust. When you establish one side of the trust, the trust will be created, but the new
trust will not function until the administrator for the reciprocal domain uses his or her
credentials to create the other side of the trust. If you have administrative credentials for
both domains involved in the trust, you can create both sides of the trust in one operation.
To create a two-way external trust for one or both sides of the trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a two-way incoming external trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
external domain, and then click Next.
4.                  On the Trust Type page, click Trust with a Windows Domain, and then
click Next.
5.                  On the Direction Of Trust page, click Two-Way, and then click Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Outgoing Trust
Authentication Level–Specified Domain page, click Domain-Wide Authentication
or Selective Authentication as appropriate, and then click Next. Afterward, on the
Trust Password page, enter and then confirm the trust password, and then click
Next three times to begin the trust creation process.
8.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next. Afterward, on the Outgoing Trust

Authentication Level–Specified Domain page, click Domain-Wide Authentication
or Selective Authentication as appropriate, and then click Next three times.
9.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the domain administrator for the specified
domain or forest must repeat this procedure and establish the outgoing trust for the
other side of the trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
10.             On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the domain administrator for the specified
domain or forest must repeat this procedure and establish the incoming trust for the
other side of the trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
11.             On the Completing The New Trust Wizard page, click Finish.

Creating Shortcut Trusts
A shortcut trust is a manually created trust that shortens the trust path to allow users to
more quickly access resources in a domain that is in another domain tree in the same
forest. How you use shortcut trusts depends on how you implement your Active Directory
domains. When your forest contains multiple domain trees, each with many child
domains, and authentication delays occur between child domains, you can optimize the
authentication process between the child domains by creating shortcut trusts between
midlevel domains in each domain tree. When your forest is less extensive and users are
experiencing delays while accessing resources in other domains, you may want to
establish a shortcut trust directly between the user domain and the resource domain to
shorten the trust path.
Creating a One-Way Incoming Shortcut Trust
A one-way incoming shortcut trust allows users in the domain where you start the New
Trust Wizard to more quickly access resources in a domain that is in another domain tree
in the same forest. With a one-way incoming shortcut trust, one side of a trust will be
created, but the new trust will not function until the administrator for the reciprocal
domain uses his or her credentials to create the outgoing side of the trust. If you have
administrative credentials for both domains involved in the trust, you can create both sides
of the trust in one operation.
To create a one-way incoming shortcut trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a one-way incoming shortcut trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
domain, and then click Next.
4.                  On the Direction Of Trust page, click One-Way: Incoming, and then click
Next.
5.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
6.                  If you are creating one side of the trust, on the Trust Password page, enter
and then confirm the trust password, and then click Next three times to begin the
trust creation process.
7.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next three times.
8.                  On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the domain administrator for the specified
domain must create a one-way outgoing shortcut trust. The same trust password

must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
incoming trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
9.                  On the Completing The New Trust Wizard page, click Finish.
Creating a One-Way Outgoing Shortcut Trust
A one-way outgoing shortcut trust will allow resources in the domain where you start the
New Trust Wizard to be accessed more quickly by users in a domain that is in another
domain tree in the same forest. With a one-way outgoing shortcut trust, one side of a trust
will be created, but the new trust will not function until the administrator for the reciprocal
domain uses his or her credentials to create the incoming side of the trust. If you have
administrative credentials for both domains involved in the trust, you can create both sides
of the trust in one operation.
To create a one-way outgoing shortcut trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a one-way outgoing shortcut trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
domain, and then click Next.
4.                  On the Direction Of Trust page, click One-Way: Outgoing, and then click
Next.
5.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
6.                  If you are creating one side of the trust, on the Trust Password page, enter
and then confirm the trust password, and then click Next three times to begin the
trust creation process.
7.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next three times.
8.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the domain administrator for the specified
domain must create a one-way incoming shortcut trust. The same trust password
must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
9.                  On the Completing The New Trust Wizard page, click Finish.
Creating a Two-Way Shortcut Trust

A two-way shortcut trust allows users in the domain where you start the New Trust Wizard
and users in a domain that is in another domain tree in the same forest to access resources
in either of the two domains more quickly. When you create a two-way shortcut trust, you
can establish one or both sides of the trust. When you establish one side of the trust, the
trust will be created, but the new trust will not function until the administrator for the
reciprocal domain uses his or her credentials to create the other side of the trust. If you
have administrative credentials for both domains involved in the trust, you can create both
sides of the trust in one operation.
To create a two-way shortcut trust for one or both sides of the trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a two-way shortcut trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the other
domain, and then click Next.
4.                  On the Direction Of Trust page, click Two-Way, and then click Next.
5.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
6.                  If you are creating one side of the trust, on the Trust Password page, enter
and then confirm the trust password, and then click Next three times to begin the
trust creation process.
7.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified domain, and then click Next three times.
8.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the domain administrator for the specified
domain must repeat this procedure and establish the outgoing trust for the other side
of the trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
9.                  On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the domain administrator for the specified
domain must repeat this procedure and establish the incoming trust for the other
side of the trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
10.             On the Completing The New Trust Wizard page, click Finish.

Creating Forest Trusts
When users need to access resources that are located in a disjoined forest, you can create a
forest trust to form a one-way or two-way transitive trust relationship. Although you can
create a forest trust between two disjoined forests, forest trusts cannot be extended
implicitly to a third forest. If you have the appropriate administrative credentials for each
forest, you can create both sides of a forest trust at the same time. Otherwise, you will
need to create each side of the trust separately.
Real World  To create a forest trust successfully, you must ensure DNS is
configured properly. If there is a root DNS server that you can make the root DNS
server for the DNS namespaces of both forests, you should make that server the root
DNS server by ensuring that the root zone contains delegations for each of the DNS
namespaces. You also should update the root hints of all DNS servers with the new
root DNS server. If there is no shared root DNS server and the root DNS servers for
each forest DNS namespace are running Windows Server, configure DNS
conditional forwarders in each DNS namespace to route queries for names in the
other namespace. If there are no shared root DNS servers and the root DNS servers
for each forest DNS namespace are not running Windows Server, configure DNS
secondary zones in each DNS namespace to route queries for names in the other
namespace.
Creating a One-Way Incoming Forest Trust
A one-way incoming forest trust allows users in the forest where you start the New Trust
Wizard to access resources in another Windows forest. With a one-way incoming forest
trust, one side of a trust will be created, but the new trust will not function until the
administrator for the reciprocal forest uses his or her credentials to create the outgoing
side of the trust. If you have administrative credentials for both forests involved in the
trust, you can create both sides of the trust in one operation.
To create a one-way incoming forest trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain node for
the forest root domain of the forest for which you want to establish an incoming
forest trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the forest
root domain of the other forest, and then click Next.
4.                  On the Trust Type page, click Forest Trust, and then click Next.
5.                  On the Direction Of Trust page, click One-Way: Incoming, and then click
Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Trust Password page, enter
and then confirm the trust password, and then click Next three times to begin the

trust creation process.
8.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified forest, and then click Next. Afterward, on the Outgoing Trust
Authentication Level–Specified Forest page, click Forest-Wide Authentication or
Selective Authentication as appropriate, and then click Next three times.
9.                  On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the administrator for the specified forest
must create a one-way outgoing forest trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
incoming trust. Afterward, provide the appropriate administrative credentials from
the specified forest.
10.             On the Completing The New Trust Wizard page, click Finish.
Creating a One-Way Outgoing Forest Trust
A one-way outgoing forest trust will allow resources in the forest where you start the New
Trust Wizard to be accessed by users in another Windows forest. With a one-way outgoing
forest trust, one side of a trust will be created, but the new trust will not function until the
administrator for the reciprocal forest uses his or her credentials to create the incoming
side of the trust. If you have administrative credentials for both forests involved in the
trust, you can create both sides of the trust in one operation.
To create a one-way outgoing forest trust for one or both sides of the trust, follow these
steps:
1.                  In Active Directory Domains and Trusts, right-click the domain node for
the forest root domain for which you want to establish an outgoing forest trust, and
then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the forest
root domain of the other forest, and then click Next.
4.                  On the Trust Type page, click Forest Trust, and then click Next.
5.                  On the Direction Of Trust page, click One-Way: Outgoing, and then click
Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Outgoing Trust
Authentication Level–Specified Forest page, click Forest-Wide Authentication or
Selective Authentication as appropriate, and then click Next. Afterward, on the
Trust Password page, enter and then confirm the trust password, and then click
Next three times to begin the trust creation process.
8.                  If you are establishing both sides of the trust, on the User Name And

Password page, enter the user name and password for the appropriate administrator
in the specified forest, and then click Next. Afterward, on the Outgoing Trust
Authentication Level–Specified Forest page, click Forest-Wide Authentication or
Selective Authentication as appropriate, and then click Next three times.
9.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the administrator for the specified forest
must create a one-way incoming forest trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified forest.
10.             On the Completing The New Trust Wizard page, click Finish.
Creating a Two-Way Forest Trust
A two-way forest trust allows users in the forest where you start the New Trust Wizard and
users in the reciprocal forest to access resources in either of the two forests. When you
create a two-way forest trust, you can establish one or both sides of the trust. When you
establish one side of the trust, the trust will be created, but the new trust will not function
until the administrator for the reciprocal forest uses his or her credentials to create the
other side of the trust. If you have administrative credentials for both forests involved in
the trust, you can create both sides of the trust in one operation.
To create a two-way forest trust for one or both sides of the trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain node for
the forest root domain for which you want to establish a two-way forest trust, and
then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the forest
root domain of the other forest, and then click Next.
4.                  On the Trust Type page, click Forest Trust, and then click Next.
5.                  On the Direction Of Trust page, click Two-Way, and then click Next.
6.                  On the Sides Of Trust page, click This Domain Only if you are creating
one side of the trust, or click Both This Domain And The Specified Domain if you
are establishing both sides of the trust. Then click Next.
7.                  If you are creating one side of the trust, on the Outgoing Trust
Authentication Level–Specified Forest page, click Forest-Wide Authentication or
Selective Authentication as appropriate, and then click Next. Afterward, on the
Trust Password page, enter and then confirm the trust password, and then click
Next three times to begin the trust creation process.
8.                  If you are establishing both sides of the trust, on the User Name And
Password page, enter the user name and password for the appropriate administrator
in the specified forest, and then click Next. Afterward, on the Outgoing Trust
Authentication Level–Specified Forest page, click Forest-Wide Authentication or
Selective Authentication as appropriate, and then click Next three times.

9.                  On the Confirm Outgoing Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
outgoing trust. For this trust to function, the administrator for the specified forest
must repeat this procedure and establish the outgoing trust for the other side of the
trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified domain.
10.             On the Confirm Incoming Trust page, do one of the following:
Click No if you are establishing one side of the trust and do not want to confirm the
incoming trust. For this trust to function, the administrator for the specified forest
must repeat this procedure and establish the incoming trust for the other side of the
trust. The same trust password must be used.
Click Yes if you are establishing both sides of the trust and want to confirm the
outgoing trust. Afterward, provide the appropriate administrative credentials from
the specified forest.
11.             On the Completing The New Trust Wizard page, click Finish.

Creating Realm Trusts
You can create a realm trust to form a one-way or two-way transitive or nontransitive trust
relationship between a Windows domain and a non-Windows Kerberos realm. Unlike
when you are working exclusively with Windows domains and forests, you will need to
create each side of the trust separately.
Creating a One-Way Incoming Realm Trust
A one-way incoming realm trust allows users in the domain where you start the New Trust
Wizard to access resources in a Kerberos realm. With a one-way incoming realm trust, the
Windows domain side of a trust will be created, but the new trust will not function until
the administrator for the Kerberos realm uses his or her credentials to create the outgoing
side of the trust.
To create a one-way incoming realm trust for the Windows domain side of the trust,
follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish an incoming realm trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the
Kerberos realm in uppercase letters, and then click Next.
4.                  On the Trust Type page, click Realm Trust, and then click Next.
5.                  On the Transitivity Of Trust page, click Nontransitive to form a trust
relationship with the domain and the specified realm only, or click Transitive to
form a trust relationship with the domain and the specified realm and all trusted
realms.
6.                  On the Direction Of Trust page, click One-Way: Incoming, and then click
Next.
7.                  On the Trust Password page, enter and then confirm the trust password,
and then click Next three times to begin the trust creation process.
8.                  On the Completing The New Trust Wizard page, click Finish.
Creating a One-Way Outgoing Realm Trust
A one-way outgoing realm trust will allow resources in the domain where you start the
New Trust Wizard to be accessed by users in a Kerberos realm. With a one-way outgoing
realm trust, the Windows domain side of a trust will be created, but the new trust will not
function until the administrator for the Kerberos realm uses his or her credentials to create
the incoming side of the trust.
To create a one-way outgoing realm trust for the Windows domain side of the trust, follow
these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish an outgoing realm trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the

Kerberos realm in uppercase letters, and then click Next.
4.                  On the Trust Type page, click Realm Trust, and then click Next.
5.                  On the Transitivity Of Trust page, click Nontransitive to form a trust
relationship with the domain and the specified realm only, or click Transitive to
form a trust relationship with the domain and the specified realm and all trusted
realms.
6.                  On the Direction Of Trust page, click One-Way: Outgoing, and then click
Next.
7.                  On the Trust Password page, enter and then confirm the trust password,
and then click Next three times to begin the trust creation process.
8.                  On the Completing The New Trust Wizard page, click Finish.
Creating a Two-Way Realm Trust
A two-way realm trust allows users in the realm where you start the New Trust Wizard and
users in the reciprocal realm to access resources in either of the two realms. When you
create a two-way realm trust, you can establish one or both sides of the trust. When you
establish one side of the trust, the trust will be created but will not function until the
administrator for the reciprocal realm uses his or her credentials to create the other side of
the trust. If you have administrative credentials for both realms involved in the trust, you
can create both sides of the trust in one operation.
To create a two-way realm trust for one or both sides of the trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain for which
you want to establish a two-way realm trust, and then click Properties.
2.                  On the Trusts tab, click New Trust, and then click Next.
3.                  On the Trust Name page, enter the DNS (or NetBIOS) name of the
Kerberos realm in uppercase letters, and then click Next.
4.                  On the Trust Type page, click Realm Trust, and then click Next.
5.                  On the Transitivity Of Trust page, click Nontransitive to form a trust
relationship with the domain and the specified realm only, or click Transitive to
form a trust relationship with the domain and the specified realm and all trusted
realms.
6.                  On the Direction Of Trust page, click Two-Way, and then click Next.
7.                  On the Trust Password page, enter and then confirm the trust password,
and then click Next three times to begin the trust creation process.
8.                  On the Completing The New Trust Wizard page, click Finish.

Removing Manually Created Trusts
You can remove manually created trusts when they are no longer needed. You cannot
remove default trusts.
To remove a manually created trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain that
contains the trust you want to remove, and then click Properties.
2.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
trust to be removed, and then click Remove.
3.                  When prompted, do one of the following:
Click No to remove the trust from the local domain only. Repeat this procedure for
the reciprocal domain.
Click Yes to remove the trust from both the local domain and the other domain.
When prompted, enter a user name and password with administrative credentials for
the reciprocal domain.
You can remove a trust by running Netdom Trust at an elevated, administrator command
prompt. Right-click the Windows logo, and then click Command Prompt (Admin). At the
elevated command prompt, enter the following command.
netdom trust TrustingDomainName /d:TrustedDomainName /remove
Here, TrustingDomainName specifies the DNS (or NetBIOS) name of the trusting domain
in the trust that is being removed, and TrustedDomainName specifies the DNS (or
NetBIOS) name of the domain that will be trusted in the trust that is being removed.
Using the /UserO and /PasswordO parameters, you can specify administrator credentials
for the trusting domain. Using the /UserD and /PasswordD parameters, you can specify
administrator credentials for the trusted domain. With both the /PasswordO and
/PasswordD parameters, you will be prompted for the required password when you enter *
as the password.

Verifying and Troubleshooting Trusts
By default, Windows validates all incoming trusts automatically. If the credentials used to
establish the trust are no longer valid, the trust fails verification. Occasionally, you may
want to revalidate trusts. If clients are unable to access resources in a domain outside the
forest, the external trust between the domains may have failed. In this case, you should
verify the trust for the trusted domain. Note that a primary domain controller (PDC)
emulator must be available to reset and verify the external trust.
Clients or servers can get trust errors within an Active Directory forest for several reasons.
The time on the clients or servers trying to authenticate may be more than 5 minutes off,
which is the default maximum time difference allowed for Kerberos authentication. In this
case, synchronize the time on the clients and servers. The problem could also be that the
domain controller is down or the trust relationship is broken. For the latter case, you can
run Netdom to verify or reset the trust.
To revalidate or reset a trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the trusted domain for
which you want to verify the incoming trust, then select Properties.
2.                  In the domain’s Properties dialog box, click the Trusts tab, and then click
Validate.
3.                  To validate and reset (if necessary) only the outgoing trust, select No, Do
Not Validate The Incoming Trust. To validate and reset (if necessary) both the
incoming and outgoing trust, select Yes, Validate The Incoming Trust, and then
enter the user name and password for an administrator account in the reciprocal
domain.
4.                  Click OK. If the trust is valid and active, you’ll see a prompt confirming
this. If the trust is not valid, Active Directory Domains and Trusts will attempt to
reset the trust. However, you may need to ensure both sides of the trust have been
created and that the trust passwords are set the same.
You can validate a trust by running Netdom Trust at an elevated, administrator command
prompt. Right-click the Windows logo, and then click Command Prompt (Admin). At the
elevated command prompt, enter the following command.
netdom trust TrustingDomainName /d:TrustedDomainName /verify
Here, TrustingDomainName specifies the DNS (or NetBIOS) name of the trusting domain
in the trust that is being created, and TrustedDomainName specifies the DNS (or
NetBIOS) name of the domain that will be trusted in the trust that is being created.


Configuring Selective Authentication
Creating an external trust or forest trust provides a pathway for all authentication requests
between domains and forests. For an external trust, the domainwide authentication setting
permits unrestricted access by any users in the trusted domain to all available shared
resources in the trusting domain. For a forest trust, the forestwide authentication setting
permits unrestricted access by any users in the trusted forest to all available shared
resources in any of the domains in the trusting forest.
To enact controls over how authentication can be used between forests, you can use
selective authentication. Selective authentication allows administrators to control which
groups of users in a trusted domain or forest can access shared resources in a trusting
domain or forest.

Enabling or Disabling Selective Authentication for External Trusts
With respect to external trusts, selective authentication restricts access to only those users
in a trusted domain who have been explicitly granted authentication permissions to
computer objects that reside in the trusting domain. To explicitly give authentication
permissions to computer objects in the trusting domain to certain users, you must grant
those users the Allowed To Authenticate permission in Active Directory. Therefore,
enabling selective authentication for an external trust requires granting the Allowed To
Authenticate permission for computer objects in the trusting domain to users in the trusted
domain and then turning on selective authentication.
To enable selective authentication for an external trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain that
contains the trust you want to configure, and then click Properties.
2.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
external trust that you want to configure, and then click Properties.
3.                  On the Authentication tab, click Selective Authentication to enable
selective authentication, or click Domain-Wide Authentication to disable selective
authentication. Then click OK.
Note  When you use this technique, only the authentication settings for the
outgoing trust are displayed. To view the authentication settings for the incoming
side of a two-way external trust, connect to a domain controller in the trusted
domain, and then use Active Directory Domains and Trusts to view the
authentication settings for the outgoing side of the same trust.

Enabling or Disabling Selective Authentication for Forest Trusts
With respect to forest trusts, selective authentication restricts access to only those users in
a trusted forest who have been explicitly granted authentication permissions to computer
objects that reside in the trusting forest. To explicitly give authentication permissions to
computer objects in the trusting forest to certain users, you must grant those users the
Allowed To Authenticate permission in Active Directory. Therefore, enabling selective
authentication for a forest trust requires granting the Allowed To Authenticate permission
for computer objects in the trusting forest to users in the trusted forest and then turning on
selective authentication.
To enable selective authentication for a forest trust, follow these steps:
1.                  In Active Directory Domains and Trusts, right-click the domain node for
the forest root domain that contains the trust you want to configure, and then click
Properties.
2.                  On the Trusts tab, under either Domains Trusted By This Domain
(Outgoing Trusts) or Domains That Trust This Domain (Incoming Trusts), click the
forest trust that you want to configure. Then click Properties.
3.                  On the Authentication tab, click Selective Authentication to enable
selective authentication, or click Forest-Wide Authentication to disable selective
authentication. Then click OK.
Note  When you use this technique, only the authentication settings for the
outgoing trust are displayed. To view the authentication settings for the incoming
side of a two-way forest trust, connect to a domain controller in the trusted forest,
and then use Active Directory Domains and Trusts to view the authentication
settings for the outgoing side of the same trust.

Granting the Allowed To Authenticate Permission
When you enable selective authentication, each user must be explicitly granted access to
resources by granting the Allowed To Authenticate permission on computer objects that
reside in the trusting domain or forest. To grant the Allowed To Authenticate permission
on computers in the trusting domain or forest, follow these steps:
1.                  In Active Directory Users and Computers, select View Advanced Features
and then open the Computers container or other container where your computer
objects reside.
2.                  Right-click the computer object that you want users in the trusted domain
or forest to access, and then click Properties.
3.                  On the Security tab, do one of the following:
In Group Or User Names, click a user or group name for which you want to grant
access to this computer, and then select the Allow check box next to the Allowed To
Authenticate permission. Repeat as necessary. Click OK when you finish.
Click Add. In the Enter The Object Names To Select box, enter the name of the user
or group object for which you want to grant access to this resource computer, and
then click OK. Select the Allow check box next to the Allowed To Authenticate
permission, and then click OK.


Chapter 9. Maintaining and Recovering Active Directory
As an administrator, you’ll perform many different tasks to maintain and recover Active
Directory Domain Services (AD DS). In other chapters of this book, I’ve covered most of
these tasks. In this chapter, I cover the following additional tasks:
Protecting items from accidental deletion
Starting and stopping AD DS
Setting the functional level of domains and forests
Configuring deleted item retention
Configuring the Windows Time service
Backing up and restoring Active Directory
Maintaining the directory database


Protecting Objects from Accidental Deletion
When you are working with Windows Server, the Protect Object From Accidental
Deletion option is available for objects created in Active Directory Users And Computers,
Active Directory Sites And Services, and Active Directory Domains And Trusts. When
enabled, this option implements the Deny Delete Subtree permission, which prevents the
object from being accidentally deleted.
To protect an object from deletion, follow these steps:
1.                  Start Active Directory Users And Computers, Active Directory Sites And
Services, or Active Directory Domains And Trusts, as appropriate, from the Tools
menu in Server Manager.
2.                  Enable Advanced Features on the View menu by clicking View and then
selecting Advanced Features.
3.                  When you enable Advanced Features, the Protect Object From Accidental
Deletion option is available on the Object tab in the object’s Properties dialog box.
Double-click the object you want to work with to open its Properties dialog box.
4.                  Select the Protect Object From Accidental Deletion option, and then click
OK. If you later want to allow the object to be deleted, repeat this procedure and
clear the Protect Object From Accidental Deletion option.
If the Protect Object From Accidental Deletion option is enabled and you try to delete the
object, the administrator console will appear to let you do this, but the operation will fail
with the error “You do not have sufficient privileges to delete X, or this object is protected
from accidental deletion.”


Starting and Stopping Active Directory Domain Services
All domain controllers can be started in Directory Services Restore Mode (DSRM). When
you are running in DSRM, you can stop AD DS and perform basic database management
procedures, including offline defragmentation. When you are finished managing the
database, you can restart the domain controller in normal mode to resume normal
operations. (For more information, see “Restarting a Domain Controller in Directory
Services Restore Mode” in Chapter 3, “Deploying Writeable Domain Controllers.”)
All domain controllers also support restartable AD DS. This feature allows you to start or
stop AD DS without having to start a domain controller in DSRM. Once you’ve stopped
AD DS, you can perform database management procedures as if you were in DSRM. You
can even perform an authoritative restore of Active Directory objects while AD DS is
stopped. When you are finished managing the database, you can start AD DS to resume
normal operations.
Note  You cannot perform a system state restore of a domain controller while AD
DS is stopped. To perform a system state restore of a DC, you must start the server
in DSRM.
You can start or stop AD DS by following these steps:
1.                  Open Server Manager by clicking the related tile on the Start screen. Or
click the Server Manager icon on the taskbar.
2.                  You should now see a complete list of services installed on the system. By
default, this list is organized by service name.
3.                  Right-click Active Directory Domain Services and then click Start or Stop
as appropriate. You can also choose Restart to have Windows stop and then start the
service after a brief pause.
Server services that depend on AD DS to function shut down before AD DS shuts down.
This means the following services stop when you stop AD DS:
Distributed File System (DFS) Replication
DNS Server
Intersite Messaging
Kerberos Key Distribution Center (KDC)
Other services that are running on the server and that do not depend on AD DS to
function, remain available to satisfy client requests while AD DS is stopped.
A domain controller with AD DS stopped is in a unique state that has some characteristics
of both a domain controller and a domain-joined member server. As when you are
working in DSRM, the AD DS database (Ntds.dit) on the server is offline. However,
unlike DSRM, the server continues to be joined to the domain as with a member server. If
another domain controller can be contacted, users can continue to log on to the domain
and you can log on to the server using your domain credentials. However, in the default
configuration, if no other domain controller can be contacted to service the logon requests
and you need to log on, you must either logon locally in DSRM by using the DSRM
password or restart the domain controller in order to log on with a domain account.

Real World  To prevent you from inadvertently getting locked out of domain
controller to which you have stopped AD DS, you can change the default by
modifying the DsrmAdminLogonBehavior registry entry. By modifying the related
value, you can permit log on using the restore mode Administrator account in
normal startup mode to a domain controller that has AD DS stopped even if no other
domain controller is available. The registry entry is under
HKLM\System\CurrentControlSet\Control\Lsa. When you modify
DsrmAdminLogonBehavior, set a value of 1 to allow log on when AD DS is
stopped. Alternatively, set a value of 0 to only allow logon with a domain account
(the default behavior).


Setting the Functional Level of Domains and Forests
As discussed in “Establishing Functional Levels” in Chapter 2, “Installing New Forests,
Domain Trees, and Child Domains,” each forest and each domain within a forest can be
assigned a functional level. Functional levels affect the inner workings of Active Directory
and are used to enable features that are compatible with the installed server versions of the
Windows operating system. For example, with the domain functional level set as Windows
Server 2012, the domain can use only domain controllers running Windows Server 2012
or later.
You lower or raise the domain or forest functional level by using Active Directory
Domains and Trusts. As discussed in “Establishing Functional Levels” in Chapter 2,
lowering the forest or domain functional level is subject to specific constraints. Because
raising the forest functional level may require you to raise the functional level of domains,
you should predetermine the steps you need to take to raise the forest functional level. To
determine the steps you need to take to raise the forest functional level, follow these steps:
1.                  On theTools menu in Server Manager, click Active Directory Domains
And Trusts.
2.                  Right-click the Active Directory Domains And Trusts node in the console
tree, and then click Raise Forest Functional Level. The current forest name and
functional level appear in the Raise Forest Functional Level dialog box.
3.                  Click Save As in the Raise Forest Functional Level dialog box. When you
click Save As, a Save As dialog box appears, allowing you to select a save location
for a log file. The log file details show the following information:
The forest root domain and the current forest functional level.
The domains and the domain controllers in those domains that are running earlier
versions of Windows Server. These are the servers that need to be upgraded.
The domain functional level of each domain for which the functional level must be
raised. Raising the forest functional level raises the domain functional level in all
the domains to that level and sets the forest functional level to that level.
To raise the functional level of a domain, follow these steps:
1.                  On theTools menu in Server Manager, click Active Directory Domains
And Trusts.
2.                  In the console tree, right-click the domain you want to work with, and then
select Raise Domain Functional Level. The current domain name and functional
level appear in the Raise Domain Functional Level dialog box.
3.                  To change the domain functionality, select the new domain functional level
in the selection list provided, and then click Raise.
4.                  When you click OK, the new domain functional level is replicated to each
domain controller in the domain. This operation can take several minutes or longer
in a large organization.
To raise the functional level of a forest, follow these steps:
1.                  On the Tools menu in Server Manager, click Active Directory Domains

And Trusts.
2.                  Right-click the Active Directory Domains And Trusts node in the console
tree, and then click Raise Forest Functional Level. The current forest name and
functional level appear in the Raise Forest Functional Level dialog box.
3.                  To change the forest functional level, select the new forest functional level
in the selection list provided, and then click Raise.
4.                  When you click OK, the new forest functional level is replicated to each
domain controller in each domain in the forest. This operation can take several
minutes or longer in a large organization.
While you can raise the domain or forest functional level using the graphical tools, you
must use Windows PowerShell to lower the functional level. Use Get-ADDomain and
Get-ADForest to get information about domains and forest, including the fully qualified
name of a domain or forest. Use Set-ADDomainMode to raise or lower the domain
functional level. Use Set-ADForestMode to raise or lower the forest functional level.
The basic syntax for setting the domain functional level is:
Set-ADDomainMode -Identity DomainName -DomainMode NewMode
Here, DomainName is the fully qualified name of the domain you want to work with and
NewMode is the desired operating level. Valid operating levels include
Windows2008Domain, Windows2008R2Domain, Windows2012Domain and
Windows2012R2Domain.
Thus, if the current domain functional level is Windows Server 2012 R2, you could lower
the domain functional level in the ImaginedLands.local domain to Windows Server 2012
by using the following command:
Set-ADDomainMode –Identity imaginedlands.local
–DomainMode Windows2012Domain
The basic syntax for setting the forest functional level is:
Set-ADForestMode -Identity ForestName -ForestMode NewMode
Here, ForestName is the fully qualified name of the forest you want to work with and
NewMode is the desired operating level. Valid operating levels include
Windows2008Forest, Windows2008R2Forest, Windows2012Forest and
Windows2012R2Forest.
Thus, if the current forest functional level is Windows Server 2012 R2, you could lower
the forest functional level in the ImaginedLands.local forest to Windows Server 2012 by
using the following command:
Set-ADForestMode –Identity ImaginedLands.local
–ForestMode Windows2012Forest
As a best practice, you may want to ensure that you are working directly with the schema
master for the forest before changing the forest functional level. The easiest way to do this
is to get the forest context using the following command:
$forest = get-adforest
Here, you get the forest object for the current logon forest and store it in the $forest

variable. After you get the forest object, you can set the forest functional level and specify
that the server you want to work with is the schema master by using the following
command:
Set-ADForestMode -Identity $forest -server $forest.SchemaMaster
-ForestMode Windows2012Forest


Configuring the Windows Time Service
As discussed in Chapter 8, “Managing Trusts and Authentication,” Windows uses
Kerberos version 5 (v5) as the primary authentication mechanism. With Kerberos
authentication, computers must have their time closely synchronized in order to be
properly authenticated. By default, the maximum allowed time difference is 5 minutes. If
the time difference is greater than this value, authentication will fail.
Although you could extend the allowable time difference through domain security policy
by using the Kerberos policy Maximum Tolerance For Computer Clock Synchronization,
doing so doesn’t get to the root cause of the time divergence. Whether computers are in a
domain or workgroup setting, the root cause of time divergence is a lack of time
synchronization, and this is why the Windows Time service (W32time) is essential for
proper operations.
The Windows Time service ensures that all computers running current versions of
Windows and Windows Server use a common time. To do this, the service synchronizes
the date and time using Network Time Protocol (NTP) and time providers. When you
deploy your forest root domain, you’ll need to configure the Windows Time service as
appropriate for your organization. Thereafter, the Windows Time service requires little
ongoing management. However, as you expand your network, you might find that you
need to modify the time services configuration to make it more efficient.

Understanding Windows Time
Keeping a computer synchronized with world time isn’t easy. System clocks can lose time,
users can accidentally set the system clock to the wrong time, and other things can also go
wrong. To help resolve problems with system time and time synchronization, Windows
uses Windows Time service to set a consistent time based on world time.
Windows Time service allows synchronization within 100 milliseconds of world time.
Windows Time service uses the Network Time Protocol (NTP) to poll the authoritative
time server. The global settings MinPollInterval and MaxPollInterval control the exact
rates. If time between the time server and the system differs, the Windows Time service
slowly corrects the time. The global settings UpdateInterval and FrequencyCorrectRate
control the exact correction rate.
Computers that are not joined to a domain and are running Windows synchronize time
with an authoritative, external time source. The default time sources are
time.windows.com, time.nist.gov, time-nw.nist.gov, time-a.nist.gov, and time-b.nist.gov.
Windows computers that are joined to a domain synchronize time with an authoritative
time source in the parent domain. The default method of synchronizing time is through the
domain hierarchy, in which a client connects to a domain controller in its domain as its
time source, and domain controllers in turn get their time from the authoritative time
source for the Windows forest. If no domain controller is specifically configured as the
authoritative time source in the forest root domain, the domain controller that holds the
PDC emulator operations master role is the authoritative time server. The PDC emulator
uses its internal clock to provide time to domain controllers throughout the forest.
Tip  Because the PDC emulator is the default time source for a forest, you should
ensure this domain controller is highly available. If you find that the PDC emulator
is overloaded, you might want to make another domain controller the authoritative
time source for the forest.
The authoritative time source at the root of a forest acquires its time either by connecting
to an installed hardware clock device on the internal network or by connecting to an
external time server, which is itself connected to a hardware clock device. Note that if you
do not configure the authoritative time server to synchronize time from an external or
internal time source, the PDC emulator uses its internal clock and is itself the reliable time
source for the forest.
Although a hardware clock, such as a radio or Global Positioning System (GPS) device, is
more secure and offers the highest accuracy, you must purchase, install, and maintain the
hardware clock. In contrast, when the authoritative time server synchronizes with an
external time server, you have good accuracy, and your only cost typically is limited to the
cost of network bandwidth used. However, NTP synchronization with an external time
source is not authenticated and is therefore less secure than if the time source is inside the
network.
Tip  All NTP servers need access to UDP port 123. This port must be open for
inbound and outbound traffic in order for the Windows Time service to function
properly.

Working with W32tm
You can configure settings for the Windows Time service by using the W32tm command-
line tool or Group Policy. You can also use W32tm to monitor and troubleshoot the
Windows Time service. I’ll detail the parameters used with this tool later; let’s look at the
basics now.
You run W32tm at an elevated command prompt. W32tm works with the local computer
by default. You enter w32tm /register at a command prompt to register the time service to
run as a service and add the default configuration to the registry. You enter w32tm
/unregister to unregister the time service and remove all configuration information from
the registry.
To instruct Windows Time service running on the specified computer to resynchronize its
clock and discard accumulated error statistics, you can use the /resync parameter. The
basic syntax is as follows.
w32tm /resync [/computer:Computer] [/nowait] [/rediscover]
Here, Computer specifies the computer on which you want to resynchronize time services.
If you don’t specify a computer, the local computer will resynchronize its time. Use
/nowait to have the command return immediately, without waiting for the
resynchronization to complete before returning. Use /rediscover to redetect the network
configuration and rediscover network sources, and then resynchronize the time.
To monitor time services in a specified domain or for specified computers, or both, you
can use the /monitor parameter. The basic syntax is as follows.
w32tm /monitor [/domain: DomainName] [/computers:Computer1,Computer2,…ComputerN] [/threads:N]
Here, DomainName is the DNS name of the domain to monitor, and computer names are
specified by DNS names or IP addresses. If you don’t specify a domain or computers to
monitor, the current logon domain is used. Be sure to separate computer names by
commas, with no spaces. The /threads parameter specifies the number of computers to
analyze simultaneously. The default value is 3; the allowed range is 1 to 50.
As part of troubleshooting, you might want to determine the difference between the local
computer time and the time on another computer. You can do this by using the /stripchart
parameter. You use the /stripchart parameter with the /dataonly parameter to display only
the data, without graphics. The basic syntax is as follows.
w32tm /stripchart /computer:TargetComputer [/period:RefreshTime] 
[/dataonly] [/samples:Count]
Here, TargetComputer is the designated target computer, RefreshTime sets the time
between samples, and Count sets the number of samples to take. The default time between
samples is 2 seconds. Additionally, if you don’t set a sample count, samples will be
collected until you press Ctrl+C.
To modify the Windows Time service configuration on a target computer, you can use the
/config parameter. With this parameter, you use the /update parameter to notify the time
service that the configuration has changed, which causes the changes to take effect. You
use /reliable:Yes to designate the computer as the reliable time source or /reliable:No to
designate the computer as an unreliable time source. Optionally, you can use the

/manualpeerlist parameter to specify a manual peer list to use as a space-delimited list of
DNS addresses or IP addresses or both. When specifying multiple peers, enclose each
value in quote marks.
The syntax for modifying the time service’s configuration is as follows.
w32tm /config [/computer:TargetComputer] [/update] [/manualpeerlist:Peers] [/syncfromflags:Flag] [/reliable:(Yes|No)]
Here, TargetComputer is the computer on which you want to change the configuration of
time services, Peers lists the manual peers, and Flag sets the desired synchronization state.
If you don’t specify a target computer, the default is the local computer. For the
/syncfromflags parameter, enter a value of manual when you want the computer to
synchronize with peers in the manual peer list. Otherwise, enter a value of domhier when
you want the computer to synchronize from a domain controller in the domain hierarchy.

Checking the Windows Time Configuration
You use the W32tm command-line tool to configure Windows Time service. To determine
whether the computer is configured to synchronize time from the domain or from a
manual list of time servers, enter the command w32tm /query /configuration at an
elevated, administrator command prompt.
In the command output, the Type field identifies the time synchronization method that the
client is using. Values you may see include:
NoSync Indicates that the client does not synchronize time.
NTP Indicates that the client synchronizes time from an external time source, and
the NtpServer field identifies this time source.
NT5DS Indicates that the client is configured to use the domain hierarchy for its
time synchronization.
AllSync Indicates that the client synchronizes time from any available time source,
including domain hierarchy and external time sources.
You can display the time difference between the local computer and a designated time
source by entering the following command at an elevated, administrator command prompt.
w32tm /stripchart /computer:TimeServer /samples:N /dataonly
Here, TimeServer sets the Domain Name System (DNS) name or IP address of the time
server that you are comparing the local computer’s time against, such as
time.windows.com or time-nw.nist.gov, and N sets the number of time samples to return.
The /stripchart parameter tells W32tm to display the offset between synchronizing
computers. This means the results will show the local time and the offset from the
designated time server’s time.
In Sample 9-1, you compare the local computer’s time to the time on the
time.windows.com time server.
w32tm /stripchart /computer:time.windows.com /samples:5 /dataonly
SAMPLE 9-1 Positive time offset example.
Tracking time.windows.com [207.46.232.182:123].
Collecting 5 samples.
The current time is 9/29/2015 3:12:24 PM.
15:12:24, +16.3861888s
15:12:27, +16.3752471s
15:12:29, +16.3870691s
15:12:31, +16.3837546s
15:12:33, +16.3791971s
The output shows the local time is about 16 seconds ahead of time on the time server. If
the time is behind, you see a minus sign instead of a plus sign in the offset value. In
Sample 9-2, the query on a different computer shows the local time is about 17 seconds
behind time on the time server.
SAMPLE 9-2 Negative time offset example.
Tracking time.windows.com [207.46.232.182:123].
Collecting 5 samples.
The current time is 9/29/2015 3:08:39 PM.

15:48:39, -17.5644882s
15:48:41, -17.5617493s
15:48:43, -17.5483586s
15:48:45, -17.5705189s
15:48:47, -17.5677411s
Before you configure the Windows Time service on any computer, you can use this
technique as a basic way to test NTP communications. If the query fails, check the System
event log for W32time errors and then refer to the details provided in the More Info link to
resolve the problem. If a firewall is blocking access to the Internet time server, you’ll need
to ensure UDP port 123 is open for outbound and inbound traffic on all routers and
firewalls between your authoritative time server and the Internet.

Configuring an Authoritative Time Source
You can configure a domain controller as the authoritative time source and specify the
external time sources it should use with W32tm. After you log on or remotely access the
domain controller, enter the following command at an elevated command prompt.
w32tm /config /manualpeerlist:Peers /syncfromflags:Manual 
/reliable:Yes /update
Here, you use the /manualpeerlist:Peers option to set the external time servers to use for
synchronization, /syncfromflags:Manual to specify that the server will synchronize with
the manual peer list, /reliable:Yes to specify that the server is the authoritative time server,
and /update option to confirm that you want to update the configuration.
When you specify multiple external peers, you use a space as the delimiter and enclose the
names of the peers in quotation marks. In the following example, you set the external time
servers as time.windows.com, time.nist.gov, and time-nw.nist.gov.
w32tm /config /manualpeerlist: “time.windows.com” “time.nist.gov” 
“time-nw.nist.gov” /syncfromflags:Manual /reliable:Yes /update
You also could get time from pool.ntp.org as shown in the following example:
w32tm /config /computer:dc05.cpandl.com /manualpeerlist:
0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org,3.pool.ntp.org
/syncfromflags:manual /update
You should then synchronize time with an external time server by entering w32tm /config
/update at an elevated command prompt. After you configure the authoritative time server
for the forest, you can log on to a client computer in the forest root domain and check the
time service performance by running w32tm /stripchart, with the authoritative time
server as the computer target in the command. For example, if
corpserver65.imaginedlands.com is the authoritative time server, you enter the following.
w32tm /stripchart /computer: corpserver65.imaginedlands.com /samples:5 /dataonly
Once you configure another authoritative time server and confirm this designation, you
can remove the designation from the PDC emulator. Log on or remotely access the PDC
emulator and then enter the following command at an elevated command prompt.
w32tm /config /syncfromflags:Domhier /reliable:No /update
Here, the /syncfromflags:Domhier option specifies that the PDC emulator’s time will be
synchronized with the nearest time source in the domain hierarchy, and /reliable:No
removes the PDC emulator’s status as the reliable time source. You should then attempt to
synchronize time with the new authoritative time server by entering w32tm /config
/update at an elevated command prompt. Because the PDC emulator is in the forest root
domain, it will synchronize with a reliable time source in the forest root domain.

Troubleshooting Windows Time Services
Computers that are not joined to a domain may not synchronize time automatically. You
can configure these computers to request time from a particular time source, such as a
domain controller in a domain. To do this, you must designate a manual time source for
the client computer. Enter the command w32tm /config /manualpeerlist:Peers
/syncfromflags:Manual /update where Peers is the DNS name or IP address of the
domain controller to use as the time source. Next, stop and then start the W32time service
by entering net stop w32time and then entering net start w32time.
If a computer has been manually configured to synchronize from a specific time source
and you later want the computer to get its time automatically, you must reconfigure the
computer to begin sourcing its time from the domain hierarchy. To do this, log on to the
computer and enter the w32tm /config /syncfromflags:Domhier /update command at an
elevated command prompt. Next, stop and then start the W32time service by entering net
stop w32time and then entering net start w32time at an elevated command prompt.
If you are experiencing problems with the Windows Time service on a client computer, the
easiest way to resolve the problem may be to reset the service to its default settings. To
restore the local computer’s Windows Time service to the default settings, do the
following:
1.                  Open an elevated command prompt.
2.                  Stop the W32time service by entering net stop w32time.
3.                  Remove the current W32time service settings by entering w32tm
/unregister.
4.                  Register the W32time service to use the default settings by entering
w32tm /register.
5.                  Start the W32time service by entering net start w32time.

Configuring Windows Time Settings in Group Policy
In Group Policy, several policy settings allow you to optimize the way Windows Time
service is used. Key policy settings are found under Computer
Configuration\Administrative Templates\System\Windows Time Service\Time Providers.
These settings include:
Enable Windows NTP Client When this setting is enabled, this computer can act
as an NTP client and synchronize its clock with designated NTP servers.
Enable Windows NTP Server When this setting is enabled, this computer can act
as an NTP server and can service NTP requests from NTP clients.
Configure Windows NTP Client When you enable this setting, you can set the
Windows Time configuration options for clients. Table 9-1 summarizes the available
configuration options.

TABLE 9-1 Configuration Settings for Windows NTP Clients
CrossSiteSyncFlags
Determines whether the service chooses synchronization partners outside the
domain of the computer. The options and values are 0 (none), 1 (PDC emulator
only), or 2 (all). This value is ignored if the NT5DS value is not set. The default
value for domain members is 2. The default value for stand-alone clients and
servers is 2.
EventLogFlags
Sets the events logged by the Windows Time service.
NtpServer
The peer from which a computer obtains time stamps, consisting of a DNS name or
IP address, followed by a comma and a type indicator. The type indicator can be a
combination of the following values: 0x1 (special interval), 0x2 (use as fallback
only), 0x4 (symmetrical active), and 0x8 (client). There is no default value for this
option on domain members. The default value on stand-alone clients and servers is
time.microsoft.com,0x1. The default value on the authoritative time server is
time.microsoft.com,0x9.
ResolvePeerBackOffMaxTimes
Sets the maximum number of times to double the wait interval when repeated
attempts to locate a peer with which to synchronize fail. A value of 0 means that the
wait interval is always the minimum. The default value on domain members is 7.
The default value on stand-alone clients and servers is 7.
ResolvePeerBackOffMinutes
Sets the initial interval to wait, in minutes, before attempting to locate a peer to
synchronize with. The default value on domain members is 15. The default value
on stand-alone clients and servers is 15.
SpecialPollInterval
Sets the special poll interval in seconds for manual peers. When the
SpecialPollInterval 0x1 flag is enabled for NtpServer, W32time uses this poll
interval instead of a poll interval set by the operating system. The default value on
domain members is 3,600. The default value on stand-alone clients and servers is
604,800.
Type
Indicates which peers to accept synchronization from. NoSync specifies that the
time service does not synchronize with other sources. NTP specifies that the time
service synchronizes from the servers specified in the NtpServer registry entry.
NT5DS specifies that the time service synchronizes from the domain hierarchy.
AllSync specifies that the time service uses all the available synchronization
mechanisms. The default value on domain members is NT5DS. The default value
on stand-alone clients and servers is NTP.
You can also configure global time services options. Table 9-2 provides detailed
information on the most used global settings for the Windows Time service. The related
Group Policy settings are under Computer Configuration\Administrative
Templates\System\Windows Time Service\Global Configuration Settings. If the Global
Configuration Settings policy is enabled, its settings take precedence over local registry
settings. The related registry settings are under
HKLM\SYSTEM\CurrentControlSet\Services\W32Time\Config. If you change the time
services configuration, you can apply the changes by entering the following command at
the command prompt.
w32tm /config /update

TABLE 9-2 Global Configuration Settings for Windows Time Services
AnnounceFlags
Sets the time server classification. A computer must be classified first as a time server to
be subsequently classified as a reliable time server. This is why the default flag is 10
(meaning flags 2 and 8 are applied). This setting is used only by domain controllers and
determines how the time service is advertised by the Net Logon service. Default value: 10
(8 + 2).
 
Accepted values: 10 (default with 8 + 2 flags). 0; the domain controller doesn’t advertise
time service. 1; the domain controller always advertises time service. 2; the domain
controller is a time server and automatically determines whether it should advertise time
service. 4; the domain controller will always advertise reliable time service. 8; the domain
controller is a reliable time server and automatically determines whether it should
advertise time service.
EventLogFlags
Determines the types of events that the time service logs. Default value: 2.
 
Accepted values: 1; logs when the time service must make a discontinuous change to the
clock. 2; logs when the time service chooses a new time source. 3; logs when the time
service hasn’t acquired time samples for a period of 1.5 times the maximum poll interval
and no longer trusts local clock’s accuracy.
FrequencyCorrectRate
Modifies the rate at which the time service corrects (synchronizes) the system clock. The
value used is multiplied by the number of clock ticks in 64 seconds to come up with the
base gain used to correct system time. Generally, the smaller the value, the more
responsive the system is to time changes. However, if the value is too small, the system
time can change too frequently to be stable. A value of 3 to 5 is generally a stable range.
 
Accepted values: 4 (default).
HoldPeriod
Determines the number of seconds the last consistently read time sample is held. It is
essentially designed to prevent frequent time changes caused by inconsistent time
samples. During this period, time synchronization (as determined by the
FrequencyCorrectRate) and spike detection (for consistent time samples) are switched off
to allow for faster time correction (convergence).
 
Accepted values: 5 (default).
LargePhaseOffset
Determines the time offset, in milliseconds, that triggers direct setting of the system clock.
If the system clock is off by more than this amount, system time is set directly to the
appropriate time rather than using time correction (convergence). Set the offset to a higher
value to reduce the likelihood that the system time will be set directly. However, if you do
this, it is more likely that bad time samples will be considered good.
 
Accepted values: 128,000 (default).
LocalClockDispersion
Indicates the relative reliability of the local CMOS clock when it’s used as a time source
for other computers but isn’t synchronized with another network time source. The
dispersion value is the number of seconds by which the time service should consider the
local CMOS clock to be off from the estimated true time at any given time. The higher the
reliability by which the local CMOS should be considered, the lower the dispersion value
should be set. If the clock is synchronized from a network time source, the dispersion
applies to that time source.

 
Accepted values: 10 (default).
MaxAllowedPhaseOffset
Specifies the maximum time correction allowed when convergence is used (rather than
direct time setting). If the system clock is off by more than this number of seconds, the
time is corrected over multiple convergence intervals. This value is designed to prevent
sudden large changes in time.
 
Accepted values: 300 (default for domain controllers); 1 (default for other computers).
MaxNegPhaseCorrection
Specifies the largest negative time correction the time service is allowed to make. If the
time is off by more than this amount, the required change is logged rather than corrected.
For example, if the clock is set to 5:00 P.M., but it is really 1:59 A.M. on the same day (an
earlier time), the required time change will be logged rather than corrected. An
administrator will then need to set the time manually. A smaller value is considered more
secure because it could prevent malicious time servers from changing system times
erroneously.
 
Accepted values: 54,000 (default).
MaxPollInterval
Determines the longest time interval to be used for checking the time. The value is set in
units of 2^n seconds, where n is the value for this setting. The default value is 2^15
(32,768 seconds). The Windows Time service will consider itself to be in an
unsynchronized state when 1.5 times the MaxPollInterval has elapsed and it is unable to
obtain a time reading from a reliable time server. This value is also referred to as the
maximum clock age. In NTP, the maximum clock age is 86,400 seconds. Thus, if you set
MaxPollInterval to a value greater than 15, the time server may be ignored completely by
peers.
 
Accepted values: 15 (default).
MaxPosPhaseCorrection
Specifies the largest positive time correction the time service is allowed to make. If the
time is off by more than this amount, the required change is logged rather than corrected.
For example, if the clock is set to 1:59 A.M., but it is really 5:00 P.M. on that same day (a
later time), the required time change will be logged rather than corrected. An
administrator will then need to set the time manually. A smaller value is considered more
secure because it could prevent malicious time servers from changing system times
erroneously.
 
Accepted values: 54,000 (default).
MinPollInterval
Determines the shortest time interval to be used for checking the time. The value is set in
units of 2^n seconds, where n is the value for this setting. The default value for DCs is
2^6 (64 seconds) because time synchronization is more important on DCs, and 2^10
(1,024 seconds) for other computers, to reduce the number of network accesses.
 
Accepted values: 6 (default for DCs); 10 (default for other computers).
PhaseCorrectionRate
Specifies the time correction interval in seconds. This is the interval for time correction
when convergence is used. With the default value, the time can be corrected once every
second.
 
Accepted values: 1 (default).

PollAdjustFactor
Sets an adjustment interval for polling the time. The value is set in units of 2^n seconds,
where n is the value for this setting.
 
Accepted values: 5 (default).
SpikeWatchPeriod
Sets the period in seconds during which suspicious time changes are watched before they
are accepted as valid. If you decrease this value, you allow the time server to correct time
spikes (sudden changes in time) quickly, but you also increase the likelihood that bad time
samples will be considered good.
 
Accepted values: 90 (default).
UpdateInterval
Determines the interval used for phase correction adjustments. The lower the value, the
more accurate the time. The higher the value, the more efficient the time sampling. Thus,
there is a tradeoff to be made between accuracy and efficiency. On DCs, you want more
accuracy and can use more system resources to maintain the system clock because clock
accuracy is very important. On other computers, you balance the need for efficiency
against the need for accuracy.
 
Accepted values: 100 (domain controllers); 30,000 (member servers); 360,000 (stand-
alone computers).
Using Group Policy, you can configure Windows Time in a domain by completing the
following steps:
1.                  On the Tools menu in Server Manager, click Group Policy Management.
In Group Policy Management, right-click the policy for the appropriate domain,
site, or OU, and then click Edit. This starts the Group Policy Management Editor.
2.                  If you want to configure global Windows Time settings, expand Computer
Configuration, Administrative Templates, System, and Windows Time Service.
Double-click Global Configuration Settings, and then select Enabled. Use the fields
available to set the desired global settings. Click OK when you are finished.
3.                  If you want to configure Windows NTP client settings, expand Computer
Configuration, Administrative Templates, System, Windows Time Service, and
Time Providers. Double-click Configure Windows NTP Client, and then select
Enabled. Use the fields available to set the default NTP settings, including the name
of the time server to use. Click OK when you are finished.


Backing Up and Recovering Active Directory
Two of the most critically important tasks you’ll perform as an administrator are backing
up and recovering Active Directory Domain Services. To perform backup and recovery,
you must install Windows Server Backup, a feature available for servers running Windows
Server. When you install this feature using the Add Feature Wizard in Server Manager,
you can run Windows Server Backup from the Administrative Tools menu and access the
Wbadmin utility at a command prompt.

Active Directory Backup and Recovery Essentials
In Windows Server, you can perform three types of backup:
A system state backup, which includes all the files that are required to recover AD
DS
A critical-volumes backup, which includes all the volumes that contain system state
files
A full server backup, which includes all volumes on the server
You can use Windows Server Backup to perform critical-volumes backups and full server
backups. You can use the Wbadmin tool at the command line to perform all types of
backup, including system state backup.
How often you back up Active Directory depends on the complexity and size of your
network. Generally, the more Active Directory objects and domain controllers you have,
the more frequently you should back up Active Directory. For example, if you have to
recover from the accidental deletion of an organizational unit (OU) by restoring the
domain from a backup, you will have to re-create all of the accounts that were created in
that OU since the backup was made. To avoid having to re-create accounts and potentially
reset large numbers of passwords, you should ensure that recent system state backups are
always available to recover related operations that were recently performed.
Real World  Computer accounts, including domain controller accounts, change
their passwords every 30 days by default. Rolling back the computer password of a
domain controller to a former state affects authentication and replication. Changes to
user passwords might also be lost as a result of domain controller failure. Because
no external record of these changes exists except in AD DS itself, you will find that
you need to manually reset computer and user account passwords. Therefore, the
more frequently you back up domain controllers, the fewer problems you will
encounter if you need to restore the directory. Generally, you will want to create
backups of each unique directory partition in the forest on two different computers
at least daily.
Domain controllers have replication partners with whom they share information. When
you have multiple domain controllers in a domain and one fails, the other domain
controllers automatically detect the failure and change their replication topology
accordingly. You can repair or replace the failed domain controller from a backup.
However, the restore doesn’t recover Active Directory information stored on the domain
controller.
To restore Active Directory on the failed domain controller, you use either a
nonauthoritative or authoritative approach. A nonauthoritative restore allows the domain
controller to come back online and then get replication updates from other domain
controllers. An authoritative restore makes the restored domain controller the authority in
the domain, and its data is replicated to other domain controllers.
In most cases, you’ll have multiple domain controllers in a domain, giving you flexibility
in your disaster-recovery plan. If one of the domain controllers fails, you can install a new
domain controller or promote an existing member server so that it can be a domain

controller. In either case, the directory on the new domain controller is updated
automatically through replication. You could also recover the failed domain controller and
then perform a nonauthoritative restore. In this case, you would restore Active Directory
on the domain controller and obtain directory updates from other domain controllers in the
domain.
In some cases, you might need to perform an authoritative restore of Active Directory. For
example, if a large number of objects are deleted from Active Directory, the only way to
recover those objects is to use an authoritative restore. In this case, you restore Active
Directory on a domain controller and use the recovered data as the master copy of the
directory database. This data is then replicated to all other domain controllers.
Real World  When objects have group memberships, recovering the object requires not
only restoring the object itself but also restoring group memberships. Group membership
is defined by linked attributes on the group object and on the group member object. The
member attribute of the group object is a forward link attribute that links to the
memberOf attribute of the group member, which can be a user, a computer, or another
group.
If you restore a domain controller that is not a global catalog server, only group
memberships for groups that are stored in the domain are restored. If you perform the
restore on a global catalog server, group memberships in universal groups that are stored
in other domains in the forest are also restored. However, restoring memberships in
domain local groups that are stored in other domains may require additional recovery
steps. (For more information, see the section “Performing an Authoritative Restore of
Active Directory” later in this chapter.)
The disaster-recovery strategy you choose for Active Directory might depend on whether
you have dedicated or nondedicated domain controllers. When you have dedicated domain
controllers that perform no other domain services, you can implement a very simple
disaster-recovery procedure for domain controllers. As long as you have multiple domain
controllers in each domain, you can restore a failed domain controller by installing a new
domain controller and then populating the directory on this new domain controller. You
can do so through replication or by recovering the domain controller by using a
nonauthoritative restore. You should always back up one or more of the domain
controllers, including their system state, so that you always have a current snapshot of
Active Directory in the backup archives. If you need to recover from a disaster that has
caused all your domain controllers to fail, or if Active Directory has been corrupted, you
can recover using an authoritative restore in Directory Services Restore Mode.
When you have nondedicated domain controllers, you should back up the system state
whenever you perform a full backup of a domain controller. This stores a snapshot of
Active Directory along with the other pertinent system information that can be used to
fully recover the domain controller. If a domain controller fails, you can recover it the way
you recover any server. You then have the option of restoring the system state data and
Active Directory to allow the server to resume operating as a domain controller, by using a
nonauthoritative restore in Directory Services Restore Mode. If you need to recover from
a disaster that has caused all your domain controllers to fail, or if Active Directory has
been corrupted, you also have the option of using an authoritative restore.

Real World  When planning backups of Active Directory, you should remember
the tombstone lifetime. Active Directory doesn’t actually delete objects when you
remove them from the directory. Instead, objects are tombstoned (marked for
deletion), and the tombstone is replicated to all the other domain controllers. By
default, the tombstone lifetime is 180 days, meaning that a tombstone will remain in
the directory for 180 days before it is deleted. To ensure that you don’t accidentally
restore objects that have actually been removed from Active Directory, you are
prevented from restoring Active Directory if the backup archive is older than the
tombstone lifetime. This means that, by default, you cannot restore a backup of
Active Directory that is older than 180 days.

Backing Up and Restoring the System State
With Wbadmin, you can use the Start SystemStateBackup command to create a backup of
the system state and the Start SystemStateRecovery command to restore the system state.
You must be in the Directory Services Restore Mode to restore the system state on a
domain controller.
Whenever you make major changes to the directory environment, you should create a new
system state backup. You can back up a server’s system state by entering the following at
an elevated command prompt.
wbadmin start systemstatebackup -backupTarget:VolumeName
Here, VolumeName is the storage location for the backup, such as X:. By default, the target
volume for a system state backup cannot be the same as a source volume that has files that
are included in the backup. Therefore, the target volume cannot be any volume that hosts
the operating system, the Ntds.dit file, Ntds log files, or the SYSVOL directory.
Real World  You can change the target restriction on source volumes by adding the
AllowSSBToAnyVolume registry entry to the server under
HKLM\SYSTEM\CurrentControlSet\Services\wbengine\SystemStateBackup in the
registry. The value type should be set as DWORD. A value of 0 prevents the storing
of system state backups on a source volume. A value of 1 allows the storing of
system state backups on a source volume. Keep in mind, however, that a backup to
the source volume might not work, because the backup can be modified during the
backup process.
You can restore a server’s system state by entering the following at an elevated command
prompt.
wbadmin start systemstaterecovery -backupTarget:VolumeName
Here, VolumeName is the storage location that contains the backup you want to recover,
such as X:.
You can use other parameters to manage recovery operations as well. Use the -
recoveryTarget parameter to restore to an alternate location. Use the -machine parameter
to specify the name of the computer to recover if the original backup location contains
backups for multiple computers. Use the -authorSysvol parameter to perform an
authoritative restore of the SYSVOL.
The system state contains other system information besides Active Directory. Therefore,
any restore of Active Directory includes all that information, and that information will be
restored to its previous state as well. If a server’s configuration has changed since the
backup, the configuration changes will be lost.
Note  A system state backup and recovery includes Active Directory–integrated
Domain Name System (DNS) zones but does not include file-based DNS zones. To
back up and restore file-based DNS zones, you should back up and recover the
entire volume that hosts the files.

Performing a Nonauthoritative Restore of Active Directory
When a domain controller fails, you can restore it the way you restore any other server,
except when it comes to Active Directory. With this in mind, first fix the problem that
caused the server to fail. After you’ve restored the server, you can then work to restore
Active Directory.
You recover Active Directory by restoring the system state on the domain controller, using
Directory Services Restore Mode. If you have made changes to Active Directory since the
backup, the system state backup will not contain those changes. However, other domain
controllers in the domain will have the most recent changes, and the domain controller
will be able to obtain those changes through the normal replication process.
When you want to restore Active Directory on a domain controller and have the domain
controller get directory updates from other domain controllers, you perform a
nonauthoritative restore. A nonauthoritative restore allows the domain controller to come
back online and then get replication updates from other domain controllers.
Schedule a full server backup of a domain controller to ensure recovery of the server
operating system and application data in the event of a hardware failure. Schedule a
separate backup of critical volumes to ensure timely recovery of Active Directory. To
guard against unforeseen issues, schedule backups on at least two different domain
controllers for each domain, and schedule additional backups on any domain controller
with a unique application partition.
A full server backup is a backup of every volume on the server. You can use this type of
backup to recover a domain controller onto new hardware. On a domain controller, critical
volumes include the boot volume and the volumes that contain operating system files,
Active Directory database and log files, and the SYSVOL folders.
You can use critical-volume backups to restore Active Directory on a domain controller.
Critical-volume backups can also be restored and copied to transferrable media to install a
new domain controller in the same domain.
The procedure to perform a full server or critical-volume recovery of a domain controller
is the same as for any server. When you do this, you will also be performing a
nonauthoritative restore of Active Directory. After the recovery is complete, restart the
domain controller in the standard operations mode and then verify the installation. When
you restart the domain controller, Active Directory automatically detects that it has been
recovered from a backup. Active Directory will then perform an integrity check and will
re-index the database. From that point on, the server can act as a domain controller, and it
has a directory database that is current as of the date of the backup. The domain controller
then connects to its replication partners and begins updating the database so that any
changes since the backup are reflected.
After you log on to the server, check Active Directory and verify that all of the objects that
were present in the directory at the time of the backup are restored. The easiest way to
confirm this is to browse Active Directory Users And Computers, Active Directory
Domains And Trusts, and Active Directory Sites And Services.

Performing an Authoritative Restore of Active Directory
An authoritative restore is used when you need to recover Active Directory to a specific
point in time and then replicate the restored data to all other domain controllers. Consider
the following example: someone accidentally deleted the Marketing organizational unit
(OU) and all the objects it contained. Because the changes have already been replicated to
all domain controllers in the domain and Active Directory Recycle Bin is not enabled, the
only way to restore the OU and the related objects would be to use an authoritative restore.
Similarly, if Active Directory were somehow corrupted, the only way to recover Active
Directory fully would be to use an authoritative restore.
When performing authoritative restores, you should consider several significant issues.
The first and most important issue has to do with passwords used for computers. These
passwords are changed automatically every 7 days. If you perform an authoritative restore
of Active Directory, the restored data will contain the passwords that were in use when the
backup archive was made. If you monitor the event logs after the restore, you might see
related events, or you might hear from users who are experiencing problems accessing
resources in the domain.
Computer account passwords allow computers to authenticate themselves in a domain
using a computer trust. If a computer password has changed, the computer may not be able
to reauthenticate itself in the domain. In this case, you may need to reset the computer
account password by right-clicking on the computer account in Active Directory Users
And Computers, and then selecting Reset Account. If the password doesn’t reset, you
might need to remove the computer account from the domain and then add it back.
Another significant issue you should consider when performing an authoritative restore
has to do with group membership. After an authoritative restore, problems with group
membership can occur for several reasons.
In the first case, an administrator might have updated a group object’s membership on a
domain controller that has not yet received the restored data. Because of this, the domain
controller might replicate the changes to other domain controllers, causing a temporary
inconsistency. The changes shouldn’t be permanent, however, because when you perform
an authoritative restore, the update sequence number (USN) of all restored objects is
incremented by 100,000. This ensures that the restored data is authoritative and overwrites
any existing data.
Another problem with group membership can occur if group objects contain user accounts
that do not currently exist in the domain. In this case, if group objects are replicated before
these user objects are, the user accounts that do not currently exist in the domain will be
seen as invalid user accounts. As a result, the user accounts will be deleted as group
members. When the user accounts are later replicated, the user accounts will not be added
back to the groups.
Although there is no way to control which objects are replicated first, there is a way to
correct this problem. You must force the domain controller to replicate the group
membership list along with the group object. You can do this by creating a temporary user
account and adding it to each group that contains user accounts that are currently not valid
in the domain. Here’s how this would work: You authoritatively restore and then restart

the domain controller. The domain controller begins replicating its data to other domain
controllers. When this initial replication process finishes, you create a temporary user
account and add it to the requisite groups. The group membership list will then be
replicated. If any domain controller has removed previously invalid user accounts as
members of these groups, the domain controller will return the user accounts to the group.
Global catalog servers are best suited for recovering group memberships after an
authoritative restore. If possible, you should perform the authoritative restore on a global
catalog server in the domain where the objects were deleted, to recover security principals
and group memberships. Global catalog servers store a single, writeable domain partition
replica and a partial, read-only replica of all other domains in the forest. A partial replica
means that the global catalog stores all objects, but with a limited set of attributes on each
object.
Specifically, global catalog servers can restore global group memberships for the recovery
domain and recover universal group memberships for all domains in the forest. Although
memberships in domain local groups in the recovery domain are restored automatically
during an authoritative restore, the global catalog does not store the member attribute for
domain local group objects from other domains. Therefore, for restored security principals
that have memberships in domain local groups in other domains, you must recover these
memberships by using the files that Ntdsutil generates during an authoritative restore.
Specifically, you must use the .txt file that Ntdsutil generates during an authoritative
restore to generate an .ldf file in each additional domain that has groups in which restored
security principals have memberships.
Tip  Keep in mind that if you can isolate a domain controller (or preferably a
global catalog server) in the domain where the deletion occurred, before the server
receives replication of the deletion, you might be able to avoid performing a restore
from a backup and having to extend the restore process to other domains. To do so,
you restart the domain controller in Directory Services Restore Mode and then
perform an authoritative restore to recover only the deletions.
To perform an authoritative restore, you’ll either need to stop AD DS as discussed in
“Stopping Active Directory Domain Services” in Chapter 3 or start the domain controller
in Directory Services Restore Mode as discussed in “Restarting a Domain Controller in
Directory Services Restore Mode” in Chapter 3. The latter approach requires you to know
the restore mode administrator password. If you don’t know or are uncertain what the
password is change it before you restart the domain controller in Directory Services
Restore Mode:
1. Open an elevated, administrator command prompt.
2. At the command prompt, enter ntdsutil.
3. At the ntdsutil prompt, enter set dsrm password.
4. At the Reset DSRM Administrator Password prompt, enter reset password on
server ServerName, where ServerName is the name of the domain controller on
which you want to reset the DSRM administrator password.
5. Enter the new restore mode administrator password.
6. Confirm the new restore mode administrator password by entering it again.

7. Enter quit twice to exit ntdsutil.
You can perform an authoritative restore by completing the following steps:
1.                  Perform a full server or critical-volume recovery of the domain controller.
After you’ve repaired or rebuilt the server, stop AD DS using the Service utility or
by entering net stop ntds at a command prompt. Alternatively, restart the server in
Directory Services Restore Mode. With DSRM, you must log on to the server by
using the local Administrator account, with the Directory Services Restore Mode
password.
2.                  Open an elevated command prompt. Next, at the command prompt, enter
ntdsutil. This starts the Directory Services Management Tool.
3.                  At the Ntdsutil prompt, enter authoritative restore. You should now be at
the Authoritative Restore prompt, where you have the following options:
You can authoritatively restore the entire Active Directory database by entering
restore database. If you restore the entire Active Directory database, a significant
amount of replication traffic will be generated throughout the domain and the forest.
You should restore the entire database only if Active Directory has been corrupted
or there is some other significant reason for doing so.
You can authoritatively restore a container and all its related objects (referred to as a
subtree) by entering restore subtree ObjectDN, where ObjectDN is the
distinguished name of the container to restore. For example, if someone
accidentally deleted the Marketing OU in the imaginedlands.com domain, you
could restore the OU and all the objects it contained by entering the command
restore subtree ou=marketing,dc=imaginedlands,dc=com.
You can authoritatively restore an individual object by entering restore object
ObjectDN, where ObjectDN is the distinguished name of the object to restore. For
example, if someone accidentally deleted the Sales group from the default container
for users and groups (cn=users) in the imaginedlands.com domain, you could
restore the group by entering the command restore object
cn=sales,cn=users,dc=imaginedlands,dc=com.
4.                  When you type a restore command and press Enter, the Authoritative
Restore Confirmation dialog box appears, which prompts you to click Yes if you’re
sure you want to perform the restore action. Click Yes to perform the restore
operation.
5.                  Enter quit twice to exit Ntdsutil, and then restart the server.
Note  Every object that is restored will have its USN incremented by 100,000.
When you are restoring the entire database, you cannot override this behavior, which
is necessary to ensure that the data is properly replicated. For subtree and object
restores, you can override this behavior by setting a different version increment
value, using the Verinc option. For example, if you wanted to restore the Sales group
in the imaginedlands.com domain and increment the USN by 500 rather than
100,000, you could do this by entering the command restore object
cn=sales,cn=users,dc=imaginedlands,dc=comverinc 500.

Restoring Sysvol Data
The Sysvol folder is backed up as part of the system state information and contains critical
domain information, including Group Policy objects, Group Policy templates, and scripts
used for startup, shutdown, logging on, and logging off. If you restore a domain controller,
the Sysvol data will be replicated from other domain controllers. Like Active Directory
data, Sysvol data is replicated using the Distributed File Service (DFS).
When you perform a nonauthoritative restore of a domain controller, the domain
controller’s Sysvol data is not set as the primary data. This means that the restored Sysvol
would not be replicated and could instead be overwritten by Sysvol data from other
domain controllers.
When you perform an authoritative restore of a domain controller, the domain controller’s
Sysvol data is set as the primary data for the domain. This means that the restored Sysvol
will be replicated to all other domain controllers. For example, if someone deletes several
scripts used for startup or logon, and there are no backups of these scripts, these can be
restored by performing an authoritative restore and allowing the restored, authoritative
domain controller’s Sysvol data to be replicated.
You can prevent a restored, authoritative domain controller’s Sysvol data from overwriting
the Sysvol on other domain controllers. To do this, you should back up the Sysvol in the
desired state on another domain controller before performing the authoritative restore.
After you complete the authoritative restore, you can restore the Sysvol in the desired state
to the authoritative domain controller.

Recovering by Installing a New Domain Controller
Sometimes you won’t be able to or won’t want to repair a failed domain controller and
may instead elect to install a new domain controller. You can install a new domain
controller by promoting an existing member server so that it is a domain controller or by
installing a new computer and then promoting it. Either way, the domain controller will
get its directory information from another domain controller.
Installing a new domain controller is the easy part. When you finish that, you need to
examine any roles that the failed server played. If the failed server was a global catalog
server, designate another domain controller as a global catalog server. (For information on
designating another server as a global catalog server, see Chapter 5, “Configuring,
Maintaining, and Troubleshooting Global Catalog Servers.”)
If the failed server held an operations master role, you will need to seize the role and give
it to another domain controller (as discussed in Chapter 6, “Configuring, Maintaining, and
Troubleshooting Operations Masters”). After seizing the operations master role, you will
need to remove the related data from Active Directory so that other computers in the
domain don’t try to connect to it anymore. You also need to remove references to the
server in DNS as well. (For more information, refer to the sections “Performing Forced
Removal of Domain Controllers” and “Cleaning Up Metadata in the Active Directory
Forest” in Chapter 3, “Deploying Writeable Domain Controllers”.)


Working with Active Directory Recycle Bin
Active Directory Recycle Bin is available when your Active Directory forest is operating
in the Windows Server 2008 R2 mode or higher. The Active Directory Recycle Bin adds
an easy-to-use recovery feature for Active Directory objects. With this feature enabled, all
link-valued and non-link-valued attributes of a deleted object are preserved, allowing you
to restore the object to the same state it was in before it was deleted.
You also can recover objects from the recycle bin without having to initiate an
authoritative restore. This differs substantially from the previously available technique,
which used an authoritative restore to recover deleted objects from the Deleted Objects
container. Previously, when you deleted an object, most of its non-link-valued attributes
were cleared and all of its link-valued attributes were removed, which meant that although
you could recover a deleted object, it was not restored to its previous state.

Getting Schema Ready for the Recycle Bin
To use Active Directory Recycle Bin, the forest must be using schema for Windows
Server 2008 R2 or later. As discussed in “Deploying Windows Server 2012 and R2,” you
can update schema using Adprep.exe as part of your preparations for deploying Windows
Server. When you update schema, every object in the forest is updated with the recycle bin
attributes as well. Keep in mind this process is irreversible once it is started.
After you prepare Active Directory schema, you need to upgrade all domain controllers in
your Active Directory forest to Windows Server 2008 R2 or later and then raise the
domain and forest functional levels to the Windows Server 2008 R2 level or higher. You’ll
then be able to enable and access the recycle bin. However, keep in mind, that once the
recycle bin has been enabled it cannot be disabled.
With the recycle bin enabled, when an Active Directory object is deleted, the object is put
in a state referred to as logically deleted, moved to the Deleted Objects container, and its
distinguished name is altered. A deleted object remains in the Deleted Objects container
for the period of time set in the deleted object lifetime value, which is 180 days by default.
When the deleted object lifetime expires, Active Directory tombstones the object (and the
process is the same as the legacy tombstone process). Here, Active Directory removes
most of the object’s attributes, changes the distinguished name so that the object name
cannot be recognized, and sets the object’s tombstoneLifetime attribute. The object is then
moved to a hidden Deleted Objects container where its deletion can be replicated to other
domain controllers.
The recycled object remains in the Deleted Objects container until the recycled object
lifetime expires and is said to be in the recycled state. The default recycled object lifetime
is 180 days. As with deletion without the Recycle Bin, Active Directory uses a garbage-
collection process to clear out tombstoned objects after the recycled object lifetime has
expired.
The msDS-deletedObjectLifetime attribute controls the deleted object lifetime. The
tombstoneLifetime attribute controls the recycled object lifetime.
Note  By default, the msDS-deletedObjectLifetime is set to $null, which means the
lifetime value comes from the tombstoneLifetime. If the tombstoneLifetime is also
set to $null, the default value is 180 days.
To determine or set the retention values for the forest, follow these steps:
1.                  On the Tools menu in Server Manager, click ADSI Edit.
2.                  In ADSI Edit, right-click ADSI Edit, and then click Connect To.
3.                  For Connection Point, click Select A Well Known Naming Context, and
then click Configuration.
4.                  If you want to connect to a specific domain controller, under Computer,
click Select Or Type A Domain Or Server. Enter the server name or the domain
name followed by a colon, and then enter the connection port. Port 389 is the
default for LDAP.
5.                  Click OK to connect to the naming context using the specified settings.

6.                  Navigate to the CN=Services\CN=Windows NT container.
7.                  Right-click CN=Directory Service, and then click Properties.
8.                  In the Attribute column, note the value in the Value column for the msDS-
deletedObjectLifetime and tombstoneLifetime attributes. If the values are <not
set>, the default value is in effect.
9.                  If you want to change the lifetime value, click the attribute to select it and
then click Edit. In the Integer Attribute Editor dialog box, enter the number of days
that a domain controller should preserve information about deleted objects, such as
240, and then click OK. Keep in mind that this value also defines the useful life of a
backup that you use for disaster recovery or for installation from backup media.

Enabling Active Directory Recycle Bin
Enabling the recycle bin is a forestwide change that requires an account that is a member
of Enterprise Admins. When you enable the recycle bin in one domain of a forest, Active
Directory replicates the change to all domain controllers in all domains of the forest,
ensuring each domain in the forest will have its own recycle bin.
To enable the recycle bin using Windows PowerShell, complete the following steps:
1.              Open an elevated, administrator PowerShell promot.
2.              At the PowerShell prompt, type the following command, and then press
ENTER:
Enable-ADOptionalFeature –Identity ‘CN=Recycle Bin
Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,
CN=Services,CN=Configuration,DC=yourdomain,DC=yourdomainsuffix’
–Scope ForestOrConfigurationSet –Target ‘ForestRootDomain’
Where DC=yourdomain,DC=yourdomainsuffix are set as appropriate for your
forest root domain and ForestRootDomain is the full name of the forest root
domain, such as:
Enable-ADOptionalFeature –Identity ‘CN=Recycle Bin
Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,
CN=Services,CN=Configuration,DC=imaginedlands,DC=.com’
–Scope ForestOrConfigurationSet –Target ‘imaginedlands.com’
You also can enable the recycle bin using Active Directory Administrative Center. To do
so, follow these steps:
1. In Active Directory Administrative Center, the local domain is opened for
management by default. To work with a different domain, click Manage and then
click Add Navigation Nodes. In the Add Navigation Nodes dialog box, select the
domain you want to work with and then click OK.
2. Select the domain you want to work with by clicking it in the left pane. In the
Tasks pane, click Enable Recycle Bin and then click OK in the confirmation
dialog box.
3. Once the change is replicated, the recycle bin will be available for use. If you then
click Refresh in Active Directory Administrative Center, you’ll see that a Deleted
Objects container is available for each domain you select.

Recovering Deleted Objects
You can recover deleted objects from the Deleted Objects container by using Active
Directory Administrative Center, Ldp.exe or the Active Directory cmdlets for Windows
PowerShell. Keep in mind that Active Directory blocks access to an object for a short
while after it is deleted. During this time, Active Directory processes the object’s link-
value table to maintain referential integrity on the linked attribute’s values. Active
Directory then permits access to the deleted object.
Recovering Deleted Objects Using Administrative Center
With Active Directory Recycle Bin enabled, you can easily recover deleted objects using
Active Directory Administrative Center. Each domain in your forest will have a Deleted
Object container. In this container, you’ll see a list of deleted objects.
Deleted objects remain in the Deleted Objects container for the deleted object lifetime.
Each deleted object is listed by type, name, deletion date, and the last known parent. When
you select a deleted object by clicking it, you can use the options in the Tasks pane to
work with it. The Restore option restores the object to its original container. For example,
if the object was deleted from the Groups container, it is restored to this container.
The Restore To option allows you to restore the object to an alternate container within its
original domain or a different domain within the current forest. You specify the alternate
container in the Restore To dialog box. For example, if the object was deleted from the
Groups container in the dev.imaginedlands.com domain, you could restore it to the Eng
OU in the eng.imaginedlands.com domain.
Recovery Using Windows PowerShell
The Active Directory cmdlets for Windows PowerShell can also help you recover deleted
objects. You use Get-ADObject to retrieve the object or objects you want to restore, pass
that object or objects to Restore-ADObject, and then Restore-ADObject restores the object
or objects to the directory database.
Note The Active Directory module is not imported into Windows PowerShell by
default. You need to import the module by using import-module activedirectory.
Get started by opening an elevated, administrator PowerShell prompt by pressing the
Windows key, typing powershell in the Everywhere Search box, right-clicking the
Windows PowerShell entry on the taskbar and then clicking Run As Administrator. The
basic syntax for recovering an object is as follows:
Get-ADObject -Filter {ObjectId} -IncludeDeletedObjects |
Restore-ADObject
where ObjectId is a filter value that identifies the object you want to restore. For example,
you could restore a deleted user account by display name or SAM account name as shown
in these examples:
Get-ADObject -Filter {DisplayName -eq “Tom Smith”}
-IncludeDeletedObjects | Restore-ADObject

Get-ADObject -Filter {SamAccountName -eq “toms”}
–IncludeDeletedObjects | Restore-ADObject
Keep in mind nested objects must be recovered from the highest-level of the deleted
hierarchy to a live parent container. For example, if you accidentally deleted an OU and all
its related accounts, you need to restore the OU before you can restore the related
accounts.
The basic syntax for restoring container objects such as an OU is as follows:
Get-ADObject -ldapFilter:”(msDS-LastKnownRDN=ContainerID)”
–IncludeDeletedObjects | Restore-ADObject
where ContainerID is a filter value that identifies the container object you want to restore.
For example, you could restore the Managers OU as shown in this example:
Get-ADObject -ldapFilter:”(msDS-LastKnownRDN=Managers)”
–IncludeDeletedObjects | Restore-ADObject
If the OU contains accounts you also want to restore, you can now restore the accounts by
using the technique discussed previously, or you can restore all accounts at the same time.
The basic syntax requires that you establish a search base and associate the accounts with
their last known parent, as shown here:
Get-ADObject -SearchBase “CN=Deleted Objects,ForestRootDN”
-Filter {lastKnownParent -eq “ContainerCN,ForestRootDN“}
-IncludeDeletedObjects | Restore-ADObject
where ForestRootDN is the distinguished name of the forest root domain, such as
DC=ImaginedLands,DC=Com, and ContainerCN is the common name of the container,
such as OU=Managers or CN=Users. The following example restores all the accounts that
were in the Managers OU when it was deleted:
Get-ADObject -SearchBase “CN=Deleted Objects,DC=ImaginedLands,DC=com”
–Filter {lastKnownParent –eq “OU=Managers,DC=ImaginedLands,DC=com”}
-IncludeDeletedObjects | Restore-ADObject


Maintaining the Directory Database
The Active Directory database is stored in the Ntds.dit file. In addition to this file, the
directory service uses log files, which store transactions before they are committed to the
database file. Other than regular backup, the directory files require no daily maintenance.

Understanding Directory Database Operations
During regular operation, you will delete objects from AD DS. When you delete an object,
free space becomes available in the database. AD DS regularly consolidates this free disk
space through a process called online defragmentation, and the consolidated free space is
reused when you add new objects to the directory. Although this automatic online
defragmentation redistributes and retains free disk space for use by the database, it does
not release the disk space to the file system. Therefore, the database size does not shrink,
even though objects might have been deleted. This is to be expected, and you do not
normally need to correct this.
You may have to manage the database to resolve low disk space, hardware failure, or
fragmentation issues caused by deleting objects. To resolve low disk-space issues, you can
move the files to a different location permanently or replace the disk on which the
database or log files are stored. To resolve a hardware failure, you can replace the disk on
which the database or log files are stored. To recover physical disk space, you can
defragment the database after bulk deletion of objects or after removing the global catalog.
Bulk deletion or removal of the global catalog can significantly decrease the used space in
the directory, but the unused (free) space is not automatically returned to the file system.
Although this condition does not affect database operation, it does result in large amounts
of free disk space in the database. To decrease the size of the database file by returning
free disk space in the database to the file system, you can perform an offline
defragmentation of the database. Whereas online defragmentation occurs automatically
while AD DS is running, offline defragmentation requires stopping AD DS or taking the
domain controller offline and then using the Ntdsutil.exe command-line tool to perform
the procedure.

Getting Statistics for the Directory Database
One of the primary uses of Ntdsutil is for displaying statistics for the directory database.
The directory database grows proportionally to the number of objects its stores, the data
those objects contain, the amount of indexed data and the types of indexes used. To get
information about the size of the indexes and other important disk space usage
information, follow these steps:
1. Open an elevated, administrator command prompt.
2. Stop AD DS by entering net stop ntds. When prompted, enter Y to stop
additional services.
3. Start the NTDS utility by entering ntdsutil.
4. At the ntdsutil prompt, enter activate instance ntds.
5. At the ntdsutil prompt, enter files.
6. At the File Maintenance prompt, enter space usage.
As shown in Sample 9-3, the output will provide detailed information about space usage.
The Owner column shows the number of data pages that the table, index or other element
occupies. Each data page uses 8 KB of disk space. Thus, if the datatable uses 2249 pages,
it’s using 17,992 KB of disk space and if an index uses 157 pages, it’s using 1256 KB of
disk space.
SAMPLE 9-3. Getting space usage information for the directory database
Space usage information for database: C:\Windows\NTDS\ntds.dit
*************************** MSysDefrag DUMP *********************************
           ObjidFDP: 2
          OLDStatus: NULL
  PassStartDateTime: 6/30/2015 8:45 AM (0x1d0a84b76c28bf2)
 PassElapsedSeconds: 0
    PassInvocations: 1
   PassPagesVisited: 11078
     PassPagesFreed: 0
  PassPartialMerges: 0
        TotalPasses: 708
TotalElapsedSeconds: 421
   TotalInvocations: 478
    TotalDefragDays: 187
  TotalPagesVisited: 1017881
    TotalPagesFreed: 902
 TotalPartialMerges: 4950
****************************** SPACE DUMP ***********************************
Name                 Type   ObjidFDP    PgnoFDP  PriExt      Owned  Available
=============================================================================
C:\Windows\NTDS\ntds.di Db         1          1   256-m       5816       312
datatable               Tbl        8        257   265-m       2249       452
 <Long Values>         LV       184        665     0-m        161        24
 Ancestors_index       Idx      179        660     0-m         41        19
 deltime_not_recycled_ Idx      171        652     0-m          9         5
 DRA_USN_CREATED_index Idx      180        661     0-m         25        10
 DRA_USN_CRITICAL_inde Idx      173        654     1-s          1         0
 DRA_USN_index         Idx      174        655     0-m         25        10

 exprocesslinks_index  Idx      175        656     1-s          1         0
 INDEX_00000000        Idx      168        649     0-m         41        18
 INDEX_00000003        Idx       13        262     0-m        157        17
 INDEX_00000004        Idx      167        648     1-s         91         0
 INDEX_00000007        Idx       14        263     1-s         57         0
 INDEX_0000002A        Idx      166        647     1-s         51         0
 INDEX_0002000D        Idx      165        646     1-s         22         0
…
 INDEX_000908DF        Idx       18        267     0-m        250        13

Checking for Free Space in the Directory Database
Garbage collection in Active Directory Domain Services (AD DS) is the process of
removing deleted objects from the directory database. This process results in unused (free)
disk space in the directory database. By default, this free space is not returned to the file
system or reported in Event Viewer. To see the amount of free disk space that could be
made available to the file system by offline defragmentation, you can change the garbage-
collection logging level so that the free disk space is reported in the Directory Service
event log. After you change the logging level, you can check the Directory Service event
log for Event ID 1646. This event reports the amount of disk space that you can recover
by performing offline defragmentation.
The Registry entry you use to control garbage-collection logging is Garbage Collection
under
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics.
When this key entry has a value of 0, garbage-collection logging is disabled. When this
key entry has a value of 1, garbage-collection logging is enabled. You can determine the
current value for this key entry by entering the following command at a command prompt.
reg query HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics
The key path can also include the UNC path of a remote computer that you want to
examine, such as \CorpServer15 or \192.168.16.125. In the following example, you
examine the NTDS configuration on Server26.
reg query \Server26\HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostics
To change the garbage-collection logging level, follow these steps:
1.                  Log on locally or remotely to the domain controller you want to configure.
Start the Registry Editor by pressing the Windows key, typing regedit in the
Everywhere Search box, and then pressing Enter.
2.                  In Registry Editor, navigate to
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnos
3.                  Double-click Garbage Collection. In the Value data box, enter 1, and then
click OK. If you later want to disable garbage-collection logging, repeat this
procedure and enter a value of 0.

Performing Offline Defragmentation
Performing offline defragmentation creates a new, compacted version of the database file
in a different location. Although this location can be on a network drive, it is best to
perform this procedure on a local file system if possible. You can use locally attached
external storage devices to provide additional disk space for defragmentation of the
database. After you compact the directory file to the temporary location, you can copy the
compacted directory file back to its original location.
The source drive on which the database currently resides should have at least 15 percent of
the current size of the directory database file for temporary storage during the index
rebuild process. The destination drive for the compacted file should have free space
equivalent to at least the current size of the database. Therefore, if the source and
destination path are on the same drive, you should have free space equivalent to at least
115 percent of the current size of the directory database file.
Before you perform offline defragmentation of the directory database file, you should
make a copy of the file. If the compaction of the database does not work properly, you can
then easily restore the database by copying back the copy of the file that you made. Do not
delete this copy of the file until you have verified that the AD DS starts and runs properly.
You can perform offline defragmentation of the directory database by following these
steps:
1.                  Stop AD DS. At an elevated, administrator command prompt, enter the
following command: net stop ntds. When prompted, enter Y to stop additional
services.
2.                  At the elevated command prompt, enter ntdsutil.
3.                  At the Ntdsutil prompt, enter activate instance ntds.
4.                  At the Ntdsutil prompt, enter files.
5.                  If you are compacting the database to a local drive, at the File Maintenance
prompt, enter compact to LocalDirectoryPath where LocalDirectoryPath is the
path to a location on the local computer that includes the drive path, such as
D:\Database. If the path contains any spaces, enclose the entire path in quotation
marks (for example, compact to “c:\DbFolder”). If the directory does not exist,
Ntdsutil.exe creates the directory and then creates in that location the file named
Ntds.dit.
6.                  If you mapped a drive to a shared folder on a remote computer, type the
drive letter only; for example, compact to X:\.
7.                  If defragmentation completes successfully, enter quit to quit the File
Maintenance prompt. Enter quit again to quit Ntdsutil.exe.
8.                  If defragmentation has errors, copy the original version of the Ntds.dit file
to the original database location, and repeat the offline defragmentation procedure.
9.                  If defragmentation succeeds with no errors, you can:
Delete all the log files in the log directory by entering the following command: del
PathToLogFiles\*.log. Be sure to include the drive path and the full file path.

Ntdsutil provides the correct path to the log files in the on-screen instructions. Do
not delete the copy of the Ntds.dit file until you have at least verified that the
domain controller starts properly.
Manually copy the compacted database file to the original location by entering the
following command: copy “TemporaryPath\Ntds.dit” “OriginalPath\Ntds.dit”.
Ntdsutil provides the correct paths to the temporary and original locations of the
Ntds.dit file in the on-screen instructions.
Once you successfully defragment the database, you should check the integrity of the
compacted database file. To do this, follow these steps:
1.                  At an elevated command prompt, enter ntdsutil.
2.                  At the Ntdsutil prompt, enter files.
3.                  At the File Maintenance prompt, enter integrity.
4.                  If the integrity check fails, an error likely occurred during the copy
operation. Manually copy the compacted database file to the original location again,
and then repeat the integrity check.
5.                  If the integrity check succeeds, enter quit to quit the File Maintenance
prompt, and then enter quit again to quit Ntdsutil.exe.
6.                  Restart AD DS. At the command prompt, enter net start ntds.
If errors appear when you restart AD DS, stop AD DS by entering net stop ntds. Enter Y
to stop additional services. Use Event Viewer to identify errors logged in the Directory
Service log. If you find Event ID 1046 “The Active Directory database engine caused an
exception with the following parameters” or Event ID 1168 “Internal error: An Active
Directory error has occurred,” you must restore from backup media.
Real World  If the integrity check repeatedly fails, you may need to revert to the
original copy of the database file. You can also attempt to perform semantic
database analysis with fixup to resolve the problem. To do this, follow these steps:
1. At an elevated command prompt, enter ntdsutil.
2. At the Ntdsutil prompt, enter activate instance ntds.
3. At the Ntdsutil prompt, enter semantic database analysis.
4. At the Semantic Checker prompt, enter verbose on.
5. At the Semantic Checker prompt, enter go fixup.
6. If errors are reported during the semantic database analysis Go Fixup phase, you’ll
need to perform directory database recovery. Enter files to go to the File
Maintenance prompt, and then enter recover.
7. If semantic database analysis with fixup succeeds, at the Semantic Checker
prompt, enter quit, and then enter quit again to close Ntdsutil.exe.
8. Restart AD DS. At the command prompt, enter net start ntds.

Moving the Directory Database
In some cases, you may need to move the Active Directory database file and logs. For
example, if the physical disk on which the database or log files are stored requires
upgrading or maintenance, you will need to move the files. If the database file or logs are
causing the disk to run low on free space, you will need to free up space or move the file
or logs to a disk that has more space.
If the path to the database file or log files will change as a result of moving the files, you
must use Ntdsutil.exe to move the files so that the registry is updated with the new path.
Even if you are moving the files only temporarily, you should use Ntdsutil.exe to move
files locally so that the registry remains current. When you finish, you should perform a
system state backup or a critical-volume backup to ensure you can recover the directory in
the new location. You should also verify that the correct permissions are applied on the
destination folder after the move. If necessary, modify the permissions to protect the files.
Before you attempt to move the database file or logs, you should determine their size and
location. By default, the database file and associated log files are stored in the
%SystemRoot%\NTDS directory. If you change to the appropriate directory, you can use
the Dir command to list the contents and determine the size of the Ntds.dit file and .log
files.
With AD DS offline, you also can examine the database and log files. To do this, follow
these steps:
1.                  Stop AD DS. At an elevated, administrator command prompt, enter the
following command: net stop ntds. When prompted, enter Y to stop additional
services.
2.                  At the elevated command prompt, enter ntdsutil.
3.                  At the Ntdsutil prompt, enter activate instance ntds.
4.                  At the Ntdsutil prompt, enter files.
5.                  At the File Maintenance prompt, enter info. As shown in the following
example, the output indicates the free space on drives, storage locations for
directory data, and the space used by directory files.
Drive Information:
       C:\ NTFS (Fixed Drive  ) free(142.7 Gb) total(232.8 Gb)
       D:\ NTFS (Fixed Drive  ) free(112.6 Gb) total(232.8 Gb)
DS Path Information:
  Database   : D:\Windows\NTDS\ntds.dit - 1423.1 Mb
  Backup dir : D:\Windows\NTDS\dsadata.bak
  Working dir: D:\Windows\NTDS
  Log dir    : D:\Windows\NTDS - 40.0 Mb total
                  edbres00002.jrs - 10.0 Mb
                  edbres00001.jrs - 10.0 Mb
                  edb00001.log - 10.0 Mb
                  edb.log - 10.0 Mb
6.                  Enter quit to quit the File Maintenance prompt. Enter quit again to quit

Ntdsutil.exe.
7.                  Restart AD DS. At the command prompt, enter net start ntds.
When you move the directory files to a local folder on the domain controller, you can
move them permanently or temporarily. For example, you could move files to a temporary
destination if you need to reformat the original location, or you could move the directory
files to a permanent location if you have additional space on another disk. When you
move files temporarily, you can use the same procedure to move the files back. Ntdsutil
updates the registry for you when you move files locally.
To move the directory database and log files to a local drive, follow these steps:
1.                  Stop AD DS. At an elevated, administrator command prompt, enter the
following command: net stop ntds. When prompted, enter Y to stop additional
services.
2.                  At the elevated command prompt, change directories to the current
location of the directory database file (Ntds.dit) or the log files, whichever you are
moving.
3.                  Run the Dir command, and note the current size and location of the
Ntds.dit file.
4.                  At the elevated command prompt, enter ntdsutil.
5.                  At the Ntdsutil prompt, enter activate instance ntds.
6.                  At the Ntdsutil prompt, enter files.
7.                  To move the Ntds.dit file, enter move db to DirPath where DirPath
specifies the path to the new location and also specifies the drive designator. If the
directory does not exist, Ntdsutil.exe creates it.
8.                  To move the log files, enter move logs to DirPath where DirPath specifies
the path to the new location and also specifies the drive designator. If the directory
does not exist, Ntdsutil.exe creates it.
9.                  When the move operation is complete, enter quit to quit the File
Maintenance prompt. Enter quit again to quit Ntdsutil.exe.
10.             At the elevated command prompt, change to the destination directory and
run the Dir command. Confirm that the file or files were copied. If you copied the
Ntds.dit file, confirm that it is the right size.
11.             If you are moving the database file or log files temporarily, you can now
perform any required updates to the original drive. After you update the drive,
repeat steps 4 through 10 to move the files back to the original location.
12.             If you are moving the database file or log files permanently, keep in mind
that Ntdsutil updates the registry automatically when you move files locally. You
should use File Explorer to check the permissions on the destination folder. Verify
that the Administrators group has Allow Full Control, that SYSTEM has Allow
Full Control, that the Include Inheritable Permissions From This Object’s Parent
check box is cleared, and that No Deny permissions are selected.
Note  If Include Inheritable Permissions From This Object’s Parent is selected,
click Edit, clear the setting, and then click OK. When you are prompted, click Copy

to copy previously inherited permissions to this object.
13.             Once you successfully move files and check permissions as necessary,
check the integrity of the database. The procedure is the same as the one discussed
in the previous section, “Performing Offline Defragmentation.”
14.             Restart AD DS. At the command prompt, enter net start ntds.
If you do not have space on the domain controller to move the files temporarily, you can
copy files to a remote share, but you must then restore the files to their original locations.
To copy files to a remote share, follow these steps:
1.                  Stop AD DS. At an elevated, administrator command prompt, enter the
following command: net stop ntds. When prompted, enter Y to stop additional
services.
2.                  At the elevated command prompt, change directories to the current
location of the directory database file (Ntds.dit) or the log files, whichever you are
moving.
3.                  Run the Dir command, and note the current size and location of the
Ntds.dit file.
4.                  Use the Xcopy command to copy the database, to copy the log files, or to
copy both to the remote location.
5.                  When Xcopy completes, change drives to the remote directory and run the
Dir command to compare the file sizes to the original file sizes.
6.                  You can now perform any required updates to the original drive. After you
update the drive, xcopy the database or log files or both to their original locations.
7.                  Once you successfully move files, check the integrity of the database. The
procedure is the same as the one discussed in the previous section, “Performing
Offline Defragmentation.”
8.                  Restart AD DS. At the command prompt, enter net start ntds.


Windows Group Policy:
The Personal Trainer
Windows Server 2012 &
Windows Server 2012 R2
William R. Stanek


PUBLISHED BY
Stanek & Associates
PO Box 362
East Olympia, WA 98540-0362
Copyright © 2015 William Stanek
All rights reserved. No part of the contents of this book may be reproduced, stored or
transmitted in any form or by any means without the express written permission of the
publisher.
United States of America
The Personal Trainer and Stanek & Associates are trademarks of William Stanek. All
other marks are property of their respective owners.
The example names for companies, organizations, persons and other named elements used
in the book are fictitious. No association with any real company, organization, person or
other named element is intended or should be inferred.
This book expresses the author’s views and opinions. The information contained herein is
provided without any express, statutory or implied warranties. Neither the authors, the
publishers, the resellers nor distributors will be held liable for any damages caused or
alleged to be caused either directly or indirectly by this book.

Cover Design: Creative Designs Ltd.
Editorial Development: Andover Publishing Solutions
Technical Review: L & L Technical Content Services
You can provide feedback related to this book by emailing the author at
williamstanek@aol.com. Please use the name of the book as the subject line.



Windows Group Policy: The Personal Trainer
Thank you for buying this book!
Find out about special offers, free book giveaways, amazing deals, and exclusive content! Plus get updates on favorite
books and more when you join William Stanek on Facebook at https://www.facebook.com/William.Stanek.Author.
Visit William online at http://www.williamrstanek.com/.




Introduction
Windows Group Policy: The Personal Trainer for Windows Server 2012 & Windows
Server 2012 R2 is the authoritative quick reference guide to Group Policy and is designed
to be a key resource you turn to whenever you have questions about Group Policy. To this
end, the book zeroes in on the key aspects of Group Policy that you’ll use the most.
Inside this book’s pages, you’ll find comprehensive overviews, step-by-step procedures,
frequently used tasks, documented examples, and much more. One of the goals is to keep
the content so concise that the book remains compact and easy to navigate while at the
same time ensuring that the book is packed with as much information as possible—
making it a valuable resource.


What’s This Book About?
Windows Group Policy: The Personal Trainer for Windows Server 2012 & Windows
Server 2012 R2 is designed to be used in the daily administration of Group Policy. In this
book, I teach you how features work, why they work the way they do, and how to
customize them to meet your needs. I also offer specific examples of how certain features
can meet your needs, and how you can use other features to troubleshoot and resolve
issues you might have. In addition, this book provides tips, best practices, and examples of
how to fine-tune all major aspects of Group Policy.


What Do I Need to Know?
This book covers Group Policy for small, medium, and large organizations. To get
practical and useful information into your hands without the clutter of a ton of background
material, I had to assume several things. If you are reading this book, I hope that you have
basic networking skills and a basic understanding of Windows Server operating systems,
and that Windows Server is already installed on your systems. With this in mind, I don’t
devote entire chapters to understanding Windows Server architecture, installing Windows
Server, or Windows networking. I do, however, provide complete details on the
components of Group Policy and how you can use these components. I provide detailed
guidance to help you quickly and easily perform common tasks, solve problems, and
implement features such as filtering Group Policy processing, migrating the SYSVOL,
implementing change control, restoring Group Policy objects (GPOs), and troubleshooting
GPO replication.


How Is This Book Organized?
Making this book easy to follow and understand was my number one goal! I really want
anyone, skill level or work schedule aside, to be able to learn how to effectively manage
Group Policy.
To make the book easy to use, I’ve divided it into 8 chapters. In Chapters 1 and 2, you’ll
roll up your sleeves and dive right in to the good stuff while also learning how Group
Policy works.
Chapter 1 provides an overview of tools, techniques, and concepts related to Group Policy.
Chapter 2 examines important changes to Group Policy and how these changes affect the
way you use Group Policy. The chapter also provides detailed advice on using both policy
preferences and policy settings, including tips on which technology to use when.
Chapters 3, 4, and 5 discuss the core tools and techniques you’ll use to manage Group
Policy. Chapter 3 explores techniques for configuring both Local Group Policy objects
(LGPOs) and Active Directory–based Group Policy objects (GPOs). Not only will you
learn about essential implementation considerations, you’ll also find tips and techniques
for working across domains, sites, and ​forests. Chapter 4 examines the change control
features available when you implement Advanced Group Policy Management (AGPM).
You’ll learn how to manage workflow within the change control system and how to
configure AGPM itself. In Chapter 5, you’ll learn how to search and filter Group Policy.
You can use the techniques discussed not only to find policy settings and search GPOs but
also to control the security groups and computers to which policy is applied.
GPOs have two parts: a Group Policy container (GPC) stored in Active Directory, and a
Group Policy template (GPT) stored in the SYSVOL. Chapter 6 shows you how to
maintain SYSVOL storage. You’ll also find tips and techniques for troubleshooting
replication. Chapter 7 discusses essential Group Policy concepts and provides tips and
techniques for managing the way Group Policy works. Chapter 8 examines how to
maintain, restore, and troubleshoot Group Policy.


What Conventions Are Used in This Book?
I’ve used a variety of elements to help keep the text clear and easy to follow. You’ll find
code terms and listings in monospace type, except when I tell you to actually enter a
command. In that case, the command appears in bold type. When I introduce and define a
new term, I put it in italics.
This book also has notes, tips and other sidebar elements that provide additional details on
points that need emphasis.


Other Resources
Although some books are offered as all-in-one guides, there’s simply no way one book can
do it all. This book is intended to be used as a concise and easy-to-use resource. It covers
everything you need to perform core tasks for Active Directory, but it is by no means
exhaustive.
As you encounter new topics, take the time to practice what you’ve learned and read
about. Seek additional information as necessary to get the practical experience and
knowledge that you need.
I truly hope you find that Windows Group Policy: The Personal Trainer for Windows
Server 2012 & Windows Server 2012 R2 helps you manage Group Policy successfully and
effectively.
Thank you,
William R. Stanek
(williamstanek@aol.com)


Chapter 1. Introducing Group Policy
Whether you are a skilled administrator who has worked with Windows networks for
years or a novice with a basic understanding, your long-term success in the ever-changing
technology landscape increasingly depends on how well you understand Group Policy.
Group Policy is a collection of preferences and settings that can be applied to user and
computer configurations. It simplifies administration of common and repetitive tasks as
well as unique tasks that are difficult to implement manually but can be automated (such
as deploying new software or controlling which programs can be installed). Group Policy
allows you to apply desired configuration preferences and settings in discrete sets. This
means that you can configure user desktops to meet the specific preferences and
requirements of your organization and control the configuration of every computer on
your network.


Group Policy Preferences and Settings
One way to think of Group Policy is as a set of rules that you can apply throughout the
enterprise. Although you can use Group Policy to manage Windows desktops and
Windows servers, Group Policy has changed since it was first implemented. For current
releases of Windows and Windows Server operating systems, Group Policy includes both
managed settings, referred to as policy settings, and unmanaged settings, referred to as
policy preferences.
Group Policy settings enable you to control the configuration of the operating system and
its components. You can also use policy settings to configure computer and user scripts,
folder redirection, computer security, software installation, and more.
Group Policy preferences enable you to configure, deploy, and manage operating system
and application settings that you were not able to manage using earlier implementations of
Group Policy, including data sources, mapped drives, environment variables, network
shares, folder options, shortcuts, and more. In many cases, you’ll find that using Group
Policy preferences is a better approach than configuring these settings in Windows images
or using logon scripts.
The key difference between preferences and policy settings is enforcement. Group Policy
strictly enforces policy settings. You use policy settings to control the configuration of the
operating system and its components. You also use policy settings to disable the user
interface for settings that Group Policy is managing, which prevents users from changing
those settings. Most policy settings are stored in policy-related branches of the registry.
The operating system and compliant applications check the policy-related branches of the
registry to determine whether and how various aspects of the operating system are
controlled. Group Policy refreshes policy settings at a regular interval, which is every 90
to 120 minutes by default.
Note  When discussing whether applications support Group Policy, the
terms compliant application and Group Policy–aware  application  are often used. A
compliant or Group Policy–aware application is an application specifically written
to support Group Policy. Whether an application is Group Policy–aware is
extremely important. Group Policy–aware applications are programmed to check the
policy-related branches of the registry to determine whether and how their features
and various aspects of the operating system are controlled. Noncompliant, unaware
applications are not programmed to perform these checks.
In contrast, Group Policy does not strictly enforce policy preferences. Group Policy does
not store preferences in the policy-related branches of the registry. Instead, it writes
preferences to the same locations in the registry that an application or operating system
feature uses to store the setting. This allows Group Policy preferences to support
applications and operating system features that aren’t Group Policy–aware and also does
not disable application or operating system features in the user interface to prevent their
use. Because of this behavior, users can change settings that were configured using policy
preferences. Finally, although Group Policy by default refreshes preferences using the
same interval as Group Policy settings, you can prevent Group Policy from refreshing
individual preferences by choosing to apply them only once.

When working with policy settings, keep the following in mind:
Most policy settings are stored in policy-based areas of the registry.
Settings are enforced.
User interface options may be disabled.
Settings are refreshed automatically.
Settings require Group Policy–aware applications.
Original settings are not changed.
Removing the policy setting restores the original settings.
When working with policy preferences, keep the following in mind:
Preferences are stored in the same registry locations as those used by the operating
system and applications.
Preferences are not enforced.
User interface options are not disabled.
Settings can be refreshed automatically or applied once.
Supports non-Group Policy–aware applications.
Original settings are overwritten.
Removing the preference item does not restore the original setting.
Real World  The way you use policy settings or policy preferences depends on
whether you want to enforce the item. To configure an item without enforcing it, use
policy preferences and then disable automatic refresh. To configure an item and
enforce the specified configuration, use policy settings or configure preferences and
then enable automatic refresh.


Understanding Group Policy Objects
Group Policy is so important to a successful Active Directory implementation that most
administrators think of it as a component of Active Directory. This is mostly true—and it
is okay to think of it this way—but you don’t necessarily need Active Directory to use
Group Policy. You can use Group Policy in both enterprise (domain) and local
(workgroup) environments.

Global Group Policy
For enterprise environments in which Active Directory is deployed, the complete set of
policy settings and policy preferences is available. This policy set is referred to as domain-
based Group Policy, Active Directory–based Group Policy, or simply Group Policy. On
domain controllers, Group Policy is stored in the SYSVOL that Active Directory uses for
replicating policies.
Group Policy is represented logically as an object called a Group Policy object (GPO). A
GPO is simply a collection of policy settings and preferences. As discussed in detail in the
section “Maintaining GPO Storage” in Chapter 8 “Maintaining and Restoring Group
Policy,” every GPO has a related Group Policy Container (GPC) and a related Group
Policy Template (GPT).
The Group Policy Container for a GPO is stored in the Active Directory database and
replicated through normal Active Directory replication. The GPC is used to store
properties related to the GPO and is identified with a globally unique identifier (GUID).
The Group Policy Template (GPT) for a GPO is stored in the SYSVOL and replicated
through SYSVOL replication. The GPT is used to store files related to the GPO on disk
and is identified with the same GUID as the Group Policy Container.
Linking a GPO to components of the Active Directory structure is how you apply Group
Policy. In your Active Directory structure, GPOs can be linked to:
Sites A site is a combination of one or more IP subnets connected by highly reliable
links. You use sites to create a directory structure that mirrors the physical structure
of your organization. A site typically has the same boundaries as your local area
networks (LANs). Because site mappings are separate and independent from logical
components in the directory, there’s no necessary relationship between your
network’s physical structures and the logical structures in the directory.
Domains A domain is a logical grouping of objects that share a common directory
database. In the directory, a domain is represented as a container object. Within a
domain, you can create accounts for users, groups, and computers as well as for
shared resources such as printers and folders. Access to domain objects is controlled
by security permissions.
Organizational units An organizational unit (OU) is a logical container used to
organize objects within a domain. Because an OU is the smallest scope to which you
can delegate authority, you can use an OU to help manage administration of accounts
for users, groups, and computers and for administration of other resources, such as
printers and shared folders. By adding an OU to another OU, you can create a
hierarchy within a domain. Because each domain has its own OU hierarchy, the OU
hierarchy of a domain is independent from that of other domains.
You can create multiple GPOs, and by linking them to different locations in your Active
Directory structure, you can apply the related settings to the users and computers in those
Active Directory containers.
Because of the object-based hierarchy in Active Directory, the settings of top-level GPOs
are applied to lower-level GPOs automatically by default. For example, a setting for the

imaginedlands.com domain is applied to the Sales OU within that domain, and the domain
settings will be applied to users and computers in the Sales OU. If you don’t want policy
settings to be applied, you may be able to override or block settings to ensure that only the
GPO settings for the low-level GPOs are applied.
Note  With domain-based Group Policy, you might think that the forest or domain
functional level would affect how Group Policy is used, but this is not the case. The
forest and domain do not need to be in any particular functional mode to use Group
Policy.
When you create a domain, two Active Directory GPOs are created automatically:
Default Domain Controllers Policy GPO A default GPO created for and linked to
the Domain Controllers OU that is applicable to all domain controllers in a domain as
long as they are members of this OU.
Default Domain Policy GPO A default GPO that is created for and linked to the
domain within Active Directory.
You can create additional GPOs as necessary and link them to the sites, domains, and OUs
you created. For example, you could create a GPO called Sales Policy and then link it to
the Sales OU. The policy then applies to that OU.

Local Group Policy
For local environments, you can use a subset of Group Policy called local Group Policy.
As the name implies, local Group Policy allows you to manage policy settings that affect
everyone who logs on to the local machine. This means local Group Policy applies to any
user or administrator who logs on to a computer that is a member of a workgroup, as well
as to any user or administrator who logs on locally to a computer that is a member of a
domain. Local Group Policy is stored locally on individual computers in the
%SystemRoot%\System32\GroupPolicy folder.
Like Active Directory–based Group Policy, local Group Policy is managed through a
GPO. This GPO is referred to as the Local Group Policy object (LGPO). All current
versions of Windows and Windows Server support multiple LGPOs, which are additional
user-specific and group-specific LGPOs stored in the
%SystemRoot%\System32\GroupPolicyUsers folder.
Because local Group Policy is a subset of Group Policy, there are many things you can’t
do locally that you can do in a domain setting. First, you can’t manage any policy
preferences. Second, you can only manage a limited subset of policy settings. Generally
speaking, the policy settings that you can’t manage locally have to do with features that
require Active Directory, such as software installation.
Beyond these fundamental differences between local Group Policy and Active Directory–
based Group Policy, both types of policy are managed in much the same way. In fact, you
use the same tools to manage both. The key difference is in the GPO you use. On a local
machine, you work exclusively with the LGPOs. If you have deployed Active Directory,
however, you can work with domain, site, and OU GPOs in addition to LGPOs.
All computers running Windows have LGPOs. The LGPOs are always processed.
However, they have the least precedence, which means their settings can be superseded by
site, domain, and OU settings. Although domain controllers have LGPOs, Group Policy
for domain controllers is managed best through the Default Domain Controllers GPO.
Tip  Keep in mind that Group Policy is set within the directory itself. Settings are
applied in this basic order: local, site, domain, and then OU. In the default
configuration (where enforcement and blocking are not used), the last setting
applied is the one in effect.


Managing Group Policy
Now that you know how GPOs are used, let’s look at how you manage Group Policy. I
discuss basic tools and techniques in this section as well as how to install additional tools
you might need. You’ll find in-depth discussions for working with Group Policy
throughout the rest of the book.

Working with Group Policy
When you install Active Directory to configure your infrastructure, Active Directory
creates default user accounts and groups to help you manage the directory and configure
security. The default users and groups available include:
Administrator A default user account with domainwide access and privileges. By
default, the Administrator account for a domain is a member of these groups:
Administrators, Domain Admins, Domain Users, Enterprise Admins, Group Policy
Creator Owners, and Schema Admins.
Administrators A local group that provides full administrative access to an
individual computer or a single domain, depending on its location. Because this
group has complete access, you should be very careful about adding users to it. To
make someone an administrator for a local computer or domain, all you need to do is
make that person a member of this group. Only members of the Administrators group
can modify this account. Default members of this group include Administrator,
Domain Admins, and Enterprise Admins.
Domain Admins A global group designed to help you administer all the computers
in a domain. Members of this group have administrative control over all computers in
a domain because they are members of the Administrators group by default. To make
someone an administrator for a domain, make that person a member of this group.
Enterprise Admins A global or universal group designed to help you administer
all the computers in a domain tree or forest. Members of this group have
administrative control over all computers in the enterprise because the group is a
member of the Administrators group by default. To make someone an administrator
for the enterprise, make that person a member of this group.
Group Policy Creator Owners A global group designed to help you administer
group policies. Members of this group have administrative control over Group
Policy.
Schema Admins A global group designed to help you administer Active Directory
schema. Members of this group have administrative control over schema.
Whenever you work with Group Policy, be sure that you are using a user account that is a
member of the appropriate group or groups.

Group Policy Administration Tools
You can manage Group Policy by using both graphical administration tools and command-
line tools. The graphical tools are the easiest to work with, but if you master the
command-line tools, you will often be able to accomplish tasks more quickly. When you
use the command-line tools with the Task Scheduler, you might even be able to automate
routine tasks.
Note  Appendix A, “Installing Group Policy Tools,” provides detailed instructions
on installing additions and extensions for Group Policy. The appendix discusses:
1. Installing the Remote Server Administration Tools.
2. Installing Group Policy client-side extensions.
3. Installing the client and server components for Advanced Group Policy
Management (AGPM).
Graphical Administration Tools
The graphical administration tools for working with Group Policy are provided as custom
consoles as well as individual snap-ins for the Microsoft Management Console (MMC).
You can access these tools directly on the Tools menu in Server Manager, or add them to
any updatable MMC. If you’re using another computer with access to a Windows Server
2012 or 2012 R2 domain, the tools won’t be available until you install them. One
technique for installing these tools is to use the Add Feature Wizard.
You manage Active Directory–based Group Policy by using the Group Policy
Management Console (GPMC), shown in Figure 1-1. You can add the GPMC to any
installation of Windows Server 2012 or 2012 R2 by using the Add Features Wizard.
FIGURE 1-1 Group Policy Management Console.
Windows Server 2012 and 2012 R2 include an updated version of the Group Policy
Management Console (GPMC). In this updated version, the Group Policy preferences are
built in. Additionally, you can configure preferences by installing the Remote Server

Administration Tools (RSAT) on a computer running current Windows desktop versions.
You use GPMC to perform these tasks:
Create, edit, and delete GPOs
Copy, import, and export GPOs
Back up and restore GPOs
Model GPOs prior to deployment to determine how their settings would affect users
and computers
Model existing GPOs to determine how their settings are affecting users and
computers
When you want to edit a GPO in the GPMC, the GPMC opens the Group Policy
Management Editor, shown in Figure 1-2. You use the editor to manage policy settings
and preferences.
FIGURE 1-2 Group Policy Management Editor.
Also available are the Group Policy Starter GPO Editor and the Local Group Policy
Editor. You use the Group Policy Starter GPO Editor to create and manage Starter Group
Policy objects, which are meant to provide a starting point for new policy objects that you
want to use throughout your organization. When you create a policy object, you can
specify a starter GPO as the source or basis of the new object. You use the Local Group
Policy Editor, shown in Figure 1-3, to create and manage policy objects for the local
computer—as opposed to settings for an entire site, domain, or organizational unit.

FIGURE 1-3 Local Group Policy Editor.
Command-Line Tools
When you install GPMC, either through the Add Features wizard or as part of the Remote
Server Administration tools, you can use the Windows PowerShell Group Policy cmdlets
to manage Group Policy. These cmdlets are found in the GroupPolicy module. Other
command-line tools for working with Group Policy include:
GPFIXUP Used to resolve domain name dependencies in Group Policy objects
and Group Policy links after a domain rename operation.
GPRESULT Used to see what policy is in effect and to troubleshoot policy
problems.
GPUPDATE Used to refresh Group Policy manually. If you enter gpupdate at a
command prompt, both the Computer Configuration settings and the User
Configuration settings in Group Policy are refreshed on the local computer.
LDIFDE Used to import and export directory information. You’ll use this tool to
help you perform advanced backup and recovery of policy settings that are stored
outside GPOs. Specifically, you can use this tool to back up and restore a large
number of Windows Management Instrumentation (WMI) filters at one time (as
discussed on the Group Policy team blog at http://go.microsoft.com/fwlink/?
linkid=109519).
NETSH IPSEC Used to view and manage a computer IP Security (IPSec)
configuration. Use netsh ipsec static show all to display the static settings and
policies for IPSec. Use netsh ipsec dynamic show all to display dynamic settings and
policies for IPSec.
Real World  I include NETSH IPSEC in the list of important Group Policy tools
because Group Policy backups created in the GPMC do not contain IPSec settings.
These settings are backed up with system state backups. Because of this, you may
want to track any IPSec settings and policies used, and NETSH IPSEC allows you to

do this.
The Group Policy management tools provide access to Group Policy objects. While I’ll
discuss techniques for working with these tools in detail in Chapter 2, “Deploying Group
Policy,” there are several quick and easy ways to work with GPOs directly. At an elevated,
administrator command line, you can open the computer’s LGPO for editing in the Local
Group Policy Editor by entering gpedit. To open another computer’s LGPO, use the
following syntax:
gpedit.msc /gpcomputer:“ComputerName”
where ComputerName is the host name or fully qualified domain name of the computer.
The remote computer name must be enclosed in double quotation marks such as:
gpedit.msc /gpcomputer:“CorpServer82”
or
gpedit.msc /gpcomputer:“CorpServer82.imaginedlands.com”
At an elevated, administrator command line, you can open a GPO for editing in the Group
Policy Management Editor. The basic syntax is:
gpedit.msc /gpobject:“LDAP://CN=GPOID,
CN=Policies,CN=System,DC=DomainName,DC=com”
where GPOID is the unique identifier for the GPO as listed on the Details tab when a GPO
is selected in the Group Policy Management Console, and Domain Name is the single part
name of the domain in which you created the GPO. The entire object path must be
enclosed in double quotation marks, such as:
gpedit.msc /gpobject:“LDAP://CN={6AC1786C-145d-21E3-956D-
00C04FB123D4},CN=Policies,CN=System,DC=imaginedlands,DC=com”
In this example, the GPO being opened for editing is the GPO with the unique identifier
{6AC1786C-145d-21E3-956D-00C04FB123D4} in the imaginedlands.com domain.
You can use an editor command that targets a specific GPO to quickly open a GPO that
you commonly view or modify. If you save the command in a Shortcut on the desktop,
you’ll have a fast and easy way to access the GPO. In a Command Prompt window, you
can copy an editor command you’ve entered by right-clicking within the Command
Prompt window, and then clicking Mark. If you drag the mouse pointer over the command
and then press Enter, you’ll copy the command to the Windows clipboard. You can then
create a desktop shortcut by right-clicking an open area of the desktop, pointing to New
and then clicking Shortcut.
When the Create Shortcut wizard starts, press Ctrl+V to paste the copied command into
the Type The Location Of The Item box, and then click Next. When prompted, enter a
Name for the shortcut, such as Enhanced Security GPO, and then click Finish. Now, when
you double-click the shortcut, you’ll start the Group Policy Management Editor with your
target GPO opened for viewing and editing.


Chapter 2. Deploying Group Policy
Group Policy provides a convenient and effective way to manage both preferences and
settings for computers and users. With Group Policy, you can manage preferences and
settings for thousands of users or computers in the same way that you manage preferences
and settings for one computer or user—and without ever leaving your desk. To do this,
you use one of several management tools to change a preference or setting to the value
you want, and this change is applied throughout the network to the subset of computers
and users you target.
Previously, making many of the administrative changes that Group Policy enables was
possible only by hacking the Windows registry, and each change had to be made
individually on each target computer. With Group Policy, you can simply enable or disable
a policy to tweak a registry value or other preference or setting, and the change will apply
automatically the next time Group Policy is refreshed. Because changes can be modeled
through the Group Policy Management Console before the modifications are applied, you
can be certain of the effect of each desired change. Prior to deploying a change, you can
save the state of Group Policy. If something goes wrong, you can restore Group Policy to
its original state. When you restore the state of Group Policy, you can be certain that all
changes are undone the next time Group Policy is refreshed.
Before you deploy Group Policy for the first time or make changes to existing policy, you
should ensure you have a thorough understanding of:
How Group Policy has changed with the introduction of each new version of the
Windows operating system.
How you can update Group Policy to include the preferences and settings available in
a new Windows operating system.
How Group Policy is applied to a local computer as well as throughout an Active
Directory environment.
How default policy sets are used and when default policy applies.
When to use policy preferences and when to use policy settings.
I discuss each of these subjects in this chapter.


Keeping Group Policy Up to Date
Group Policy applies only to Windows desktops and Windows servers. Each new version
of the Windows operating system has brought with it changes to the way Group Policy
works.
Current releases of Windows and Windows Server use the Group Policy Client service to
isolate Group Policy notification and processing from the Windows logon process.
Separating Group Policy from the Windows logon process reduces the resources used for
background processing of policy while increasing overall performance and allowing
delivery and application of new Group Policy files as part of the update process without
requiring a restart.
Unlike early releases, current releases of Windows and Windows Server don’t use the
trace logging functionality in Userenv.dll and don’t write to the Application log. Instead,
they write Group Policy event messages to the System log. Additionally, the Group Policy
operational log replaces Group Policy trace logging events that previously were logged to
%SystemRoot%\Debug\Usermode\Userenv.log. Thus, when you are troubleshooting
Group Policy issues, you’ll use the detailed event messages in the operational log rather
than the Userenv log. In Event Viewer, you can access the operational log under
Applications And Services Logs\Microsoft\Windows\GroupPolicy.
Current releases of Windows and Windows Server use Network Location Awareness
instead of ICMP protocol (ping). With Network Location Awareness, a computer is aware
of the type of network to which it is currently connected and can also be responsive to
changes in the system status or network configuration. By using Network Location
Awareness, the Group Policy client can determine the computer state, the network state,
and the available network bandwidth. This change also allows Group Policy to be
refreshed over Virtual Private Network (VPN) connections.

Managing Policy Updates
Each new version of the Windows operating system introduces policy changes. Sometimes
these changes have made older policies obsolete on newer versions of Windows. In this
case the policy works only on specific versions of the Windows operating system, such as
only on Windows 7 and Windows Server 2008 R2. Generally speaking, however, most
policies are forward compatible. This means that policies introduced in Windows 7 and
Windows Server 2008 R2 can, in most cases, be used on Windows 8.1 or later as well as
Windows Server 2012 and later. It also means that Windows 8.1 and Windows Server
2012 policies usually aren’t applicable to Windows 7, Windows Server 2008 R2 or earlier
releases of Windows and Windows Server.
If a policy isn’t applicable to a particular version of the Windows operating system, you
can’t apply it to computers running those versions of the Windows operating system. You
will know if a policy is supported on a particular version of Windows because this is
stated explicitly whenever you are working with a preference or setting.
Like Group Policy, the Group Policy Management Console (GPMC) has changed with
new versions of Windows. When you install the Remote Server Administration Tools (as
discussed in Chapter 1, “Overview of Group Policy”) and select GPMC as a tool you want
to use, you install the version of GPMC for the operating system you are using.
When you start using GPMC for the most recent release of Windows Server installed in
your domain environment, you should stop using previous versions of GPMC. These
previous versions of the GPMC will not have all of the same settings that the most recent
release has. Because of this, you should only manage Group Policy Objects (GPOs) for
the most recent release of Windows Server installed in your domain environment from
computers running that version of Windows Server or a Windows desktop with the related
Remote Server Administration tools installed.
On a computer running Windows 8.1, Windows Server 2012, or later versions, you’ll
automatically see the new features and policies as well as standard features and policies
when you use the appropriate version of GPMC to work with Group Policy. However, the
new features and policies aren’t automatically added to Group Policy objects (GPOs).
Don’t worry—there’s an easy way to fix this, and afterward you’ll be able to work with
new features and policies as appropriate throughout your enterprise.
To push new features and policies into your Active Directory domains, you need to update
the appropriate GPOs. Once you make the update, compatible clients are able to take
advantage of the enhanced policy set, and incompatible clients simply ignore the settings
they don’t support.
You update a GPO for new features and policies by following these steps:
1.                  Log on to a computer running Windows 8.1 or a later release of Windows
using an account with domain administrator privileges.
2.                  Open the Group Policy Management Console (GPMC) by selecting Group
Policy Management on the Tools menu in Server Manager.
3.                  In the GPMC, you’ll see a Forest node representing the current forest to
which you are connected (see Figure 2-1). When you expand the Forest node,

you’ll then see the Domains and Sites nodes. Use these nodes to work your way to
the Group Policy object (GPO) you want to work with.
FIGURE 2-1 Group Policy Management Console connects to the local forest by default.
4.                  When you find the GPO you want to work with, right-click it and then
select edit to open the Group Policy Management Editor, as shown in Figure 2-2.
FIGURE 2-2 Editing a GPO in Group Policy Management Editor.
5.                  In the Group Policy Management Editor, click the Computer
Configuration node and then click the User Configuration node. When you select
these nodes, the current administrative templates are read in and applied to the GPO
you’ve selected. After Group Policy is refreshed, you can modify policy settings as
necessary, and the changes will be updated as appropriate in the selected site,
domain, or organizational unit.
6.                  Repeat this procedure to update the GPOs for other sites, domains, or
organizational units.
Nothing else about how Group Policy is used changes when you make this update.

Managing Changes with Template Files
In Group Policy, two types of XML-based policy definition files provide the structure for
defining the display of policy settings: language-neutral files ending with the .admx file
extension and language-specific files ending with the .adml extension. The language-
neutral files ensure that a GPO has identical core policies. The language-specific files
allow policies to be viewed and edited in multiple languages. Because the language-
neutral files store the core settings, policies can be edited in any language for which a
computer is configured, thus allowing one user to view and edit policies in English and
another to view and edit policies in Spanish, for example. The mechanism that determines
the language used is the language pack installed on the computer.
For simplicity, both types of files generally are referred to as ADMX files. Language-
neutral ADMX files are installed in the %SystemRoot%\PolicyDefinitions folder.
Language-specific ADMX files are installed in the
%SystemRoot%\PolicyDefinitions\LanguageCulture folder. Each subfolder is named after
the appropriate International Standards Organization (ISO) language/culture name, such as
en-US for U.S. English.
Only policy editors that are compatible with the ADMX file format can read the policies
that use ADMX. When you start a compatible policy editor, it automatically reads in the
ADMX files from the policy definitions folders. Because of this, you can copy ADMX
files that you want to use to the appropriate policy definitions folder to make them
available when you are editing GPOs. If the policy editor is running when you copy the
file or files, you must restart the policy editor to force it to read in the file or files.
In domains, ADMX files can be stored in a central store rather than in the Policy​-
Definitions folder on each computer you use for GPO editing. Using a central store makes
management of ADMX files easier and more efficient by allowing administrators to
manage GPOs from any compliant computer on the network, simplifying version
management of policy files and making it easier to add new policy files.
To create a central store for ADMX files, you must access a domain controller using an
account that is a member of the Domain Admins group and then create a folder called
PolicyDefinitions within the SYSVOL. This folder is where you’ll place the language-
neutral ADMX files. You’ll also need to create subfolders within the PolicyDefinitions
folder for each language that is supported in your ADMX files. These subfolders will store
the language-specific resource files, which have the extension .adml. After you create the
required folders, you need to copy the language-neutral ADMX definition files and the
language-specific ADMX resource files to the appropriate folders in the central store.
Because the default location for the active SYSVOL is %SystemRoot%\Sysvol\sysvol,
you would do the following to create and establish the central store in the default
SYSVOL location:
1.                  Access a domain controller running Windows Server 2012 or later in the
target domain using an account that is a member of Domain Admins, and then
create a PolicyDefinitions folder under
%SystemRoot%\Sysvol\sysvol\DomainName\Policies, where DomainName is the
name of the domain in which the domain controller is located and for which you

want to establish a central store. Within the PolicyDefinitions folder, create
subfolders for each language that is supported in your ADMX files.
2.     Copy all the ADMX and ADML files from their original location on a target
computer to the appropriate SYSVOL folders. Windows and Windows Server have
many default ADMX files. Each ADMX file has an associated ADML file located
under one or more language-specific folders, such as en-US for U.S. English. These
files are stored by default under %SystemRoot%\PolicyDefinitions and
%SystemRoot%\PolicyDefinitions\LanguageCulture, respectively. If you’ve
created custom ADMX files, these files are stored on the workstation on which they
were created. Some additional ADMX files may be available only on computers
with the current Windows or Windows Server operating system and service pack
installed.
If you want to create a central store for all languages supported by the computer on which
you are currently logged on, you could copy all the required policy files from your
computer to a target domain controller in a single step. Simply run the following
commands at an elevated, administrator command prompt:
xcopy /s /y %SystemRoot%\PolicyDefinitions \DC\Sysvol\DomainName\policies\PolicyDefinitions\
where DC is the host name of the target domain controller, and DomainName is the fully
qualified DNS name of the domain in which the domain controller is located. In the
following example, you copy the ADMX and ADML files from your computer to
CorpServer56 in the Imaginedlands.com domain:
xcopy /s /y %SystemRoot%\PolicyDefinitions
\CorpServer56\Sysvol\imaginedlands.com\policies\PolicyDefinitions\
Two helpful environment variables when you are working with policy files are
%UserDNSDomain% and %LogonServer%. %UserDNSDomain% represents the current
log on domain, and %LogonServer% represents the domain controller that authenticated
you during logon. Therefore, you could also copy all required policy files by entering the
following command at an elevated, administrator command prompt:
xcopy /s /y %SystemRoot%\PolicyDefinitions \%LogonServer%\Sysvol\
%UserDNSDomain%\policies\PolicyDefinitions\
As a recommended best practice, you should create the central store on the domain
controller that holds the PDC (primary domain controller) Emulator role in the target
domain. Why? By default, the PDC emulator is the domain controller that Group Policy
relies on when you access GPOs for editing. Therefore, when you create the central store
on the PDC emulator, you ensure that anyone who edits Group Policy objects sees the
central store immediately rather than having to wait for SYSVOL replication. As part of
normal SYSVOL replication, the PDC emulator will then replicate the central store to
other domain controllers in the domain.
You can determine which domain controller in your logon domain has the PDC Emulator
role by entering the following command at a command prompt:
dsquery server -o rdn -hasfsmo pdc
The resulting output is the host name of the PDC emulator in your logon domain. If you
want the name for the PDC emulator in another domain, you must use the –Domain

parameter. Consider the following example:
dsquery server -o rdn -hasfsmo pdc -domain tech.imaginedlands.com
Here you obtain the host name for the PDC emulator in the tech.imaginedlands.com
domain. If there are multiple domains in the forest, you might also want a list of all the
domain controllers that have the PDC emulator role on a per-domain basis. To do this, use
the -Forest parameter, such as:
dsquery server -hasfsmo pdc -forest
For more information on why Group Policy relies on the PDC emulator by default, see
“Connecting to and Working with GPOs” later in this chapter.

Managing Changes with DFSR Replication
A key change between early implementations of Active Directory and current
implementations has to do with how policies and related data are replicated. The Active
Directory system volume (SYSVOL) contains domain policy; scripts used for log on, log
off, shutdown, and startup; other related files; and files stored within Active Directory.
While I’ll provide an in-depth discussion of the SYSVOL in Chapter 7, “Maintaining the
SYSVOL,” let’s take a quick look at the way SYSVOL replication works.
Domain controllers use the Active Directory replication topology to replicate files and
folders in the SYSVOL shared folders. The replication service used is Distributed File
System (DFS).
DFS checks with the Knowledge Consistency Checker (KCC) running on each domain
controller to determine the replication topology that has been generated for Active
Directory replication. Then DFS uses this replication topology to replicate SYSVOL files
to other domain controllers in the domain.
Distributed File Service (Dfssvc.exe) stores information about stand-alone namespaces in
the registry and information about domain-based namespaces in Active Directory. The
stand-alone DFS metadata contains information about the configuration of each stand-
alone namespace and is maintained in the registry of the root server at
HKLM\SOFTWARE\Microsoft\Dfs\Roots\Standalone. Domain-based root servers have a
registry entry for each root under HKLM\SOFTWARE\Microsoft\Dfs\Roots\Domain, but
these entries do not contain the domain-based DFS metadata.
When the DFS service starts, DFS checks this path for registry entries that correspond to
domain-based roots. If these entries exist, the root server polls the PDC emulator master to
obtain the DFS metadata for each domain-based namespace and stores the metadata in
memory.
In Active Directory, the DFS object stores the DFS metadata for a domain-based
namespace. The DFS object is created in Active Directory when you establish a domain at
or promote a domain to the Windows Server 2008 or higher domain functional level.
Active Directory replicates the entire DFS object to all domain controllers in a domain.
DFS uses a client-server architecture. A domain controller hosting a DFS namespace has
both the client and the server components, allowing the domain controller to perform local
lookups in its own data store and remote lookups in data stores on other domain
controllers. DFS uses the Common Internet File System (CIFS) for communication
between DFS clients, root servers, and domain controllers. CIFS is an extension of the
Server Message Block (SMB) file sharing protocol.
Note  DFS is only available when all domain controllers are running Windows
Server 2008 or later and the domain is running in the Windows Server 2008 or
higher functional level. When you make a change to a GPO and DFS is being used,
only the changes in GPOs are replicated, thereby eliminating the need to replicate an
entire GPO after a change.


Applying and Linking Group Policy Objects
You store Group Policy preferences and settings in Group Policy objects (GPOs). While
I’ll cover the nitty-gritty details in later chapters, I’ll examine the basic concepts related to
Group Policy application (initial processing) and refresh (subsequent processing) in this
section.

Policy Sets Within GPOs
Within Group Policy, two distinct sets of policies are defined:
Computer policies These apply to computers and are stored under Computer
Configuration in a Group Policy object.
User policies These apply to users and are stored under User Configuration in a
Group Policy object.
Both Computer Configuration and User Configuration have Policies and Preferences
nodes. You use:
Computer Configuration\Policies to configure policy settings targeted to specific
computers.
Computer Configuration\Preferences to configure policy preferences targeted to
specific computers.
User Configuration\Policies to configure policy settings targeted to specific users.
User Configuration\Preferences to configure policy preferences targeted to specific
users.
Initial processing of the related policies is triggered by two unique events:
Processing of computer policies is triggered when a computer is started. When
a computer is started and the network connection is initialized, computer policies are
applied.
Processing of user policies is triggered when a user logs on to a computer. 
When a user logs on to a computer, user policies are applied.
Once applied, policies are automatically refreshed to keep settings current and to reflect
any changes that might have been made. By default, Group Policy on domain controllers
is refreshed every 5 minutes. For workstations and other types of servers, Group Policy is
refreshed every 90 to 120 minutes by default. In addition, most security settings are
refreshed every 16 hours regardless of whether any policy settings have changed in the
intervening time. Other factors can affect Group Policy refreshes, including how slow-link
detection is defined (per the Group Policy Slow Link Detection Policy under Computer
Configuration\Policies\Administrative Templates\System\Group Policy) and policy
processing settings for policies under Computer Configuration\Policies\Administrative
Templates\System\Group Policy. As discussed in “Controlling Group Policy Processing
and Refresh” in Chapter 7, you can check the last refresh of Group Policy using the Group
Policy Management Console.

GPO Types
As discussed in Chapter 1, there are two types of policy objects: Active Directory​–based
Group Policy objects (GPOs) and Local Group Policy objects (LGPOs).
Active Directory supports three levels of Group Policy objects:
Site GPOs Group Policy objects applied at the site level to a particular Active
Directory site.
Domain GPOs Group Policy objects applied at the domain level to a particular
Active Directory domain.
Organizational Unit (OU) GPOs Group Policy objects applied at the OU level to
a particular Active Directory OU.
Through inheritance, a GPO applied to a parent container is inherited by a child container.
This means that a policy preference or setting applied to a parent object is passed down to
a child object. For example, if you apply a policy setting in a domain, the setting is
inherited by organizational units within the domain. In this case, the GPO for the domain
is the parent object and the GPOs for the organizational units are the child objects.
In an Active Directory environment, the basic order of inheritance goes from the site level
to the domain level to the organizational unit level. This means that the Group Policy
preferences and settings for a site are passed down to the domains within that site, and the
preferences and settings for a domain are passed down to the organizational units within
that domain.
Tip  As you might expect, you can override inheritance. To do this, you
specifically assign a policy preference or setting for a child container that
contradicts the policy preference or setting for the parent. As long as overriding the
policy is allowed (that is, overriding isn’t blocked), the child’s policy preference or
setting will be applied appropriately. To learn more about overriding and blocking
GPOs, see the section “Managing Group Policy Inheritance” in Chapter 7.
Windows 8.1, Windows Server 2012, and later versions allow the use of multiple LGPOs
on a single computer (as long as the computer is not a domain controller). On compliant
computers, there are three layers of LGPOs:
Local Group Policy object The Local Group Policy object is at the top of the
policy hierarchy for the local computer. The LGPO is the only local computer policy
object that allows both computer configuration and user configuration settings to be
applied to all users of the computer.
Administrators Local Group Policy object / Non-Administrators Local Group
Policy object Whether the Administrators Local Group Policy object or the Non-
Administrators Local Group Policy object applies depends on the account being used.
If the account is a member of the local computer’s Administrator’s group, the
Administrators Group Policy object is applied. Otherwise, the Non-Administrators
Group Policy object is applied. This object contains only user configuration settings.
User-specific Local Group Policy object A user-specific Local Group Policy
object applies only to an individual user or to members of a particular group. This
object contains only user configuration settings.

These layers of LGPOs are processed in the following order: Local Group Policy object,
Administrators or Non-Administrators Local Group Policy object, and then user-specific
Local Group Policy object.
Real World  When computers are being used in a stand-alone configuration rather
than a domain configuration, you may find that multiple LGPOs are useful because
you no longer have to explicitly disable or remove settings that interfere with your
ability to manage a computer before performing administrator tasks. Instead, you
can implement one local policy object for administrators and another local policy
object for nonadministrators. In a domain configuration, however, you might not
want to use multiple LGPOs. In domains, most computers and users already have
multiple Group Policy objects applied to them—adding multiple LGPOs to this
already varied mix can make managing Group Policy confusing. Therefore, you
might want to disable processing of LGPOs, and you can do this through Group
Policy. To disable processing of Local Group Policy objects on computers running
Windows 8.1, Windows Server 2012 or later, you must enable the Turn Off Local
Group Policy Objects Processing setting in an Active Directory–based Group Policy
object that the computer processes. When you are editing a GPO in the Group Policy
Management Editor, this setting is located under Computer Configuration\Policies.
Expand Administrative Templates\System\Group Policy, and then double-click the
Turn Off Local Group Policy Objects Processing entry.
Putting this all together when both Active Directory and local policies are in place,
policies are applied in the following order:
1.                  Local GPOs
2.                  Site GPOs
3.                  Domain GPOs
4.                  Organizational unit GPOs
5.                  Child organizational unit GPOs
Because the available preferences and settings are the same for all policy objects, a
preference or setting in one policy object can possibly conflict with a preference or setting
in another policy object. Compliant operating systems resolve conflicts by overwriting any
previous preference or setting with the last read and most current preference or setting.
Therefore, the final preference or setting written is the one that Windows uses. For
example, by default, organizational unit policies have precedence over domain policies.
As you might expect, there are exceptions to the precedence rule. These exceptions are
discussed in the section “Managing Group Policy Inheritance” in Chapter 7.

GPO Links
In Active Directory, each site, domain, or OU can have one or more GPOs associated with
it. The association between a GPO and a site, domain, or OU is referred to as a link. For
example, if a GPO is associated with a domain, the GPO is said to be linked to that
domain.
GPOs are stored in a container called Group Policy Objects. This container is replicated to
all domain controllers in a domain, so by default all GPOs are also replicated to all domain
controllers in a domain. The link (association) between a domain, site, or OU is what
makes a GPO active and applicable to that domain, site, or OU.
Linking can be applied in two ways:
You can link a GPO to a specific site, domain, or OU. For example, if a GPO is
linked to a domain, the GPO applies to users and computers in that domain. The main
reason for linking a GPO to a specific site, domain, or OU is to keep with the normal
rules of inheritance.
You can link a GPO to multiple levels in Active Directory. For example, a single
GPO could be linked to a site, a domain, and multiple OUs. In this case, the GPO
applies to each of these levels within Active Directory. The main reason for linking a
GPO to multiple levels within Active Directory is to create direct associations
between a GPO and multiple sites, domains, and OUs irrespective of how inheritance
would normally apply.
You can also unlink a GPO from a site, domain, or OU. This removes the direct
association between the GPO and the level within Active Directory from which you’ve
removed the link. For example, if a GPO is linked to a site called First Seattle Site and
also to the imaginedlands.com domain, you can remove the link from the
imaginedlands.com domain, removing the association between the GPO and the domain.
The GPO is then linked only to the site. If you later remove the link between the site and
the GPO, the GPO is completely unlinked. A GPO that has been unlinked from all levels
within Active Directory still exists within the Group Policy Objects container, but it is
inactive.

Connecting to and Working with GPOs
When you use the GPMC to work with GPOs, by default the corresponding changes are
made on the domain controller that is acting as the PDC emulator. In this way, the PDC
emulator is the central point of contact for GPO creation, modification, and deletion.
Active Directory manages policy in this way to ensure that changes to the GPO structure
can be implemented only on a single authoritative domain controller and that only one
administrator at a time is granted access to a particular GPO. Because the PDC emulator
role is specified at the domain level, there is only one PDC emulator in a domain, and
therefore only one place where policy settings are changed by default. If the PDC
emulator is unavailable when you are trying to work with policy settings, you get a prompt
that enables you to work with policy settings on the domain controller to which you are
connected or on any available domain controller.
Any user who is a member of the Domain Admins or Enterprise Admins group can view
and work with Active Directory–based Group Policy. Unlike local Group Policy, GPO
creation and linking are separate operations with Active Directory–based Group Policy.
First you create a GPO and define a group of policy settings to achieve desired results.
Then you apply your GPO and make it “live” by linking it to the container or containers
within Active Directory where it will be applied.
Although creating and linking GPOs are two distinct operations, the GPMC does allow
you to create GPOs and simultaneously link them to a domain or OU within the directory.
This means you have two options for creating and linking GPOs. You can:
Create a GPO and then later link it to a domain or OU within the directory.
Create a GPO and simultaneously link it to a domain or OU within the directory.
To link a GPO to a site, the GPO must already exist.
The link is what tells Active Directory to apply the preferences and settings specified in
the GPO. For example, you can create a GPO called Main Imaginedlands.com Domain
Policy and then link it to the Domain container for imaginedlands.com. According to the
default (standard) inheritance and policy processing rules, once you link a GPO to a
container, the related policy preferences and settings are applied to that container, and
lower-level containers within the directory can also inherit the preferences settings. This
means a linked GPO can affect every user and computer throughout the enterprise—or
some subset of users and computers throughout the enterprise.


Using Default Policies
With Windows Server, you create a domain by establishing the first domain controller for
that domain. This typically means logging on to a stand-alone server as a local
administrator, running the Active Directory Domain Services Configuration Wizard, and
then specifying that you want to establish a new forest or domain. When you establish the
domain and the domain controller, two GPOs are created by default:
Default Domain Policy GPO A GPO created for and linked to the domain within
Active Directory. This GPO is used to establish baselines for a selection of policy
settings that apply to all users and computers in a domain.
Default Domain Controllers Policy GPO A GPO created for and linked to the
Domain Controllers OU that is applicable to all domain controllers in a domain (as
long as they aren’t moved from this OU). This GPO is used to manage security
settings for domain controllers in a domain.
These default GPOs are essential to the proper operation and processing of Group Policy.
By default, the Default Domain Controllers Policy GPO has the highest precedence among
GPOs linked to the Domain Controllers OU, and the Default Domain Policy GPO has the
highest precedence among GPOs linked to the domain. As you’ll learn in the sections that
follow, the purpose and use of each default GPO is a bit different.
Note  The default GPOs are used to establish defaults for a limited subset of policy
settings. Neither default GPO is used to establish default preferences.
Working with the Default Domain Policy GPO
The Default Domain Policy GPO is a complete policy set that includes settings for
managing any area of policy, but it isn’t meant for general management of Group Policy.
As a best practice, you should edit the Default Domain Policy GPO only to manage the
default Account policies settings and three specific areas of Account policies:
Password policy Determines default password policies for domain controllers,
such as password history and minimum password length settings.
Account lockout policy Determines default account lockout policies for domain
controllers, such as account lockout duration and account lockout threshold.
Kerberos policy Determines default Kerberos policies for domain controllers, such
as maximum tolerance for computer clock synchronization.
To manage other areas of policy, you should create a new GPO and link it to the domain or
an appropriate OU within the domain. That said, several policy settings are exceptions to
the rule that the Default Domain Policy GPO (or the highest precedence GPO linked to the
domain) is used only to manage Account policies. These policies (located in the Group
Policy Management Editor under Computer Configuration\Policies\Windows
Settings\Security Settings\Local Policies\Security Options) are as follows:
Accounts: Rename Administrator Account Renames the built-in Administrator
account on all computers throughout the domain, setting a new name for the account
so that it is better protected from malicious users. Note that this policy affects the
logon name of the account, not the display name. The display name remains

Administrator or whatever you set it to. If an administrator changes the logon name
for this account through Active Directory Users And Computers, it automatically
reverts to what is specified in this policy setting the next time Group Policy is
refreshed.
Accounts: Administrator Account Status Forcibly disables the built-in
Administrator account on all computers throughout the domain. If you disable the
Administrator account, keep in mind that this account is always available when you
boot a computer in safe mode.
Accounts: Guest Account Status Forcibly disables the built-in Guest account on
all computers throughout the domain. If you disable the Guest account, keep in mind
that network logons will fail if you set the security option Network Access: Sharing
And Security Model For Local Accounts to Guest Only.
Accounts: Rename Guest Account Renames the built-in Guest account on all
computers throughout the domain, setting a new name for the built-in Guest account
so that it is better protected from malicious users. Note that this policy affects the
logon name of the account, not the display name. The display name remains Guest or
whatever else you set it to. If an administrator changes the logon name for this
account through Active Directory Users And Computers, it automatically reverts to
what is specified in this policy setting the next time Group Policy is refreshed.
Network Security: Force Logoff When Logon Hours Expire Forces users to log
off from the domain when logon hours expire. For example, if you set the logon
hours as 8 A.M. to 6 P.M. for the user, the user is forced to log off at 6 P.M.
Network Security: Do Not Store LAN Manager Hash Value On Next Password
Change Determines whether at the next password change the LAN Manager hash
value for the new password is stored. Because this value is stored locally in the
security database, a password could be compromised if the security database was
attacked. On current releases of Windows and Windows Server, this setting is
typically enabled by default.
Network Access: Allow Anonymous SID/Name Translation Determines whether
an anonymous user can request security identifier (SID) attributes for another user.
This is a legacy setting that is best left in the default, disabled state. If this setting is
enabled, a malicious user could use the well-known Administrators SID to obtain the
real name of the built-in Administrator account, even if the account has been
renamed.
Additionally, certificates stored as policy settings for data recovery agents in the domain
are also exceptions. These policies are stored under Computer
Configuration\Policies\Windows Settings\Security Settings\Public Key
Policies\Encrypting File System). You typically manage these policy settings through the
GPO that is linked to the domain level and has the highest precedence. As with Account
policies, this is the Default Domain Policy GPO by default.
Wondering why configuring policy in this way is a recommended best practice? Well, if
Group Policy becomes corrupted and stops working, you can use the Dcgpofix tool to
restore the Default Domain Policy GPO to its original state (which would mean that you
would lose all the customized settings you’ve applied to this GPO). Further, some policy
settings can only be configured at the domain level, and configuring them in the Default

Domain Policy GPO (or the highest precedence GPO linked to the domain) makes the
most sense.
Note  Bottom line, if you define Account policies in multiple GPOs linked to a
domain, the settings will be merged according to the link order of these GPOs. The
GPO with a link order of 1 will always have the highest precedence. I discuss link
order in “Changing Link Order and Precedence” in Chapter 7. For more information
on working with Dcgpofix, see “Recovering the Default GPOs” in Chapter 8
“Maintaining and Restoring Group Policy.”
You can access the Default Domain Policy GPO in several ways. If you are using the
GPMC, you’ll see the Default Domain Policy GPO when you click the domain name in
the console tree, as shown in Figure 2-3. Right-click the Default Domain Policy node and
select Edit to get full access to the Default Domain Policy GPO.
FIGURE 2-3 Accessing the Default Domain Policy GPO in GPMC.
In the Group Policy Management Editor, under Computer Configuration, expand
Policies\Windows Settings\Security Settings\Local Policies as shown in Figure 2-4. You
can then work with Audit Policy, User Rights Assignment, and Security Options as
necessary.
FIGURE 2-4 Editing the Default Domain Policy GPO.

Working with the Default Domain Controllers Policy GPO
The Default Domain Controllers Policy GPO is designed to ensure that all domain
controllers in a domain have the same security settings. This is important because all
domain controllers in an Active Directory domain are equal. If they were to have different
security settings, they might behave differently, and this would be counter to the way
Active Directory is designed to work. If one domain controller has a specific policy
setting, this policy setting should be applied to all domain controllers to ensure consistent
behavior across a domain.
The Default Domain Controllers Policy GPO is linked to the Domain Controllers OU.
This ensures that it is applicable to all domain controllers in a domain as long as they
aren’t moved from this OU. Because all domain controllers are placed in the Domain
Controllers OU by default, any security setting changes you make will apply to all domain
controllers by default. The key security areas that you should manage consistently include:
Audit policy Determines default auditing policies for domain controllers.
User rights assignment Determines default user rights assignment for domain
controllers.
Security options Determines default security options for domain controllers.
Microsoft recommends that you not make any other changes to the Default Domain
Controllers Policy GPO. Keep in mind that this GPO applies only to domain controllers
because it is linked to the Domain Controllers OU and all domain controllers are members
of this OU by default.
Moving a domain controller out of the Domain Controllers OU can adversely affect
domain management and can also lead to inconsistent behavior during logon and
authentication. Why? When you move a domain controller out of the Domain Controllers
OU, the Default Domain Controllers Policy GPO no longer applies unless you’ve linked
this GPO to the destination OU. Further, any GPO linked to the destination OU is applied
to the domain controller.
Therefore, if you move a domain controller out of the Domain Controllers OU, you should
carefully manage its security settings thereafter. For example, if you make security
changes to the Default Domain Controllers Policy GPO, you should ensure that those
security changes are applied to domain controllers stored in OUs other than the Domain
Controllers OU.
You can access the Default Domain Controllers Policy GPO in several ways. If you are
using the GPMC, you’ll see the Default Domain Controllers Policy GPO when you click
the Domain Controllers node in the console tree. Then right-click the Default Domain
Controllers Policy and select Edit to get full access to the Default Domain Controllers
Policy GPO.
Real World  Microsoft product support does not support moving a domain controller
out of the Domain Controllers OU. If you’ve done so and are having problems with your
domain controllers that could be related to this action, Microsoft product support will ask
you to move the domain controller back to the Domain Controllers OU.
Other components and products rely on the Default Domain Controllers Policy GPO

being present and linked in the domain. For example, Exchange Server may generate
error events stating it cannot find a global catalog. Often, this occurs because you do not
have the Default Domain Controllers Policy linked to the Domain Controllers OU or
because you have moved domain controllers out of the Domain Controllers OU.


Using Policy Preferences and Settings
So far we’ve discussed how Group Policy has changed, how you can update policy, and
how policy is applied, but I haven’t discussed the specific ways in which you can use
preferences and settings to help you better manage your network. I’ll remedy that now by
detailing uses for both preferences and settings. Because some overlap occurs in
management areas for preferences and settings, I’ll also discuss whether using settings or
preferences is better suited to a particular task.

Using Policy Settings for Administration
A policy setting is a managed setting that you apply to control configuration, such as to
restrict access to the Run dialog box. Most policy settings have three basic states:
Enabled The policy setting is turned on, and its settings are active. You typically
enable a policy setting to ensure that it is enforced. Once enabled, some policy
settings allow you to configure additional options that fine-tune how the policy
setting is applied.
Disabled The policy setting is turned off, and its settings are not applied. Typically,
you disable a policy setting to ensure that it is not enforced.
Not Configured The policy setting is not being used. No settings for the policy are
either active or inactive and no changes are made to the configuration settings
targeted by the policy.
By themselves, these states are fairly straightforward. However, these basic states can be
affected by inheritance and blocking (which I touched on briefly and will discuss in detail
in Chapter 5, “Searching and Filtering Group Policy”). That said, with the following two
rules about inheritance and blocking in mind, you’ll be well on your way to success with
Group Policy:
If inherited policy settings are strictly enforced, you cannot override them. This
means the inherited policy setting is applied regardless of the policy state set in the
current GPO.
If inherited policy settings are blocked in the current GPO and not strictly enforced,
the inherited policy setting is overridden. This means the inherited policy setting does
not apply, and only the policy setting from the current GPO is applied.
Now that you know exactly how to apply individual policy settings, let’s look at the
administrative areas to which you can apply Group Policy. Through a special set of
policies called Administrative Templates, you can manage just about every aspect of the
Windows graphical user interface (GUI). The Administrative Template policy settings
affect actual registry settings, so the available policies are nearly identical whether you are
working with local Group Policy or domain-based Group Policy. You can use
administrative templates to manage:
Control Panel Controls access to and the options of Control Panel. You can also
configure settings for Add Or Remove Programs, Display, Printers, and Regional
And Language Options.
Desktop Configures the Windows desktop, the availability and configuration of
Active Desktop, and Active Directory search options from the desktop.
Network Configures networking and network client options, including offline files,
DNS clients, and network connections.
Printers Configures printer publishing, browsing, spooling, and directory options.
Shared folders Allows publishing of shared folders and Distributed File System
(DFS) roots.
Start and taskbar Configures Start and the taskbar, primarily by removing or
hiding items and options.
System Configures policies related to general system settings, disk quotas, user

profiles, logon, power management, system restore, error reporting, and more.
Windows components Configures whether and how to use various Windows
components, such as Event Viewer, Task Scheduler, and Windows Updates.
Real World  You can obtain additional administrative templates for Microsoft Office at
the Microsoft Download Center ( http://download.microsoft.com ). At the Download
Center, search for “Office customization tool,” and then click the link for the most recent
release. Next, download and run the self-extracting executable. When prompted, accept
the license terms and then click Continue. You will then be able to select a destination
folder for the related files. Review the files you’ve just extracted.
To use the administrative templates in GPMC on your computer, copy the ADMX files to
the %SystemRoot%\PolicyDefinitions folder and the ADML files to the appropriate
language-specific subfolder of the PolicyDefinitions folder. Otherwise, to make the
administrative templates available throughout the domain, copy the ADMX and ADML
files to the appropriate folders within the SYSVOL on a domain controller.
Table 2-1 provides a comprehensive list of administrative areas you can manage using
Group Policy. Whether you are working with local Group Policy or Active Directory–
based Group Policy, the areas of administration are similar. However, you can do much
more with Active Directory–based Group Policy primarily because you cannot use local
Group Policy to manage any features that require Active Directory.

TABLE 2-1 Key Administrative Areas That Can Be Managed with Policy Settings
Device/Drive
installation
Controls the way device and driver installation works.
 
Computer Configuration\Policies\Administrative
Templates\System\Device Installation
 
Computer Configuration\Policies\Administrative
Templates\System\Drive Installation
 
User Configuration\Policies\Administrative
Templates\System\Drive Installation
Device Installation
restriction
Restricts the devices that can be deployed and used.
 
Computer Configuration\Policies\Administrative
Templates\System\Device Installation\Device Installation
Restrictions
Disk quotas
Configures the way disk quotas are used and whether
quotas are enforced, logged, or both.
 
Computer Configuration\Policies\Software Settings
Encrypted data
recovery agents
Configures data recovery agents and their related
certificates for use with the Encrypting File System
(EFS).
 
Computer | User Configuration\Policies\Windows
Settings\Security Settings\Public Key
Policies\Encrypting File System
File and folder
security
Configures security permissions for files and folders.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\File System
Folder redirection
Moves critical data folders for users to network shares
where they can be better managed and backed up
regularly (domain-based Group Policy only).
 
User Configuration\Policies\Windows Settings\Folder
Redirection
General computer
security
Establishes security settings for accounts, event logs,
restricted groups, system services, the registry, and file
systems. (With local Group Policy, you can only manage
general computer security for account policies.)

 
Computer Configuration\Policies\Windows
Settings\Security Settings
Internet settings
Controls the ways Windows Internet Explorer can be
used and establishes lockdown settings.
 
Computer Configuration\Policies\Administrative
Templates\Windows Components\Internet Explorer
IP security
Configures IP security policy for clients, servers, and
secure servers.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\IP Security Policies
Local security policies
Configures policy for auditing, user rights assignment,
and user privileges.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\Local Policies
Offline files
Determines whether and how offline files are used.
 
Computer | User Configuration\Policies\Administrative
Templates\Network\Offline Files
Policy-based Quality
of Service (QoS)
Manages network traffic to help improve quality of
service for critical applications.
 
Computer | User Configuration\Policies\Windows
Settings\Policy-based QoS
Power options
Configure power management plans and settings for
devices.
 
Computer | User Configuration\Policies\Administrative
Templates\System\Power Management
Printer deployment
Configures printers for use.
 
Computer | User Configuration\Policies\Windows
Settings\Deployed Printers
Public key security
Configures public key policies for autoenrollment, EFS,
enterprise trusts, and more.
 
Computer | User Configuration\Policies\Windows
Settings\Security Settings\Public Key Policies
Registry security
Configures security permissions for registry keys.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\Registry

Restricted groups
Controls the membership of both Active Directory–based
groups and local computer groups.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\Restricted Groups
Scripts
Configures logon/logoff scripts for users and
startup/shutdown scripts for computers.
 
Computer | User Configuration\Policies\Windows
Settings\Security Settings\Scripts
Software installation
Configures automated deployment of new software and
software upgrades (domain-based Group Policy only).
 
Computer | User Configuration\Policies\Software
Settings\Software Installation
Software restriction
Restricts the software that can be deployed and used.
Local Group Policy does not support user-based software
restriction policies, only computer-based software
restriction policies.
 
Computer | User Configuration\Policies\Windows
Settings\Security Settings\Software Restriction Policies
Start menu
Defines the available options on and the behavior of
Start.
 
User Configuration\Policies\Administrative
Templates\Start Menu And Taskbar
System services
Configures startup state and security permissions for
system services.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\System Services
Wired networking
(IEEE 802.3)
Configures wired network policies for authentication
methods and modes that apply to wired clients (domain-
based Group Policy only). Can also be used to validate
server certificates, enable quarantine checks, enforce
advanced 802.1X settings, and enable single sign on.
 
Computer Configuration\Policies\Windows
Settings\Security Settings\Wired Network (IEEE 802.3)
Policies
Wireless networking
(IEEE 802.11)
Configures wireless network policies for access points,
wireless clients, and preferred networks (domain-based
Group Policy only). Can also be used to define permitted
types of connections and block disallowed types of
connections.

 
Computer Configuration\Policies\Windows
Settings\Security Settings\Wireless Network (IEEE
802.11) Policies

Using Policy Preference for Administration
A policy preference is an unmanaged setting that you apply to preconfigure an option for a
user, such as to map a network share to a drive. Most policy preferences can be established
using one of four different actions:
Create Creates the preference only if a preference does not already exist.
Replace Deletes the preference if it exists and then creates it, or creates the
preference if it doesn’t yet exist.
Update Modifies the preference if it exists. Otherwise, creates the preference.
Delete Deletes the preference if it exists.
As with states for policy settings, these actions are fairly straightforward. However, these
basic actions also can be affected by inheritance and blocking. To help you navigate
inheritance and blocking, keep these basic rules in mind:
If inherited policy preferences are strictly enforced, you cannot override them. This
means the inherited policy preference is applied regardless of the action defined in
the current GPO.
If inherited policy preferences are blocked in the current GPO and not strictly
enforced, the inherited policy preference is overridden. This means the inherited
policy preference does not apply, and only the policy preference from the current
GPO is applied.
Unlike policy settings, policy preferences apply only to Active Directory–based Group
Policy. When you are working with Active Directory–based Group Policy, you can use
policy preferences to configure the items discussed in Table 2-2.
TABLE 2-2 Key Elements That Can Be Configured with Policy Preferences
Applications
Application settings. Available when you install preference settings for an application.
 
User Configuration\Preferences\Windows Settings\Applications
Data Sources
Open Database Connectivity (ODBC) data sources
 
Computer | User Configuration\Preferences\Control Panel Settings\Data Sources
Devices
System devices, including USB ports and removable media
 
Computer | User Configuration\Preferences\Control Panel Settings\Devices
Drive Maps
Network shares mapped to drive letters.
 
User Configuration\Preferences\Windows Settings\Drive Maps
Environment
System and user environment variables
 
Computer | User Configuration\Preferences\Windows Settings\Environment
Files
Files that can be copied from a source location to a destination location.

 
Computer | User Configuration\Preferences\Windows Settings\Files
Ini Files
Property values within .ini files.
 
Computer | User Configuration\Preferences\Windows Settings\Ini Files
Folders
Folders in a particular location on the file system.
 
Computer | User Configuration\Preferences\Windows Settings\Folders
Local Users And
Groups
User and group accounts for the local computer.
 
Computer | User Configuration\Preferences\Control Panel Settings\Local Users And
Groups
Network Options
Virtual Private Networking and Dial-up Networking connections
 
Computer | User Configuration\Preferences\Control Panel Settings\Network Options
Network shares
Shares, hidden shares, and administrative shares.
 
Computer or User Configuration\Preferences\Windows Settings\
Printers
Printer configuration and mapping
 
Computer | User Configuration\Preferences\Control Panel Settings\Printers
Registry
Registry keys and values.
 
Computer | User Configuration\Preferences\Windows Settings\Registry
Scheduled Tasks
Scheduled tasks for automation
 
Computer | User Configuration\Preferences\Control Panel Settings\Scheduled Tasks
Services
System services
 
Computer Configuration\Preferences\Control Panel Settings\Services
Shortcuts
Shortcuts for file system objects, URLs, or shell objects.
 
Computer | User Configuration\Preferences\Windows Settings\Shortcuts
Through special preferences for Control Panel, you can also manage various aspects of the
Windows graphical user interface (GUI). You can use these special preferences to manage:
Folder settings as if you were using the options available in the Folder Options utility
in Control Panel. Located in Computer | User Configuration\Preferences\Control
Panel Settings\Folder Options.
Internet settings as if you are using the options available in the Internet Options

utility in Control Panel. Located in User Configuration\Preferences\Control Panel
Settings\Internet Settings.
Power plans and power management options as if you were using the related utilities
in Control Panel. Located in Computer | User Configuration\Preferences\Control
Panel Settings\Power Plan.
Regional and language settings as if you were using the options available in the
Regional And Languages utility in Control Panel. Located in User
Configuration\Preferences\Control Panel Settings\Regional Options.
Start menu as if you were using the Start Menu Properties dialog box. Located in
User Configuration\Preferences\Control Panel Settings\Start Menu.

Choosing Between Preferences and Settings
Because some management areas overlap between policy preferences and policy settings,
you can sometimes perform a particular task in more than one way. For example, using
policy settings, you can identify logon scripts that should be used. Within these scripts,
you can map network drives, configure printers, create shortcuts, copy files and folders,
and perform other tasks. Using policy preferences however, you could perform these same
tasks without the need of using logon scripts. So which one should you use? Well, the
truth is that there really isn’t one right answer. It depends on what you want to do. In the
following sections, I describe some general guidelines for specific areas of overlap.
Real World  When a conflict occurs between a policy setting and a policy
preference defined in a particular GPO, a registry-based policy setting will normally
win. For conflicts between non-registry-based policy settings and preferences, the
last value written wins (as determined by the order in which the client-side
extensions for policy settings and preferences are processed). Determining whether a
policy setting is registry-based or not is easy. All registry-based policy settings are
defined in administrative templates.
Controlling Device Installation
Through policy settings, you can control device installation and enforce specific
restrictions. The goal is to prevent users from installing specific types of hardware
devices. You can specify that certain approved devices can be installed (according to the
hardware ID of the device). You can also prevent installation of specific disapproved
devices (again according to the hardware ID of the device). These policy settings are
found under Computer Configuration\Policies\Administrative Templates\System\Device
Installation\Device Installation Restrictions.
While restrictions block the installation of a new device or prevent a device from being
plugged back in after it has been unplugged, it doesn’t prevent existing devices from being
used. Why? The device drivers are already installed and the devices are already available,
and because the device or drive isn’t rechecked, it continues to work.
Using policy preferences, you can disable device classes, individual devices, port classes,
and individual ports, but you cannot prevent a driver from loading. You disable devices by
selecting a device class or device already installed on your management computer. You
disable ports by selecting a port class or specific port already in use on your management
computer. The related preferences are found under Computer | User
Configuration\Preferences\Control Panel Settings\Devices.
While you can disable devices and ports using preferences, this doesn’t prevent device
drivers from installing. It also doesn’t prevent a user with appropriate rights from enabling
ports or devices in Device Manager. However, as Group Policy by default refreshes policy
preferences using the same refresh interval as for policy settings, the preference would be
reapplied during the next refresh interval. Therefore, unless you specifically elect to apply
the preference once and not reapply it, the preference would be reapplied every 90 to 120
minutes.
Given how these technologies work, the best solution for your environment may depend

on your goal. If you want to completely lock things down and prevent specific devices
from being installed and used, you may want to use both policy settings and policy
preferences to do the job. Policy settings could prevent specific devices from being
installed, providing they weren’t already installed. Policy preferences could disable
devices already installed, providing that you’ve already installed the device on your
management computer so it can be selected.
Controlling Files and Folders
Through policy settings, you can specify security permissions for files and folders. The
goal is to establish specific access control lists (ACLs) for important files and folders.
However, the files and folders must already exist on the target computers so that the ACLs
can be applied. These policy settings apply to any computer that supports Group Policy
and are found under Computer Configuration\Policies\Windows Settings\Security
Settings\File System.
Using policy preferences, you can manage files and folders. Preferences for files work
differently than preferences for folders. With files, you can create, update, or replace a file
on a target computer by copying it from a source computer. You can also delete a file on a
target computer. With folders, you can create, update, replace, or delete a folder in a
specific location on a target computer. You can also specify whether to delete existing files
and subfolders during the create, update, replace, or delete operation.
File and folder preferences apply to any computer on which the client-side extensions for
Group Policy Preferences are installed. For files, the related preferences are found under
Computer | User Configuration\Preferences\Windows Settings\Files. For folders, the
related preferences are found under Computer | User Configuration\Preferences\Windows
Settings\Folders.
Tip  Group Policy also provides preferences for working with .ini files and
shortcuts. Preferences for .ini files are limited to modifying values for designated
properties within a specific section of the .ini file. Shortcut preferences are used to
create shortcuts to files, folders, URLs, and shell objects in a specific location, such
as the desktop.
Here, using policy settings and preferences together gives you the best of both worlds.
Through preferences you have an easy way to copy files from a source computer to target
computers and to manage folders. Through settings you have an easy way to apply desired
security settings. Additionally, with files and folders, you might want to apply preferences
only once and not reapply them. Otherwise, the create, update, replace, or delete
operations will be reapplied during Group Policy refresh.
Controlling Internet Explorer
Group Policy offers a wide array of settings and preferences for Internet Explorer. There
are so many options that even a few experts are confused as to what does what. The key
things to focus on are the following:
Policy settings under Computer | User Configuration\Policies\Administrative
Templates\Windows Components\Internet Explorer are primarily meant to control
Internet Explorer behavior. These settings configure browser security enhancements,

help to lockdown Internet security zones and much more.
Preference settings under User Configuration\Preferences\Control Panel
Settings\Internet Settings allow you to configure any of the options available in the
Internet Options utility in Control Panel (which essentially includes every user-
configurable option).
Because policy settings are managed and policy preferences are unmanaged, you can use
policy settings when you want to enforce specific settings for Internet Explorer. Although
you can configure Internet Explorer with preferences, the preferences are not enforced and
users can change settings. That said, if you apply the preferences so that they are refreshed
automatically as part of normal Group Policy refreshes, settings users change may be
overwritten by your preferences.
Controlling Power Options
When you want to control power management settings, the choice between policy settings
and policy preferences is easy. You use policy settings when you want to configure the
way power management works and specify an active power plan. You use policy
preferences when you want to create, replace or remove power plans and specify their
default settings.
The related policy settings are found under Computer
Configuration\Policies\Administrative Templates\System\Power Management. The related
preferences are found under User | Computer Configuration\Preferences\Control Panel
Settings\Power Options.
Controlling Printers
With policy settings, you can deploy printers to computers running any version of
Windows that supports Group Policy. This technology establishes a connection to an
existing shared printer. Use policy settings under User Configuration\Policies\Windows
Settings\Deployed Printers.
With policy preferences, you can map and configure printers. These preferences include
options for configuring local printers as well as for mapping both TCP/IP and shared
network printers. These policy preferences apply to any computer on which the client-side
extensions for Group Policy Preferences are installed.
As printer preferences are much more versatile than printer settings, you’ll probably want
to use preferences to deploy printers. That said, if you’ve already configured printers to be
deployed using policy settings, you don’t need to switch to policy preferences and
redeploy the printers.
Controlling Registry Keys and Values
Through policy settings, you can specify security permissions for registry keys. The goal
is to establish specific access control lists (ACLs) for important registry keys. However,
the registry keys must already exist on the target computers so that the ACLs can be
applied. These policy settings apply to any computer that supports Group Policy and are
found under Computer Configuration\Policies\Windows Settings\Security
Settings\Registry.

Using policy preferences, you can create, update, replace, or delete registry keys. The
related preferences are found under Computer | User Configuration\Preferences\Windows
Settings\Registry. Although you can modify just about any registry key, it is contradictory
to widely manage registry values through preferences. Why? Policy settings defined
within the administrative templates set registry values for you so that you don’t have to
modify the registry directly. You can install additional administrative templates to manage
the registry settings of other applications. If administrative templates aren’t available for a
particular application, you can create your own custom administrative template to manage
the registry settings for the application.
Because of the conflicting goals, I recommend using policy preferences to manage
individual registry keys and only in a limited number of situations. When you need to
work with multiple or many registry keys, you should use preexisting administrative
templates or consider creating your own custom administrative templates. Additionally,
with registry keys, you might want to apply preferences only once and not reapply them.
Otherwise, the create, update, replace, or delete operation will be reapplied during Group
Policy refresh.
Controlling the Start Menu
When it comes to Start, there is a lot of overlap between what you can configure with
policy settings and what you can configure with policy preferences. With this in mind, you
use policy settings and policy preferences to work with Start in very different ways.
Through policy settings, you can control the options available on Start and define the
behavior of various Start options. With dozens of settings to choose from under User
Configuration\Policies\Administrative Templates\Start Menu And Taskbar, there are many
possibilities.
Policy preferences for working with Start are located in User
Configuration\Preferences\Control Panel Settings\Start Menu. With policy preferences,
you manage the options and behavior of Start. There are, however, no options for
configuring the taskbar.
Controlling System Services
When you want to control system services, the choice between policy settings and policy
preferences is easy. You can use policy settings to:
Configure the service startup mode
Specify the access permissions for services (which control who can start, stop, and
pause the service)
Policy settings for services are located under Computer Configuration\Policies\Windows
Settings\Security Settings\System Services.
You can use policy preferences to:
Configure the service startup mode
Configure a service action that can be used to start a stopped service, stop a started
service, or stop and restart a service
Specify the account under which the service runs and set the password for this

account
Specify recovery actions that determine how the service responds to failure
Policy preferences for services are located under Computer
Configuration\Preferences\Control Panel Settings\Services.
Because policy settings are managed and policy preferences are unmanaged, you can use
policy settings when you want to enforce specific startup modes and access permissions.
Although you can configure services with preferences, the preferences are not enforced
and users can change settings. If you apply the preferences so that they are refreshed,
settings users change may be overwritten by your preferences.
Controlling Users and Groups
When you want to control users and groups, the choice between policy settings and policy
preferences is easy. You use policy settings when you want to restrict the membership of
either a group defined in Active Directory or a group on the local computer. You do this
by specifying the members of the group and the groups of which the group is a member.
The related policy settings are found in Computer | User Configuration\Policies\Windows
Settings\Security Settings\Restricted Groups.
You use policy preferences to create, replace, update, or delete users and groups on the
local computer. With local user accounts, you can also:
Rename existing user accounts
Set user account passwords
Set status flags for user accounts
Status flags can be used to require users to change passwords at next log on, disable the
account, or set an expiration date.
With local groups, you can also:
Rename existing groups
Add or remove the current user as a member
Delete member users, member groups, or both
Policy preferences for local users and groups are located under Computer | User
Configuration\Preferences\Control Panel Settings\Local Users And Groups.


Chapter 3. Group Policy Management
The Group Policy Management Console (GPMC) is the primary tool you use to work with
Group Policy. As discussed in Chapter 1, “Introducing Group Policy,” and detailed step by
step in Appendix A, you need to install the GPMC before you can use it, and the
installation technique you use depends on the operating system running on your computer.
As also detailed step by step in Appendix A, you can extend Group Policy in a variety of
ways. If a computer doesn’t already have Group Policy client-side extensions, you may be
able to install the extensions so that you can configure the computer using policy
preferences as well as policy settings.
If you want to manage other applications through Group Policy, such as applications in the
Microsoft Office system, you may be able to install Group Policy templates and add-ons
for the applications. If you want additional control over how Group Policy is used, you
may want to install the client and server components for Advanced Group Policy
Management (AGPM). Advanced Group Policy Management is a set of extensions for the
Group Policy Management Console that adds change control and other features.
In this chapter, you’ll learn techniques you can use to work with the GPMC. In Chapter 4,
“Advanced Group Policy Management,” you’ll learn techniques you can use to take
advantage of the additional features provided by AGPM.


Understanding Resultant Set of Policy
Group Policy applies only to users and computers. Group Policy settings are divided into
two categories: Computer Configuration, which contains settings that apply to computers,
and User Configuration, which contains settings that apply to user accounts. Each
category can be divided further into two general types: policy settings and policy
preferences.
Each general type can be divided further into several major classes of settings, each of
which contains several subclasses of settings. For policy settings, the three major classes
are:
Software Settings For automated deployment of new software and software
upgrades. Also used for uninstalling software.
Windows Settings For managing key Windows settings for both computers and
users, including scripts and security. For users, you can also manage remote
installation services and folder redirection.
Administrative Templates For managing registry settings that configure the
operating system, Windows components, and applications. Administrative templates
are implemented for specific versions of the operating system.
For policy preferences, the two major classes are:
Windows Settings For configuring key Windows settings for both computers and
users, including environment variables, files, folders, registry values, and shortcuts.
For computers, you can also manage network shares. For users, you can also manage
applications and mapped drives.
Control Panel Settings For configuring various options and utilities in the Control
Panel, including data sources, devices, folder options, network options, power
options, and printers. For computers, you can also manage services. For users, you
can also manage Internet settings and Start options.
When the Group Policy client running on a computer applies Group Policy objects (GPOs)
to users and computers, their effects (the end result of inheritance and processing) are
cumulative. These cumulative effects on an individual computer or user are referred to as
the Resultant Set of Policy (RSoP). You’ll need to determine the RSoP for a particular user
or group to learn exactly how policy is being applied.
In the Group Policy Management Console, you can determine the RSoP for a user or
group by using the Group Policy Results Wizard, and you can model policy changes that
you’d like to make by using the Group Policy Modeling Wizard. These wizards are
discussed in the section “Planning Group Policy Changes” in Chapter 7, “Managing
Group Policy Processing.”
Within Active Directory, objects are organized using a hierarchical tree structure called a
directory tree. The structure of the tree is derived from the schema and is used to define
the parent-child relationships of objects stored in the directory. Figure 3-1 shows a
representation of a directory tree for a domain. The domain object is the parent object of
all objects in a domain; as such, it is at the root of the directory tree. The domain object in
turn contains other objects, including other container objects, such as subdomains or
organizational units (OUs), and standard objects, such as users, computers, and printers. In

the figure, na.imaginedlands.com is a subdomain of imaginedlands.com, and this
subdomain has two top-level OUs: Sales and Services.
FIGURE 3-1 The imaginedlands.com domain and its related directory tree.
Active Directory uses Lightweight Directory Access Protocol (LDAP) for querying and
managing objects in the directory. You can locate any object in the directory according to
its LDAP path. The LDAP path to the Sales OU in the na.imaginedlands.com domain is
LDAP://OU=Sales,DC=na,DC=Imaginedlands,DC=COM. Here LDAP:// specifies that
you are using the Lightweight Directory Access Protocol, and
OU=Sales,DC=na,DC=Imaginedlands,DC=COM is the exact location of the Sales OU in
the directory. Each component of the object’s name is shown in the path. (OU stands for
organizational unit, and DC stands for domain component.) The exact path to an object,
excluding the protocol designator, is the object’s distinguished name (DN).
Objects in the directory also have a relative name, referred to as the relative distinguished
name (RDN). The RDN includes only the name component of the object. For example, the
RDN of the Sales OU is OU=Sales. Within the Sales OU, you might have a user, Joe, and
a computer, JoesPC. The RDN of these objects would be CN=Joe and CN=JoesPC,
respectively. CN stands for common name. The DNs of these objects would be
CN=Joe,OU=Sales,DC=na,DC=Imaginedlands,DC=COM and
CN=JoesPC,OU=Sales,DC=na,DC=Imaginedlands,DC=COM, respectively.
The DN identifies an object’s place within the directory. Not only does the DN tell you the
exact containers in which the object is stored, but it also tells you the relationship of those
containers to each other. The relationship of container objects is extremely important when
it comes to applying Group Policy. When you know where an object is in the directory
tree and in which container object it resides, you can determine the GPOs that would
typically be applied to the object. That said, it is important to keep in mind that Group
Policy is not inherited from parent to child domains and that an object’s DN does not
indicate the site in which the object is located.

Real World  Inheritance works differently within and between domains. Within a
domain, top-level GPOs are inherited automatically by lower-level GPOs, which
means the domain GPO is automatically inherited by OUs. The domain GPO and
the GPO of a top-level OU are inherited by a second-level OU, and so on. Between
parent and child domains, inheritance is not automatic. A child domain does not
automatically inherit the GPO of the parent domain. Microsoft recommends that you
avoid assigning GPOs across domains because if Group Policy is obtained from
another domain, the processing of Group Policy objects could slow the startup and
logon processes. Therefore, inheritance of child domains is rarely enforced.
Although the directory path tells you about most of the containers that might have GPOs
that affect a user or computer, it doesn’t tell you about all the GPOs that could possibly
apply. One important piece is missing, and it has to do with sites.
You use sites to map your network’s physical structure. Because site mappings are
separate and independent from logical components in the directory, there’s no necessary
relationship between your network’s sites and the domains in the directory. A domain can
span one or more sites. A single site also can span multiple domains.
Figure 3-2 shows a deeper view of the na.imaginedlands.com domain and the objects
within it. As you can see, this domain has two sites associated with it:
Toronto Site This site has two OUs—Sales and Support—and has several
resources that are physically located within it. Sales, a top-level OU, has two
computer objects and one user object associated with it. Support, a child OU of Sales,
has one computer object and one user object associated with it. CorpSvr01 is a
domain controller. JoesPC and TimsPC are workstations.
NY Site This site has one OU, Services, and has several resources physically
located within it. Services, a top-level OU with no child OUs, has three computer
objects and two user objects associated with it. CorpSvr02 is a domain controller.
SallysPC and RonsPC are workstations.

FIGURE 3-2 A sampling of objects within the na.imaginedlands.com domain.
Based on this diagram, you know exactly which objects are stored in the directory and in
which containers. You also know which sites are associated with which objects, and this
gives you the complete picture of which GPOs will be applied to which objects. Since you
know that computers and users are also affected by a local machine GPO (the LGPO), you
now know that JoesPC would be affected by the following GPOs and in the following
order:

1.                  The local machine GPO for the computer
2.                  The GPO for the Toronto site
3.                  The GPO for the na.imaginedlands.com subdomain
4.                  The GPO for the Sales OU
The user, Joe, would be affected by the same GPOs, which would be applied in the same
order to set permitted actions and limitations on his account.
Continuing the example and excluding LGPOs, you can determine how GPOs affect
computers and users.
At the site level, any GPOs linked to the Toronto site affect JoesPC, Joe, CorpSvr01,
TimsPC, and Tim. Any GPOs linked to the NY site affect SallysPC, Sally, RonsPC,
Ron, and CorpSvr02.
At the domain level, any GPOs linked to the na.imaginedlands.com domain affect
JoesPC, Joe, CorpSvr01, TimsPC, Tim, SallysPC, Sally, RonsPC, Ron, and
CorpSvr02.
At the OU level, any GPOs linked to the Sales OU affect JoesPC, Joe, and
CorpSvr01. Any GPOs linked to the Support OU affect TimsPC and Tim. Any GPOs
linked to the Services OU affect SallysPC, Sally, RonsPC, Ron, and CorpSvr02.
Again, excluding LGPOs, you could also say that the RSoP for these objects is as follows:
Joe The RSoP for Joe flows from the Toronto site to na.imaginedlands.com and
then the Sales OU.
JoesPC The RSoP for JoesPC flows from the Toronto site to na.imaginedlands.com
and then the Sales OU.
CorpSvr01 The RSoP for CorpSvr01 flows from the Toronto site to
na.imaginedlands.com and then the Sales OU.
Sally The RSoP for Sally flows from the NY site to na.imaginedlands.com and then
the Services OU.
SallysPC The RSoP for SallysPC flows from NY site to na.imaginedlands.com and
then the Services OU.
Ron The RSoP for Ron flows from the NY site to na.imaginedlands.com and then
the Services OU.
RonsPC The RSoP for RonsPC flows from the NY site to na.imaginedlands.com
and then the Services OU.
CorpSvr02 The RSoP for CorpSvr02 flows from the NY site to
na.imaginedlands.com and then the Services OU.
Tim The RSoP for Tim flows from the Toronto site to na.imaginedlands.com, Sales
OU, and then the Support OU.
TimsPC The RSoP for TimsPC flows from the Toronto site to
na.imaginedlands.com, Sales OU, and then the Support OU.
When you look at RSoP, it’s also important to consider what will happen when changes
are made: for example, if Sally visits the Toronto office and logs on to JoesPC, or if Tim
from Support goes to New York and logs on to RonsPC. Here is what happens with regard

to Group Policy:
Sally in Toronto logging on to JoesPC JoesPC is subject to the Computer
Configuration settings in the GPOs for the Toronto site, na.imaginedlands.com, and
the Sales OU. Sally (logging on to JoesPC while in Toronto) is subject to the User
Configuration settings in the GPOs for the NY Site, na.imaginedlands.com, and the
Services OU. By default, the User Configuration settings in the GPOs that apply to
Sally have precedence.
Tim in New York logging on to RonsPC RonsPC is subject to the Computer
Configuration settings in the GPOs for the NY site, na.imaginedlands.com, and the
Services OU. Tim (logging on to RonsPC while in New York) is subject to the User
Configuration settings in the GPOs for the Toronto site, na.imaginedlands.com, the
Sales OU, and the Support OU. By default, the User Configuration settings in the
GPOs that apply to Tim have precedence.
Moving CorpSvr01 into the Support OU CorpSvr01 (when it is moved into the
Support OU) is subject to the GPOs for the Toronto site, na.imaginedlands.com, the
Sales OU, and the Support OU. By default, the policy settings for the Support OU
have precedence.
Tip  In this section I’ve focused on policy processing across sites and domains.
While policy is processed in this way within a single forest, policy processing does
not work this way across forests. To learn how policy is processed across forests, see
“Policy Processing Across Forests” in Chapter 8 “Maintaining and Restoring Group
Policy.”


Managing Local Group Policies
As discussed in the section “GPO Types” in Chapter 2, “Deploying Group Policy,” current
releases of Windows and Windows Server allow the use of multiple Local Group Policy
objects (LGPOs) on a single computer (as long as the computer is not a domain
controller). Previously, computers had only one LGPO.
When computers are being used in a stand-alone configuration rather than a domain
configuration, you may find that multiple LGPOs are useful because you no longer have to
explicitly disable or remove settings that interfere with your ability to manage a computer
before performing administrator tasks. Instead, you can implement one LGPO for
administrators and another LGPO for nonadministrators.
When computers are being used in a domain configuration, however, you might not want
to use multiple LGPOs. In domains, most computers and users already have multiple
GPOs applied to them. Adding multiple LGPOs to this already varied mix can make
managing Group Policy confusing. For this reason, you might want to disable processing
of LGPOs. As discussed in “GPO Types” in Chapter 2, you can use the Turn Off Local
Group Policy Objects Processing setting under Computer
Configuration\Policies\Administrative Templates\System\Group Policy to disable or
enable processing of LGPOs.
To work with LGPOs, you must use an administrator account. In a domain, you can use an
account that is a member of the Enterprise Admins, Domain Admins, or the
Administrators domain local group. In a workgroup, you must use an account that is a
member of the local Administrators group.

Working with Top-Level LGPOs
With the exception of domain controllers, all computers running Windows have an
editable LGPO. The quickest way to access the LGPO on a local computer is to enter the
following command at a command prompt:
gpedit.msc /gpcomputer: “%ComputerName%”
This command starts the Group Policy Management Editor in a Microsoft Management
Console (MMC) with its target set to the local computer. Here, %ComputerName% is an
environment variable that sets the name of the local computer and must be enclosed in
double quotation marks as shown. To access the top-level LGPO on a remote computer,
enter the following command at a command prompt:
gpedit.msc /gpcomputer: “RemoteComputer”
where RemoteComputer is the host name or fully qualified domain name (FQDN) of the
remote computer. Again, the double quotation marks are required, as shown in the
following example:
gpedit.msc /gpcomputer: “corpsvr24”
You can also manage the top-level LGPO on a computer by following these steps:
1.                  Type mmc into the Search box, and then select mmc in the results.
2.                  In the Microsoft Management Console, click File and then click
Add/Remove Snap-In.
3.                  In the Add Or Remove Snap-Ins dialog box, click Group Policy Object
Editor and then click Add.
4.                  In the Select Group Policy Object dialog box, click Finish (because the
local computer is the default object). Click OK.
Note  When you are working with Start, you can begin a search simply by typing
the search text. From the desktop, you must display the Charm bar and then click
Search.
You can now manage the local Group Policy settings using the options provided. Because
local policy does not have policy preferences, you will not find separate Policies and
Preferences nodes under Computer Configuration and User Configuration. (See Figure 3-
3.)
FIGURE 3-3 Manage local policy settings.
Tip  You can use the same MMC to manage more than one LGPO. In the Add Or
Remove Snap-Ins dialog box, you simply add one instance of the Local Group

Policy Object Editor for each object you want to work with.
Because LGPOs have only policy settings, you cannot manage policy preferences using
LGPOs. The policy settings you can manage locally depend on whether the computer is a
member of a domain or a workgroup, and they include the following:
Account policies for passwords, account lockout, and Kerberos
Local policies for auditing, user rights assignment, and security options
Event logging options for configuring log size, access, and retention options for the
Application, System, and Security logs
Security restriction settings for groups, system services, registry keys, and the file
system
Security settings for wireless networking, public keys, and Internet Protocol Security
(IPSec)
Software restrictions that specify applications that aren’t allowed to run on the
computer
Default LGPOs are stored in the %SystemRoot%\System32\GroupPolicy folder on each
computer. In this folder you’ll find the following subfolders:
Machine Stores computer scripts in the Script folder and registry-based policy
information for HKEY_LOCAL_MACHINE (HKLM) in the Registry.pol file.
User Stores user scripts in the Script folder and registry-based policy information
for HKEY_CURRENT_USER (HKCU) in the Registry.pol file.
You shouldn’t edit these folders and files directly. Instead, you should use the appropriate
features of one of the Group Policy management tools. Using the Group Policy Object
Editor, you can configure local Group Policy in the same way that you configure Active
Directory–based group policy. To apply a policy, you enable it and then configure any
additional or optional values as necessary. An enabled policy setting is turned on and
active. If you don’t want a policy to apply, you must disable it. A disabled policy setting is
turned off and inactive. The enforcement or blocking of inheritance can change this
behavior, as detailed in “Managing Group Policy Inheritance” in Chapter 7.
Tip  By default, policy files and folders are hidden. If you want to view hidden
files and folders in File Explorer, click the View tab, and choose Show Hidden Files
And Folders, clear Hide Protected Operating System Files (Recommended).

Working with Other LGPOs
With the exception of domain controllers, all computers running Windows have an
editable LGPO. By default, the only local policy object that exists on a computer is the
Local Group Policy object. You can create and manage other local objects as necessary.
You can create or access the Administrator Local Group Policy object or the Non-
Administrator Local Policy Group object by following these steps:
1.                  Type mmc into the Search box, and then select mmc in the results. In the
Microsoft Management Console, click File and then click Add/Remove Snap-In.
Note  When you are working with Start, you can begin a search simply by typing
the search text. From the desktop, you must display the Charm bar and then click
Search.
2.                  In the Add Or Remove Snap-Ins dialog box, click Group Policy Object
Editor, and then click Add.
3.                  In the Select Group Policy Object dialog box, click Browse. In the Browse
For A Group Policy Object dialog box, click the Users tab.
4.                  On the Users tab, shown in Figure 3-4, the entries in the Group Policy
Exists column specify whether a particular local policy object has been created. Do
one of the following:
Select Administrators to create or access the Administrator Local Group Policy
object.
Select Non-Administrators to create or access the Non-Administrator Local Group
Policy object.
Select the local user whose User-Specific Local Group Policy object you want to
create or access.
FIGURE 3-4 Select the type of local policy object to create or work with.
5.                  Click OK. If the selected object doesn’t already exist, it will be created.
Otherwise, you’ll open the existing object for review and editing.
Policy settings for administrators, nonadministrators, and users are stored in the
%SystemRoot%\System32\GroupPolicyUsers folder. Because these LGPOs only apply to
user configuration settings, user-specific policy settings under

%SystemRoot%\System32\GroupPolicyUsers have only a User subfolder, and this
subfolder stores user scripts in the Script folder and registry-based policy information for
HKEY_CURRENT_USER (HKCU) in the Registry.pol file.


Managing Active Directory–Based Group Policy
Active Directory–based Group Policy is available when Active Directory Domain
Services (AD DS) is installed. Each site, domain, and organizational unit can have one or
more group policies. Group policies listed higher in the Group Policy list have greater
precedence than policies listed lower in the list. This ensures that policies are applied
appropriately throughout the related sites, domains, and organizational units.

Working with GPOs in Sites, Domains, and OUs
When you want to work with Active Directory–based Group Policy, you’ll find that each
domain in your organization has two default GPOs: Default Domain Controllers Policy
GPO and Default Domain Policy GPO. The default GPOs are essential to the proper
operation and processing of Group Policy. By default, the Default Domain Controllers
Policy GPO has the highest precedence among GPOs linked to the Domain Controllers
organizational unit, and the Default Domain Policy GPO has the highest precedence
among GPOs linked to the domain.
Site, domain, and organizational unit group policies are stored in the
%SystemRoot%\Sysvol\Domain\Policies folder on domain controllers. In this folder
you’ll find one subfolder for each policy you’ve defined on the domain controller. The
policy folder name is the policy’s globally unique identifier (GUID). You can find the
policy’s GUID on the policy’s Properties page on the General tab in the Summary frame.
Within these individual policy folders, the subfolders you’ll find include:
Machine Stores computer scripts in the Script folder and registry-based policy
information for HKEY_LOCAL_MACHINE (HKLM) in the Registry.pol file.
User Stores user scripts in the Script folder and registry-based policy information
for HKEY_CURRENT_USER (HKCU) in the Registry.pol file.
As with files for local policies, do not edit these folders and files directly. Instead, use the
appropriate features of one of the Group Policy management tools. The best way to
manage Active Directory–based Group Policy is with the Group Policy Management
Console. You can use the GPMC to manage policy settings in accordance with your
administrative privileges. The account you use must be a member of the Enterprise
Admins or Domain Admins group or have been delegated permissions to work with
specific aspects of Group Policy.
Members of Enterprise Admins can manage policy settings for the specific forest of which
they are a member. For example, if the user account WilliamS is a member of the
Enterprise Admins group in the imaginedlands.com forest, WilliamS can manage the
policy settings for any child domain in the imaginedlands.com domain as well as the
parent domain (imaginedlands.com). This means he can manage the policy settings for
tech.imaginedlands.com, cs.imaginedlands.com, and imaginedlands.com.
Members of Domain Admins can manage policy settings for the specific domain of which
they are a member. For example, if the user account WilliamS is a member of the Domain
Admins group in the tech.imaginedlands.com domain, WilliamS can manage the policy
settings for the tech.imaginedlands.com domain, but he cannot manage policy settings for
cs.imaginedlands.com or imaginedlands.com. He can manage the policy settings for other
domains only if he has Domain Admins privileges in those domains (or Enterprise Admins
privileges for the forest).
When you work with delegated administrative permissions, keep in mind that the account
has only the specific permissions that were delegated. Delegated permissions for Group
Policy include:
Permission to manage Group Policy links

Permission to generate RSoP for the purposes of logging
Permission to generate RSoP for planning purposes
These delegated permissions are separate from AGPM roles, which I’ll discuss in
“Delegating Change Control Privileges” in Chapter 4. AGPM roles delegate privileges
within the change control framework.
You manage Active Directory–based Group Policy by using the Group Policy
Management Console. Once you install the GPMC, you can run it from the Tools menu in
Server Manager. Click Tools, and then click Group Policy Management.
As shown in Figure 3-5, the left pane of the GPMC has two top-level nodes by default:
Group Policy Management (the console root) and Forest (a node representing the forest to
which you are currently connected, which is named after the forest root domain for that
forest). When you expand the Forest node, you see the following nodes:
Domains Provides access to the policy settings for domains in the forest being
administered. You are connected to your logon domain by default; you can add
connections to other domains. If you expand a domain, you can access the Default
Domain Policy GPO, the Domain Controllers OU (and the related Default Domain
Controllers Policy GPO), and GPOs defined in the domain.
Sites Provides access to the policy settings for sites in the related forest. Sites are
hidden by default.
Group Policy Modeling Provides access to the Group Policy Modeling Wizard,
which helps you plan policy deployment and simulate settings for testing purposes.
Any saved policy models are also available.
Group Policy Results Provides access to the Group Policy Results Wizard. For
each domain to which you are connected, all the related GPOs and OUs are available
to work with in one location.
FIGURE 3-5 Access GPOs for domains, sites, and OUs.
GPOs found in domain, site, and OU containers in the GPMC are actually GPO links and
not the GPOs themselves. The actual GPOs are found in the Group Policy Objects
container of the selected domain. It is also helpful to note that the icons for GPO links
have a small arrow at the bottom left, similar to shortcut icons.

Accessing Additional Forests
The GPMC is designed to work with multiple forests, domains, and sites. When you start
the GPMC for the first time, you are connected to your logon domain and forest. You can
connect to additional forests by taking the following steps:
1.                  Open the GPMC by clicking the Tools menu in Server Manager, and then
clicking Group Policy Management Console. Or enter gpmc.msc at a command
prompt.
2.                  Right-click the Group Policy Management node in the console tree, and
then select Add Forest.
3.                  In the Add Forest dialog box, enter the name of a domain in the forest to
which you want to connect, and then click OK.
As long as there is an external trust to the domain, you can establish the connection and
obtain forest information—even if you don’t have a forest trust with the entire forest.
From now on, when you start the Group Policy Management Console, the additional forest
should be listed.

Showing Sites in Connected Forests
The GPMC doesn’t show available sites by default. If you want to work with the sites in a
particular forest, follow these steps:
1.                  Open the GPMC by clicking the Tools menu in Server Manager, and then
clicking Group Policy Management Console. Or enter gpmc.msc at a command
prompt.
2.                  Expand the entry for the forest you want to work with by clicking the
related node. Right-click the related Sites node, and then click Show Sites.
3.                  In the Show Sites dialog box, shown in Figure 3-6, select the check boxes
for the sites you want to work with and clear the check boxes for the sites you don’t
want to work with. Click OK.
FIGURE 3-6 Select the sites to display in the GPMC.
From now on, when you start the GPMC, the additional site or sites should be listed under
the Sites node, as shown in Figure 3-7.
FIGURE 3-7 Access the sites in the GPMC.

Accessing Additional Domains
In the GPMC, you can view the domains to which you are connected on a per-forest basis.
You are connected to your logon domain and forest by default. To work with other
domains in a particular forest, follow these steps:
1.                  Open the GPMC by clicking the Tools menu in Server Manager, and then
Group Policy Management Console. Or enter gpmc.msc at a command prompt.
2.                  Expand the entry for the forest you want to work with, and then expand the
related Domains node by double-clicking the node.
3.                  If the domain you want to work with isn’t listed, right-click the Domains
node in the designated forest, and then click Show Domains.
4.                  In the Show Domains dialog box, select the check boxes for the domains
you want to work with and clear the check boxes for the domains you don’t want to
work with. Click OK.
From now on, when you start the GPMC, the additional domain or domains should be
listed under the Domains node in the currently selected forest.

Setting Domain Controller Focus Options
When you start the GPMC, the console connects to Active Directory running on the
domain controller that is acting as the PDC emulator for your logon domain and obtains a
list of all GPOs and OUs in that domain. It does this by using LDAP to access the
directory store and the Server Message Block (SMB) protocol to access the SYSVOL. If
the PDC emulator isn’t available for some reason, such as when the server is down or
otherwise offline, the GPMC displays a prompt that lets you choose to work with policy
settings on the domain controller to which you are currently connected or on any available
domain controller. If you want to force the GPMC to work with a domain controller other
than the PDC, you can configure this manually as well. This process is referred to as
setting the domain controller focus.
You can choose the domain controller to work with on a per-domain basis:
1.                  Open the GPMC by clicking the Tools menu in Server Manager, and then
Group Policy Management Console. Or enter gpmc.msc at a command prompt.
2.                  Expand the entry for the forest you want to work with, and then expand the
related Domains node by double-clicking the related node.
3.                  Right-click the domain for which you want to set the domain controller
focus, and then click Change Domain Controller to open the Change Domain
Controller dialog box, shown in Figure 3-8.
4.                  The domain controller to which you are currently connected is listed under
Current Domain Controller. Use the following Change To options to set the domain
controller focus, and then click OK.
The Domain Controller With The Operations Master Token For The PDC
Emulator Choose this option if you aren’t connected to the PDC emulator for
some reason and want to try to establish a connection to this server at this time. For
example, if the PDC emulator was offline for maintenance and is now online, you
might want to try to reconnect to it.

FIGURE 3-8 Set the domain controller focus.
Any Available Domain Controller Choose this option to connect to any
available domain controller. Use this option if you don’t need to work with a
domain controller running a specific version of the Windows server operating
system.
Any Available Domain Controller Running Windows Server 2003 Or
Later Choose this option if you need to work with a domain controller that is
running Windows Server 2003 or later.
This Domain Controller Choose this option and then make a selection in the
Domain Controllers area if you want to work with a specific domain controller. The
site where each domain controller resides is listed as well, so you can work with a
domain controller in a particular site if necessary.


Delegating Privileges for Group Policy Management
In Active Directory, administrators are automatically granted permissions for performing
different Group Policy management tasks. Other individuals can be granted such
permissions through delegation. In Active Directory, you delegate Group Policy
management permissions for very specific reasons. You delegate permissions to allow a
user who is not a member of Enterprise Admins or Domain Admins to perform any or all
of the following tasks:
View settings, change settings, delete a GPO, and modify security
Manage links to existing GPOs or generate RSoP
Create GPOs (and therefore also be able to manage any GPOs she has created)
Any privileges you delegate in this way are outside the change controls provided by
AGPM and discussed in “Using Change Control” in Chapter 4. If you plan to use AGPM
change controls, you’ll want to limit and carefully monitor privileges delegated for Group
Policy management.

Determining and Assigning GPO Creation Rights
In Active Directory, administrators have the ability to create GPOs in domains, and
anyone who has created a GPO in a domain has the right to manage that GPO. To
determine who can create GPOs in a domain, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Select the Group Policy Objects node. As shown in Figure 3-9, the users
and groups who can create GPOs in the selected domain are listed on the
Delegation tab.
FIGURE 3-9 Check permissions for GPO creation.
You can allow a nonadministrative user or a group (including users and groups from other
domains) to create GPOs (and thus implicitly grant them the ability to manage the GPOs
they’ve created). To grant GPO creation permission to a user or group, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Select the Group Policy Objects node. In the right pane, select the
Delegation tab. The current GPO creation permissions for individual users and
groups are listed. To grant the GPO creation permission to another user or group,
click Add.
4.                  In the Select User, Computer, Or Group dialog box, select the user or
group you want to grant permissions to and then click OK.
The list of users and groups on the Delegation tab are updated as appropriate. If you want
to remove the GPO creation permission in the future, access the Delegation tab, click the

user or group, and then click Remove.

Determining Group Policy Management Privileges
The GPMC provides several ways to determine who has access permissions for Group
Policy management. To determine Group Policy permissions for a specific site, domain, or
OU, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with, and
then expand the related Domains or Sites node as appropriate.
2.                  When you select the domain, site, or OU you want to work with, the right
pane is updated with several tabs. Select the Delegation tab, as shown in Figure 3-
10.
FIGURE 3-10 Check permissions for sites, domains, or OUs.
3.                  In the Permission list, select the permission you want to check. The
options are:
Link GPOs The user or group can create and manage links to GPOs in the
selected site, domain, or OU.
Perform Group Policy Modeling Analyses The user or group can determine the
RSoP for the purposes of planning.
Read Group Policy Results Data The user or group can determine the RSoP that
is currently being applied for the purposes of verification or logging.
The individual users or groups with the selected permissions are listed under Groups
And Users.
To determine which users or groups have access to a particular GPO and what permissions
have been granted to them, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Expand the Group Policy Objects node. When you select the GPO whose
permissions you want to check, the right pane is updated with several tabs. Select

the Delegation tab, as shown in Figure 3-11.
FIGURE 3-11 Check permissions for specific GPOs.
The permissions for individual users and groups are listed. You’ll see three general
types of allowed permissions:
Read The user or group can view the GPO and its settings.
Edit Settings The user or group can view the GPO and its settings and can also
change settings. The user or group cannot delete the GPO or modify security.
Edit Settings, Delete, Modify Security The user or group can view the GPO and
its settings and can also change settings, delete the GPO, and modify security.
When you select a group on the Delegation tab, you can click the Properties button to
display a Properties dialog box and get more information about the group. The tabs in the
Properties dialog box provide the following information:
General Shows the group name, description, and e-mail address (if applicable).
Also shows the group type and scope.
Members Shows the users and groups that are members of the selected group.
Allows you to add and remove group members (providing you have appropriate
permissions in the domain).
Member Of Shows the groups that the selected group is a member of. Allows you
to add and remove group memberships (providing you have appropriate permissions
in the domain).
Managed By Shows information about a user who has been designated as the
manager of the selected group. Clicking Change allows you to designate or change
the manager assignment. If a manager is assigned, you can click Properties to view
the properties of the manager’s account or click Clear to remove the manager.

Delegating Control for Working with GPOs
You can allow a nonadministrative user or a group (including users and groups from other
domains) to work with a domain, site, or OU GPO by granting one of three specific
permissions:
Read Allows the user or group to view the GPO and its settings.
Edit Settings Allows the user or group to view the GPO and its settings and also
change settings. The user or group cannot delete the GPO or modify security.
Edit Settings, Delete, Modify Security Allows the user or group to view the GPO
and its settings and also change settings, delete the GPO, and modify security.
To grant these permissions to a user or group, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Select the Group Policy Objects node, and then select the GPO you want
to work with in the left pane. In the right pane, select the Delegation tab.
4.                  The current permissions for individual users and groups are listed. To grant
permissions to another user or group, click Add.
5.                  In the Select User, Computer, Or Group dialog box, enter the name of the
user or group and then click Check Names. After you select the correct account,
click OK.
6.                  In the Add Group Or User dialog box, shown in Figure 3-12, select the
permission to grant: Read; Edit Settings; or Edit Settings, Delete, Modify Security.
Click OK.
FIGURE 3-12 Grant permission to the user or group.
The list of users and groups on the Delegation tab is updated to reflect the permissions
granted. If you want to remove this permission in the future, display the Delegation tab,
click the user or group, and then click Remove.
Note  The best way to delegate authority is to use the Add and Remove options on
the Delegation tab. That said, you can click the Advanced button to view and
manage advanced security settings directly. Clicking the Advanced button displays

the Security Settings dialog box for the GPO. In this dialog box, you can select users
or groups that currently have permissions to view or change their advanced security
permissions. You also can add or remove users and groups.

Delegating Authority for Managing Links and RSoP
You can allow a nonadministrative user or a group (including users and groups from other
domains) to manage GPO links and RSoP. The related permissions can be granted in any
combination and are defined as follows:
Link GPOs Allows the user or group to create and manage links to GPOs in the
selected site, domain, or OU.
Perform Group Policy Modeling Analyses Allows the user or group to determine
RSoP for the purposes of planning.
Read Group Policy Results Data Allows the user or group to determine the RSoP
that is currently being applied for the purposes of verification or logging.
To grant these permissions to a user or group, follow these steps:
1.                  In GPMC, expand the entry for the forest you want to work with, and then
expand the related Domains or Sites node as appropriate.
2.                  In the left pane, select the domain, site, or OU you want to work with. In
the right pane, select the Delegation tab.
3.                  In the Permission list, select the permission you want to grant (see Figure
3-13). The options are Link GPOs, Perform Group Policy Modeling Analyses, and
Read Group Policy Results Data.
FIGURE 3-13 Select the permission to view or grant.
4.                  The current permissions for individual users and groups are listed. To grant
the selected permission to another user or group, click Add.
5.                  In the Select User, Computer, Or Group dialog box, enter the name of the
user or group and then click Check Names. After you select the correct account,
click OK.
6.                  In the Add Group Or User dialog box, shown in Figure 3-14, specify how
the permission should be applied. To apply the permission to the current container
and all child containers, select This Container And All Child Containers.
Otherwise, select This Container Only. Click OK.

FIGURE 3-14 Grant the permission to this container only or to the container and its child
containers.
The list of users and groups on the Delegation tab are updated to reflect the permissions
granted. If you want to remove this permission in the future, display the Delegation tab,
click the user or group, and then click Remove.
Note  As when you are working with the Delegation tab for individual GPOs, you
have Properties and Advanced options. Clicking Properties allows you to view and
manage the properties of a selected group. Clicking Advanced allows you to view
and manage advanced security settings for the domain.


Managing Your GPOs in Production
When you’ve deployed AGPM in a domain, your GPOs are either controlled or
uncontrolled. With controlled GPOs, you have offline copies of GPOs as well as live
GPOs in production, and you also have additional management options, as discussed in
“Managing Controlled GPOs” in Chapter 4.
Regardless of whether you’ve deployed AGPM, there are certain tasks that you’ll use to
manage your GPOs in the live production environment. These tasks include:
Using starter GPOs
Creating and linking GPOs
Determining where GPOs are linked
Enabling, disabling, and removing GPOs
Enabling, disabling, and removing GPO links
This section discusses these tasks as they relate to production GPOs.

Using Starter GPOs
When you create a GPO in the Group Policy Management Console, you can base the new
GPO on a starter GPO (except when working with the Change Control node). This allows
you to use a starter GPO to define baseline settings for the new GPO. However, starter
GPOs only store policy settings within the administrative templates. They do not store
other types of policy settings, and they do not store any policy preferences.
Real World  In the enterprise, you can create different categories of starter GPOs,
basing them on the users and computers they will be used with or on required
security configurations. Although starter GPOs are limited to settings in
administrative templates, you can modify the settings you’ve defined at any time. In
contrast, AGPM provides GPO templates. A template is a predefined GPO that you
use to create a baseline for new GPOs. Unlike starter GPOs, GPO templates store
both policy preferences and policy settings. While this makes GPO templates more
versatile than starter GPOs, you cannot edit a GPO template after you create it. For
more information, see “Creating GPO Templates” in Chapter 4.
Starter GPOs are stored in a separate folder in the SYSVOL. Because this folder is not
created by default, you must create the folder if you want to use starter GPOs. Because
each domain has a separate starter GPO folder, you must create the starter folder in each
domain where you will use starter GPOs.
To create the starter GPO folder in a domain, follow these steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Select the Starter GPOs node. If the starter GPO folder has not been
created, the details pane will state this, as shown in Figure 3-15.
FIGURE 3-15 Check the status of the starter GPO folder.
4.                  If the starter folder hasn’t been created yet, click Create Starter GPOs
Folder.

To create a starter GPO, follow these steps:
1.                  In the GPMC, right-click the Starter GPOs node, and then select New.
2.                  In the New Starter GPO dialog box, shown in Figure 3-16, enter a
descriptive name for the new starter GPO, such as Standard User GPO. If desired,
enter comments describing the GPO’s purpose. Click OK.
FIGURE 3-16 Create a starter GPO.
You can work with starter GPOs in much the same way that you work with standard
GPOs. You can:
Edit starter GPOs Right-click the starter GPO, and then choose Edit. In the Group
Policy Management Editor, configure policy settings as necessary, and then close the
Group Policy Management Editor.
Create a new GPO from a starter GPO While you are working with the Starter
GPOs node, you can create a new GPO from a starter GPO by right-clicking the
starter GPO and selecting New GPO From Starter GPO.
Delete starter GPOs With the Starter GPOs node selected, right-click the starter
GPO, and then choose Delete. When prompted to confirm, click OK.
Rename starter GPOs With the Starter GPOs node selected, right-click the starter
GPO, and then choose Rename. Type the new name for the starter GPO and then
press Tab or Enter.
To move starter GPOs between Active Directory domains or forests, you can store a
starter GPO in a cabinet (.CAB) file. A CAB file stores all the information related to a
starter GPO, including the preferences and settings you’ve configured for both users and
computers.
To store a starter GPO in a cabinet file, complete the following steps:
1.                  In the GPMC, select the Starter GPOs node.
2.                  With the Contents tab selected in the details pane, you should see a list of
available starter GPOs.
3.                  Select the starter GPOs that you want to place in a CAB file.
4.                  Click Save As Cabinet. Use the Save Starter GPO As Cabinet dialog box

to select the save location and file name for the cabinet file. To more easily browse
for a save location, click the Browse Folders button.
5.                  Click Save.
To load a starter GPO from a cabinet file, complete the following steps:
1.                  In the GPMC, select the Starter GPOs node.
2.                  With the Contents tab selected in the details pane, you should see a list of
available starter GPOs.
3.                  Click Load Cabinet. In the Load Starter GPO dialog box, click Browse For
CAB.
4.                  Select the location where you saved the cabinet file.
5.                  Select the cabinet file to load, and then click Open.
6.                  In the Load Starter GPO dialog box, use the details provided to confirm
that you’ve selected the right starter GPO. Click OK to load the starter GPO.
7.                  If there’s an existing starter GPO in the domain with the same name, you’ll
see a warning that you are about to overwrite the settings of that starter GPO. If you
want to continue and overwrite the settings, click OK. Otherwise, click Cancel.

Creating and Linking GPOs
When you create and link a GPO to a site, domain, or OU, the GPO is applied to the user
and computer objects in that site, domain, or OU according to the Active Directory
options governing inheritance, the precedence order of GPOs, and other settings.
You can create and link GPOs as separate operations or as a single operation on a selected
domain, site, or OU. You can, for example, create a GPO without linking it to any domain,
site, or OU. You can also create a GPO for a selected domain or OU and have the GPO
linked automatically to that domain or OU. With sites, you can only create and link a GPO
in separate operations.
How you create and link GPOs is a matter of preference. There is no right or wrong way.
Some administrators prefer to create a GPO first and then link it to a domain, site, or OU.
Other administrators prefer to create a GPO and have it linked automatically to a specific
domain or OU. However, you should remember that a GPO can be linked to multiple
containers (domains, sites, and OUs) and at multiple levels.
Creating and Linking GPOs for Sites
In an Active Directory forest, only Enterprise Admins and forest root Domain Admins can
create and modify sites and site links. Similarly, only Enterprise Admins and forest root
Domain Admins can create and manage GPOs for sites.
Sites aren’t listed automatically in the GPMC. If you don’t see the site you want to work
with, right-click Sites and then click Show Sites. You can then select the sites you want to
display.
Real World  Site-level GPOs aren’t used that often, and when they are
implemented, they are used primarily for managing network-specific policy settings
—which is in keeping with the purpose of sites to help you better manage the
physical structure of the network (your subnets). For example, you might want to
use site-level GPOs to manage IP security, Internet Explorer configurations for
proxies, wireless networking, or public key security on a per-subnet basis.
In the GPMC, you can create and link a new site GPO by completing the following steps:
1.                  In the GPMC, access the domain in which you want to create the GPO.
Under the domain node, right-click the Group Policy Objects node, and then click
New.
2.                  In the New GPO dialog box, shown in Figure 3-17, enter a descriptive
name for the GPO, such as Enhanced Security Policy. If you want to use a starter
GPO as the source for the initial settings, select the starter GPO to use from the
Source Starter GPO drop-down list. Click OK. You’ll see the new GPO listed in the
Group Policy Objects container.

FIGURE 3-17 Create a new GPO.
3.                  Right-click the new GPO, and choose Edit. This opens the Group Policy
Management Editor.
4.                  Configure the necessary policy settings, and then close the Group Policy
Management Editor.
5.                  In the GPMC, expand the Sites node and select the site you want to work
with. In the right pane, the Linked Group Policy Objects tab shows the GPOs that
are currently linked to the selected site (if any).
6.                  Right-click the site to which you want to link the GPO, and then click Link
An Existing GPO.
7.                  In the Select GPO dialog box, shown in Figure 3-18, use the Look In This
Domain list to choose the domain where the GPO is stored.
8.                  In the Group Policy Objects list, select the GPO you want to link to the
site, and then click OK.
FIGURE 3-18 Select the GPO to which you want to link.
The GPO is now linked to the site. In the right pane, the Linked Group Policy Objects tab

should show the linked GPO. After Group Policy is refreshed for computers and users in
the site, the policy settings in the GPO will be applied. To learn how to manually refresh
Group Policy, see “Refreshing Group Policy Manually” in Chapter 7.
Computer policy is refreshed during startup when the computer connects to the network.
User policy is refreshed during logon when the user logs on to the network. Thus you can
verify that computer policy settings have been applied as expected by restarting a
workstation or server in the site and then checking the computer. To verify user policy
settings, have a user who is logged on to a computer in the site log off and then log back
on. You can then verify that user policy settings have been applied as expected.
Creating and Linking GPOs for Domains
In an Active Directory forest, only Enterprise Admins, Domain Admins, and those who
have been delegated permissions can manage objects in domains. You must be a member
of Enterprise Admins or Domain Admins or be specifically delegated permissions to be
able to work with GPOs in a domain. With regard to Group Policy, delegated permissions
are primarily limited to the management of Group Policy links and RSoP for the purposes
of logging and planning.
Unlike site GPOs, which aren’t frequently used, GPOs are used widely in domains. In the
GPMC, you can create and link a new GPO for a domain in two separate operations or as
a single operation.
Creating and Then Linking a GPO for a Domain
To create a GPO and then link it separately for a domain, take the following steps:
1.                  In the GPMC, right-click the Group Policy Objects node and then click
New.
2.                  In the New GPO dialog box, enter a descriptive name for the GPO, such as
Support Policy. If you want to use a starter GPO as the source for the initial
settings, select the starter GPO to use from the Source Starter GPO drop-down list.
Click OK.
3.                  The new GPO is now listed in the Group Policy Objects container. Right-
click the GPO, and then choose Edit.
4.                  In the Group Policy Management Editor, configure the necessary policy
settings and then close the Group Policy Management Editor.
5.                  In the GPMC, expand the Domains node and then select the domain you
want to work with. In the right pane, the Linked Group Policy Objects tab shows
the GPOs that are currently linked to the selected domain (if any).
6.                  Right-click the domain to which you want to link the GPO, and then select
Link An Existing GPO. Use the Select GPO dialog box to select the GPO you want
to link, and then click OK.
The GPO is now linked to the domain. In the right pane, the Linked Group Policy
Objects tab should show the linked GPO as well.
When Group Policy is refreshed for computers and users in the domain, the policy settings

in the GPO are applied. To verify that computer policy settings have been applied as
expected, restart a workstation or server in the domain and then check the computer. To
verify user policy settings, have a user who is logged on to a computer in the domain log
off and then log back on. You can then verify that user policy settings have been applied
as expected.
Creating and Linking a Domain GPO as a Single Operation
In the GPMC, you can create and link a domain GPO as a single operation by taking the
following steps:
1.                  In the GPMC, right-click the domain you want to work with, and then
click Create A GPO In This Domain, And Link It Here.
Tip  If you don’t see the domain you want to work with, right-click Domains and
then click Show Domains. You can then select the available domains that you want
to display.
2.                  In the New GPO dialog box, enter a descriptive name for the GPO, such as
Support Policy. If you want to use a starter GPO as the source for the initial
settings, select the starter GPO to use from the Source Starter GPO drop-down list.
Click OK.
3.                  The GPO is created and linked to the domain. Right-click the GPO, and
then choose Edit.
4.                  In the Group Policy Management Editor, configure the necessary policy
settings and then close the Group Policy Management Editor.
When Group Policy is refreshed for computers and users in the domain, the policy settings
in the GPO are applied. To verify that computer policy settings have been applied as
expected, restart a workstation or server in the domain and then check the computer. To
verify user policy settings, have a user who is logged on to a computer in the domain log
off and then log back on. You can then verify that user policy settings have been applied
as expected.
Creating and Linking GPOs for OUs
In an Active Directory forest, only Enterprise Admins, Domain Admins, and those who
have been delegated permissions can manage objects in OUs. You must be a member of
Enterprise Admins or Domain Admins or be specifically delegated permissions to be able
to work with GPOs in OUs. With regard to Group Policy, delegated permissions are
primarily limited to the management of Group Policy links and RSoP for the purposes of
logging and planning.
Unlike site GPOs, which aren’t frequently used, GPOs are used widely in OUs. The
GPMC is fairly versatile when it comes to OUs. Not only can you use it to create and link
a new GPO for an OU, but you can also create any necessary OUs without having to work
with Active Directory Users And Computers.
Creating OUs in the GPMC
To create an OU in the GPMC, follow these steps:

1.                  In the GPMC, right-click the domain in which you want to create the OU,
and then click New Organizational Unit.
2.                  In the New Organizational Unit dialog box, enter a descriptive name for
the OU and then click OK.
Creating and Then Linking a GPO for an OU
To create a GPO for an OU and then link it separately, complete the following steps:
1.                  In the GPMC, right-click the Group Policy Objects node, and then click
New.
2.                  In the New GPO dialog box, enter a descriptive name for the GPO, such as
Support Policy. If you want to use a starter GPO as the source for the initial
settings, select the starter GPO to use from the Source Starter GPO drop-down list.
Click OK.
3.                  The new GPO is now listed in the Group Policy Objects container. Right-
click the GPO, and then choose Edit.
4.                  In the Group Policy Management Editor, configure the necessary policy
settings and then close the Group Policy Management Editor.
5.                  In the GPMC, expand the Domains node and select the OU you want to
work with. In the right pane, the Linked Group Policy Objects tab shows the GPOs
that are currently linked to the selected OU (if any).
6.                  Right-click the OU to which you want to link the GPO, and then select
Link An Existing GPO. Use the Select GPO dialog box to select the GPO you want
to link, and then click OK.
7.                  The GPO is now linked to the OU. In the right pane, the Linked Group
Policy Objects tab should show the linked GPO as well.
When Group Policy is refreshed for computers and users in the OU, the policy settings in
the GPO are applied. To verify that computer policy settings have been applied as
expected, restart a workstation or server in the OU and then check the computer. To verify
user policy settings, have a user who is logged on to a computer in the OU log off and
then log back on. You can then verify that user policy settings have been applied as
expected.
Creating and Linking an OU GPO as a Single Operation
In the GPMC, you can create and link an OU GPO as a single operation by taking the
following steps:
1.                  In GPMC, right-click the OU you want to work with, and then click Create
A GPO In This Domain, And Link It Here.
2.                  In the New GPO dialog box, enter a descriptive name for the GPO, such as
Support Policy. If you want to use a starter GPO as the source for the initial
settings, select the starter GPO to use from the Source Starter GPO drop-down list.
Click OK.
3.                  The GPO is created and linked to the OU. Right-click the GPO, and then

choose Edit.
4.                  In the Group Policy Management Editor, configure the necessary policy
settings and then close the Group Policy Management Editor.
When Group Policy is refreshed for computers and users in the OU, the policy settings in
the GPO are applied. To verify that computer policy settings have been applied as
expected, restart a workstation or server in the OU and then check the computer. To verify
user policy settings, have a user who is logged on to a computer in the OU log off and
then log back on. You can then verify that user policy settings have been applied as
expected.

Determining Where a GPO Is Linked
You can link a GPO to multiple sites, domains, and OUs. Linking a GPO ensures that the
objects under the scope of a site, domain, or OU are affected by the policy preferences and
settings in the GPO (according to the Active Directory options governing inheritance, the
precedence order of GPOs, etc).
Because a link establishes a relationship between the GPO and the container to which it is
linked, one way to view GPO links is to view the Active Directory node to which a GPO
is linked. As discussed in “Enabling and Disabling GPO Links” later in the chapter, GPO
links can be either active or inactive. When you access the container to which a GPO is
linked, a GPO with an active link is displayed with an icon showing a black arrow, while a
GPO with an inactive link is displayed with a dimmed icon.
To see which GPOs are linked to a particular Active Directory node as well as the state of
each GPO, complete the following steps:
1.                  In the GPMC, select the container for the site, domain, or OU with which
you want to work.
2.                  In the details pane, select the Linked Group Policy Objects tab.
3.                  As shown in Figure 3-19, you’ll then see a list of GPOs linked to the node
you selected. The GPOs are listed in order of link precedence.
FIGURE 3-19 View the GPOs linked to a particular node.
Another way to examine GPO links is to view all the nodes to which a particular GPO is
linked. This will give you an excellent idea of exactly how the GPO is being used.
To view the links per GPO, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with, and
then expand the related Domains node by double-clicking it.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains that you want to display.

3.                  Expand the Group Policy Objects node. Select the GPO you want to
examine.
4.                  In the details pane, select the Scope tab.
5.                  Under Display Links To This Location, select [Entire Forest] to display all
links to the GPO in the enterprise. You can also search all sites in the enterprise or a
particular domain by choosing the related option. As shown in Figure 3-20, you’ll
then see a list of linked locations.
FIGURE 3-20 Determine where a GPO is linked.

Enabling and Disabling GPOs
You can enable or disable GPOs either completely or partially. Completely disabling a
GPO is useful if you don’t need the GPO now but might need it again in the future or if
you’re troubleshooting policy processing problems. Partially disabling a GPO is useful
when you want the related policy settings to apply to either users or computers but not
both.
By partially disabling a policy, you can ensure that only the per-computer policy settings
or only the per-user policy settings are applied. In cases in which you are trying to speed
up policy processing, you might also want to disable user or computer settings. However,
this may result in only minimal performance gains and you should only do this when
you’ve fully determined the impact of this change on your environment.
Real World  Disabling a GPO is different from unlinking a GPO from a container.
When you disable processing of a GPO, either completely or partially, the GPO still
applies to users and computers according to how the GPO is linked. As a result, Group
Policy clients running on computers see the GPO as one that is applicable and might
need to be processed.
When you unlink a GPO from a container, the GPO no longer applies to any computers
or users in that container. As a result, Group Policy clients running on computers do not
see the GPO as one that is applicable and needing to be processed.
You can enable and disable GPOs partially or entirely by completing the following steps:
1.                  In the GPMC, expand the container for the site, domain, or OU with which
you want to work by double-clicking it.
2.                  Select the GPO you want to work with, and then click the Details tab in the
right pane, as shown in Figure 3-21.
3.                  Use the GPO Status list to choose one of the following status settings:
Enabled Allows processing of the policy object and all its settings.
All Settings Disabled Disallows processing of the policy object and all its
settings.
Computer Configuration Settings Disabled Disables processing of Computer
Configuration settings; this means that only User Configuration settings are
processed.
User Configuration Settings Disabled Disables processing of User
Configuration settings; this means that only Computer Configuration settings are
processed.
4.                  When prompted to confirm that you want to change the status of this GPO,
click OK.

FIGURE 3-21 Specify the desired status for the GPO on the Details tab.

Enabling and Disabling GPO Links
In the GPMC, you can stop using a linked GPO in several ways. You can:
Disable a link to a GPO
Remove a link to a GPO
Delete the GPO and all links to it
Disabling a link to a GPO stops the site, domain, or OU from using the related policy
settings. It doesn’t delete the GPO, however. The GPO remains linked to other sites,
domains, or OUs as appropriate. If you disable all links to the GPO from sites, domains,
and OUs, the GPO will continue to exist—it will still “live” in the Group Policy Objects
container—but its policy settings will have no effect in your enterprise.
Tip  When you access a domain, site, or OU node in the GPMC, the icon for a
GPO with an active link is displayed with a black arrow and the icon for a GPO with
an inactive link is dimmed.
To disable an active link to a GPO, right-click the GPO in the container to which it is
linked and then click Link Enabled. Selecting Link Enabled toggles the option off. In the
GPMC, a GPO with an inactive link remains in its previously linked position but is
displayed with a dimmed icon. This means you’ll see the dimmed icon when you select a
container to which the GPO is linked.
To enable a disabled link to a GPO, right-click the GPO in the container to which it is
linked and then select Link Enabled. Selecting Link Enabled toggles the option on. In the
GPMC, a GPO with an active link is displayed with an icon showing a black arrow.
Real World  With respect to GPO processing by clients, disabling a link is similar
to unlinking a GPO from a container. Whether you unlink a GPO from a container
or disable a link, the GPO no longer applies to any computers or users in that
container. As a result, Group Policy clients running on computers do not see the
GPO as one that is applicable and needing to be processed.

Removing a GPO Link
A GPO link creates an association between a GPO and the site, domain, or OU to which it
is linked. When you disable a link, the association remains and the GPO continues to be
displayed (albeit with a dimmed icon) at the level to which it is linked. To break the
association between the GPO and a site, domain, or OU, you must remove the link and not
simply disable it.
To remove a GPO link, right-click the GPO in the container to which it is linked and then
click Delete. When prompted to confirm that you want to delete the link, click OK.
Caution  The Group Policy Object container holds the actual GPO rather than
linked references to a GPO. Don’t select the GPO in the Group Policy Objects
container and perform this procedure. If you do, you will permanently delete the
GPO.

Deleting GPOs
Deleting a GPO permanently removes the GPO and all links to it. The GPO will not
continue to exist in the Group Policy Objects container and will not be linked to any sites,
domains, or OUs. The only way to recover a deleted GPO is to restore it from a backup (if
a backup copy is available).
Note  If a GPO is linked to multiple domains, deleting a GPO from one domain
will not delete links in other domains. Therefore, before you remove a GPO, you
should determine where the GPO is linked. Note also that Microsoft does not
recommend linking a GPO to multiple domains because this could cause
performance issues when processing policy.
To delete a GPO, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with, and
then expand the related Domains node by double-clicking it.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Expand the Group Policy Objects node. Right-click the GPO, and then
select Delete. When prompted to confirm that you want to delete the GPO and all
links to the GPO in the current domain, click Yes.


Managing Group Policy Preferences
Most policies have an enabled, disabled, or not configured state, and this makes it easy to
establish policy settings. Policy preferences are very different from policy settings,
however. To master policy preferences, you need to know:
How management actions and editing states work
How to configure the Common tab options
How to manage preference items
In this section, I’ll discuss these concepts.

Configuring Management Actions and Editing States
When you are working with policy preferences, it is very important to keep in mind which
type of preference you are working with. For this reason, I’ve provided a summary of
configuration options for preferences in Table 3-1. As the table shows, most preferences
support management actions and only a few support editing states.
TABLE 3-1 Preference Configuration Options
PREFERENCE TYPE
SUPPORTS MANAGEMENT
ACTIONS
SUPPORTS EDITING
STATES
Data sources
Yes
No
Device
No
No
Drive maps
Yes
No
Environment
Yes
No
Files, Ini files
Yes
No
Folder options
No
Yes
Folders
Yes
No
Immediate task
No
No
Internet settings
No
Yes
Local user, local group
Yes
No
Network share
Yes
No
New file type
Yes
No
Power options
No
Yes
Power scheme
Yes
Yes
Regional options
No
Yes
Registry item
Yes
No
Scheduled task
Yes
No
Service
No
No
Shortcuts
Yes
No
Start menu
No
Yes
Yes
No

TCP/IP printer, local printer, shared
printer
VPN connection, DUN connection
Yes
No
Based on the table, you can see that policy preferences can be divided into two main
classes: those that support management actions, and those that present the graphical user
interface from a Control Panel utility. The largest class of preferences is the one that
supports the following management actions:
Create
Replace
Update
Delete
This class of preferences includes those that configure applications, data sources, drive
maps, environment variables, files, folders, registry settings, shortcuts, and network
shares. With this class of preferences, the action controls how the preference item is
applied. With a Create, Replace, or Update action, the item can be removed when it is no
longer applied, as discussed in “Removing Preference Items” later in this chapter.
The smallest class of preferences is the one that presents graphical user interfaces from
Control Panel utilities. This class of preferences includes those that configure folder
options, Internet settings, power options, regional and language settings, and Start settings.
With this class of preferences, the item is applied according to the editing state of each
setting in the related interface. Because the editing state applied cannot be reversed, there
is no option to remove when it is no longer applied.
There are a few preferences that support neither management actions nor editing states.
With devices, you use the Action list to enable or disable a particular type of device. With
immediate tasks, the related preference creates a task. The task runs and is then deleted
automatically. With services, you use the related preference to configure an existing
service.
Both management actions and editing states are fairly easy to work with. Let’s start by
looking at the management actions.
Using the Create, Replace, Update, and Delete Actions
With the Create action, you can create a preference item on a user’s computer. However,
the preference item is created only if it does not already exist. For example, as shown in
Figure 3-22, you can create a folder preference item to create a folder with a specific path
with any of the following file system attributes: read-only, hidden, or archive.

FIGURE 3-22 Create a preference item to add a folder.
You use the Replace action to delete an existing preference item and then re-create it. The
Replace action creates a preference item if it doesn’t already exist. Continuing the folder
preference item example, you could use the Replace action to replace a folder and its
contents if the folder exists. The end result of a Replace operation is to delete existing
contents and to overwrite existing settings.

FIGURE 3-23 Create a preference item to replace a folder.
With most preferences, you have additional options that control exactly how the Replace
operation works. With folders, as shown in Figure 3-23, you have the following options:
Delete This Folder (If Emptied) The folder is deleted if it is empty. This occurs
only if the preference option to delete all files and recursively delete all subfolders
has been processed. If this option is not selected, the Replace operation is prevented
from deleting the folder.
Delete All Files In The Folder(s) This option deletes all files in the folder that are
not marked hidden or system. If Recursively Delete All Subfolders is also selected,
files that are allowed to be deleted within subfolders are deleted as well. If this option
is not selected, the Replace operation is prevented from deleting files within folders.
Allow Deletion Of Read-Only Files/Folders When this option is selected, the
Replace operation clears the read-only attribute on files and folders so that they can
be deleted. When this option is not selected, the replace operation is prevented from
deleting read-only files and folders.
Ignore Error For Files/Folders That Cannot Be Deleted The Replace operation
ignores error messages that occur because files or folders cannot be deleted. When
this option is not selected, an error is returned if the Replace operation encounters
any issues deleting files or folders.
Recursively Delete All Subfolders (If Emptied) When this option is selected, all
empty subfolders in the folder that are not marked hidden or system are deleted.
When this option is used with the Delete All Files In The Folder option, the Replace
operation deletes all files in all subfolders first and then deletes the empty subfolders.
When this option is not selected, the Replace operation is prevented from deleting
subfolders.

You use the Update action to modify a preference item. The Update action creates a
preference item if it does not exist. This action differs from a Replace action in that it only
updates settings defined within the preference item. All other settings remain the same.
In other words, updating an item does not delete any related contents. For example, with a
folder preference, you can use the Update action to set or clear the read-only, hidden, and
archive attributes on a folder (see Figure 3-24).
FIGURE 3-24 Create a preference item to update a folder.
With the Delete action, you can delete a preference item on a user’s computer (see Figure
3-25). With most preferences, you have additional options that control exactly how the
Delete operation works. Often, the additional options will be the same as those available
with a Replace operation.

FIGURE 3-25 Create a preference item to delete a folder.
Managing Editing States
Preferences for folder options, Internet settings, power options, regional and language
settings, and Start settings can be managed using graphical user interfaces from Control
Panel utilities. Because each version of the Windows operating system can have a slightly
different interface, the related options are tied to a specific version of Windows.
By default, when you are working with this type of preference, every setting in the
interface is processed by the client computer and applied, even if you don’t specifically set
the related value. This effectively overwrites all existing settings for this interface.

FIGURE 3-26 Note the editing state indicators.
Because of this default overwrite mode, whenever you are configuring this type of
preference you need to keep in mind the editing state of interface options. As shown in
Figure 3-26, the editing state of each related option is depicted graphically:
A sold green line indicates that the setting will be delivered and processed on the
client.
A red dashed line indicates that the setting will not be delivered or processed on the
client.
When limited space on the interface prevents underlining, the interface uses a green circle
as the functional equivalent of a solid green line (meaning that the setting will be delivered
and processed on the client) and a red circle as the functional equivalent of a red dashed
line (meaning that the setting will not be delivered or processed on the client). Figure 3-27
shows these conventions.

FIGURE 3-27 Note the alternative editing state indicators.
It is important to point out that the value associated with an option is separate from the
editing state. Setting or clearing an option will not change the editing state.
You can use the following function keys to manage the editing state of options:
F5 Pressing F5 enables processing of all settings on the selected tab. This is useful
if you disabled processing of some settings and later decide that you want all settings
on a tab to be processed.
F6 Pressing F6 enables processing of the currently selected setting on the selected
tab. This is useful if you disabled a setting and later decide you want the setting to be
processed.
F7 Pressing F7 disables processing of the currently selected setting on the selected
tab. This is useful to prevent one setting from being processed on the client.
F8 Pressing F8 disables processing of all settings on the selected tab. This is useful
to prevent all settings on a tab from being processed on the client. It is also useful if
you only want a few settings to be enabled.

Controlling Preference Items
Each Group Policy preference extension maintains a separate list of preference items to be
processed. When you are editing a GPO, you can manage preference items separately by
selecting the preference area and then working with the related preference items in the
details pane. Double-click a preference item to display its Properties dialog box. You can
then use the Properties dialog box to view or edit settings for the preference item.
Managing Precedence and Processing
A preference extension processes its preference items according to their precedence order.
The preference item with the lowest precedence (the one listed last) is processed first,
followed by the preference item with the next lowest precedence, and so on until the
preference item with the highest precedence (the one listed first) is processed.
Processing occurs in this order to ensure that preference items with higher precedence
have priority over preference items with lower precedence. If there is any conflict between
the settings applied in preference items, the settings written last win.
In the example shown in Figure 3-28, two preference items for Internet settings have been
created. Here, the preference item with the precedence order of 2 is processed first and
then the preference item with the precedence order of 1 is processed.
FIGURE 3-28 Preference items have a precedence order.
To change the precedence order, select a preference area in the console tree and then click
the preference item that you want to work with in the details pane. You’ll then see
additional options on the toolbar. These options include:
Move The Selected Item Up
Move The Selected Item Down
To lower the precedence of the selected item, click Move The Selected Item Down. To
raise the precedence of the selected item, click Move The Selected Item Up.
While you have a preference item selected, you can also use options on the toolbar to
disable or enable it for processing. To disable an item, click Disable This Item. To enable

an item, click Enable This Item. Other options allow you to:
Copy or paste the item
Delete the item
View properties
Display the configured settings in an XML file in Internet Explorer
Add a new item
You have similar options on a shortcut menu when you right-click a preference item.
By default, if processing of one preference item fails, processing of other preference items
will continue. To change this behavior, you can select the Stop Processing Items In This
Extension If An Error Occurs option on the Common tab. With this option selected, a
preference item that fails prevents the remaining preference items within the extension
from processing for a particular GPO. This setting doesn’t affect processing in other
GPOs.
Many preference items have the same set of options on the Common tab. As Figure 3-29
shows, other options on the Common tab include:
Run In Logged-On User’s Security Context
Remove This Item When It Is No Longer Applied
Apply Once And Do Not Reapply
Item-Level Targeting

FIGURE 3-29 Control processing of preference items using Common tab options.
Setting the Security Context
By default, the Group Policy client running on a computer processes user preferences
within the security context of either the Winlogon account (for early Windows computers)
or the System account (for current Window and Windows server operating systems). In
this context, a preference extension is limited to the environment variables and system
resources available to the computer.
Alternatively, the client can process user preferences in the security context of the logged
on user. This allows the preference extension to access resources as the user rather than as
a system service, which may be required when using drive maps or other preferences for
which the computer might not have permissions to access resources or might need to work
with user environment variables.
To allow the preference extension to run in the logged on user’s security context, follow
these steps:
1.                  In the GPMC, right-click the GPO you want to work with and then click
Edit.
2.                  In the Group Policy Management Editor, select the preference area you
want to work with in the console tree. In the details pane, you’ll see a list of
preference items configured for the selected preference area.
3.                  Double-click a preference item to display its Properties dialog box.
4.                  On the Common tab, select Run In Logged-On User’s Security Context.
Click OK.
Removing Preference Items
By default, when the policy settings in a GPO no longer apply to a user or computer, the
policy settings are removed because they are no longer set in the Group Policy area of the
registry. Default preference items are not removed automatically, however, when a GPO
no longer applies to a user or computer.
To change this behavior, you may be able to set the Remove This Item When It Is No
Longer Applied option for a preference item. When this option is selected, the preference
extension determines whether a preference item that was in scope is now out of scope. If
the preference item is out of scope, the preference extension removes the settings
associated with the preference item.
If you select Remove This Item When It Is No Longer Applied, the management action is
set as Replace. As a result, during Group Policy processing, the preference extension
performs a Delete operation followed by a Create operation. Then, if the preference items
goes out of scope (meaning it no longer applies) for the user or computer, the results of the
preference item are deleted (but not created). Item-level targeting can cause a preference
item to go out of scope as well. (Item-level targeting is discussed in more detail in “Using
Item-Level Targeting” later in this chapter.)
Generally, preferences that support management actions can be removed when they no
longer apply, but preferences that support editing states cannot be removed when they no

longer apply. To remove an item when it no longer applies, follow these steps:
1.                  In the GPMC, right-click the GPO you want to work with and then click
Edit.
2.                  In the Group Policy Management Editor, select the preference area you
want to work with in the console tree. In the details pane, you’ll see a list of
preference items configured for the selected preference area.
3.                  Double-click a preference item to display its Properties dialog box.
4.                  On the Common tab, select Remove This Item When It Is No Longer
Applied. Click OK.
Applying Preference Items During Refresh
Group Policy stores most policy settings in policy-related branches of the registry. The
operating system and compliant applications check the policy-related branches of the
registry to determine whether and how various aspects of the operating system are
controlled. If a policy setting disables a portion of the user interface, the user is prevented
from changing related settings.
Group Policy does not store policy preferences in the policy-related branches of the
registry. Instead, it writes preferences to the same locations in the registry that an
application or operating system feature uses to store the setting. As a result, users can
change settings that were configured using policy preferences. However, by default the
results of preference items are rewritten each time Group Policy is refreshed to ensure that
preference items are applied as administrators designated.
You can change this behavior by setting the Apply Once And Do Not Reapply option for a
preference item. When this option is selected, the preference extension applies the results
of the preference item one time and does not reapply the results.
To configure an item so that it isn’t reapplied, follow these steps:
1.                  In the GPMC, right-click the GPO you want to work with and then click
Edit.
2.                  In the Group Policy Management Editor, select the preference area you
want to work with in the console tree. In the details pane, you’ll see a list of
preference items configured for the selected preference area.
3.                  Double-click a preference item to display its Properties dialog box.
4.                  On the Common tab, select Apply Once And Do Not Reapply. Click OK.

Using Item-Level Targeting
Item-level targeting allows you to filter the application of a preference item so that the
preference item applies only to selected users or computers. Unlike security group filters
or Windows Management Instrumentation (WMI) filters, which can be difficult to create
and manage, item-level targeting is very easy to work with.
Basically, each targeting item results in a true or false value. If the result is true, the
preference item applies and is processed. If the result is false, the preference item does not
apply and is not processed.
You can perform item-level targeting on just about any characteristic of a computer as
well as several characteristics of users. For example, you can target a preference item so
that it applies only to the following:
Computers with a battery
Users or computers with a name that matches certain parameters
A computer CPU speed or RAM greater than a specified amount
During a specified time or on a specified day of the week or month
Computers with dial-up, remote access, or Terminal Services connections
Computers with a certain amount of available disk space on a particular drive
Computers or users in a particular site or domain
If an environment variable has a specified value
If a file or registry value exists in a specified location
If the computer has an IP or MAC address in a specified range
If the locale specified is installed
If an LDAP, WMI, or MSI query returns a specified value.
A computer with a specified operating system and service pack
A computer with a PCMCIA slot
A portable computer in a specified docking state
When the Group Policy processing mode meets the specified criteria
When a user or computer is a member of a specified security group
You can also change the value of a targeting item to its opposite by using the Is Not option
rather than the default Is option. For example, with Battery Present targeting, you can use
Is Not to target computers that do not have a battery.
To achieve very narrowly scoped targeting, you can apply multiple targeting items to a
preference item. When you do this, you select a logical operation (AND or OR) to use to
combine each targeting item with the preceding ones.
A logical AND is the default setting when you add multiple targeting items. A logical
AND is the easiest to work with. For example, if you combine three targeting items with a
logical AND operation, the results in the preference item are applied only when all three
targeting items evaluate to true.
To configure item-level targeting, follow these steps:
1.                  In the GPMC, right-click the GPO you want to work with and then click
Edit.
2.                  In the Group Policy Management Editor, select the preference area you

want to work with in the console tree. In the details pane, you’ll see a list of
preference items configured for the selected preference area.
3.                  Double-click a preference item to display its Properties dialog box.
4.                  On the Common tab, select Item-Level Targeting, and then click Targeting.
This opens the Targeting Editor.
5.                  In the Targeting Editor, shown in Figure 3-30, click New Item, and then
select the targeting item, such as Battery Present. Repeat this process to add other
targeting items.
FIGURE 3-30 Configure item-level targeting.
6.                  To change the value of a targeting item to its opposite, click the targeting
item and then select Is Not on the Item Options menu. For example, with Battery
Present targeting, you can use Is Not to target a computer without a battery.
7.                  To connect a targeting item with a logical OR rather than a logical AND,
click the targeting item and then select Or on the Item Options menu. For example,
you could use OR to ensure the item is processed when the computer is running
Windows 8.1 or the computer is a docked laptop.
8.                  Text fields accept variables and wildcards. Press F3 to display a list of
variables. Click the variable you want to use to insert it into the text field. Valid
wildcards include the asterisk (*) to match multiple characters or the question mark
(?) to match a single character.
9.                  If you need to change the order of a targeting item, click the targeting item
to modify it and then click the Move Up or Move Down button on the toolbar.
10.             Click OK to return to the Properties dialog box for the preference item.
Click OK again to close the Properties dialog box.
Targeting items are evaluated as a logical expression. Using targeting collections, you can
create parenthetical groupings within that expression. You can even nest one targeting
collection inside another collection to create complex logical expressions.

With a targeting collection, the collection of targeting items must result in the expected
value for the item to be applied. With an Is expression, the collection must evaluate to
true. With an Is Not expression, the collection must evaluate to false.
After you create your logical expression, you’ll need to ensure that the expression makes
sense. The Targeting Editor does not evaluate the logic you are trying to apply. It won’t
flag expressions that might be mutually exclusive as errors. For example, if you use AND
expressions to specify that a computer must have one IP address on the 192.168.10.0
network and one IP address on the 192.168.15.0 network, the Targeting Editor will not see
the error in your logic. The Targeting Editor will not know that you meant to use an OR
expression to indicate that a computer should have an IP address on one network or the
other.
Additionally, if you hard code a value when you meant to use an environment variable, the
targeting will not work as expected. For example, if you enter a user name rather than
using the %UserName% environment variable, the targeting will only apply to that
particular user.


Chapter 4. Advanced Group Policy Management
Advanced Group Policy Management (AGPM) is available as part of the Microsoft
Desktop Optimization Pack for Software Assurance. AGPM provides a set of extensions
for the Group Policy Management Console that fundamentally change how you control
and work with Active Directory–based Group Policy. As discussed in Appendix A,
“Installing Group Policy Tools,” you need to install the AGPM client and server
components before you can use AGPM. After you’ve installed the AGPM extensions,
your GPOs are either uncontrolled or controlled.
Uncontrolled GPOs are not stored in an offline archive and exist only in the production
environment. Controlled GPOs exist in two places: a copy of the GPO exists in an offline
archive, and the original exists in the production environment.
Controlled GPOs must be checked out of the archive before they can be edited. When a
user editing a controlled GPO finishes modifying the GPO, the user checks the GPO back
in to the archive. Only an approved administrator can then deploy the updated GPO to the
live production environment. Additionally, AGPM allows you to roll back changes to
GPOs, to roll forward changes to GPOs, and to recover both GPOs and GPOs links from
the AGPM recycle bin. These change control processes are the core features offered by
AGPM.
Note  Microsoft has released several versions of AGPM over the years. AGPM 4.0
SP2 is the current release. Not only is this version compatible with Windows 8.1,
Windows Server 2012, and Windows Server 2012 R2, it is backwards compatible
with Windows 7, Windows Server 2008, and Windows Server 2008 R2 as well.


Using Change Control
Advanced Group Policy Management provides extensions for the Group Policy
Management Console (GPMC) that introduce new ways to control and work with Active
Directory–based Group Policy. Your success with AGPM will depend on how you use the
technology. While AGPM provides a change control system, it does not prevent a user
with appropriate permissions from circumventing change control. Therefore, as part of
deploying AGPM, you need to communicate the importance of working within the change
control system and establish guidelines for working with GPOs that require its use.
AGPM uses a client-server architecture. Appendix A provides step-by-step details for
installing the AGPM server and client components. You must install the AGPM server
component to use AGPM in a domain. Performing a server installation of AGPM installs
the AGPM Service on the server and establishes the GPO archive. The AGPM Service
enables offline editing by copying GPOs from a domain controller in the current domain
and storing them in the archive. The AGPM Service allows you to apply updates to GPOs
by copying updated GPOs back to a domain controller in the current domain.
Once you’ve established an AGPM server for a domain, you can install the AGPM client
on computers that you use to manage GPOs. Each Group Policy administrator must have
the AGPM client installed on computers that she uses to manage GPOs. You do not need
to install the AGPM client on computers of users who will not manage Group Policy.
To ensure you can manage all available policy settings and preferences for the most recent
release of Windows and Windows Server in use, you should run the AGPM client and
AGPM server on the same operating system line. For example, if you’ve deployed
Windows 8.1 and Windows Server 2012 R2, the client should run on Windows 8.1 and the
server on Windows Server 2012 R2. If you run the client on an earlier release, you won’t
be able to edit policy settings or preferences that exist only on the later release.

Connecting to and Using AGPM
When AGPM is added to the GPMC, a Change Control node is displayed under each
Domain node. When you select the Change Control node, the GPMC will try to make a
connection to the GPO archive on the AGPM server. If the connection is successful, the
details pane shows the following top-level tabs (see Figure 4-1):
FIGURE 4-1 Use change control to manage GPOs.
Tip  When you select a GPO, you can view and manage the AGPM roles assigned
to users and groups. Clicking a group and then clicking Properties displays a
Properties dialog box that lists the group’s current members and allows you to add
or remove members. Clicking a user and then clicking Properties displays a
Properties dialog box that lists the user’s name and contact information and also
allows you to modify this information.
Contents Allows you to work with controlled and uncontrolled GPO via
additional, second-level tabs.
Domain Delegation Allows you to assign users and groups to each of the AGPM
roles. You can also configure the e-mail address and SMTP server for sending
approval requests. Only Full Control Administrators can configure domain delegation
settings.
AGPM Server Allows you to determine the host name and port of the AGPM
server that manages the offline archive for the domain. If AGPM policy is not yet
configured in Group Policy, a Full Control Administrator can specify the AGPM
server to use by host name and port. Additionally, this tab allows a Full Control
Administrator to control how many old GPO versions to retain.
Production Delegation Allows you to view and manage security permissions for
the live production environment. Only Full Control Administrators can configure
production delegation settings.
The additional, second-level tabs accessible from the Contents tab are:

Controlled Lists controlled GPOs. As you add GPOs to the offline archive and
control them, they are added to the Controlled tab. If you have appropriate
permissions, you can right-click a controlled GPO and then select Check In, Check
Out, or Edit to perform the action you want to take. You can also choose commands
to rename the GPO, delete the GPO, deploy the GPO to production, import the
original GPO from production, or save the GPO as a template.
Uncontrolled Lists uncontrolled GPOs. When you first deploy AGPM, all your
GPOs will be uncontrolled and listed on the Uncontrolled tab. If you have
appropriate permissions, you can right-click an uncontrolled GPO and select
Controlled to begin controlling the GPO.
Pending Lists controlled GPOs with pending requests from Editors. Anytime there
are GPOs with pending requests that need to be approved, the related GPOs are listed
on the Pending tab. If you created the request, you can right-click a pending request
and select Withdraw to delete the request. If you have appropriate permissions, you
can right-click a pending request and select Approve to approve the request or Reject
to reject the request.
Tip  When you are working with pending requests, the Withdraw, Approve, and
Reject operations can be performed on multiple items. Simply use Shift+Click or
Ctrl+Click to select the items on which you want to perform an operation, right-
click the selection, and then choose the operation you want.
Templates Lists templates that you’ve created for new controlled GPOs. A
template is similar in purpose to a starter GPO. You use templates to establish
baseline preferences and settings for a particular type of new GPO. You can specify a
default template for creating controlled GPOs by right-clicking the template and
selecting Set As Default.
Recycle Bin Lists controlled GPOs that have been deleted but have not been fully
purged from the offline archive. If you have appropriate permissions, you can right-
click a deleted GPO and select Destroy to permanently remove the GPO or Restore to
restore the GPO to its previous, controlled state.
Note  Throughout this text, I’ll refer to the AGPM recycle bin simply as the
recycle bin. The AGPM recycle bin is separate from the recycle bin used by the
operating system.
If the GPMC can connect to the AGPM server, the client is configured correctly. If the
GPMC cannot connect to the server, you may have incorrectly set the DNS name or port
information for the server. As long as AGPM policy is not yet configured, you can change
this information on the AGPM Server tab. As shown in Figure 4-2, the FQDN for the
server and TCP port typically are listed in the error text. If this information looks to be
correct, the issue might be that a firewall port hasn’t been opened or that the AGPM
Service isn’t running.

FIGURE 4-2 Resolve the error by checking configuration information, the firewall
settings, and the status of the AGPM Service.
If you can connect to the AGPM server but don’t have permission to work with the GPO
archive, the GPMC connects to the AGPM server but is unable to access the GPO archive.
As a result, you get an “insufficient permissions” error as shown in Figure 4-3. To resolve
this, you’ll need to take one of the following steps:
Have an AGPM administrator delegate an appropriate domainwide role for your user
account or a group of which your user account is a member.
Add your account to the AGPM administrator group identified as Archive Owner
during installation of the AGPM server.
FIGURE 4-3 Resolve this error by ensuring that your account has been assigned an
appropriate AGPM role.

Managing GPOs with Change Control
AGPM version 4.0 or later supports both policy preferences and policy settings in GPOs.
AGPM includes change management features and fundamentally changes how you control
and work with Group Policy. When you are working with Group Policy and not using
AGPM, administrative control works like this:
By default, only members of the Group Policy Creator Owners group can create
GPOs.
To edit or modify an existing GPO, a user must be a member of the Domain Admins
group in the domain or of the Enterprise Admins group in the forest, as appropriate
for the GPO, or the user must have created the GPO.
Using delegation, you can grant permissions over the security properties of GPOs to
groups or users. Permissions you can grant include the rights to view, create, and
manage GPOs.
When you are working with Group Policy and using AGPM, GPOs are either:
Uncontrolled Uncontrolled GPOs are not subject to AGPM change controls. When
you are working with the Uncontrolled tab, you’ll find that GPOs are listed by name,
state, the name of the account that last changed the GPO, last change date, version,
GPO status, and WMI filter. Normally the state is listed as Uncontrolled.
Controlled Controlled GPOs are subject to AGPM change controls. When you are
working with the Controlled tab, you’ll find that GPOs are listed by name, state, the
name of the account that last changed the GPO, last change date, version, GPO
status, and WMI filter. The Checked In state means that the GPO is checked in and
currently under AGPM control. The Checked Out state means that the GPO has been
checked out for editing.
Tip  Whenever you work with Change Control, it is important to ensure that you are
viewing the current state of the tabs and GPOs. To refresh the view, click the Refresh
button on the toolbar or select Refresh on the Action menu.
Real World  Whenever you work with Group Policy Software Installation packages,
keep in mind that AGPM preserves the integrity of these packages. Although you can
edit GPOs offline, links between packages, as well as cached client information, are
preserved. Therefore, when editing a GPO offline with AGPM, you must configure any
Group Policy Software Installation upgrade of a package in another GPO to reference the
deployed GPO, not the checked-out copy. Additionally, you must have Read permission
for the deployed GPO.
You can work with uncontrolled GPOs in the same ways you work with GPOs when
AGPM is not installed. To edit an uncontrolled GPO, select the Group Policy Objects
node in the GPMC, right-click the GPO in the details pane, and then click Edit.
You can view uncontrolled GPOs by selecting the Change Control node in the GPMC,
selecting the top-level Contents tab, and then clicking the Uncontrolled tab in the details
pane, as shown in Figure 4-4.

FIGURE 4-4 View uncontrolled GPOs.
To place an uncontrolled GPO under control, you must have appropriate permissions.
Users with Reviewer role permissions require prior approval to control GPOs. Users with
the Editor, Approver, or Full Control Administrator role can control GPOs without prior
approval. For more information on these roles, see “Delegating Change Control
Privileges” later in the chapter.
After you elect to control a GPO, the GPMC creates a copy of the GPO in the offline
archive. You then use the copy whenever you edit the GPO while working with the
Change Control node. Controlling a GPO is the first step in the change control process.
Tip  There is no uncontrol option. However, if you no longer want to control a
GPO, you can remove control by deleting the GPO from the archive only. To do this,
right-click the GPO on the Controlled tab and then click Delete. If you still want to
use the GPO in production, don’t remove both the archive copy and the live
production copy.
With change control in place, GPOs must be checked out prior to editing and checked in
after editing. Only one user at a time can check out and edit a controlled GPO. When a
GPO is checked out, no one else can check out and edit the GPO within the AGPM
change-control framework.
Real World  When you check out a GPO under change control, the GPMC lists the
production GPO in the Group Policy Objects node with Checked Out as the state. When
you check the GPO back in under change control, the GPMC changes the state to
Checked In.
Change control is only as good as your organization’s commitment to using the
framework it provides. Change control does not prevent anyone with appropriate access
rights from editing GPOs outside the change control framework. For example, anyone
who is the creator/owner of a GPO could edit a GPO by right-clicking the GPO in the
GPMC’s Group Policy Object node and choosing Edit.

The processes related to change control are fairly straight forward. Because of change
control, when you are working with GPOs on the Controlled tab, you can perform the
following tasks if you have appropriate permissions (see Figure 4-5):
Track GPO history Right-click a controlled GPO and then select History to view
its change history, which includes a detailed list of all state changes and unique
versions available. History information tells you when changes were made to the
GPO, who made the changes, and what changes were made.
Obtain a report on settings Right-click a controlled GPO, point to Settings, and
then select the type of report you want to generate. If you select HTML Report or
XML Report, you’ll get a detailed report about the GPO in the format you choose. If
you select GPO Links, you’ll see a list of the domains and organizational units (OUs)
to which the GPO was linked when it was most recently controlled, archived, or
checked in. AGPM doesn’t manage site links.
FIGURE 4-5 Manage controlled GPOs on the Controlled tab.
Obtain a report on the differences in GPO versions Right-click a controlled
GPO, point to Differences, and then select the type of report you want to generate. If
you select HTML Report or XML Report, you’ll get a detailed differences report on
the GPO in the format you choose.
Edit a GPO Right-click a controlled GPO that you’ve previously checked out and
then click Edit to edit the GPO in the Group Policy Management Editor.
Check in a GPO Right-click a controlled GPO that you’ve previously checked out
and then click Check In to check in the GPO and make the edited version of the GPO
the current version. When prompted, provide a history comment and then click OK.
Check out a GPO Right-click a controlled GPO and then click Check Out to check
out a GPO so that you can edit it. When prompted, provide a history comment and
then click OK.
Undo a check out of a GPO Right-click a controlled GPO that you previously

checked out and then click Undo Check Out to check in the GPO without applying
your edits. When prompted to confirm, click Yes.
Import a GPO from production Right-click a controlled GPO, select Import
From, and then click Production to copy the live production version over the current
version of the GPO in the archive. This procedure ensures that the archive copy is
current and undoes any edits not applied. When prompted, provide a history
comment and then click OK.
Delete a GPO Right-click a controlled GPO that is checked in and then click
Delete. Next, to remove the copy of the GPO only from the archive, select Delete
GPO From Archive Only and then click OK. Or, to remove the GPO from the archive
and from production, select Delete GPO From Archive And Production. The deleted
GPO is then moved to the recycle bin.
Deploy a GPO Right-click a controlled GPO that is checked in and then select
Deploy to copy the current version of the GPO in the archive to the live production
environment. When prompted to confirm, click Yes. By default, existing links are not
modified; only links that existed when the GPO was last archived or checked in but
have since been removed are restored. If you don’t want to restore previous links,
clear the Restore Links check box.
Note  During deployment, no existing links are deleted nor will any OUs be
created. Also note that AGPM does not manage site links. Therefore site links will
not be modified or restored.
Label a GPO Right-click a controlled GPO and then click Label to add comments
to the history information. When prompted, enter a label and comment and then click
OK. The label you provide is entered in the State field, and your comments are
entered in the Comment field.
Rename a GPO Right-click a controlled GPO that is checked in and then click
Rename to rename a GPO. In the Rename GPO dialog box, enter the new name for
the GPO, add an optional comment, and then click OK.
Save a GPO as a Template Right-click a GPO on the Controlled or Uncontrolled
tab, and then click Save As Template to save the GPO as a template for other new
controlled GPOs. In the Create New GPO Template dialog box, enter the name for
the GPO template, add an optional comment, and then click OK.
Real World  With the exception of renaming, all the operations described in the
previous list can be performed on multiple GPOs. Simply use Shift+Click or
Ctrl+Click to select the GPOs on which you want to perform an operation, right-
click, and then choose the operation you want.

Delegating Change Control Privileges
With controlled GPOs, permissions are managed through the AGPM administrative roles.
These roles—listed from the role with the least permissions to the role with the most
permissions—are as follows:
Reviewer Role members have read-only access to a GPO for which they’ve been
granted this role. Read-only access allows them to review the GPO edit history and
settings but not to make changes.
Editor Role members have permission to review and edit a GPO for which they’ve
been granted this role. This allows them to perform Reviewer tasks and to make
changes to GPOs. Because changes to GPOs are made in the offline archive, changes
are not applied until they are officially checked in by an Approver. Additionally,
Editors can create GPO templates.
Approver Role members have permission to review and approve a GPO for which
they’ve been granted this role. This allows them to perform Reviewer tasks and to
create, deploy, and delete GPOs. An Approver checks in a GPO from the archive to
make the offline copy of the GPO live in the production environment.
Full Control Administrator Role members have full control over a GPO for
which they’ve been granted this role. This allows them to perform Reviewer,
Approver, and Editor tasks. Additionally, Full Control Administrators can modify
options and security associated with GPOs.
Table 4-1 summarizes the basic permissions assigned to each role.
TABLE 4-1 Basic Permissions of AGPM Roles
PERMISSION
REVIEWER
EDITOR
APPROVER
FULL CONTROL
ADMINISTRATOR
List contents
X
X
X
X
Read settings
X
X
X
X
Edit settings
 
X
 
X
Create GPOs in
production
 
 
X
X
Deploy GPOs to
production
 
 
X
X
Delete GPOs from
production
 
 
X
X
Modify options
 
 
 
X
Modify security
 
 
 
X
Create templates
 
X
 
X
Because of the additional layer of control, an administrator who wants to work with a

particular GPO must not only be a member of the appropriate groups in Active Directory
but must also be assigned the appropriate administrative role. For example, if Tony G is to
be a Group Policy administrator with full control, Tony needs to be a member of Domain
Admins or Enterprise Admins and he needs to be assigned the Full Control Administrator
role. However, if Tony G is to be a Group Policy administrator with Editor or Reviewer
privileges only, Tony should be assigned the Editor or Reviewer role as appropriate, but he
should not be a member of Domain Admins, Enterprise Admins, or Group Policy Creator
Owners.
Table 4-2 lists the key tasks that members of a particular AGPM role can perform. Note
that membership in administrator groups may grant additional privileges that you don’t
want a Group Policy Reviewer, Editor, or Approver to have. For example, by default,
members of Domain Admins and Group Policy Creator Owners can create and manage
GPOs in a domain. Therefore, if an Editor or Reviewer is a member of one of these
groups, they won’t be subject to the limitations of this role.
TABLE 4-2 Key Tasks Members of AGPM Roles Can Perform
TASK
REVIEWER
EDITOR
APPROVER
FULL CONTROL
ADMINISTRATOR
Add a GPO to the
Controlled tab
Requires approval
Yes
Yes
Yes
Check in a GPO
No
Yes
Yes
Yes
Check out a GPO
No
Yes
No
Yes
Create a GPO in the
archive
No
Yes
Yes
Yes
Create a GPO in the
archive and in production
No
Requires
approval
Yes
Yes
Create a template
No
Yes
No
Yes
Delete a GPO from
archive
No
Yes
Yes
Yes
Delete a GPO from
archive and production
No
Requires
approval
Yes
Yes
Deploy a GPO
No
Requires
approval
Yes
Yes
Edit a GPO
No
Yes
No
Yes
Import a GPO from
production
No
No
Yes
Yes
Label a GPO
No
Yes
Yes
Yes
Modify GPO options
No
No
No
Yes

Modify GPO security
No
No
No
Yes
Obtain a report on
settings
Yes
Yes
Yes
Yes
Obtain a report on the
differences in GPO
versions
Yes
Yes
Yes
Yes
Rename a GPO
No
Yes
No
Yes
Remove a GPO from the
recycle bin
No
No
Yes
Yes
Restore a GPO from the
recycle bin
No
Requires
approval
Yes
Yes
Save a GPO as a template
No
Yes
No
Yes
Track GPO history
Yes
Yes
Yes
Yes
Undo the check out of a
GPO
No
Yes
Yes
Yes
After you mark a GPO as controlled, you must grant AGPM roles to specific users and
groups to allow the GPO to be controlled by various users in your organization. The
Reviewer, Approver, Editor, and Full Control Administrator roles can be assigned on a
per-GPO basis or a per-domain basis. With controlled GPOs, the only account granted an
AGPM role by default is the Archive Owner user or group specified when you install the
AGPM server components.
Note  When you assign the Editor role to someone, he will have the Reviewer and
Editor roles. Similarly, when you assign the Approver role to someone, he will have
the Reviewer and Approver roles.
By default, the Archive Owner is granted the Full Control Administrator role over all
controlled GPOs. This means that if you configured a group as the Archive Owner, you
can give someone the Full Control Administrator role throughout the domain simply by
adding the user’s user account to this group. Using Domain Delegation for AGPM, you
can specify other users and groups to have AGPM roles on a domainwide basis. Only Full
Control Administrators can configure domain delegation settings.
To delegate privileges on a per-GPO basis, complete the following steps:
1.                  In the GPMC, select the Change Control node and then select the top-level
Contents tab.
2.                  On the Controlled tab of the Contents panel, select the GPO you want to
work with. In the lower pane, you’ll see a list of groups and users who have been
delegated privileges as well as the role or roles assigned.
Note  The Inherited column specifies whether the delegated privilege is inherited.

If a delegated privilege is inherited from domain delegation, you cannot edit the
inherited role assignment at this level. Otherwise, you can modify the role
assignment as necessary.
3.                  Do one of the following:
To delegate privileges to a group or user, click Add. Use the Select User, Computer,
Or Group dialog box to specify the group or user to which you want to assign an
access role and then click OK. In the Add Group Or User dialog box, use the Role
list to select the role to grant and then click OK.
To remove a noninherited delegated privilege, click the group or user assigned the
role and then click Remove. When prompted to confirm, click OK.
To view or manage the membership of a group that has been delegated privileges,
click the group to select it and then click Properties. In the Properties dialog box,
you’ll see a list of current members. To remove a member, click the user or group,
click Remove, and then click Yes when prompted to confirm. To add a member,
click Add, use the Select User, Computer, Or Group dialog box to specify the group
or user to add, and then click OK.
To view the security permissions assigned to a group or user, click the group or user
to select it, and then select Advanced. Use the Permissions For dialog box and its
options to review the assigned security permissions.
To delegate privileges on a domainwide basis, complete the following steps:
1.                  In GPMC, select the Change Control node and then select the top-level
Contents tab.
2.                  On the Domain Delegation tab of the Contents panel, you’ll see a list of
groups and users who have been delegated privileges as well as the role or roles
assigned.
Note  The Inherited column specifies whether the delegated privilege is inherited.
By default, the only group or user to inherit privileges at the domain level is the
Archive Owner you assigned when you installed the AGPM server. You cannot edit
an inherited role assignment at this level. Otherwise, you can modify the role
assignment as necessary.
3.                  Do one of the following:
To delegate privileges to a group or user, click Add. Use the Select User, Computer,
Or Group dialog box to specify the group or user to which you want to assign an
access role and then click OK. In the Add Group Or User dialog box, use the Role
list to select the role to grant and then click OK.
To remove a noninherited delegated privilege, click the group or user assigned the
role and then click Remove. When prompted to confirm, click OK.
To view or manage the membership of a group that has been delegated privileges,
click the group to select it and then click Properties. In the Properties dialog box,
you’ll see a list of current members. To remove a member, click the user or group,
click Remove, and then click Yes when prompted to confirm. To add a member,
click Add, use the Select User, Computer, Or Group dialog box to specify the group
or user to add, and then click OK.

To view the security permissions assigned to a group or user, click the group or user
to select it and then select Advanced. Use the Permissions For dialog box and its
options to review the assigned security permissions.

Managing Workflow and E-mail Notification
AGPM uses workflow methodology to enable Group Policy administrators to notify
someone that a task needs to be performed without actually performing the task. The built-
in workflow features facilitate communication within the tool as well as through e-mail.
The workflow technique used depends on the role or roles assigned to the administrator
performing a particular task.
If an administrator has the Reviewer role but not the Editor, Approver, or Full Control
Administrator role, he or she must get approval from an Editor, an Approver, or a Full
Control Administrator prior to controlling a GPO.
If an administrator has the Editor role and is not also an Approver or a Full Control
Administrator, he or she must get approval from an Approver or a Full Control
Administrator prior to AGPM finalizing the following tasks:
Creating a GPO in the archive and in the production environment
Deleting a GPO from both the production environment and the archive
Restoring a GPO from the recycle bin to the archive
Deploying a GPO to the production environment
As part of the workflow, when an Editor tries to create, delete, deploy, or restore a GPO,
the GPO is moved from its current location to the Pending tab. On the Pending tab, shown
in Figure 4-6, GPOs are listed by name, state, who last changed the GPO, change date, and
other values. This allows an Approver or a Full Control Administrator who accesses the
Pending tab to determine what needs to be done. The key information to review is the
following:
Name Shows which GPO has a pending action
State Shows what action is pending
Changed By Shows who requested the change
Change Date Shows when the change request was made
FIGURE 4-6 Requests waiting to be processed are listed on the Pending tab.

If you’ve configured e-mail notification, approval requests are also sent to a designated
approval e-mail address or addresses when an Editor tries to create, delete, or restore a
GPO. E-mail notification is not configured by default. To configure e-mail notification,
you must be a Full Control Administrator. If you are, you can configure e-mail by
completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain in which you
want to manage GPOs.
2.                  In the details pane, select the Domain Delegation node, as shown in Figure
4-7.
3.                  Under Send Approval Requests, provide the following information and
then click Apply:
From E-Mail Address Specifies the e-mail alias for the account under which
approval requests will be sent. With Microsoft Exchange Server, you need to ensure
that the e-mail alias is valid for sending e-mail and might want to set up a related
mailbox to ensure this. If you configure a mail-enabled user account (a user account
with a mailbox), you can provide the user name and password information for this
account in the User Name, Password, and Confirm Password boxes.
To E-Mail Address Specifies a comma-delimited list of e-mail addresses to
which approval requests are sent. With Exchange Server, if an e-mail address is a
distribution group, you can notify all the people in the distribution group. For
example, if designated Approvers and Full Control Administrators are members of
the distribution group, they’ll be notified of pending requests.
SMTP Server Specifies the Simple Mail Transfer Protocol (SMTP) server
through which approval requests are routed. This must be a valid SMTP server.
Because most SMTP servers block message relay, you need to ensure that the e-
mail alias is valid on the SMTP server. Typically, this will mean that the related
mailbox exists on the server or that the server is configured to recognize and permit
the use of the e-mail address provided in the From E-Mail Address field.
User Name Sets the user name authorized to connect to the SMTP server and
send e-mail messages using the address you’ve provided for From E-mail Address.
With Exchange Server, you should specify the mailbox owner. If the user you
specify is not the mailbox owner, the user you specify must have Send On Behalf
Of privileges.
Password/Confirm Password Sets the password for the user account you
specified.
Real World  The password you provide is stored within the archive in an
encrypted format. The encryption protecting the password causes the password to
fail if the archive is moved to another computer. To resolve this, you must re-enter
and reconfirm the password and then click Apply.

FIGURE 4-7 Configure an e-mail address and SMTP server to use for sending e-mail
requests.
To create a GPO, you must be an Approver or a Full Control Administrator. While
Approvers and Full Control Administrators can create GPOs without making a formal
request, Editors who are not Approvers or Full Control Administrators cannot. Editors
create new controlled GPOs by using the following technique:
1.                  An Editor makes a request stating that he or she wants to create a new
controlled GPO by right-clicking Change Control and selecting New Controlled
GPO. The Editor sets the name of the GPO and specifies whether to deploy the new
GPO to production upon approval or to create it offline without immediately
deploying it. The GPO can also be based on a template as a starting point.
2.                  The new GPO is displayed on the list of GPOs on the Pending tab.
3.                  An Approver reviews the request and, if appropriate, approves the creation
of the GPO. After approval, the GPO is moved to the Controlled tab and made
available as appropriate.
Real World  Sometimes it seems you cannot create, check out, delete, or deploy
controlled GPOs. If you receive Failed and Access Denied errors when trying to create,
check out, delete, or deploy controlled GPOs, be sure the domain user account for the
AGPM Service is either a member of the Group Policy Creator Owners group or has
been delegated permission to create GPOs in the domain. You can verify membership in
the Group Policy Creator Owners group by using Active Directory Users And
Computers.
You can delegate GPO creation permissions using the GPMC. In the GPMC, select the
Group Policy Objects node and then click the Delegation tab in the details pane to
determine the users and groups that have been delegated permissions to create (and work
with) GPOs. The accounts that are delegated the GPO creation permission by default are
Domain Admins, Group Policy Creators Owners, and SYSTEM. To delegate creation

permissions to another user or group, click Add, select the account in the dialog box
provided, and then click OK.
Additionally, on each individual GPO, the account for the AGPM Service must be
delegated the permissions Edit Settings, Delete, and Modify Security. Although these
permissions are added by default to any new GPO that you create within AGPM, they are
not set on GPOs that are created outside AGPM or prior to installing AGPM.
Additionally, an administrator could accidentally remove these permissions. To confirm
that the permissions are set, select the GPO under the Group Policy Object node and then
click Delegation in the details pane. If the account isn’t listed, click Add. Select the
account in the Select User, Computer, Or Group dialog box. In the Add Group Or User
dialog box, under Permissions, select Edit Settings, Delete, Modify Security, and then
click OK.
To check out, edit, check in, or deploy a GPO, you must have appropriate permissions.
Editors who are not Approvers or Full Control Administrators check out, edit, check in,
and deploy controlled GPOs using a multipart process that works like this:
1.                  An Editor checks out a GPO from the offline archive by right-clicking it
and selecting Check Out. Next, the Editor edits the GPO by right-clicking it and
selecting Edit. When finished, he or she checks in the modified GPO to the offline
archive by right-clicking the GPO and selecting Check In. The GPO remains visible
on the Controlled tab throughout this process.
Important  It is important to remember that AGPM only controls how GPOs are
used within the change control system. AGPM does not prevent a user with
appropriate permissions from directly editing a GPO in the GPMC and thereby
circumventing change control. For this reason, you’ll need to communicate the
importance of working within the change control system and establish guidelines for
working with GPOs that require its use.
2.                  Checking in a GPO doesn’t deploy the GPO; deploying a GPO is a
separate process. An Editor makes a request stating that he or she wants to deploy a
GPO by right-clicking the GPO on the Controlled tab and selecting Deploy. This
copies the GPO to the Pending tab.
3.                  An Approver reviews the history of the GPO simply by double-clicking
the GPO. Using the History window, the Approver can create an HTML report to
display a summary of the GPO’s policy preferences and policy settings. To
determine the changes between versions, the Approver can select each version and
then click the Differences button.
4.                  If the Approver wants to accept the request, he or she can then approve
and deploy the GPO by right-clicking the GPO and then clicking Approve.
Deploying the GPO copies the current version of the GPO from the offline archive
to the live production environment.
5.                  If the Approver doesn’t want to accept the request, he or she can cancel the
deployment by right-clicking the GPO and clicking Reject. The Approver can go a
step further and reject the changes as well by double-clicking the GPO to access its
History window. In the History window, right-click the version to restore and then

click Deploy.
Any Editor, Approver, or Full Control Administrator can delete the archive copy of a
GPO. However, only an Approver or a Full Control Administrator can delete a GPO from
both the archive and production environment without prior approval. Editors who are not
Approvers or Full Control Administrators can delete controlled GPOs from both the
archive and production by using a multipart process that works like this:
1.                  An Editor identifies a GPO to delete from production and the archive by
right-clicking it, clicking Delete, and then specifying that the GPO should be
deleted from the archive and production. The GPO is moved to the Pending tab and
displayed on the list of GPOs on the Pending tab.
2.                  An Approver reviews the deletion request.
3.                  If the Approver accepts the deletion request, he or she can then approve it
simply by right-clicking the GPO and clicking Approve. The GPMC then moves
the GPO to the recycle bin.
4.                  If the Approver doesn’t accept the deletion request, he or she can
disapprove and cancel the request by right-clicking the GPO and selecting Reject.
Only an Approver or a Full Control Administrator can destroy a GPO by permanently
removing it from the recycle bin. Only an Approver or a Full Control Administrator can
restore a GPO from the recycle bin without prior approval. For Editors who are not
Approvers or Full Control Administrators, restoring controlled GPOs works like this:
1.                  An Editor identifies a GPO to restore in the recycle bin by right-clicking it
and then clicking Restore. This makes a request stating that the GPO should be
restored. The GPO is moved to the Pending tab and displayed on the list of GPOs
on the Pending tab.
2.                  An Approver reviews the restoration request.
3.                  If the Approver accepts the restoration request, he or she can approve it
simply by right-clicking the GPO and clicking Approve. Restoring a GPO moves
the GPO from the Pending tab to the Controlled tab.
4.                  If the Approver doesn’t accept the restoration request, he or she can then
disapprove and cancel the request by right-clicking the GPO and selecting Reject.
This action moves the GPO back to the recycle bin.
The administrative template settings for AGPM enable you to control how AGPM works.
You can use the AGPM: Configure Logging setting to centrally configure logging and
tracing options for AGPM servers and clients to which a GPO with this setting is applied.
The setting is available under Computer Configuration\Policies\Administrative
Templates\Windows Components\AGPM when editing a GPO in the Group Policy
Management Editor. When enabled, trace files are written to
%LocalAppData%\Microsoft\AGPM\agpm.log on AGPM clients and
%ProgramData%\Microsoft\AGPM\agpmserv.log on AGPM servers.
Other settings are available under User Configuration\Policies\Administrative
Templates\Windows Components\Microsoft Management Console\Restricted\Permitted
Snap-ins\Extension Snap-ins. In this area, you can:

Use AGPM: Show Change Control Tab to control the visibility of the Change
Control folder in the GPMC.
Use AGPM: Show History Tab For Linked GPOs to control the visibility of the
History tab provided by AGPM when you view a linked GPO in the GPMC.
Use AGPM: Show History Tab For GPOs to control the visibility of the History tab
provided by AGPM when you view a GPO in the GPMC.
To learn about other related settings, see “Configuring Group Policy to Support AGPM”
in Appendix A.


Managing Controlled GPOs
With AGPM, your GPOs are either controlled or uncontrolled. With controlled GPOs, you
have offline copies of GPOs as well as live GPOs in production, and you have additional
management options as discussed in this section. These additional options include:
Creating and using GPO templates
Controlling and importing GPOs
Creating, deploying, and deleting controlled GPOs
Labeling, restoring, and redeploying controlled GPOs
Checking out, editing, and checking in controlled GPOs
Tracking change history and generating reports
Irrespective of AGPM controls, there are certain tasks that you’ll use to manage your
GPOs in the live production environment. These tasks are discussed in “Managing Your
GPOs in Production” in Chapter 3, “Group Policy Management.”

Using GPO Templates
A template is a predefined GPO that you use as a baseline for new GPOs. Although GPO
templates store both policy preferences and policy settings, you cannot edit a GPO
template after you create it. In the enterprise, you can create multiple GPO templates to
help other administrators create new GPOs more quickly.
Tip  You also can use starter GPOs to help you more easily create new GPOs.
However, starter GPOs only store settings within administrative templates. I discuss
how to use starter GPOs in “Using Starter GPOs” in Chapter 3.
Creating GPO Templates
To create a GPO template, you must be an Editor or a Full Control Administrator. Editors
and Full Control Administrators can create new GPO templates using the following
technique:
1.                  In the GPMC, select the Change Control node in the domain in which you
want to manage GPOs.
2.                  In the details pane, select the top-level Contents node.
3.                  On the Controlled or Uncontrolled tab, right-click a GPO and then select
Save As Template.
4.                  In the Create New GPO Template dialog box, shown in Figure 4-8, enter a
name for the GPO template, add an optional comment if you want, and then click
OK.
5.                  The AGPM Progress window tracks the progress of the template creation
process. When the GPMC is finished creating the template, click Close. If an error
occurs, note the error, take corrective action, and then repeat this procedure. Most
errors you’ll see have to do with permissions. You must have appropriate
permissions to create GPO templates.
FIGURE 4-8 Specify the name of the new template.
Managing GPO Templates
When you are working with the Change Control node in the GPMC and have selected the
top-level Contents tab, GPO templates you’ve created are available on the Templates tab.
As shown in Figure 4-9, when you select a template, the lower pane displays a list of
groups and users who have permission to access the template.

FIGURE 4-9 View available GPO templates.
You can work with templates in much the same way as you work with GPOs. If you right-
click a GPO template, you have the following options:
New Controlled GPO Creates a new GPO based on the selected template.
Depending on your administrative role, you see the New Controlled GPO dialog box
or the Submit Control Request dialog box. The process works exactly as discussed in
“Creating Controlled GPOs” later in this chapter.
Set As Default Sets the selected template as the default to be used automatically
when creating a new GPO.
Delete Marks the selected template for deletion. To delete a GPO template and
move it to the recycle bin, you must have the Approver or Full Control Administrator
role. If you do not have permission to delete a GPO, you will be prompted to submit
a request, and your pending delete request will be listed on the Pending tab. The
process is similar to the one discussed in “Deleting Controlled GPOs” later in the
chapter.
Tip  You can delete multiple GPO templates. Simply use Shift+Click or Ctrl+Click
to select the GPO templates to delete, right-click, and then click Delete.
Rename Changes the name of the selected template. After you right-click the GPO
template, click Rename, and the Rename GPO dialog box is displayed. Enter the new
name for the GPO template, add an optional comment if you want, and then click
OK.
Settings Generates an HTML-based or XML-based report displaying the settings
within the selected GPO template.
Differences Generates an HTML-based or XML-based report comparing the
settings between the selected template and another template you identify when
prompted.
Delegating Privileges for GPO Templates

You can delegate privileges for a particular GPO template by completing the following
steps:
1.                  In the GPMC, select the Change Control node and then select the top-level
Contents tab.
2.                  On the Templates tab of the Contents panel, select the GPO template you
want to work with. In the lower pane, you’ll see a list of groups and users who have
been delegated privileges as well as the role or roles assigned.
If a delegated privilege is inherited from domain delegation, you cannot edit the
inherited role assignment at this level. Otherwise, you can modify the role
assignment as necessary.
3.                  Do one of the following:
To delegate privileges to a group or user, click Add. Use the Select User, Computer,
Or Group dialog box to specify the group or user to which you want to assign an
access role and then click OK. In the Add Group Or User dialog box, use the Role
list to select the role to grant, and then click OK.
To remove a noninherited delegated privilege, click the group or user assigned the
role and then click Remove. When prompted to confirm, click OK.
To view or manage the membership of a group that has been delegated privileges,
click the group to select it and then click Properties. In the Properties dialog box,
you’ll see a list of current members. To remove a member, click the user or group,
click Remove, and then click Yes when prompted to confirm. To add a member,
click Add, use the Select User, Computer, Or Group dialog box to specify the group
or user to add, and then click OK.
To view the security permissions assigned to a group or user, click the group or user
to select it, and then select Advanced. Use the Permissions For dialog box and its
options to review the assigned security permissions.

Creating Controlled GPOs
The way you create controlled GPOs depends on your AGPM role. While Approvers and
Full Control Administrators can create GPOs without making a formal request, Editors
who are not Approvers or Full Control Administrators cannot.
Creating GPOs with No Approval Required
If you are an Approver or a Full Control Administrator, you can create a controlled GPO
by completing the following steps:
1.                  In the GPMC, right-click the Change Control node in the domain in which
you want to create the controlled GPO. On the shortcut menu, select New
Controlled GPO.
2.                  In the New Controlled GPO dialog box, shown in Figure 4-10, enter a
descriptive name for the GPO, such as Customer Service OU Policy. Optionally,
enter a comment for the GPO.
FIGURE 4-10 Create a controlled GPO.
3.                  Specify where to create the GPO. If you want to create a copy of the GPO
in the archive and in the production environment, select Create In Archive And
Production. If you want to create a copy of the GPO in the archive but not in the
production environment, select Create In Archive Only.
4.                  Specify whether to base the GPO on a template. If you want to use a GPO
template as the source for the initial settings, use the From GPO Template list to
select the GPO template to use. If you do not want to use a GPO template as the
source for the initial settings, select <Empty GPO> in the From GPO Template list.
5.                  Click OK. If you selected <Empty GPO> and an empty template does not
yet exist, click OK to create it when prompted.
6.                  The AGPM Progress window tracks the progress of the GPO creation
process. When the GPMC is finished creating the template, click Close. If an error
occurs, note the error, take corrective action, and then repeat this procedure. Most

errors you’ll see have to do with permissions. You must have appropriate
permissions to create controlled GPOs.
If you copied the GPO to the archive and to production, the GPO will exist in both places.
Otherwise, it will exist only in the archive. To finalize the GPO, you must:
1.                  Check out the GPO from the archive.
2.                  Edit the GPO.
3.                  Check in the GPO to the archive.
4.                  Deploy the GPO to production. This copies the GPO from the archive to
production.
5.                  Link the GPO to the appropriate containers in Active Directory.
Creating GPOs with Approval Required
If you are an Editor, you must have approval to create a GPO. To create a GPO, you must
complete the following steps:
1.                  In the GPMC, right-click the Change Control node in the domain in which
you want to create the controlled GPO. On the shortcut menu, select New
Controlled GPO. The GPMC displays the Submit Control Request dialog box,
shown in Figure 4-11.
2.                  If you want to send a courtesy copy of the request to someone, enter the e-
mail address in the CC box. You can enter multiple e-mail addresses by separating
them with commas.
3.                  Enter a descriptive name for the GPO, such as Customer Service OU
Policy. Optionally, enter a comment for the GPO.
4.                  Specify where to create the GPO. If you want to create a copy of the GPO
in the archive and in the production environment, select Create In Archive And
Production. If you want to create a copy of the GPO in the archive but not in the
production environment, select Create In Archive Only.

FIGURE 4-11 Request approval for your action.
5.                  Specify whether to base the GPO on a template. If you want to use a GPO
template as the source for the initial settings, use the From GPO Template list to
select the GPO template to use. If you do not want to use a GPO template as the
source for the initial settings, select <Empty GPO> in the From GPO Template list.
6.                  Click Submit. If you selected <Empty GPO> and an empty template does
not yet exist, click OK to create it when prompted.
7.                  The AGPM Progress window tracks the progress of the request
submission. When the GPMC is finished, click Close. If an error occurs, note the
error, take corrective action, and then repeat this procedure. Most errors you’ll see
have to do with e-mail being improperly configured. Your mail administrator can
help you to resolve e-mail errors.
On the Pending tab, you’ll see your Pending Create request. Because you created the
request, you can right-click the request and then select Withdraw to remove the request at
any time (see Figure 4-12). Otherwise, you need to wait for an Approver or a Full Control
Administrator to handle your request.

FIGURE 4-12 Review or withdraw your request on the Pending tab.
To reject a pending create request, an Approver or a Full Control Administrator right-
clicks the request and then clicks Reject. When prompted, the Approver or Full Control
Administrator can enter an optional comment before clicking OK to reject the request.
Rejecting the request cancels the pending GPO creation task.
To approve a pending create request, an Approver or a Full Control Administrator right-
clicks the request and then clicks Approve. When prompted to confirm, the Approver or
Full Control Administrator can enter an optional comment before clicking Yes to authorize
the GPO to be created. When the request is accepted, the GPO is created and the archive
copy is made available on the Controlled tab. If the Editor specified that the GPO should
be created in production, the GPO is also created in the production environment. To
finalize the GPO, you must:
1.                  Check out the GPO from the archive.
2.                  Edit the GPO.
3.                  Check in the GPO to the archive.
4.                  Deploy the GPO to production. This copies the GPO from the archive to
production.
5.                  Link the GPO to the appropriate containers in Active Directory.

Controlling GPOs
When you select the Change Control node in the GPMC and are working with the top-
level Contents tab, uncontrolled GPOs are listed on the Uncontrolled tab. To control an
uncontrolled GPO, you must have appropriate permissions. Reviewers require prior
approval to control GPOs. Editors, Approvers, and Full Control Administrators can
control GPOs without needing prior approval.
Real World  When you create a new controlled GPO using the AGPM extensions,
the AGPM Service account is delegated permission to manage the GPO
(specifically, the account is granted the Edit Settings, Delete, and Modify Security
permissions). To ensure that you can control GPOs created outside AGPM or prior
to installing AGPM, you need to ensure that the AGPM Service account is either a
member of a group with similar permissions or that you delegate these permissions
manually as discussed in “Delegating Control for Working with GPOs” in Chapter
3.
Controlling GPOs with Permissions
If you are an Editor, an Approver, or a Full Control Administrator, you can control a GPO
by completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Uncontrolled tab, right-click the GPO you want to control and then
select Control.
3.                  In the Control GPO dialog box, enter a comment for the change history if
you want. When you click OK, the GPO is copied to the offline archive and is
displayed on the Controlled tab.
Controlling GPOs Without Permissions
If you are a Reviewer, you can control a GPO by completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Uncontrolled tab, right-click the GPO you want to control and then
select Control.
3.                  In the Submit Control Request dialog box, shown in Figure 4-13. Do the
following:
1.               If you want to send a courtesy copy of the request to someone, enter the e-
mail address in the CC box. You can enter multiple e-mail addresses by separating
them with commas. Optionally, enter a comment. Click Submit.
2.               The AGPM Progress window tracks the progress of the request
submission. When GPMC is finished, click Close. If an error occurs, note the
error, take corrective action, and then repeat this procedure. Most errors you’ll see
have to do with e-mail being improperly configured. Your mail administrator can
help you resolve e-mail errors.

On the Pending tab, you’ll see your Pending Control request. Because you created the
request, you can right-click the request and then click Withdraw to remove the request at
any time. Otherwise, you need to wait for an Editor, an Approver, or a Full Control
Administrator to handle your request.
FIGURE 4-13 Request approval for your action.
To reject a pending control request, an Approver, or a Full Control Administrator right-
clicks the request and then clicks Reject. When prompted, the Approver or Full Control
Administrator can enter an optional comment before clicking OK to reject the request.
Rejecting the request cancels the pending control task. This means that the GPO remains
uncontrolled and is listed on the Uncontrolled tab.
To approve a pending control request, an Approver or a Full Control Administrator right-
clicks the request and then selects Approve. When prompted to confirm, the Editor,
Approver, or Full Control Administrator can enter an optional comment before clicking
Yes to authorize the GPO to be controlled. When the request is accepted, the GPO is
copied to the offline archive from the production environment and made available on the
Controlled tab.

Importing GPOs from Production
Importing a GPO from production copies the GPO from the live production environment
to the offline archive. This procedure:
Overwrites the archive copy
Ensures that the archive copy is current
Undoes any unapplied edits in the archive copy
Only Approvers and Full Control Administrator can import GPOs from production. If you
are an Approver or a Full Control Administrator, you can import a GPO from production
by completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled tab, right-click the GPO you want to import from
production, select Import From, and then click Production.
3.                  When prompted, provide a history comment, and then click OK.
4.                  The AGPM Progress window tracks the progress of the import process.
When the GPMC is finished creating the template, click Close. If an error occurs,
note the error, and take corrective action as necessary.
Note  If you created a GPO in the archive only and haven’t previously deployed it
to production, a production copy does not exist. Therefore, the Import From
command is dimmed when you right-click the GPO.

Checking Out, Editing, and Checking In Controlled GPOs
One of the most important features that AGPM provides is the ability for you to edit a
GPO offline because it ensures that no one else is modifying the offline copy you are
working with. To do this, AGPM implements change controls that require you to check
out a GPO prior to editing it.
Only Editors and Full Control Administrators can check out and edit a GPO. An Editor or
a Full Control Administrator checks out a GPO from the offline archive by right-clicking
it and selecting Check Out. When you check out a GPO, the GPMC does several things:
Changes the state of the GPO to Checked Out and adds a red highlight to the GPO’s
icon on the Controlled tab.
Allows only the person who checked out the GPO to edit it (within the change
control system). However, an Approver or a Full Control Administrator is still able to
check in the GPO or undo the checkout of the GPO.
Opens a copy of the GPO in the Group Policy Management Editor.
Modifies the GPO’s history to note the state change.
The person who checked out the GPO can edit it by right-clicking it and clicking Edit.
When finished, he or she can check in the modified GPO to the offline archive by right-
clicking the GPO and clicking Check In.
When you check in a GPO, the GPMC does several things:
Changes the state of the GPO to Checked In and removes the red highlight from the
GPO’s icon on the Controlled tab.
Modifies the history to note the state change.
Establishes the archive copy as the previous version and the version you are checking
in as the current version.
Tip  If you double-click a GPO on the Controlled tab, you open a history window.
This window has an All States tab, which shows a history of the state changes, and a
Unique Versions tab, which shows a list of all unique versions of the GPO that are
available. You can restore a particular version from the history to establish it as the
current version. You can also compare versions in the history to identify the changes
that were made.
Checking in a GPO doesn’t deploy the GPO; deploying a GPO is a separate process. You
don’t have to apply the changes you’ve made to your copy of the GPO. If you want to
discard any changes when you check the GPO back in, right-click the GPO and then click
Undo Check Out.
When you undo a check out of a GPO, the GPMC does several things:
Changes the state of the GPO to Checked In and removes the red highlight from the
GPO’s icon on the Controlled tab.
Modifies the history to note the state change.
When a GPO is checked out, an Approver or a Full Control Administrator can check in the
GPO or undo the checkout of the GPO.

Deploying Controlled GPOs
Checking in a GPO doesn’t deploy the GPO; deploying a GPO is a separate process.
When you deploy a GPO, you copy the current version of the GPO from the offline
archive to the live production environment.
Real World  Group Policy access control lists (ACLs) can be modified through security
filtering, WMI filtering, and delegation. For policy to apply, a user must have both Read
and Apply Group Policy permissions for the GPO. If a user doesn’t have either one,
policy stops applying for that object. Read permission is also required in order to manage
a GPO.
For AGPM to control the administrative delegation that gets applied to a GPO, AGPM
overrides (and rewrites) the security descriptors for a controlled GPO when you deploy
it. This ensures that every GPO is configured with an access control list that mandates
that the control of that GPO belongs to AGPM, so you can provide access to those that
need it within AGPM, not within GPMC.
Permissions are added for the AGPM Service account, and all Deny permissions except
the Deny permission for Apply Group Policy are removed. Adding permissions for the
AGPM service account ensures that change control works properly for the GPO.
Preserving the Deny permission for Apply Group Policy ensures that users or groups can
be excluded from having policy applied. Other individual Deny permissions are not
preserved, however, to ensure that change control can function as expected.
Deploying a GPO with Permissions
Only Approvers and Full Control Administrators can deploy a GPO without prior
approval. If you are an Approver or a Full Control Administrator, you must complete the
following steps to deploy a GPO:
1.                  In the GPMC, right-click the GPO on the Controlled tab and then click
Deploy.
Note  During deployment, no existing links are deleted nor will any OUs be
created. Also note that AGPM does not manage site links. Therefore, site links will
not be modified or restored.
2.                  The Deploy GPO dialog box prompts you to confirm the action, as shown
in Figure 4-14. By default, existing links are not modified. Only links that existed
when the GPO was last archived or checked in but have since been removed are
restored.
Note  The Restore Links check box and the Advanced button are grayed out
(dimmed) if a production GPO copy that was previously imported had no links or if
the online GPO copy has not yet been linked.

FIGURE 4-14 Confirm that you want to deploy the selected GPO.
3.                  To review the GPO’s links prior to deploying it, click Advanced. The GPO
Links For Selected GPOs dialog box shows you where the GPO is linked. Do the
following, and then click OK:
Select the links you want to restore.
Clear the related check box for links you do not want to restore.
4.                  If you don’t want to restore any previous links, clear the Restore Links
check box.
5.                  Click Yes to deploy the GPO to production.
Deploying a GPO Without Permissions
Editors who are not Approvers or Full Control Administrators must get approval to deploy
a GPO. If you are an Editor, you can deploy a GPO by completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled tab, right-click the GPO you want to control and then
click Deploy.
3.                  In the Submit Control Request dialog box, do the following:
1.               If you want to send a courtesy copy of the request to someone, enter the e-
mail address in the CC box. You can enter multiple e-mail addresses by separating
them with commas. Optionally, enter a comment. Click Submit.
2.               The AGPM Progress window tracks the progress of the request
submission. When the GPMC is finished, click Close. If an error occurs, note the
error, take corrective action, and then repeat this procedure. Most errors you’ll see
have to do with e-mail being improperly configured. Your mail administrator can
help you resolve e-mail errors.
On the Pending tab, you’ll see the pending deploy request. Because you created the
request, you can right-click the request and then click Withdraw to remove the request at
any time. Otherwise, you’ll need to wait for an Approver or a Full Control Administrator
to handle your request.
To reject a pending deploy request, an Approver or a Full Control Administrator right-
clicks the request and then selects Reject. When prompted, the Approver or Full Control
Administrator can enter an optional comment before clicking OK to reject the request.
Rejecting the request cancels the pending deploy task. This means the GPO is returned to
the Controlled tab and is not copied to the live production environment.
To approve a pending control request, an Approver or a Full Control Administrator right-

clicks the request and then selects Approve. When prompted to confirm, the Approver or
Full Control Administrator can enter an optional comment before clicking Yes to authorize
the GPO to be deployed. By default, existing links are not modified. Only links that
existed when the GPO was last archived or checked in but have since been removed are
restored. If you don’t want to restore previous links, clear the Restore Links check box
before clicking OK.
When the request is accepted, the GPO is copied from the offline archive to the production
environment and made available once again on the Controlled tab. During deployment, no
existing links are deleted nor will any OUs be created. Also note that AGPM does not
manage site links. Therefore, site links will not be modified or restored.

Identifying Differences in GPOs
You can generate difference reports to analyze the differences between Group Policy
objects (GPOs), templates, or different versions of a single GPO. Reports can be formatted
in HTML or XML, depending on your preference.
If you are a Reviewer, an Editor, an Approver, or a Full Control Administrator, you can :
Determine the differences between two GPOs or templates Select the two GPOs
or templates. Right-click one of the GPOs or templates, click Differences, and then
click HTML Report or XML Report to display a differences report summarizing the
settings of the GPOs or templates.
Determine the differences between a GPO and a template Right-click the GPO,
click Differences, and then click Template. Select the template and type of report, and
then click OK to display a differences report summarizing the settings of the GPO
and template.
Determine the differences between versions of a GPO Double-click the GPO to
display its history, and then select the versions to be compared. Right-click one of the
versions, click Differences, and then click HTML Report or XML Report to display a
differences report summarizing the settings of the GPOs.
Determine the differences between a GPO version and a template Double-click
the GPO to display its history. Right-click the GPO version to examine, click
Differences, and then click Template. Select the template and type of report, and then
click OK to display a differences report summarizing the settings of the GPO version
and template.

Reviewing GPO Links
You can display a diagram showing where GPOs are linked to domains and organizational
units. GPO link diagrams are updated each time you control, import, or check in a GPO.
If you are a Reviewer, an Editor, an Approver, or a Full Control Administrator, you can
review the links to GPOs. To display GPO links for one or more GPOs, complete the
following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled, Pending, or Recycle Bin tab, right-click the GPO you
want to work with.
3.                  On the shortcut menu, click Settings and then click GPO links.
To display GPO links for one or more versions of a GPO, complete the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled, Pending, or Recycle Bin tab, double-click the GPO to
display its history.
3.                  In the History window, right-click the GPO version you want to review,
click Settings, and then click HTML Report or XML Report to display a summary
of the GPO’s settings.

Labeling and Renaming Controlled GPOs
Normally, you add comments to a GPO when you change its state. If you are an Editor, an
Approver, or a Full Control Administrator, you can also add comments to a GPO by using
labels. In the GPMC, right-click a GPO on the Controlled tab and then select Label. In the
Label GPO dialog box, enter a label and comment and then click OK. The label you
provide is entered in the State field, and your comments are entered in the Comment field.
Editors and Full Control Administrators can rename controlled GPOs using options on the
Controlled tab. To rename a GPO, right-click a GPO that is checked in and then click
Rename. In the Rename GPO dialog box, enter the new name for the GPO, add an
optional comment if you want, and then click OK.

Uncontrolling GPOs
Once you control a GPO, there is no option to remove control from it. A controlled GPO is
simply a GPO with an offline copy in an archive and a live production copy, while an
uncontrolled GPO is a GPO with only a live production copy. Therefore, if you no longer
want to control a GPO, you can remove control simply by deleting the GPO from the
archive but keeping the production copy. Deleting a GPO from the archive moves it to the
recycle bin where it can be restored or purged later.
Editors, Approvers, and Full Control Administrators can delete GPOs from the archive. To
delete a GPO from the archive and remove control from it, complete the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled tab, check the status of the GPO you no longer want to
control. If the GPO is checked in, you can remove control. Right-click the GPO and
then select Delete.
3.                  In the Delete dialog box, shown in Figure 4-15, select Delete GPO From
Archive Only and then click OK.
FIGURE 4-15 Delete a GPO from the archive to stop controlling it.
4.                  Next, when prompted to confirm, click Yes. The GPMC moves the GPO to
the recycle bin. If you select the Recycle Bin tab, you’ll see the deleted GPO, as
shown in Figure 4-16.

FIGURE 4-16 View deleted GPOs in the recycle bin.

Deleting Controlled GPOs
To delete a controlled GPO and move it to the recycle bin, you must be an Approver or a
Full Control Administrator. While Approvers and Full Control Administrators can delete a
controlled GPO directly, Editors who are not Approvers or Full Control Administrators
must have approval.
Note  As I mentioned at the beginning of the chapter, the change control system is
only as good as your policies regarding its use. An administrator who has
appropriate permissions can delete the production copy of any GPO by right-
clicking the GPO under the Group Policy Objects node in the GPMC and choosing
Delete. Though this does not delete the archive copy of the GPO, it does go around
the change control system.
Deleting a GPO with Permissions
If you are an Approver or a Full Control Administrator and want to delete the GPO from
the archive and production, complete the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled tab, check the status of the GPO you want to delete. If
the GPO is checked in, you can delete it by right-clicking it and then clicking
Delete.
Tip  Before you can delete a checked out GPO, you must check it back in or undo
the previous check out. Don’t take this step without discussing the issue with the
person who checked out the GPO.
3.                  Next, to remove only the copy of the GPO from the archive, select Delete
GPO From Archive Only and then click OK. To remove the GPO from the archive
and from production, select Delete GPO From Archive And Production.
4.                  When prompted to confirm, click Yes. The GPMC moves the GPO to the
recycle bin. If you select the Recycle Bin tab, you’ll see the deleted GPO.
Deleting a GPO Without Permissions
Editors who are not Approvers or Full Control Administrators must get approval to delete
a GPO from both the archive and production. If you are an Editor, you can delete a GPO
from both the archive and production by completing the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  On the Controlled tab, check the status of the GPO you want to delete. If
the GPO is checked in, you can delete it by right-clicking it and then selecting
Delete.
3.                  To remove only the copy of the GPO from the archive, select Delete GPO
From Archive Only and then click OK. When prompted to confirm, click Yes. The
GPMC moves the GPO to the recycle bin. If you select the Recycle Bin tab, you’ll
see the deleted GPO.

4.                  To remove the GPO from the archive and from production, select Delete
GPO From Archive And Production, and then click OK. When the Submit Control
Request dialog box is displayed, do the following:
1.               If you want to send a courtesy copy of the request to someone, enter the e-
mail address in the CC box. You can enter multiple e-mail addresses by separating
them with commas. Optionally, enter a comment. Click Submit.
2.               The AGPM Progress window tracks the progress of the request
submission. When GPMC is finished, click Close. If an error occurs, note the
error, take corrective action, and then repeat this procedure. Most errors you’ll see
have to do with e-mail being improperly configured. Your mail administrator can
help you resolve e-mail errors.
On the Pending tab, you’ll see your Pending Delete request. Because you created the
request, you can right-click the request and then select Withdraw to remove the request at
any time. Otherwise, you’ll need to wait for an Approver or a Full Control Administrator
to handle your request.
To reject a pending delete request, an Approver or a Full Control Administrator right-
clicks the request and then selects Reject. When prompted, the Approver or Full Control
Administrator can enter an optional comment before clicking OK to reject the request.
Rejecting the request cancels the pending delete task. This means the GPO is returned to
the Controlled tab and is not deleted from the archive or production.
To approve a pending delete request, an Approver or a Full Control Administrator right-
clicks the request and then selects Approve. When prompted to confirm, the Approver or
Full Control Administrator can enter an optional comment before clicking Yes to authorize
the GPO to be deleted.
When the request is accepted, the GPO is removed from the offline archive and the
production environment. A copy of the GPO is placed in the recycle bin and can be
viewed by selecting the Recycle Bin tab.

Restoring or Destroying Controlled GPOs
When you delete a GPO or GPO template, the item is moved to the recycle bin within the
AGPM archive (see Figure 4-17). The GPO or GPO template will remain in the recycle
bin until it is either restored or destroyed. Restoring a deleted GPO or GPO template
returns it to the archive. Destroying a GPO or GPO template permanently removes it from
the archive.
Tip  If a GPO was deleted from the production environment, restoring it to the
archive will not automatically redeploy it to the production environment. To return
the GPO to the production environment, you must deploy the GPO as discussed in
“Deploying Controlled GPOs” earlier in this chapter.
FIGURE 4-17 Destroy or restore GPOs.
Restoring or Destroying Items with Permissions
If you are an Approver or a Full Control Administrator and want to restore or destroy a
GPO or GPO template, complete the following steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  Select the Recycle Bin tab to display a list of deleted GPOs and GPO
templates.
3.                  Do one of the following:
To restore a GPO or GPO template, right-click it and then click Restore. When
prompted to confirm, add a comment if you want to, and then click OK. When the
AGPM Progress window indicates the operation is complete, click Close. The GPO
or GPO template is then restored to its previous location, either the Controlled tab
or the Templates tab.
To destroy a GPO or GPO template, right-click it and then select Destroy. When

prompted to confirm, click Yes. When the AGPM Progress window indicates the
operation is complete, click Close. The GPO or GPO template is then removed from
the recycle bin and permanently deleted.
Restoring or Destroying Items Without Permissions
Editors who are not Approvers or Full Control Administrators cannot permanently delete
GPOs or GPO templates. They can, however, request that a GPO or GPO template be
restored.
If you are an Editor, you can restore a GPO or GPO template by completing the following
steps:
1.                  In the GPMC, select the Change Control node in the domain you want to
work with and then select the top-level Contents node.
2.                  Select the Recycle Bin tab to display a list of deleted GPOs and GPO
templates.
3.                  Right-click the GPO or GPO template to restore and then click Restore.
4.                  When the Submit Control Request dialog box is displayed, do the
following:
1.               If you want to send a courtesy copy of the request to someone, enter the e-
mail address in the CC box. You can enter multiple e-mail addresses by separating
them with commas. Optionally, enter a comment. Click Submit.
2.               The AGPM Progress window tracks the progress of the request
submission. When GPMC is finished, click Close. If an error occurs, note the
error, take corrective action, and then repeat this procedure. Most errors you’ll see
have to do with e-mail being improperly configured. Your mail administrator can
help you resolve e-mail errors.
On the Pending tab, you’ll see your pending restore request. Because you created the
request, you can right-click the request and then select Withdraw to remove the request at
any time. Otherwise, you’ll need to wait for an Approver or a Full Control Administrator
to handle your request.
To reject a pending delete request, an Approver or a Full Control Administrator right-
clicks the request and then selects Reject. When prompted, the Approver or Full Control
Administrator can enter an optional comment before clicking OK to reject the request.
Rejecting the request cancels the pending restore task. This means the GPO or GPO
template is returned to the Recycle Bin tab.
To approve a pending restore request, an Approver or a Full Control Administrator right-
clicks the request and then selects Approve. When prompted to confirm, the Approver or
Full Control Administrator can enter an optional comment before clicking Yes to authorize
the GPO to be deleted.
When the request is accepted, the GPO or GPO template is restored to its previous
location, either the Controlled tab or the Templates tab.


Controlling GPO Versions and History
After you install AGPM, the GPMC tracks the history of each GPO you’ve created. When
you are working with GPOs in the Group Policy Object node or GPO links within other
nodes, you can view this history by selecting the GPO or GPO link in the left pane and
then clicking the History tab in the details pane. When you are working with the Change
Control node and its top-level Contents tab, you can display the history of a GPO by
double-clicking the GPO or by right-clicking a GPO and then clicking History.

Working with GPO History
History provides a record of events in the lifetime of the selected GPO. When you are
working with the History window, there are two related subtabs:
All States Tracks changes in the state of the GPO. State changes that occurred in
production are identified with the label Production.
Unique Versions Tracks the unique versions of the GPO that are checked into the
archive. The version deployed to the production environment, shortcuts to unique
versions, and informational states are omitted from this list.
When you are working with GPO history, you can compare multiple versions of a GPO or
obtain a report of the settings within a version of a GPO. Both of these tasks are discussed
in “Identifying Differences in GPOs” earlier in the chapter.
By default, every version of every controlled GPO is retained in the archive. However,
you can configure the AGPM Service to limit the number of versions retained for each
GPO and automatically delete the oldest version when that limit is exceeded. To do this,
complete the following steps:
1.                  In the GPMC, select the Change Control node and then select the top-level
Contents tab.
2.                  After you select the AGPM Server tab, do one of the following:
To limit the number of versions of a GPO maintained in the archive, select the
Delete Old Versions check box. Specify how many versions to retain, and then click
Apply.
To retain all the versions of a GPO in the archive, clear the Delete Old Versions
check box and then click Apply.
When a GPO version is deleted, a record of that version remains in the history of the GPO,
but the GPO version itself is deleted from the archive. The maximum number of unique
versions to store for each GPO does not include the current version, so entering 0 retains
only the current version. The limit can be no more than 999 versions.

Preventing or Enabling Deletion of History Versions
In the History window, you can prevent a GPO version from being deleted by marking it
as not deletable. To specify whether a version of a GPO is deletable, right-click it and then
do one of the following:
Click Do Not Allow Deletion to prevent the version from being deleted from the
history.
Click Allow Deletion to allow the version to be deleted from the history.

Rolling Back to a Previous Version of a GPO
As an Approver or a Full Control Administrator, you can roll back changes to a GPO by
redeploying an earlier version of the GPO from its history. Deploying an earlier version of
a GPO overwrites the version of the GPO currently in production.
To deploy a previous version of a GPO to the production environment, complete the
following steps:
1.                  In the GPMC, select the Change Control node and then select the top-level
Contents tab.
2.                  On the Controlled tab, double-click the GPO you want to work with to
display its history.
3.                  Right-click the version to be deployed, and then click Deploy. When
prompted to confirm, click Yes. When the AGPM Progress window indicates the
operation is complete, click Close. In the History window, click Close.
The version you deployed becomes the current version in production.


Chapter 5. Searching and Filtering Group Policy
Because Group Policy is so extensive, it sometimes can be difficult to find what you are
looking for in the Group Policy Management Console (GPMC) and related policy editors
—whether it’s a set of policies, a particular Group Policy object (GPO), or an object that
Group Policy is affecting. Rather than search through every single GPO and every related
policy setting in those GPOs, you can save time and be much more effective by using one
of several filtering techniques, including filtering policy settings to streamline the view
and searching policy objects, links, and configuration settings for various conditions,
values, and keywords.
By default, a linked GPO applies to all users and computers in the container to which it is
linked. But sometimes you don’t want a GPO to apply to a user or computer in a particular
container, and this is where processing filters come in handy. You can apply two types of
processing filters to GPOs:
Security group filters Control the security groups to which a policy object is
applied
Windows Management Instrumentation (WMI) filters Control the computers to
which a policy object is applied
Processing filters are very different from view filters. You filter the view to make it easier
to find what you are looking for in the GPMC and related editors. You filter the way
policy is processed to change how policy is applied.


Finding Policy Settings
When you are viewing or editing a GPO, all policy settings for all Administrative
templates are displayed in the Group Policy Management Editor by default. Because so
many policy settings are available and many of them might not be applicable in your
environment or might not be suited to your current needs, this default view can make
finding the policy settings you want to work with difficult.

Filtering Techniques for Policy Settings
To reduce the policy set and make it more manageable, you can filter the view so that only
the policy settings you want to work with are shown. For example, if you are looking for a
particular group of policy settings, such as those that are configured for or can be used
with computers running Windows 8.1 or later, you can filter the view to show only those
policy settings.
The one drawback is that this type of filtering applies only to settings within the
Administrative templates. Anytime you are actively editing a GPO, you can filter the
Administrative templates by using any combination of the following techniques:
Show or hide policy settings that can be fully managed
Show or hide policy settings that are currently configured
Show or hide policy settings that have comments
Show only the policy settings that contain a specific keyword
Show only the policy settings that apply to a specific requirement regarding the
operating system, application, or system configuration
Note  Filtering policy settings only affects their display in the Group Policy
Management Editor. Filtered policy settings are still applied as intended throughout
the site, domain, or organizational unit (OU).
Policy settings within the Administrative templates are either managed by the Group
Policy service or they are not. When a policy setting is managed by the Group Policy
service, it is added and applied when it is in scope for a computer or a user and removed if
it later falls out of scope for a computer or a user. When a policy setting is unmanaged, it
is added and applied when it is in scope for a computer or a user but is not removed if it
later falls out of scope.
Showing or hiding managed settings is useful if you want to ensure that you are working
with nonlegacy policy settings. As legacy policy settings typically modify different
sections of the Windows registry than do template settings for current versions of
Windows, it is recommended that you not use legacy Administrative templates, and the
option not to use them is selected by default. If you want to work with legacy
Administrative templates and their settings, you must clear this filter option.
Showing or hiding policy settings that are currently configured is useful when you want to
determine what policy settings have or have not been applied. By filtering policy to show
only configured settings, you see only policy settings that are enabled or disabled, and
policy settings that are set as “not configured” are hidden. Conversely, when you filter
policy to show only nonconfigured settings, you see only policy settings that are set as
“not configured,” and policy settings that are enabled or disabled are hidden from view.
Every policy setting in the Administrative templates has a comment property. This
property allows any administrator to enter text associated with a specific policy setting.
When you are trying to find comments from other administrators or comments you made
previously, you can show policy settings with comments. If you are trying to add
documentation to policy settings, you might also want to search for policy settings that are
configured but have no comments.

Keyword and requirements filters let you narrow the match criteria even further. Keyword
filters are inclusive. You use them to select items you want to display rather than to hide
items you don’t want to display.
You can filter keywords in one of the following ways:
Any Matches policy settings that include any of the words in the filter. Choose Any
to separately match any of the keywords. For example, if you enter security, key,
and computer, any policy setting that contains the word security, the word key, or
the word computer is a match for the keyword filter.
All Matches policy settings that include all the words in the filter. Choose All to
match only settings that have all the keywords. For example, if you enter security,
key, and computer, only policy settings that contain all three words are a match for
the keyword filter.
Exact Matches policy settings that are exact matches for a keyword phrase. Choose
Exact to exactly match a keyword phrase. For example, if you enter security key on
computer, only policy settings that contain this exact phrase are a match for the
keyword filter.
The keyword filter can search within any combination of the following:
Policy setting title Used to search within the title of a policy setting
Explain text Used to search within the explanatory text associated with a policy
setting
Comment Used to search within the comment text associated with a policy setting
You use requirements filters when you want to view only the policy settings that work
with specific technologies and operating systems. By filtering policy settings in this way,
you see only the policy settings that meet your specified operating system, application, or
system configuration requirements. For example, you could filter policy to:
View only the policy settings that are supported by Windows 8.1 or later.
View only the policy settings that apply to Windows Internet Explorer 11.
View only the policy settings that apply to Internet Explorer 11 on Windows 8.1 or
later.
As you can see, this makes it easy to find policy settings that match very stringent criteria.

Filtering Policy Settings
When you are viewing or editing a policy object in the Group Policy Management Editor,
you can filter the related policy settings to find the policy settings you want to work with.
Filtering works only with the Administrative templates. When you apply a filter, the filter
applies to both Computer Configuration and User Configuration settings.
To filter policy settings, complete the following steps.
1.                  In the Group Policy Management Editor, expand Policies and then expand
Computer Configuration or User Configuration as appropriate.
2.                  Right-click Administrative Templates, and then choose Filter Options to
open the Filter Options dialog box, shown in Figure 5-1.
3.                  To filter by managed or unmanaged policy settings, choose one of the
following options from the Managed list:
Any Displays both managed and unmanaged settings
Yes Displays only managed settings
No Displays only unmanaged settings
4.                  To filter by configured state, choose one of the following options from the
Configured list:
Any Displays both configured and not configured settings
Yes Displays only settings that are configured
No Displays only settings that are not configured
5.                  To filter based on whether a policy setting has comments, choose one of
the following options from the Comment list:
Any Displays both commented and uncommented policy settings
Yes Displays only settings that have comments
No Displays only settings that do not have comments

FIGURE 5-1 Use the available options to define your filter.
6.                  To filter policy settings by keyword, do the following:
1.               Select the Enable Keyword Filters check box.
2.               Enter one or more keywords in the Filter For Word(s) box.
3.                In the Search Criteria list, make a selection. Choose Any to match any of
the words in the Filter For Word(s) box. Choose All to match only settings that
have all the words in the Filter For Word(s) box. Choose Exact to exactly match
the phrase in the Filter For Word(s) box.
4.               Select the appropriate check boxes next to Within. Select Policy Setting
Title to search the title of the policy setting. Select Explain Text to search the
explanatory text of the policy setting. Select Comment to search the comment of
the policy setting.
7.                  To filter policy settings by requirements, do the following:
1.               Select the Enable Requirements Filters check box.
2.               In the Select The Desired Platform And Application Filter(s) list, make a
selection. Choose Include Settings That Match Any Of The Selected Platforms to
display policy settings that match any of the technologies or platforms you select.
Choose Include Settings That Match All Of The Selected Platforms to display

policy settings that match all the technologies and platforms you select.
3.                Select the technologies and platforms you want to match.
8.                  Click OK to apply your filter settings and close the Filter Options dialog
box.
When you apply a filter, the view of the Administrative Templates node is filtered and a
filter icon is added to the Administrative Templates node and any subnodes under
Computer Configuration and User Configuration that contain policy settings that match
the filter criteria, as shown in Figure 5-2. You can navigate the matching nodes as you do
normally. If you select the All Settings node under either Computer Configuration or User
Configuration, you’ll see a complete list of the policy settings that match your filter
criteria for either Computer Configuration or User Configuration, as appropriate. To
remove the filter, right-click Administrative Templates and then select Filter On to clear
the filtering flag.
FIGURE 5-2 Review the policy settings that match the filter criteria.


Searching for GPOs
Clearly, being able to search within individual GPOs is helpful. Still, you’ll often want to
perform similar searches on a larger scope, such as searching all GPOs in a domain or
forest for specific values or configuration criteria. To search all GPOs in a domain or
forest, you can use the search feature in the Group Policy Management Console (GPMC).

Search Techniques for Policy Objects, Links, and Settings
If you want to find a specific policy object, link, or setting, the GPMC search feature is the
right tool for you. You can use the search feature to find virtually any value associated
with a policy object. The search feature can search all GPOs in the currently selected
domain or in all the domains of a selected forest.
You can search for any of the following items:
GPO Name Allows you to search for a policy object by name. For example, if you
know that a policy object has the word Sales in its name but you don’t know in which
domain the object exists, you can search for all policy objects with names that
contain this keyword.
GPO Links Allows you to search for policy objects that are linked or not linked in
a particular domain. For example, if you want to find all policy objects that are linked
in a particular domain, you can search for all policy object links that exist in that
domain. Or, if you want to find all policy objects that aren’t currently linked to a
domain, you can search for all policy object links that do not exist in that domain.
Security Groups, Users, or Computers Allows you to search for security groups,
users, or computers that have directly assigned (explicit) or inherited (implicit) Group
Policy management privileges in a particular domain or in all domains in a forest. For
example, you might need to know whether the ServiceTechs group has explicit
permission to edit Group Policy settings or whether the user MikeP has permission to
read Group Policy settings in a particular domain or in any domain of the current
forest.
Linked WMI Filter Allows you to search for a linked Windows Management
Instrumentation (WMI) filter in a particular domain. This allows you to determine
whether a filter with specific criteria is or is not being applied.
User Configuration Allows you to quickly determine whether certain policy
preferences and policy settings under User Configuration are configured. You can
search all areas of policy preferences and many areas of policy settings. For example,
you might need to find policy objects in a particular domain that have Folder
Redirection configured, and you can use this search feature to do so.
Computer Configuration Allows you to quickly determine whether certain policy
preferences and policy settings under Computer Configuration are configured. You
can search all areas of policy preferences and many areas of policy settings. For
example, you might need to find policy objects in a particular domain that have a
802.3 wireless networking policy configured, and you can use this search feature to
do so.
GUID Allows you to search for a policy object by its globally unique identifier
(GUID). This is useful if you already know the full GUID of a policy object that you
need to locate. A typical scenario where you might know the GUID and not know the
policy object location is when you are troubleshooting a problem with Group Policy
and see errors that reference the GUID of a policy object.
As part of your search, you define the conditions under which matches are found.
Conditions are dynamic and based on the search item you select. Conditions can be
inclusive or exclusive. You use inclusive conditions to select items you want to display.

You use exclusive conditions to hide items you don’t want to display.
Conditions include:
Contains/Does Not Contain Allows you to search based on specific values that are
either contained or not contained in the search item. For example, if you are sure the
policy object you are looking for doesn’t have the word Security in its name (while
most other policy objects you’ve created do), you can search for a GPO Name that
does not contain the value Security.
Is/Is Not Allows you to search for a value that is or is not being used. For example,
you may want to search to determine whether a linked WMI filter is or is not being
applied to policy objects.
Is Exactly/Equals Allows you to search for an exact value associated with a search
item. For example, if you are sure the policy object you are looking for is named
Support Policy, you can search for a GPO Name that has that exact value.
Exist In/Does Not Exist In Allows you to search for GPO links that either exist in
or do not exist in the selected domain. This allows you to obtain a list of policy
objects linked in the domain or a list of policy objects linked outside the domain.
Has This Explicit Permission/Does Not Have This Explicit Permission Allows
you to search for security groups, users, and computers that have or do not have an
explicit permission in Group Policy. Explicit permissions are directly assigned. For
example, if TimC has been delegated the Edit Settings permission on the
TechServices Policy GPO, he has explicit Edit Settings permission with regard to this
object.
Has This Effective Permission/Does Not Have This Effective Permission 
Allows you to search for security groups, users, and computers that have or do not
have an effective permission in Group Policy. Effective permissions are indirectly
assigned. For example, a member of the Domain Admins group has the effective
permission to apply settings.
After you select a search item and a search condition for that search item, you specify the
value to match. As summarized in Table 5-1, each search item has different types of
values you can match. By combining search items and defining conditions for each, you
can narrow the search to find the policy objects you are looking for.
TABLE 5-1 Value for Search Items
Computer
Configuration
Specifies the policy area to match. Choose the policy area to match from the list provided. If you set
the condition as Contains, the GPO must have this area of policy configured to match the search
criteria. If you set the condition as Does Not Contain, the GPO must not have this area of policy
configured to match the search criteria.
GPO Links
Specifies whether to look for links in the current domain or all available sites. If you set the condition
as Exists In, the links in the domain or sites specified match the search criteria. If you set the
condition as Does Not Exist In, the links that do not exist in the domain or sites specified match the
search criteria.
GPO Name
Sets the text to match in the GPO name. If you set the condition as Contains, the name must contain
the text to match. If you set the condition as Does Not Contain, the name must not contain the text to
match. If you set the condition as Is Exactly, the name must be exactly as you enter it to match.

GUID
Sets the globally unique identifier (GUID) to match. As the only applicable condition is Equals , the
GUID you enter must match a GPO’s GUID exactly to match the search criteria.
Linked WMI
Filter
Sets the WMI filter to match. Choose the WMI filter name to match from the list provided. If you set
the condition Is, the GPO must have the filter applied to match the search criteria. If you set the
condition Is Not, the GPO must not have the filter applied to match the search criteria.
Security
Groups,
Users, or
Computers
Sets the delegated permissions to match. Choose the delegated permission to match from the list
provided. If you set the condition as Has This Explicit Permission, a security group, user, or
computer must have this explicit permission to match the search criteria. If you set the condition as
Does Not Have This Explicit Permission, a security group, user, or computer must not have this
explicit permission to match the search criteria.
User
Configuration
Sets the policy area to match. Choose the policy area to match from the list provided. If you set the
condition as Contains, the GPO must have this area of policy configured to match the search criteria.
If you set the condition as Does Not Contain, the GPO must not have this area of policy configured
to match the search criteria.

Performing Searches for GPOs
To search Group Policy for any of the previously discussed search criteria, complete these
steps:
1.                  Open the GPMC. If you want to search all the domains in a particular
forest, right-click the entry for the forest you want to work with and then click
Search. If you want to search a specific domain, right-click the domain and then
click Search.
2.                  In the Search For Group Policy Objects dialog box, shown in Figure 5-3,
select a search item on the Search Item list, such as GPO Name or User
Configuration.
FIGURE 5-3 Use specific search conditions and values to search Group Policy.
3.                  Use the Condition list to set the search condition.
4.                  Select or enter a search value in the Value field.
5.                  Click Add to add the search criteria.
6.                  As necessary, repeat steps 2 through 5 to add additional search criteria.
Keep in mind that additional search criteria further restrict the result set. A policy
object must match all search criteria to be displayed in the search results.
7.                  Click Search to search for policy objects that meet your search criteria.
As shown in Figure 5-4, the search results are displayed in the lower pane of the Search
For Group Policy Objects dialog box. GPOs are listed by name, domain, and GUID.

FIGURE 5-4 Review the search results.
You can view or edit the settings of any policy object listed by selecting it in the Search
Results list and then clicking Edit. If you have a long list of GPOs and want to save the
list, complete the following steps:
1.                  Click Save Results.
2.                  Use the Save GPO Search Results dialog box to select a save location for
the list.
3.                  Enter a file name.
4.                  Click Save. Each GPO is saved to a separate line within a comma-
separated values (CSV) text file. Within each line, commas are used to separate the
name, domain, and GUID values.


Using Security Group Filters
You’ll often need to determine or control whether and how Group Policy applies to a
particular security group, user, or computer. By default, GPOs apply to all users and
computers in the container to which a particular GPO is linked.

Security Group Filtering
When you’ve delegated Group Policy management permissions to users or have
administrators whose accounts are defined at the domain or OU level, you might not want
a policy object to be applied to such accounts. For example, if you’ve delegated
administrator privileges and Group Policy management permissions to Debby, you might
want to enable her to install programs and perform other tasks that standard users cannot
because of restrictions you’ve defined in Group Policy. In this case, you must take special
steps to ensure that a Group Policy object isn’t applied to Debby.
A linked GPO applies to users and computers because of the security settings on the GPO.
Two GPO permissions determine whether a policy object applies to a security group, user,
or computer:
Read If this permission is allowed, the security group, user, or computer can read
the policy for the purposes of applying it to other groups, users, or computers (not for
the purposes of viewing policy settings; View Settings is an explicit permission that
must be granted).
Apply Group Policy If this permission is allowed, the GPO is applied to the
security group, user, or computer. The settings of an applied GPO take effect on the
group, user, or computer.
Note  Additional permissions are also assigned to administrators and the operating
system. All members of the Enterprise Admins and Domain Admins groups, as well
as the Local System account, have permission to edit or delete GPOs and manage
their security.
A security group, user, or computer must have both Read and Apply Group Policy
permissions for a policy object to be applied. By default, all users and computers have
these permissions for all new GPOs. They inherit these permissions from their
membership in the implicit group Authenticated Users. An authenticated user is any user
or computer that has logged on to the domain and been authenticated.
To set the permissions so that a GPO applies only to specific users, security groups, or
computers (rather than to all authenticated users), you must remove Authenticated Users
from the permissions set and then add new security group filters for users who are to
receive the GPO. Only members of these groups within the site, domain, or OU where the
GPO is linked receive the GPO; members of the groups in other sites, domains, or OUs do
not receive the GPO.

Examining Security Group Filters
In the GPMC, you can determine which groups, users, and computers have been assigned
both Read and Apply Group Policy permissions by completing the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Expand the Group Policy Objects node, and then select the GPO you want
to work with.
4.                  In the details pane, click the Scope tab. On the Scope tab, the Security
Filtering pane shows which groups, users, and computers have been assigned both
Read and Apply Group Policy permissions. By default, only the Authenticated
Users group is listed.
FIGURE 5-5 Review the security filtering configuration.
Real World   You can add or remove groups, users, and computers directly from
the Security Filtering panel by using the Add and Remove options. Adding a group,
user, or computer grants Read and Apply Group Policy permissions. Removing a
group, user, or computer removes Read and Apply Group Policy permissions.
However, the Security Filtering panel doesn’t give you the complete picture of the
security permissions that have been assigned to the GPO. For this reason, I describe
how you should work with the Delegation tab in the sections that follow. On the
Delegation tab, you see the exact set of allowed permissions for all users and
groups. This lets you see at a glance how permissions are applied.

Applying Security Group Filters
By default, Authenticated Users, Creator Owner, System, Domain Admins, Enterprise
Admins, and Enterprise Domain Controllers have access permissions for GPOs. If you
install Advanced Group Policy Management (AGPM), the AGPM service account also
has permissions for GPOs.
To change permissions so that a GPO applies only to specific security groups, users, or
computers, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Expand the Group Policy Objects node, and then select the GPO you want
to work with.
4.                  In the details pane, click the Delegation tab to see a list of users and groups
that have some level of permissions for the selected policy object.
5.                  Click Advanced. In the Security Settings dialog box, shown in Figure 5-6,
you’ll see the list of users and groups that have permissions on the selected GPO.
When you select a user or group, you’ll see the individual permissions assigned.
FIGURE 5-6 Manage advanced permissions.
6.                  If the Authenticated Users group is listed, select it and then click Remove.
When prompted to confirm, click OK.

7.                  Click Add. Use the Select Users, Computers, Service Accounts, Or Groups
dialog box to select a security group, user, or computer that should have
permissions on the selected GPO. Click OK.
8.                  In the Security Settings dialog box, select the security group, user, or
computer you just added. Then do one of the following:
If the policy object should be applied to the security group, user, or computer, the
minimum permissions should be set to allow Read and Apply Group Policy.
If the policy object should not be applied to the security group, user, or computer,
the minimum permissions should be set to allow Read and deny Apply Group
Policy.
Caution  Don’t change other permissions unless you are sure of the consequences.
A better way to manage other permissions is to follow the techniques discussed in
“Delegating Privileges for Group Policy Management” in Chapter 3, “Group Policy
Management.”
9.                  Remove and add other groups, users, and computers as appropriate. When
you are finished, click OK to apply the security settings.
To remove security group filters and apply the GPO to all authenticated users, complete
the following steps:
1.                  In the GPMC, expand the Group Policy Objects node and then select the
GPO you want to work with.
2.                  In the details pane, click the Delegation tab to see a list of users and groups
that have some level of permissions for the selected policy object.
3.                  Click Advanced. In the Security Settings dialog box, shown earlier in
Figure 5-6, you’ll see the list of users and groups that have permissions on the
selected GPO. When you select a user or group, you’ll see the individual
permissions assigned.
4.                  If the Authenticated Users group is not listed, click Add. In the Select
Users, Computers, Or Groups dialog box, enter Authenticated Users and then
click OK.
5.                  With the Authenticated Users group selected, you should see that this
group has been granted Read permission by default. Under Allow, select Apply
Group Policy as well to assign this permission to the Authenticated Users group.
6.                  Remove any additional groups, users, or computers you added previously
by selecting each in turn and then clicking Remove. When prompted to confirm,
click OK.
7.                  When you are finished, click OK to apply the security settings.


Using WMI Filters
Windows desktops and Windows servers support Windows Management Instrumentation
(WMI). WMI is a management framework that you can use to query a computer to
determine its attributes. For example, you can create a WMI query to determine the
operating system running on a computer or the amount of available memory.
WMI queries by themselves are helpful, especially when used in scripts. To really tap into
their power, however, you can use them with WMI filters. A WMI filter consists of one or
more WMI queries that determine whether certain criteria are true. When you link a WMI
filter to a GPO, you can use it to control policy application by forcing Group Policy to
evaluate your queries with regard to the computers to which the GPO applies. If all the
queries return true, meaning that a target computer meets the search criteria, the settings in
the GPO are applied. If any of the queries return false, meaning that a target computer
does not meet the search criteria, the settings in the GPO are not applied.
WMI filters provide a powerful solution for targeting GPOs to specific users and
computers. However, because they are evaluated every time Group Policy is processed,
they can increase the amount of time it takes to process policy.

Creating WMI Queries
WMI filters apply only to computers running Windows desktop and Windows Server
operating systems. WMI filters are most useful as tools for exception management. By
filtering for particular criteria, you can target particular GPOs to specific users and
computers.
You create and manage WMI filters by using the GPMC. Most WMI filters use the
Root\CimV2 namespace, and this option is populated by default in the GPMC. In the
GPMC, you can link a GPO to only one WMI filter at a time. However, each WMI filter
can be linked to many GPOs.
WMI filters are evaluated on a destination computer after the list of potential GPOs is
determined and filtered based on security group membership. Because a WMI filter
applies to every policy setting in the GPO, you must create separate GPOs if you have
different filtering requirements for different policy settings.
You can use WMI filters to target Group Policy settings based on just about any
measurable characteristic of a computer, including:
Amount of memory installed
Available hard disk space
Processor type or speed
Network adapter type or speed
Operating system version, service pack level, or hotfix
Registry key or key value
System services that are running
You create WMI queries using the WMI Query Language. The basic syntax is:
Select * from WMIObjectClass where Condition
In this syntax, WMIObjectClass is the WMI class you want to work with, and Condition is
the condition you want to evaluate. The Select statement returns objects of the specified
class. A condition has three parts:
The name of the object property you are examining
An operator, such as = for equals, > for greater than, or < for less than
The value to evaluate
Operators can also be defined by using Is or Like. The Is operator is used to exactly match
criteria. The Like operator is used to match a keyword or text string within a value. In the
following example, you create a filter to target computers running Windows 8:
Select * from Win32_OperatingSystem where Caption like “%8%”
The Win32_OperatingSystem class tracks the overall operating system configuration. The
Win32_OperatingSystem class is one of two WMI object classes that you’ll use
frequently. The other is Win32_ComputerSystem. The Win32_ComputerSystem class
tracks the overall computer configuration.
In Windows PowerShell, you can use the Get-WMIObject cmdlet to get a WMI object that
you want to work with. By redirecting the object to Format-List *, you can list all the
properties of the object and their values. When working with WMI, you should work with

the root namespace, specified by setting the –Namespace parameter to root/cimv2. By
using the –Computer parameter, you can specify the computer you want to work with. If
you want to work with the local computer, use a dot (.) instead of a computer name.
Following this, you can examine the Win32_OperatingSystem object and its properties to
obtain summary information regarding the operating system configuration of a computer
by entering the following command at the Windows PowerShell prompt:
Get-WmiObject -Class Win32_OperatingSystem -Namespace root/cimv2
-ComputerName . | Format-List *
To save the output in a file, simply redirect the output to a file. In the following example,
you redirect the output to a file in the working directory named os_save.txt:
Get-WmiObject -Class Win32_OperatingSystem -Namespace root/cimv2
-ComputerName . | Format-List * > os_save.txt
The detailed operating system information, obtained by using this command, is shown in
Listing 5-1. Table 5-2 provides a summary of the operating system properties and their
meanings.
LISTING 5-1 Verbose Operating System Configuration Output
Status               : OK
Name                 : Microsoft® Windows Server® 2012 R2 Enterprise |C:\Windows|\Device\Harddisk1\Partition1
FreePhysicalMemory    : 679172
FreeSpaceInPagingFiles: 3749368
FreeVirtualMemory    : 2748020
__GENUS              : 2
__CLASS              : Win32_OperatingSystem
__SUPERCLASS         : CIM_OperatingSystem
__DYNASTY            : CIM_ManagedSystemElement
__RELPATH            : Win32_OperatingSystem=@
__PROPERTY_COUNT     : 65
__DERIVATION         : {CIM_OperatingSystem,
                      CIM_LogicalElement,
                      CIM_ManagedSystemElement}
__SERVER             : CORPSERVER84
__NAMESPACE          : root\cimv2
__PATH               : \CORPSERVER84\root\cimv2:Win32_OperatingSystem=@
BootDevice           : \Device\HarddiskVolume1
BuildNumber          : 7601
BuildType            : Multiprocessor Free
Caption              : Microsoft® Windows Server®
                      2012 R2 Enterprise 
CodeSet              : 1252
CountryCode          : 1
CreationClassName    : Win32_OperatingSystem
CSCreationClassName  : Win32_ComputerSystem
CSDVersion           : Service Pack 1
CSName               : CORPSERVER84
CurrentTimeZone      : -420
DataExecutionPrevention_32BitApplications : True
DataExecutionPrevention_Available         : True
DataExecutionPrevention_Drivers    : True
DataExecutionPrevention_SupportPolicy     : 3
Debug                : False
Description          : 

Distributed          : False
EncryptionLevel      : 256
ForegroundApplicationBoost         : 2
InstallDate          : 20140917143704.000000-480
LargeSystemCache     : 
LastBootUpTime       : 20140804124518.375199-420
LocalDateTime        : 20140804183034.619000-420
Locale               : 0409
Manufacturer         : Microsoft Corporation
MaxNumberOfProcesses : 4294967295
MaxProcessMemorySize : 8589934464
MUILanguages         : {en-US}
NumberOfLicensedUsers: 
NumberOfProcesses    : 95
NumberOfUsers        : 3
OperatingSystemSKU   : 10
Organization         : 
OSArchitecture       : 64-bit
OSLanguage           : 1033
OSProductSuite       : 274
OSType               : 18
OtherTypeDescription : 
PAEEnabled           : 
PlusProductID        : 
PlusVersionNumber    : 
Primary              : True
ProductType          : 2
QuantumLength        : 1
QuantumType          : 1
RegisteredUser       : Windows User
SerialNumber         : 
ServicePackMajorVersion            : 1
ServicePackMinorVersion            : 0
SizeStoredInPagingFiles            : 3974528
SuiteMask            : 274
SystemDevice         : \Device\HarddiskVolume2
SystemDirectory      : C:\Windows\system32
SystemDrive          : C:
TotalSwapSpaceSize          : 
TotalVirtualMemorySize      : 7591744
TotalVisibleMemorySize      : 3667328
Version              : 6.1.7601
WindowsDirectory     : C:\Windows 
Scope     : System.Management.ManagementScope
Path      : \Server52\root\cimv2:
            Win32_OperatingSystem=@
Options  : System.Management.ObjectGetOptions
ClassPath    : \CorpServer52\root\cimv2:
              Win32_OperatingSystem
Properties           : {BootDevice…}
SystemProperties     : {___GENUS, ___CLASS,
                      ___SUPERCLASS…}
Qualifiers           : {dynamic, Locale, provider, Singleton…}
Site          :
Container            :

TABLE 5-2 Properties of Win32_OperatingSystem
BootDevice
Disk drive from which the Win32 operating system boots.
BuildNumber
Build number of the operating system.
BuildType
Type of build used for the operating system, such as “retail
build”, “checked build”, or “Multiprocessor Free”.
Caption
Operating system name.
ClassPath
WMI object class path.
CodeSet
Code page value used by the operating system.
Container
The container associated with the object.
CountryCode
Country code used by the operating system.
CreationClassName
Name of the class from which the object is derived.
CSCreationClassName
Name of the class from which the computer system object
is derived.
CSDVersion
Indicates the latest service pack installed on the computer.
The value is NULL if no service pack is installed.
CSName
Name of the computer system associated with this object
class.
CurrentTimeZone
Number of minutes the operating system is offset from
Coordinated Universal Time. The value is positive,
negative, or zero.
DataExecutionPrevention_32BitApplications
Indicates whether Data Execution Prevention (DEP) is
enabled for 32-bit applications.
DataExecutionPrevention_Available
Indicates whether DEP is supported by the system
hardware.
DataExecutionPrevention_Drivers
Indicates whether DEP is enabled for device drivers.
DataExecutionPrevention_SupportPolicy
Specifies the DEP support policy being used. Values are 0
= none, 2 = on for essential Windows programs and
services only, 3 = on for all programs except those
specifically excluded.
Debug
Indicates whether the operating system is a checked
(debug) build. If TRUE, the debugging version of User.exe
is installed.

Description
Description of the Windows operating system.
Distributed
Indicates whether the operating system is distributed across
multiple computer system nodes. If so, these nodes should
be grouped as a cluster.
EncryptionLevel
Level of encryption for secure transactions, as 40-bit, 128-
bit, or n-bit.
ForegroundApplicationBoost
Sets the priority of the foreground application. Application
boost is implemented by giving an application more
processor time. Values are: 0 = none, 1 = minimum, 2 =
maximum (default).
FreePhysicalMemory
Physical memory (in kilobytes) currently unused and
available.
FreeSpaceInPagingFiles
Amount of free space (in kilobytes) in the operating
system’s paging files. Swapping occurs when the free
space fills up.
FreeVirtualMemory
Virtual memory (in kilobytes) unused and available.
InstallDate
Date when the operating system was installed.
LargeSystemCache
Indicates whether memory usage is optimized for programs
or the system cache. Values are: 0 = memory usage is
optimized for programs, 1 = memory usage is optimized
for the system cache.
LastBootUpTime
When the operating system was last booted.
LocalDateTime
Local date and time on the computer.
Locale
Language identifier used by the operating system.
Manufacturer
Operating system manufacturer. For Win32 systems, this
value will be “Microsoft Corporation”.
MaxNumberOfProcesses
Maximum number of process contexts the operating
system can support. If there is no fixed maximum, the
value is 0.
MaxProcessMemorySize
Maximum memory (in kilobytes) that can be allocated to a
process. A value of zero indicates that there is no
maximum.
MUILanguages
User interface languages supported.
Name
Name of the operating system instance.
NumberOfLicensedUsers
Number of user licenses for the operating system. A value
of 0 = unlimited, a value of –1 = unknown.

NumberOfProcesses
Current number of process contexts on the system.
NumberOfUsers
Current number of user sessions.
OperatingSystemSKU
Operating system product type indicator.
Options
Lists the management object options.
Organization
Company name set for the registered user of the operating
system.
OSArchitecture
Operating system architecture, as 32-bit or 64-bit.
OSLanguage
Language version of the operating system installed.
OSProductSuite
Operating system product suite installed.
OSType
Type of operating system. Values include: 1 = other, 18 =
Windows NT or later.
OtherTypeDescription
Sets additional description; used when OSType = 1.
Path
Identifies the full WMI path to the object class.
PAEEnabled
Indicates whether physical address expansion (PAE) is
enabled.
PlusProductID
Product number for Windows Plus! (if installed).
PlusVersionNumber
Version number of Windows Plus! (if installed).
Primary
Indicates whether this is the primary operating system.
ProductType
Operating system product type. Values are: 1 =
workstation, 2 = domain controller, 3 = server.
Properties
Lists all the properties of the object.
Qualifiers
Lists any qualifiers for the object.
QuantumLength
Number of clock ticks per unit of processor execution.
Values are: 1 = unknown, 2 = one tick, 3 = two ticks.
QuantumType
Length type for units of processor execution. Values are: 1
= unknown, 2 = fixed, 3 = variable. With variable length,
foreground and background applications can have different
values. With fixed length, the foreground and background
values are the same.
RegisteredUser
Name set for the registered user of the operating system.
Scope
Lists the management object scope.

SerialNumber
Operating system product serial number.
ServicePackMajorVersion
Major version number of the service pack installed on the
computer. If no service pack has been installed, the value is
0 or NULL.
ServicePackMinorVersion
Minor version number of the service pack installed on the
computer. If no service pack has been installed, the value is
0 or NULL.
Site
Site associated with the object.
SizeStoredInPagingFiles
Total number of kilobytes that can be stored in the
operating system’s paging files. A value of 0 indicates that
there are no paging files.
Status
Current status of the object. Values include: “OK”, “Error”,
“Unknown”, “Degraded”, “Pred Fail”, “Starting”,
“Stopping”, and “Service”.
SuiteMask
Bit flags that identify the product suites available on the
system.
SystemDevice
Physical disk partition on which the operating system is
installed.
SystemDirectory
System directory of the operating system.
SystemDrive
Physical disk partition on which the operating system is
installed.
SystemProperties
Lists the system properties.
TotalSwapSpaceSize
Total swap space in kilobytes. This value may be
unspecified (NULL) if swap space is not distinguished
from page files.
TotalVirtualMemorySize
Virtual memory size (in kilobytes).
TotalVisibleMemorySize
Total amount of physical memory (in kilobytes) that is
available to the operating system.
Version
Version number of the operating system.
WindowsDirectory
Windows directory of the operating system.
The detailed operating system information tells you a great deal about the operating
system running on the computer. The same is true for computer configuration details,
which can be obtained by entering the following command at a Windows PowerShell
prompt:
Get-WmiObject -Class Win32_ComputerSystem -Namespace root/cimv2
-ComputerName . | Format-List *

Listing 5-2 provides an example of the output from this command, and Table 5-3 provides
a summary of the computer configuration properties and their meaning. As discussed
previously, you can redirect the output to a save file.
LISTING 5-2 Computer Configuration Information
AdminPasswordStatus         : 1
BootupState                 : Normal boot
ChassisBootupState          : 3
KeyboardPasswordStatus      : 2
PowerOnPasswordStatus       : 1
PowerSupplyState            : 3
PowerState                  : 0
FrontPanelResetStatus       : 2
ThermalState                : 3
Status                      : OK
Name                        : CORPSERVER84
PowerManagementCapabilities : 
PowerManagementSupported    : 
__GENUS                     : 2
__CLASS                     : Win32_ComputerSystem
__SUPERCLASS                : CIM_UnitaryComputerSystem
__DYNASTY                   : CIM_ManagedSystemElement
__RELPATH                   : Win32_ComputerSystem.Name=“CORPSERVER84”
__PROPERTY_COUNT            : 58
__DERIVATION                : {CIM_UnitaryComputerSystem, CIM_ComputerSystem,
CIM_System,CIM_LogicalElement…}
__SERVER                    : CORPSERVER84
__NAMESPACE                 : root\cimv2
__PATH    :\CORPSERVER84\root\cimv2:
          Win32_ComputerSystem.Name=“CORPSERVER84”
AutomaticManagedPagefile    : True
AutomaticResetBootOption    : True
AutomaticResetCapability    : True
BootOptionOnLimit           : 
BootOptionOnWatchDog        : 
BootROMSupported            : True
Caption                     : CORPSERVER84
CreationClassName           : Win32_ComputerSystem
CurrentTimeZone             : -420
DaylightInEffect            : True
Description                 : AT/AT COMPATIBLE
DNSHostName                 : CORPSERVER84
Domain                      : imaginedlands.com
DomainRole                  : 5
EnableDaylightSavingsTime   : True
InfraredSupported           : False
InitialLoadInfo             : 
InstallDate                 : 
LastLoadInfo                : 
Manufacturer                : Dell Inc. 
Model                       : 
NameFormat                  : 
NetworkServerModeEnabled    : True
NumberOfLogicalProcessors   : 2
NumberOfProcessors          : 1
OEMLogoBitmap               : 
OEMStringArray              : {www.dell.com}
PartOfDomain                : True

PauseAfterReset             : -1
PCSystemType                : 5
PrimaryOwnerContact         : 
PrimaryOwnerName            : Windows User
ResetCapability             : 1
ResetCount                  : -1
ResetLimit                  : -1
Roles                       : {LM_Workstation, LM_Server, Primary_Domain_Controller, Timesource…}
SupportContactDescription   : 
SystemStartupDelay          : 
SystemStartupOptions        : 
SystemStartupSetting        : 
SystemType                  : x64-based PC
TotalPhysicalMemory         : 3755343872
UserName                    : IMAGINEDL\williams
WakeUpType                  : 6
Workgroup                   :
Scope                       : System.Management.ManagementScope
Path                        : \Server52\root\cimv2:
              Win32_ComputerSystem.Name=“Server52”
Options                     : System.Management.ObjectGetOptions
ClassPath                   : \Server52\root\cimv2:
                              Win32_ComputerSystem
Properties                  : {AdminPasswordStatus…}
SystemProperties            : {___GENUS, ___CLASS,
                              ___SUPERCLASS…}
Qualifiers                  : {dynamic, Locale,
                             provider, UUID}
Site                        :
Container                   :
TABLE 5-3 Computer Configuration Entries and Their Meaning
AdminPasswordStatus
Status of the Administrator password. Values are: 1 = disabled, 2 = enabled, 3 = not
implemented, 4 = unknown.
AutomaticManagedPagefile
Indicates whether the computer’s page file is being managed by the operating
system.
AutomaticResetBootOption
Indicates whether the automatic reset boot option is enabled.
AutomaticResetCapability
Indicates whether the automatic reset is enabled.
BootOptionOnLimit
System action to be taken when the ResetLimit value is reached. Values are: 1 =
reserved, 2 = operating system, 3 = system utilities, 4 = do not reboot.
BootOptionOnWatchDog
Reboot action to be taken after the time on the watchdog timer has elapsed. Values
are: 1 = reserved, 2 = operating system, 3 = system utilities, 4 = do not reboot.
BootROMSupported
Indicates whether a boot ROM is supported.
BootupState
Indicates how the system was started. Values are: “Normal boot”, “Fail-safe boot”,
and “Fail-safe with network boot”.
Caption
System name.
ChassisBootupState

Bootup state of the system chassis. Values are: 1 = other, 2 = unknown, 3 = safe, 4 =
warning, 5 = critical, 6 = nonrecoverable.
ClassPath
Windows Management Instrumentation (WMI) object class path.
Container
Container associated with the object.
CreationClassName
Name of class from which object is derived.
CurrentTimeZone
Number of minutes the computer is offset from Coordinated Universal Time.
DaylightInEffect
Indicates whether daylight saving mode is on.
Description
Description of the computer.
DNSHostName
Name of the server according to DNS.
Domain
Name of the domain to which the computer belongs.
DomainRole
Domain role of the computer. Values are:0 = stand-alone workstation, 1 = member
workstation, 2 = stand-alone server, 3 = member server, 4 = backup domain
controller, 5 = primary domain controller.
EnableDaylightSavingsTime
Indicates whether daylight saving time (DST) is enabled. If True, the system
changes to an hour ahead or behind when DST starts or ends. If False, the system
does not change to an hour ahead or behind when DST starts or ends.
FrontPanelResetStatus
Hardware security settings for the reset button on the computer. Values are: 0 =
disabled, 1 = enabled, 2 = not implemented, 3 = unknown.
InfraredSupported
Indicates whether an infrared (IR) port exists on the computer system.
InitialLoadInfo
Data needed to find either the initial load device (its key) or the boot service to
request the operating system to start up.
InstallDate
Date when the computer was installed.
KeyboardPasswordStatus
Indicates the keyboard password status. Values are: 0 = disabled, 1 = enabled, 2 =
not implemented, 3 = unknown.
LastLoadInfo
Array entry of the InitialLoadInfo property, which holds the data corresponding to
booting the currently loaded operating system.
Manufacturer
Computer manufacturer’s name.
Model
Product name given by the manufacturer.
Name
Computer name.
NameFormat
Identifies how the computer system name is generated.
NetworkServerModeEnabled
Indicates whether network server mode is enabled.
NumberOfLogicalProcessors

Number of processor cores. If the computer has two processors with four cores
each, the number of logical processors is eight. If the computer has hyperthreading
architecture, the number of logical processors may also be higher than the number
of physical processors.
NumberOfProcessors
Number of enabled processors on the computer.
OEMLogoBitmap
Identifies the bitmap for the OEM’s logo.
OEMStringArray
List of descriptive strings set by the OEM.
PartOfDomain
Indicates whether the computer is part of a domain. If True, the computer is a
member of a domain. If False, the computer is a member of a workgroup.
Options
Lists the management object options.
Path
Identifies the full WMI path to the object class.
PauseAfterReset
Time delay (in milliseconds) before a reboot is initiated after a system power cycle
or reset. A value of -1 indicates there is no time delay.
PCSystemType
Indicates the type of computer. Values are: 0 = unspecified, 1 = desktop, 2 = mobile,
3 = workstation, 4 = enterprise server, 5 = small office and home office (SOHO)
server, 6 = appliance PC, 7 = performance server, 8 = role maximum.
PowerManagementCapabilities
Power management capabilities of a logical device. Values are: 0 = unknown, 1 =
not supported, 2 = disabled, 3 = enabled, 4 = power saving modes entered
automatically, 5 = power state settable, 6 = power cycling supported, 7 = timed
power on supported.
PowerManagementSupported
Indicates whether the device’s power can be managed.
PowerOnPasswordStatus
Power on password status. Values are:0 = disabled, 1 = enabled, 2 = not
implemented, 3 = unknown.
PowerState
Indicates the current power state of the computer. Values are: 0 = unknown, 1 = full
power, 2 = power save – low power mode, 3 = power save – standby, 4 = power
save – unknown, 5 = power cycle, 6 = power off, 7 = power save – warning.
PowerSupplyState
State of the enclosure’s power supply when last booted. Values are: 1 = other, 2 =
unknown, 3 = safe, 4 = warning, 5 = critical, 6 = nonrecoverable.
PrimaryOwnerContact
Contact information for the computer’s owner.
PrimaryOwnerName
Name of the system owner.
Properties
Lists all the properties of the object.
Qualifiers
Lists any qualifiers for the object.
ResetCapability
Value indicates whether a computer can be reset using the Power and Reset buttons
(or other hardware means). Values are: 1 = other, 2 = unknown, 3 = disabled, 4 =
enabled, 5 = nonrecoverable.
ResetCount

Number of automatic resets since the last intentional reset. A value of -1 indicates
that the count is unknown.
ResetLimit
Number of consecutive times a system reset will be attempted. A value of -1
indicates that the limit is unknown.
Roles
System roles.
Scope
Lists the management object scope.
Site
The site associated with the object.
Status
Current status of the computer. Values are: “OK”, “Error”, “Degraded”,
“Unknown”, “Pred Fail”, “Starting”, “Stopping”, “Service”.
SupportContactDescription
List of the support contact information for the computer.
SystemProperties
Lists the system properties.
SystemStartupDelay
Startup delay in seconds.
SystemStartupOptions
List of the startup options for the computer.
SystemStartupSetting
Index of the default start profile.
SystemType
System architecture type, such as “X86-based PC” or “64-bit Intel PC”.
ThermalState
Thermal state of the system chassis when last booted. Values are: 1 = other, 2 =
unknown, 3 = safe, 4 = warning, 5 = critical, 6 = nonrecoverable.
TotalPhysicalMemory
Total byte size of physical memory.
UserName
Name of the user currently logged on.
WakeUpType
Event that caused the system to power up. Values are: 0 = reserved, 1 = other, 2 =
unknown, 3 = APM timer, 4 = modem ring, 5 = LAN remote, 6 = power switch, 7 =
PCI PME#, 8 = AC power restored.
Workgroup
When a computer is a member of a workgroup, the workgroup name is listed here.
In addition to targeting operating system or computer configuration properties, you might
want to target computers based on the amount of disk space and file system type. In the
following example, you target computers that have more than 1 gigabyte (GB) of available
space on the C, D, or G partition:
Select * from Win32_LogicalDisk where (Name = ” C:”  OR Name = ” D:” 
OR Name = ” G:” ) AND DriveType = 3 AND FreeSpace > 1048576000 AND
FileSystem = ” NTFS”
In the preceding example, DriveType = 3 represents a local disk and FreeSpace units are
in bytes (1 GB = 1,048,576,000 bytes). The partitions must be located on one or more
local fixed disks, and they must be running the NTFS file system.
In Windows PowerShell, you can examine all the properties of the Win32_LogicalDisk

object by entering the following command at the Windows PowerShell prompt:
Get-WmiObject -Class Win32_LogicalDisk -Namespace root/cimv2
-ComputerName . | Format-List *
As you’ll see, there are many properties you can work with, including Compressed, which
indicates whether a disk is compressed. Other important WMI object classes include:
Win32_BIOS Displays information about the BIOS configuration on the computer
Win32_NetworkAdapterConfiguration Displays information about the network
adapter configuration on the computer
Win32_PageFile Displays information about the page file configuration on the
computer
Win32_PhysicalMemory Displays information about the physical memory
configuration on the computer
Win32_Process Displays information about all the processes running on the
computer
Win32_Processor Displays information about the computer’s CPU
Win32_Service Displays information about all the services configured on the
computer
Using the techniques I’ve discussed previously, you can examine the properties of any or
all of these objects by using Windows PowerShell. If you do, you will find that
Win32_PhysicalMemory has a Capacity property that tracks the total physical memory in
bytes. Knowing this, you could easily create a WMI filter to target computers with 4 GB
of RAM or more. The WMI query to handle the task is the following:
Select * from Win32_PhysicalMemory where Capacity > 4194300000
I used the value 4194300000 because there are 4,194,304,000 bytes in 4 GB, and we want
the computer to have at least this capacity.
To display a complete list of WMI objects, enter the following command at the Windows
PowerShell prompt:
Get-WmiObject –list -Namespace root/cimv2 -ComputerName .
| Format-List name
Because the list of available objects is so long, you’ll definitely want to redirect the output
to a file. In the following example, you redirect the output to a file in the working
directory called FullWMIObjectList.txt:
Get-WmiObject –list -Namespace root/cimv2 -ComputerName .
| Format-List name > FullWMIObjectList.txt
Rather than viewing all WMI classes, you may want to see only the Win32 WMI classes.
To view only the Win32 WMI classes, use the following command:
Get-WmiObject -list | where {$_.name -like “*Win32_*”}

Managing WMI Filters
Creating and applying WMI filters is a two-step process. First you define the WMI filter
and set the desired query. Then you link the WMI filter to GPOs as appropriate. If you
later decide that you don’t want to link a WMI filter to a GPO, you can unlink the filter to
remove it. After you remove the link to the WMI filter, the GPO will no longer filter
policy application based on the queries defined in the filter.
Creating a WMI Filter
Because WMI filters let you easily target specific types of computers, they are often
overused. However, this approach is not necessarily a good one. WMI filters work well
when you have a few management exceptions. They don’t work well when you deploy
them widely. If you create multiple WMI filters, each targeted to separate GPOs, you may
negatively impact performance. Why? Too many WMI filters can slow down Group
Policy processing because each filter must be evaluated whenever policy is applied. To
avoid problems, test your WMI filters carefully and deploy them strategically.
To create a WMI filter, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the WMI Filters node to display a list of currently configured
filters in the details pane, as shown in Figure 5-7. If an existing WMI filter is linked
to one or more GPOs, the names of the GPOs are listed under the Linked GPO
column.
FIGURE 5-7 List currently configured WMI filters.
3.                  Right-click the WMI Filters node in the domain in which you want to add
a WMI filter, and then click New.
4.                  In the New WMI Filter dialog box, shown in Figure 5-8, type a name for

the new WMI filter in the Name box, and then type a description of the filter in the
Description box.
5.                  Click Add. In the WMI Query dialog box, the default namespace is
root\CimV2. In most cases, you do not need to change the namespace. If you need
to change this value, click Browse, select the namespace you need to use from the
list, and then click OK.
6.                  In the WMI Query dialog box, define a WMI query in the Query box, and
then click OK.
7.                  To add additional queries to the filter, repeat steps 4 through 6.
8.                  After you add all the necessary WMI queries, click Save. The WMI filter
will then be available to be linked.
FIGURE 5-8 Create the WMI query.
Viewing and Editing WMI Filters
When you select the WMI Filters node in the GPMC, you see a list of the currently
configured WMI filters in the details pane. If a WMI filter is linked to one or more GPOs,
the names of the GPOs are listed in the Linked GPO column.
To view and manage individual filters, expand the WMI Filters node in the console tree
and then select the WMI filter you want to work with. In the details pane, you’ll then see
the configuration details for the selected WMI filter. As shown in Figure 5-9, the General
tab displays:
The description you entered for the WMI filter
The queries you defined for the WMI filter
The GPOs that are linked to the WMI filter
If you want to edit the filter definition, click Edit Filter. You are then able to see the filter
name and description. You are also able to add, remove, or edit WMI queries. When you
are finished, click Save to save the changes. Any query changes are reflected the next time

clients process group policy.
FIGURE 5-9 Review the WMI filter details.
Applying or Removing a WMI Filter
To apply a WMI filter, you must link it to a GPO. Each GPO can have only one linked
WMI filter at a time. If you no longer want a GPO to process a WMI filter, you can
remove the link.
To add or remove a link to a WMI filter, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with and
then expand the related Domains node.
2.                  Expand the node for the domain you want to work with. If you don’t see
the domain you want to work with, right-click Domains and then click Show
Domains. You can then select the domains you want to display.
3.                  Expand the Group Policy Objects node and then select the GPO you want
to work with.
4.                  In the details pane, click the Scope tab. On the Scope tab, the WMI
Filtering pane shows whether the GPO is linked to a WMI filter (see Figure 5-10).

FIGURE 5-10 Link a WMI filter to a GPO.
5.                  Do one of the following:
If you want to add a link to a WMI filter, select the WMI filter from the drop-down
list provided. When prompted to confirm that you want to change to the selected
filter, click Yes.
If you want to remove a link to a WMI filter, select <None> from the drop-down
list provided. When prompted to confirm that you want to remove the previously
selected filter, click Yes.


Chapter 6. Maintaining the SYSVOL
The SYSVOL is a collection of folders that contain copies of a domain’s public files,
including system policies, logon scripts, and important elements of Group Policy objects
(GPOs). The SYSVOL directory must be available and the appropriate subdirectories must
be shared on a server before the server can advertise itself on the network as a domain
controller. Shared subdirectories within the SYSVOL are replicated to every domain
controller in the domain.
In Group Policy, only the Group Policy template (GPT) is replicated through SYSVOL
replication. Active Directory replication handles replication of the Group Policy container
(GPC), which is stored in the domain’s directory database. For Group Policy to be
effective, both the GPT and the GPC must be available on a domain controller.
Domain controllers can use Distributed File System (DFS) Replication for replication of
the SYSVOL share. For files that are larger than 64 kilobytes (KB), DFS Replication uses
an algorithm called remote differential compression (RDC) to detect changes to the data,
and this enables DFS Replication to replicate only the changes, in the form of file blocks,
without having to replicate entire files. To ensure rapid propagation of changes, the DFS
Replication service actively monitors the SYSVOL. If a change occurs to any file in the
SYSVOL, the service automatically replicates the file updates to the SYSVOL folders on
the other domain controllers in the domain.
When domain controllers are using DFS Replication, the Netlogon service shares and
advertises the SYSVOL copy maintained by the DFS Replication service. If you enter net
share at a command prompt, you’ll see two related shares, as shown in this example:
D:\Users\williams>net share
Share name   Resource      Remark
–––––––––––––––––-
C$           C:\          Default share
D$           D:\          Default share
IPC$                      Remote IPC
ADMIN$       C:\Windows   Remote Admin
NETLOGON C:\Windows\SYSVOL\sysvol\imaginedlands.local\SCRIPTS
Logon server share
SYSVOL C:\Windows\SYSVOL\sysvol   Logon server share
The command completed successfully.
Here, the path to the NETLOGON share is
C:\Windows\SYSVOL\sysvol\imaginedlands.com\SCRIPTS, and the path to the SYSVOL
share is C:\Windows\SYSVOL\sysvol. This is the default configuration for the SYSVOL
when DFS Replication is being used.


Maintaining the SYSVOL
Because Active Directory replicates the SYSVOL for you, you really don’t need to
manage the SYSVOL on a daily basis. That said, you may occasionally need to perform
maintenance tasks as your network changes. This section discusses the key maintenance
tasks you might need to perform.

Managing SYSVOL Storage
The location of the SYSVOL folder and subfolders is configurable. The default location
for the SYSVOL root is %SystemRoot%\Sysvol.
Within the SYSVOL, you’ll find a domain subfolder located at
%SystemRoot%\Sysvol\domain. The domain subfolder contains the policies, scripts, and
starter GPOs for the domain.
Within the SYSVOL, you’ll find a sysvol\DomainName subfolder, where DomainName is
the name of the domain in which the domain controller is located. The SYSVOL uses a
junction point to make this folder appear to be the same as the domain subfolder.
However, the sysvol\DomainName subfolder is in fact a junction point that points to the
domain-specific subfolder of the domain folder.
Within the SYSVOL, you’ll find staging and staging areas folders, which are used to
manage changes to SYSVOL content. The DFS-R service uses these folders to queue
changes that are to be replicated to other domain controllers. These staging areas have a
default storage quota of 4 gigabytes (GB). As your installation of Active Directory
Domain Services (AD DS) grows in size and complexity, the amount of disk space needed
for the SYSVOL typically will grow. Because of this, you may need to modify the storage
quota. You’ll also need to ensure that the volume on which the SYSVOL is created has
adequate space to store the related files. You can reduce the amount of data stored on the
SYSVOL by creating a central store, as discussed in “Managing Changes with Template
Files” in Chapter 2.
System maintenance tasks that modify disk configuration can affect the SYSVOL.
Therefore, when you maintain disk configurations, even if the maintenance occurs on a
different disk drive, you should verify that the maintenance does not affect the SYSVOL.
Why? Logical drive letters can change after you add and remove disks. DFS Replication
locates the SYSVOL by using paths that are stored in AD DS. If drive letters change after
you add or remove disk drives, you need to manually update the paths in the registry and
AD DS or restore the original configuration.
You should relocate the SYSVOL only when required by disk-space maintenance or
upgrades. To relocate the SYSVOL, you must:
1.                  Stop the DFS-R and Netlogon services.
2.                  Copy the entire folder structure (including any hidden folders) to the new
location.
3.                  Update the related junction points.
4.                  Update the path values that are stored in the registry and in AD DS.
5.                  Start the DFS-R and Netlogon services.
6.                  Force replication with replication partners.
Note  Because there are many things that can go wrong with a manual SYSVOL
move, Microsoft recommends that you uninstall AD DS and then re-install AD DS
with the new SYSVOL path instead of performing a manual move.
Performing these procedures maintains the relationships between the paths, the folders,

and the junction points and ensures proper domain controller operations. As an alternative
to relocating the SYSVOL, you can relocate the staging area while leaving the rest of the
SYSVOL in its original location. For more information, see “Relocating the Staging Area”
later in this chapter.

Managing Storage Quotas for DFS Replication
The staging area has a default storage quota of 4 GB. If staging-area disk space is low,
DFS Replication will have problems cleaning up the staging area. This will result in
related low disk space and error events being generated in the event logs. You can avoid
this problem in most cases by using a central store. You can also modify the storage
quotas used by DFS Replication if necessary.
Each domain controller has separate settings for DFS Replication and storage quotas. To
change the storage configuration used by DFS Replication, you must modify the
configuration separately on each domain controller in the domain by completing the
following steps:
1.                  Open DFS Management by clicking the Tools menu in Server Manager,
and then clicking DFS Management.
2.                  In the console tree, expand the Replication node and then select Domain
System Volume. As shown in Figure 6-1, you’ll see detailed information for the
Domain System Volume, including:
Local Path Shows the full file path to the replicated folder.
Membership Status Shows the replication group membership status as either
enabled or disabled.
Member Shows the member server on which replication is configured.
Replicated Folder Shows the name of the replicated folder.
Staging Quota Shows the storage quota for the staging folder.
FIGURE 6-1 Use DFS Management to check DFS Replication.
3.                  In the details pane, right-click the DFS Replication member entry you
want to manage and then click Properties.
4.                  On the Staging tab, shown in Figure 6-2, use the Quota combo box to set
the quota you want for the Staging folder, and then click Apply. The default quota
is 4,096 MB. The minimum quota you can set is 10 MB, and the maximum quota
that you can set is 4,294,967,295 MB (or 4 terabytes).

FIGURE 6-2 Set the desired quota for the staging folder.
5.                  On the Advanced tab, shown in Figure 6-3, use the Quota combo box to
set the quota for subfolders within the ConflictAndDeleted folder, and then click
Apply. The default quota is 4,096 MB. The minimum quota you can set is 10 MB
and the maximum quota that you can set is 4,294,967,295 MB (or 4 terabytes).

FIGURE 6-3 Set the desired quota for the ConflictAndDeleted folder.
6.                  Click OK to close the Properties dialog box.
Real World  By default, the ConflictAndDeleted folder has a maximum allowed size of
4,096 megabytes (MB). This size limit is enforced by a disk quota and can be changed as
discussed in this section. Typically, the size of the ConflictAndDeleted folder will rarely
approach this limit. However, if the ConflictAndDeletedManifest.xml file becomes
corrupted, it can in some situations cause the ConflictAndDeleted folder to exceed its
quota and might also prevent the DFS Replication service from replicating files.
To resolve this problem, you can initiate a cleanup of the ConflictAndDeleted folder and
the ConflictAndDeletedManifest.xml file. To do this, you need the globally unique
identifier (GUID) of the SYSVOL share, which you can obtain by entering the following
command at a command prompt:
wmic /namespace:\root\microsoftdfs path dfsrreplicatedfolderconfig get
replicatedfolderguid,replicatedfoldername
To initiate cleanup, enter the following command at a command prompt:
wmic /namespace:\root\microsoftdfs path dfsrreplicatedfolderinfo where
“replicatedfolderguid=’<GUID>’” call cleanupconflictdirectory
where GUID  is the GUID of the replicated folder that has a corrupted
ConflictAndDeletedManifest.xml file.
If no conflicts or deletions are occurring when you run the command, the
ConflictAndDeleted folder will be empty and the ConflictAndDeletedManifest.xml file
will not exist (because it was deleted by the DFS Replication service). If conflicts or
deletions are occurring when you run the command, some files will remain in the
ConflictAndDeleted folder, including the ConflictAndDeletedManifest.xml file.
However, the size will be much smaller and the total size of the ConflictAndDeleted
folder should be below the quota limit.

Relocating the Staging Area
Within the SYSVOL, the staging area acts as a queue for changes that need to be
replicated to other domain controllers and for new files that need to be replicated. The
location of the staging area can be configured by using DFS Management. However,
before you do this, be sure to notify domain administrators that they should not make any
changes in the SYSVOL directory until the move is complete.
Each domain controller has separate settings for DFS Replication and the staging area. To
relocate the staging area, you must modify the configuration on each domain controller
separately by completing the following steps:
1.                  Stop the DFS-R and Netlogon services.
2.                  Create the staging area folder structure.
3.                  Change the staging area path.
4.                  Start the DFS-R and Netlogon services.
5.                  Force replication with replication partners.

Identifying Replication Partners
When you are trying to determine whether replication is working properly, it is often
helpful to locate a domain controller’s replication partners. One way to do this is to
examine the connection objects for a domain controller by using Active Directory Sites
And Services. To do this, however, you must know the site in which the domain controller
is located. If you don’t know the site in which the domain controller is located, you can
use the DSQUERY SERVER command to determine this information. At a command
prompt enter dsquery server –name ServerName, where ServerName is the name of the
domain controller—for example, dsquery –server –name CorpServer65. The output of the
command lists the site in which the domain controller is located.
To identify replication partners by examining connection objects, complete the following
steps:
1.                  Open Active Directory Sites And Services by clicking the Tools menu in
Server Manager, and then clicking Active Directory Sites And Services.
2.                  In the console tree, double-click the Sites container to display the list of
sites.
3.                  Double-click the site that contains the domain controller whose connection
objects you want to determine.
4.                  Double-click the Servers folder to display the list of servers in the selected
site.
5.                  Double-click the server object for the domain controller whose replication
partners you want to identify. This displays the server’s NTDS Settings object.
6.                  Click the NTDS Settings object to display the list of connection objects in
the details pane. These objects represent inbound connections that are used for
replication to the server. The From Server column displays the names of the domain
controllers that are source replication partners for the selected domain controller.

Rebuilding the SYSVOL
A domain controller cannot function without a properly shared and replicating SYSVOL.
If you suspect that the SYSVOL is not configured properly, you can rebuild the SYSVOL
on the domain controller. However, you should do this only when all other domain
controllers in the domain have a healthy and functioning SYSVOL. Additionally, do not
attempt to rebuild the SYSVOL until you resolve any problems that may be occurring with
DFS Replication in a domain.
One way to rebuild the SYSVOL is to perform a nonauthoritative restore of the domain
controller from a backup on which the SYSVOL was working properly. For details, see
“Backing Up and Recovering Active Directory” in Chapter 9, “Maintaining and
Recovering Active Directory,” in Active Directory Administrator’s Pocket Consultant.
You also can rebuild the SYSVOL on a domain controller by performing the following
procedures:
1.                  Identify the target domain controller. This is the domain controller for
which you are repairing the SYSVOL.
Caution  This procedure won’t work in all deployments of Active Directory and
probably will need to be modified to work in your environment. Before you try this
procedure in a live production environment, you should thoroughly test this
procedure on a development or test network. Further, if the SYSVOL configurations
of the source and target aren’t the same, you need to update the locations where
folder paths are specified in junction points in the file system, in Netlogon
parameters in the registry, and in attributes in Active Directory Domain Services
(AD DS). The latter two tasks are beyond the scope of this book.
2.                  Identify a source replication partner as discussed in “Identifying
Replication Partners” earlier in the chapter. You will import the SYSVOL from the
source replication partner.
3.                  Compare the SYSVOL configuration on the target and source domain
controllers. Ensure that both use the same locations for directory paths and junction
points. For example, if both use the default paths on the C drive for SYSVOL
storage, the configurations are identical and you can proceed. Otherwise, you
should not use this technique to rebuild the SYSVOL.
4.                  Create a copy of the current SYSVOL directory structure for both the
target and source by entering the following commands at an elevated command
prompt on both servers:
cd %systemroot%
dir /s /ad sysvol_dfsr > save.txt
5.                  If you open Save.txt in Notepad and search twice for Junction, you’ll find
the exact paths to both junction points the SYSVOL is using. The path for the
System Volume Information\DFSR\Private folder includes two GUIDs separated by
a hyphen.
6.                  On the source replication partner and the target domain controller, use the
Services utility or the SC command to ensure that the DFS Replication Service and

the Netlogon service have been started and are running. Then, verify that the related
shares are being shared by entering net share at a command prompt.
7.                  Verify that replication is working between the source replication partner
and the target domain controller by entering dcdiag /test:replications at a
command prompt.
8.                  Restart the target domain controller in Directory Services Restore Mode.
Restarting in Directory Services Restore Mode takes the target domain controller
offline, meaning it functions as a member server and not as a domain controller.
During installation of Active Directory Domain Services, you set the Administrator
password for logging on to the server in Directory Services Restore Mode.
9.                  You can restart a domain controller in Directory Services Restore Mode
manually by pressing the F8 key during domain controller startup. You must then
log on by using the Directory Services Restore Mode password for the local
Administrator account.
10.             In Directory Services Restore Mode, the DFS Replication service is
stopped automatically. You also need to stop the Netlogon service. Use the Services
utility or the SC command to do this. Note that both services restart automatically
when you restart the domain controller normally after you complete the procedure
to import the SYSVOL folder structure.
11.             On the target domain controller, delete the contents of the
%SystemRoot%\Sysvol folder but retain the folder itself.
12.             Using Robocopy, copy the entire SYSVOL folder structure from the source
replication partner to the target domain controller. You use Robocopy to ensure that
file ownership and access control list settings are retained on the SYSVOL folders
and files. At an elevated command prompt, enter the following command:
robocopy SourceShare DestinationShare /copyall /mir /b
/r:0 /xd “DfsrPrivate” /xf “DfsrPrivate”
where SourceShare is the full UNC path to the SYSVOL share you are copying on
the source replication server, and DestinationShare is the full UNC path to the
SYSVOL share on the target domain controller. The additional parameters have the
following usage:
/copyall copies the following file information: data, attributes, time stamps, NTFS
access control list (ACL), owner information, and auditing information.
/mir mirrors the directory tree that you are copying.
/b copies files in backup mode to override file and folder permission settings
(ACLs).
/r:0 specifies performing 0 (zero) retries on failed copies.
/xd “DfsrPrivate” excludes the DfsrPrivate directory from the copy.
/xf “DfsrPrivate” excludes the DfsrPrivate file from the copy.
13.             Verify that the security settings on the copied SYSVOL are the same as on
the original SYSVOL. You can use File Explorer to examine file and folder security
settings. If there’s a problem with the security settings, repeat steps 9 and 10.
14.             Verify that the folder structure was copied correctly and that the required

junction points still exist. One way to do this is to enter the following commands at
an elevated command prompt:
cd %systemroot%
dir /s /ad sysvol_dfsr > current.txt
When you open the Current.txt file in Notepad, you can examine the directory
structure.
15.             Restore the default junction points as necessary, and verify that the default
junction points are configured correctly. The default junction points are
C:\Windows\SYSVOL_DFSR\domain\DfsrPrivate and
C:\Windows\SYSVOL\sysvol\DomainName, where DomainName is the fully
qualified name of the domain, such as
C:\Windows\SYSVOL\sysvol\imaginedlands.com.
16.             Restart the target domain controller normally. Restarting the server
normally will ensure that the target domain controller starts in normal operating
mode. In this mode, the DFS Replication service and the Netlogon service should
start automatically.
17.             Check the Directory Service event log to ensure that it contains no errors
related to replication, the SYSVOL, or Netlogon. Test replication on the target
domain controller to ensure that replication is working as expected. If you are
unable to successfully complete this procedure, you need to perform a
nonauthoritative restore of the domain controller from backup.
Real World  To restore the junction points, you must know the volume GUIDs. I
recommend copying and pasting the GUIDs from the Save.txt file you created
earlier on the target domain controller. When the target domain controller is using a
default configuration of the SYSVOL, enter the following commands at an elevated
command prompt to create and then verify the first junction point using the GUIDs:
cd %SystemRoot%\Sysvol\domain
mklink /J DfsrPrivate “C:\System Volume Information\DFSR\Private\GUID”
dir /a:L
To create and verify the second junction point, enter the following commands at an
elevated command prompt:
cd %SystemRoot%\SYSVOL\sysvol
mklink /J DomainName C:\Windows\Sysvol\DomainName
dir /a:L
Here, DomainName  is the fully qualified name of the domain, such as
imaginedlands.com.


Generating Replication Diagnostics Reports
You can use the DFS Management console to monitor DFS Replication. Using the
Diagnostic Reports features of DFS Management, you also can implement monitoring to
detect low disk space and other potential issues that might cause DFS Replication to fail.
Using the DFS Management console, you can:
Generate a health report. A health report shows the overall health of replication and
replication efficiency.
Perform a propagation test. A propagation test checks replication progress by creating
a test file in a replicated folder.
Generate a propagation report. A propagation report tracks the replication progress
for the test file created during a propagation test.
Note  The amount of time required to test replication and generate reports will
vary based on DFS Replication health, the number of replicated folders, available
server resources, network connectivity, and other factors.

Generating Replication Health Reports
You can create health reports to determine the health of the replication architecture and to
determine replication efficiency. To generate a health report, complete the following steps:
1.                  Click  theTools menu in Server Manager, and then click DFS
Management.
2.                  In the console tree, under the Replication node, right-click Domain System
Volume, and then click Create Diagnostic Report.
3.                  When the Diagnostic Report Wizard starts, choose Health Report, as
shown in Figure 6-4, and then click Next.
FIGURE 6-4 Generate a health report for DFS Replication.
4.                  On the Path And Name page, shown in Figure 6-5, configure the save path
for the report by using the Report Path options. Then enter a name for the report in
the Report Name box as appropriate. Click Next.

FIGURE 6-5 Specify the save path and report name.
5.                  On the Members To Include page, use the options provided to select
servers to include in the report. Generally, you’ll want to limit the number of
servers you include to allow the test to be completed faster.
6.                  To include an excluded server, click it in the Excluded Members list and
then click Add. To exclude an included member, click in the Included Members list
and then click Remove. Click Next.
7.                  On the Options page, shown in Figure 6-6, specify whether to count
backlogged files in the report. Counting backlogged files is important because the
more files that domain controllers have in their back log, the further behind they are
with their replication.
8.                  If you include backlogged files, use the Reference Member list to select a
reference member that has the most up-to-date files. Files on the reference member
will be compared to files on other members to determine whether other servers
have a backlog of files.
9.                  If you want to count replicated files and their sizes on each member, select
the Count The Replicated Files And Their Sizes check box. Click Next.

FIGURE 6-6 Optimize the report settings.
10.             Review the options you’ve selected, and then click Create to generate the
health report. The more options and included servers selected, the longer it will take
to generate the report.
11.             When the wizard finishes generating the report, it opens the report in
Windows Internet Explorer. Review the results and note the save location of the
health report for future reference.

Performing Propagation Tests
A propagation test checks replication progress by creating a test file in a replicated folder
and then using a related reporting mechanism to check how long the test file took to
propagate. To get a good understanding of how replication is working, you’ll need to run
several propagation tests. Ideally, you’ll run the tests at different times of day and under
different conditions.
To perform a propagation test, complete the following steps:
1.                  Click the Tools menu in Server Manager, and then click DFS
Management.
2.                  In the console tree, under the Replication node, right-click Domain System
Volume, and then click Create Diagnostic Report.
3.                  When the Diagnostic Report Wizard starts, choose Propagation Test and
then click Next.
4.                  On the Start A New Propagation Test page, shown in Figure 6-7, select
SYSVOL Share from the Replicated Folder list. From the Propagation Server list,
select the server to test.
FIGURE 6-7 Create a test for the SYSVOL share.
5.                  By default, any existing test files that are older than 90 days will be
deleted. This is typically what you want to happen. Click Next.
6.                  Review the options you’ve selected and then click Create to perform the
propagation test. Click Close.
7.                  When the wizard finishes, it does not automatically generate a related
report. You must create this report separately as discussed in the next section.
However, keep in mind that to get useful reports, you should run several
propagation tests under different conditions and at different times.

Generating Propagation Reports
A propagation report tracks the replication progress for test files created during
propagation tests. The report is designed to help you identify replication problems, such as
whether the domain is experiencing high replication latency between domain controllers.
To generate a propagation report, complete the following steps:
1.                  Click the Tools menu in Server Manager, and then click DFS
Management.
2.                  In the console tree, under the Replication node, right-click Domain System
Volume, and then click Create Diagnostic Report.
3.                  When the Diagnostic Report Wizard starts, choose Propagation Report and
then click Next.
4.                  On the Report Options page, shown in Figure 6-8, select SYSVOL Share
from the Replicated Folder list. From the Propagation Server list, select a server
you previously tested.
5.                  Use the combo box provided to set the number of test files to include. By
default, the wizard will include a maximum of five test files in the report. Click
Next.
FIGURE 6-8 Select the replicated folder and server you previously tested.
6.                  On the Path And Name page, configure the save path for the report by
using the Report Path options. Then enter a name for the report in the Report Name
box, as appropriate. Click Next.
7.                  Review the options you’ve selected, and then click Create to generate the
propagation report.
8.                  When the wizard finishes generating the report, it opens the report in
Internet Explorer. Review the results and note the save location of the propagation

report for future reference.


Troubleshooting Replication Issues
During normal Active Directory operations, changes made to the directory, policy, and
SYSVOL on one domain controller are replicated to that domain controller’s replication
partners. To determine whether replication is working properly, you can use the Domain
Controller Diagnostics Tool (Dcdiag.exe) to perform a series of replication tests. To do
this, follow these steps:
1.                  Start an elevated, administrator command prompt by right-clicking the
Windows logo, and then clicking Command Prompt (Admin).
2.                  At the command prompt, enter the following command: dcdiag
/s:ServerName /test:replications, where ServerName specifies the name of the
domain controller that you want to examine.
3.                  The output of the diagnostics testing provides a wealth of information that
can help you diagnose and resolve replication issues. If any test fails, open Event
Viewer and check for replication errors in the Directory Service log.
Using an elevated, administrator command prompt, you can verify successful replication
by entering repadmin /showrepl. If you are not running Repadmin on the domain
controller whose replication you are checking, you can specify a destination domain
controller in the command. For example, if you want to check CorpServer98, enter the
following command:
repadmin /showrepl CorpServer98
As shown in Sample 6-1, Repadmin lists inbound neighbors for the current or specified
domain controller. These inbound neighbors identify the distinguished name of each
directory partition for which inbound directory replication has been attempted, the site and
name of the source domain controller, and whether replication succeeded.
SAMPLE 6-1. Confirming replication with neighbors.
LA-First-Site\CORPSERVER98
DSA Options: IS_GC DISABLE_OUTBOUND_REPL IS_RODC
Site Options: (none)
DSA object GUID: a465bbc1-c3d9-46ec-96fc
DSA invocationID: c045996c-b163-45b7-80d3
==== INBOUND NEIGHBORS ======================================
DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
 Last attempt @ 2014-12-11 12:14:18 was successful.
CN=Configuration,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
Last attempt @ 2014-12-11 12:14:18 was successful.
CN=Schema,CN=Configuration,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e

 Last attempt @ 2014-12-11 12:14:18 was successful.
DC=DomainDnsZones,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e 
 Last attempt @ 2014-12-11 12:14:18 was successful.
DC=ForestDnsZones,DC=imaginedlands,DC=com
 Atlanta-First-Site\CORPSERVER65 via RPC
 DSA object GUID: a9d16546-c45a-4609-8c1e
 Last attempt @ 2014-12-11 12:14:18 was successful.
The example shows the replication status for five directory partitions:
DC=imaginedlands,DC=com A domain partition
CN=Configuration,DC=imaginedlands,DC=com The forestwide Configuration
partition
CN=Schema,CN=Configuration,DC=imaginedlands,DC=com The forestwide
Schema partition
DC=DomainDnsZones,DC=imaginedlands,DC=com The DNS application
partition for domain-level zones
DC=ForestDnsZones,DC=imaginedlands,DC=com The DNS application
partition for forest-level zones
If you find problems with replication, you can try to force Active Directory replication by
running the following command at an elevated command prompt on the domain
controller: repadmin /syncall. You also can force the DFS Replication service to poll
Active Directory by running the following command at an elevated command prompt:
dfsrdiag PollAd /Member:ComputerName, where ComputerName is the host name of
the domain controller—for example, dfsrdiag PollAd /Member:CorpServer84.
Manually polling Active Directory in this way can trigger replication if changes are
waiting to be replicated.
As part of troubleshooting, you should ensure that the DFS Replication service and the
Netlogon service are running and configured properly. If you suspect there is a problem
with the DFS Replication service, you can use the following command to determine the
status of the service on the local computer: sc query dfsr. To reset the DFS Replication
service, stop the service by using sc stop dfsr and then start the service by using sc start
dfsr. The stop and start commands must be entered at an elevated, administrator command
prompt.
Note  To work with a remote computer, you must specify the UNC path as part of
the command, such as sc \ComputerNamequery dfsr , where ComputerName is the
host name of the domain controller—for example, sc \CorpServer84 query dfsr .
If you suspect a problem with the Netlogon service, you can use the following command
to determine the status of the service on the local computer: sc query netlogon. To reset
the Netlogon service, stop the service by using sc stop netlogon and then start the service
by using sc start netlogon. The stop and start commands must be entered at an elevated,
administrator command prompt.
To verify that the SYSVOL shares are configured properly, enter the following command

at a command prompt: net share. The default path to the NETLOGON share is
C:\Windows\SYSVOL\sysvol\imaginedlands.local\SCRIPTS, and the path to the
SYSVOL share is C:\Windows\SYSVOL\sysvol.
Next, in File Explorer, verify that the folder locations actually exist on the system
currently identified as the system drive. If the drive letter of the system drive changed, you
need to manually update the paths in the registry and AD DS, or restore the original
configuration.
Because security settings on the SYSVOL can also affect replication, you should verify
that the proper permissions are set for SYSVOL replication. To do this, follow these steps:
1.                  Start an elevated, administrator command prompt by right-clicking the
Windows logo, and then clicking Command Prompt (Admin).
2.                  At the command prompt, enter the following command: dcdiag
/s:ServerName /test:netlogons, where ServerName specifies the name of the
domain controller to check.
3.                  In the output of the Netlogon test, look for a message that states that
“ComputerName passed test NetLogons,” where ComputerName is the name of the
domain controller. If you do not see this message, check the permissions on the
related folders.


Chapter 7. Managing Group Policy Processing
The Group Policy client running on a computer is responsible for processing policy and
requesting updates to policy. To ensure that policy changes you make are applied as
expected, you need a strong understanding of:
How inheritance works and how inheritance can be modified.
How policy is processed and refreshed, and how you can modify these processes.
How policy processing changes when users connect over slow links, and how you
can manage slow-link processing.
How you can plan policy changes so that no surprises occur when you move
computers or when users log on from different locations.
Understanding processing rules will help you master Group Policy and also help prepare
you for the unexpected. After reading this chapter, you’ll know when, why, and how
Group Policy applies to users and computers.


Managing Group Policy Inheritance
When you work with Group Policy, it is important to note the level of support for the
policies you are working with. A policy supported by all computers running Windows 8.1
or later means that computers running Windows 8.1, Windows Server 2012 R2 and later
versions of the Windows operating system support this policy.
When you create or modify GPOs, the policy preferences and settings you configure affect
users and computers. Through inheritance, a GPO applied to a parent container is inherited
by a child container. This means that a policy preference or setting applied to a parent
object is passed down to a child object. Thus, inheritance ensures that every computer and
user object in a domain, no matter which container it is stored in, is affected by Group
Policy.
Most policy settings have three configuration options: Not Configured, Enabled, or
Disabled. Not Configured is the default state for most policy settings. If a policy setting is
enabled, the policy setting is enforced and is applied to all users and computers that are
subject to the policy either directly or through inheritance. If a policy setting is disabled,
the policy setting is not enforced and is not applied to users and computers that are subject
to the policy either directly or through inheritance.
Most policy preferences have four configuration options: Create, Replace, Update, or
Delete. The Create option creates the preference only if the preference does not already
exist. The Replace option deletes the preference if it exists and then re-creates it, or creates
the preference if it doesn’t yet exist. The Update option modifies the preference if it exists
or creates the preference if it does not exist. The Delete option deletes the preference if it
exists.
You can change the way inheritance works in four key ways. You can:
Change link order and precedence
Override inheritance (as long as there is no enforcement)
Block inheritance (to prevent inheritance completely)
Enforce inheritance (to supersede and prevent overriding or blocking)
The sections that follow describe how to manage Group Policy inheritance using these
techniques.

Changing Link Order and Precedence
The order of inheritance for Group Policy goes from the site level to the domain level to
the organizational unit (OU) level. When multiple policy objects are linked to a particular
level, the link order determines the order in which policy is applied. Linked policy objects
are always applied in link-ranking order. Lower-ranking policy objects are processed
before higher-ranking policy objects.
In the Group Policy Management Console (GPMC), you can determine the GPOs that are
in scope for a particular OU by selecting the OU in the console tree and then selecting the
Linked Group Policy Objects tab in the details pane, as shown in Figure 7-1. These
policies will be processed from the lowest link order to the highest. Support Desktop
Policy (with link order 3) will be processed before Support Networking Policy (with link
order 2). Support Security Policy (with link order 1) will be processed last.
FIGURE 7-1 Review the link-ranking order.
What effect does link order have on policy settings? Well, because Support Networking
Policy settings are processed after Support Desktop Policy settings, Support Desktop
Policy settings have higher precedence and take priority. Because Support Security Policy
settings are processed last, Support Security Policy settings have the highest precedence
and take priority over both Support Desktop Policy and Support Networking Policy.
To go beyond the scope of the OU and view how domain policy affects the OU, select the
OU in the console tree and then select the Group Policy Inheritance tab, as shown in
Figure 7-2. This tab doesn’t display site-linked GPOs; site-linked GPOs are listed under
the Sites node.
The precedence order shows exactly how policy objects are being processed for the
container you’ve selected in the console tree. As with link order, lower-ranking policy
objects are processed before higher-ranking policy objects. Here, General Domain Policy
(with precedence 6) will be processed first, then Corporate Policy (with precedence 5),
and so on. Support Security Policy is processed last, so any policy settings configured in

this policy object are final and will override those of other policy objects (unless
inheritance blocking or enforcing is used).
FIGURE 7-2 Review the precedence order for processing.
When multiple policy objects are linked at a specific level, you can easily change the link
order (and thus the precedence order) of the policy objects linked at that level. To change
the precedence order, complete these steps:
1.                  In the GPMC, select the container for the site, domain, or OU you want to
work with.
2.                  In the details pane, the Linked Group Policy Objects tab should be selected
by default. Click the policy object you want to work with.
3.                  Click the Move Link Up or Move Link Down button as appropriate to
change the link order of the selected policy object.
4.                  When you have finished changing the link order, confirm that policy
objects are being processed in the expected order by checking the precedence order
on the Group Policy Inheritance tab.

Overriding Inheritance
As discussed previously, policy is inherited by lower-level containers from top-level
containers. If multiple policy objects modify the same areas of policy, the order in which
the policy objects are applied determines which policy settings take effect. Essentially, the
order of inheritance goes from the site level to the domain level to the OU level. Although
the Group Policy Inheritance tab doesn’t actually show this, this means that Group Policy
settings for a site are passed down to domains, and the settings for a domain are passed
down to OUs.
You can override policy inheritance in several ways. With policy settings, you can:
Disable an enabled (and inherited) policy setting When a policy setting is
enabled in a higher-level policy object, you can override inheritance by disabling the
policy setting in a lower-level policy object. You thus override the policy setting that
is enabled in the higher-level container. For example, if the user policy Prohibit Use
Of Internet Connection Sharing On Your DNS Domain is enabled for a site, users in
the site should not be able to use Internet Connection Sharing. However, if domain
policy specifically disables this user policy, users in the domain can use Internet
Connection Sharing. On the other hand, if the domain policy is set to Not
Configured, that setting will not be modified and will be inherited as specified for the
higher-level container.
Enable a disabled (and inherited) policy setting When a policy setting is
disabled in a higher-level policy object, you can override inheritance by enabling the
policy setting in a lower-level policy object. By enabling the policy setting in a
lower-level policy object, you override the policy setting that is disabled in the
higher-level container. For example, if the user policy Allow Shared Folders To Be
Published is disabled for a domain, users in the domain should not be able to publish
shared folders in Active Directory. However, if the Support Team OU policy
specifically enables this user policy, users in the Support Team OU can publish
shared folders in Active Directory. Again, if the OU policy is set to Not Configured,
the policy setting will not be modified and will be inherited from the higher-level
container.
With policy preferences, you can:
Delete a created (and inherited) preference When a policy preference is created
in a higher-level policy object, you can override inheritance by deleting the policy
preference in a lower-level policy object. You thus override the policy preference that
is created in the higher-level container. For example, if you create a folder using
Folder preferences within a site, users in the site should have this folder. However, if
domain policy specifically deletes this folder, users in the domain will not have this
folder. On the other hand, if the domain policy doesn’t set this Folder preference, that
preference will not be modified and will be inherited as specified from the higher-
level container.
Create a deleted (and inherited) policy preference When a policy preference is
deleted in a higher-level policy object, you can override inheritance by creating the
policy preference in a lower-level policy object. By enabling the policy preference in
a lower-level policy object, you override the policy preference that is deleted in the

higher-level container. For example, if you delete an environment variable by using
Environment preferences within a site, users in the site should not have the
environment variable. However, if domain policy specifically creates this
environment variable, users in the domain will have this environment variable. On
the other hand, if the domain policy doesn’t set this Environment preference, that
preference will not be modified and will be inherited as specified from the higher-
level container.
As you can see, overriding inheritance is a basic technique for changing the way
inheritance works. As long as a policy is not blocked or enforced, this technique will
achieve the effects you want.

Blocking Inheritance
Sometimes you will want to block inheritance so that policy preferences and settings from
higher-level containers are not applied to users and computers in a particular container.
When inheritance is blocked, only configured policy preferences and settings from policy
objects linked at that level are applied. This means that all GPOs from all high-level
containers are blocked (as long as there is no policy enforcement).
By using blocking, you can ensure that domain or OU administrators have full control
over the policies that apply to users and computers under their administration. At the
domain level, domain administrators can use inheritance blocking to block inherited
policy settings from the site level. At the OU level, OU administrators can use inheritance
blocking to block inherited policy settings from both the domain level and the site level.
That said, the way you use blocking or enforcement will depend largely on your
organizational structure and how much control is delegated to your administrators. Some
organizations choose to centrally manage Group Policy. Others delegate control to
divisions, branch offices, or departments within the organization. There is no one-size-fits-
all solution. A balance between central management and delegation of control might work
best.
Consider the following scenarios to see how blocking can be used:
If you want a domain to be autonomous and don’t want the domain to inherit any site
policies, you can configure the domain to block inheritance from higher-level
containers. Because inheritance is blocked, only the configured policy preferences
and settings from policy objects linked to the domain are applied. Blocking
inheritance of site policy doesn’t affect inheritance of the domain policy objects by
OUs, but it does mean that OUs in that domain will not inherit site policies either.
If you want an OU to be autonomous and don’t want the OU to inherit any site or
domain policies, configure the OU to block inheritance from higher-level containers.
Because inheritance is blocked, only the configured policy preferences and settings
from policy objects linked to the OU are applied. If the OU contains other OUs,
inheritance blocking won’t affect inheritance of policy objects linked to this OU, but
the child OUs will not inherit site or domain policies.
In the GPMC, you can block inheritance by right-clicking the domain or OU that should
not inherit settings from higher-level containers and then clicking Block Inheritance. If
Block Inheritance is already selected, selecting it again removes the setting. When you
block inheritance in the GPMC, a blue circle with an exclamation point is added to the
container’s node in the console tree. This notification icon provides a quick way to tell
whether any domain or OU has the Block Inheritance setting enabled. If you select the
container and then select the Group Policy Inheritance tab in the details pane, you’ll also
see that higher-level policy objects are no longer being inherited, as shown in Figure 7-3.

FIGURE 7-3 Inheritance blocking is enabled.
Note  Blocking inheritance does not affect local GPOs. If you do not want local
GPOs to be applied, you should disable them. To disable processing of Local Group
Policy objects, you can enable the Turn Off Local Group Policy Objects Processing
policy setting in an Active Directory–based Group Policy object that the computer
processes. In Group Policy, this setting is located under Computer Configuration.
Expand Policies\Administrative Templates\System\Group Policy, and then double-
click the Turn Off Local Group Policy Objects Processing policy entry.

Enforcing Inheritance
Sometimes you might want to enforce inheritance and prevent administrators who have
authority over a container from overriding or blocking inherited Group Policy settings.
When inheritance is enforced, all configured policy preferences and settings from higher-
level policy objects are inherited and applied regardless of how they are configured in
lower-level policy objects. Thus, enforcement of inheritance is used to supersede
overriding and blocking of policy preferences and settings.
Forest administrators can use inheritance enforcement to ensure that configured policy
settings from the site level are applied and to prevent overriding or blocking of policy
settings by both domain and OU administrators. Domain administrators can use
inheritance enforcement to ensure that configured policy settings from the domain level
are applied and to prevent overriding or blocking of policy settings by OU administrators.
Enforcing Group Policy inheritance dramatically affects the way that Group Policy is
processed and applied. By default, a site policy has the lowest precedence, and as such it is
the first policy processed. Any of the other policy objects can override or block its
preferences or settings because they are processed later. On the other hand, an enforced
site policy can have the highest precedence, and as such it will be the last policy
processed. This means that no other policy objects can override or block its preferences or
settings.
Consider the following scenarios to see how inheritance enforcement can be used:
As a forest administrator, you want to ensure that domains inherit a particular site
policy, so you configure the site policy to enforce inheritance. All configured policy
preferences and settings from the site policy are thus applied regardless of whether
domain administrators have tried to override or block policy from the site level.
Enforcement of the site policy also affects inheritance for OUs in the affected
domains. They will inherit the site policy regardless of whether overriding or
blocking has been used.
As a domain administrator, you want to ensure that OUs within the domain inherit a
particular domain policy, so you configure the domain policy to enforce inheritance.
All configured policy preferences and settings from the domain policy are thus
applied regardless of whether OU administrators have tried to override or block
policy from the domain level. Enforcement of the domain policy also affects
inheritance for child OUs within the affected OUs. They will inherit the domain
policy regardless of whether overriding or blocking has been used.
In the GPMC, you can enforce policy inheritance by expanding the container to which the
policy is linked, right-clicking the link to the GPO that you want to enforce, and then
clicking Enforced. If Enforced is already selected, selecting it again removes enforcement.
When you enforce inheritance in the GPMC, a lock icon is added to the link to the GPO.
This notification icon provides a quick way to tell whether any linked GPO has its
inheritance enforced. If you select a link to the GPO in the console tree and then select the
Scope tab in the details pane, you’ll also see a Yes entry in the Enforced column under
Links, as shown in Figure 7-4.

Note  If multiple GPOs are enforced at the same level, the settings of a GPO with
higher precedence will be applied over a GPO with lower precedence. For example,
if you’ve linked three GPOs to the site level and enforced all three GPOs, the
settings in the GPO with the highest precedence will always win. The settings in the
GPO with the next highest precedence will always win over the GPO with the next
lowest precedence.
FIGURE 7-4 Review details on the Scope tab to determine whether a linked policy is
enforced.
You can also determine whether policy objects linked at a specific level are enforced by
completing these steps:
1.                  In the GPMC, select the site, domain, or OU that you want to work with in
the console tree.
2.                  In the details pane, select the Group Policy Inheritance tab in the details
pane. If a policy object linked at the selected level is enforced, you’ll see an
(Enforced) entry in the Precedence column, as shown in Figure 7-5.

FIGURE 7-5 Check for the Enforced notation.


Controlling Group Policy Processing and Refresh
Policy processing and refresh settings control when and how policy is applied. You have
many options for customizing or optimizing Group Policy processing and refreshes in
your environment. Key tasks that you might want to perform include the following:
Changing the default refresh interval
Enabling or disabling policy object processing completely or by setting category
Changing the processing preference for user and computer settings
Configuring slow-link detection and subsequent processing
Manually refreshing Group Policy
Before exploring these techniques in the sections that follow, let’s first examine how
policy is processed and refreshed. When you work with Group Policy processing and
refresh, you might also want to know which policy objects have been applied and when
the last policy refresh occurred on a particular computer. For details, see “Determining
Effective Settings and Last Refresh” later in this chapter.

Policy Processing and Refresh Essentials
In Group Policy, policy preferences and settings are divided into two distinct sets:
computer policies and user policies. Computer policies apply to computers and are stored
under Computer Configuration in Group Policy. User policies apply to users and are
stored under User Configuration in Group Policy.
After you create and link a GPO to a site, domain, or OU, the policy preferences and
settings that the GPO contains do not take effect immediately. Instead, the policy
preferences and settings within the GPO are applied the next time policy is processed or
refreshed. The same is true when you change the policy preferences and settings within a
GPO—the changes do not take effect until the next time policy is processed or refreshed.
I distinguish between initial processing of policy and refresh processing of policy because
the two tasks work in very different ways. Initial processing refers to the way policies are
processed the first time policy is applied. Refresh processing refers to the way policies are
processed during subsequent applications of policy.
Whether we are talking about initial processing or refresh processing, it is important to
note that policy is never pushed out to clients from domain controllers. Instead, the Group
Policy client running on a computer is responsible for making policy requests. A domain
controller responding to a request makes policies available, and the client pulls the
policies it needs from the domain controller.
Initial policy processing of computer policies is triggered when a computer is started.
Generally, this means that when a computer is started and the network connection is
initialized, the initial computer policies are applied.
Initial processing of user policies is triggered when a user logs on to a computer.
Generally, this means that when a user logs on to a computer, the initial user policies are
applied.
Because user policies are applied after computer policies, user policies have precedence
over computer policies by default. This means that if computer and user settings conflict,
user settings have priority and take precedence.
After policy settings are applied, the settings are refreshed automatically to ensure that
they are current. By default, Group Policy on domain controllers is refreshed every 5
minutes. For other types of servers and on workstations, Group Policy is refreshed every
90 minutes by default. A random offset of up to 30 minutes is added to reduce impact on
domain controllers and the network during updates (making the effective refresh window
90 to 120 minutes).
During a refresh of Group Policy, the client computer contacts an available domain
controller in its local site. If one or more of the policy objects defined in the domain have
changed, the domain controller provides a list of all the policy objects that apply to the
computer and to the user who is currently logged on, as appropriate. The domain
controller does this regardless of whether the version numbers of the listed policy objects
have changed. By default, the computer processes the policy objects only if the version
number of at least one of the policy objects has changed. If any one of the related policies
has changed, all of the policies have to be processed again to account for inheritance and

the interdependencies within policies.
Security settings are a notable exception to the processing rule. By default, these settings
are refreshed every 16 hours (960 minutes) regardless of whether policy objects contain
changes. A random offset of up to 30 minutes is added to reduce impact on domain
controllers and the network during updates (making the effective refresh window 960 to
990 minutes). Also, if the client computer detects that it is connecting over a slow network
connection, it informs the domain controller, and only the Security Settings and
Administrative Templates policy settings are transferred over the network, which means
that by default only Security Settings and Administrative Templates policy settings are
applied when a computer is connected over a slow link. The way slow-link detection
works is configurable in a policy.
Real World  The major factor affecting the way that Group Policy refreshes work
is link speed. If a computer detects that it is using a slow connection (the exact
definition of which is configurable in Group Policy), the computer modifies the way
policy changes are processed. Specifically, if a client computer detects that it is
using a slow network connection, only the Security Settings and Administrative
Templates are processed. Although you cannot turn off the processing of Security
Settings and Administrative Templates, you can configure other areas of policy so
that related settings are processed across a slow network connection.
Following this, you can summarize the core mechanics of policy processing and refreshes
in this way:
Initial processing occurs when a computer starts or when a user logs on. During
initial processing, all applicable policy objects are processed.
Refresh processing occurs every 5 minutes on domain controllers and every 90 to
120 minutes on workstations. During refresh processing, changes in applicable policy
objects are processed.
Security reprocessing occurs every 960 to 990 minutes. During security reprocessing,
all security settings are reapplied regardless of whether they have changed.
That in a nutshell is how policy processing and refreshes work. Because initial processing
occurs in the foreground and occurs synchronously (meaning each policy object is applied
in order), the startup and logon processes cannot be completed until policy processing is
completed. Because refresh processing occurs in the background, it does not force the user
to wait while a refresh occurs. Instead, changes simply are applied as policy is refreshed.

Policy Processing and Refresh Exceptions
The operating system running on a computer, the computer configuration, and the
configuration of Group Policy itself can alter the way policy processing and refreshes
work. The default setting for Windows Server to synchronously process policy objects in
the foreground every time a computer starts or a user logs on. This means that each policy
object is processed in order for both the computer (during startup) and the user (during
logon). During startup, each policy object must be processed in turn to complete the
startup process. During logon, each policy object must be processed in turn to complete
the logon and make the interface available to the user. Because this type of processing
forces startup or logon to wait until processing is finalized, this type of processing is
referred to as synchronous foreground processing.
Windows desktops use this behavior only the first time a computer is started after joining
the domain. After that, Windows desktops perform asynchronous foreground processing at
startup and logon, a type of processing that works like background refresh processing.
Because asynchronous foreground processing does not force the startup or logon processes
to wait, the user gains access to the user interface more quickly during logon.
This modified behavior would work wonderfully if it weren’t for the fact that some policy
settings can be applied only during foreground processing. Areas of policy that can be
applied only during synchronous foreground processing include policy settings for:
Deployed printers
Folder redirection
Offline files
Scripts
Software installation
In addition, areas of policy preferences affected this way include drive maps and printers.
These and other policy preferences and settings that require synchronous foreground
processing will not be applied during asynchronous foreground processing or during
background refresh processing.
To guarantee the application of these types of preferences and settings, I recommend
creating a GPO called Force Synchronous Processing. In this GPO, enable the Always
Wait For The Network At Computer Startup And Logon Policy setting. Once you create
the GPO, you can:
Link the GPO to the appropriate containers for which forced synchronous processing
is required. This ensures that Windows waits for Group Policy to be applied in the
foreground synchronously during startup and logon.
Unlink the GPO when you no longer want to force synchronous processing. This
allows desktop versions of Windows to default to background refresh only.
Because the Always Wait For The Network At Computer Startup And Logon Policy
setting is under Computer Configuration, the setting is processed by computer (not user)
objects. Finally, it is important to note that while most security-related policy settings can
be applied to a computer during background refresh, some security-related policy settings
require a restart of the computer.

Refreshing Group Policy Manually
As an administrator, you might need to refresh Group Policy manually. For example, you
might not want to wait for Group Policy to be refreshed at the automatic interval, or you
might be trying to resolve a problem with refreshing policy and want to force Group
Policy to be refreshed.
On computers running Windows, you can refresh Group Policy manually by using the
Gpupdate command-line utility. Gpupdate performs a background refresh of Group Policy
on the computer to which you are currently logged on or connected. Table 7-1 provides a
summary of the options you can use with Gpupdate.

TABLE 7-1 Options for Gpupdate
OPTION
DESCRIPTION
REQUIRES
ELEVATED
COMMAND
PROMPT
/Target:Computer
Refreshes only the computer policies.
No
/Target:User
Refreshes only the user policies.
No
/Force
Forces the Group Policy client to refresh all policies. By default only policies
that have changed are refreshed.
No
/Wait:WaitTime
Sets the number of seconds to wait for processing to finish before returning
the command prompt. The default wait time is 600 seconds. Use a value of 0
to return the command prompt immediately. A value of -1 means to wait
infinitely.
No
/Logoff
Forces a logoff after policy is refreshed, which may be required for policies
that can be processed only during logon.
Yes
/Boot
Forces a restart after policy is refreshed, which may be required for policies
that can be processed only during startup.
Yes
/Sync
Sets the next application of foreground policy to be performed synchronously
at startup and at logon.
Yes
You can initiate a background refresh in several ways. If you enter gpupdate at a
command prompt, both computer policies and user policies are refreshed on the local
computer. You can also refresh user and computer policies separately. To refresh only
computer policies, enter gpupdate /target:computer at the command prompt. To refresh
only user policies, enter gpupdate /target:user at the command prompt.
Keep in mind that only policy settings that have changed are processed and applied when
you run Gpupdate. You can change this behavior using the /Force parameter. The /Force
parameter forces a refresh of all policy settings. With a forced refresh, if some user
policies require synchronous foreground processing, you’ll be prompted to log off. Press
Y to log off so that the policies can be applied, or press N to cancel the logoff. You’ll see a
reboot prompt for computer policies that require synchronous foreground processing.
You can use Gpupdate to log off a user or restart a computer after Group Policy is
refreshed. This is useful because some group policies are applied only when a user logs on
or when a computer starts up. To log off a user after a refresh, add the /Logoff parameter.
To restart a computer after a refresh, add the /Boot parameter.
Using the /Sync option, you set a flag that changes the way Gpupdate works. Instead of
causing a refresh to occur, including the /Sync option tells the computer to perform
synchronous foreground processing during the next startup and logon. Any additional
options you include can be used to further control the forced synchronous foreground

processing. For example, if you add /Target:Computer, only computer policies are targeted
and then applied during the next boot cycle. If you add /Target:User, only user policies are
targeted and then applied during the next logon cycle. If you want to force the user to log
off, the computer to restart, or both, you can add the /Logoff option, the /Boot option, or
both.
Real World  When you’ve installed Windows PowerShell and WinRm on computers in
your organization, you can easily execute commands on those computers from your
management computer. Consider the following sample Windows PowerShell script:
$names = @(“corpc85”,“corpc86”,“corpc87”)
$sb = {Get-WmiObject Win32_OperatingSystem | ‘
Invoke-WmiMethod Reboot}
Invoke-Command –scriptblock $sb –computer ‘
$names –asjob
Invoke-Command uses WinRM to run Windows PowerShell remotely. Here, you create
an array of computer names, define a script block, and then invoke the script block on the
remote computers as background jobs. This actually pushes the Get-WmiObject and
Invoke-WmiMethod commands out to each specified computer where they then execute
locally.
In addition to executing its own cmdlets, Windows PowerShell also can execute external
commands that have their own executable files (as long as the executables are in the
command path). Knowing this, you can easily execute other types of commands on
remote computers as well. The following example runs Gpupdate on a group of remote
computers:
$names = @(“corpc85”,“corpc86”,“corpc87”)
$sb = {Gpupdate}
Invoke-Command –scriptblock $sb –computer ‘
$names –asjob
This actually pushes the Gpupdate command out to each specified computer, where it
then executes locally. Keep in mind that WinRM uses TCP port 80 for HTTP and TCP
port 443 for HTTPS by default, and these ports must be open between your management
computer and the target computers.

Changing the Refresh Interval
After Group Policy is initially applied, it is periodically refreshed to ensure that it is
current. The default refresh interval for domain controllers is 5 minutes. For all other
computers, the default refresh interval is 90 minutes, with up to a 30-minute variation to
avoid overloading the domain controller with numerous concurrent client requests. This
means an effective refresh window for non–domain controller computers of 90 to 120
minutes.
You can change the refresh rate. A faster refresh rate reduces the possibility that a
computer won’t have the most current policy configuration. A slower refresh rate reduces
the frequency of policy refreshes (which can also reduce overhead with regard to resource
usage), but it also increases the possibility that a computer won’t have the most current
policy configuration.
In a large organization with many computers, you might want to reduce policy-related
resource usage on your domain controllers, or you might want to reduce policy-related
traffic on your network. To do this, you can change the default refresh interval. Here are
some examples:
If policy is changed infrequently and you want to relax the processing rules, you can
increase the refresh window to reduce resource usage. For example, you could use a
refresh interval of 15 minutes on domain controllers and 120 minutes on other
computers.
If policy is changed frequently and you want to ensure faster application, you can
reduce the refresh window (while increasing resource usage). For example, you could
use a refresh interval of 5 minutes on domain controllers and 45 minutes on other
computers.
You can change the Group Policy refresh interval on a per-policy-object basis. To set the
refresh interval for domain controllers, complete the following steps:
1.                  In the GPMC, right-click the Group Policy object you want to modify, and
then click Edit. This GPO should be linked to a container that contains domain
controller computer objects.
2.                  Under Computer Configuration, navigate to Policies\Administrative
Templates\System\Group Policy folder.
3.                  Double-click the Set Group Policy Refresh Interval For Domain
Controllers policy. This displays a Properties dialog box for the policy, as shown in
Figure 7-6.
4.                  Define the policy by selecting Enabled.
Use the first Minutes combo box to set the base refresh interval. You will usually want
this value to be between 5 and 59 minutes.
5.                  Use the other Minutes combo box to set the minimum and maximum time
variation for the refresh interval. The variation effectively creates a refresh window,
with the goal to avoid overloading that might result from numerous simultaneous
client requests for a Group Policy refresh.

6.                  Click OK to save your settings.
FIGURE 7-6 Change the refresh interval for domain controllers.
To set the refresh interval for non–domain controller computers (member servers and
workstations), complete the following steps:
1.                  In the GPMC, right-click the Group Policy object you want to modify, and
then click Edit. This GPO should be linked to a container that contains computer
objects.
2.                  Under Computer Configuration, navigate to the Policies\Administrative
Templates\System\Group Policy folder.
3.                  Double-click the Set Group Policy Refresh Interval For Computers policy.
This displays a Properties dialog box for the policy, as shown in Figure 7-7.
4.                  Define the policy by selecting Enabled.
5.                  Use the first Minutes combo box to set the base refresh interval. You will
usually want this value to be between 60 and 180 minutes.
6.                  Use the other Minutes combo box to set the minimum and maximum time
variation for the refresh interval. The variation effectively creates a refresh window,
with the goal to avoid overloading that might result from numerous simultaneous
client requests for a Group Policy refresh.
7.                  Click OK to save your settings.

FIGURE 7-7 Change the refresh interval for member servers and workstations.

Modifying GPO Processing
You can enable or disable processing of policy objects either completely or partially.
Completely disabling a policy object is useful if you no longer need a policy now but
might want to use it in the future, or if you’re troubleshooting policy-processing problems.
Partially disabling a policy object is useful when you want the related policy settings to
apply to either users or computers but not both.
By partially disabling a policy, you can then ensure that only the per-computer policy
settings or only the per-user policy settings are applied. In cases in which you are trying to
speed up policy processing, you might also want to disable user or computer settings.
However, you should do this only when you’ve fully determined the impact of this change
on your environment.
You can enable and disable policies partially or entirely by completing the following steps:
1.                  In the GPMC, select the container for the site, domain, or OU with which
you want to work.
2.                  Select the policy object you want to work with, and then click the Details
tab in the details pane, as shown in Figure 7-8.
FIGURE 7-8 Check the current GPO status.
3.                  Use the GPO Status list to choose one of the following status settings:
Enabled Allows processing of the policy object and all its settings.
All Settings Disabled Disallows processing of the policy object and all its
settings.
Computer Configuration Settings Disabled Disables processing of Computer
Configuration settings; only User Configuration settings are processed.
User Configuration Settings Disabled Disables processing of User
Configuration settings; only Computer Configuration settings are processed.

4.                  When prompted to confirm that you want to change the status of this GPO,
click OK.

Configuring Loopback Processing
When Group Policy is applied, computer policies are applied before user policies. Because
Group Policy uses a last-writer-wins methodology, this means that user policy settings
override computer policy settings when a conflict occurs between settings in Computer
Configuration and settings in User Configuration. It is also important to point out that
computer settings are applied from the computer’s GPOs, and user settings are applied
from the user’s GPOs.
In some special situations, you might not want this behavior. In a secure lab or kiosk
environment, for example, you might want user settings to be applied from the computer’s
GPOs to ensure compliance with the strict security rules and guidelines for the lab. On a
shared computer, you might want user settings to be applied from the computer’s GPOs
but also allow user settings from the user’s GPOs to be applied. Using loopback
processing, you can allow for these types of exceptions and obtain user settings from a
computer’s GPOs.
To configure loopback processing, complete the following steps:
1.                  In the GPMC, right-click the Group Policy object you want to modify, and
then click Edit.
2.                  Under Computer Configuration, navigate to the Policies\Administrative
Templates\System\Group Policy folder.
3.                  Double-click the Configure User Group Policy Loopback Processing
Mode policy. This displays a Properties dialog box for the policy, as shown in
Figure 7-9.
FIGURE 7-9 Set the loopback mode to either Replace or Merge.

4.                  Define the policy by selecting Enabled, and then use the Mode list to select
one of these processing modes:
Replace When you use the Replace option, user settings from the computer’s
GPOs are processed and the user settings in the user’s GPOs are not processed. This
means the user settings from the computer’s GPOs replace the user settings
normally applied to the user.
Merge When you use the Merge option, user settings in the computer’s GPOs are
processed first, then user settings in the user’s GPOs are processed, and then user
settings in the computer’s GPOs are processed again. This processing technique
combines the user settings in both the computer and user GPOs. If there are any
conflicts, the user settings in the computer’s GPOs have preference and overwrite
the user settings in the user’s GPOs.
5.                  Click OK to save your settings.


Configuring Slow-Link Detection
A computer connected to a local area network (LAN) does not necessarily have a fast link,
nor does a computer connected using a remote connection necessarily have a slow link.
The default value for what Group Policy considers a slow link is any rate slower than 500
kilobits per second (Kbps). You can change this threshold by using Group Policy.

Slow-Link Detection Essentials
Active Directory uses slow-link detection to help reduce network traffic during periods of
high latency. This feature is used by Group Policy clients to detect increased latency and
reduced responsiveness on the network and then take corrective action to reduce the
likelihood that processing Group Policy will further saturate the network. Once a slow link
is detected, Group Policy clients reduce their network communications and requests to
reduce the overall network traffic load by limiting the amount of policy processing they
do.
The technique that client computers use to determine whether they are using a slow
network connection depends on the operating system:
The client computer sends a sequence of pings to the domain controller to which it is
connected. The response time from the domain controller (which is an indicator of
latency) determines the next step. If the response time from any of the pings is 10
milliseconds or less, the client maintains or resumes processing of Group Policy
following normal (full) procedures. If the response time from the domain controller is
more than 10 milliseconds, the computer pings the domain controller three times with
a 2-KB message packet and uses the average response time to determine the network
speed.
The Group Policy client determines the link speed by using the Network Location
Awareness (NLA) service to sample the current TCP traffic between the client and
the logon domain controller. Prior to beginning a refresh, the Group Policy service
running on the client requests the NLA service to start sampling TCP bandwidth on
the network interface that hosts the domain controller. The Group Policy service
continues to communicate with the domain controller as it gathers the information
required to do a policy refresh. Then the Group Policy service requests the NLA
service to stop sampling the TCP traffic and provide an estimated bandwidth between
the computer and the domain controller based on the sampling.
By default, if the connection speed is determined to be less than 500 Kbps (which could
also be interpreted as high latency/reduced responsiveness on a fast network), the client
computer interprets this as a slow network connection and notifies the domain controller.
As a result, only the Administrative Templates (registry-based) settings and critical
security settings are requested and then applied by default. Table 7-2 provides a detailed
summary of which settings are applied over a slow link by default and whether a policy
area is reapplied during refresh even if it hasn’t changed by default.
TABLE 7-2 Default Settings for Policy Refresh over a Slow Link
POLICY AREAS
REQUESTED OVER A SLOW
LINK?
PROCESS EVEN IF NOT
CHANGED?
Administrative Templates
Yes (Cannot be disabled)
No
Applications Preferences
Yes
Yes
Data Sources Preferences
Yes
Yes

Deployed Printers
No
No
Devices Preferences
Yes
Yes
Disk Quotas
No
No
Drive Maps Preferences
Yes
Yes
EFS Recovery
No
No
Environment Preferences
Yes
Yes
Files Preferences
Yes
Yes
Folder Options Preferences
Yes
Yes
Folder Redirection
No
No
Folders Preferences
Yes
Yes
Internet Explorer Maintenance
Yes
No
Ini Files Preferences
Yes
Yes
Internet Settings Preferences
Yes
Yes
IP Security
Yes
No
Local Users And Groups
Preferences
Yes
Yes
Network Options Preferences
Yes
Yes
Network Shares Preferences
Yes
Yes
Power Options Preferences
Yes
Yes
Printers Preferences
Yes
Yes
Regional Options Preferences
Yes
Yes
Registry Preferences
Yes
Yes
Registry security settings
No
No
Scheduled Tasks Preferences
Yes
Yes
Scripts
No
No
Security
Yes (Cannot be disabled)
Yes
Services Preferences
Yes
Yes

Shortcuts Preferences
Yes
Yes
Software Installation
No
No
Software Restriction Policies
Yes
No
Start Menu Preferences
Yes
Yes
Wired Policy
Yes
No
Wireless Policy
Yes
No
You can configure slow-link detection using the Configure Group Policy Slow Link
Detection policy. Under Computer Configuration, you’ll find this policy in the
Policies\Administrative Templates\System\Group Policy folder. If you disable this policy
or do not configure it, clients use the default value of 500 Kbps per second to determine
whether they are on a slow link. If you enable this policy, you can set a different slow-link
value, such as 256 Kbps per second.
The only way to disable slow-link detection completely is to enable the Group Policy
Slow Link Detection policy and then set the Connection Speed option to 0. This setting
effectively tells clients not to detect slow links and to consider all links to be fast.
You can optimize processing for various areas of Group Policy individually as well. To do
this, you use Computer Configuration policies found in the Policies\Administrative
Templates\System\Group Policy folder. Key policies include:
Configure Disk Quota Policy Processing By default, updates to policy settings for
disk quotas are not processed over slow links. This doesn’t, however, change the
meaning of or enforcement of any current disk quotas defined in a GPO. Previously
obtained policy settings for disk quotas are still enforced.
Configure EFS Recovery Policy Processing By default, updates to policy settings
for Encrypting File System (EFS) recovery are not processed over slow links. This
doesn’t, however, change the meaning of or enforcement of any current EFS recovery
options defined in policy. If you turn off EFS recovery processing, previously
obtained policy settings for EFS recovery are still valid and enforced.
Configure Folder Redirection Policy Processing By default, updates to policy
settings for folder redirection are not processed over slow links. Note that folder
redirection settings are only read and applied during logon. Thus, if a user connects
over a slow network during logon, the folder redirection settings will not apply by
default and the user’s folders will not be subsequently redirected. This behavior is
typically what you want, especially if users are connecting via a dial-up or another
slow remote connection.
Configure Internet Explorer Maintenance Policy Processing By default, updates
to policy settings for Windows Internet Explorer maintenance are processed over
slow links. If always having the most current Internet Explorer maintenance settings
is important to the safety and security of the network, you should allow processing
across a slow network connection. This ensures that the settings are the most current
possible given the current Group Policy refresh rate.

Configure IP Security Policy Processing By default, updates to policy settings for
IP Security are processed over slow links. If you turn off processing, it doesn’t
change the meaning of or enforcement of any current IP Security policies. Previously
obtained policy settings for IP Security are still valid and enforced.
Configure Scripts Policy Processing By default, updates to policy settings for
scripts are not processed over slow links. Note that policy-defined scripts are
executed only when specific events occur, such as logon, logoff, shutdown, or
startup.
Configure Security Policy Processing Updates to policy settings for security are
always processed regardless of the type of link. By default, security policy is
refreshed every 16 hours even if security policy has not changed. The only way to
stop the forced refresh is to configure security policy processing so that it is not
applied during periodic background refreshes. To do this, you select the policy setting
Do Not Apply During Periodic Background Processing. Because security policy is so
important, however, the Do Not Apply setting means only that security policy
processing is stopped when a user is logged on and using the machine. One of the
only reasons you’ll want to stop security policy refresh is if applications are failing
during refresh.
Configure Software Installation Policy Processing By default, updates to policy
settings for software installation are not processed over slow links. This means new
deployments of or updates to software are not made available to users who connect
over slow links. This is typically a good thing because deploying or updating
software over a slow link can be a very long process.
Wireless Policy Processing By default, updates to policy settings for wireless
networking are processed over slow links. If you turn off processing, it doesn’t
change the meaning of or enforcement of any current wireless policies. Previously
obtained policy settings for wireless networking are still valid and enforced.
Each of these Processing settings, as well as other related Processing settings, can be
enabled or disabled to modify the way processing works. If you enable a Processing
setting, you’ll have additional optimization options, which can include:
Allow Processing Across A Slow Network Connection Select this option to
enable slow-link processing. Clear this option to disable slow-link processing.
Do Not Apply During Periodic Background Processing Select this option to
disable background processing (allowing only foreground processing at startup and
logon). Clear this option to enable background processing.
Process Even If The Group Policy Objects Have Not Changed Select this option
to process the related area of policy even if there aren’t any changes. Clear this
option to process only the related area when there are changes.
Generally, policy areas related to preferences are processed even if they haven’t changed.
This is important to note because policy preferences are configured by default so that they
are reapplied during policy refresh. If you don’t want preferences in a particular policy
area to be automatically reapplied during refresh, you have two choices. You can:
Override the default setting on a per-preference basis. To do this, select the Apply
Once And Do Not Reapply option on the Common tab when you configure a related

preference.
Override the default setting for a policy area on a per-GPO basis. To do this, enable
the related Processing policy setting and then clear the Process Even If The Group
Policy Objects Have Not Changed check box.

Configuring Slow-Link Detection and Policy Processing
You can configure slow-link detection and related policy processing by completing the
following steps:
1.                  In the GPMC, right-click the policy object you want to modify, and then
click Edit.
2.                  Under Computer Configuration, navigate to the Policies\Administrative
Templates\System\Group Policy folder.
3.                  Double-click the Configure Group Policy Slow Link Detection policy.
4.                  Select Enabled to define the policy, as shown in Figure 7-10, and then use
the Connection Speed combo box to specify the speed that should be used to
determine whether a computer is on a slow link. For example, if you want
connections of less than 256 kilobits per second to be deemed slow, enter 256. If
you want to disable slow-link detection completely for this policy object, enter 0.
5.                  Click OK to save your settings.
FIGURE 7-10 Configure slow-link detection.

Configuring Slow-Link and Background Policy Processing
Policy preferences are refreshed in full every 90 to 120 minutes. Security settings are
refreshed in full every 16 hours. Other areas of Group Policy are not refreshed fully. For
these areas, only policies that have changed are refreshed. Sometimes, however, you might
want to force clients to reprocess policy settings even if they haven’t changed on the
server.
Real World  Consider the case in which a local OU administrator has made
changes to a local computer that might affect how the computer operates. If the local
admin has modified the registry or another area of the operating system directly,
these changes won’t be reflected as changes to Group Policy. To try to overwrite and
fix these types of changes, you might want to reapply Group Policy. As long as
Group Policy writes to the related area of the registry or to the operating system
configuration in general, the problem will be resolved.
You can optimize slow-link and background processing (refresh) of key areas of Group
Policy by using the Computer Configuration policies in the Policies\Administrative
Templates\System\Group Policy folder. The key configuration options available include:
Allow Processing Across A Slow Network Connection Ensures that the extension
settings are processed even on a slow network
Do Not Apply During Periodic Background Processing Overrides refresh when
extension settings change after startup or logon
Process Even If The Group Policy Objects Have Not Changed Forces the client
computer to process the extension settings during refresh even if the settings haven’t
changed
Background Priority Sets the relative priority for the related background process
as either normal, below normal, low, or idle
Tip  By default, Background Priority is set to idle, which means the related
process has no priority at all. Because all prioritized processes go before no-priority
processes, there is a strong possibility that no-priority processes will not get
adequate processing time on a highly active system. To prevent this from happening,
you can increase the priority as appropriate.
To configure slow-link and background policy processing of key areas of Group Policy,
complete these steps:
1.                  In the GPMC, right-click the policy object you want to modify, and then
click Edit.
2.                  Under Computer Configuration, navigate to the Policies\Administrative
Templates\System\Group Policy folder.
3.                  Double-click the policy you want to configure. The key policies for
controlling slow-link and background policy processing include:
Configure Applications Policy Processing
Configure Data Sources Policy Processing
Configure Devices Policy Processing
Configure Disk Quotas Policy Processing

Configure Drive Maps Preference Extension Policy Processing
Configure EFS Recovery Policy Processing
Configure Environment Preference Extension Policy Processing
Configure Files Preference Extension Policy Processing
Configure Folder Options Preference Extension Policy Processing
Configure Folder Redirection Policy Processing
Configure Folders Preference Extension Policy Processing
Configure Group Policy Caching
Configure Group Policy Slow Link Detection
Configure Internet Explorer Maintenance Policy Processing
Configure Ini Files Policy Processing
Configure Internet Settings Preference Extension Policy Processing
Configure IP Security Policy Processing
Configure Local Users And Groups Policy Processing
Configure Logon Script Delay
Configure Network Options Preference Extension Policy Processing
Configure Network Shares Preference Extension Policy Processing
Configure Power Options Preference Extension Policy Processing
Configure Printers Policy Preference Extension Processing
Configure Regional Options Preference Extension Policy Processing
Configure Registry Policy Processing
Configure Registry Preference Extension Policy Processing
Configure Scheduled Tasks Policy Processing
Configure Scripts Policy Processing
Configure Security Policy Processing
Configure Services Preference Extension Policy Processing
Configure Shortcuts Preference Extension Policy Processing
Configure Software Installation Preference Policy Processing
Configure Start Menu Preference Extension Policy Processing
Configure Wired Policy Processing
Configure Wireless Policy Processing

FIGURE 7-11 Optimize policy processing.
4.                  Select Enabled to define the policy, as shown in Figure 7-11, and then
make your configuration selections. The options will differ slightly depending on
the policy selected and might include the following:
Allow Processing Across A Slow Network Connection
Do Not Apply During Periodic Background Processing
Process Even If The Group Policy Objects Have Not Changed
Background Priority
5.                  Click OK to save your settings.


Planning Group Policy Changes
Before you change Group Policy, you should model the effects of policy changes you’d
like to make and back up the current Group Policy configuration. After you implement
Group Policy or perform updates to Group Policy, you should review the results. Then,
when you have finished with the update and review processes, you should back up the
Group Policy configuration again.

Testing Implementation and Configuration Scenarios
Modeling Group Policy for planning is useful when you want to test various
implementation and configuration scenarios. For example, you might want to model the
effect of a slow link or the use of loopback processing. You can also model the effect of
moving users or computers to another container in Active Directory or the effect of
changing security group membership for users and computers.
All domain and enterprise administrators have permission to model Group Policy for
planning, as do those who have been delegated the Perform Group Policy Modeling
Analyses permission. To model Group Policy and test various implementation and update
scenarios, complete these steps:
1.                  In the GPMC, right-click the Group Policy Modeling node, and then click
Group Policy Modeling Wizard.
2.                  When the Group Policy Modeling Wizard starts, click Next. The Domain
Controller Selection page, shown in Figure 7-12, is displayed.
FIGURE 7-12 Select the domain controller on which the simulation will run.
3.                  Under Show Domain Controllers In This Domain, select the domain for
which you want to model results.
4.                  Under Process The Simulation On This Domain Controller, the Any
Available Domain Controller option is selected by default. If you want to use a
specific domain controller, select This Domain Controller, and then choose a
specific domain controller from the list. Click Next.
5.                  On the User And Computer Selection page, shown in Figure 7-13, select
the modeling options for users and computers. In most cases, you’ll want to model
policy for a specific container using user and computer information. In this case, do

the following:
Under User Information, select Container, and then click Browse to display the
Choose User Container dialog box. Choose any of the available user containers in
the selected domain. For example, you can simulate policy settings for users in the
Customer Service OU.
Under Computer Information, select Container, and then click Browse to display
the Choose Computer Container dialog box. Choose any of the available computer
containers in the selected domain. For example, you can simulate policy settings for
computers in the same OU you selected under User Information or in a different
OU, such as in the Technology OU.
FIGURE 7-13 Define the simulation criteria for users, computers, or both.
6.                  Click Next. The Advanced Simulation Options page, shown in Figure 7-
14, is displayed. The advanced options allow you to modify the simulation for
network and subnet variations, such as slow-link detection, loopback processing,
and accessing the network from a particular site. Select any advanced options as
necessary.

FIGURE 7-14 Specify advanced simulation criteria.
7.                  Click Next. If you are modeling user information, the User Security
Groups page, shown in Figure 7-15, is displayed.
8.                  Use the options on this page to simulate what would happen if you were to
add a user to a designated security group. By default, the simulation is for a user
who is a member of the implicit security groups Authenticated Users and Everyone.
If you want to simulate membership in additional groups, you can add the groups
here. For example, if you want to see what would happen if a user in the designated
container were a member of the Engineering security group, you can add this group
to the Security Groups list. You might want to do this, for example, if you’ve
configured security filtering for some policy objects.

FIGURE 7-15 Simulate user membership in various security groups.
9.                  Click Next. If you are modeling computer information, the Computer
Security Groups page, shown in Figure 7-16, is displayed.
10.             Use the options on this page to simulate what would happen if you were to
add a computer to a designated security group. By default, the simulation is for a
computer that is a member of the implicit security groups Authenticated Users and
Everyone. If you want to simulate membership in additional groups, you can add
the groups here. For example, if you want to see what would happen if a computer
in the designated container were a member of the Domain Controllers security
group, you can add this group to the Security Groups list.

FIGURE 7-16 Simulate computer membership in various security groups.
11.             Windows Management Instrumentation (WMI) filters can be linked to
policy objects. By default, selected users and computers are assumed to meet all
WMI filter requirements, which is what you want in most cases for modeling, so
click Next twice to skip the WMI Filters For Users and WMI Filters For Computers
pages.
12.             If the default behavior isn’t what you want, on the WMI Filters For Users
page, select Only These Filters and then click List Filters. The wizard searches for
and lists all applicable filters. If you don’t want a filter to apply, click it and then
click Remove. Click Next to continue. Repeat the selection process on the WMI
Filters For Computers page and then click Next again.
13.             To complete the modeling, click Next, and then click Finish. The wizard
generates a report, the results of which are displayed in the details pane. The name
of the modeling report is generated based on the containers you chose.
14.             Click on the report’s name to highlight it for editing. Type a descriptive
name for the modeling report, and then press Tab. On the report, click Show All to
display all the policy information that was modeled.
15.             You can then work through the various nodes of the report to view the
effective settings for users, computers, or both in the selected container and for the
selected modeling options.

Determining Effective Settings and Last Refresh
You can also use Group Policy modeling to log Resultant Set of Policy (RSoP). RSoP
allows you to review:
All of the policy objects that apply to a computer.
The last time the applicable policy objects were processed (refreshed).
The user currently logged on to a computer (if any).
All domain and enterprise administrators have permission to generate RSoP, as do those
who have been delegated permission to Read Group Policy Results Data. To generate
RSoP, complete these steps:
1.                  In the GPMC, right-click the Group Policy Results node, and then click
Group Policy Results Wizard.
2.                  When the Group Policy Results Wizard starts, click Next. On the
Computer Selection page, shown in Figure 7-17, select This Computer to view
information for the local computer. If you want to view information for a remote
computer, select Another Computer and then click Browse. In the Select Computer
dialog box, type the name of the computer, and then click Check Names. After you
select the correct computer account, click OK.
FIGURE 7-17 Select the computer for which you want to log RSoP.
3.                  By default, both user and computer policy settings are logged. If you want
to see results only for user policy settings, select Do Not Display Policy Settings
For The Selected Computer. Click Next.
4.                  On the User Selection page, shown in Figure 7-18, select the user whose
policy information you want to view. You can view policy information for any user

who has logged on to the computer. If you want to see results only for computer
policy settings, select Do Not Display User Policy Settings.
FIGURE 7-18 Select the user whose RSoP for this computer you want to view.
5.                  To complete the modeling, click Next twice, and then click Finish. The
wizard generates a report, the results of which are displayed in the details pane.
6.                  The name of the modeling report is generated based on the user and
computer you chose. Click on the name to highlight it for editing. Type a
descriptive name for the modeling report, and then press Tab.
7.                  On the report, click Show All to display all the policy information that was
modeled. You can then work through the various nodes of the report to view the
effective settings for the selected user, computer, or both.
To view the last time the computer or user policy was refreshed, look under Computer
Configuration Summary, General or User Configuration Summary, General and then
check Last Time Group Policy Was Processed, as appropriate.
To view applied policy objects for the computer or user, look under Computer
Configuration Summary, Group Policy Objects, Applied GPOs or User Configuration
Summary, Group Policy Objects, Applied GPOs, as appropriate.
To view denied policy objects for the computer or user, look under Computer
Configuration Summary, Group Policy Objects, Denied GPOs or User Configuration
Summary, Group Policy Objects, Denied GPOs, as appropriate.
The entries under Denied Policy objects show all policy objects that should have been
applied but weren’t. This typically occurs because the policy objects were empty or did
not contain any computer or user policy settings. A policy object also might not have been
processed because inheritance was blocked. If so, the Reason Denied is stated as Blocked

SOM. Scope of Management (SOM) refers to the location to which a GPO is linked.
There are three types of SOMs: sites, domains, and OUs. If inheritance was blocked, this
caused the GPO to fall outside the SOM. As a result, the GPO was not applied.


Chapter 8. Maintaining and Restoring Group Policy
As an administrator, you’ll perform many different tasks to maintain and recover Group
Policy. In other chapters of this book, I’ve covered most of the key tasks. In this chapter, I
cover the following additional tasks:
Planning for new enterprise needs
Maintaining Group Policy object (GPO) storage
Copying, importing, and migrating GPOs
Backing up and restoring Group Policy
Troubleshooting Group Policy


Growing Your Enterprise Policy Configuration
Standard configurations for Group Policy work well when applications run on client
computers and users log on within their home forests. In more diverse enterprise
environments, however, applications don’t always run on client computers and users don’t
always log on within their home forests. As a result, you might need to configure Group
Policy to work with thin clients, terminal servers, or cloud computing. You might also
need to configure Group Policy to work across forests. These concepts are discussed in
this section.

Policy Processing for Thin Clients, Terminal Services, and Cloud Computing
In the enterprise, users might run applications on remote terminal servers, or they might
use Internet-accessible on-demand services (referred to as cloud computing architecture).
In either case, the underlying computing architecture runs on servers rather than on client
computers. In these environments, you need to carefully consider how you will use Group
Policy.
In many cases, you’ll want everyone who logs on to your terminal servers to have the
same settings, regardless of who they are. To do this, you can configure loopback
processing to use Replace mode, as discussed in “Configuring Loopback Processing” in
Chapter 7, “Managing Group Policy Processing.” In Replace mode, user settings from the
GPOs applied to the terminal servers are processed, and the user settings in the user’s
GPOs are not processed. Thus, the user settings from the terminal server’s GPOs replace
the user settings normally applied to the user.
To ensure that Group Policy is processed as expected, you need to create an organizational
unit (OU) for your terminal servers and then move the computer objects for your terminal
servers to this OU. After you reboot the terminal servers to ensure that the move is
processed, you can be sure that any user policy settings on GPOs linked to the terminal
servers OU will apply to users who log on to your terminal servers.
Typically, administrators within your organization are responsible for managing and
configuring your terminal servers, including managing the underlying hardware. In
contrast, with Internet-accessible on-demand services, third-party computer-services
organizations usually manage the underlying hardware, while members of your
organization manage virtual server environments. Rather than logging on to a central
server, users access individual applications running within the virtual server environment
over the Internet. Therefore, in this configuration, you typically would not want to use
loopback processing.

Policy Processing Across Forests
An Active Directory forest can be joined to another forest using cross-forest trusts. When
a user from one forest logs on to a computer in another forest, the Group Policy client
running on the computer disables processing of cross-forest policy and enforces loopback
processing in the current forest for the user. As a result, the computer processes GPOs as if
it was using the loopback processing Replace mode and logs a related event in the
Application log. This means that the computer:
Ignores GPOs that would normally apply to the user in his or her home forest.
Processes only the computer’s GPOs, and applies both the computer settings and the
user settings from those GPOs.
Logs event ID 1109 in the Application log. This event states that a specified user
from a different forest logged on to the local machine and that loopback processing
was enforced in this forest for this user account.
Real World  As long as the computer is running the latest service pack, policy
processing across forests uses Replace mode by default. Additionally, as discussed
in more detail in “Working with Domain and Forest Trusts” in Chapter 8,”Managing
Trusts and Authentication,” in Active Directory Administration: The Personal
Trainer , cross-forest trusts can be configured to allow forestwide authentication or
to use selective authentication. The forestwide authentication configuration allows
unrestricted access by users in another forest. The selective authentication
configuration requires users from another forest to be specifically granted
authentication permissions.
Computers process policy across forests in this way to protect themselves from settings
that could potentially affect their stability and security. Generally, this is a good thing
because administrators in one forest might not have any control over the policy settings in
another forest. However, if you have tested various configurations and are sure that the
user GPOs do not affect stability or security, you might want to configure policy so that
both user and computer GPOs are always applied. To do this, you can enable the Allow
Cross-Forest User Policy And Roaming User Profiles setting. Under Computer
Configuration, you’ll find this policy in the Administrative Templates\System\Group
Policy folder.
Applying the Allow Cross-Forest User Policy And Roaming User Profiles setting to
servers generally affects security in some way, so typically you want to ensure that this
setting is applied only to workstation versions of Windows. To do this, you can configure
the setting in GPOs that do not apply to servers or you can create a GPO called Allow
Cross-Forest Policy and link it to OUs that affect only workstations.


Maintaining GPO Storage
Each Group Policy object has a related Group Policy container (GPC) and a related Group
Policy template (GPT). The sections that follow discuss techniques for working with the
GPC and GPT separately from the GPO itself.

Examining Group Policy Containers
The Group Policy container (GPC) for a GPO is:
Stored in the Active Directory database.
Replicated through normal Active Directory replication.
Used to store properties related to the GPO.
Identified with a globally unique identifier (GUID).
You can use Active Directory Users And Computers to view the GPC associated with
every GPO you’ve created. In Active Directory Users And Computers, choose Advanced
Features on the View menu. Expand the System and Policies nodes, and you’ll see the
GPC objects for the domain to which you are currently connected.
As shown in Figure 8-1, each GPC is identified by its GUID. While the GUID for each
GPO you create is unique, the two default GPOs have the same GUID in every domain. If
you expand the GPC folder, you’ll see that each GPC has a subfolder named Machine and
a subfolder named User.
FIGURE 8-1 Locate Group Policy containers.
If you right-click a container and select Properties, you can view detailed information
about the GPC. On the Object tab, shown in Figure 8-2, you’ll see the following
information:
Canonical Name Of Object Shows the object’s place in the directory tree as a
logical path from the highest container to the object itself—for example,
imaginedlands.com/System/Policies/{3E60DB37-C145-480F-9050-7c5fa26916b6}.

Object Class Shows the object class, which in this case is groupPolicyContainer.
Created Shows the date the GPC was created.
Modified Shows the date the GPC was last modified.
Update Sequence Number (USNs) Shows the current and original USN for the
object.
FIGURE 8-2 Review object properties for a GPC.
On the Security tab, shown in Figure 8-3, you can determine who has access to the GPC in
Active Directory. Generally, these values are as set in the Group Policy Management
Console (GPMC) for the related GPO and should not be modified directly.

FIGURE 8-3 Review GPC security.
On the Attribute Editor tab, shown in Figure 8-4, you’ll find the complete set of attributes
associated with the GPC. Some of the key properties include:
cn Shows the common name of the GPC, such as {3E60DB37-C145-480F-9050-
7c5fa26916b6}. This is the name of the GPC relative to the parent container in which
it is stored. This property is also referred to as the relative distinguished name
(RDN).
displayName Shows the friendly name of the object as assigned in the user
interface, such as Atlanta Site Primary GPO.
distinguishedName Shows the object’s place in the directory tree as a logical
series of containers, from the object itself to the highest container with which it is
associated—for example, CN={3E60DB37-C145-480F-9050-7c5fa26916b6},
CN=Policies, CN=System, DC=imaginedlands, DC=com.

Figure 8-4 Review GPC attributes.
gPCFileSysPath Shows the physical path to the associated Policies folder (the
GPT) stored in the SYSVOL. The Policies folder has the same name as the GPC
itself.
gPCFunctionalityVersion Shows the version number of the Group Policy
extension tool that created the Group Policy object.
gPCMachineExtensionNames Shows the list of GUIDs that tell the client-side
engine which client-side extensions (CSEs) have machine data in the GPO. CSEs are
listed according to their GUIDs and the GUID of the Microsoft Management Console
(MMC) snap-in for the Administrative Templates node.
gPCUserExtensionNames Shows the list of GUIDs that tell the client-side engine
which CSEs have user data in the GPO. CSEs are listed according to their GUIDs
and the GUID of the MMC snap-in for the Administrative Templates node.
objectClass Shows the object class, which in this case is groupPolicyContainer.
USNChanged Shows the current USN for the object.
USNCreated Shows the original USN for the object.
versionNumber Shows the version of the object.
whenChanged Shows the date the GPC was last modified.
whenCreated Shows the date the GPC was created.
The version number tracks changes in a GPO. When you create a new GPO, the version
number is 0. As you edit a GPO, the version number increases according to the following
formula:
Version = (Number of User Configuration changes * 65536) + 
(Number of Computer Configuration changes)

According to the formula:
When you configure a setting in Computer Configuration, the GPMC adds 1 to the
version number. If you were to then not configure the setting, the GPMC adds 1 to
the version number again.
When you configure a setting in User Configuration, the GPMC adds 65,536 to the
version number. If you were to then not configure the setting, the GPMC adds 65,536
to the version number again.
This formula makes it possible for the GPMC to track changes to Computer Configuration
and User Configuration using a single value. In the GPMC, if you select a GPO in the
console tree and then click the Details tab in the details pane, you see the separate version
details for Computer Configuration and User Configuration, as shown in Figure 8-5.
FIGURE 8-5 Check the version number in the GPMC.
Here the User Configuration was modified four times and the Computer Configuration
modified 37 times: (65,536 * 4) + 37 equals 262,181. If you were to compare the version
information shown in the GPMC to the versionNumber attribute, you’d find the version
number was 262,181.
Real World  The GPC and the GPT store the same version number for a GPO.
However, in situations where replication hasn’t been completed, the GPC and GPT
version numbers could be different. In this case, you’d get a warning message that
the GPC and GPT weren’t in sync. The GPC and GPT do not need to be in sync for
Group Policy to be processed.

Examining Group Policy Templates
The Group Policy template (GPT) for a GPO is:
Stored in the SYSVOL.
Replicated through SYSVOL replication.
Used to store files related to the GPO on disk.
Identified with a globally unique identifier (GUID).
You can view the GPT associated with every GPO you’ve created by accessing the
SYSVOL folder on a domain controller. As discussed in “Managing SYSVOL Storage” in
Chapter 6, “Maintaining the SYSVOL,” the default location of the SYSVOL is
%SystemRoot%\Sysvol. Within the domain subfolder of the SYSVOL, you’ll find several
subfolders:
Policies Stores the GPT files for each GPO you’ve created
Scripts Stores shutdown, startup, logon, and logoff scripts used in your GPOs
StarterGPOs Stores the starter GPOs you’ve defined for the domain
Within the Policies folder, each GPT is identified by the GUID of the GPO with which it
is associated, such as {3E60DB37-C145-480F-9050-7c5fa26916b6}. (See Figure 8-6.)
The GPT can contain the following:
Gpt.ini A file that stores the version number of the GPT.
Adm A folder that stores the Administrative template (.adm) files associated with a
GPO. This folder is used only when you create or edit GPOs on computers running
legacy versions of Windows. Otherwise, .adm files are stored locally in the
%SystemRoot%\policydefinitions folder or in the central store.
Machine A folder that stores on-disk files for the Computer Configuration section
of the GPO.
User A folder that stores on-disk files for the User Configuration section of the
GPO.
FIGURE 8-6 Examine the GPT for a GPO.
Within the Machine folder, you’ll find the following:
Applications A folder that stores Application Advertisement Scripts (AAS) files
associated with applications deployed with Group Policy Software Installation under
Computer Configuration.

GptTmpl A file stored in the Microsoft\WindowsNT\SecEdit folder that is used to
stored computer security settings defined under Computer Configuration in the
Windows Settings\Security Settings area of the GPO.
Registry.pol A file that stores the configured registry settings in Computer
Configuration under the Administrative Templates area, as well as settings for
Software Restriction Policies configured under Computer Configuration.
Scripts\Shutdown Stores settings related to shutdown scripts in a file called
Scripts.ini; can also store the actual scripts.
Scripts\Startup Stores settings related to startup scripts in a file called Scripts.ini;
can also store the actual scripts.
Within the User folder, you’ll find the following:
Applications A folder that stores Application Advertisement Scripts (AAS) files
associated with applications deployed with Group Policy Software Installation under
User Configuration.
Fdeploy.ini A file stored in the Documents And Settings folder that is used to
stored folder redirection settings defined under User Configuration.
Microsoft\IEAK A folder that stores custom settings and files related to Internet
Explorer Maintenance settings. Key customization settings are stored in the
Install.ins file. Related bitmap images and imported settings are stored in subfolders
of the Microsoft\IEAK\Branding folder.
Registry.pol A file that stores the configured registry settings in User
Configuration under the Administrative Templates area, as well as settings for
Software Restriction Policies configured under User Configuration.
Scripts\Logoff Stores settings related to logoff scripts in a file called Scripts.ini;
can also store the actual scripts.
Scripts\Logon Stores settings related to logon scripts in a file called Scripts.ini;
can also store the actual scripts.

Understanding GPC and GPT Processing
For a GPO to be processed by a Group Policy client, the GPC and GPT must be present on
the domain controller that authenticated the computer in the domain. The GPC and GPT
do not have to have the same version number. Regardless, if the version number of the
GPC or GPT is different from the version number the client has stored in the registry from
the last time Group Policy was refreshed, the client processes policy because it detects that
a change has occurred.
If the version numbers of the GPC and GPT are not identical, it simply means that changes
were made to one part of the GPO or the other and replication has not been completed. By
default, the GPC and GPT parts of a GPO are written to the PDC emulator in the domain.
The PDC emulator is responsible for replicating the GPC and GPT to other domain
controllers. Because Active Directory replication and SYSVOL replication occur at
different intervals, the GPC and GPT for a policy object can easily become out of sync.
In the Group Policy Management Console, you are connected to the PDC emulator in the
domain by default. As a result, you see and work with Group Policy as it is reflected on
the PDC emulator. You can connect to a different domain controller as discussed in
“Setting Domain Controller Focus Options” in Chapter 3, “Group Policy Management.”
When you change domain controllers, you view and work with Group Policy as it is
reflected on that domain controller. If you edit a GPO, any changes you make are made on
that domain controller, and that domain controller in turn replicates the changes. You can
change the focus when you are editing a GPO. To do this, complete the following steps:
1.                  In the Group Policy Management Editor, select the top-level policy node.
2.                  On the View menu, select DC Options.
3.                  In the Options For Domain Controller Selection dialog box, shown in
Figure 8-7, choose one of the following options and then click OK:
The One With The Operations Master Token For The PDC Emulator Choose
this option to view and edit the GPO as it exists on the PDC emulator.
The One Used By The Active Directory Snap-ins Choose this option to view and
edit the GPO as it exists on the domain controller currently in focus.
Use Any Available Domain Controller Choose this option to view and edit the
GPO as it exists on any available domain controller in the domain.
FIGURE 8-7 Change focus during editing if necessary.

When Group Policy is deployed to client computers, the Group Policy client performs
initial processing and refresh processing as a normal part of its operations. The client is
responsible for requesting policy; policy is never pushed to the client. The client is
responsible for:
Determining whether it is on a slow link.
Discovering all the GPOs that apply to the computer or user.
Discovering which client-side extensions (CSEs) are required.
Applying GPOs and refreshing those GPOs as necessary.
To perform these tasks, the Group Policy client uses the following protocols and ports:
Computers running current versions of Windows use Network Location Awareness
(NLA) to sample TCP traffic between the client and the authenticating domain
controller. This sampling must be enabled for any firewalls between the client and the
authenticating domain controller.
For authentication to Active Directory, clients use remote procedure call (RPC) on
TCP port 135.
For querying Active Directory, clients use Lightweight Directory Access Protocol
(LDAP) on UDP and TCP port 389.
For Domain Name System (DNS) lookups, clients use TCP port 53.
For querying the GPT in the SYSVOL, clients use server message block (SMB) over
IP on UDP and TCP port 445.
If the client cannot connect to the authenticating domain controller on any of these ports,
Group Policy processing will fail. Because of this, it is important to ensure that clients
have appropriate access to their authenticating domain controllers over the network.
The client-side extensions (CSEs) are contained in dynamic-link libraries (DLLs). Once
the client has the CSEs, the client can process them. On computers running legacy
versions of Windows, the Group Policy client runs with the privileges of the Winlogon
process—a system service with the highest level of privileges on the computer. The Group
Policy client runs under the Group Policy Client Service—a system service with reduced
execution privileges. Both clients process each CSE DLL in turn and store information
related to each CSE process in the registry keys under
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions (see
Figure 8-8). CSEs are registered according to their GUID. The order in which the CSE
GUIDs are listed represents the order in which the CSEs were processed. If you select a
CSE GUID, note the following:
(Default) Specifies the exact area of policy to which the CSE relates, such as
Wireless Group Policy.
DllName Specifies the name of the CSE DLL.
EnableAsynchronousProcessing Specifies whether asynchronous processing is
used. 1 indicates it must be asynchronous; 0 indicates it must be synchronous.

FIGURE 8-8 Review CSEs processed by a client.
EventSources Specifies the event sources that can generate related events in the
event logs.
NoBackgroundPolicy Specifies whether the CSE supports background processing.
1 indicates it does not support background processing; 0 indicates it does.
NoGPOListChanges Specifies whether the CSE is processed regardless of
whether related policies have changed. 1 indicates it is not processed regardless of
changes; 0 indicates it is always processed.
NoMachinePolicy Specifies whether the CSE supports per-computer settings. 1
indicates it does support per-computer settings; 0 indicates it does not.
NoSlowLink Specifies whether the CSE is processed over a slow link. 1 indicates
it is not processed over a slow link; 0 indicates it is.
NoUserPolicy Specifies whether the CSE supports per-user settings. 1 indicates it
does support per-computer settings; 0 indicates it does not.
PerUserLocalSettings Specifies whether the CSE caches policies for the user in
the machine section of the Registry. 1 indicates it does cache policies; 0 indicates it
does not.
RequiresSuccessfulRegistry Specifies whether the CSE DLL must be registered
with the operating system. 1 indicates it must be registered; 0 indicates it does not.
Note  If you want to modify settings, you should do so by editing the appropriate
Group Policy objects. Chapter 7 discusses the techniques you can use to configure
most of these settings.


Copying, Importing, and Migrating GPOs
The GPMC features built-in copy and import operations. The copy feature allows you to
copy existing GPOs from one domain to another. The import operation allows you to
create backup copies of GPOs in one domain and import them into another domain.
Because no trust is necessary for the copy and import operations to work, the target
domain for the copy or import operation can be a parent domain, child domain, a domain
in a different tree or forest, or even an external domain for which no trust exists.
However, it is important to note that the copy and import operations work only with the
policy settings within a policy object. These operations don’t copy a policy object’s links
or any Windows Management Instrumentation (WMI) filters that might be associated with
a policy object.
Additionally, if your GPOs reference security principals or contain UNC paths, you may
need to map security principals or UNC paths contained in your GPOs to different values.
This process is handled as a migration.

Copying GPOs
In the GPMC, you can copy a GPO and all its settings in one domain and then navigate to
the domain into which you want to paste the copy of the GPO. The source and target
domains can be any domains to which you can connect in the GPMC and for which you
have permission to manage GPOs. The specific permissions you need are as follows:
In the source domain, you need Read permission to create the copy of the policy
object.
In the target domain, you need Write permission to write the copied policy object.
Administrators have this privilege, as do users who have been delegated permission
to create GPOs.
Additionally, be sure that the destination domain is trusted by the source domain and that
you have GPO Create permissions on the destination domain. You can confirm GPO
Create permissions on a domain by using the GPMC. In the GPMC console tree, expand
Group Policy Objects in the destination domain and then click the Delegation tab to check
which users or groups can create GPOs in the domain.
You can copy a policy object from one domain to another domain to which you have a
connection and permissions by completing the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with,
expand the related Domains node, and then expand the related Group Policy
Objects node.
2.                  Right-click the GPO you want to copy, and then click Copy.
3.                  Access the target domain. Expand the entry for the forest, expand the
related Domains node, and then expand the related Group Policy Objects node.
4.                  Right-click the target domain’s Group Policy Objects node, and then click
Paste.
5.                  If the source and target domains for the copy operation are the same, you’ll
see a dialog box like the one shown in Figure 8-9. Otherwise, the Cross-Domain
Copying Wizard starts. When you click Next, you see a wizard page with similar
options.
FIGURE 8-9 Specify how permissions should be applied.
6.                  Choose to create a copy of the policy object with the default permissions
for the selected domain, or copy the existing permissions to the new policy object.
In most cases, you’ll want to use the default permissions for new GPOs to ensure
that administrators in the target domain can access and work with the copied policy

object.
7.                  Click OK or Next as appropriate. The rest of the wizard pages relate to
migration tables, which allow you to refine the copied settings so that the proper
security principals and UNC paths are used (based on the local environment). For
example, you might need to specify that the permissions for the Managers group
should be migrated to the ManagementTeam group in the new policy object, or you
might need to specify new locations for folder redirection in the new domain.
Note  You’ll find detailed information about migration tables in “Migrating GPOs”
later in this chapter.

Importing GPOs
Copying GPOs between domains works fine when you have connectivity between
domains and the appropriate permissions. If you are an administrator at a remote office or
have been delegated permissions, however, you might not have access to the source
domain to create a copy of a policy object. In this case, another administrator can make a
backup copy of a policy object for you and then send you the related data. When you
receive the data, you can import the backup copy of the policy object into your domain to
create a new policy object with the same settings.
Anyone with the Edit Settings Group Policy management privilege can perform an import
operation. Additionally, you need to have access to the backup GPO files.
To import a backup copy of a policy object into a domain, complete the following steps:
1.                  In the GPMC, expand the entry for the forest you want to work with, and
then expand the related Domains node by double-clicking it.
2.                  Right-click Group Policy Objects, and then click New. In the New GPO
dialog box, type a descriptive name for the new GPO and then click OK.
3.                  Right-click the new GPO, and then click Import Settings. When the Import
Settings Wizard starts, click Next.
4.                  Because the import operation overwrites all the settings of the policy
object you select, you are given the opportunity to back up the policy object before
continuing, as shown in Figure 8-10. If you want to back up the GPO, do the
following and then click Next. Otherwise, simply click Next.
1.               Click Backup. In the Back Up Group Policy Object dialog box, click
Browse.
2.               Use the Browse For Folder dialog box to select a secure save location for
the GPO. Optionally, type a description of the GPO.
3.                Click Backup. When the backup process is complete, click OK to return to
the Import Settings Wizard.

FIGURE 8-10 Back up the policy object you are working with, if necessary.
5.                  Use the options on the Backup Location page to type or browse for the
name of the folder containing the backup copy of the policy object you want to
import. This step is a bit confusing because you were just given the opportunity to
back up the current policy object, but this step relates to the backup folder for the
policy object you want to import. Click Next.
6.                  If there are multiple backups stored in the designated backup folder, you’ll
see a list of them on the Source GPO page, as shown in Figure 8-11. If there are
multiple versions of GPOs and you want to see only the latest version, select the
Show Only The Latest Version Of Each GPO check box.

FIGURE 8-11 Select the GPO backup you want to use.
7.                  Select the GPO you want to use by clicking it. If you want to review the
settings for the GPO, click View Settings. When you are ready to continue, click
Next.
8.                  The Import Settings Wizard scans the GPO for references to security
principals and UNC paths that might need to be migrated. If any are found, you are
given the opportunity to create migration tables or use existing migration tables (as
discussed in “Migrating GPOs.”)
9.                  Continue through the wizard by clicking Next, and then click Finish. This
starts the import process. When the import is complete, click OK.

Migrating GPOs
When copying or importing GPOs from one domain to another, the process is fairly
straightforward, except when your GPOs reference security principals or contain UNC
paths. If your GPOs reference security principals or contain UNC paths, you are given the
opportunity to create migration tables to map the values contained in the source GPO to
different values in the target GPO.
Migration tables help you map:
Permissions on a GPO in the source domain to the required permissions on a GPO in
the target domain. The permissions on a GPO describe which users, computers, and
computer groups will process that GPO and which users or user groups can view and
edit policy settings in the GPO or delete the GPO.
Security principals defined in the source domain to the required security principals in
the target domain. Specifically, policies such as User Rights Assignment, Restricted
Groups, File System, Registry, or System Services allow you to specify particular
users or groups that can access or configure those resources. The security identifiers
(SIDs) for those users and groups are stored in the GPO and must be modified to
reflect the users and groups in the GPO’s new location.
UNC paths defined for software installation, folder redirection, or scripts in the
source domain to the required UNC paths in the target domain. For example, you
might have a GPO that references redirected folders stored on a server in the source
domain. In the target domain, the folders may need to be redirected to a different
server.
When you are working with the Cross-Domain Copying Wizard or the Import Settings
Wizard, you configure migration settings on the Migration References page. You can elect
to transfer references to security principals and UNC paths using the following options:
Copy Them Identically From The Source
Using This Migration Table To Map Them In The Destination GPO
When you select the copy option, the values are copied exactly from the source GPO to
the target GPO. When you select the migration table option, you can:
Click Browse to search for and select an existing migration table. Migration table
files end with the .migtable file extension by default.
Click Edit to edit a migration table you’ve selected in the Migration Table Editor.
Click New to create a migration table in the Migration Table Editor.
In addition to creating migration tables automatically as part of the copy and import
operations, you can also create migration tables in advance and use them in your copy and
import operations. One advantage of creating a migration table in advance is that you can
be sure that the migration settings you define are exactly what you want.
A single migration table can be used for more than one GPO, which means you can use a
single migration table that covers every possible security principal and UNC path
combination for a given migration of GPOs from one domain to another. In that case you
can simply apply the same migration table to every GPO that you are deploying, and those
principals and paths that match will be correctly mapped.

You can create migration tables using the Migration Table Editor (Mtedit.exe). To start
this tool, on the Start screen, type mtedit.exe in the Everywhere Search box, and then
press Enter. As Figure 8-12 shows, the Migration Table Editor starts with a blank
migration table that you can populate manually by typing entries into the grid or populate
automatically by using one of the auto-populate methods.
FIGURE 8-12 Start the Migration Table Editor.
The easiest way to start creating a migration table is to use an auto-populate method from
either a backup GPO or a live production GPO. To populate a migration table from a live
production GPO, complete the following steps:
1.                  On the Tools menu, click Populate From GPO.
2.                  In the Select GPO dialog box, shown in Figure 8-13, use the Look In This
Domain list to select the source domain.
FIGURE 8-13 Select the GPO to scan.
3.                  Use the Group Policy Objects list to select the source GPO. If you want to
include the security principals who have permission on the GPO, as well as security
principals and UNC paths used within the GPO, select the During Scan, Include
Security Principals check box.
Tip  You can select multiple GPOs or multiple backup GPOs when auto-

populating a single migration table. This allows you to use a single migration table
for all GPOs in a domain.
4.                  When you click OK, the Migration Table Editor scans the GPO for
security principals and UNC paths and then lists the related source values, as shown
in Figure 8-14.
Figure 8-14 Map values from the source domain to the target domain.
To auto-populate a migration table from a backup of a GPO, complete the following steps:
1.                  On the Tools menu, click Populate From Backup.
2.                  In the Select Backup dialog box, click Browse. Use the Browse For Folder
dialog box to select the folder containing the backup copy of the policy object you
want to work with.
3.                  If there are multiple backups stored in the designated backup folder, you’ll
see a list of them, as shown in Figure 8-15. If there are multiple versions of GPOs
and you want to see only the latest version, select the Show Only The Latest
Version Of Each GPO check box.
FIGURE 8-15 Select the GPO backup you want to use.

4.                  Use the Backed Up GPOs list to select the source GPO. If you want to
include the security principals who have permission on the GPO, as well as security
principals and UNC paths used within the GPO, select the During Scan, Include
Security Principals check box.
5.                  When you click OK, the Migration Table Editor scans the GPO for
security principals and UNC paths and then lists the related source values, as shown
previously in Figure 8-14.
In the Migration Table Editor, the Source Name column lists the source name of the
security principal or the source UNC path. The Source Type column lists the type of
object. The Destination Name lists the target name of a security principal or the source
UNC path in the target domain.
Table 8-1 lists the different object types that can be mapped. The Free Text or SID object
type is a catch all for security principals that are referenced by name but weren’t resolved
to an actual SID. If you enter user, computer, or group names in the editor, you can use the
Free Text or SID object type so that you don’t have to resolve security principals to their
SIDs. The Migration Table Editor does not support mapping to a built-in security group
such as the built-in Administrators group.
TABLE 8-1 Object Types That Can Be Mapped in the Migration Table Editor
OBJECT TYPE
USED TO MAP
User
Individual user accounts
Domain global group
Domain global groups
Domain local group
Domain local groups
Universal group
Universal groups
Computer
Computer names
UNC path
UNC paths used in policies
Free Text or SID
Undetermined security principal, such as a group name that isn’t resolved to an actual SID
Security principals can be specified by their Universal Principal Name (UPN), Security
Accounts Manager (SAM) name, or Domain Name System (DNS) name. The syntax is:
UPN SecurityPrincipal@UPN suffix, such as WilliamS@imaginedlands.com
SAM NetBIOS domain name\user, such as IMAGINEDL\williams
DNS DNS domain name\user, such as imaginedlands.com\Williams
With computer names, you must include the dollar sign ($) as part of the name:
UPN Computer Name$@UPN suffix, such as CorpServer18$@imaginedlands.com
SAM NetBIOS domain name\computer name$, such as
IMAGINEDL\CorpServer18$
DNS DNS domain name\Computer name$, such as

imaginedlands.com\CorpServer18$
With UNC paths, enter the full path following the syntax:
\servername\sharename
For example:
\FileServer24\data
With the Free Text or SID type, enter a string or the string representation of a SID. For
example, “WilliamS” or “S-1-5-21-4027440173-2312786515-3063062-1108”. However,
SIDs cannot be specified in the destination field.
Tip  When you select Advanced Features on the View menu in Active Directory
Users And Computers, you can view the SID for a security principal. Right-click the
security principal, and then select Properties. In the Properties dialog box, select the
Attribute Editor tab and then scroll down until you see the objectSid attribute.
Modify the Destination Name column for each security principal and UNC path as
appropriate. The default Destination Name value is Same As Source, which means that the
same security principal or UNC path will be used in the destination GPO as the source. In
this case, the value is copied without modification and the mapping accomplishes no
changes. Typically, you will need to change the destination name for one or more source
entries when migrating a GPO. To change the destination field, you can type an entry or
right-click the field and then choose Browse or Set Destination. Choosing Browse allows
you to select a security principal in any trusted domain. If you choose Set Destination, you
can choose one of three options:
No Destination If you specify No Destination, the security principal is not included
in the destination GPO when it is migrated. This option is not available for UNC path
entries.
Map By Relative Name If you specify Map By Relative Name, the security
principal name is assumed to already be in the destination domain, and that name will
be used for the mapping. For example, if the source name is Domain Admins for the
tech.imaginedlands.com domain and you are migrating the GPO to the
eng.imaginedlands.com domain, the name Domain
Admins@tech.imaginedlands.com will be mapped to Domain
Admins@eng.imaginedlands.com. The group must already exist in the destination
domain for the import or copy operation to succeed. This option is not available for
UNC path entries or for security principals that are designated as the Free Text or
SID type.
Same As Source If you specify Same As Source, the same security principal is
used in both the source and destination GPOs. Essentially, the security entry is left as
is.
If you try to map from one group type to another, you will receive a warning. For
example, if you have a source security principal that is a domain global group and you
select a domain local group as the destination, you will be warned that the destination
name is a different type from the source. If you then try to validate the file without making
changes, the validation process will fail. However, you can still use the migration table to
perform a migration.

Before saving a migration table, you should validate it. To do this, on the Tools menu,
click Validate. The validation process:
Determines whether the XML format of the resulting file is valid.
Validates the existence of destination security principals and UNC paths.
Checks that source entries with UNC paths do not have destinations of Map By
Relative Name or No Destination, which are not supported.
Checks that the type of each destination entry in the table matches the type in Active
Directory.
When you enter data manually, the validation process is especially important as a way to
ensure that an entry error does not prevent a successful migration. If you need to delete a
row, click the gray box to the left of the row (this selects the row), right-click, and then
click Delete.
Note  Validation can fail because you do not have the permission to resolve the
security principals or UNC paths specified in the file. This does not mean that the
file will not work as expected during a migration, provided that the user who
performs the migration can resolve the security principal and UNC names.
Keep in mind that a GPO comprises two parts—the GPC, the portion that is stored and
replicates as part of Active Directory, and the GPT, the portion that is stored and replicates
as part of the SYSVOL. Because these are two separate objects that need to replicate
across your network, both need to be synchronized before the new GPO is applied, and it
might take an extended period of time to replicate to all locations in an extended Active
Directory deployment.
In the GPMC, you can view the replication status on a given domain controller. In the
console tree, expand Group Policy Objects in the domain containing the GPOs that you
want to apply, click a GPO you want to check, and then click the Details tab in the details
pane. If the GPO is synchronized on that domain controller for User Configuration, the
Active Directory and SYSVOL version numbers will be identical under User Version. If
the GPO is synchronized on that domain controller for Computer Configuration, the
Active Directory and SYSVOL version numbers will be identical under Computer
Version. However, the user version and computer version numbers do not need to match.
To deploy a new GPO using import and migration operations, complete the following
steps:
1.                  In the GPMC, expand the entry for the forest you want to work with,
expand the related Domains node, and then expand the Group Policy Objects node.
2.                  Right-click the GPO to be updated, and then click Import Settings. When
the Import Settings Wizard starts, click Next.
3.                  On the Backup GPO page, click Backup to back up the existing production
GPO before performing the import. In the Backup Group Policy Object dialog box,
specify the location where the GPO backup is to be stored, type a description for
the backup, and then click Backup. After the GPO backup is complete, a message
states that the backup succeeded. Click OK.
4.                  On the Backup GPO page, click Next.

5.                  On the Backup Location Page, specify the folder that contains the backup
of the GPO that you want to import and then click Next. You must have access to
the folder where you backed up your GPOs. If your backups were completed on a
server in another domain, you might need to map a drive to that folder from the
computer on which you are running the import operation.
6.                  On the Source GPO page, click the GPO that you want to import, and then
click Next.
7.                  On the Scanning Backup page, the wizard scans the policy settings in the
backup to determine references to security principals or UNC paths that need to be
transferred and then displays the results of the scan. Click Next.
8.                  On the Migrating References page, select Using This Migration Table To
Map Them To New Values In The New GPOs, and then specify a path to the
migration table you created for this migration.
9.                  If you want the entire migration to fail if a security principal or UNC path
that exists in the source GPO is not present in the migration table, select Use
Migration Table Exclusively. Use this option to import the GPO only if all security
principals found in the backed-up version are accounted for in the migration table.
10.             Click Next. Confirm that you specified the correct migration options, and
then click Finish. After you click Finish, the migration of the GPO begins. After the
wizard completes the import operation, a message will state that the import was
successful. Click OK.
The import process does not import GPO links or WMI filter settings. Check the links to
the GPO to ensure that it is linked to the appropriate container objects. Check the WMI
Filtering settings to ensure that the GPO is either not applying filters or is applying the
appropriate filters.
In the event that you have a problem with a GPO after you deploy it, the best way to roll
back the deployment is to restore the original GPO by using the backup GPO that you
created.


Backing Up and Restoring GPOs
Just as you back up other types of critical data, you should back up your GPOs. The
GPMC provides separate procedures for backing up production GPOs, starter GPOs, and
WMI filters.
Real World  As discussed in Chapter 4, “Advanced Group Policy Management,”
using change control protects your GPOs in many ways. Change control archives
copies of all your controlled GPOs. If you delete a GPO, the deleted GPO is moved
to a recycle bin from which it can be recovered later. When you are working with a
GPO’s history, you can view unique versions and restore the archived copy of a
GPO to a particular version simply by right-clicking the version to restore and
selecting Deploy. You can also mark unique versions of a GPO so that they cannot
be deleted. To do this, right-click a particular version of a GPO and then click Do
Not Allow Deletion. As extensive as these features are, however, they are still not a
substitute for regular GPO backups.

Backing Up GPOs
Typically, you’ll want to create two types of backups for your GPOs:
GPO backups that are stored on a designated domain controller and then backed up
as part of that computer’s routine system backup
GPO backups that are stored on removable media, such as a DVD, that can be stored
in a lock box and rotated periodically to storage off site
As with any backup process, you should develop a specific backup strategy for GPOs.
Here is an example:
1.                  Designate a domain controller in each domain as the policy backup
computer. In most cases, you will want this computer to be the PDC emulator for
the domain because this is the default domain controller to which the GPMC
connects.
2.                  Before backing up the designated domain controller by using the normal
system backup process, create a backup of your domain’s GPOs. You should create
a new backup periodically (weekly or monthly, in most cases). You should also
create a backup before you change policy settings and again after you’ve finalized
policy.
3.                  You should periodically create media backups of your GPOs. This means
storing the backups on removable media, on DVD, or at another location. You
should have designated secure storage on site and periodically rotate backup sets
off site.
It is also important to note what won’t be backed up with your GPOs:
Your backup will not contain IPSec settings; these are backed up with system state
backups. Because of this, you should track any IPSec settings used so that you can
restore them after you restore your GPOs.
While the locations of domain and OU links are backed up with a GPO, restoring a
backup does not restore those links. This is a safety precaution to ensure that you
don’t inadvertently relink a GPO to a location to which it shouldn’t be linked.
However, as the backup process does record where the GPO was linked within a
domain or OU at the time of the backup, you can use this information to manually
relink the GPO after you restore it. Site links are not listed, however.
Your backup will not contain WMI filters, starter GPOs, or the contents of the
Advanced Group Policy Management (AGPM) archive. You must back up these
items separately from GPO backups.
Using the GPMC, you can back up individual GPOs in a domain or back up all GPOs in a
domain by completing the following steps:
1.                  In the GPMC, navigate to the Group Policy Objects container for the
domain with which you want to work. Do one of the following:
If you want to back up all GPOs in the domain, right-click the Group Policy Objects
node, and then click Back Up All.
If you want to back up a specific GPO in the domain, right-click the GPO, and then

click Back Up.
2.                  In the Back Up Group Policy Object dialog box, shown in Figure 8-16,
click Browse, and then use the Browse For Folder dialog box to set the location in
which the GPO backup should be stored.
FIGURE 8-16 Specify the backup location and description.
3.                  In the Description field, type a description of the contents of the backup.
4.                  Click Back Up to start the backup process.
5.                  The Backup dialog box, shown in Figure 8-17, shows the progress and
status of the backup. Click OK when the backup is complete.

FIGURE 8-17 Review the backup progress.
When doing a full backup, you should be able to back up all GPOs successfully, including
checked out GPOs. If a backup fails, check the permissions on the GPOs and the folder to
which you are writing the backup. You need Read permission on a GPO and Write
permission on the backup folder to create a backup. By default, members of the Domain
Admins and Enterprise Admins groups should have these permissions.

Restoring GPOs
Using the GPMC, you can restore a GPO to the exact state it was in when it was backed
up. The GPMC tracks the backup of each GPO separately, even if you back up all GPOs at
once. Because version information is also tracked according to the backup time stamp and
description, you can restore the last version of each GPO or a particular version of any
GPO.
To restore a GPO, you need Edit Settings, Delete, and Modify Security permissions on the
GPO and Read permission on the folder containing the backup. By default, members of
the Domain Admins and Enterprise Admins groups should have these permissions.
When you restore a GPO, the following occurs:
Except for IPSec settings, all preferences and settings inside the GPO are restored.
The friendly (display) name and GUID are restored.
The security and permissions on the GPO itself are restored.
Any link to a WMI filter is restored.
When you restore a GPO, you do not need to delete the original GPO. The restore
operation simply replaces the original GPO with the backed-up copy of the GPO.
You can restore a GPO by completing the following steps:
1.                  In the GPMC, navigate to the Group Policy Objects container for the
domain with which you want to work.
2.                  Right-click the Group Policy Objects node, and then click Manage
Backups. This displays the Manage Backups dialog box, shown in Figure 8-18.
FIGURE 8-18 Select the backup to restore.

3.                  In the Backup Location field, enter the folder path to the backup or click
Browse to use the Browse For Folder dialog box to find the folder.
4.                  All GPO backups in the designated folder are listed under Backup Policy
objects. To show only the latest version of the GPOs according to the time stamp,
select Show Only The Latest Version Of Each GPO.
5.                  Select the GPO you want to restore. If you want to confirm its settings,
click View Settings, and then verify that the settings are as expected by using
Windows Internet Explorer.
6.                  When you are ready to continue, click Restore. Confirm that you want to
restore the selected GPO by clicking OK. The Restore dialog box, shown in Figure
8-19, shows the progress and status of the restore operation.
FIGURE 8-19 Track the restore status.
7.                  In the Restore dialog box, click OK when the restore is complete, and then
restore additional policy objects as necessary or click Close to close the Manage
Backups dialog box.
If a restore fails, check the permissions on the GPO and the folder from which you are
reading the backup. To restore a GPO, you need Edit Settings, Delete, and Modify
Security permissions on the GPO and Read permission on the folder containing the
backup.
The locations of a GPO’s links are backed up with the GPO. However, a restore of a
backup will not restore GPO links. As a result, you must manually verify GPO links and
create or remove links as appropriate. To see where a GPO had links when it was backed
up, complete the following steps:
1.                  In the GPMC, navigate to the Group Policy Objects container for the
domain with which you want to work.

2.                  Right-click the Group Policy Objects node, and then click Manage
Backups.
3.                  In the Manage Backups dialog box, select the backup of the GPO you want
to examine and then click View Settings.
4.                  A summary report of the GPO’s settings is then displayed in Internet
Explorer. Click the Links heading to display a list of domain and OU links the GPO
had when it was backed up. Site links are not listed, however.

Backing Up and Restoring Starter GPOs
The backup and restore processes for starter GPOs are separate from the backup and
restore processes for production GPOs. To back up starter GPOs, complete the following
steps:
1.                  In the GPMC, navigate to the Starter Objects container for the domain
with which you want to work. Do one of the following:
•If you want to back up all starter GPOs in the domain, right-click the Starter GPOs
node, and then click Back Up All.
•If you want to back up a specific starter GPO in the domain, right-click the GPO,
and then click Back Up.
2.                  In the Back Up Group Policy Object dialog box, click Browse, and then
use the Browse For Folder dialog box to set the location in which the starter GPO
backup should be stored. Optionally, in the Description field, enter a description of
the contents of the backup.
3.                  Click Back Up to start the backup process. Click OK when the backup is
complete.
To restore a starter GPO, complete the following steps:
1.                  In the GPMC, navigate to the Starter Objects container for the domain
with which you want to work.
2.                  Right-click the Starter GPOs node, and then click Manage Backups. This
displays the Manage Backups dialog box.
3.                  In the Backup Location field, enter the folder path to the backup or click
Browse to use the Browse For Folder dialog box to find the folder.
4.                  All starter GPO backups in the designated folder are listed under Backed
Up Starter GPOs. To show only the latest version of the starter GPOs according to
the time stamp, select Show Only The Latest Version Of Each Starter GPO.
5.                  Select the starter GPO you want to restore. If you want to confirm its
settings, click View Settings, and then verify that the settings are as expected by
using Internet Explorer.
6.                  When you are ready to continue, click Restore. Confirm that you want to
restore the selected starter GPO by clicking OK.
7.                  In the Restore dialog box, click OK when the restore operation is
complete. Restore additional starter GPOs as necessary, or click Close to close the
Manage Backups dialog box.

Backing Up and Restoring WMI Filters
The backup and restore processes for WMI filters are separate from the backup and restore
processes for production GPOs. In the GPMC, you can only back up and restore WMI
filters one at a time. WMI filter links are not restored when you restore a WMI filter. See
“Applying or Removing a WMI Filter” in Chapter 5, “Searching and Filtering Group
Policy,” for details about linking WMI filters to GPOs.
Tip  The LDIF Directory Exchange utility (LDIFDE.exe) is available on Windows
Server when you install the Remote Server Administration Tools. You can use
LDIFDE.exe to back up and restore multiple WMI filters at one time. For more
information, see http://go.microsoft.com/fwlink/?linkid=109519 .
To back up a WMI filter, complete the following steps:
1.                  In the GPMC, navigate to the WMI Filters container for the domain with
which you want to work.
2.                  Right-click the WMI filter you want to back up, and then select Export.
Use the Export WMI Filter dialog box to select the save location for the filter and set
the backup file name. WMI filters are saved as .MOF files.
3.                  Click Save.
When you export a WMI filter to a .MOF file, you can import the filter to the same
domain or to any other domain to which you have access. To restore a WMI filter,
complete the following steps:
1.                  In the GPMC, navigate to the WMI Filters container for the domain with
which you want to work.
2.                  Right-click the WMI Filter node, and then click Import.
3.                  Use the Import WMI Filter dialog box to select the .MOF file in which you
saved the filter.
4.                  Click Open. In the Import WMI Filter dialog box, review the name,
description, and queries associated with the filter. This dialog box is identical to the
New WMI Filter and Edit WMI Filter dialog boxes discussed in “Managing WMI
Filters” in Chapter 5.
5.                  The import can succeed only if a WMI filter with the name you set on the
filter does not exist in the domain. Therefore, if a WMI filter with the current name
already exists in the domain, you need to rename this filter.
6.                  Because the backup process might modify the queries contained in the
filter, you should review the queries to ensure that no extra characters or unwanted
changes have been made. After you’ve made any necessary changes, click Import.

Backing Up and Restoring the AGPM Archive
Each AGPM server you’ve deployed maintains an archive of controlled GPOs. The
archive stores old versions of the GPOs as well as versions of deleted GPOs that are stored
in the recycle bin. If you examine the archive folder, you’ll see that it contains a number
of directories and files.
As part of your backup routine, you should create a backup of the archive folder. You can
do this simply by copying the entire folder to another location. If you ever need to restore
the AGPM archive, whether on a new server or the original server, you can restore the
archive by completing the following steps:
1.                  Using the Services utility, stop the AGPM Service.
2.                  Using File Explorer, copy the contents of the backup folder to the archive
folder the server is using with AGPM.
3.                  Using the Services utility, start the AGPM Service.
Note  The account under which the AGPM Service runs must own the AGPM archive.
If you configured a new AGPM server, ensure that the current log-on-as account has full
control over the AGPM archive files.
Real World  When you restore the AGPM archive on a new server and you’ve
configured e-mail notification for AGPM, you’ll also need to reset the password for any
mail-enabled user account you are using for notification. The account password is stored
within the archive in an encrypted format. The encryption protecting the password causes
the password to fail if the archive is moved to another computer. You can resolve this by
using the GPMC. In the GPMC, select the Change Control node in the domain in which
you want to manage GPOs. In the details pane, select the Domain Delegation node.
Under Send Approval Requests, confirm the user information provided. Reenter and
reconfirm the password for the user account, and then click Apply.

Recovering the Default GPOs
As discussed in “Using Default Policies” in Chapter 2, “Deploying Group Policy,” two
GPOs are created by default when you create a new domain:
Default Domain Controllers Policy GPO
Default Domain Policy GPO
Because the default GPOs are essential to the proper operation and processing of Group
Policy, you must ensure that these GPOs are available and can be processed. Before
making any changes to the default GPOs, be sure to back up the GPOs by using the
GPMC. If a problem occurs with the changes to the default GPOs and you cannot restore
them from backup, you can use the Dcgpofix.exe tool to re-create the default policies in
their initial state. Alternatively, if you are using AGPM and are controlling the default
GPOs, a record will be maintained of any changes that you’ve made to the default GPOs,
and you can revert to a previous state or the initial state.
Dcgpofix.exe is included with Windows Server and is located in the
%SystemRoot%\System32 folder. By default, Dcgpofix restores both the Default Domain
Policy and Default Domain Controller Policy GPOs. This means that you will lose most
changes made to these GPOs as a result of the restore process.
Note  The only exceptions are settings for Remote Installation Services (RIS),
Security Settings, and Encrypting File System (EFS), which are maintained
separately and not affected by the restore operation. Nondefault security settings are
not maintained, however, such as security settings configured by Microsoft
Exchange, security settings configured as a result of a migration from legacy
Windows, and security settings configured through Systems Management Server
(SMS).
Although Dcgpofix.exe restores the policy settings that are contained in the default GPOs
at the time they are generated, it does not restore other GPOs that you’ve created.
Dcgpofix.exe is only intended for disaster recovery of the default GPOs.
The syntax for Dcgpofix.exe is as follows:
dcgpofix [/ignoreschema] [/Target: Domain | DC | BOTH]
The options for Dcgpofix.exe are as follows:
/ignoreschema By default, Dcgpofix.exe checks the Active Directory schema
version number to ensure compatibility between the version of Dcgpofix you are
using and the Active Directory schema configuration. If the versions are not
compatible, Dcgpofix.exe does not run. To allow it to work when schema versions
are different, you must bypass the automatic schema check by using this option.
/target: DOMAIN Specifies that the Default Domain Policy should be re-created.
/target: DC Specifies that the Default Domain Controllers Policy should be re-
created.
/target: BOTH Specifies that both the Default Domain Policy and the Default
Domain Controllers Policy should be re-created.
Only Domain Admins or Enterprise Admins can run Dcgpofix. To restore the Default

Domain Policy and Default Domain Controller Policy GPOs, log on to a domain
controller in the domain in which you want to fix default Group Policy. Enter dcgpofix at
the command prompt.
You can also restore only the Default Domain Policy or only the Default Domain
Controller Policy GPO. To restore only the Default Domain Policy, enter dcgpofix
/target: domain. To restore only the Default Domain Controller Policy, enter dcgpofix
/target: dc.


Troubleshooting Group Policy
Throughout this book, I’ve discussed many different techniques you can use for
diagnosing and resolving problems with Group Policy:
Chapter 3 examines techniques you can use to manage GPOs and delegate privileges
for policy management.
Chapter 4 examines techniques you can use to manage workflow, manage previous
versions of GPOs, and recover GPOs both from history and from the AGPM recycle
bin.
Chapter 5 examines techniques you can use to search GPOs, apply security group
filters, and use WMI filters.
Chapter 6 examines techniques you can use to maintain the SYSOVL, generate
diagnostics reports for replication, and troubleshoot replication issues.
Chapter 7 examines ways you can modify policy processing, test implementation
scenarios, and determine effective settings.
Appendix A, “Installing Group Policy Tools,” discusses techniques for installing
Group Policy tools.
In this section, I’ll provide some additional tips and techniques for troubleshooting Group
Policy.

Diagnosing Group Policy: The Basics
At a very basic level, Group Policy works like this:
1.                  A Group Policy client discovers through an Active Directory lookup that
policy objects apply to it. Active Directory tells the client where in the SYSVOL it
can find the policy file associated with the object referenced in Active Directory.
2.                  The client uses a Server Message Block (SMB) call to read the policy file
from the SYSVOL on a domain controller.
3.                  The client reads any necessary settings from those policy files by using
client-side extensions (CSEs) that process those settings.
4.                  The client applies the settings.
As you can see, the Group Policy client does all the work. The domain controller doesn’t
do any processing.
Whenever there are changes to Active Directory or the Windows operating system, there
are questions about how to get the latest features and extensions. Technically, however,
Group Policy isn’t bound by the Active Directory version or the operating system version.
What determines changes to policy are new policy extensions and new administrative
tools.
Sometimes new settings within Group Policy require schema updates to enable them to
work. For example, policy settings related to BitLocker Drive Encryption require schema
extensions to work. More typically, to take advantage of the latest and greatest features of
Group Policy, you simply need to edit your GPOs from a management computer running
the latest version of Windows. Editing a GPO on the latest version of Windows with the
latest version of the administrative tools ensures that new templates are applied to the
GPO and that new settings are available.
Note  The template format has nothing to do with the policy file that’s created—
it’s just used to create the policy by the administrative tool itself. Originally, the
Group Policy editors used the ADM file format, and these ADM files were copied
into every policy object on the SYSVOL. Current releases of Windows and
Windows Server use the ADMX template format, which is an XML-based format.
ADMX files aren’t copied into every policy object and instead rely on a central or
local store.

Common Problems with Group Policy
Many problems with Group Policy result from the way policy is inherited and processed.
When trying to determine why policy hasn’t been processed on a computer or for a user, it
is important to keep in mind how policy is processed and applied. As discussed in Chapter
7, a variety of techniques can be used to modify the way inheritance works and policy is
processed, and these modifications can lead to unanticipated results when Group Policy is
applied.
If a GPO isn’t being processed when you think it should, ensure that the GPO is:
Linked A GPO must be linked to the appropriate site, domain, or OU to be
processed. See “Creating and Linking GPOs” in Chapter 3.
Enabled A GPO must be enabled to be processed. In cases where you’ve disabled
Computer Configuration settings, only User Configuration settings are processed and
only user settings are applied. In cases where you’ve disabled User Configuration,
only Computer Configuration settings are processed and only computer settings are
applied. See “Modifying GPO Processing” in Chapter 7.
Applicable A GPO must be configured with the appropriate permissions, filters,
and targeting for it to be applicable. If a GPO is filtered out because of permissions or
WMI filters, it doesn’t apply. See “Using Security Group Filters” and “Using WMI
Filters” in Chapter 5. If a computer or user falls outside the targeting parameters,
Group Policy preferences won’t apply. See “Using Item-level Targeting” in Chapter
3.
If policy isn’t being applied as you expect, you should examine the network configuration
of the client computer and ensure that the Local Area Connection settings for Internet
Protocol (IP) are configured with the correct:
IP address configuration
Subnet mask
Default gateway
DNS server addresses
At a command prompt, you can quickly check the IP configuration by entering ipconfig
/all. In your troubleshooting, don’t overlook the importance of the event logs. Your
troubleshooting should start with the event logs. In the System log, you’ll find general
policy events logged with the source as GroupPolicy. If policy was successfully processed
for the computer, you’ll see event ID 1502. If policy was successfully processed for the
user, you’ll see event ID 1503. If there are any processing problems, you’ll see related
errors, such as error code 1129, stating that processing of Group Policy failed because of
the lack of network connectivity to a domain controller. To get more information about an
error code, you can search Microsoft TechNet (http://technet.microsoft.com/).
Error 1129 can tell you right away that the computer has an IP configuration problem or
that the computer’s network cable isn’t connected properly.
The Group Policy Operational log provides in-depth tracking of Group Policy processing
events. To access this log, complete the following steps:
1.                  Open Event Viewer by clicking the Tools menu in Server Manager, and

then clicking Event Viewer.
2.                  In Event Viewer, expand the Applications And Services Log node. Work
your way to the Group Policy Operational log by expanding the Microsoft,
Windows, and GroupPolicy nodes.
3.                  When you select Operational in the console tree, all the related events are
displayed in the details pane.
4.                  Click the Level column heading to sort events by level. You can then
quickly see if there are any error and warning events, as shown in Figure 8-20.
Figure 8-20 View the Group Policy Operational log.
Don’t forget the foreground and background processing rules. Keep the following in mind:
Sometimes you might need to force the computer or user profile to process policy
updates, and you can use Gpupdate to do this, as discussed in “Refreshing Group
Policy Manually” in Chapter 7. With forced updates, keep in mind that sometimes the
first forced update of Group Policy might not work and you might need to run
Gpupdate -force a second time. Why? If a computer is connected over a slow link,
some client-side extensions are not processed, and it may take several forced updates
to get the computer to refresh policy.
If you move a computer to a new location in the directory or on the physical network,
you might also need to restart the computer to ensure that the computer processes the
correct GPOs.
Some policies are applied only after the second logon, not after the first logon. This
occurs because anything that is set to run synchronously won’t run until after the
second logon. As a result, sometimes a user may need to log off and log on several
times to ensure that policy is fully processed. Or you may need to enable the Always
Wait For The Network At Computer Startup And Logon Policy setting as discussed
in “Policy Processing and Refresh Exceptions” in Chapter 7.
Partially disabling a GPO, using loopback processing, and linking WMI filters can
change the way Group Policy is processed. Always check to see how related settings
are being applied.

Something as simple as the client computer not having the correct time can also cause
policy processing to fail. Why? Kerberos version 5 is the default authentication
mechanism for computers running Windows. Kerberos v5 checks the time stamp on
authentication messages. If the time on the client and the time on the server are more than
5 minutes apart, authentication will fail. To prevent this from happening, you should
configure Windows Time Service in the domain as discussed in “Configuring the
Windows Time Service” in Chapter 9, “Maintaining and Recovering Active Directory,” in
Active Directory Administrator’s Pocket Consultant.
Best Practice  Sometimes older settings that were designed for earlier versions of
Windows can have unpredictable effects when you also set related policies that
apply only to newer versions of Windows. Consider the following scenario: In a
GPO that applies to both users and computers, you configure firewall, IPSec,
wireless networking, or auditing settings for Windows Server 2008. In the same
GPO, you also configure newer policy settings for one or more of these
administrative areas using policies that apply to Windows 8.1 and Windows Server
2012. When Group Policy is applied to computers running Windows 8.1 and
Windows Server 2012, the overlap between the older policy settings and the newer
policy settings can cause unpredictable results, making it difficult to diagnose and
resolve related problems. The best practice here is to make sure that you separate
older and newer policy settings that overlap. To resolve this, you could separate
computers into different organizational units. Alternatively, you could use access
control lists with groups or WMI filters. In Chapter 5, see “Using Security Group
Filters“ and “Using WMI Filters“ for more information on access control lists and
WMI.

Diagnosing Group Policy Issues
Group Policy is refreshed automatically at a specific interval. On domain controllers,
Group Policy is refreshed every 5 minutes by default. On member servers and
workstations, Group Policy is refreshed every 90 to 120 minutes by default. You can
refresh Group Policy manually using Gpupdate, as discussed in “Refreshing Group Policy
Manually” in Chapter 7.
When you are trying to determine why policy is not being applied as expected, you should
check for common problems, as discussed previously, and then examine the Resultant Set
of Policy (RSoP) for the user or computer, or both, experiencing problems with Group
Policy. If you run the Group Policy Results Wizard first and then run the Group Policy
Modeling Wizard, you can view how settings are applied currently as well as how settings
should be applied based on the container in which a user, computer, or both are located.
You can compare the settings between the planning and logging modes to check for
discrepancies between how you think policy is being applied and how it is actually being
applied. For detailed information on using these wizards, see “Planning Group Policy
Changes” in Chapter 7.
Using the Gpresult command-line utility, you can view the Resultant Set of Policy as well.
Gpresult provides details on:
The last time Group Policy was applied
The domain controller from which policy was applied
The complete list of applied GPOs
The complete list of GPOs not applied because of filters
The security group memberships for the computer and user
Details on special settings applied for folder redirection, software installation, disk
quota, IPSec, and scripts
The basic syntax for Gpresult is:
gpresult /s ComputerName /user Domain\UserName
where ComputerName is the name of the remote computer for which you want to log
policy results, and Domain\UserName indicates the remote user for which you want to log
policy results. For example, to view the RSoP for corp-pc28 and the user wrstanek in the
ImaginedL domain, you would enter the following command:
gpresult /s corp-pc28 /user imaginedl\wrstanek
You can view more detailed output using one of the two verbose options. The /v option
turns on verbose output, and results are displayed only for policy settings in effect. The /z
option turns on verbose output for policy settings in effect and all other GPOs that have
the policy set.
Because Gpresult output can be fairly long, you should direct the output to a file, as shown
in this example:
gpresult /s corp-pc28 /user imaginedl\wrstanek /z > rsopsave.log
Under Computer Configuration, in the Administrative Templates\System\Group
Policy\Logging And Tracing folder, you’ll find a set of policies for configuring logging

and tracing of Group Policy preferences processing (see Figure 8-21).
FIGURE 8-21 Configure policy to log and trace preferences.
You can configure logging and tracing separately for each major area within Group Policy
preferences by completing the following steps:
1.                  In the Group Policy Management Editor, double-click the policy
processing area to log, trace, or both.
2.                  In the Properties dialog box, shown in Figure 8-22, select Enabled to
enable the policy.
3.                  Use the Event Logging list to set the type of events to log. The options
include:
Informational, Warnings, and Errors
Warnings and Errors
Errors Only
None
4.                  On the Tracing list, select On to turn on debug tracing, or select Off to turn
off debug tracing. By default, trace data is written to the
%CommonAppData%\GroupPolicy\Preference\Trace folder. User trace data is
written to User.log. Computer trace data is written to Computer.log. Planning trace
data is written to Planning.log.

FIGURE 8-22 Enable logging and tracing.
5.                  If you enabled tracing, use the Maximum Size Of Trace File combo box to
set the maximum size of individual trace files. The default maximum size is 1,024
kilobytes.
6.                  Click OK to apply the setting. Repeat this process as necessary for other
preference areas.
When you are done logging and tracing, you should edit the Enabled policy settings and
set them to Not Configured or Disabled to stop logging and tracing.

Restoring the Default Policy GPOs
If the Default Domain Policy or Default Domain Controller Policy GPO becomes
corrupted, Group Policy will not function properly. You can resolve this problem by using
Dcgpofix to restore the default GPOs to their original default state. For more information,
see “Recovering the Default GPOs” earlier in the chapter.


Appendix A. Installing Group Policy Tools
Group Policy is one of the most rapidly changing areas of Windows administration. To
help you keep pace with the changes, I’ve included in this appendix details for installing
important Group Policy tools. By reading this appendix, you’ll learn how to:
Install the Remote Server Administration Tools.
Install the client and server components for Advanced Group Policy Management
(AGPM).
Install Group Policy templates and add-ins for Microsoft Office.


Installing the Remote Server Administration Tools
The Microsoft Remote Server Administration Tools (RSAT) are a collection of tools for
remotely managing the roles and features in Windows Server from a computer running a
compatible operating system. RSAT supports remote management of Windows Server
regardless of whether the server is running a Server Core installation or a Full Server
installation.
RSAT is available in a 32-bit edition and a 64-bit edition for specific versions of
Windows, such as for Windows 8.1. If your computer is running a 32-bit edition of
Windows, you must install the 32-bit edition of RSAT. If your computer is running a 64-
bit edition of Windows, you must install the 64-bit edition of RSAT. You can use the tools
designed for either architecture to remotely manage 64-bit Windows Server 2012 and
Windows Server 2012 R2 servers.
The installer package for the remote administration tools is provided as an update.
Microsoft assigns the installer package an identification number in the Microsoft
Knowledge Base. Be sure to write down this number. If you need to uninstall or reinstall
the installer package, this number will help you locate the update you need to uninstall or
reinstall.

Configuring and Selecting Remote Server Administration Tools
You can obtain and register the installer package for use by completing the following
steps:
1.                  Obtain the version of the Microsoft Remote Server Administration Tools
that is compatible with the operating system, architecture and service pack used on
your computer. You can obtain the latest version of the tools by visiting the
Microsoft Download Center ( http://download.microsoft.com/ ) and searching for
all downloads containing the keywords Microsoft Remote Server Administration
Tools . After you download the executable, double-click the executable to start the
installation.
2.                  If you’ve saved this file to a location on your computer or a network share,
you can begin the installation process by accessing the file location in File Explorer
and double-clicking the installer file.
3.                  When prompted to confirm the installation, click OK. When you are
prompted, read the license terms. If you accept the terms, click I Accept to
continue. The installer will then install the tools as an update.
4.                  When the installer completes the installation of the tools, click Close.
Although the installer may not state so explicitly, you may need to restart your
computer to finalize the installation.
Installing the package ensures that the remote administration tools are available for
selection. After RSAT has been installed, you can configure and select the remote server
administration tools that you want to use by completing the following steps:
1.                  In Control Panel, click Programs. Under Programs And Features, click
Turn Windows Features On Or Off.
2.                  In the Windows Features dialog box, expand Remote Server
Administration Tools.
3.                  Using the options under the Feature Administration Tools and Role
Administration Tools nodes, select the remote administration tools that you want to
install and then click OK. For example, to install the Group Policy Management
Console and related features, select Group Policy Management.
Windows automatically configures the selected tools for use. At the command line, you’ll
be able to use any command-line tool that Windows has made available. The graphical
versions of the tools are available on the Tools menu in Server Manager.

Removing the Remote Server Administration Tools
You can remove remote server administration tools that you no longer want to use by
completing the following steps:
1.                  In Control Panel, click Programs. Under Programs And Features, click
Turn Windows Features On Or Off.
2.                  In the Windows Features dialog box, expand Remote Server
Administration Tools.
3.                  Using the options under the Feature Administration Tools and Role
Administration Tools nodes, clear the check boxes for any remote server
administration tool that you want to remove, and then click OK.
If you no longer use a computer for remote administration and want to remove the remote
administration tools completely, you can remove the entire installer package by
completing the following steps:
1.                  In Control Panel, click Programs. Under Programs And Features, click
View Installed Updates.
2.                  Click the update you used to install the remote administration tools, and
then click Uninstall.
3.                  When prompted to confirm, click Yes.


Installing Advanced Group Policy Management
Advanced Group Policy Management (AGPM) is a set of extensions for the Group Policy
Management Console that includes advanced features that allow you to:
Archive and edit GPOs offline.
Delegate different levels of permissions for Group Policy administrators.
Perform change management of GPOs by using check-in and check-out capabilities.
Track workflow and perform reporting on GPOs.
Roll back and roll forward changes to archived GPOs.
Maintain a recycle bin of deleted GPOs and recover GPOs and GPO links from this
recycle bin.
Note  At the time of this writing, AGPM is only available through the Microsoft
Desktop Optimization Pack (MDOP) for Software Assurance, which also includes
Microsoft Application Virtualization, Diagnostics, and Recovery Toolset; Asset
Inventory Service; and System Center Desktop Error Monitoring. Because the
Microsoft Desktop Optimization Pack for Software Assurance is available only to
organizations that have an enterprise license with Microsoft that includes Software
Assurance, your organization would need to have this type of enterprise license
agreement. Generally, this type of license applies to organizations with at least 50
desktop computers.
AGPM uses a client/server architecture. The server component is used to archive GPOs
for offline use, to control GPOs for change management, and to store related history data.
The client component extends the GPMC so that it includes the additional features
provided in AGPM. When AGPM is added, the only immediate difference you’ll notice in
the GPMC’s user interface is a Change Control node under each domain node.
If you plan to deploy AGPM, keep in mind that Microsoft has released several versions of
the Microsoft Desktop Optimization Pack for Software Assurance. You’ll want to use at
least the 2014 version. Microsoft Desktop Optimization Pack 2014 allows you to use:
AGPM 4.0  AGPM 4.0 runs on Windows Vista Service Pack 1, Windows 7,
Windows Server 2008 and Windows Server 2008 R2. Both 32-bit and 64-bit
installations are available.
AGPM 4.0SP1  Adds support for Windows 8 and Windows Server 2012.
AGPM 4.0SP2  Adds support for Windows 8.1 and Windows Server 2012 R2.
Tip  You should run the AGPM client and AGPM server on the same operating
system line. For example, if you’ve deployed Windows 8.1 and Windows Server
2012 R2, the client should run on Windows 8.1 and the server on Windows Server
2012 R2. If you run the client on an earlier release, you won’t be able to edit policy
settings or preferences that exist only on the later release. Thus, if you are using
Windows 8.1 and Windows Server 2012 R2, you should deploy AGPM 4.0 SP2.
AGPM 3.0 and later have the following enhancements over early AGPM releases:
Customizable permissions  Allow you to configure custom permissions for each
domain. The permissions you configure for a GPO on the Production Delegation tab

replace any permissions already on the GPO when it is controlled or deployed from
the AGPM server. Once a GPO is under AGPM control, changes to permissions from
outside AGPM are prevented.
More robust change tracking  Change tracking has been enhanced to track
additional types of changes made to GPOs, such as when a request was made and
who made it, when a request was approved or rejected and who approved or rejected
the request, when changes to AGPM delegation were made and who made them, and
so on.
Purging of historical data  Allows you to purge old data by specifying how many
historical versions of GPOs to retain. Purging old data deletes the data from the
archive, so this data is no longer accessible. As part of enhanced change tracking, the
information about the change to the purge time is retained in the history and an entry
is recorded in the history that data was purged.
Support extensions  Adds support for Group Policy preferences, an enhanced user
interface (UI) with clearer descriptions and localization in ​additional languages.
A key feature added with AGPM 4.0 is the ability to export and import GPOs to different
forests. AGPM 4.0 SP1 is updated to support the additional client-side extensions in
Windows 8 and Windows Server 2012 and also adds support for: Central Access Policy,
DNS security, DirectAccess on DNS client computers, Internet Explorer 10, default
connection URLs for remote connections, Windows To Go Startup options and Windows
To Go Hibernate options.
AGPM 4.0 SP2 is updated to support the additional client-side extensions in Windows 8.1
and Windows Server 2012 R2 and also adds support for: specifying Work Folder settings,
auto provision synchronization, and forcing automatic setup for all users.
Because AGPM 4.0 has feature enhancements, I recommend that you use this version or a
later version. If you are already using AGPM 3.0, you can upgrade to AGPM 4.0 and then
upgrade AGPM 4.0 to AGPM SP1 or AGPM SP2.
Features in AGPM 4.0 and later versions are what I discuss in this book. GPMC must be
installed as part of the Remote Server Administration Tools.
The sections that follow detail how you can install client and server components for
AGPM.

Performing a Server Installation of AGPM
Performing a server installation of AGPM installs the AGPM Service on the server and
establishes the GPO archive. The AGPM Service enables offline editing by copying GPOs
from a domain controller in the current domain and storing them in the AGPM archive.
The AGPM Service allows you to apply updates to GPOs by copying updated GPOs back
to a domain controller in the current domain.
During installation, you need to select a folder to be used for archive storage. The AGPM
server stores GPO archives, deleted GPOs, and related history information in this folder.
Although the permissions on this folder are used to control the tasks individual
administrators can perform with respect to AGPM-managed GPOs, you shouldn’t edit the
permissions directly. Instead, use the extensions provided by AGPM in the GPMC to
delegate permissions.
Before you install an AGPM server in a domain, you’ll want to:
Select a computer to act as the AGPM server. Generally, this computer should be a
member of the domain and should not be a domain controller.
Create a domain user account for the AGPM Service. The account should not be the
Administrator account. This account should be a member of the Group Policy
Creator Owners group or be delegated permission to create GPOs in the domain.
When you create a new controlled GPO by using the AGPM extensions, the AGPM
Service account is delegated permission to manage the GPO (specifically, the account
is granted the edit settings, delete, and modify security permissions). To be sure that
you can work with GPOs created prior to installing AGPM, check that the AGPM
Service account is either a member of a group with similar permissions or that you
delegate these permissions manually as discussed in “Delegating Control for
Working with GPOs” in Chapter 3, “Group Policy Management.”
Create a group account that will be the initial owner of the AGPM archive. Members
of this group will be used to set up AGPM delegation and will have full control over
all AGPM functions.
Note  Whether you are working with AGPM 3.0, 4.0, 4.0 SP1 or 4.0 SP2, the
AGPM server component requires the Microsoft .NET Framework 3.5. If this
version of the framework isn’t installed already, you’ll need to install it. Visit the
Microsoft Download Center ( http://download.microsoft.com/ ) and search for
“.NET Framework 3.5.”
You’ll want to be sure that the server has adequate free space on the disk used for archive
storage. When determining the size requirements, keep the following in mind: GPOs that
store Administrative templates can grow to be several megabytes (MB) in size; GPOs that
do not store Administrative templates typically are only a few kilobytes in size.
Additionally, when you use change tracking, multiple versions of GPOs may be stored in
the archive.
Real World  As discussed in “Keeping Group Policy Up to Date” in Chapter 2,
some settings for Group Policy objects are defined in a set of files called
Administrative templates. Administrative templates can use the original ADM
format or the newer ADMX format. With ADM, the description of settings and the

values for settings are stored in the template files, and these files are in turn stored in
each GPO you create.
When ADMX is used with a central store, the description of settings and the values for
settings are stored separately. Setting descriptions are defined using language-neutral files
ending with the .admx file extension and language-specific files ending with the .adml
extension. These files are not stored in individual GPOs. Instead, they are stored in the
SYSVOL, and only the actual settings in use are stored in GPOs. Because only in-use
settings are stored, these GPOs are significantly smaller than their counterparts that use
ADM.
Therefore, if a domain has 100 GPOs that are 4 MB each, you’ll need 400 MB of storage
initially and several gigabytes of storage to store multiple versions of each GPO. On the
other hand, if a domain has 100 GPOs that are 4 kilobytes (KB) each, you’ll need 400 KB
of storage initially and only several megabytes of storage to store multiple versions of
each GPO.
The general steps to install the AGPM server vary slightly depending on the version you
are installing. To install the AGPM server on the computer that will host the AGPM
Service, follow these general steps:
1.                  Access the computer with an account that is a member of the Domain
Admins group.
2.                  Insert or mount the Microsoft Desktop Optimization Pack 2014 DVD. If
Autorun is enabled, the splash screen is displayed. Otherwise, double-click
Launcher.exe in the Launcher folder on the DVD.
3.                  On the splash screen, click the Advanced Group Policy Management
option.
4.                  On the Advanced Group Policy Management page, you’ll see installation
options for the available versions of AGPM. On Windows 8.1 and Windows Server
2012 or Windows Server 2012 R2, you’ll want to install AGPM 4.0 or later. Click
Install Server (32-bit) or Install Server (64-bit) as appropriate for the bitness of the
operating system.
Best Practice  Although you can install the AGPM server on a computer running a
Windows desktop operating system, you should be sure that you understand the
limitations involved when you do so. Client versions of Windows are not designed
to act as servers and can handle only a limited number of network connections.
Therefore, you should install the AGPM server on a client version of Windows only
in small network environments, such as those used for testing and development. To
ensure good performance in an enterprise production environment, install the
AGPM server on a computer running Windows Server 2012 or Windows Server
2012 R2.
5.                  When the Microsoft Advanced Group Policy Management—Server Setup
Wizard starts, click Next.
6.                  On the Microsoft Software License Terms page, review the license terms.
Select I Accept The License Terms check box, and then click Next.

7.                  On the Application Path page, shown in Figure A-1, select a location in
which to install application components for the AGPM server. The default path is
%SystemRoot%\Program Files\Microsoft\AGPM\Server. Click Next.
Figure A-1  Specify an application path for the server components.
8.                  On the Archive Path page, shown in Figure A-2, select a location for the
AGPM archive. The default location is %SystemRoot%\ProgramData\​-
Microsoft\AGPM. Although the archive folder can be on the AGPM server or a
network share, you should select a location with sufficient space to store all GPOs
and history data managed by this AGPM server. Click Next.
Figure A-2  Specify an archive path for GPO archives.

9.                  On the AGPM Service Account page, shown in Figure A-3, click Browse.
Use the Select User Or Group dialog box to select the domain account under which
the AGPM Service will run. After you enter and then confirm the password for this
account, click Next.
Figure A-3  Select the domain account for the AGPM Service.
10.             On the Archive Owner page, shown in Figure A-4, select an account or
group to which you want to initially assign the AGPM Administrator (Full Control)
role. AGPM administrators with full control can assign AGPM roles and ​-
permissions to other Group Policy administrators (including the role of AGPM
Administrator). Click Next.

Figure A-4  Select the account or group that will control the GPO archive.
11.             On the Port Configuration page, shown in Figure A-5, specify the port the
AGPM Service will use to communicate with clients. The default port is 4600. By
default, the wizard adds a port exception to the Windows Firewall if it is running.
Click Next.
12.             On the Languages page, specify the UI languages to install. By default, all
supported languages are selected. If you don’t want to install the UI components for
a language, clear the related check box. Click Next.
13.             The AGPM server components require the following additional
components: Windows Communications Foundation (WCF) Activation, Non-HTTP
Activation, and the Windows Process Activation Service. If these or other required
components aren’t already installed, they will be installed during the AGPM server
installation. Click Details to see a complete list of the components that will be
installed if they are not already present. When you are ready to continue, click
Install.
14.             When the installation is complete, click Finish to exit the wizard.
Figure A-5  Set the communications port for the AGPM Service.
You can check the server installation by:
Verifying that the AGPM Service is installed and running. To do this, start the
Services utility from the Tools menu in Server Manager. In the Services ​utility, check
that the AGPM Service is listed as Started with a Startup Type of ​Automatic and that
the service logs on as the service account you designated.
Confirming that the AGPM archive has been created. To do this, start File Explorer
and then navigate to the archive location. The default location is
%SystemRoot%\ProgramData\Microsoft\AGPM. Initially the archive folder will be
empty.

If the AGPM Service or the AGPM archive folder isn’t established, you’ll need to repeat
the AGPM server installation. The primary reason the installation will fail is because you
are logged on with a local computer account rather than a domain user account.

Performing a Client Installation of AGPM
Once you’ve established an AGPM server for a domain, you can install the AGPM client
on computers that you use to manage GPOs. Installing the AGPM client installs
extensions for the GPMC. These extensions provide the additional functionality.
Each Group Policy administrator must have the AGPM client installed on the computers
that he or she uses to manage GPOs. You do not need to install the AGPM client on
computers of users who will not manage Group Policy.
For AGPM 4.0 SP2 or later, the computer on which you are installing the AGPM client
must be running Windows 8.1 or Windows Server 2012 R2 and have GPMC installed as
part of the Remote Administration Server Tools.
The general steps to install the AGPM server vary slightly depending on the version you
are installing.  To install the AGPM client on a management computer, follow these
general steps:
1.                  Access the computer with an account that is a member of the Domain
Admins group.
2.                  Insert or mount the Microsoft Desktop Optimization Pack 2014 DVD. If
Autorun is enabled, the splash screen is displayed. Otherwise, double-click
Launcher.exe in the Launcher folder on the DVD.
3.                  On the splash screen, click the Advanced Group Policy Management
option.
4.                  On the Advanced Group Policy Management page, you’ll see installation ​-
options for the available versions of AGPM. On Windows 8.1 later and Windows
Server 2012, you’ll want to install AGPM 4.0 SP2 or later. Click Install Client (32-
bit) or Install Client (64-bit) as appropriate for the bitness of the operating system.
5.                  When the Microsoft Advanced Group Policy Management—Client Setup
Wizard starts, click Next.
6.                  On the Microsoft Software License Terms page, review the license terms.
Select I Accept The License Terms check box, and then click Next.
7.                  On the Application Path page, shown in Figure A-6, select a location in
which to install application components for the AGPM client. The default path is
%SystemRoot%\Program Files\Microsoft\AGPM\Client. Click Next.

Figure A-6  Specify an application path for the client components.
8.                  On the AGPM Server page, shown in Figure A-7, specify the AGPM
server to which the client should connect. Enter the fully qualified domain name of
the server, such as corpserver23.imaginedlands.com. Next, enter the port number on
which the client can connect to the AGPM Service running on the server. The
default port is 4600. By default, the wizard adds a port exception to Windows
Firewall if it is running. Click Next.
Figure A-7  Specify the server to which the client should connect.
9.                  On the Languages page, specify the UI languages to install. By default, all
supported languages are selected. If you don’t want to install the UI components for

a language, clear the related check box. Click Next.
10.             Click Install to install the client components. When the installation is
complete, click Finish to exit the wizard.
11.             Repeat the client installation on each computer that will be used for Group
Policy management.
After you install the client, you can start the GPMC and verify that the client extensions
are available on your management computer by following these steps:
1.                  Start the GPMC by clicking Group Policy Management on the Tools menu
in Server Manager.
2.                  Click the node for the domain in which you’ve installed AGPM to expand
it.
3.                  Under the domain node, you should see a Change Control node. When you
select the Change Control node, the GPMC will try to make a connection to the
GPO archive on the AGPM server. Note the following:
If the GPMC can connect to the AGPM server, the client is configured correctly.
You’ll find a list of available uncontrolled GPOs on the Contents\Uncontrolled tab,
as shown in Figure A-8. Later, when GPOs are under AGPM control, you’ll see
controlled GPOs on the Contents\Controlled tab.
Figure A-8  Verify that you can connect to the AGPM server.
If GPMC cannot connect to the server, you may not have correctly set the DNS
name or port information for the server. As long as AGPM policy is not yet
configured, you can change this information on the AGPM Server tab.
If you don’t have permission to work with the GPO archive, the GPMC can connect
to the AGPM server but cannot access the archive. You’ll receive an “insufficient
permissions” error as shown in Figure A-9. You’ll need to add your account to the
AGPM Administrator group. Then you’ll need to log off and then log back on.

Figure A-9  Resolve a permissions error by making your account an AGPM administrator.
Next, you can make the client extensions for AGPM available to other administrators.
This requires a two-step procedure:
1.                  In the first step, you make the Agpm.admx template available.
2.                  In the second step, you configure Group Policy to support AGPM.
Making the Agpm.admx Template Available
The Agpm.admx template should be available on your management computer after you
install the AGPM client. If you have not established a central store, you should be able to
use this template when you edit GPOs while logged on to your management computer.
You can verify that the appropriate files are available by following these steps:
1.                  On the computer on which you have installed the AGPM client, log on
with a user account that has appropriate permissions.
2.                  In File Explorer, check that the Agpm.admx file is in the
%SystemRoot%\Windows\PolicyDefinitions folder and that the Agpm.adml files
are in the appropriate language-specific subdirectories, such as %SystemRoot%\​-
Windows\PolicyDefinitions\en-us.
If you have established a central store, you’ll need to copy the related ADMX and ADML
files to the central store. The required ADMX file is Agpm.admx. You’ll find this file in
the %SystemRoot%\Windows\PolicyDefinitions folder. For each language you installed,
you’ll find a related Agpm.adml in a language-specific subdirectory of the
%SystemRoot%\Windows\PolicyDefinitions folder. Copy each language-specific
Agpm.adml file to the appropriate subdirectory in the central store.
At an elevated, administrator command prompt, enter the following commands:
xcopy %SystemRoot%\PolicyDefinitions\agpm.admx
\DC\Sysvol\DomainName\policies\PolicyDefinitions\
where DC is the host name of the target domain controller and DomainName  is the fully
qualified DNS name of the domain in which the domain controller is ​located. In the
following example, you copy the Agpm.admx file from your ​computer to CorpServer56 in
the Imaginedlands.com domain:
xcopy %SystemRoot%\PolicyDefinitions\agpm.admx

\CorpServer56\Sysvol\Imaginedlands.com\policies\PolicyDefinitions\
Next at an elevated, administrator command prompt, enter the following commands:
xcopy %SystemRoot%\PolicyDefinitions\LanguageCulture\agpm.adml
\DC\Sysvol\DomainName\policies\PolicyDefinitions\LanguageCulture\
where DC is the host name of the target domain controller, DomainName is the fully
qualified DNS name of the domain in which the domain controller is located,
and LanguageCulture  identifies the language-specific folder, such as EN-US. In
the following example, you copy the Agpm.adml file from your computer to 
CorpServer56 in the Imaginedlands.com domain:
xcopy %SystemRoot%\PolicyDefinitions\en-us\agpm.adml
\CorpServer56\Sysvol\Imaginedlands.com\policies
\PolicyDefinitions\en-us\
Configuring Group Policy to Support AGPM
Once you’ve ensured that the Agpm.admx template is available, you can configure Group
Policy to support AGPM in one of two ways. You can:
Use the AGPM: Specify Default AGPM Server (All Domains) policy to specify a
default AGPM server for all domains. Once you configure a default AGPM server for
all domains, administrators are unable to connect to any other AGPM server. You can
override this policy for specific domains by enabling and then configuring the
AGPM: Specify AGPM Servers policy.
Disable the AGPM: Specify Default AGPM Server (All Domains) policy and then
identify a specific AGPM server for each domain by enabling and then configuring
the AGPM: Specify AGPM Servers policy. Once you identify a specific AGPM
server for a domain through Group Policy, administrators are unable to connect to
any other AGPM server in that domain.
You can configure Group Policy to support AGPM by following these steps:
1.                  On the computer on which you have installed the AGPM client, log on
with a user account that is a member of the group that you selected as the Archive
Owner. This group has the role of AGPM Administrator (Full Control).
2.                  Start the GPMC by clicking Group Policy Management on the Tools menu
in Server Manager.
3.                  In the console tree, select and then right-click a GPO that is applied to all
Group Policy administrators. On the shortcut menu, click Edit.
Note  If no single GPO is applied to all Group Policy administrators, you will need
to repeat this procedure for applicable GPOs to ensure that Group Policy
administrators can connect to your AGPM servers.
4.                  In the Group Policy Management Editor, expand User Configuration,
Policies, Administrative Templates, and then select the Windows Components
node.
5.                  Under Windows Components, select the AGPM node. In the details pane,
double-click AGPM: Specify Default AGPM Server (All Domains).

6.                  In the AGPM: Specify Default AGPM Server (All Domains) Properties
dialog box, shown in Figure A-10, do one of the following:
If you want to configure a default AGPM server for all domains, select Enabled and
then enter the fully qualified domain name, a colon, and the port number for the
AGPM server, such as corpserver28.imaginedlands.com:4600 . Port 4600 is the
default port used by the AGPM Service. Click OK.
If you want to specify AGPM servers on a per-domain basis, select Disabled and
then click OK. You will then need to enable and configure the AGPM: Specify
AGPM Servers policy in each domain.
Figure A-10  Enable AGPM in Group Policy.
7.                  The AGPM: Specify AGPM Servers policy overrides the AGPM: Specify
Default AGPM Server (All Domains) policy. If you want to identify AGPM servers
on a per-domain basis, do the following:
1.               Double-click AGPM: Specify AGPM Servers.
2.               Select Enabled, and then click Show.
3.                In the Value Name box, enter the domain for which you are identifying the
AGPM server in the first text box, such as imaginedlands.com.
4.               In the Value box, enter the fully qualified domain name, a colon, and the
port number for the AGPM server, such as
corpserver28.imaginedlands.com:4600. Port 4600 is the default port used by the
AGPM Service.
5.               Click OK to close the Add Item dialog box.
6.                 Repeat steps c to f as necessary to identify AGPM servers for other

domains. Click OK twice when you have finished.
8.                  Click OK. When Group Policy is next refreshed, the AGPM Server
connection is configured as appropriate, and Group Policy administrators for which
this GPO applies will be able to connect to the AGPM server (providing the AGPM
client is installed on their management computers).


Installing Group Policy Templates and Add-ins for Microsoft
Office
You can obtain Group Policy templates and add-ins for Microsoft Office at the Microsoft
Download Center ( http://download.microsoft.com ). You can find and install these
additions by following these steps:
1.                  Go to http://download.microsoft.com  in Windows Internet Explorer. At
the Download Center, click Home & Office under Download Categories. Search for
“office customization tool.”
2.                  After you perform a Home & Office search for “office customization tool,”
click the link for the most recent release.
3.                  Download and run the self-extracting executable for the version or
versions of Office your organization uses.
4.                  When prompted, review the license terms. Select I Accept The License
Terms check box, and then click Continue.
5.                  Select a destination folder for the folders and files in the download, and
then review the folders and files you just extracted.
To use the Administrative templates in the GPMC on your management computer, copy
the ADMX files to the %SystemRoot%\Windows\PolicyDefinitions folder, and copy the
ADML files to the appropriate language-specific subfolder within the PolicyDefinitions
folder. If you are using a central store and want to make the templates available
throughout the domain, copy the ADMX and ADML files to the appropriate folders by
following these steps:
1.                  Access a domain controller running Windows Server 2012 in the target
domain by using an account that is a member of Domain Admins. Verify that a
PolicyDefinitions folder has been created under
%SystemRoot%\Sysvol\ DomainName \Policies, where DomainName  is the name
of the domain in which the domain controller is located and for which you are
checking that a central store has been established.
2.                  Copy the ADMX and ADML files from the extraction location on your
computer to the appropriate SYSVOL folders on the domain controller.
For example, if you extracted the download to your Documents folder in your user profile,
you could copy all the required policy files from your computer to the target domain
controller in a single step. Simply run the following commands at an elevated,
administrator command prompt:
xcopy /s %UserProfile%\ADMX
\DC\Sysvol\DomainName\policies\PolicyDefinitions\
where DC is the host name of the target domain controller and DomainName  is the fully
qualified DNS name of the domain in which the domain controller is located. In the
following example, you copy the ADMX and ADML files from your computer to
CorpServer43 in the Imaginedlands.com domain:
xcopy /s %UserProfile%\ADMX

\CorpServer43\Sysvol\imaginedlands.com\policies\PolicyDefinitions\
Note  See “Managing Changes with Template Files” in Chapter 2 for more
information on working with a central store.


About the Author
William Stanek (http://www.williamstanek.com/) has more
than 20 years of hands-on experience with advanced
programming and development. He is a leading technology
expert, an award-winning author, and a pretty-darn-good
instructional trainer. Over the years, his practical advice has
helped millions of programmers, developers, and network
engineers all over the world. His current and books include
Windows 8.1 Administration Pocket Consultants, Windows
Server 2012 R2 Pocket Consultants and Windows Server
2012 R2 Inside Outs.
William has been involved in the commercial Internet
community since 1991. His core business and technology
experience comes from more than 11 years of military
service. He has substantial experience in developing server
technology, encryption, and Internet solutions. He has
written many technical white papers and training courses on
a wide variety of topics. He frequently serves as a subject
matter expert and consultant.
William has an MS with distinction in information systems and a BS in computer science,
magna cum laude. He is proud to have served in the Persian Gulf War as a combat
crewmember on an electronic warfare aircraft. He flew on umerous combat missions into
Iraq and was awarded nine medals for his wartime service, including one of the United
States of America’s highest flying honors, the Air Force Distinguished Flying Cross.
Currently, he resides in the Pacific Northwest with his wife and children.
William recently rediscovered his love of the great outdoors. When he’s not writing, he
can be found hiking, biking, backpacking, traveling, or trekking in search of adventure
with his family!
Find William on Twitter at www.twitter.com/WilliamStanek and on Facebook at
www.facebook.com/William.Stanek.Author.


