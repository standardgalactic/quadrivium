Unpacking Stubs

Types of Unpacking Stubs
HYBRID
injected process unpacks data into own 
process
OWN PROCESS UNPACKING
e.g. UPX, Wibu
PROCESS INJECTION UNPACKING
e.g. Process Hollowing aka RunPE
2

Unpacking Stub - Steps
E.g.
create new process 
find another process
create new section
increase section size
CREATE OR FIND 
TARGET LOCATION
Target data can be:
PE EXE
PE DLL
shellcode
section
WRITE
final preparation, e.g., 
set entry point in 
target
PREPARE 
EXECUTION
Execute target
EXECUTE
Prepare target location, 
e.g.
carving the process
adding RWX rights
PREPARE 
LOCATION
3

Own Process Execution - Virtual Section
entry point
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
UNPACKING STUB
ENCRYPTED 
TARGET CODE
HEADER
EMPTY SECTION
PE IMAGE ON DISK
PE IMAGE IN MEMORY
4

Own Process Execution - Virtual Section
reads and decrypts
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
EMPTY SECTION
PROCESS
5

Own Process Execution - Virtual Section
writes
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
EMPTY SECTION
PROCESS
6

Own Process Execution - Virtual Section
writes
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
UNPACKED TARGET
PROCESS
7

Own Process Execution - Virtual Section
Tail Jump
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
The tail jump is the 
jump to the original 
entry point (OEP)
The tail jump usually 
hops into a different 
section
UNPACKED TARGET
PROCESS
8

Own Process Execution - New Section
UNPACKING STUB
ENCRYPTED 
TARGET CODE
HEADER
PROCESS
9

Own Process Execution - New Section
Creates
UNPACKING STUB
ENCRYPTED 
TARGET CODE
HEADER
NEW SECTION
PROCESS
10

Own Process Execution - New Section
writes
UNPACKING STUB
ENCRYPTED 
TARGET CODE
HEADER
UNPACKED TARGET
PROCESS
11

Own Process Execution - New Section
Tail Jump
UNPACKING STUB
ENCRYPTED 
TARGET CODE
HEADER
UNPACKED TARGET
PROCESS
12

Process Injection Execution - New Section
Create or Find
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
PROCESS A
PROCESS B 
13

Process Injection Execution - New Section
Suspend
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
PROCESS A
PROCESS B 
(SUSPENDED)
14

Process Injection Execution - New Section
Creates
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
NEW SECTION
PROCESS A
PROCESS B 
(SUSPENDED)
15

Process Injection Execution - New Section
Reads and decrypts
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
NEW SECTION
PROCESS A
PROCESS B 
(SUSPENDED)
16

Process Injection Execution - New Section
Writes
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
UNPACKED TARGET
PROCESS A
PROCESS B 
(SUSPENDED)
17

Process Injection Execution - New Section
Set entry point to target
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
UNPACKED TARGET
PROCESS A
PROCESS B 
(SUSPENDED)
18

Process Injection Execution - New Section
Resume
UNPACKING STUB
ENCRYPTED TARGET 
CODE
HEADER
SECTION 2
SECTION 1
HEADER
UNPACKED TARGET
PROCESS A
PROCESS B 
(RESUMED)
19

Process Injection Execution - RunPE
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
SECTION 3
SECTION 2
HEADER
SECTION 1
PROCESS A
PROCESS B 
(SUSPENDED)
20

Process Injection Execution - RunPE
Unmap
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
SECTION 3
SECTION 2
HEADER
SECTION 1
PROCESS A
PROCESS B 
(SUSPENDED)
21

Process Injection Execution - RunPE
Unmap
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
PROCESS A
PROCESS B 
(SUSPENDED)
22

Process Injection Execution - RunPE
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
PROCESS A
PROCESS B 
(SUSPENDED)
23

Process Injection Execution - RunPE
Allocate memory
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
PROCESS A
PROCESS B 
(SUSPENDED)
24

Process Injection Execution - RunPE
Decrypt
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
PROCESS A
PROCESS B 
(SUSPENDED)
25

Process Injection Execution - RunPE
Write
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
TARGET SECTION 2
TARGET HEADER
TARGET SECTION 1
PROCESS A
PROCESS B 
(SUSPENDED)
26

Process Injection Execution - RunPE
Set thread context entry point
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
TARGET SECTION 2
TARGET HEADER
TARGET SECTION 1
PROCESS A
PROCESS B 
(SUSPENDED)
27

Process Injection Execution - RunPE
Resume
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
TARGET SECTION 2
TARGET HEADER
TARGET SECTION 1
PROCESS A
PROCESS B 
(SUSPENDED)
28

Process Injection Execution - RunPE
UNPACKING STUB
ENCRYPTED TARGET 
FILE
HEADER
TARGET SECTION 2
TARGET HEADER
TARGET SECTION 1
PROCESS A
PROCESS B 
(RESUMED)
29

