
w w w . s y n g r e s s . c o m
Syngress is committed to publishing high-quality books for IT Professionals and
delivering those books in media and formats that ﬁt the demands of our cus-
tomers. We are also committed to extending the utility of the book you purchase
via additional materials available from our Web site. 
SOLUTIONS WEB SITE
To register your book, visit www.syngress.com/solutions. Once registered, you can
access our solutions@syngress.com Web pages. There you will ﬁnd an assortment
of value-added features such as free e-booklets related to the topic of this book,
URLs of related Web sites, FAQs from the book, corrections, and any updates from
the author(s).
ULTIMATE CDs
Our Ultimate CD product line offers our readers budget-conscious compilations of
some of our best-selling backlist titles in Adobe PDF form. These CDs are the perfect
way to extend your reference library on key topics pertaining to your area of exper-
tise, including Cisco Engineering, Microsoft Windows System Administration,
CyberCrime Investigation, Open Source Security, and Firewall Conﬁguration, to
name a few.
DOWNLOADABLE E-BOOKS
For readers who can’t wait for hard copy, we offer most of our titles in download-
able Adobe PDF form. These e-books are often available weeks before hard copies
and are priced affordably.
SYNGRESS OUTLET
Our outlet store at syngress.com features overstocked, out-of-print, or slightly hurt
books at signiﬁcant savings.
SITE LICENSING
Syngress has a well-established program for site licensing our e-books onto servers
in corporations, educational institutions, and large organizations. Contact us at
sales@syngress.com for more information.
CUSTOM PUBLISHING
Many organizations welcome the ability to combine parts of multiple Syngress
books, as well as their own content, into a single volume for their own internal use.
Contact us at sales@syngress.com for more information.
Visit us at

Ido Dubrawsky
Technical Editor
C. Tate Baumrucker
James Caesar
Mohan Krishnamurthy
Dr. Thomas W. Shinder
Becky Pinkard
Eric Seagren
Laura Hunter
Enterprise
DMZs
Designing and Building

Syngress Publishing, Inc., the author(s), and any person or ﬁrm involved in the writing, editing, or produc-
tion (collectively “Makers”) of this book (“the Work”) do not guarantee or warrant the results to be
obtained from the Work.
There is no guarantee of any kind, expressed or implied, regarding the Work or its contents.The Work is
sold AS IS and WITHOUT WARRANTY.You may have other legal rights, which vary from state to
state.
In no event will Makers be liable to you for damages, including any loss of proﬁts, lost savings, or other
incidental or consequential damages arising out from the Work or its contents. Because some states do not
allow the exclusion or limitation of liability for consequential or incidental damages, the above limitation
may not apply to you.
You should always use reasonable care, including backup and other appropriate precautions, when working
with computers, networks, data, and ﬁles.
Syngress Media®, Syngress®,“Career Advancement Through Skill Enhancement®,”“Ask the Author
UPDATE®,” and “Hack Prooﬁng®,” are registered trademarks of Syngress Publishing, Inc.“Syngress:The
Deﬁnition of a Serious Security Library”™,“Mission Critical™,” and “The Only Way to Stop a Hacker is
to Think Like One™” are trademarks of Syngress Publishing, Inc. Brands and product names mentioned
in this book are trademarks or service marks of their respective companies.
KEY
SERIAL NUMBER
001
HJIRTCV764
002
PO9873D5FG
003
829KM8NJH2
004
LKLKPOP34N
005
CVPLQ6WQ23
006
VBP965T5T5
007
HJJJ863WD3E
008
2987GVTWMK
009
629MP5SDJT
010
IMWQ295T6T
PUBLISHED BY
Syngress Publishing, Inc.
800 Hingham Street
Rockland, MA 02370
Designing and Building Enterprise DMZs
Copyright © 2006 by Syngress Publishing, Inc.All rights reserved. Printed in Canada and the United
States of America. Except as permitted under the Copyright Act of 1976, no part of this publication may
be reproduced or distributed in any form or by any means, or stored in a database or retrieval system,
without the prior written permission of the publisher, with the exception that the program listings may
be entered, stored, and executed in a computer system, but they may not be reproduced for publication.
Printed in Canada
1  2  3  4  5  6  7  8  9  0
ISBN: 1-59749-100-4
Publisher:Andrew Williams
Page Layout and Art: Patricia Lupien
Acquisitions Editor: Erin Heffernan
Copy Editor: Darlene Bordwell,Audrey Doyle
Technical Editor: Ido Dubrawsky
Indexer: Nara Wood
Cover Designer: Michael Kavish
Distributed by O’Reilly Media, Inc. in the United States and Canada.
For information on rights, translations, and bulk sales, contact Matt Pedersen, Director of Sales and Rights,
at Syngress Publishing; email matt@syngress.com or fax to 781-681-3585.

v
Technical Editor
Ido Dubrawsky (CISSP, CCNA, CCDA) is the Chief Security
Advisor for Microsoft’s Communication Sector North America, a
division of the Mobile and Embedded Devices Group. Prior to
working at Microsoft, Ido was the acting Security Consulting
Practice Lead at AT&T’s Callisma subsidiary and a Senior Security
Consultant. Before joining AT&T, Ido was a Network Security
Architect for Cisco Systems, Inc., SAFE Architecture Team. He has
worked in the systems and network administration ﬁeld for almost
20 years in a variety of environments from government to academia
to private enterprise. He has a wide range of experience in various
networks, from small to large and relatively simple to complex. Ido
is the primary author of three major SAFE white papers and has
written, and spoken, extensively on security topics. He is a regular
contributor to the SecurityFocus website on a variety of topics cov-
ering security issues. Previously, he worked in Cisco Systems, Inc.
Secure Consulting Group, providing network security posture assess-
ments and consulting services for a wide range of clients. In addi-
tion to providing penetration-testing consultation, he also
conducted security architecture reviews and policy and process
reviews. He holds a B.Sc. and a M.Sc. in Aerospace Engineering
from the University of Texas at Austin.
Cherie Amon (CCSA/CCSE) has been installing, conﬁguring and
supporting Check Point products since 1997. Cherie is also the
Technical Editor and co-author of Check Point Next Generation
Security Administration (Syngress Publishing, ISBN: 1-928994-74-1)
and contributing author of Nokia Network Security Solutions
Handbook (Syngress Publishing, ISBN: 1-931836-70-1). She is also a
Contributing Authors

vi
contributing author of Check Point NG VPN-1/FireWall-1:Advanced
Conﬁgurations and Troubleshooting (Syngress Publishing, ISBN:
1-931836-97-3).
C.Tate Baumrucker (CISSP, Sun Enterprise Engineer, MCSE) is
a Principal Architect with Callisma, a completely owned subsidiary
of AT&T.Tate is responsible for leading engineering teams in the
design and implementation of secure and highly available systems
infrastructures and networks. He is industry-recognized as a subject-
matter expert in security, network performance, and LAN support
systems, such as HTTP, SMTP, DNS, and DHCP. For 11 years,Tate
has provided business and technical consulting services in enterprise
and service-provider industries and to the Department of Defense,
and currently works as the Principal Architect of Network
Performance for the Pentagon’s enterprise-wide networks.Tate has
contributed to other Syngress books, including Managing Cisco
Network Security (ISBN: 1-928994-17-2), Cisco Security Specialist’s
Guide to PIX Firewall (ISBN: 1-931836-63-9), and Cisco Security
Professional’s Guide to Secure Intrusion Detection Systems (ISBN: 1-
932266-69-0).
Tate resides in Washington, DC with his wife, Evelyne and two
daughters, Elise and Margot.
James Caesar (CCIE #14995, CCSE Plus) is currently a Network
Analyst for Ceridian Corporation, where he is responsible for design
and implementation of the company’s global network infrastructure,
including the DMZ environment which supports Ceridian’s many
Web-based products. James was a co-author for other Syngress titles,
including Managing Cisco Network Security, 2nd Edition (ISBN:
1931836566) and Check Point NG VPN-1/Firewall-1(ISBN:
1931836973). James holds his bachelor’s degree in Electrical
Engineering from the Georgia Institute of Technology and lives out-
side of Atlanta, GA with his wife, Julie.
Eli Faskha (CCSI, CCSA, CCSE, CCSE+, CCAE, MCP). Based in
Panama City, Panama, Eli is Founder and President of Soluciones
Seguras, a company that specializes in network security and is the
only Check Point Gold Partner in Central America and the only

vii
Nokia Internet Security partner in Panama. He was Assistant
Technical Editor for Conﬁguring Check Point NGX VPN-1/FireWall-
1 (ISBN: 1597490318), a Syngress Publishing book. Eli is the most
experienced Check Point Certiﬁed Security Instructor and Nokia
Instructor in the region, and has taught participants from almost
twenty different countries.A 1993 graduate of the University of
Pennsylvania’s Wharton School and Moore School of Engineering,
he also received an MBA from Georgetown University in 1995. Eli
has more than 8 years of Internet development and networking
experience, starting with Web development of the largest Internet
portal in Panama in 1999 and 2000, managing a Verisign afﬁliate in
2001, and running his own company since then. Eli has written sev-
eral articles for the local media and has been recognized for his con-
tributions to Internet development in Panama.
Laura E. Hunter (CISSP, MCSE: Security, MCDBA, Microsoft
MVP) is an IT Project Leader and Systems Manager at the
University of Pennsylvania, where she provides network planning,
implementation, and troubleshooting services for various business
units and schools within the university. Her specialties include
Windows 2000 and 2003 Active Directory design and implementa-
tion, troubleshooting, and security topics. Laura has more than a
decade of experience with Windows computers; her previous expe-
rience includes a position as the Director of Computer Services for
the Salvation Army and as the LAN administrator for a medical
supply ﬁrm. She is a contributor to the TechTarget family of Web
sites, and to Redmond Magazine (formerly Microsoft Certiﬁed
Professional Magazine).
Laura has previously contributed to the Syngress Windows Server
2003 MCSE/MCSA DVD Guide & Training System series as a DVD
presenter, author, and technical reviewer, and is the author of the
Active Directory Consultant’s Field Guide (ISBN: 1-59059-492-4) from
APress. Laura is a three-time recipient of the prestigious Microsoft
MVP award in the area of Windows Server—Networking. Laura
graduated with honors from the University of Pennsylvania and also
works as a freelance writer, trainer, speaker, and consultant.

viii
Mohan Krishnamurthy Madwachar (JNCIW-FW, CWNA, and
CCSA) is an AVP of Infrastructure Services for ADG Infotek, Inc.
ADG Infotek is an IT Services Company headquartered in
Gurgaon, India. Mohan operates from ADG’s East Brunswick ofﬁce
in New Jersey.ADG Infotek is part of a leading systems integration
group that has branches in 7 countries and executes projects in
nearly 15 countries. Mohan is a key contributor to their infrastruc-
ture services division and plays a signiﬁcant role in the organization’s
Network Security and Training initiatives. Mohan’s tenure with
companies such as Schlumberger Omnes and Secure Network
Solutions India adds to his experience and expertise in imple-
menting large and complex network and security projects.
Mohan holds leading IT industry certiﬁcations, and is a member
of the IEEE and PMI.
Mohan dedicates his contributions to this book to his father
Krishnamurthy Madwachar and mother Radha Madwachar who
have been his inspiration and support for his career achievements.
Mohan also writes in newspaper columns on various subjects and
has contributed to leading content companies as a technical writer
and a subject-matter expert.
Wesley J Noonan (Houston,Texas) has worked in the computer
industry for more than 12 years, specializing in Windows-based net-
works and network infrastructure security design and implementa-
tion. He is a Staff Quality Engineer for NetIQ, working on their
security solutions product line. Wes is the author of Hardening
Network Infrastructure (ISBN: 0072255021), and is a contributing/
co-author for The CISSP Training Guide, Hardening Network Security
(ISBN: 0072257032) and Firewall Fundamentals (ISBN: 1587052210).
Wes is the technical editor for Hacking Exposed: Cisco Networks
(ISBN: 0072259175). Wes also contributes to “Redmond” magazine,
writing on the subjects of network infrastructure and security, and
he maintains a Windows Network Security section called “Ask the
Experts” for Techtarget.com (http://searchwindowssecurity.
techtarget.com/ateAnswers/0,289620,sid45_tax298206,00.html).
Wes has also presented at TechMentor 2004.
Wes lives in Houston,Texas.

ix
Becky Pinkard (CCSA, CCNA, GCIA) has worked in the infor-
mation technology industry for over 10 years. She is currently a
senior security architect with a Fortune 50 company where she is
fortunate enough to work with security technology on a daily basis.
Becky’s main areas of interest are intrusion detection, pen testing,
vulnerability assessments, risk management, and forensics. She is a
SANS Certiﬁed Instructor and has taught for the SANS Institute
since 2001. She participated on the Strategic Advisory Council for
the Center for Internet Security where she edited the ﬁrst draft of
the CIS Windows NT benchmark. Becky holds a bachelor’s degree
from Texas A&M University and is a member of the North Texas
chapter of InfraGard. She’d like to send out hacker-like greetz to her
wonderful partner, awesome family and incredible friends - you are
all loved beyond compare.
Eric S. Seagren (CISA, CISSP-ISSAP, SCNP, CCNA, CNE-4,
MCP+I, MCSE-NT) has ten years of experience in the computer
industry, with the last eight years spent in the ﬁnancial services
industry working for a fortune 100 company. Eric started his com-
puter career working on Novell servers and performing general net-
work troubleshooting for a small Houston-based company. While
working in the ﬁnancial services industry, his duties have included
server administration, disaster recovery, business continuity coordina-
tion,Y2K remediation, network vulnerability assessment, and risk
managements. Eric has spent the last few years as an IT architect
and risk analyst, designing and evaluating secure, scalable, and redun-
dant networks.
Eric has contributed to several books as a contributing author or
technical editor.These include; Hardening Network Security
(McGraw-Hill), Hardening Network Infrastructure (McGraw-Hill),
Hacking Exposed: Cisco Networks (McGraw-Hill), Conﬁguring
Checkpoint NGX VPN-1/FireWall-1 (ISBN: 1-597490-31-8), a
Syngress Publishing book and Firewall Fundamentals (Cisco Press).
He has also received a CTM from Toastmasters of America.
Thomas W. Shinder, M.D. is the primary content creator and
driving force for www.isaserver.org. He is co-owner of TACTEAM

x
and he has provided Microsoft Internet Security and Acceleration
Server ﬁrewall consultation and strategic guidance to major enter-
prises including Microsoft, HP, Exxon and the United States Federal
Government.Tom is also the coauthor of Dr.Tom Shinder’s
Conﬁguring ISA Server 2004 (ISBN: 1931836191), published by
Syngress.
Darren Windham (CISSP, Security+) works for McAfee, Inc., sup-
porting enterprise-level clients with the implementation, operation,
and integration of the McAfee product line. Darren is currently
becoming familiar with current technologies supporting Network
Access Control (NAC).
Darren’s previous experience in technology includes network
design, system conﬁguration, security audits, internal investigations,
ensuring compliance with GLB, FFIEC, OTS, FDIC, and SOX reg-
ulations, and managing technology risks within an organization. He
has also worked as a security consultant for local companies
including other ﬁnancial institutions along with networking and
server support. Darren was a reviewer for the book Hacking Exposed:
Computer Forensics (McGraw-Hill Osborne Media, ISBN:
0072256753). Darren was also a contributing author for the book
Winternals Defragmentation, Recovery, and Administration Field Guide
(Syngress Publishing, ISBN: 1-59749-079-2)
Darren is a member of Information Systems Audit and Control
Association® (ISACA), North Texas Electronic Crimes Task Force
(N-TEC), and the North Texas Snort User Group.
Darren thanks his wife, Jaime, and his three sons, Daniel,
Andrew, and Jacob for being his support and inspiration to succeed.
Darren would also like to thank his friends and coworkers along the
way that have shared their knowledge and experience: Chris Bolton,
Dave Cowen, Keith Loyd, Chris Davis, Gabby Cox, and Matt Gair.

Chapter 1 DMZ Concepts, Layout, and Conceptual Design . . . . . . . . . . . 1
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .2
Planning Network Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .3
Security Fundamentals  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .3
Identifying Risks to Data  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .6
Identifying Risks to Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .7
Identifying Potential Threats  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .8
Introducing Common Security Standards  . . . . . . . . . . . . . . . . . . . . . . . . . . . .8
Policies, Plans, and Procedures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .10
DMZ Definitions and History  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .11
DMZ Concepts  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .14
Traffic Flow Concepts  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .17
Networks With and Without DMZs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .20
Why Design Is So Important  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .23
Designing End-to-End Security for 
Data Transmission Between Hosts on the Network  . . . . . . . . . . . . . . . . . . . .24
Traffic Flow and Protocol Fundamentals  . . . . . . . . . . . . . . . . . . . . . . . . . . . .24
Designing for Protection in Relation to the Inherent Flaws of TCP/IP v4  . . .25
Public and Private IP Addressing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .26
Ports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .26
The OSI Model  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .28
Traffic and Security Risks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .32
Advaced Risks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .34
Web and FTP Sites  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .35
E-Mail Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .36
Advanced Design Stratgies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .36
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .40
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .40
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .42
Chapter 2 Windows DMZ Design. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .46
Introducing Windows DMZ Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .47
Fundamental Windows DMZ Design  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .48
New Features in Windows Server 2003 R2  . . . . . . . . . . . . . . . . . . . . . . . . . .57
Building a Windows DMZ  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .58
Designing the DMZ Windows Style  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .59
DMZ Perimeter Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .67
DMZ Mail Services  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .72
Web Servers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .73
Designing Windows DNS in the DMZ . . . . . . . . . . . . . . . . . . . . . . . . . . . . .74
Engineering Windows Traffic in the DMZ  . . . . . . . . . . . . . . . . . . . . . . . . . .75
xi
Contents

xii
Contents
Assessing Network Data Visibility Risks  . . . . . . . . . . . . . . . . . . . . . . . . .79
Windows DMZ Design Planning List  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .81
A Look Forward to Longhorn  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .83
Introducing the Read-Only Domain Controller  . . . . . . . . . . . . . . . . . . . . . .83
Slimming Down with Server Core  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .83
Using Network Access Protection  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .84
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .85
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .86
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .90
Chapter 3 Sun Solaris DMZ Design . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .94
New Features of Sun Solaris 10  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .94
Placement of Servers  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .95
The Firewall Ruleset . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .98
The Private Network Rules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .99
The Public Network Rules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .101
Server Rules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .103
System Design . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .104
Hardware Selection:The Foundation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .105
Software Selection:The Structure  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .108
Configuration:The Plumbing and Other Details  . . . . . . . . . . . . . . . . . . . . .117
Implementation:The Quick and Dirty Details  . . . . . . . . . . . . . . . . . . . . . . . . . .129
Media Integrity  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .129
Physical Host Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .129
Host Network Security . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .130
Patch Application  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .130
Solaris System Hardening  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .131
Hardening Checklists for DMZ Servers and Solaris . . . . . . . . . . . . . . . . . . . . . . .139
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .140
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .141
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .143
Chapter 4 Wireless DMZs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 145
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .146
The Need for Wireless DMZs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .146
Passive Attacks on Wireless Networks  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .147
Active Attacks on Wireless Networks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .150
Man-in-the-Middle Attacks on Wireless Networks . . . . . . . . . . . . . . . . . . . .153
Jamming Attacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .155
Designing the Wireless DMZ . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .156
Placement of Wireless Equipment  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .156
Access to DMZ Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .156
Authentication Considerations  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .156
Wireless DMZ Components  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .158
Access Points  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .159
Network Adapters  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .159

Contents
xiii
Authentication Servers  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .160
Enterprise Wireless Gateways and Wireless Gateways  . . . . . . . . . . . . . . . . . .161
Firewalls and Screening Routers  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .161
Other Segmentation Devices . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .162
Wireless DMZ Examples  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .162
Wireless LAN Security Best-Practices Checklist  . . . . . . . . . . . . . . . . . . . . . . . .165
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .167
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .167
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .169
Chapter 5 Implementing Wireless DMZs . . . . . . . . . . . . . . . . . . . . . . . . 171
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .172
Implementing RADIUS With Cisco EAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .172
LEAP Features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .173
Building a Cisco LEAP Solution  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .175
Installing and Configuring Juniper Steel-Belted RADIUS . . . . . . . . . . . . . . . . . .176
RADIUS Authentication Process . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .177
Installing Steel-Belted RADIUS  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .178
Configuring Cisco LEAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .182
Windows Active Directory Domain Authentication With LEAP and RADIUS  . .186
LEAP Review  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .188
Implementing PEAP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .188
Windows 2003 Environment PEAP Solution . . . . . . . . . . . . . . . . . . . . . . . .191
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .204
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .204
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .205
Chapter 6 Firewall Design: Cisco PIX and ASA . . . . . . . . . . . . . . . . . . . 207
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .208
PIX and ASA Basics  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .208
Securing Your Network Perimeters  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .209
The Cisco Perimeter Security Solution  . . . . . . . . . . . . . . . . . . . . . . . . . . .210
Cisco PIX/ASA Versions and Features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .215
Cisco PIX Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .215
Cisco ASA Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .222
Cisco Firewall Software  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .228
Making a DMZ and Controlling Traffic  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .243
Securely Managing the PIX  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .243
PIX/ASA Configuration Basics  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .251
Defining Interfaces  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .251
Configuring NAT  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .258
Configuring Access Rules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .269
Routing Through the PIX  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .278
Configuring Advanced PIX/ASA Features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .282
PIX/ASA 7.x Security Contexts  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .283
The PIX/ASA Failover Services  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .285
Blocking ActiveX and Java  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .295

xiv
Contents
Content Filtering  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .296
Cut-Through Proxy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .297
Application Inspection  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .299
Intrusion Detection  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .306
FloodGuard and DNSGuard  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .307
Securing SNMP and NTP  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .307
PIX/ASA Firewall Design and Configuration Checklist  . . . . . . . . . . . . . . . . . . .308
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .310
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .311
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .313
Chapter 7 Firewall and DMZ Design: Check Point . . . . . . . . . . . . . . . . 315
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .316
Basics of Check Point Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .316
Choosing the Right Check Point Solution  . . . . . . . . . . . . . . . . . . . . . . . . .318
Management Architecture  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .319
Stateful Inspection  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .320
Higher-Level Protections  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .320
Securing Your Network Perimeters  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .321
Firewall Modes  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .321
Routing Through Check Point  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .323
Configuring Your DMZ  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .323
ISP Redundancy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .323
Clusters  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .324
SecureXL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .324
Quality of Service  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .325
Configuring the Firewall  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .325
Configuring Interfaces  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .326
Configuring Interface Antispoofing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .327
Customizing Stateful Inspection  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .328
Configuring the Security Rulebase  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .330
Creating Objects and Servers  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .330
Creating Services  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .331
Creating Rules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .332
Configuring the Address Translation Rulebase . . . . . . . . . . . . . . . . . . . . . . . . . . .333
Configuring Networkand Application Protections . . . . . . . . . . . . . . . . . . . . . . . .335
SmartDefense Network Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .336
SmartDefense Application Intelligence . . . . . . . . . . . . . . . . . . . . . . . . . . . . .340
Web Intelligence . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .344
Content Inspection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .347
Check Point NG Secure DMZ Checklist . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .350
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .351
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .351
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .352

Contents
xv
Chapter 8 Firewall and DMZ Design: 
SecurePlatform and Nokia Firewalls . . . . . . . . . . . . . . . . . . . . . . . . . . . 355
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .356
Basics of SecurePlatform Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .357
Choosing the Right SecurePlatform Option  . . . . . . . . . . . . . . . . . . . . . . . .357
Configuring SecurePlatform  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .357
SecurePlatform Configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .363
SecurePlatform Maintenance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .363
Basics of Nokia Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .365
Choosing the Right Platform  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .366
Configuring the Nokia Appliance  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .371
Using cpconfig  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .379
Using cpconfig on SmartCenters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .379
Using cpconfig on Security Gateways  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .380
Nokia Firewall and DMZ Design Checklist  . . . . . . . . . . . . . . . . . . . . . . . . . . . .381
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .382
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .382
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .384
Chapter 9 Firewall and DMZ Design: Juniper NetScreen. . . . . . . . . . . . 387
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .388
NetScreen Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .388
The Juniper NetScreen Security Solution  . . . . . . . . . . . . . . . . . . . . . . . . . .388
Juniper NetScreen Versions and Features  . . . . . . . . . . . . . . . . . . . . . . . . . . .388
Juniper NetScreen Firewalls . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .389
Juniper NetScreen Firewall Software  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .394
Securely Managing Juniper NetScreen Firewalls  . . . . . . . . . . . . . . . . . . . . . . . . .396
Console  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .396
SSH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .397
WebUI . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .397
The NetScreen Security Manager  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .398
NetScreen Configuration Basics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .398
Virtualization  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .399
Defining Interfaces  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .401
Configuring Security Policies  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .405
Configuring Network Address Translation  . . . . . . . . . . . . . . . . . . . . . . . . . .408
Routing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .414
NetScreen Advanced Features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .418
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .429
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .429
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .431
Chapter 10 Firewall and DMZ Design: ISA Server 2005 . . . . . . . . . . . . 435
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .436
Network Services Segment Configuration Options . . . . . . . . . . . . . . . . . . . . . . .437
Scenario 1:A LAN Router between 
the ISA Firewall and Corporate Network  . . . . . . . . . . . . . . . . . . . . . . . . . .437

xvi
Contents
Scenario 2: No LAN Router between 
the ISA Firewall and Corporate Network  . . . . . . . . . . . . . . . . . . . . . . . . . .438
ISA Firewall Stateful Packet Inspection and Request/Response Paths  . . . . . . . . .439
Multiple Departmental Networks/Security 
Zones Connected to a Backbone Network . . . . . . . . . . . . . . . . . . . . . . . . . . . . .442
Example Network and Perimeter Network Design . . . . . . . . . . . . . . . . . . . . . . .443
Creating the ISA Representing the 
Corporate Network on the Network Services Perimeter . . . . . . . . . . . . . . . . . . .445
Creating the Corpnet ISA Firewall Network  . . . . . . . . . . . . . . . . . . . . . . . . . . .446
Creating the Rule on the Network Services Perimeter ISA, Setting a Route
Relationship between the Corporate Network and Network Services Segment  . .447
Creating the Network Rule Defining a Route Relationship between 
the Corpnet ISA Firewall Network and the Default Internal Network  . . . . .448
Creating an Intradomain Communications Access Rule on the 
Network Services Perimeter ISA Firewall and a DNS Server Publishing Rule  . .450
Creating the Intradomain Communications Rule . . . . . . . . . . . . . . . . . . . . .451
Creating the DNS Server Publishing Rule  . . . . . . . . . . . . . . . . . . . . . . . . .454
Creating Access Rules Controlling Outbound Access 
from the Network Services Segment on the Perimeter ISA Firewall  . . . . . . . . . .456
Creating the Access Rule Allowing DNS 
Traffic from the DNS Server to the Internet  . . . . . . . . . . . . . . . . . . . . . . . .457
Creating the Access Rule Allowing Outbound 
Windows Update and Microsoft Reporting  . . . . . . . . . . . . . . . . . . . . . . . . .457
Creating the Network Services Access Rules 
Enabling Corpnet Clients Access to Network Services  . . . . . . . . . . . . . . . . . . . .459
Creating an OWA Publishing Rule on the 
Network Services Perimeter ISA Firewall  . . . . . . . . . . . . . . . . . . . . . . . . . .461
Creating SMTP, POP3, and IMAP4 Server Publishing Rules  . . . . . . . . . . . .466
Creating an Access Rule Allowing Access to File Shares on the File Server  . .470
Configuring the Default Internal Network on the Edge ISA Firewall  . . . . . . . . .472
Adding IP Addresses of the Network Services Perimeter 
Segment to the Front-End ISA Firewall’s Default Internal Network  . . . . . . .474
Creating a Routing Table Entry on the Edge ISA Firewall  . . . . . . . . . . . . . . . . .475
Joining the Edge ISA Firewall to the Domain . . . . . . . . . . . . . . . . . . . . . . . . . . .476
Creating Access Rules on the Edge ISA Firewall, Controlling Outbound 
Access from Corpnet Hosts and Hosts on the Network Services Segment  . . . . . .477
Creating the Outbound DNS for the DNS Server Access Rule  . . . . . . . . . .478
Creating the All Open Rule for Authenticated Users  . . . . . . . . . . . . . . . . . .480
Creating the Microsoft Update and Error Reporting Sites Access Rule  . . . .481
Creating Publishing Rules on the Edge ISA Firewall to 
Allow Inbound Connections to the Exchange Server Mail Services . . . . . . . . . . .484
Creating an SSL Server Publishing Rule on 
the Network Services Perimeter ISA Firewall  . . . . . . . . . . . . . . . . . . . . . . .484
Creating the Network Services Perimeter 
Network OWA Web Publishing Rule  . . . . . . . . . . . . . . . . . . . . . . . . . . . .485
Creating Secure Exchange RPC, SMTP, POP3,

Contents
xvii
and IMAP4 Server Publishing Rules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .486
Creating a Routing Table Entry on Network Clients 
(Required Only If No LAN Routers Are Installed)  . . . . . . . . . . . . . . . . . . . . . .490
Joining the Network Clients to the Domain . . . . . . . . . . . . . . . . . . . . . . . . . . . .490
Creating and Configuring DNS Entries in 
the Domain DNS, Including WPAD Entries . . . . . . . . . . . . . . . . . . . . . . . . . . . .490
Configuring the Firewall and Web Proxy Client 
Settings on the Edge ISA Firewall, and Enabling Autodiscovery . . . . . . . . . . . . . .493
Installing the Firewall Client Share on the Network Services Segment File Server 497
Installing the Firewall Client on the Network Clients  . . . . . . . . . . . . . . . . . . . . .499
Connecting the Corporate Network Clients to 
Resources on the Network Services Segment and the Internet  . . . . . . . . . . . . . .501
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .502
Chapter 11 DMZ Router and Switch Security . . . . . . . . . . . . . . . . . . . . 503
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .504
Securing the Router  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .504
Router Placement in a DMZ Environment  . . . . . . . . . . . . . . . . . . . . . . . . .504
Border Gateway Protocol  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .509
Access Control Lists  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .516
Disabling Unneeded IOS features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .537
Other Security Features  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .543
Securing the Switch  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .544
Cisco Switches  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .544
Securely Managing Switches  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .554
Disabling Unneeded IOS Features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .559
VLAN Trunking Protocol  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .560
VLANs  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .561
Private VLANS  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .565
Securing Switch Ports . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .569
IOS Bugs and Security Advisories  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .570
DMZ Router and Switch Security Best-Practice Checklists  . . . . . . . . . . . . . . . .571
Router Security Checklist . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .571
Switch Security Checklist  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .572
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .574
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .574
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .576
Chapter 12 DMZ-Based VPN Services. . . . . . . . . . . . . . . . . . . . . . . . . . . 577
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .578
VPN Services in the DMZ  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .579
VPN Deployment Models  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .580
Topology Models  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .585
Business Partner Connections  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .590
Remote Access Services  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .591
Designing an IPSec Solution  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .598
Designing an IPSec Encryption Scheme  . . . . . . . . . . . . . . . . . . . . . . . . . . .599

xviii
Contents
Designing an IPSec Management Strategy  . . . . . . . . . . . . . . . . . . . . . . . . . .600
Designing Negotiation Policies  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .601
Designing Security Policies  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .604
Designing IP Filters  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .605
Defining Security Levels  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .605
Connecting B2B Sites  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .605
Extranets  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .606
VPN Security . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .606
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .610
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .611
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .613
Chapter 13 Windows Bastion Hosts . . . . . . . . . . . . . . . . . . . . . . . . . . . 615
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .616
Configuring Bastion Hosts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .616
Testing Bastion Host Security  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .617
Vulnerability Scanning  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .617
Using Vulnerability Scanning Results to Harden Bastion Hosts . . . . . . . . . . .621
Configuration Fundamentals  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .622
Domain Members or Standalone Servers  . . . . . . . . . . . . . . . . . . . . . . . . . . .623
Installation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .624
Server and Domain Isolation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .640
Remote Administration  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .644
Using Terminal Services for Remote Administration (Windows 2000) . . . . . .644
Using RDP for Remote Administration (Windows 2003)  . . . . . . . . . . . . . .649
Bastion Host File Replication  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .650
Command-Line Administration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .650
Bastion Host Configurations  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .652
Configuring an IIS5 Server for Web Access  . . . . . . . . . . . . . . . . . . . . . . . . .652
Configuring an IIS6 Server for Web Access  . . . . . . . . . . . . . . . . . . . . . . . . .654
Configuring an IIS Server for SMTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .658
Bastion Host Maintenance and Support  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .660
Windows Bastion Host Checklist . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .660
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .660
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .661
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .662
Chapter 14 Linux Bastion Hosts. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 663
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .664
System Installation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .664
Disk Partitions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .665
Choosing a Linux Version . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .665
Removing Optional Components  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .668
Minimizing Services  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .668
Removing Optional Software  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .670
Choosing a Window Manager . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .674
Additional Steps  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .674

Contents
xix
Configure Automatic Time Synchronization  . . . . . . . . . . . . . . . . . . . . . . . .674
Patching and Updates  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .676
Removing SUID Programs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .678
SELinux Policy Development  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .678
TCP/IP Stack Hardening  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .680
Automated Hardening Scripts  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .681
Controlling Access to Resources  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .682
Address-Based Access Control  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .683
Auditing Access to Resources  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .687
Enabling the Audit Daemon  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .687
Enabling the Syslog Daemon . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .688
Viewing and Managing the Logs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .688
Remote Administration  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .691
SSH . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .691
Remote GUI  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .693
Bastion Host Configurations  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .693
Configuring a Web Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .694
Configuring an FTP Server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .695
Configuring an SMTP Relay Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .696
Configuring a DNS Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .697
Bastion Host Maintenance and Support  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .698
Linux Bastion Host Checklist  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .699
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .700
Solutions Fast Track . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .700
Frequently Asked Questions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .702
Index. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 703
Appendices A, B, C, and D can be downloaded from
www.syngress.com/solutions. 
Appendix A Intrusion Detection in the DMZ . . . . . . . . . . . . . . . . . . . . . A:1
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:2
Intrusion Detection 101  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:6
Deployment of an IDS . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:11
Repelling the Hacker . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:17
Honeypots in the DMZ  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:19
Host-Based Intrusion Detection Systems  . . . . . . . . . . . . . . . . . . . . . . . . . .A:21
Tripwire . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:23
Saving the DNS Server  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:24
Keeping the Web Server Serving  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:27
Cisco Enterprise IPS Management  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:29
Understanding the Cisco Management Center for IPS Sensors  . . . . . . . . . . . . .A:30
IPS MC & Security Monitor . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:30
The MC for IPS Sensors & Sensors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:31
MC for IPS Sensors & Signatures  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:31
MC for IPS Sensors & Security Policy . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:32

xx
Contents
Installing the Cisco IPS Management Center  . . . . . . . . . . . . . . . . . . . . . . . . . .A:33
Server Hardware Requirements  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:34
CiscoWorks Architecture Overview  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:34
VMS Component Compatibility  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:37
Client Installation Requirements  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:37
Installation Steps  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:38
Getting Started  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:39
Authorization Roles  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:40
Installation Verification  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:40
Adding Users to CiscoWorks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:41
The MC for IPS Sensors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:43
Setting up sensors and sensor groups . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:43
MC for IPS Sensors Hierarchy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:45
Creating Sensor Subgroups  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:45
Adding Sensors to a Sensor Group . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:47
Deleting Sensors from a Sensor Group . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:50
Deleting Sensor Subgroups  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:51
Configuring Signatures and alarms  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:52
Configuring Signatures  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:52
How to generate, approve and deploy IPS sensor configuration files . . . . . . . . . .A:57
Reviewing Configuration Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:57
Generating Configuration Files  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:58
Approving Configuration Files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:58
Deploying Configuration Files . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:59
Configuring Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:61
Audit Log Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:61
Generating Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:62
Viewing Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:63
Exporting Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:63
Deleting Generated Reports  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:63
Edit Report Parameters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:64
Example of IPS Sensor Versions Report Generation  . . . . . . . . . . . . . . . . . .A:64
Security Monitor Reports . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:66
Administering the Cisco MC for IPS Sensors server  . . . . . . . . . . . . . . . . . . . . .A:67
Database Rules  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:67
Updating Sensor Software and Signatures . . . . . . . . . . . . . . . . . . . . . . . . . .A:69
Defining the E-mail Server Settings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:69
Snort  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:70
The Poor Man’s IDS  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:90
Network Time  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:93
More IDS Deployment Strategies . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:94
Case Study  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:96
Lessons Learned . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:97
Summary  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:98
Solutions Fast Track  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:99
Bibliography  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:104

Contents
xxi
Appendix B Testing the DMZ . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . A:109
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:110
Reconnaissance and Penetration Testing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:113
Defense in Depth  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:113
Recon 101  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:116
Scanning Techniques  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:126
Attacking the DMZ Hosts  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:155
DNS Exploits  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:155
Other Attack Methods . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:171
DMZ Hardening Checklist  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:173
Testing Made Easy  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:174
Live Linux Distributions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:174
Metasploit Framework . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:175
Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:176
Solutions Fast Track  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:177
Frequently Asked Questions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:179
Appendix C IIS Web Server Hardening . . . . . . . . . . . . . . . . . . . . . . . . A:183
Introduction  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:184
Understanding Common Vulnerabilities Within Microsoft IIS Web Server  . . . .A:184
Poor Application Configuration  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:185
Unsecured Web-Based Code  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:185
Inherent IIS Security Flaws  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:185
Foundational Microsoft OS Vulnerabilities  . . . . . . . . . . . . . . . . . . . . . . . .A:185
Patching and Securing the OS  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:185
Patching the Microsoft Operating System . . . . . . . . . . . . . . . . . . . . . . . . .A:186
Configuring a Secure Operating System . . . . . . . . . . . . . . . . . . . . . . . . . .A:186
Configuring Windows Firewall  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:188
Disabling Vulnerable Services . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:190
Hardening the IIS Application  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:191
IIS Installation Options and Basic Services Setup  . . . . . . . . . . . . . . . . . . .A:192
Virtual Directories, Script Mappings, and ISAPI Filters  . . . . . . . . . . . . . . .A:192
Logging  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:193
Monitoring the Server for Secure Operation . . . . . . . . . . . . . . . . . . . . . . . . . .A:194
Appendix D Apache Web Server Hardening. . . . . . . . . . . . . . . . . . . . A:197
Understanding Common Vulnerabilities Within Apache Web Server  . . . . . . . .A:198
Poor Application Configuration  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:198
Unsecured Web-Based Code  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:198
Inherent Apache Security Flaws  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:198
Foundational OS Vulnerabilities . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:199
Patching and Securing the OS  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:199
Patching Unix, Linux, and BSD Operating Systems  . . . . . . . . . . . . . . . . .A:200
Configuring a Secure Operating System . . . . . . . . . . . . . . . . . . . . . . . . . .A:200
Hardening the Apache Application  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:200
Prepare the OS for Apache Web Server  . . . . . . . . . . . . . . . . . . . . . . . . . .A:201
Acquire, Compile, and Install Apache Web Server Software  . . . . . . . . . . . .A:202
Configure the httpd.conf File  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .A:206
Monitoring the Server for Secure Operation . . . . . . . . . . . . . . . . . . . . . . . . . .A:214


DMZ Concepts,
Layout, and
Conceptual Design
Solutions in this chapter:
■
Planning Network Security 
■
DMZ Deﬁnitions and History 
■
DMZ Design Fundamentals
■
Advanced Risks
■
Advanced Design Strategies
Chapter 1
1
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
Since the dawn of the Internet Age, we have witnessed the constant advance of innovative
technologies and enjoyed a continuous expansion of access, convenience, and power that
networked computer systems provide. From unparalleled communications around the globe
to the simple act of paying bills from a cellular phone, it seems that nothing is impossible.
Yet, with this progress comes a similarly constant and increasing threat against our privacy,
our ﬁnancial security, and the very lifestyle we treasure.
Each year brings news of larger and more devastating technological security inci-
dents in both commercial and federal sectors. Last year, we saw the compromise of several
massive credit card databases, including Card Systems and Lowe’s. Just recently, conﬁdential
data, including the Social Security numbers and medical histories of thousands of U.S. vet-
erans was stolen, only to be recovered later. Was the data that held the identity of those vet-
erans copied and sold? Will that singular incident cost the U.S. government millions of
dollars and wreak havoc on thousands of citizens?  
The statistical trends of security incidents have not and will not decline; our increased
access to more valuable and critical data provides too great an incentive to amateur hackers
and professional criminals.The Mazu Networks 2006 Internal Threat Report ﬁnds that,
“although enterprises are clearly more educated and aware of the risks posed by internal net-
work vulnerabilities than ever before, they continue to fall victim to a growing number of
attacks that circumvent perimeter and endpoint security solutions. In 2005, malicious attacks
became increasingly ominous, with a large number of incidents focused on criminal activities
such as identity theft and extortion versus traditional hacker exploits such as Web site
defacement or vandalism.Additionally, network services such as instant messaging, IP tele-
phony and SOAP/XML joined existing attack vectors like e-mail, Web trafﬁc and browser-
based exploits.This growth in attack type, frequency and vector has exceeded the capabilities
of traditional security technologies and has rendered status quo defense strategies ineffective.”
So, what then are our options as security professionals? What actions can we take to pro-
tect against these threats? One step is the secure design of computer services networks or
demilitarized zones (DMZs).A DMZ is a network construct that provides secure segregation
of networks that host services for users, visitors, or partners.This separation is accomplished
using ﬁrewalls and multiple layers of ﬁltering to control access and protect critical systems.
This book is designed to be a deﬁnitive work for your use in understanding the concepts of
protection, the terminology and components of DMZ structure, and DMZ design in enter-
prise networks.
Along the way, the authors of this book will provide you with the information you need
to appropriately design, implement, monitor, and maintain a secure and functional DMZ
structure.The book contains not only the theory, but the “how to” information that you
require to successfully protect your networks from attack. Information is available about var-
ious DMZ-related hardware and software implementations (including Cisco PIX and ASA,
Nokia, Check Point, Microsoft ISA Server, and others) that will be useful in planning and
implementing your own DMZ.
www.syngress.com
2
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Chapter 1 provides a great deal of background information to refresh your knowledge
of security concepts and deﬁnes DMZ terminology to improve your understanding and
create a common ground for subsequent chapters in the book.This chapter also explores
DMZ design basics before expanding into advanced risks and the advanced designs that
might be used to better protect your networks.After reviewing these basic concepts, Chapter
2 discusses the procedures and placement for Windows-based services within the DMZ and
internal networks, and Chapter 3 covers UNIX-based services within the DMZ and internal
networks. It is imperative that you read this ﬁrst section of the book because it will give you
the underlying fundamentals and concepts you need to accurately design a DMZ.
Planning Network Security 
Successfully implementing security for your network and computer systems begins with a
written plan that is evaluated and accepted by all critical stakeholders in your organization.
This initial plan will be used to deﬁne the starting parameters for security policies and the
overall direction and goals for your protection plan.The plan will contain the decision-
making information leading to the design of a functional DMZ that meets the needs and
level of protection for your organization.
Planning for network security requires an evaluation of the risks involved with loss of
data, unauthorized access to data, and information compromise, among other things.The
plan must consider cost factors, staff knowledge and training, and the hardware and platforms
currently in use in the current and future organization.As we will see, the DMZ plan and
concept provides a multilayered security capability, but as with anything that involves mul-
tiple components, administration costs and equipment costs increase with the complexity of
the design.
Fortunately, there are many templates and published standards to assist you in the cre-
ation of functional security plans.These blueprints must be customized to match your needs
and environment, but they provide excellent and holistic examples of things to consider in
your own plan. We’ll discuss some of these products later in the chapter.
Finally, it should be understood that no security plan is ever a ﬁnal plan. Instead, we
work continuously to revise and update the plan in an ongoing effort to provide the best
possible coverage that minimizes the risk of intrusion and damage in an evolving environ-
ment. Of course, before we can provide a meaningful and effective evaluation of the areas we
need to protect, we must understand the components that have to be protected. In the next
few sections of this chapter, we look more closely at the fundamentals of security and deﬁne
more precisely what exactly we are trying to protect.
Security Fundamentals
When discussing the fundamentals of security in our networks, we use the conﬁdentiality,
integrity, and availability (CIA) triad model as a starting point.This CIA triad provides security
professionals with the paths they needed to assess their security stance and a set of rules that
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
3

make it somewhat easier to group tools and procedures for evaluation. Using CIA as an evalua-
tion method is still a good practice and sound methodology today, but we must consider a
number of other factors that weren’t covered at the time that the CIA concept was developed.
Until a few years ago, for instance, providing CIA for our infrastructure included the use
of simple proxy-based ﬁrewalls combined with Network Address Translation (NAT) between
outside (untrusted) networks and our internal (trusted) network.At that time, that system
served the purpose for which it was designed; it provided a perimeter defense between the
untrusted and trusted security zones and limited access to internal networks and services.
Figure 1.1 illustrates the original conﬁguration we might have used.
Figure 1.1 Original Basic Firewall Conﬁguration
Since those days, however, we’ve greatly expanded the role of our network infrastructure
and system resources to provide information to employee, partner, and public requests for
information. We provide varied data to different types of consumers, so it makes sense to
segment these service networks in different ways.Additionally, the freely available tools and
the relative ease with which various probing and spooﬁng attacks can be mounted force us
to isolate our networks and protect the information that is contained in them.That same
growth in the availability of tools and attack methodologies has necessitated the expansion of
the CIA concepts that were originally handled through a single-ﬁrewall design.A new,
greatly expanded multilayer approach must be employed to ensure proper protection of our
assets.This is where we begin to consider the use of the DMZ concept, allowing us to better
segregate and divide our networks. Figure 1.2 demonstrates a generic DMZ conﬁguration.
www.syngress.com
4
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Untrusted Network Zone
Internal Users
Corporate Servers
The Internet
`
`
`
Firewall
Internal Network Zone

Figure 1.2 Generic DMZ Conﬁguration
One reason for this new design is our need to provide services to some employees and
others outside of the Internal Network Zone environment when we might not want to
allow those services to be available to everyone.The addition of the extra layer of ﬁltering
provided by the second ﬁrewall (or more) in the control environment allows us to more
ﬁnely control access to the data and servers hosting that data.This in turn allows us to more
fully implement the second part of the triad, integrity. If we can control these access points
more closely through access control lists and user accounts, for instance, it is much more
likely that we will succeed in maintaining the integrity of the data and keeping it in a pro-
tected and undamaged state.
Perhaps more important, including additional security zones in the form of DMZs limits
the scope of systems vulnerabilities; compromised systems on untrusted or DMZ networks
may present less of a potential threat to critical, internal-only systems.As we’ll see through
our study in this book, the DMZ design and ﬂexibility contribute greatly to the adminis-
trator’s ability to ensure CIA and still provide services to those who need them.
NOTE
The ﬁrewall conﬁgurations we will use act primarily to route and restrict trafﬁc
ﬂow to and from particular network segments. As we will see in later sections
of the chapter, those conﬁgurations are varied and depend on required protec-
tions and functionality.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
5
Internal Users
Corporate Servers
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone

Identifying Risks to Data
As we continue to review the basics of security, it is necessary to understand some of the
risks that occur in relation to our data. One of the important things we have learned as sys-
tems operators and administrators is that it is paramount to protect the data that we are
charged with controlling, maintaining, and providing. We understand that there is a necessity
to perform backup operations, provide disaster recovery services, and generally keep the
information highly available and intact. While you prepare to develop your plan for protec-
tion, consider that there are now many more potential causes of data loss and corruption
than at any time previously in the history of computing. Here are a few of the ways data can
be lost:
■
Hardware failure
■
Power disruption
■
External attacks:
■
Enumeration of your network
■
Access to conﬁdential data
■
Modiﬁcation of critical data
■
Destruction of data
■
Internal attacks:
■
Unauthorized access
■
Theft of information
■
Disclosure of information to others
■
Destruction of data
■
Natural and other disasters:
■
Water, ﬂooding
■
Fire
■
Ground movement
■
Weather disasters (hurricanes, tornados, ice storms, others)
■
War
Human and software failures:
■
Inadvertent deletion of data
■
Corruption of data
www.syngress.com
6
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

■
Disregard for physical security of equipment/network
■
Conﬁguration errors
Are all these risks to data relevant to the DMZ? Although it’s possible that not all will
relate directly to the consideration of your DMZ and its implementation, we’ll see that the
overall planning required for the DMZ and its design must incorporate overall, systematic
security planning.Thus, we must consider all these potential problem areas as risks when we
plan to provide protection for the data sources in our systems.
Identifying Risks to Services
Maintaining the security of services being provided to partners, employees, and customers
can be a difﬁcult task.The continued growth of shared information and the availability of
technologies providing network-based information and services to an ever-growing user base
outside our internal networks generate a number of risks to the information we provide.
Additional sources of risk are created through the multitude of services we provide to the
end user. With each passing day, customer demand for functionality grows. What was once
simply e-mail, Web, and secure online purchasing now involves mobile technologies such as
personal digital assistants (PDAs), mobile phones, and wireless services. New protocols and
languages are developed to accommodate new functions but are delivered with evolving vul-
nerabilities that create risk to the services we offer individuals and companies outside our
internal networks. Some of the things that can be classiﬁed as risks to services are:
Denial-of-service (DoS) attacks:
■
Unauthorized use of services such as mail relaying
■
Compromise of poorly conﬁgured system and services, such as:
■
DNS server zone transfers 
■
Active and unprotected Telnet service 
■
File Transfer Protocol (FTP) server ﬁle root unsecured or not otherwise 
protected
■
Interception or diversion of services or service information
Unauthorized remote control of systems
As you can see, the risks of service disruption are not limited to failure of our systems; they
also incorporate the risks of attack and lack of availability of services provided to us by others
that could impact our operation. It must be understood that every service has inherent vulner-
abilities. Our job as security professionals is to fully identify, understand, and overcome these
vulnerabilities through secure conﬁguration and proper network design.To assist in this effort,
the SANS Institute publishes the most common services vulnerabilities on its Web site, at
www.sans.org/top20.We must anticipate those risks as we design our security plans.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
7

Identifying Potential Threats
As you prepare your overall security plan and DMZ, it is important that you identify and
evaluate the potential risks and threats to your network, systems, and data.You must evaluate
your risks thoroughly during the identiﬁcation process and assign priority to the risks. This
will help determine the order in which you gain funding and apply protection, thereby
reducing the likelihood of loss resulting from those risks and threats if they materialize.This
methodology should be applied to anything that could potentially disrupt, slow, or damage
your systems, data, or credibility. Some potential threats to consider include:
■
Outside hacker attacks:
■
Trojans, worms, and virus attacks
■
DoS or distributed denial-of-service (DDoS) attacks
■
Compromise or loss of internal conﬁdential information
■
Network monitoring and data interception 
■
Internal attacks by employees
■
Hardware failures
■
Loss of critical systems
This identiﬁcation process creates the basis for your security plan, policies, and imple-
mentation of your security environment.You should realize that this is an ongoing evaluation
and is subject to change as conditions evolve within your company and its associated assets.
We have learned that security is a process and is never truly “ﬁnished.” However, a good
basic evaluation goes a long way toward creating the most secure system that we can achieve.
Introducing Common Security Standards
Security and network professionals use a number of currently accepted procedures and stan-
dards to conduct our business and ensure that we are following industry best practices.
Although we, as network and systems administrators, have a responsibility to try to attain
perfection in the availability and integrity of our data, we also have constraints placed on us
in accomplishing those conditions.Those constraints include budgets, physical plant capa-
bility, and training of users and technicians to maintain the security and integrity of the data.
These constraints do not relieve us of our responsibility for maintaining the data safely and
securely.To that end, we currently employ some accepted security standards that help us per-
form our tasks to the best possible level. In this section, we review some of the common
security standards and brieﬂy discuss them:
■
Conﬁdentiality, integrity, and availability (CIA) CIA is a commonly
accepted benchmark for evaluating information systems security. Over the past few
years, the CIA processes have expanded to include more comprehensive guidelines
www.syngress.com
8
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

that incorporate the process of deﬁning risk and use of risk management tools to
provide a more complete method of protection.The components of CIA are:
■
Conﬁdentiality infers that individuals have access to only that which they are
expressly permitted. It involves privacy of communications, secure storage of
sensitive data, and granular control for the authentication, authorization, and
auditing of system use.
■
Integrity relates to the validity of data, which means our information is pro-
tected from corruption, modiﬁcation, or deletion while it is stored, used, or
transmitted.
■
Availability means continual accessibility to our networks, systems and data. It
includes the aspects of resistance to attack, proper scalability, redundancy, con-
tingency systems, and ease of use.
■
Least privilege  This concept is used by the security team to deﬁne levels of
access to resources. Individuals should have access to only what is necessary to do
their jobs. Denying access by default and providing access by exception is also part
of least privilege.As security professionals, we know this can be a challenging task,
but it is potentially the largest cause of internal security breaches.
■
Defense in depth The idea that no single system, methodology, or human being
can individually secure an environment leads us to the concept of defense in
depth. In principle, the concept implies a multitiered approach to provide security.
Some simple examples of defense in depth include the use of vendor ﬁrewalls, the
application of several types of intrusion prevention systems (IPS) or intrusion
detection systems (IDS), and, of course, the use of DMZs to protect our network.
Holistically, defense in depth involves the use of multiple types of defense strategies
that, in aggregate, provide a comprehensive security stance.
Remember, too, that security involves multiple dimensions that should be applied when
creating our security plans.These include:
■
Physical  The hardware that stores data and provides services must remain physi-
cally inaccessible to unauthorized users.A secure physical environment prevents
access to systems using cipher locks, biometrics, smart cards, and other technologies.
■
Personnel  The individuals responsible for system administration, security, and
maintenance in your company must be trusted and reliable. Proper human
resources practices such as background veriﬁcation and routine law enforcement
checkups can help ensure a trusted workforce.
■
Procedural  Perhaps the most critical dimension to security is procedural aware-
ness. Human mistakes due to improper training, missing written procedures, or
sheer incompetence presents an enormous risk to your company.To offset this risk,
training must be an essential part of your security plan.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
9

■
Technical For each new threat we face, a solution will eventually be developed.
These are the technical responses to these threats that you will deploy as part of
your overall security plan and may include ﬁrewalls, IPS, IDS, aggregation and cor-
relation facilities, to name a few.
These are the fundamental and standard aspects of security. Now let’s revisit some of the
means by which we construct our security policies, plans, and procedures.
Policies, Plans, and Procedures
Earlier in this chapter, we mentioned that it is important to provide and conduct an initial
baseline security audit and institute a security plan for the organization.Along with this
practice, it is equally important to provide adequate information not only to the individuals
in charge of security, but to everyone in the organization. Everyone must cooperate in this
plan to achieve the desired goal of information and services security and integrity in your
environment.To that end, we must provide additional service beyond the security evaluation
and plan.This means working with a planning team that includes legal, human resources, and
management input to prepare the documentation.
At a minimum, your security plan should provide documentation and supporting work
that includes:
Acceptable-use policies:
■
Permitted activities
■
Disciplines for infractions
■
Auditing policies
■
Disaster recovery plans
■
Reporting hierarchy and escalation paths
■
Overall security policy:
■
What needs protection and from what type of attack?
■
What methodologies will be utilized for protection?
■
Who is responsible for implementation, monitoring, and maintenance?
■
Risk analysis—what is vulnerable and what is the impact if
lost/damaged/compromised?
■
Growth and service needs projections
User training and education plans
As previously mentioned, there are several bodies of work that we can leverage to com-
plete a comprehensive security policy and plan. One such document is ISO/IEC 17799:2005,
which establishes guidelines and general principles for initiating, implementing, maintaining,
www.syngress.com
10
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

and improving information security management in an organization.Although everything
within the ISO/IEC 17799 standard might not apply to your speciﬁc objectives, it is an invalu-
able source of elements included in a holistic plan and makes an excellent reference.
The objectives set forth in the standard include general guidance on typical goals of
information security and provides best practices in information security management,
including:
■
Security policy
■
Organization of information security
■
Asset management
■
Human resources security
■
Physical and environmental security
■
Communications and operations management
■
Access control
■
Information systems acquisition, development, and maintenance
■
Information security incident management
■
Business continuity management
■
Compliance
This standard is provided as a practical guideline in developing security standards
and effective security management practices.
Many documents and processes are necessary for the proper implementation and
enforcement of a security stance after delivery of your overall security plan. Figure 1.3 pro-
vides a brief pictorial view of what is involved in the security policy planning stage.This
process is necessary and must be completed and maintained throughout your company’s life
span before proceeding to the tasks of designing the DMZ. Without the security policy in
place, DMZ design may be ineffective and not cost-effective, because it may have to be
reconﬁgured to ﬁt with the organization’s overall security needs.
DMZ Deﬁnitions and History 
In the security fundamentals section of this chapter, we began to discuss some of the termi-
nology and deﬁnitions relating to our work with DMZ structure and its components. Before
we proceed to a more in-depth discussion of the DMZ, we need to review the deﬁnitions its
components. Furthermore, we’ll brieﬂy discuss the history of the DMZ and the philosophy
that has led to its implementation for protection.To begin, we deﬁne some common terms
that we will use throughout the book as we discuss DMZs.Table 1.1 details and deﬁnes
these terms.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
11

Figure 1.3 The Path to Completion of a Security Policy Document
Table 1.1 DMZ Deﬁnitions
Term
Deﬁnition or Description
DMZ
In computer networks, a demilitarized zone, or DMZ, is a com-
puter host or small network inserted as a “neutral zone” between
a company’s private network and the outside public network. The
DMZ prevents outside users from getting direct access to a server
that has company data. (The term comes from the geographic
buffer zone that was set up between North Korea and South
Korea following the United Nations’ “police action” there in the
early 1950s.) 
Bastion host 
A machine (usually a server) located in the DMZ with strong 
(untrusted host)
host-level protection and minimal services. It is used as a gateway
between the inside and the outside of networks. The bastion host
is normally not the ﬁrewall but a separate machine that will
probably be sacriﬁcial in the design. The notation “untrusted
host” may be used because the bastion host is always considered
to be potentially compromised and therefore should not be fully
trusted by internal network clients.
Firewall
A hardware device or software package that provides ﬁltering
and/or provision of rules to allow or deny speciﬁc types of net-
work trafﬁc to ﬂow between internal and external networks.
Proxy server
An application-based translation of network access requests.
Provisions for local user authentication for access to untrusted
networks. Logging and control of port/protocol access may be
possible. Normally used to connect two networks.
www.syngress.com
12
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Security Policy
Lifecycle
Define 
Requirements
Identify 
Assets
Promote
Awareness
Monitor and
Improve
Design Security
Plan
Identify and
Analyze Risks
Obtain Approval
Document
Plan
Continued

Table 1.1 continued DMZ Deﬁnitions
Term
Deﬁnition or Description
Network Address 
Application-based translation of IP headers to masquerade 
Translation (NAT)
internal IP networks. Can be deployed in a one-to-one or one-to-
many relationship, Port Address Translation (PAT). Originally con-
ceived to provide additional IP space in the form of RFC 1918
addresses.  
Packet ﬁltering
The use of a set of rules to open or close ports to speciﬁc proto-
cols (such as allowing Transmission Control Protocol [TCP] or User
Datagram Protocol [UDP] packets) or protocol ID(s), such as
allowing or blocking Internet Control Message Protocol (ICMP).
Stateful packet 
A hardware- or software-based process in ﬁrewalls that inspect 
ﬁltering
transient ﬂows to ensure proper standards-based protocol
activity.  
Screened subnet
An isolated network containing hosts that need to be accessible
from both the untrusted external network and the internal net-
work. An example is the placement of a bastion host in a dual-
ﬁrewall network, with the bastion host in the network between
the ﬁrewalls. A screened subnet is often a part of a DMZ imple-
mentation.
Screening router
An often used initial screening method to limit trafﬁc to and
from a protected network. It may employ various methods of
packet ﬁltering and protocol limitation and act as a limited initial
ﬁrewall device.
Intrusion detection A hardware or software system that “listens” to transient 
system (IDS)
network ﬂows and sends alerts based on signature matching or
anomalous trafﬁc.  
Intrusion 
An inline hardware or software system that “listens” to transient 
prevention 
network ﬂows, sends alerts based on signature matching or 
system (IPS)
anomalous trafﬁc, and terminates malicious trafﬁc on detection. 
Honeypot or 
Devices or a network of devices that appear to have vulnerable 
honeynet
services but are actually used to collect information about poten-
tial threats, hackers, and malicious code access.
DMZ use has become a necessary method of providing a multilayered, defense-in-depth
approach to security.The use of DMZ structures developed as a response to evolving busi-
ness requirements in which increased numbers of services were deployed for multiple, yet
functionally disparate, consumers of data.These new technologies and designs have provided
a higher level of protection for the data and services we are charged with protecting.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
13

DMZ Concepts 
The use of a DMZ and its overall design and implementation can be relatively simple or
extremely complex, depending on the needs of the particular business or network system.
The DMZ concept was born as the need for separation of networks became more acute; we
began to provide more access to services for individuals or partners outside our trusted,
internal network infrastructure.A primary reason that the DMZ is a critical component of
security design is the realization that a single type of protection is subject to failure.This
failure can arise from conﬁguration errors, planning errors, equipment failure, or deliberate
action on the part of an internal employee or external attack force.The DMZ has proven to
be more secure and to offer multiple layers of protection for the security of the protected
networks and machines. Over time, it has proven to be very ﬂexible, scalable, redundant, and
robust in its ability to provide the ongoing protection companies need. DMZ design now
includes the ability to use multiple products (both hardware- and software-based) on mul-
tiple platforms to achieve the necessary level of protection.
To provide a common understanding of DMZ design, let’s examine a number of con-
ceptual paths for trafﬁc ﬂow into service networks and DMZs. Before we look at the con-
ceptual paths, let’s make sure that we understand the basic conﬁgurations and layouts that can
be used for ﬁrewall and DMZ network. In the following ﬁgures, we’ll see and discuss these
conﬁgurations. Please note that each of these conﬁgurations is useful to protect assets on
both internal and external networks such as the Internet. Our ﬁrst conﬁguration is shown in
Figure 1.4.
Figure 1.4 A Basic Network With a Single Firewall
www.syngress.com
14
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Untrusted Network Zone
Internal Users
The Internet
`
`
`
Firewall
Internal Network Zone

In Figure 1.4, we can see the basic conﬁguration that would be used in a simple net-
work situation where there was no need to provide external services.This conﬁguration
would typically be used to begin to protect a small business or home network. It could also
be used within an internal network to protect an inner network that needed to be divided
and isolated from the main network.This situation could include payroll, ﬁnance, or devel-
opment divisions that must protect their information and keep it away from general network
use and view.
Figure 1.5 details a protection design that would allow for the implementation and pro-
vision of services outside the protected network. In this design, it would be absolutely
imperative that rules be enacted to not allow the untrusted host to access the internal net-
work. Security of the bastion host machine would be accomplished on the machine itself,
and only minimal and absolutely necessary services would be enabled or installed on that
machine. In this design, we might be providing a Web presence that did not involve e-com-
merce or the necessity to dynamically update content.This design would not be used for
provision of virtual private network (VPN) connections, File Transfer Protocol (FTP) ser-
vices, or other services that required other content updates to be performed regularly.
Figure 1.5 Basic Network, Single Firewall and Bastion Host (Untrusted Host)
Figure 1.6 shows a basic DMZ structure. In this design, the bastion host is partially pro-
tected by the ﬁrewall. Rather than the full exposure that would result to the bastion host
shown in Figure 1.5, this setup would allow us to specify that the bastion host in Figure 1.6
could be allowed full outbound connection, but the ﬁrewall could be conﬁgured to allow
only port 80 trafﬁc inbound to the bastion host (assuming it was a Web server) or others as
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
15
Internal Users
Bastion Host
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone

necessary for connection from outside.This design would allow connection from the internal
network to the bastion host if it was necessary.This design would potentially allow updating
of Web server content from the internal network if allowed by a ﬁrewall rule, which could
allow trafﬁc to and from the bastion host on speciﬁc ports, as designated. (There is more on
that topic later in the chapter.)
Figure 1.6 A Basic Firewall With a DMZ
Figure 1.7 shows a generic multitiered DMZ conﬁguration. Because ﬁrewalls are now
capable of virtualization through inspection of 802.1q Virtual LAN (VLAN) tags, we no
longer require physically separate ﬁrewalls or ﬁrewall interfaces. In this arrangement, a single
trunked interface is connected to the DMZ, and the ﬁrewall enforces separate security poli-
cies based on the inspected VLAN tags.This conﬁguration is recommended when your
DMZ networks exist within the same security zone. Should you have separate security zones
for your DMZ, you may wish to provide physical separation on multiple switches to mitigate
VLAN hopping risks.The bastion host can be protected from the outside and allowed to
connect to or from the internal network, or even another separate DMZ network. In this
arrangement, like the conditions in Figure 1.6, ﬂow can be controlled to and from both of
the networks, away from the DMZ.This conﬁguration and method are more likely to be
used if more than one bastion host is needed or if a traditional multitiered application envi-
ronment is present in the DMZ.
www.syngress.com
16
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Internal Users
Bastion Host
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone

Figure 1.7 A Multitiered Firewall With a DMZ
Trafﬁc Flow Concepts
Now that we’ve had a quick tour of some generic designs, let’s take a look at the way net-
work trafﬁc typically ﬂows through these designs. Be sure to note the differences between
the levels and the ﬂow of trafﬁc and protections offered in each design.
Figure 1.8 illustrates the ﬂow pattern for information through a basic single-ﬁrewall
setup.This type of trafﬁc control can be achieved through hardware or software and is the
basis for familiar products such as Internet Connection Sharing (ICS) and the NAT func-
tionality provided by digital subscriber line (DSL) and cable modems used for connection to
the Internet. Note that ﬂow is unrestricted outbound, but the basic conﬁguration will drop
all inbound connections that did not originate from the internal network.
Figure 1.9 reviews the trafﬁc ﬂow in a network containing a bastion host and a single
ﬁrewall.This network conﬁguration does not produce a DMZ; the protection of the bastion
host is conﬁgured individually on the host and requires extreme care in setup. Inbound
trafﬁc from the untrusted network or the bastion host is dropped at the ﬁrewall, providing
protection to the internal network. Outbound trafﬁc from the internal network is allowed.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
17
Internal Users
Bastion Host
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone 1
Internal Network Zone
Bastion Host
Demilitarized 
Network Zone 2

Figure 1.8 Basic Single-Firewall Flow
Figure 1.9 A Basic Firewall With Bastion Host Flow
Figure 1.10 shows the patterns of trafﬁc as we implement a DMZ design. In this form,
inbound trafﬁc ﬂows through to the bastion host if allowed through the ﬁrewall and is
dropped if destined for the internal network.Two-way trafﬁc is permitted as speciﬁed
between the internal network and the bastion host, and outbound trafﬁc from the internal
network ﬂows through the ﬁrewall and out, generally without restriction.
www.syngress.com
18
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Untrusted Network Zone
Internal Users
The Internet
`
`
`
Firewall
Internal Network Zone
Permitted Flows
Denied Flows
Legend
Bastion Host
Untrusted Network Zone
Internal Users
The Internet
`
`
`
Firewall
Internal Network Zone
Permitted Flows
Denied Flows
Legend

Figure 1.10 A Basic Single Firewall With DMZ Flow
Figure 1.11 contains a more complex flow path for information but provides the most
capability in these basic designs to allow for configuration and provision of services to the
outside. In this case, we have truly established a DMZ, separated and protected from both
the internal and external networks.This type of configuration is used quite often when
there is a need to provide more than one type of service to the public or outside world,
such as e-mail, Web servers, DNS, and so forth.Traffic to the bastion host can be allowed
or denied as necessary from both the external and internal networks, and incoming traffic
to the internal network can be dropped at the external firewall. Outbound traffic from the
internal network can be allowed or restricted either to the bastion host (DMZ network)
or the external network.
As you can see, there is a great amount of flexibility in the design and function of
your protection mechanisms. In the sections that follow, we expand further on conditions
for the use of various configurations and on the planning that must be done to implement
them.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
19
Internal Users
Bastion Host
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone
Permitted Flows
Denied Flows
Legend

Figure 1.11 A Multitiered Firewall With a DMZ Flow
Networks With and Without DMZs 
As we pursue our discussions about the creation of DMZ structures, it is appropriate to also
take a look at the reasoning behind the structures of the DMZ and when and where we’d
want to implement a DMZ or perhaps use some other alternative.
During our preview of the concepts of DMZs, we saw in Figures 1.4–1.7 some exam-
ples of potential designs for network protection and access.Your design may incorporate any
or all of these types of conﬁgurations, depending on your organization’s needs. For instance,
Figure 1.4 shows a conﬁguration that may occur in a home network installation or perhaps
with a small business environment that outsources its services or information for customers
at a collocation facility.This design would be suitable under these conditions, provided that
conﬁgurations are correct and monitored for change.
Figure 1.5 illustrates a network design with a bastion host located outside the ﬁrewall. In
this design, the bastion host must be stripped of all unnecessary functionality and services
and protected locally with appropriate ﬁle permissions and access control mechanisms.This
design is suitable for an organization that provides minimal services to an external network,
such as a simple Web server.Access to the internal network from the bastion host is generally
not allowed, because the bastion host is subject to compromise and therefore untrusted.
Figure 1.6 details the ﬁrst of the actual DMZ designs and incorporates a screened
subnet. In this type of design, the ﬁrewall controls the ﬂow of information from network to
network and provides more protection to the bastion host from external ﬂows.This design
might be used when it is necessary to regularly update the content of a Web server or pro-
www.syngress.com
20
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Internal Users
Bastion Host
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone 1
Internal Network Zone
Protected 
Host
Demilitarized 
Network Zone 2
Permitted Flows
Denied Flows
Legend
HTTPS Only
RDBMS Only

vide a front end for mail or other services that need contact with both the internal and
external networks.Although better for security purposes than Figure 1.5, this design still
infers an untrusted relationship between the bastion host and the internal network.
Finally, Figure 1.7 provides a design that allows for the placement of many types of ser-
vice in the DMZ.Trafﬁc can be very ﬁnely controlled between the various networks
through access at the ﬁrewall, and services can be provided at multiple levels to both internal
and external networks.
In the next section, we proﬁle some of the advantages and disadvantages of the common
approaches to DMZ architecture and provide a checklist to help you decide what is appro-
priate for your DMZ design.
Pros and Cons of DMZ Basic Designs
Table 1.2 details the advantages and disadvantages of the various types of basic design dis-
cussed in the preceding section.
Table 1.2 Pros and Cons of Basic DMZ Designs
Basic Design
Advantages
Disadvantages
Recommended Use
Single ﬁrewall
Inexpensive, fairly 
Much lower security Home, small 
easy conﬁguration, 
capabilities, no 
ofﬁce/home ofﬁce 
low maintenance
growth or expansion (SOHO), small business 
potential
with outsourced services
Single ﬁrewall 
Lower cost than 
Bastion host 
Small business with 
with bastion 
more robust 
vulnerable to 
minimal services and/or 
host
alternatives, simple 
compromise, 
static content that 
design
inconvenient to 
doesn’t require frequent 
update content, loss updates
of functionality 
other than for 
absolutely required 
services; not scalable
Single ﬁrewall 
Firewall provides 
Increased complexity, Larger businesses with 
with screened 
protection to both 
requires split DNS
multiple networks 
subnet and 
internal network and 
requiring access to the 
bastion host
bastion host, 
bastion host for 
limiting compromise 
dynamic information
risk while providing 
some ﬂexibility 
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
21
Continued

Table 1.2 continued Pros and Cons of Basic DMZ Designs
Basic Design
Advantages
Disadvantages
Recommended Use
Multitiered 
Allows for multiple 
Requires more 
Larger operations that 
ﬁrewall with 
service-providing 
hardware and 
require the capability to 
DMZ
hosts in the DMZ; 
software for imple-
offer multiple types of 
protects bastion 
mentation of this 
Web access and services 
hosts in the DMZ 
design; increased 
to both the internal and 
from other DMZ 
complexity, requires external networks 
host networks, 
more conﬁguration involved
allows ﬁne 
work and monitoring,
granularity of 
requires split DNS
control; limits 
fault domain 
after compromise
Conﬁguring & Implementing…
Bastion Hosts
Bastion hosts must be individually secured and hardened because they are always
in a position that could be attacked or probed. This means that before place-
ment, a bastion host must be stripped of unnecessary services, fully updated with
the latest patches and software updates, and isolated from other trusted
machines and networks.  This reduces the possibility that its compromise would
allow for connection to (and potential compromise of) the protected networks
and resources. This also means that a machine being used for this purpose should
have no user accounts relative to the protected network or directory services
structure, which could lead to enumeration of your internal network.
DMZ Design Fundamentals
DMZ design, like security design, is always a work in progress.As in security planning and
analysis, we ﬁnd DMZ design carries great ﬂexibility and change potential to keep the pro-
tection levels we put in place in an effective state. Ongoing work is required so that the
system’s security is always as high as possible within time and budget constraints while still
allowing appropriate users and visitors access to information and services.You will ﬁnd that
the time and funds spent in design and preparation for the implementation are very good
www.syngress.com
22
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

investments if the process is focused and effective; this effort will lead to a high level of suc-
cess and an optimal level of protection for the network you are protecting.
In this section of the chapter, we explore the fundamentals of the design process.To
make decisions about our initial design, we incorporate the information we discussed in rela-
tion to security and trafﬁc ﬂow.Additionally, we’ll build on that information and review
some other areas of concern that could affect the way we design our DMZ structure.
NOTE
In this section we look at design of a DMZ from a logical point of view. Physical
design and conﬁguration are covered in following chapters, based on the
vendor-based solution you choose to deploy. 
Why Design Is So Important
Design of the DMZ is critically important to the overall protection of your internal net-
work—and the success of your ﬁrewall and DMZ deployment.The DMZ design can incor-
porate sections that isolate incoming VPN trafﬁc, Web trafﬁc, partner connections, employee
connections, and public access to information provided by your organization. Design of the
DMZ structure throughout the organization can protect internal resources from internal
attack.As we discussed in the security section, it has been well documented that much of the
risk of data loss, corruption, and breach actually exists inside the network perimeter. Our ten-
dency is to protect assets from external harm but to disregard the dangers that come from
our own internal equipment, policies, and employees.
These attacks or disruptions do not arise solely from disgruntled employees. In fact,
many of the most damaging conditions that occur are due to inadvertent mistakes made by
well-intentioned employees. Each and all of these entry points is a potential source of loss for
your organization and ultimately can provide an attack point to defeat your other defenses.
Additionally, the design of your DMZ will allow you to implement a multilayered approach
to securing your resources without single points of failure in your plan.This minimizes the
problems and loss of protection that can occur because of poorly conﬁgured rule sets or
access control lists (ACLs), as well as reducing the problems that occur due to hardware con-
ﬁguration errors. In the last chapters of this book, we investigate how to mitigate risk by
testing your network infrastructure to ensure that ﬁrewalls, routers, switches, and hosts are
thoroughly hardened.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
23

Designing End-to-End Security for Data
Transmission Between Hosts on the Network
Proper DMZ design, in conjunction with the security policy and plan developed previously,
allows for end-to-end protection of your network and services.The importance of this capa-
bility is explored more fully later in the chapter when we review some of the security prob-
lems inherent in the current implementation of TCP/IPv4 and the transmission of data.The
use of one or more of the many currently available ﬁrewall products or appliances will most
often afford the opportunity not only to block or ﬁlter speciﬁc protocols but also to protect
the data as it is being transmitted.This protection may take the form of encryption using
available cryptographic transports to protect data.Additionally, proper use of the technologies
available within this design provides the necessary functions in the concepts of CIA and
defense in depth that we have discussed in earlier sections.
This need to provide end-to-end security requires that we are conversant with and
remember basic network trafﬁc patterns and protocols.The next few sections help remind us
about these requirements and further illustrate the need to design the DMZ with this capa-
bility in mind.
Trafﬁc Flow and Protocol Fundamentals 
The ability to granularly and holistically control trafﬁc ﬂow through the DMZ is a major
beneﬁt of DMZ designs that include multi-tiered ﬁrewalls. In modern hardware and soft-
ware-based ﬁrewalls, we can control trafﬁc ﬂowing in and out of the network or DMZ
through packet ﬁltering based on port numbers or by allowing or denying the use of entire
protocols suites. For instance, a ﬁrewall rule set might include a statement that blocks com-
munication via ICMP, which would block protocol 1.A statement that allows IPSec trafﬁc
using ESP or AH would be written allowing protocol 50 for ESP or 51 for AH. (For a
listing of the protocol IDs, visit www.iana.org/assignments/protocol-numbers.) Remember
that the optimal rule of security follows the principle of least privilege; we must include in
our design the capability to allow only the absolutely necessary trafﬁc into and out of the
various portions of the DMZ structure and deny all other trafﬁc.
DMZ Protocols
Protocol use within a DMZ environment is highly variable based on the speciﬁc needs of an
organization. Often some of these protocols are problematic to our security stance. We
should be well aware of the potential risks associated with the protocol used in various soft-
ware implementations and those that are frequently and actively attacked due to known vul-
nerabilities and weak code.Table 1.3 provides a brief overview of some known issues with
various protocols.This table is not intended to be all-inclusive; rather, it is demonstrative that
when designing a plan for DMZ structure, the DMZ designer must be aware of many proto-
cols’ limitations.
www.syngress.com
24
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Table 1.3 Protocols With Known Weaknesses
Protocol
Basic Weakness
File Transfer Protocol (FTP)
No encryption, exposing usernames, passwords, and
payload in clear text
Telnet
Vulnerable to buffer overﬂow attacks, replay, and
spooﬁng to gain privilege and discover passwords,
allowing potential for breach of service
Hypertext Transfer 
Many security vulnerabilities within various vendor 
Protocol (HTTP)
software implementations;  poor HTTP server conﬁgu-
ration allows privilege escalation and compromise
Lightweight Directory 
Some implementations are subject to buffer overﬂow 
Access Protocol (LDAP) 
and DoS attacks, with possibility of privilege elevation
and Microsoft Directory 
Services
Simple Network 
DoS and buffer overﬂow attacks are possible as are 
Management Protocol 
security risks posed by administrators who leave the 
(SNMP)
community names and other information in default
conﬁgurations; some conditions can result in privilege
escalation and compromise
Secure Shell (SSH)
Privilege escalation, system compromise when code run
under root credentials, DoS attacks
Domain Name Services (DNS) Many security vulnerabilities within various vendor soft-
ware implementations allow privilege escalation and
compromise; widespread deployment needed for
Internet use
Designing for Protection in 
Relation to the Inherent Flaws of TCP/IPv4
The current implementation of TCP/IPv4 contains a number of well-documented ﬂaws that
should be considered in the design of both your security plan and your DMZ. Some of
these problems are corrected in IPv6, but since implementation of this technology isn’t com-
pletely standardized or on the immediate horizon, we must accommodate the weaknesses of
the existing protocols in implementing our DMZ design. We must plan for certain known
problems, such as:
■
SYN attacks, a DoS condition resulting from overﬂow of the wait buffer
■
IP spooﬁng, allowing the attacker to pretend it is another host
■
Sequence guessing, allowing reassembly or delivery of forged packets
■
Connection hijacking, allowing man-in-the-middle attacks
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
25

You can ﬁnd a good discussion of the problems with TCP/IPv4 in Stephen Bellovin’s
Security Problems in the TCP/IP Protocol Suite, available at
www.cs.columbia.edu/~smb/papers/ipext.pdf.A more complete discussion of the ﬂaws and
improvements made in TCP/IPv6 is available at www.linuxsecurity.com/resource_ﬁles/doc-
umentation/tcpip-security.html.The design that we create for our DMZ structure will
accommodate the weaknesses of the TCP/IP protocol and provide the protection necessary
to stymie these attacks and their resulting potential for security breaches.To accomplish that
goal, we need to consider these various problems and design functional protections in the
design and ﬁrewall and ACL rules while considering the use of other protocols such as IPSec
and L2TP to protect the data on the wire.
Public and Private IP Addressing
One of the primary reasons that the DMZ concepts have been so useful is that network
administrators have a greatly expanded capability to use private addressing schemes.As you
will recall, the initial TCP/IPv4 implementations were based on classful subnet masks, which
inherently limited ﬂexibility in network designs. With the advent of classless addressing and
improvements provided with the acceptance of that concept, much greater utilization has
been made of functions such as NAT to provide addressing for the internal network, without
exposing that network to the dangers of the public network.The DMZ design must incor-
porate the methods and equipment being used for address translation and routing as it pro-
vides a method of hiding internal addresses from unwanted contact.
Therefore, we should plan to use RFC 1918-based private IP addressing ranges, which
are shown in Table 1.4.
Table 1.4 Private IP Address Ranges
Private IP Range
CIDR Mask
Decimal Mask
10.0.0.0–10.255.255.255
/8
255.0.0.0
172.16.0.0–172.31.255.255
/16
255.255.0.0
192.168.0.0–192.168.255.255
/24
255.255.255.0
Use of private address space allows us much greater ﬂexibility in the segregation of the
DMZ and assures that the contacts between the protected network, the DMZ, and the out-
side world are more difﬁcult for would-be attackers to penetrate.
Ports 
Knowledge of various ports used in network communication is an extremely important tool
toward our ability to ﬁlter access levels and establish ACL functions on devices and in soft-
ware implementations used to protect our assets. Recall that ports 0–1023 are reserved for
speciﬁc uses and that all other ports are functionally available for use by applications.
www.syngress.com
26
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Registered ports include those from 1024 through 49151, and dynamic and/or private ports
(used by applications for communication and session maintenance) are those from 49152
through 65535.The entire port list can be found at www.iana.org/port-numbers.
That means, of course, that the DMZ design must incorporate rules that block all trafﬁc
that is not necessary for the function of the DMZ or communications that must be carried
through that area. Generally, this involves creating a rule set for the ACL that restricts or
blocks all unused ports on a per-protocol basis to assure that the trafﬁc is actually stopped.
These rules that are created become an integral part of the DMZ defense. Security adminis-
trators often start from one of two “all or nothing” conﬁgurations: either all ports are open
and administrators close ports as problems occur (bad), or all ports are initially closed and
administrators open ports as required (good, but requiring a great deal of administration and
monitoring in a new network that has not been fully documented). Either method can be
considered in your design, but the latter incorporates the concept of least privilege and pro-
vides much more security as you begin your quest to prevent system compromise.
The SANS Institute (www.sans.org) recommends the port actions shown in Table 1.5 at
a minimum as you design your DMZ and ﬁrewall blocking rules from external networks.
Table 1.5 Common Ports to Block
Protocol
Port
Service Name
TCP
21
FTP
TCP
25
SMTP
TCP/UDP
53
DNS
TCP/UDP
67, 68
DHCP
TCP/UDP
69
TFTP
TCP
80
WWW, HTTP
TCP/UDP
88
Kerberos
TCP
135
RPC/DCE Endpoint Mapper
UDP
137
NetBIOS Name Service
UDP
138
NetBIOS Datagram Service
TCP
139
NetBIOS Session Service
TCP
143
IMAP
TCP/UDP
389
LDAP
TCP
443
HTTP over SSL/TLS
TCP/UDP
445
Microsoft SMB/CIFS
TCP/UDP
464
Kerberos lpasswd
UDP
500
Internet Key Exchange, IKE (IPSec)
TCP
593
HTTP RPC Endpoint Mapper
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
27
Continued

Table 1.5 Common Ports to Block
Protocol
Port
Service Name
TCP
636
LDAP over SSL/TLS
TCP/UDP
1433, 1434 MS SQL Server
TCP
3268
AD Global Catalog
TCP
3269
AD Global Catalog over SSL
TCP
3389
Windows Terminal Server
ICMP
N/A
Internet Control Messaging Protocol (ICMP)
The OSI Model 
While we are reviewing the basics prior to designing our DMZ structure, we should also
look brieﬂy at the basis for trafﬁc ﬂow in our networks and how the data is transported and
delivered from host to host.This review is not intended to be all inclusive but rather to
demonstrate that these trafﬁc ﬂow designs strongly inﬂuence technology considerations in
properly defending our machines and data from attack or misuse. Recall that there exist two
different but complementary designs of data trafﬁc ﬂow and processing for network commu-
nication.The ﬁrst is the Open Systems Interconnection (OSI) model, which formed the basis for
all network communication as originally conceived.The OSI was followed, during the
development of the TCP/IP protocol suite, by the TCP/IP model, which combines the func-
tions of the OSI model layers. Figure 1.12 details the components of the two models.
Figure 1.12 The OSI and TCP/IP Models
www.syngress.com
28
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Layer 7: 
Application
Layer 6: 
Presentation
Layer 5: 
Session
Layer 4: 
Transport
Layer 3: 
Network
Layer 2: 
Data Link
Layer 1: 
Physical
Application Layer
Transport Layer
Network Layer
Subnet Layer
OSI Model
TCP /IP Model

Recall that in both models, packets are assembled and headers from each layer are added
as a packet is encapsulated and prepared for transport on the physical media.The header
contains information about the processing that occurred, to guide reassembly by the
receiving machine.Through either process, when the packet is being sent from the sender to
the receiver, a negotiated port is used to deliver the information to the receiving machine.
While you’re making design decisions for the DMZ access restrictions, it is important to
keep in mind your communication needs for your existing or proposed services and applica-
tions.The launch point of the communication becomes important as we consider the design,
because we must provide for communication that starts at the Application Layer differently
than the communication that is occurring at lower layers such as the Transport Layer or
below.The various layers of the models provide the DMZ designer with a number of dif-
ferent places to institute the desired controls that are used to restrict or allow trafﬁc into and
out of the DMZ.
Identifying Potential Risks from the Internet
Part of the identiﬁcation process for identifying Internet-based risks is a thorough review of
the original baseline analysis performed during security planning. Risks identiﬁed from that
analysis should be a part of your comprehensive DMZ design plan and should consider a
number of potential problems, including, but certainly not limited to:
Virus and Trojan introduction to the network:
■
Possibility of enumeration of the network
■
Various entry points to the network
■
Unauthorized disclosure of information
■
Remote control usage:
■
VNC
■
Microsoft’s Terminal Services
■
PCAnywhere and similar products
Possible weak conﬁgurations allowing elevated access privileges
Evaluation and inclusion of these potential areas of entry and attack, along with others
that may be deﬁned in your plan, should be constantly reviewed during the design process
and again at regular intervals to verify that the discovered risks are mitigated through proper
security design and enforcement.
Using Firewalls to Protect Network Resources
Firewalls have long been and continue to be an integral part in the planning process for
DMZ deployments.The design can include any or all of the basic designs we discussed ear-
lier in the chapter and may very well incorporate multiple types of conﬁgurations,
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
29

depending on your organization’s needs to protect data and resources from various threat
areas. Firewalls are not the only component of the design that is important, but they do play
a major part in allowing the administrator control of trafﬁc, and thus they provide a higher
level of protection.
Part of the design process includes evaluating and checking the performance of different
hardware- and software-based ﬁrewall products. Later chapters of this book discuss some of
the most used technologies, such as Check Point and Check Point NG, PIX, Nokia, and
Microsoft’s ISA Server.Additionally, ﬁrewall considerations are explored during discussions of
wireless network protection and the methods of protecting networks using Sun and
Microsoft network operating system (NOS) software.
Using Screened Subnets 
to Protect Network Resources
As you proceed to a more advance design for your DMZ, conditions may drive the decision
to employ screened subnets for protection or provision of services.The screened subnet, in
some designs, actually becomes synonymous with DMZ in usage. However, the screened
subnet is actually a security enhanced version of the multihomed screened host conﬁgura-
tions that were used in the past. It involves the use of more hardware but provides a more
secure basis for conﬁguration and blocking unauthorized access.
The screened subnet that we looked at earlier in the chapter can be conﬁgured in a
number of conﬁgurations, dependent on your needs.The most simple of construction
involves a multiple-interface ﬁrewall with the capability to ﬁlter trafﬁc to more than one
network.Although simple than others, this design might not be appropriate to use in your
environment if you plan to offer services such as Web, e-mail, FTP, or VPN connections
from the public network to your private network. In these situations, a good case could be
made for the multitiered ﬁrewall approach, perhaps with multiple screened subnets that pro-
vide different services or access based on criteria that you have identiﬁed during your plan-
ning process. Certainly, if offering services that involve e-commerce or access to conﬁdential
records (such as HIPAA-compliant patient records), your plan will most likely need to
include multiple screened subnets, following the earlier suggestions that a multilayer
approach be used to restrict access and prevent attacks from outside.
Securing Public Access to a Screened Subnet
Public access to screened subnets is secured and restricted through a multilayer process, using
a screening router to begin providing protection and a ﬁrewall in the next layer to protect
the access point coming into the screened subnet. Figure 1.13 shows a possible conﬁguration
to begin this protection process.
www.syngress.com
30
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Figure 1.13 A Basic Screened Subnet
In this conﬁguration, it is possible to limit the inbound trafﬁc initially by conﬁguring a
rule set on the router; this piece might be provided by an Internet service provider (ISP), for
example. Further levels of security can be developed in your plan as needed to protect assets
on the screened subnet by ﬁrewall rule sets and hardening of the server providing services.
Additionally, this design could be expanded or used for services or administration of screened
subnets, providing greater security to the internal network as well.
Designing & Planning…
Know What You Want to Secure First
As you begin your DMZ design process, you must ﬁrst be clear about the ele-
ments for which your design is intended. A design that is only intended to super-
ﬁcially limit internal users’ access to the Internet, for instance, requires much less
planning and design work than a system protecting resources from multiple
access points or providing multiple services to the public network or users from
remote locations. An appropriate path to follow for your initial design might look
like this:
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
31
Internal Users
Screened Subnet
The Internet
`
`
`
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone
Demarcation Router
Router ACLs Provide Initial Protection
Firewall Rules Provide Granular, Stateful 
Inspection
Firewall
Continued

1. Perform baseline security analysis of existing infrastructure, including
OS and application analysis:
■
Perform baseline network mapping and performance monitoring
■
Identify risk to resources and appropriate mitigation processes
■
Identify potential security threats, both external and internal
■
Identify needed access points from external sources:
■
Public networks
■
VPN access
■
Extranets
■
Remote access services
■
Identify critical services
2. Plan your DMZ
Trafﬁc and Security Risks 
After beginning to research the necessary components for designing your protection plan,
you will reach a point at which you will assess the actual risks to the security of your enter-
prise network. One of the ﬁrst tools you might consider in this part of your evaluation is the
SANS Top 20 list of the current most critical vulnerabilities, to review the most commonly
vulnerable services.You can view this list at www.sans.org/top20; it is updated frequently.
This information can help you to at least begin to identify some of the risks involved and
then to design a more effective plan to secure what you need to secure.
More appropriately, you should list all services in the DMZ that are required for business
operations.This list should detail the vendor and version of software on each system.This
continually evolving list can be used to investigate speciﬁc vulnerabilities within your envi-
ronment.Armed with this information, you can proceed to mitigate the known risks and
weak points within your DMZ.
As we continue with our overview of DMZ design principles, we also need to discuss
the management of resources and the challenges that occur in designing for administration
and control of the DMZ.The following sections detail a number of the areas that we must
be aware of during our consideration of design and DMZ implementation.
Application Servers in the DMZ
Application server placement in the DMZ must be designed with tight controls in mind.As
in other screened subnet conﬁgurations, the basic security of the operating system must ﬁrst
be assured on the local machine, with all applicable patches and software updates applied.All
unused services should be disabled or removed if possible.
www.syngress.com
32
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

We spend a great deal of time in this book covering the hardening of your systems
(Windows 2000, Sun Solaris, and the like) within the DMZ.Additionally, functionality of the
application servers located in the DMZ should be limited to speciﬁc tasks that do not
involve critical corporate data or information.Therefore, although it is acceptable to place a
Web server in the DMZ with a supporting database server, neither of those servers should
contain conﬁdential or critical corporate information, because they are still located in an area
in which they are considered untrusted. Critical or conﬁdential information should not be
accessible from or stored in the DMZ. For instance, as discussed in the following section, it is
not acceptable to store any type of internal network authentication information on machines
in the DMZ. Likewise, front-end servers or application proxy servers can be placed in the
DMZ for other needs, such as an SMTP gateway or a DNS forwarder. In these instances,
neither the mail nor the DNS server should store any information about the internal net-
work or allow general communication to pass unchecked to or from the internal network.
Trafﬁc to these servers from the internal network should pass through a ﬁrewall, restricting
trafﬁc to individual machines in both directions, using speciﬁc port and address information.
Domain Controllers in the DMZ
Domain controllers for Windows networks or other directory services authentication servers
should never have those services located within the DMZ. It is feasible in some conﬁgura-
tions to provide a front end to these critical servers from within the DMZ, but it is not rec-
ommended, because compromise of a bastion host allowed to communicate with the
internal network through the ﬁrewall could lead to compromise of the entire internal
system.Access to your internal network that requires authentication should instead be han-
dled in your design by the use of VPN solutions, including RADIUS and TACACS+, dis-
cussed in the next section. It is possible, however, that domain controllers need to be placed
within the DMZ, depending on the services you plan to provide in the DMZ. For instance,
if you were running a cluster that is highly available from the Internet on Windows 2000
servers, the cluster will not operate correctly without a domain controller present. For that
reason, you have to accurately assess what you will need and analyze how to implement and
secure it.
RADIUS-Based Authentication Servers in the DMZ
Remote Authentication Dial-In User Service (RADIUS) servers, by deﬁnition and usage, are
required to have full access to the authentication information provided by the Directory
Services system in the enterprise. For this reason, the RADIUS server must be fully pro-
tected from attack and patched completely to avoid DoS conditions.The preferred option
would have the RADIUS server located in the internal network, with proxied requests
coming from a Routing and Remote Access Services (RRAS) server allowed through the
ﬁrewall to the RADIUS server only from the speciﬁed RRAS servers.Additionally, it would
make sense to plan for the use of IPSec to further protect that trafﬁc. Regardless, understand
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
33

that you must analyze the need and deploy the choices based on a proper design that pro-
vides the required service but still remains secure.
VPN DMZ Design Concepts 
VPN usage has grown during the past few years. Many organizations embraced the possi-
bility of VPN use as a method to communicate securely from remote ofﬁces.This led to a
surge of connectivity that was requested in order to allow home “teleworkers” to perform
their job functions without entering the secured environs of the actual workplace and its
network.
A number of changes have been implemented in VPN technology in the recent past,
and these have modiﬁed the thought process that we must undertake as we design our DMZ
infrastructure.To begin, VPN solutions should be created in a separate DMZ space, away
from the other parts of the Internet-facing infrastructure and apart from your internal net-
work space. VPN technologies now incorporate the capability to enter your company net-
work space through public switched telephone network (PSTN) connections, Frame Relay
connections, and the public Internet. Each of these connection types must be included in the
plan, and entry points must be carefully controlled to allow the required access and protec-
tion of information while not allowing a back-door entry to the internal networks.
A number of these plans are discussed in subsequent chapters of this book as different
ﬁrewall conﬁgurations and designs are considered and discussed. When we’re looking at the
possibilities for VPN implementation and protection, it is extremely important to utilize all
potential security tools available, including IPSec and its authentication and encryption possi-
bilities as well as IDS and IPS. It is also important to evaluate the actual network design, in
order to use RFC 1918 (private) addressing in the internal network and properly secure the
addressing within the VPN, which should be registered addresses. Chapter 10 covers this
topic more fully.
Advanced Risks
After you’ve considered the basic issues for connectivity to your infrastructure in your
design, it is appropriate to begin to explore and plan for other areas that might need protec-
tion through your DMZ design.There are nearly inﬁnite overall design possibilities,
including the ability to protect not only the internal network but e-commerce, business
partner, and extranet connections.Additionally, your enterprise may be involved in the cre-
ation of hosted services, in which you are providing protection to Web, FTP, or other servers
that require unique protections as well as the ability to provide management capabilities.This
section visits a number of those potential areas that may be appropriate for coverage in your
overall DMZ design.
www.syngress.com
34
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Business Partner Connections
Business partner connections can provide a unique challenge to the DMZ designer. Often
there is a requirement to provide access to and from enterprise resource planning (ERP)
packages such as those from Oracle, SAP, Microsoft Dynamics, and others that are currently
in use, to provide project management, packaging, and collaboration tools to members of
multiple organizations.
One of the challenges that arises quickly is the question of how to appropriately allow
connectivity between organizations with proper authentication and protection of informa-
tion for all parties. Many of the basic designs that we’ve discussed, including the use of
speciﬁcally screened subnets for VPN access, provide partial solutions to these issues, but
each case also requires an in-depth evaluation and most certainly collaboration between the
DMZ designers to appropriately channel the access entry points, remote access if needed,
and authentication of the users from various entities to maintain the requirements of CIA.
Chapter 10 covers this conﬁguration more fully.
Extranets
Of the possibilities that can be explored in relation to business partner connections for an
enterprise, extranets provide a great deal of ﬂexibility in their implementation and use.
Extranets can be XML-powered Web browser-based information stores, can allow contact by
customers seeking catalog information, and can allow real-time or close to real-time tracking
capabilities of shipments and the supply chain.Additionally, the extranet can be conﬁgured
for collaborative efforts and used between business partners for the ultimate capability to
share information and processes while working on joint projects. Extranets, much like the
earlier discussion of VPN access, are usually placed on isolated DMZ segments to segregate
them from the hosting network’s operations.These DMZ segments will house and host
machines that allow the use of ERP software and the warehousing of common information.
The use of extranet applications is most often Web browser based for the client that is
seeking the information and not normally for storing highly sensitive data, although the data
should still be protected.
Web and FTP Sites
Customer-based Web and FTP sites that are provided or hosted by your organization can
also cause the DMZ design to change in various ways. Hosting the information on cus-
tomer-based sites requires the same processes that we’ve looked at in relation to hosting our
own Web and FTP servers in the DMZ, with an additional requirement that some sort of
remote management capability be provided for the customer to administer and monitor the
sites.This hosting can lead to a plan that permits administrative access from Internet-based,
untrusted sources and must be carefully explored. Ensure that your DMZ design will not be
compromised by the methods used to allow remote access to these servers and their adminis-
tration by the client customer. It may be appropriate to host customer-based operations in a
separate DMZ segment, away from your operation altogether.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
35

E-Commerce Services
Among the possibilities that we may include in our overall DMZ design scheme is the
possibility of hosting or supporting e-commerce services.As with other DMZ design con-
siderations, the DMZ segment hosting e-commerce services must provide a level of isola-
tion that protects such things as credit card information and transactions. It can include
restrictions that block access from noncustomer address ranges, and it can also include
restrictions on traffic to limit it to ports for Web services and Secure Sockets Layer (SSL),
to protect the internal records generated by the services’ action. E-commerce activities
should also include restrictions that disable IP forwarding between servers and segregation
of services such as noncritical database information among different servers for load bal-
ancing and to distribute security to a higher degree. No contact should be allowed
between the e-commerce DMZ servers inbound to the internal network. E-commerce
applications benefit greatly from multitiered DMZ structures where the traditional applica-
tion tiers (Web front end, database, and so on) are segmented and protected from each
other with tightly restricted, minimal connectivity.
E-Mail Services
E-mail services are among the most used (and abused) network services that are provided
through a combination of access points, both external and internal. SMTP gateways should
be located in segregated DMZ subnets with ﬁrewalls allowing access into and out of the
mail subnet for SMTP (TCP port 25) and DNS (UDP/TCP port 53).This setup should also
include mail relay settings on the DMZ mail gateway that prevent relaying mail from net-
works other than the internal network or other trusted networks.The external ﬁrewall that
allows access to the SMTP gateway should be conﬁgured to block outbound SMTP trafﬁc
that did not originate at the gateway. Finally, the server should be conﬁgured to only send
mail to accepted internal addresses while rejecting all other communications. Great care must
be used in the proper conﬁguration of mail servers from all vendors when access is granted
in any fashion from the external networks.
Advanced Design Strategies
Up to this point, we’ve directed our discussion to access path design and the methods of
securing access to the internal network from the external network. In most cases, the DMZ
is used to block incoming trafﬁc and control it more completely through the multiple layers
that are placed in the design, because this approach offers tighter control to stop access to the
internal network. In the past, standard DMZ designs almost always defaulted to a condition
in which the internal network’s access to the external public network was unrestricted.As
threats have grown in complexity, it has become clear that outbound access restrictions are
often needed to prevent perpetuation of malicious trafﬁc such as worms and viruses.
www.syngress.com
36
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Before we complete our discussion of basic designs, it is appropriate to explore brieﬂy
some of the ways we might consider blocking access from the internal network to the external
network, either wholly or in part, if the security design we created earlier indicates a need to
do so. In the next section, we visit some of the common conditions that your organization
might want to block or limit in your efforts to protect your assets and information.
Advanced DMZ Design Concepts
Intranet users have regularly been allowed full and unrestricted access to public network
resources via the DMZ structure. Often the protection for the internal network involves
using NAT or proxy-based connectivity to allow outward ﬂow while restricting inbound
requests to the internal network.You should think about some special considerations while
you are working in this area. Let’s list some of them and consider them in thought patterns
as an addition to the overall design:
■
Traditional local area network (LAN)-based protocols such as Microsoft CIFS
should generally not be used outbound to transmit and received data from wide
area network (WAN) destinations.
■
Known worm propagation protocols and ports should be denied outbound access
to prevent the spread of malicious trafﬁc, should a system be compromised on an
internal network.
■
DMZ design lends itself to allowing control of unnecessary services that may be
present on the external network. For instance, the DMZ design may incorporate
outbound blocking of ports to services providing instant messaging, non-business-
related networks, and other restrictions as appropriate to your system.
■
Known management ports for externally located devices and services should be
blocked from the internal network.
Additionally, we must look at the applications that are in use from the internal network
to determine the appropriate level of outbound access to accommodate those applications.
As we continue through the book, we’ll ﬁnd that a number of other considerations must
be taken into account as we create the design plan. For instance, although many DMZ con-
ﬁgurations allow access to a Web server that we are operating, there must be a method in
place to advise us of the presence of potential hackers working within our borders.To this
end, the DMZ design must also include provisions for IDS and IPS placement in the various
levels of the DMZ structure for evaluation of and alarm during intrusion attempts.This is
most notably required when encrypted ﬂows are permitted into your DMZ. As with all ser-
vices that we provide, the Web services servers must be continually evaluated and kept up to
date in their levels of security and service packs.
Another conceptual area that must be mentioned is the difference between a DMZ that is
established for the purpose of isolating or segregating the public network from your private
network and a DMZ that is used for the purpose of isolating or segregating a portion of your
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
37

internal network.The design you create should include the capability to establish internal
DMZ structures to protect conﬁdential information from the general LAN operation.This
could include segregation of ﬁnancial data or provisions for VPN access to the internal net-
work that does not originate from the public network (such as Frame Relay PVC channels or
PSTN modem access).Again, when dealing with these special cases, the designer must be abso-
lutely sure that the design does not introduce a back-door situation that allows public network
bypass of the DMZ structure through compromise of a host machine.
Remote Administration Concepts
Remote management and administration of the various pieces of hardware within the DMZ
design you implement provide another challenge for the designer.Although it is extremely
tempting to use the built-in capabilities of the various operating systems and the manage-
ment software provided for many of our hardware devices, it is very important to thoroughly
review alternatives. Use of these tools for normal management from within the internal net-
work could be a quick recipe for security breach and disaster.
It is certainly technologically possible to access the equipment in the DMZ through use
of SSH,Telnet, or Microsoft’s Terminal Services and to create ﬁrewall rules allowing trafﬁc
on the necessary ports to accomplish this task. So, what’s the problem with using the built-in
tools? These management tools, including SNMP-based traps and management agents, rely
on the integrity of the network and the systems on which they are loaded to provide reports
and management capabilities used to control the conﬁguration of hardware and servers.
What happens when the underlying network capability is degraded, reduced, or overloaded
through an equipment failure or a DoS attack? What happens when the server itself is com-
promised? No management is possible, because we now can’t reach the equipment.
Overcoming this problem necessitates the concept of in-band versus out-of-band management
of your systems.
The alternative of providing out-of-band management capabilities can be accomplished
in a number of ways, including serial connections to secured management ports on the
devices to be managed or a separate management screened subnet, such as illustrated in
Figure 1.14.
In this simpliﬁed design, the servers located in the DMZ are each conﬁgured as a multi-
homed machine, with the additional adapters conﬁgured to accept communications only
from the designated management workstation(s), if your security policy allows multiple
administrative units. Optimally, this second interface is a dedicated management port com-
monly found on today’s server platforms.The outside ﬁrewall is conﬁgured to allow speciﬁc
port-based trafﬁc to ﬂow from the management workstation to the servers, and the manage-
ment workstation is not accessible from either the untrusted network or the protected LAN.
This approach eliminates much of the security vulnerability that is presented when manage-
ment options include only in-band tools.
www.syngress.com
38
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design

Figure 1.14 A Method to Provide Out-of-Band Management in the DMZ
Authentication Design
Earlier in the chapter, we mentioned that it is generally inappropriate to locate a RADIUS
or TACACS+ server in a DMZ segment, because it creates a condition in which the authen-
tication information is potentially accessible to the public network. In some environments, it
might be necessary to implement a plan to accommodate the authentication of users
entering the DMZ from a public network. In this case, the DMZ design should include a
separate authentication DMZ segment and the equipment in that segment should be hard-
ened, as previously detailed in our discussion of placement.At this point, it is possible to pro-
vide an RRAS server in the DMZ with no internal account information and utilize ACLs
and packet ﬁltering at the ﬁrewall to restrict and encrypt the trafﬁc between the two
machines to the authentication trafﬁc. It is recommended that this process utilize IPSec, and
it would require that Protocol ID 51 for IPSec and IKE trafﬁc on port 500 (UDP) be
allowed for the communication to occur. It is also possible that other third-party authentica-
tion products such as Cisco’s CiscoSecure ACS could provide a gateway and controls to
allow this functionality.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
39
Internal Users
Production Traffic Network
The Internet
`
`
`
Firewall
Untrusted Network Zone
Demilitarized 
Network Zone
Internal Network Zone
Permitted Flows
Denied Flows
Management Traffic
Legend
Screened Management Subnet

Summary
Chapter 1 provided the opportunity to explore and review a number of important concepts
in our preparation for designing an effective and secure DMZ structure. DMZ design
includes a number of important steps that make the overall design process smoother and less
subject to compromise.These steps include performing a complete physical and logical secu-
rity analysis of the systems to be protected, followed by the adoption of an enterprise secu-
rity policy to detail the path of management, monitoring, enforcement, and responsibility for
various areas of the enterprise’s security. Once we have completed a security analysis and
have a security policy that has management support, we have the opportunity to think about
the design of the DMZ structure. With a plan it is possible to incorporate the principles of
security, such as defense in depth and CIA, into the design, to assure a higher level of secu-
rity in the DMZ.
Generically, we create the basic DMZ structure after we have identiﬁed the assets and
resources that need protection.This simple plan is followed by an evaluation of how the
information currently ﬂows in the organization and how it should be handled to securely
isolate and protect the systems from compromise.
When the generic tasks have been completed, the design begins to take shape as we
conﬁgure and deﬁne the various levels of the DMZ structure to provide necessary services
to customers, employees, and partners. We’re aware at this point that there are nearly inﬁnite
possibilities in the use of various equipment and conﬁgurations, and we’re charged with cre-
ating a design that is functional and economically feasible in the reduction of risk. Here we
begin to consider not only the best logical design but also the design that might be the most
feasible to protect our data.
We ﬁnd as we proceed that the level of service that we are providing and the connec-
tivity needs of the various partners and operations greatly affect the level of conﬁguration
within the DMZ structure. We also ﬁnd that it is possible to allow connectivity in multiple
levels for various services while always striving to protect the internal network from harm.
Solutions Fast Track
Planning Network Security 

DMZ design requires that we ﬁrst evaluate the physical and logical security and
needs of the organization.

The overall security plan and evaluation require input from all concerned parties
in the organization, at levels ranging from human resources to the legal
department to the chief security ofﬁcer, to provide a valid analysis.
www.syngress.com
40
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design


Following the completion of the security plan, it is imperative that an overall
enterprise security policy be written, approved, and implemented to assist in the
evaluation of the need for DMZ protection. Without this document and deﬁnition
of responsibility, DMZ design is fruitless.
DMZ Deﬁnitions and History 

DMZ use has been increasingly important as the de facto enterprise architecture
design for security while at the same time offering an ever-increasing array of
services and connections to services in the network.

The multilayer approach of using bastion hosts, screened subnets, IDS/IPS, and
ﬁrewalls to provide ﬁner and ﬁner control of access when approaching the interior
network has proven to be an effective means to securing the DMZ structure.

DMZ design is never static. Like security plans and policies, DMZ designs are a
work in progress at all times, and it should be understood that the design is an
evolving effort, subject to constant upgrade and tweaking.
DMZ Design Fundamentals 

Multiple design possibilities exist, depending on the level of protection that is
required in the particular enterprise conﬁguration.

DMZ designs generally consist of ﬁrewalls and segments that are protected from
each other by ﬁrewall rules and routing as well as the use of RFC 1918 addressing
on the internal network.

DMZ design depends on the architect’s ability to accurately assess the actual risks
so that he or she can design adequate protection.
Advanced Risks 

Outside the normal DMZ structure, many other conditions could arise that
require evaluation.These conditions include restriction of access to the public
networks from the private networks, not only the protection of the public network
access to the internal network.

Business-to-business (B2B) and e-commerce activities require special consideration
to provide protection of partner and customer data and information.They also
demand a level of design separate from basic needs.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
41


Provision of e-mail services and VPN connectivity to the private network via
connection through the DMZ with a connection to the public network requires
special considerations prior to design.
Advanced Design Strategies
■
Consider the methods that might be used to provide VPN services to special
connections, such as Frame Relay and PVC circuits or Internet-based home users.
■
Limit or restrict outbound trafﬁc from the internal network to inappropriate
services, such as FTP or messaging services.
■
Provide for out-of-band management capabilities on all DMZ design segments as
well as intrusion detection services where they are appropriate.
Q: What is the difference between a DMZ and a screened subnet?
A: Although the terms are sometimes used interchangeably, the screened subnet is a varia-
tion of the screened host conﬁgurations that required dual or multihomed hosts to pro-
vide protection. In the case of the DMZ, the protection is most often provided through
the use of screening routers and ﬁrewall appliances or software to more securely limit
trafﬁc and eliminate single points of failure.
Q: You mention that a security policy must be in place before designing a DMZ. Why
should I go to all that trouble?
A: It is important that administrators have a clear goal and vision about the levels of protec-
tion that you are responsible for and that you are expected to maintain. It is impossible
to navigate the complexities of the DMZ design stage without ﬁrst having a path to
follow.
Q: Could you explain the difference between out-of-band and in-band management?
A: In-band management tools require that the network being managed and the devices
connected to it utilize the same network. In the case of network problems or DoS
www.syngress.com
42
Chapter 1 • DMZ Concepts, Layout, and Conceptual Design
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

attacks, the administrator would be unable to manage the equipment or rectify the
problem. With out-of-band tools in place, management occurs on a different level,
which may be a separate segment or serial port-based interaction with a console port on
equipment.This capability is very important in the maintenance of your DMZ structure.
Q: A client has an outside ofﬁce that needs to be able to authenticate to the internal net-
work.The client would like to accomplish this task as inexpensively as possible while
still maintaining security. What would you recommend?
A: In this case, the normal recommendation would be to use a modem-based RAS to allow
access to the internal network, unless there is already a substantial DMZ structure in
place to accommodate the trafﬁc from the remote ofﬁce.
Q: To provide the levels of security that are required in the large enterprise environment,
what path would you recommend toward achieving the most complete design?
A: As we’ve discussed throughout the chapter, the most complete design requires security
analysis, policy creation, and discussion with all stakeholders to appropriately implement
the DMZ plan and structure.
Q: I thought that RADIUS was only for billing purposes?
A: Actually, RADIUS does have the capability to log access times and trafﬁc, thus making
auditing a simpler process. Its main use, however, is to screen the authentication process
from outside networks and limit communication via the authentication mechanisms of
our internal networks.
www.syngress.com
DMZ Concepts, Layout, and Conceptual Design • Chapter 1
43


Windows 
DMZ Design
Solutions in this chapter:
■
Introducing Windows DMZ Security
■
What’s New in Windows Server 2003 and R2
■
Building a Windows DMZ
■
Looking Ahead to Windows Longhorn
■
Windows DMZ Design Planning List
Chapter 2
45
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
Microsoft has taken great strides in the past few years to enhance its security posture.
Windows 2000 and Windows Server 2003 are as secure as Microsoft can make them, so it’s
very important that you follow this chapter closely; everything you learn here will be used in
your network’s demilitarized zone (DMZ).
In Chapter 1 we learned what a DMZ is, its fundamental security concepts, and how to
design a basic DMZ with trafﬁc ﬂows. In this chapter we start to populate the DMZ with
systems and the speciﬁcs of designing those systems to work within the DMZ. From
Chapter 1, you’ll recall what you learned about the basic DMZ and its overall reason for
existence as well as its basic design. Building on the content of Chapter 1, this chapter shows
you how to use your Windows systems within the DMZ design. We cover how to design a
Windows-based network solution that will work within and around the DMZ segment. It’s
important to know this information as a security administrator or engineer because the
DMZ (as you are now starting to see) can be very complex to work with. It will grow even
more complex as we move through this book. (Chapter 13 and Appendix A focus entirely
on how to lock down and harden Windows services such as IIS, so if you are only looking
to harden systems, you might want to jump directly to those sections of the book.) 
In this chapter you learn about Windows security but only as it relates to the DMZ. In
other words, this chapter is not a general Windows security chapter but rather is customized
to ﬁt the needs of designing security within the DMZ. Of course, the chapter covers many
security topics revolving around Windows security, but all the content is tailored, for the
most part, to security administrators working within a DMZ environment.
The last section of this chapter discusses basic trafﬁc ﬂows and the services and protocols
Microsoft products use. With this information, you can design your systems so that all
needed trafﬁc will go through the ﬁrewalls, as well as preventing trafﬁc that you do not want
to go through the ﬁrewall. In later chapters, we show you how to conﬁgure those ﬁrewalls to
allow the trafﬁc to pass; you can come back to this chapter to get the data you need (such as
port numbers for access control lists) to engineer your solution.As mentioned before, you
need to read this book in its entirety to be able to complete your solution if you are not sure
what to do at all, but if you have a Cisco PIX ﬁrewall that you need to implement with a
Windows IIS Server, you can probably just read this chapter, the PIX chapter (Chapter 6),
and the chapter on how to secure Windows 2000 and Windows 2003 bastion hosts on the
DMZ segment (Chapter 13).
This chapter can serve as a rough design document to help you place your Windows
systems and the services they run within the DMZ. Many administrators wonder how to
place their systems within the DMZ, especially when those systems are Web or FTP servers
that face the Internet and are publicly accessible.This job can be nerve-wracking, especially
with all the past publicity about Microsoft being an insecure system with many bugs,
unchecked buffers, and a plethora of other problems, resulting in its products becoming the
biggest target on the Internet today.This chapter (and following chapters) will remedy those
www.syngress.com
46
Chapter 2 • Windows DMZ Design

fears by providing you with the answers and solutions you need, not only to place the sys-
tems in and around the DMZ but also to protect them.
NOTE
If you are looking for a book on how to harden and implement security with
Windows 2000 or Windows Server 2003 in more granular detail without a focus
on the DMZ segment, you can check out this Syngress title:
■
MCSA/MCSE Exam 70-291 Study Guide & DVD Training System
Implementing, Managing, and Maintaining a Windows Server 2003
Network Infrastructure (ISBN: 1931836922)
Introducing Windows DMZ Security
In this section we take a broad look at security concepts for Windows systems, tailoring all
the content to DMZ-based hosts.This section of the chapter covers the following details:
■
Fundamental Windows DMZ design
■
Windows DMZ bastion hosts design
■
Engineering Windows trafﬁc in the DMZ
An introduction to Windows DMZ security must start with a general discussion of the
concepts of applying a secure foundation to the core services running within the DMZ, all
based on the Microsoft product line. In discussing Windows-based security in the DMZ, we
need to look at a few general concepts.What will be publicly accessible? Why do you need
these services available? How will you control access to and from such resources? How will
you maintain these services? Everything else is all about hardening the systems. Let’s look at the
general design. Remember, DMZs are the best place for you to place and secure your publicly
used information and services such as an e-commerce site, a Web site, an FTP site,VPN-based
services, and so on. In this chapter we look at proper placement of these needed services.
In this section of the chapter we also look at basic Windows DMZ bastion host design.
This is really about placement of servers and reasons you would place them in speciﬁc loca-
tions on your network.
Remember, you need to understand three very important concepts: why you are
building a DMZ, where to place speciﬁc services, and how to engineer the trafﬁc to and
from those services.After that, you can worry about locking down those individual systems.
www.syngress.com
Windows DMZ Design • Chapter 2
47

Fundamental Windows DMZ Design
Before we look at the fundamentals of securing the DMZ segment and its hosts, we need a
general idea of what it’s going to look like on a map.All good network designers plan the
topology (hopefully with a topology map) and ﬁgure out in advance trafﬁc ﬂows, logical
addressing, and any other factors that would affect the system’s planned operation. If you
choose not to follow this recommendation, you could ﬁnd yourself very discouraged when
the network does not function properly and systems cannot be accessed due to a simple (or
complex) mistake you made in the design.A DMZ segment can be one of the most compli-
cated network segments to design and implement. When you add Windows to the mix, you
not only have to be an expert in security—you also must be an expert in network engi-
neering, Windows 2000 and Windows 2003 system design, and the services to be made
available. Look at it from this perspective:You want to set up a DMZ segment with a PIX
ﬁrewall and a Windows-based Web server.This should not be a complicated task, but think
of all the areas you need to focus on:
■
Network engineering
■
Systems engineering
■
Security analysis
Now take a look at Figure 2.1, which points out all three of these areas.
Figure 2.1 Fundamental DMZ Design
www.syngress.com
48
Chapter 2 • Windows DMZ Design
CORP.RSNETWORKS.NET
DNS
Database
IIS
DC 1
FTP
INTERNET
DMZ
Internal
Network

The reason we have segmented this ﬁgure into three sections is that it represents how
you should design each section. Let’s take a look at each section in more detail.
NOTE
In Figure 2.1, note also the use of high availability in your design. If your
resources need to be in high demand, it is critical that you design high-avail-
ability features so that you can keep your services available in time of disaster.
Here you can see the need for ﬁrewalls, redundant routers, and Internet connec-
tions to different points of presence (POPs), highly available Web services, and
database services. Never rule out high availability for your solution if you can
afford to implement it. 
Network Engineering the DMZ
Your ﬁrst step in designing a Windows-based DMZ is to select all the networking hardware
you will need.You must do an assessment of your needs to ﬁgure out what the hardware
infrastructure will cost your company. When you are looking at the networking end of it,
you should ask yourself,“What devices will I need, and how should I scale them?” Exploring
these questions will bring answers based on networking gear and costs. Since we’ve already
mentioned Cisco, let’s stick with that company’s products for this example. In Figure 2.1 we
looked at a very basic network infrastructure, but the future needs are quite high, so let’s say
that we decide to scale up the network hardware. We interviewed all departments that are
part of the project to design and implement a DMZ infrastructure with an IIS Web server.
After talking to everyone involved, we came up with a few important items:
1.
We need to scale up the number of connections to the Internet, since the VPN
services, external DNS, and other services will be added sooner rather than later.
For this reason, we might need to have more port availability on our switch that is
publicly accessible via the Internet.
2.
We need to add more bandwidth and site-to-site VPN services off the external
Internet routers.This need will become critical next year.This tells us that we had
better not skimp on the Internet-facing routers, and we must make sure that we
purchase models that either have crypto cards (to use IPSec for VPNs) installed or
that are upgradeable to them.
3.
We need to eventually set up a load-balanced solution with multiple IIS servers
and a possible backend database cluster.This tells us that we will need to scale the
ﬁrewall, switches, and all other infrastructure to meet the needs for a possible e-
commerce site, a load-balanced cluster, and so on.
www.syngress.com
Windows DMZ Design • Chapter 2
49

Can you see why you must really plan this project very well? There is nothing more
frustrating than having to constantly replace equipment because you have not anticipated
future needs and requirements. It always winds up costing more in the long run, so make
sure that you perform a detailed needs assessment up front, and scale your design to what
you might need in the future.
NOTE
Even if your management team or project stakeholders decide it’s not in the
best interest of the project, organization, or IT group to scale resources up or
out (which adds immensely to the cost of the project), at least they’ll remember
you brought it up—and when the need comes up in the future (as it usually
will), it will be on record that you at least tried! 
Now you have performed a needs analysis and have designed the infrastructure. (The
initial design is shown in Figure 2.1.) You have noted that a redundant ﬁrewall should be
used to ease the pain of failure as well as your scaling requirements.The management team
responsible for purchasing and approving this design has stated that all is approved except the
redundant ﬁrewall, which will be considered and purchased at a later date.
After you run a test (maybe even a pilot or prototype) of your network design, you are
ready to implement it.Again, this chapter focuses on overall design. Since this book was
written with all types of systems in mind, you can replace that ﬁrewall (currently PIX) with
a Nokia ﬁrewall, a Check Point ﬁrewall, or Microsoft ISA Server.This book allows for that
ﬂexibility in design so that you can pretty much replace that ﬁrewall with whatever you are
currently using or plan to use. We look at the speciﬁcs of adding rules and so on in later
chapters.
Now that you have an idea of network design, let’s continue with our plan to design it.
Take a look at Figure 2.2.
Since you have already selected your vendor’s product line (Cisco) and have your needs
analysis done, you can lay out your infrastructure. In Figure 2.2 you see that we have used
Cisco routers, switches, and a ﬁrewall to build our DMZ segment.The Layer 3 switches in
the internal network position were already in place.This is the LAN’s default gateway and
the switch responsible for segmenting the LAN into virtual LANs (VLANs). Chapter 9 of
this book is all about building those VLANs; for now, we’ll focus on design.
www.syngress.com
50
Chapter 2 • Windows DMZ Design

Figure 2.2 Network Design of the DMZ
We’ve decided to use the following components for our DMZ:
■
Two Cisco 3725 routers with T1 WAN interface cards (WICs) with which to
connect to the Internet and Fast Ethernet ports to the external switch. We decided
on two routers because we want to have a highly available solution to the Internet.
If one link goes down, we have another to use, and we can offset the load in times
of high demand. We chose this router model because we foresaw a future need to
implement site-to-site VPNs, add more redundancy to the network, and leave
room for a possible later upgrade in not only bandwidth but also in the number of
connections for backup lines.
■
We selected two Cisco switches for our external public network segment and for the
DMZ. Now you have to do some research (or refer to Chapter 9 for more informa-
tion), but your switch choice will be based on how many ports you need, the
amount of trafﬁc you will have going through it, the quality-of-service enhance-
ments you would like, and other features such as dual power supply.Your switch
should be scaled to what you need and scaled up (or out) based on future needs.The
best piece of advice we can offer you in terms of a decision on a switch is to
research very heavily on the vendor’s Web site to ﬁnd what each model offers and
how it can ﬁt into your design, based on current and future needs as well as cost.
■
We selected a Cisco PIX ﬁrewall to be the “trafﬁc cop” among the Internet, the
DMZ, and the private LAN.Again, Chapter 6 focuses on this design (you will be
shown the exact conﬁguration to implement this solution), and that is where you
can ﬁnd all the details on a speciﬁc model. One design ﬂaw we pointed out (but
www.syngress.com
Windows DMZ Design • Chapter 2
51
INTERNET
DMZ
Internal
Network

had to live with) was the single-ﬁrewall design. We originally asked for a redun-
dant solution (two ﬁrewalls with failover, as you will see in Chapter 9), but the
cost was too high for now and the need was not as great.Again, this solution was
implemented to make the DMZ and to control trafﬁc to and from it, so the
needed design was met with this requirement, but a second redundant ﬁrewall
would be ideal.
NOTE
When planning your infrastructure, you always need to ensure that you plan the
proper equipment list, no matter what vendor you pick. If you are purchasing
this much equipment, presales support could be in order. Ask your vendor to
show you user limits per device (the number of users who can simultaneously
use this device without affecting its performance) as well as what type of trafﬁc
you will be pumping through it. Many times, the vendor can help you design
your network so that you don’t fall short on what you need or you don’t go
into overkill where you might not need the extra power. 
You can see that implementing a DMZ is not a cakewalk; it’s all based on needs and
analysis. It is something that you have to really plan out and design so that it comes out the
way you want it and need it instead of becoming a costly disaster. In addition, note that we
have only designed the actual infrastructure—we have not even plugged any intelligence into
it. Future chapters point out how to add intelligence so that you can conﬁgure rules and
other settings to make all the components work together. In the next section, we look at
adding the systems into the segment.
Designing & Planning…
What Is a Site-to-Site VPN?
We have alluded to the need for a site-to-site VPN as a future requirement in our
design. The purpose of this VPN is twofold. First, we want you to “think outside
the box” and consider that there are such things as future requirements when
designing a DMZ. Second, we want to ensure that this book is relevant to today’s
and tomorrow’s future technology trends. Let’s look at the Cisco router that we
selected for this DMZ design as an example. 
www.syngress.com
52
Chapter 2 • Windows DMZ Design
Continued

Key features for the Cisco 3725 and 3745 are:
■
Two integrated 10/100 LAN ports 
■
Two integrated Advanced Integration Module (AIM) slots 
■
Three integrated WIC slots 
■
Two (Cisco 3725) or four (Cisco 3745) Network Module (NM) slots 
■
One (Cisco 3725) or two (Cisco 3745) High-Density Service Module
(HDSM)-capable slots 
■
??32MB Compact Flash (default); 128MB maximum 
■
??128MB DRAM (default, single 128MB DIMM); 256MB DRAM max-
imum 
■
Optional in-line power for 16-port EtherSwitch NM and 36-port
EtherSwitch HDSM 
■
Support for all major WAN protocols and media: FR, ISDN, X.25,
ATM, fractional T1/E1, T1/E1, xDSL, T3/E3, HSSI 
■
Support for selected NMs, WICs, and AIMs from the Cisco 1700,
2600 and 3600 Series 2 RU (Cisco 3725) or 3 RU (Cisco 3745) rack-
mountable chassis 
The VPN and encryption AIM are: 
■
AIM-VPN/HP DES/3DES VPN Advanced Integration Module for 3660
and 3745—High Performance 
■
AIM-VPN/EP DES/3DES VPN Advanced Integration Module for 2600
and 3725—Enhanced Performance
You are using this router because of the addition of the VPN and encryption
AIM that are available with it. You need this added crypto card to be able to
tunnel from one site to another over the Internet. You understand why we
selected the router we did (for its scaling and functionality), so you need to know
what a site-to-site VPN is, now that you have the router hardware lined up. A site-
to-site VPN (as shown in Figure 2.3) is a network solution that utilizes both public
and private IP Internet connections to establish the WAN between all sites that
you want to connect to, such as remote branch ofﬁces, business-to-business
partner connections, and so on. 
The beneﬁts of using this solution are many. For one, VPN technology can
run over public or private Internet-based solutions. In other words, you can uti-
lize this design in just about any country in the world. Frame Relay (especially in
international deployments) can be quite costly, so you might want to utilize a
VPN connection to connect a remote branch more cheaply than with a costly
Frame Relay connection. You can also augment your WAN with a backup solution
based on VPN. VPN services are better in some ways because all VPN trafﬁc takes
place at Layer 3, without delving down to Layer 2 of the OSI model. Since there
www.syngress.com
Windows DMZ Design • Chapter 2
53
Continued

is no breakdown of data and rebuilding of data, it can be argued that a VPN solu-
tion is better when you’re trying to utilize voice over IP (VOIP), and the like. (Keep
in mind that both VPN and VoIP technologies would beneﬁt from QoS or policy-
based routing to avoid performance degradation.) The difference we mentioned
before (public vs. private VPN technologies) is that a public VPN network setup
will utilize any ISP’s Internet service, whereas a private VPN network would be,
for example, AT&T’s private IP VPN network built only for use with private busi-
ness and not publicly accessible via the Internet, if you do not want it to be, using
a Layer 3 private network. Both can be used at the same time with this solution,
adding another degree of ﬂexibility to your design. 
Figure 2.3 A VPN-Based Network
The reason this information is so important is that in the future, you might
only have an Internet connection to worry about for all your remote e-mail,
Internet access, and WAN access. Therefore, the DMZ becomes even more critical
at this point in the design phase. Each router you see in Figure 2.3 should be ﬁre-
walled (with a DMZ, if the services are needed) especially if you are not using an
ISP’s private VPN solution. One last note: The design used in Figure 2.3 is called
a partial mesh. This keeps the tunnel endpoint to a minimum, with no more than
one to three hops to get to any site from any site. A full mesh keeps hop counts
down, but tunnel maintenance is harder to maintain because you will have many
more tunnels to maintain with a full mesh. Conversely, a partial mesh keeps the
hop count down but requires more complex routing solutions for full site-to-site
connectivity.
www.syngress.com
54
Chapter 2 • Windows DMZ Design
Server
Server
Server
Server
Server
Server
HUB SITE
HUB SITE
HUB SITE
Hosted Resources
Insourced Resources

Now that you have designed your network, it is time to populate the segment with sys-
tems. In the next section we look at systems engineering your DMZ.
Systems Engineering the DMZ
You can now start to populate the DMZ and its surrounding areas. First, you need to think
about access to and from the DMZ and the services that are needed.The reason behind this
initial thought is that your end users, customers, potential customers, and outsiders will be
able to utilize needed resources and only those needed resources—nothing more, nothing
less.To start the engineering process, you must ﬁrst make certain that you have these
answers! What do you need? You should make sure that users can obtain the information
that they need about your company without accessing the internal network and accessing
only the DMZ or safely accessing the internal network, if you chose not to implement a
DMZ. Working with DMZs can be tricky (hence the need for this book), so if you can, it’s
always better to segment Internet-based resources via the DMZ for an added level of safety.
Now that you know your network layout, you have to think about other access to and
from the DMZ.Your secret, protected, conﬁdential, and proprietary information should be
stored behind your ﬁrewall and DMZ on your internal network. Servers on the DMZ
shouldn’t contain sensitive trade secrets, source code, proprietary information, or anything
that can be used against you or your company—or that can be used to exploit or hack into
your systems. (There’s more on DMZ hacking techniques in Chapter 14.) A breach of your
DMZ servers should at worst create an annoyance in the form of downtime while you
recover from the security breach.
Here are examples of systems that could wind up on your DMZ:
■
A Web server that holds public information This can be IIS (since we are
discussing Microsoft technologies in this chapter) or any other publicly accessible
Web server.You can also think of FTP services, NNTP services, and other Web-
based services to be accessed and utilized.
■
Electronic commerce-based solutions always wind up on the DMZ The
front end of an e-commerce transaction server is the one through which orders are
placed. Keep the back end, where you store client information, behind the ﬁrewall.
You want to design this system properly because if you don’t, you could compro-
mise your entire client database (or personal and private data) if your system is
exploited.
■
A mail server that relays outside mail to the inside This will be a highly
utilized solution, especially since spam and other e-mail exploits are common
DMZ host-based targets of attack.
■
VPN solutions are prevalent in the DMZ Other than the site-to-site VPN
we already learned about, you also have VPN solutions in which you have a
remote access solution so that clients can attach over the Internet to get to their
www.syngress.com
Windows DMZ Design • Chapter 2
55

ﬁles and other data they need on the corporate network.This data also has to be
publicly accessible via the DMZ.
■
Security devices These include intrusion detection solutions, honeypots, and
other items you will learn about in Chapter 15.
These areas all need to be addressed when it comes to providing a solution for your sys-
tems and where to place them within the DMZ or around it.
Take a look at Figure 2.4, which shows the placement of the systems within the DMZ.
We have placed all the publicly accessible systems (such as Web, FTP, and DNS) on the
DMZ so that Internet users can access them and not come into and through our internal
network, which is to remain private.You can also see that we have placed our domain con-
troller and all-important data (such as a SQL Server database) on the internal network.This
approach keeps these resources secure and accessed only via proper channels, not exposed to
the Internet for malicious exploits to take place.
Figure 2.4 Systems on the DMZ 
Security Analysis for the DMZ
Once you have ﬁnalized the DMZ network segment design and placed your systems where
they need to be (and you understand why they need to be there), you have to consider the
security of such systems.To learn how to harden the systems themselves, read through the
chapters in this book that concern security measures you need to take in the DMZ. If you
want to implement an IDS for intrusion detection, for example, you can read Chapter 15 to
learn how to do that, but to understand placement for your DMZ, take a look at Figure 2.5.
www.syngress.com
56
Chapter 2 • Windows DMZ Design
CORP.RSNETWORKS.NET
DNS
Database
IIS
DC 1
FTP
DMZ
Internal
Network

Figure 2.5 Implementing Security in the DMZ 
To keep the security analysis potion of your DMZ design to a minimum (the rest of the
book is based on conﬁguring security), you need to know the two biggest targets of attack
and what you should be concerned about when considering your design.
Zone 1
Zone 1 of Figure 2.5 is the location of your public Internet connection and where you are
traditionally most vulnerable to exploitation. Zone 1 is where you need to consider your
external router and switch security as well as the outside port of your ﬁrewall.You can read
Chapter 13 to learn how to lock down this zone. Furthermore, Zone 1 is where you would
consider placing your network-based IDS (although you can place it just about anywhere,
depending on what you are trying to capture) as well as your honeypot.You can read
Chapter 15 to learn about IDSs and their implementation around the DMZ.
Zone 2
Zone 2 is the actual DMZ.The DMZ is where we have placed our Windows 2000 servers
and the services they offer, such as external DNS and Web services.To learn how to harden
the systems on the DMZ (also called bastion hosts), read Chapter 13.
New Features in Windows Server 2003 R2
For a number of reasons, the notion of the network perimeter has evolved over time. Part of
this is due to the increased prevalence of high-speed residential Internet connectivity as well
as an overall increase in connected e-commerce ventures for both new and existing compa-
www.syngress.com
Windows DMZ Design • Chapter 2
57
CORP.RSNETWORKS.NET
DNS
Database
IIS
DC 1
FTP
INTERNET
DMZ
Internal
Network
ZONE 1
ZONE 2

nies. Because companies rely more and more on the Internet to do business, many are
searching for better ways to improve their ability to interact with vendors, suppliers, and cus-
tomers, without “giving away the store”—in other words, without providing more access to
the internal network than an external user in one of these roles requires. For example,
Windows Server 2003 allows you to create trust relationships between two separate Active
Directory forests, but in many instances, granting this level of access to a customer or busi-
ness partner would be undesirable or simply impractical.
To help address this challenge, Windows Server 2003 R2 includes a new feature called
the Active Directory Federation Service, or ADFS.This service provides an alternative to the tra-
ditional DMZ environment and creates an environment where two separate organizations or
distinct subsidiaries of a larger parent company can create a federation agreement to allow one
party to provide access to its resources across the Internet. For example,Airplanes.com, an
airplane manufacturer, can conﬁgure a federation agreement with its business partner
Airplaneparts.com, in which Airplanes.com employees can access resources on the
Airplaneparts.com internal network using their company’s existing Internet connection.The
federation agreement conﬁgures the business rules that dictate which resources can be
accessed by whom, as well s the technical controls that will be used to authenticate users:
smart cards,Active Directory logons, the Microsoft Passport service, and the like.
NOTE
As of this writing, ADFS can be used only to secure Web-based applications; tra-
ditional client/server applications cannot leverage ADFS for authentication or
authorization.
Building a Windows DMZ
Building a Windows DMZ is not very difﬁcult; however, there are many moving parts that
you need to be concerned with in the initial design and for consistent maintenance.
Consider this situation:You are the systems engineer responsible for designing, imple-
menting, and maintaining a Windows DMZ segment that consists of an IIS Web server, an
FTP site, an external DNS server, and an e-mail relay.That doesn’t sound like a lot, but this
is one tall order. Consider the following:You will have to know (or ﬁnd the people who
know) how to conﬁgure hardware such as routers, switches, and the ﬁrewall.You must have
security applied to these items and others, such as an IDS if you need it or if the design
requires it.You have to place bastion hosts on the DMZ and conﬁgure security on them,
including hardening the base OS (Windows 2000 as well as Windows 2003) and then
applying the needed services and hardening them, too. Lastly, you need to know how to
engineer the trafﬁc to and from those services to other front-end or back-end systems,
www.syngress.com
58
Chapter 2 • Windows DMZ Design

depending on what the design calls for. In this last example, consider having an internal
DNS namespace and an external DNS namespace. How do you conﬁgure them to work
together through the ﬁrewall? This is the point behind this chapter (and much of this book),
which is to get you to think about these details so that your DMZ is a success, works prop-
erly, can be maintained, and is secure.
Now that we have taken a look at the fundamentals of laying out the hardware to create
the DMZ, let’s examine the details of populating it with a Windows solution.
Designing the DMZ Windows Style 
Now that you have the fundamental placement, design, and understanding, let’s get into
more detail concerning the Windows platform, since there is much to think about and much
to plan. In this section we cover domain models (how to conﬁgure your domain), devices
that sit on your DMZ segment, the names and deﬁnitions of systems revolving around the
DMZ, and much more. In this section we look speciﬁcally at the domain model, which can
confuse many architects who might not know the exact placement of the domain controllers
(DCs) and where the logical boundaries of the domain sit with the DMZ segment.
Domain Considerations
Building a domain with a DMZ segment can be confusing. For one, you have probably
heard many times that you should never expose an Active Directory DC to a public network
such as the Internet. If this advice is sound, how in the world do you set up domain-based
logins if you need a domain-based account for a particular service to work? Consider the
following:You need to implement a load-balanced cluster in your DMZ, and for the service
to work, the cluster account must log into a domain. If this were the case, where would you
place the DC? Figure 2.6 offers a possible solution.
Figure 2.6 A Cluster in a DMZ
Windows DMZ Design • Chapter 2
59
CORP.RSNETWORKS.NET
DNS
Database
EMail
DC1
FTP
INTERNET
DMZ
Internal
Network
DMZ 2
IIS1
IIS2
IIS3
Firewall directs
traffic as well as
securing the
perimeter
Load Balanced
Web Cluster
www.syngress.com

This solution is not impossible, but it can be tricky.Think of the trafﬁc ﬂow and other
issues you need to consider with your design:
1.
As you can see, your IIS load-balanced cluster will need to be accessible to the
Internet users who will want to see your Web site.
2.
If e-commerce solutions are available, the IIS servers need to know how to get to
the back-end database, if that is what you need for your solution.You must have a
way to get your IIS servers to communicate through the ﬁrewall to get to the
SQL server.Alternately, you can segment the back-end database into a DMZ of its
own rather than placing it on the internal LAN.Your design can be augmented by
doing so and then placing restrictions on the trafﬁc ﬂow between the Web cluster
DMZ and the database DMZ.
3.
You have two DMZ segments from your PIX ﬁrewall.You need to know how to
set security levels on each and how to deny trafﬁc coming from one segment to
the other. If someone exploits your DNS server and if you have not applies secu-
rity so that it does not allow this type of activity, it might only be a matter of time
before they get to your second DMZ.
4.
Your cluster needs to access a DC if it is using the Cluster Service, though the DC
in question does not necessarily need to be a DC on the internal LAN. Since this
is a load-balanced solution, you can forego that need, but if you place a cluster on
the DMZ, you need a nearby DC to service your requests.Alternately, you can
deploy a hardware-based load-balancer instead.
5.
Your ﬁrewall should be conﬁgured to allow for external public Internet trafﬁc to
come to your Web sites, but your Web servers can only make requests to the
database of the DC behind the ﬁrewall or a database server in a separate DMZ.
The Web servers need to deliver what was requested of them to the Internet users.
6.
Your ﬁrewall should also be conﬁgured so that your internal DNS server (not
shown) can communicate with its forwarder on the DMZ.The internal e-mail
server (also not shown) should be able to send e-mail back and forth to the relay
on the DMZ. Users should be able to get to the FTP site.
As you can see, now that you have planned it, you only need to pay for it, implement it,
and maintain it.That’s easier said than done, which is why you have this book. Remember,
this chapter is conceptual in nature; it’s not until you get to some of the later chapters that
you actually learn how to conﬁgure all these elements on the ﬁrewall.
NOTE
Depending on the model and type of ﬁrewall you use, you can in fact have dif-
ferent DMZ segments with different services on each, to add even more security
to your DMZ segments and hosts. 
www.syngress.com
60
Chapter 2 • Windows DMZ Design

The Internet Connection 
Your Windows DMZ solution needs to allow for Internet access. What must be known
about the Internet connection is that it should be able to handle the site’s required band-
width needs. If you are using this Internet connection as your LAN’s Internet access for
surﬁng and e-mail, and you decide to use it for a VPN as well, you need to analyze your
requirements ﬁrst.You can do a trafﬁc ﬂow analysis to ascertain the requirements quite
quickly, but you need to know how to do the analysis and have the tools with which to do
the analysis. If you do not, it is in your best interests to work with an outside vendor that
does have the required tools and experience. Failing to do so will almost always result in bad
performance and increased cost later, when you need to reprovision the lines to a higher
bandwidth. Everything you need to consider is shown in Figure 2.7.
Figure 2.7 Internet Connection Considerations 
Figure 2.7 shows four sections:
1.
The ﬁrst section you need to consider is the actual ISP you are connecting to.You
see here that we have two clouds; the reasoning is that our Internet connection
should be highly available. We suggest having at least two connections if your
company’s livelihood depends on use of the Internet.You can also diversify the
connections between providers and points of presence (POPs). If you have both
POPs in, let’s say, New York, and if New York develops a major problem (or a
single ISP goes down completely), you will still be available on the Internet. If
you have serious concerns about high availability, you should also consider geo-
graphically dispersed servers and/or deploying a disaster recovery site.
2.
Make sure you size your connections properly for high availability. Most vendors
and ISPs have sizing tools that help you determine how much bandwidth you
www.syngress.com
Windows DMZ Design • Chapter 2
61
INTERNET
FIREWALL
1.
2.
3.
4.

need to the Internet. If we had two T1s here, we would have almost 3MB of
trafﬁc to and from the Internet, which is not too bad at all.
3.
Make sure that you have a properly sized router. Make sure that the router can
handle all the Internet-based trafﬁc, both coming and going. Processing power,
available memory, and other factors can hinder your response time, so do not make
the router the bottleneck on the Internet.
4.
Do not let the last leg of the segment (for the Internet connection), which is the
connection into the ﬁrewall, be the bottleneck. Make certain that you have
100MB/full duplex or better here if possible. Most ﬁrewalls allow for Fast Ethernet
connectivity.
Remember, anyone can connect to and use the Internet, so the number (and frequency)
of your vulnerabilities will become much higher.Always make certain that all these areas are
secured properly; you can learn how to lock all this down in later chapters in this book.
Wide Area Network Link
A WAN link is really not much different from the Internet connection (they both use some
form of leased lines), but in a traditional sense, a WAN link describes the connections from
your company to others through the use of private lines.When we say private, we mean in the
sense that it is not accessible via the Internet, which is a publicly accessible arena.The WAN
link (T1, Frame Relay, ISDN) connects your remote sites up to the backbone located within
the core site. Most traditional designs show a hub-and-spoke formation. Here, in Figure 2.8, a
hub and spoke are shown connected to an Internet-based segment with a DMZ.
Figure 2.8 A WAN Connected to a Backbone with an Internet Connection
www.syngress.com
62
Chapter 2 • Windows DMZ Design
Server
Server
Servers
CORE NETWORK
Server
Server
EAST.RSNETWORKS.NET
SOUTH.RSNETWORKS.NET
WEST.RSNETWORKS.NET
NORTH.RSNETWORKS.NET
RSNETWORKS.NET

The reason that this concept is so important is that you will have to know how to get
trafﬁc from the LAN to either the WAN links or perhaps out to the Internet. How do you
do this? Let’s go through the process step by step while looking at Figure 2.8:
1.
You need to consider the design. In Figure 2.8, we have a core network (where
the major resources are located) connected to the Internet and also to a Frame
Relay network with two remote sites. How do you direct the trafﬁc? How do the
remote sites access the Internet? 
2.
Look at Area 1; you can see that the Internet connection has been established cor-
rectly, as shown in the last section. Now you need to visualize how users will gain
access the Internet; to the user, this process should be transparent: Click the Web
browser and out you go! This is set via the proxy settings in the Web browser (as
shown in Figure 2.9) or via the default gateway of the client (as shown in Figure
2.10).The proxy setting will be valuable to you if you use a proxy server to get to
the Internet. (A proxy server DMZ-based system is described in Chapter 8, when
we take a granular look at ISA Server.) If you need to see what your default
gateway is set to, you can do an IPCONFIG /all to get all the IP settings for your
Windows NT or 2000/2003 system. If you are using older 9x versions,
WINIPCFG will do the same.You need to know your default gateway because
this is how you will direct trafﬁc in an enterprise DMZ. Remember, if you have
only an Internet connection, the Internet connection-based router (or the ﬁrewall
in front of it) can be your default gateway.
Figure 2.9 Proxy Settings for a Web Browser 
Figure 2.10 Default Gateway Settings for a LAN Client 
Microsoft Windows 2000 [Version 5.00.2195]
(C) Copyright 1985-2000 Microsoft Corp.
www.syngress.com
Windows DMZ Design • Chapter 2
63

C:\>ipconﬁg /all
Windows 2000 IP Conﬁguration
Host Name . . . . . . . . . . . . : SHIMONSKI-LAPTOP
Primary DNS Sufﬁx
. . . . . . . :
Node Type . . . . . . . . . . . . : Hybrid
IP Routing Enabled. . . . . . . . : No
WINS Proxy Enabled. . . . . . . . : No
DNS Sufﬁx Search List. . . . . . : rsnetworks.net
Ethernet adapter Local Area Connection 3:
Connection-speciﬁc DNS Sufﬁx
. : rsnetworks.net
Description . . . . . . . . . . . : Wireless Network PC Card
Physical Address. . . . . . . . . : 00-23-15-26-1E-3D
DHCP Enabled. . . . . . . . . . . : Yes
Autoconﬁguration Enabled . . . . : Yes
IP Address. . . . . . . . . . . . : 192.168.2.100
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 192.168.2.1
DHCP Server . . . . . . . . . . . : 192.168.2.101
DNS Servers . . . . . . . . . . . : 192.168.2.102
192.168.2.103
Lease Obtained. . . . . . . . . . : Sunday, May 25, 2003 8:04:49 AM
Lease Expires . . . . . . . . . . : Monday, May 26, 2003 8:04:49 AM
C:\>
3.
Now that you understand that portion, you need to understand Area 2, which is
the default gateway for the LAN, as shown in Figure 2.8. Now you need to engi-
neer the WAN link behind your default gateway, or it must be the default gateway
if you have an Internet connection to get to.To get to the Internet or the
Internet-based proxy/ﬁrewall, you need to know how to view the routes in your
router. In Figure 2.11, we did a show IP route command on the Cisco router.This
gave us a routing table, of which we show only the beginning.You can see here
that the last line shows what’s called the gateway of last resort.Your Windows systems
will need to know what this is to get out to the Internet if they are connected
anywhere on your internal LAN or if they are one of your remote sites. Figure
2.12 shows you the command to add this route.
www.syngress.com
64
Chapter 2 • Windows DMZ Design

Figure 2.11 The Routing Table on the WAN Router
WANROUTER#sh ip route
Codes: C - connected, S - static, I - IGRP, R - RIP, M - mobile, B - BGP
D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS
* - candidate default, U - per-user static route, o - ODR
P - periodic downloaded static route
Gateway of last resort is 10.10.10.100 to network 0.0.0.0
Figure 2.12 Adding a Route to the Router 
ip route 0.0.0.0 0.0.0.0 10.10.10.100
4.
Area 3 is the frame cloud.The frame cloud needs to be engineered and provi-
sioned properly, with the proper access port size and Committed Information Rate
(CIR) based on your needs. Make sure you size the frame cloud properly and ask
for a bandwidth and utilization report a few months after you use it, to make sure
you are not overpaying for what you don’t need or undercutting your remote sites
by not giving them the bandwidth they need to do their jobs. Remember, you
need to allow your remote sites to access the Internet through your core, so you
need to properly size the frame links (or any other WAN connection technology).
5.
Last but not least, take a look at the remote sites. Note that these sites need to
travel up to the core router, and then the core router needs to send the Internet
requests up the ﬁrewall, which directs the requests out to the Internet. Look at
Figure 2.13. It clearly shows the trafﬁc ﬂow needs.And remember the gateway of
last resort we saw in Figure 2.11? This same gateway will be used in the remote-
side router, with one exception—the IP address of the gateway will be the core
router, as shown in Figure 2.14.
www.syngress.com
Windows DMZ Design • Chapter 2
65

Figure 2.13 Internet Trafﬁc Out from a Remote Site
Figure 2.14 The Routing Table on the WAN Router
WANROUTER#sh ip route
Codes: C - connected, S - static, I - IGRP, R - RIP, M - mobile, B - BGP
D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS
* - candidate default, U - per-user static route, o - ODR
P - periodic downloaded static route
Gateway of last resort is 10.10.10.1 to network 0.0.0.0
Take another look at Figure 2.13. It is imperative that you understand the ﬂow here.A
user at a remote site needs to access the Internet via the WAN link.The user is on the
remote site LAN with an IP address of 10.10.102.5/24, given via a DHCP server.The
default gateway for the LAN is the 10.10.102.1 router.The user makes a request of the
Internet, and because the IP address is not local to the LAN (10.10.10.100), the request must
be forwarded to the default gateway on the LAN. Because of the route added (as shown in
Figure 2.14), the router knows to forward the request up through the Frame Relay WAN to
10.10.10.1, which is the main core router through which the Internet is connected.You
should start to see the picture here now.The core router sends the request to the ﬁrewall (or
proxy, or whatever you have conﬁgured), and it forwards the request once again to the
Internet router on the perimeter of your network.
www.syngress.com
66
Chapter 2 • Windows DMZ Design
INTERNET
FIREWALL
1.
2.
3.
4.
FRAME RELAY
REMOTE SITES
CORE NETWORK
10.10.10.1
10.10.10.100
10.10.101.1
10.10.102.1

NOTE
Never forget: You will need to conﬁgure the route back to the remote site as well.
You can add a routing protocol or static routes in reverse, depending on what you
need to do. For help, you can use ping and tracing tools (tracert for Windows and
Traceroute for UNIX) to ﬁgure out how to get to and from each site. 
As you can see, it’s very important that you know how to design and engineer the WAN
link (in conjunction with the Internet connection) or you will be running around in circles
trying to ﬁgure out why your Windows workstations cannot communicate over the
Internet.
Server and Domain Isolation Using IPSec
As an alternative to a physical DMZ, you can use IPSec to create logical groupings of trusted
hosts on your network and to prevent untrusted computers from being able to communicate
with your domain computers. In other words, you can isolate the computers within an Active
Directory domain so that they cannot exchange any network trafﬁc with computers that are
not domain members.This approach is useful for environments that have numerous “visiting
users” who need basic Internet access (such as salespeople or conference attendees visiting a
corporate campus) but who should not have access to sensitive resources stored on corporate
ﬁle and application servers. Microsoft has published a great deal of information about server
and domain isolation; it can be found at www.microsoft.com/sdisolation.
DMZ Perimeter Security
The DMZ is an isolated segment through which you simply allow services to Internet users
while still maintaining some form of security on your network.To allow users to come into
your corporate network unknown, unwatched, and consistently will surely lead to an attack
somewhere down the line, if not instantly. In this section we look at all the areas you need to
consider while building your Windows DMZ. In the last section we took a look at where
your internal resources need to be, how they need to be laid out, and some special consider-
ations to take into account. Here we look at the reverse of your protected network (where
your LAN meets your internal ﬁrewall port), which is the unprotected network.This is your
DMZ and Internet connection, which make up your network perimeter.Although the claim
is that they are “unprotected,” we will make them “highly protected”—or as much as we
can! Let’s take a look.
The External Router
The external router is the router that connects you to the Internet.Again, there can be more
than one, and it’s recommended (depending on your needs) that you have at least two con-
www.syngress.com
Windows DMZ Design • Chapter 2
67

nections the Internet.The external router connects the protected network and DMZ to the
WAN Link.The router provides the ﬁrst opportunity to actively permit or deny access for
clients and servers and for network services.This means that you can apply ACLs,AAA, log-
ging, and much more to the ﬁrst line of defense of your network.You will want to read
Chapter 13 in its entirety to learn how to lock down the Internet router, but for now, simply
understand its importance in the design.
The Firewall
As you already know, a ﬁrewall is the “trafﬁc cop” in the middle of your DMZ, public
Internet, and private LAN that handles incoming and outgoing trafﬁc and places that trafﬁc
where it needs to be against the rules that you create for it—simple as that.Your ﬁrewall, if
conﬁgured properly, will aid you in building and maintaining security on your perimeter
network.A ﬁrewall is simply an enforcer of a security policy. (Security policy is explained in
detail in the sidebar,“Guidelines for Creating a Good Security Policy-Based DMZ.”) A ﬁre-
wall should reside at the perimeter of your network and protect your data from malicious
attackers and wrongdoers.As shown in Figure 2.15, your ﬁrewall can have many interfaces.
Figure 2.15 Firewall Interfaces 
Let’s look at each section to see what these interfaces can connect to. Section 1 is the
external WAN port on the ﬁrewall.This is the Ethernet connection that connects your
system to the external router. Section 2 is the ﬁrst DMZ leg and has IIS Web services on it.
Section 3 is the connection into the corporate network—the private network. Section 4 is
the second DMZ leg with a DNS server on it.The point here is to show you that you could
www.syngress.com
68
Chapter 2 • Windows DMZ Design
INTERNET
1.
2.
DMZ1
DMZ2
3.
4.

have multiple DMZs set by one single ﬁrewall! As you will see in Chapter 5, there are many
ways you can deliver secure services though multiple DMZs with only one ﬁrewall.Three
interfaces are recommended: one for incoming trafﬁc, one for access to the demilitarized
zone, and one that connects to the protected network. But remember, if you need more than
one DMZ, you can create multiple ones.
NOTE
In Chapter 8, you will learn all about Microsoft’s Windows-based proxy and ﬁre-
wall product, ISA Server. ISA (which stands for Internet Acceleration and
Security) allows you to build a DMZ ﬁrewall and create a protected solution
with a Microsoft product. 
Designing & Planning…
Guidelines for Creating a 
Good Security Policy-Based DMZ
We mentioned the importance of a ﬁrewall and alluded to the fact that a ﬁrewall
is essentially the enforcer of a security policy. This means that your ﬁrewall will
be conﬁgured to mirror the needs and requests of the corporation. For instance,
if you want to create a security policy that states, “No remote user can pass the
DMZ. Only users needing to access our IIS Web server from the Internet can
access that single server, and nowhere else can they go though or pass the DMZ,”
all you need to do is conﬁgure the rules on the ﬁrewall (PIX, Check Point, Nokia,
ISA) to reﬂect that need, as shown in Figure 2.16. 
Let’s examine that need against what we actually conﬁgured: We need to
have only Internet users access the IIS server at 12.10.11.2. This is done through
the ﬁrewall and its ruleset; you add a rule to the ﬁrewall stating that any user
needing to get to an IIS server should be sourced from the Internet. The ﬁrewall
also knows that if the IIS server is compromised, no request from the 12.10.11
network needs to go to the 10.10.10.0 subnet in the private network. As you see
from Request 2 in the ﬁgure, you can’t allow users to go through the ﬁrewall to
attach to the Web server, because this capability is not in the security policy. 
www.syngress.com
Windows DMZ Design • Chapter 2
69
Continued

Figure 2.16 Trafﬁc Directed to an IIS System on the DMZ
Extra DMZ Routers
Sometimes (if the size and complexity of the network dictate) you’ll need a router on each
leg of the ﬁrewall.This concept is illustrated in Figure 2.17.At times, you will get requests to
either add security to the segment you are working on or add more and more devices to it,
where you might need to either route or direct trafﬁc. Some ﬁrewalls will not route like a
router; in other words, a ﬁrewall might route the RIPv1 protocol, whereas a router will
route IS-IS, OSPF, EIGRP, RIP, and so on.A router does just that—it routes.A ﬁrewall can
in fact route if it is conﬁgured to do so, but often, depending on how paranoid you are, you
could decide to keep these services dependent on the device in which they sit.You might
even want to separate these roles, even if you are using a true enterprise-class ﬁrewall that is
capable of handling multiple routing protocols.
The added routers can increase security and ﬂexibility, but they can also add complexity.
The only real time you need to use this is when the ﬁrewall is not part of the protected net-
work.The DMZ router ﬁlters on the services the DMZ provides and denies all other trafﬁc.
A good way to envision this concept is if you have a ﬁrewall that will do NAT. If the ﬁrewall
provides NAT, the DMZ router will verify that all connections originate from the ﬁrewall,
which will add to your safety. With the internal network router (shown in Figure 2.19), you
can see another level of security against attack.The threat that lingers most on the internal
network is the end user. If conﬁgured properly, the internal router can be used to protect
your ﬁrewall and DMZ from internal attack.The rules you set up on the router should
www.syngress.com
70
Chapter 2 • Windows DMZ Design
INTERNET
FIREWALL
1.
2.
CORE NETWORK
10.10.10.1
12.10.11.2
12.10.11.1
12.10.10.1
DMZ
computer
Web Server
10.10.10.15

mimic those conﬁgured on the ﬁrewall. Router hardening and lockdown are covered in
Chapter 13 of this book.
Figure 2.17 Extra Routers Added to the DMZ Segment  
NOTE
Although this solution might be deemed overkill, you never know what level of
security a company and its security team are willing to use for the most protec-
tion. Never underestimate the client’s needs; always bring up options in design
meetings so that you can let the stakeholders in the project decide what they
want to spend for the level of decreased risk. 
Name Resolution for the DMZ
Too often, DNS and WINS servers are misplaced when people work with the DMZ. Is there
a speciﬁc design you need to follow? In essence, yes, there is.The importance of name resolu-
tion in the DMZ matters only if you in fact need it. Let’s look at a quick design map so you
can follow along. Figure 2.18 shows you that it is very important to use static addressing on
your DMZ and on your public Internet segments so that a publicly accessible resource like a
Web server will not continually receive a new IP address from DHCP; this would make it dif-
ﬁcult for outside users to access this resource consistently, since its IP address would not be a
“known quantity.” If a hacker is able to tap into and exploit your DNS server, for example,
she would gain access to all IP and name information for your network. If your DMZ is not
www.syngress.com
Windows DMZ Design • Chapter 2
71
INTERNET
FIREWALL
CORE NETWORK
10.10.10.1
12.10.11.2
12.10.11.1
12.10.10.1
DMZ
computer
Web Server
10.10.10.15

very large (which it normally is not), you should use static addressing. DNS,WINS, and even
DHCP are more suitable for the internal network, where you are more likely to have more
hosts, so it is safer to put it there and only have to look for internal attacks.
Figure 2.18 Name Resolution in the DMZ 
DMZ Mail Services
Too often, mistakes are made with e-mail service placement due to the administrator’s lack
of knowledge of how and where to place such services! There are really only two ways to
place an e-mail server easily within a DMZ. For one, you can place the e-mail server (only
one for this example) in the private network.The ﬁrewall in front of the e-mail server would
be responsible for taking all requests in and out of the network and for securing the trafﬁc to
the e-mail server. Due to the server’s design, it made the relaying of outbound Internet-
based e-mail the responsibility of the e-mail server—only one single server.The question
then, however, is,“Why would we want to expose our e-mail server to the public Internet?
What if somehow there was a way to attack the e-mail server directly through the ﬁrewall?”
(Not to mention the deluge of spam and virus-infected e-mail messages that would be clog-
ging up your internal mail server as a result.) Figure 2.19 shows you the design we are
talking about.You can see the e-mail server behind the ﬁrewall, allowing public Internet
access directly to your private corporate network.
www.syngress.com
72
Chapter 2 • Windows DMZ Design
INTERNET
FIREWALL
1.
2.
CORE NETWORK
10.10.10.1
12.10.11.2
12.10.11.1
12.10.10.1
DMZ
computer
Web Server
10.10.10.15

Figure 2.19 E-Mail Server Behind the Firewall
Mail Relay
Several risks are associated with the receipt of e-mail from potentially untrusted entities out-
side the site. Now that you can visualize this situation, let’s consider an alternative. Would
you want your Microsoft Exchange server exposed in this manner? Would you want your
Sendmail server attacked and penetrated so that the attacker has direct access into your net-
work? Of course you wouldn’t. Because of this vulnerability, it is common to simply add
another e-mail server to the DMZ segment and use this server as a relay to and from the
protected e-mail server in the private network.The server now becomes what’s called an e-
mail relay, and it will relay the mail to and from the Internet and to and from the mail server.
If mail relays (IIS has an SMTP service that can be used as a relay) are compromised, you
can simply reinstall the server from scratch and not lose a thing, because all the server did
was relay trafﬁc.
Web Servers
Web servers are the most common form of DMZ-based hosts today. Other services are
needed, such as DNS and e-mail, but if you really think about it, the main reason DMZs
even exist is due to the public Internet Web surfer feeding frenzy.Almost every company in
business in the world now has a publicly accessible Web site, which means that just about
every company worldwide either has an Internet presence or is looking to have one.Thanks
to all these personal invitations to companies’ corporate networks, it is imperative that you
also plan your security completely or your network could be exploited.
www.syngress.com
Windows DMZ Design • Chapter 2
73
CORP.RSNETWORKS.NET
DNS
IIS
EMAIL
FTP
INTERNET
DMZ

External Web Server
Organizations frequently have data they want to publish to the external network via a Web
server.Again, to allow direct access to the Web server via the Internet while the server is sit-
ting in your private and protected LAN would create a signiﬁcant security vulnerability. For
that reason, allow an external Web server to be placed on the DMZ.This way you can allow
all your visitors to come directly to your IIS server and not have them exploit that server
only to ﬁnd ways to get to other systems. If the IIS server is external on the DMZ, you can
at least have some defense against it if it is compromised in any way.
Internal Web Server
Your internal Web server is nothing more than an intranet you set up for HTTP and other
Web-based access for use within the LAN and not for public access.Your internal Web
server will be secure from the Internet only if you never directly connect it to the Internet.
Once you do, you move the server out to the DMZ and it becomes an external Web server.
Designing Windows DNS in the DMZ
The last (and most common) services to see on the DMZ, both internally and externally, are
the DNS servers for your organization. If you are using DNS to resolve your company’s IP
address to easy-to-remember names, this section is for you. DNS services are now the single
most common service used for name resolution; WINS and NetBIOS-based name resolu-
tion is still around for some Microsoft application support, but even this will be phased out
over time. Because of DNS’s growing use, it is important that when you plan your Windows
network, you are able to design the Internet namespace and the external namespace for the
organization.You can also set up your own primary servers in the DMZ, or you can forward
requests to others.
Figure 2.20 shows both solutions at work. For one, you can set up an internal names-
pace called PRIVATEDNS.NET.This is the company’s Windows DNS solution that the
entire Active Directory depends on. We do not want to expose that to the Internet if we
don’t have to. Now we can put a forwarder on the DNS server that resides in the DMZ.
This is called the external DNS server, which will be explained shortly.The last scenario is to
host your own public DNS servers.That means that even more trafﬁc will come to your site,
since others can use your DNS servers as well. If you opt to do this, make certain that you
secure your DNS servers as well as possible, since they will be exposed to external attackers.
www.syngress.com
74
Chapter 2 • Windows DMZ Design

Figure 2.20 Examining DNS in the DMZ
External DNS Server
The external DNS server resides in the DMZ and is for public use.The only information
that should be on the external DNS server is the information that needs to be advertised to
Internet clients—nothing more.You can use a Windows 2000 or Windows 2003 server, but
it is not uncommon to see Linux on the DMZ doing DNS forwarding. Not one piece of
internal DNS information should be kept on this system.The internal DNS server is unable
to communicate directly with the external network, because it will be conﬁgured to send
queries and receive the responses via the external DNS server.You have to ensure that DNS
UDP and TCP connections are allowed through the ﬁrewall to the external DNS server or
your solution might not work.
Engineering Windows Trafﬁc in the DMZ
Once you have ﬁnalized the DMZ network segment design and placed your systems where
they need to be (and understand why they need to be there), you have to consider trafﬁc
and applications ﬂows,ACLs, and ﬁltering. In this section we review the concepts you need
to allow for the proper trafﬁc to ﬂow where it is needed to and from the DMZ segment.
Trafﬁc engineering can be tough.Think of it like this:You build your DMZ (using
whatever ﬁrewall product you like—PIX, Nokia, Check Point, ISA), and now you have to
let services in and out. Other chapters in this book show you exactly how to do that (with
these exact vendor products), but it is important that you at least understand the concept of
it here as well as the fundamentals of design. Each chapter of the book grows more detailed
www.syngress.com
Windows DMZ Design • Chapter 2
75
PRIVATEDNS.NET
DNS
DNS
DNS
FTP
INTERNET
DMZ
COMPANYNAME.NET

in discussing to how to conﬁgure each device, but the concepts of design and the initial
layout are the most important by far.
First, you need to know what a port is.A port number is a number assigned to a service.
You can think of an IP address and a port number as analogous to a street address and an
apartment number. If you have ever lived in an apartment, you know that everyone in the
apartment complex has the same street address. So what tells the mail carrier where to put
everyone’s mail? The apartment number does. If it weren’t for the apartment number, all
organization would end once the mail got to your street address.You would have to search
through everyone’s mail to ﬁnd yours.This is the same concept behind IP addresses and port
numbers.The port number is used by a particular service. When a request is made, the port
number tells the computer which service it wants to talk to.You could say that the port
number deﬁnes the endpoints of a connection.The format for using port numbers is the IP
address followed by a colon and the port number. For example, let’s say that we want to con-
nect to the IP address 10.10.10.10 and we want to use the port for HTTP (port 80).The
syntax would be 10.10.10.10:80.
There are three port categories:
■
Well-known ports
■
Registered ports
■
Dynamic/private ports
The Internet Corporation for Assigned Names and Numbers (ICANN) is responsible
for managing port numbers.The well-known port numbers range from 0 to 1023.The regis-
tered port numbers range from 1024 to 49151.The dynamic and private ports range from
49152 to 65535. Most systems use the well-known port numbers to run system processes or
privileged programs. ICANN doesn’t control the registered port numbers. Most of the time
these numbers are used with nonsystem processes or nonprivileged programs, such as an
ordinary user running a program.Table 2.1 lists the well-known port numbers.
Table 2.1 Well-Known Port Numbers
Port Number
Transport Layer Protocol
Description
7
TCP, UDP
Echo
13
TCP, UDP
Daytime
19
TCP, UDP
Character generator
20
TCP, UDP
File Transfer Protocol (default data)
21
TCP, UDP
File Transfer Protocol (control)
22
TCP, UDP
SSH Remote Login Protocol
23
TCP, UDP
Telnet
25
TCP, UDP
Simple Mail Transfer Protocol (SMTP)
www.syngress.com
76
Chapter 2 • Windows DMZ Design
Continued

Table 2.1 continued Well-Known Port Numbers
Port Number
Transport Layer Protocol
Description
53
TCP, UDP
Domain Name Server (DNS)
67
TCP, UDP
Bootstrap Protocol Server
68
TCP, UDP
Bootstrap Protocol Client
69
TCP, UDP
Trivial File Transfer Protocol (TFTP)
79
TCP, UDP
Finger
80
TCP, UDP
World Wide Web HTTP
88
TCP, UDP
Kerberos
110
TCP, UDP
Post Ofﬁce Protocol Version 3 (POP 3)
118
TCP, UDP
SQL Services
119
TCP, UDP
Network News Transfer Protocol
(NNTP)
123
TCP, UDP
Network Time Protocol
137
TCP, UDP
NETBIOS Name Service
138
TCP, UDP
NETBIOS Datagram Service
139
TCP, UDP
NETBIOS Session Service
143
TCP, UDP
Internet Message Access Protocol
(IMAP4)
156
TCP, UDP
SQL Service 
161
TCP, UDP
SNMP
162
TCP, UDP
SNMPTRAP
179
TCP, UDP
Border Gateway Protocol
194
TCP, UDP
Internet Relay Chat Protocol
213
TCP, UDP
IPX
369
TCP, UDP
Rpc2portmap
389
TCP, UDP
Lightweight Directory Access Protocol
(LDAP)
401
TCP, UDP
Uninterruptible Power Supply (UPS)
443
TCP, UDP
HTTP over TLS/SSL (HTTPS)
445
TCP, UDP
Microsoft-DS
464
TCP, UDP
Kpasswd
500
TCP, UDP
Isakmp
513
TCP
Remote login via Telnet (login)
514
UDP
Syslog
530
TCP, UDP
Rpc
www.syngress.com
Windows DMZ Design • Chapter 2
77
Continued

Table 2.1 continued Well-Known Port Numbers
Port Number
Transport Layer Protocol
Description
563
TCP, UDP
NNTP over TLS/SSL (NNTPS)
568
TCP, UDP
Microsoft shuttle
569
TCP, UDP
Microsoft rome
593
TCP, UDP
HTTP RPC Ep map
631
TCP, UDP
Internet Printing Protocol (IPP)
636
TCP, UDP
LDAP over TLS/SSL (LDAPS)
637
TCP, UDP
Lanserver
689
TCP, UDP
NMAP
691
TCP, UDP
MS Exchange Routing
749
TCP, UDP
Kerberos administration
750
TCP, UDP
Kerberos version iv
What is so important about these ports is that when you get to later chapters of this
book, you will have to come back here to get the numbers to plug into the ACLs and ﬁlters
you create with your ﬁrewall of choice. Make sure that you understand the placement of
DMZ hosts and what trafﬁc to let through before you attempt to conﬁgure your ﬁrewall,
because the ﬁrewall conﬁguration will solely depend on that information (port, service,
placement) ﬁrst! You can’t direct trafﬁc if you don’t know where to send it and what num-
bers you need to plug in to get that movement in the ﬁrst place. If you have the network
design shown in Figure 2.21, what trafﬁc map would you design? 
Figure 2.21 Windows Trafﬁc in the DMZ
www.syngress.com
78
Chapter 2 • Windows DMZ Design
EMAIL
RELAY
DNS
DNS
EMAIL
INTERNET
DMZ

Let’s look at this subject in more detail:
■
You have an internal DNS server that needs to communicate with an external
DNS server to forward queries.
■
You have an external DNS server that needs to communicate with the Internet
DNS.
■
You have an e-mail server and its e-mail relay to the Internet to consider.
■
You have an e-mail relay that needs to send mail to the Internet.
Now that you have looked at the trafﬁc map, you need to conﬁgure the rules in the
ﬁrewall.You will have to use DNS and e-mail ports from Table 2.1. For DNS, you can use
port 53, and for e-mail services, you’ll use SMTP to send mail on ports 25.Again, there are
many more services and many more ports, but if you lay out the map and think about the
communication paths, you can easily plug in the numbers and then go to the appropriate
chapter in the book to ﬁnd out how to conﬁgure the necessary rules, ﬁlters, and ACLs.
Assessing Network Data Visibility Risks
Now that you have engineered the trafﬁc to ﬂow into and out of your network, what is
really the risk of others seeing this trafﬁc? Tools to eavesdrop on trafﬁc are freely available on
the Internet and can cause you much pain when you try to build a Windows DMZ.
Depending on the structure of your network, an attacker can use a network sniffer to
explore and map the hosts it contains. We won’t spend too much time on this topic, because
it’s really the concept you have to get down here.You need to think about the problems you
could encounter while building your DMZ, if you do let certain trafﬁc traverse your net-
work and over the Internet, and decide which ports and services to allow or disable.
Conﬁguring & Implementing…
Disable NetBIOS and SMB!
Disabling NetBIOS on servers in untrusted networks (or anywhere in general) is
always a good idea. Just remember to test before you do, in case an application
you are using is dependent on that service. Other than that, disable away.
NetBIOS is by far the poorest form of secure name resolution you can ﬁnd.
Always use DNS if you can, but in case your Windows networks contain any
legacy systems (anything predating Windows 2000), you are sure to need
NetBIOS. Always disable NetBIOS if it’s not needed on your DMZ hosts or they will
be exploited, without question. Servers in the perimeter network should have all
www.syngress.com
Windows DMZ Design • Chapter 2
79
Continued

unnecessary protocols disabled, including NetBIOS and server message block
(SMB). These protocols should both be disabled to counter the threat of user enu-
meration. You can think of user enumeration as a form of information gathering
so that the attacker can ﬁnd other ways to attack from the information he or she
has gathered. This information includes domain and trust details, shares, user
information, groups and user rights, and even Registry information. You will
want to disable NetBIOS whenever possible. To do this from a ﬁrewall, you can
block all communication using the following ports:
■
UDP/137 (NetBIOS name service) 
■
UDP/138 (NetBIOS datagram service) 
■
TCP/139 (NetBIOS session service) 
SMB uses the following ports: 
■
TCP/139 
■
TCP/445 
To disable these on a host, you can remove File and Printer Sharing for
Microsoft Networks and Client for Microsoft Networks using the Transmission
Control Protocol/Internet Protocol (TCP/IP) Properties dialog box in your Local
Area Connection properties. Once you have done that, there is one more option.
This is the easy way to disable SMB:
■
Open the Device Manager. (You can get to it from the Control
Panel of the Computer Management Console.) 
■
Once you open Device Manager (in Computer Management view,
as shown in Figure 2.22), you can then show the hidden devices
(where the driver is) by right-clicking the Device Manager icon and
selecting View and then Show Hidden Devices.  
■
Expand the Non-Plug and Play Drivers. 
■
Right-click NetBIOS over Tcpip, and then click Disable. Once this is
done, you will disable the SMB direct host listener on TCP/445 and
UDP 445.
■
Close the Computer Management console to ﬁnish. 
You can also use the Windows Firewall or IPSec policies to control ﬁle and
print sharing trafﬁc on an individual computer or on multiple computers in an
Active Directory domain using Group Policy Objects.
In sum, these steps show you how to engineer trafﬁc on a Windows 2000
and a Windows 2003 network. You need to know how to direct trafﬁc as well as
how to enable and disable it. An attacker can research just as easily as you can,
and this is what they are looking for—the exploits you have forgotten about and
left wide open. 
www.syngress.com
80
Chapter 2 • Windows DMZ Design
Continued

Figure 2.22 Disabling NetBIOS over TCPIP
Not all trafﬁc engineering is completely without repercussion to a produc-
tion environment, so you need to test your efforts before going live into produc-
tion. You could disable a service or driver only to ﬁnd out an application that
depended on it no longer functions properly. When you disable the NetBIOS over
TCP/IP driver, for instance, you have effectively disabled the nbt.sys driver. This
driver could be used by another application. Just be careful and test your appli-
cations in a test environment before making “live” changes. 
Windows DMZ Design Planning List
Until now we have looked at ways to build a Windows DMZ. We have covered the network
hardware needs and basic layout, the devices that will populate the DMZ, the types of sys-
tems you need to place on your DMZ, and the engineering of trafﬁc through the DMZ.
The last thing you need to know is the population of systems in the DMZ, such as Windows
hosts, DNS servers, and others.Again, this information is covered in detail in Chapter 13.
For you to properly plan your Windows 2000/2003 DMZ, follow these checklists to get
yourself from start to ﬁnish.These are by no means all-inclusive lists, but they should serve
you well in getting started, getting the foundation of what is needed up and running.Then,
if necessary, you can populate the list with more items you need or want.
To successfully start your Windows 2000/2003 DMZ implementation, begin with our ini-
tial discussion on planning: network engineering, systems engineering, and security analysis.
■
Network engineering
www.syngress.com
Windows DMZ Design • Chapter 2
81

■
First, start with your vision.You must have current network topology maps
handy and a map of what it is you plan to do.There are many examples
through this chapter and this book on how to make a proper topology map
for your organization.
■
After the planning stage, you can either start to work on a prototype, or pilot,
or go live. No matter what you decide, you should do some testing or visit a
location (or another business) to analyze their Windows 2000 DMZ solution
to see if your scaling requirements are right.
■
Don’t undercut yourself. If you need to scale up or out, plan that in now, so
you can get a jump on future requirements.
■
Get the devices you need, lay them out, test them, and then implement them
into the design.
■
Make certain that you harden your network engineering devices.They will be
exposed to the Internet and are just as vulnerable to attack as your Web or
DNS servers.
■
Systems engineering
■
Plan the placement (logically and physically) of your DMZ hosts. Since you
are using Windows 2000 or Windows 2003, you can look at IIS for a Web and
FTP server as well as an SMTP relay, Windows 2000/2003 DNS services,
Exchange 2000/2003, ISA Server 2004, and so on.
■
Once you plan your systems, you need to engineer the communications
between devices in the DMZ and behind it.
■
Once you have the planned communications, you can start implementation.
■
Bastion hosts installation and lockdown
■
As you populate the DMZ with hosts to provide services, you need to harden
them.
■
Harden the base Windows 2000/2003 operating system ﬁrst. (You’ll ﬁnd
details in Chapter 13.)
■
Harden each individual service you implement. (You’ll ﬁnd details in Chapter
13 and Appendix A.)
■
Security analysis
■
Run tests on your Windows DMZ to ensure that all devices are locked down,
hardened, secure, and ready to provide services to the public Internet.
■
Test all connections and all devices, and use a plethora of tools to test different
types of attack.
www.syngress.com
82
Chapter 2 • Windows DMZ Design

■
Run service packs, hotﬁxes, and anything else to test, harden, secure, and
tighten up the perimeter or your network could be exploited.You can refer to
Chapter 14 to learn how to hack the DMZ and test it.
A Look Forward to Longhorn
The next release of the Windows Server operating system, currently codenamed Longhorn,
will have a number of new features that provide additional capabilities for securing DMZ
and other perimeter and remote networks.The three major features that administrators will
ﬁnd useful in this arena are the Read-Only Domain Controller (RODC), Server Core, and
Network Access Protection (NAP).
Introducing the Read-Only Domain Controller
The RODC is being designed for environments such as a branch ofﬁce, where you need to
deploy a domain controller but you cannot guarantee its physical security. Unlike the Backup
Domain Controller (BDC) from NT 4.0, RODC will store only a conﬁgurable subset of
your Active Directory database in its local copy of the AD database. For example, if you have
a branch ofﬁce with only 20 users, you can conﬁgure an RODC in that location so that it
stores only those 20 user accounts in its local database. If any users other than those 20 need
to authenticate at the local branch, they’ll need to contact a DC in the main ofﬁce to
authenticate; if the WAN link between the branch ofﬁce and the main ofﬁce is unavailable,
any user whose credentials haven’t been stored on the local RODC (including domain
administrators) will be unable to log in. (You can still log on using a local administrative
account for troubleshooting.) In addition, accounts belonging to certain “special” groups
such as domain admins and enterprise admins will not be cached on an RODC by default.
This increases the security of your domain controllers by minimizing the number of account
passwords that will be compromised if an RODC is hacked or physically stolen.
Slimming Down with Server Core
In addition to the full-blown version of Longhorn Server, you will also be able to install
Longhorn in a Server Core conﬁguration, which allows you to deploy a small-ﬁngerprint ver-
sion of Longhorn Server, with an installation size that’s as little as 500MB. Server Core
cannot run anything requiring a graphical user interface (GUI), the .NET Framework, or
any component that relies on managed code.This simpliﬁed conﬁguration allows you to
deploy modular servers that are dedicated to only one or two components, such as domain
controller or ﬁle/print services.
www.syngress.com
Windows DMZ Design • Chapter 2
83

Using Network Access Protection
In an era of laptop computers, pervasive wireless access, and high-speed Internet access in a
majority of homes, virtual private networks (VPNs) have blurred the notion of the network
perimeter much more than it has been in the past.This creates new risks for an enterprise
network, since administrators often can’t maintain a strict level of control over these laptops
and other remote computers; VPNs can often become a threat vector through which viruses
and malware can infect an internal network.To help combat this problem, Longhorn will
offer Network Access Protection (NAP), which will bring a “quarantine” feature for any
wired or wireless clients connecting to a corporate network. Using NAP, you can prevent a
remote client from accessing your network resources until it has passed one or more “health
checks” that can ensure that a remote client has the appropriate antivirus software installed
with up-to-date deﬁnitions and that a client is running a particular operating system and
patch level; it can even scan incoming clients for particular malware infections or other vul-
nerabilities. Using NAP, you can extend the logical perimeter of your network to include
remote clients in a much safer and more controlled manner.
www.syngress.com
84
Chapter 2 • Windows DMZ Design

Summary
Although this is only the second chapter in the book, you should start to see many concepts
coming together.The demilitarized zone, or DMZ, is probably the most difﬁcult segment to
design and engineer on your network. In this chapter in particular, you should have acquired
the foundation to lay out and build a Windows-based DMZ.Again, it’s not merely knowing
Windows, Cisco, or any other vendor’s products that will get you through the design and
implementation of a Windows DMZ, but all this knowledge put together underlies a simple
set of concepts: Design the network, design the systems, and then test them all for security.
We looked at that process in great detail in this chapter.You learned how to lay out all the
hardware you need, set up a plan and a design with a topology map, plan where the systems
will be placed—in front of, behind, and within the DMZ segment formed by the ﬁrewall
you use. Other chapters focus on more granular aspects such as bastion hosts, hardening,
testing, and so on, but this chapter should have laid the groundwork for your design.
When considering Microsoft Windows (or any other vendor OS), you need to consider
system placement and trafﬁc engineering.You need to know exactly what ports and services
that OS needs to rely on to communicate and function properly.Although Windows Server
2003 is a much more secure operating system than its predecessors, it is only as secure as you
can make it.Therefore, it’s very important that you followed the content of this chapter
closely, since everything you learned here will be used in the DMZ of your network.The
DMZ is the segment exposed to the Internet, so it is critical that you understand the con-
cepts not only in this chapter but in this entire book. We can’t stress it enough: If you place
Windows servers on your DMZ, pay close attention to hardening techniques and proper
trafﬁc ﬂows, or you could be exploited.
In this chapter we covered how you can design a Windows-based network solution that
will work within and around the DMZ segment. It’s important to know how to perform
this task as a security administrator or engineer because the DMZ can be very complex to
work with and around. In this chapter you learned how to use your Windows systems
within the DMZ design.
Lastly, this chapter focused not on learning Windows security concepts but on how to
design the proper DMZ layout. In other chapters you will learn the granular details needed
to implement security, harden systems, and test those systems to ensure that they are secured
properly.
This chapter should have served as a rough design document to help you place your
Windows systems and the services they run within the DMZ. It is common for many adminis-
trators to wonder how to place their systems within the DMZ, especially when they are Web
or FTP servers facing the Internet and publicly accessible.As we mentioned in the chapter, this
job can be nerve shattering, especially with all the publicity Microsoft has gotten in the past as
being an insecure system with many bugs, unchecked buffers, and a plethora of other problems
resulting in becoming the biggest target on the Internet today.This chapter should help you
remedy those fears by providing you with the answers and solutions you need to not only
place the systems in and around the DMZ but also to protect them.
www.syngress.com
Windows DMZ Design • Chapter 2
85

Solutions Fast Track
Introducing Windows DMZ Security
■
To begin, we need a general idea of what it’s going to look like on a map.All
good network designers plan the topology (hopefully with a topology map) and
ﬁgure out trafﬁc ﬂows, logical addressing, and any other factors that would affect
the systems operating as advertised. If you choose not to follow this
recommendation, you could ﬁnd yourself very discouraged when the network
does not function properly and systems cannot be accessed because of a simple (or
complex) mistake you made in the design.
■
The DMZ segment can be one of the most complicated segments to design and
implement on the network. When you add Windows to the mix, you not only
have to be an expert in security but also network engineering as well as Windows
system design and the services to be made available. In sum, make sure you plan
your implementation very closely.
■
The three main sections you need to consider when you’re building your
Windows DMZ are network engineering, systems engineering, and security
analysis.
■
Your ﬁrst step in designing a Windows-based DMZ is to select all the networking
hardware you will need.You must assess your needs, trying to ﬁgure out what the
hardware infrastructure will cost your company.You need to look at needs ﬁrst.
When you are looking at the networking end of it, you should ask yourself,“What
devices will I need, and how should I scale them?” Exploring these questions will
bring about answers based on networking gear and costs.
■
When planning your infrastructure, you always need to ensure that you plan the
proper equipment list, no matter what vendor you pick. If you are purchasing this
much equipment, presales support might be in order.Ask you vendor to show you
user limits per device (how many users can simultaneously use this device without
affecting its performance) as well as the type of trafﬁc you will be pumping
through it. Often, the vendor can help you design your network so that you don’t
fall short on what you need or do not go into overkill where you might not need
the extra power.
■
When you want to populate the DMZ with Windows hosts, you need to think
about access to and from the DMZ and the services that are needed.The reason
behind this initial thought is that your end users, customers, potential customers,
and outsiders will be able to utilize needed resources and only those needed
resources—nothing more, nothing less.To start the engineering process, you have
www.syngress.com
86
Chapter 2 • Windows DMZ Design

to ﬁrst make certain that you have these answers! You should make sure that users
can obtain the information that they need about your company without accessing
the internal network and only by accessing the DMZ or accessing the Internal
network safely, if you chose not to implement a DMZ. If you can, it’s always better
to segment Internet-based resources via the DMZ for an added level of safety.
Now that you know your network layout, you have to think about other access to
and from the DMZ.
■
Your secret, protected, conﬁdential, and proprietary information should be stored
behind your ﬁrewall and DMZ on your internal network. Servers on the DMZ
shouldn’t contain sensitive trade secrets, source code, proprietary information, or
anything that can be used against you or your company—or be used to exploit or
hack your systems. (There’s more on DMZ hacking techniques in Chapter 14.) A
breach of your DMZ servers should at worst create an annoyance in the form of
downtime while you recover from the security breach.
■
A Web server that holds public information is a common example of a DMZ host.
This can be IIS (since we are discussing Microsoft technologies in this chapter) or
any other publicly accessible Web server.You can also think of FTP services,
NNTP services, and other Web-based services to be accessed and utilized.
■
Electronic commerce-based solutions always wind up on the DMZ.This is the
front end of an e-commerce transaction server through which orders are placed.
Keep the back end, where you store client information, behind the ﬁrewall.You
want to design this properly; if you don’t, you could potentially compromise your
entire client database (or personal and private data) if it’s exploited.
■
A mail server that relays outside mail to the inside will be a highly utilized
solution in the DMZ, especially since spam and other e-mail exploits are common
DMZ host-based targets for attacks.
■
VPN solutions are prevalent in the DMZ. Other than the site-to-site VPNs we
already learned about, you also have VPN solutions in which you will have a
remote access solution so that clients can attach over the Internet to get to their
ﬁles and other data needed on the corporate network.This also has to be publicly
accessible via the DMZ.
Building a Windows DMZ
■
Depending on the model and type of ﬁrewall you use, you can in fact have
different DMZ segments with different services on each to add even more security
to your DMZ segments and hosts.This might be necessary if you plan to segment
your DMZ hosts even further.This would mean that you could place an IIS load-
balanced cluster on one DMZ and an e-mail relay on another.
www.syngress.com
Windows DMZ Design • Chapter 2
87

■
Your Windows solution revolving around the DMZ needs to allow for Internet
access.The Internet connection should be able to handle the bandwidth needs of
the site. If you are using this Internet connection as your LAN’s Internet access for
surﬁng and e-mail and you decide to use it for a VPN as well, you need to analyze
your requirements ﬁrst.
■
A trafﬁc ﬂow analysis can be done to ascertain the needed requirements (for WAN
links, Internet connections, and so on) quite quickly, but you need to know how
to do the analysis and have the tools to do so. If you do not, it is in your best
interests to work with an outside vendor that does have the tools and experience
to do so. Not doing so will almost always result in bad performance and increased
cost later when you need to reprovision the lines to a higher bandwidth.
■
Sometimes (if the size and complexity of the network dictate) you’ll need a router
on each leg of the ﬁrewall.At times, you will get requests to either add security to
the segment you are working on or add more and more devices to it, where you
might need to either route or direct trafﬁc.You might decide to keep these
services dependent on the device in which they sit. Keep your devices dedicated
to what they do best when you can afford to do so and can use the added security.
■
Too often, administrators mistake where to put DNS and WINS servers when
working with the DMZ. Be sure to control where your public and private
resources are published so that you are not exposing details of private hosts to the
public over the Internet.
■
Know how to place an e-mail server on the DMZ.You could place it in the
private network.The ﬁrewall in front of the e-mail server would be responsible for
taking all requests in and out of the network and responsible for securing the
trafﬁc to the e-mail server. Due to the design of the server, it made the relaying of
outbound Internet-based e-mail the responsibility of the e-mail server—only one
single server.The question is then, however,“Why would we want to expose our
e-mail server to the public Internet? What if there was a way to attack the e-mail
server directly through the ﬁrewall?”
■
It is common to simply add another e-mail server to the DMZ segment and use
this as a relay to and from the protected e-mail server in the private network.The
server now becomes an e-mail relay, and it will relay the mail to and from the
Internet and to and from the mail server. If mail relays (IIS has an SMTP service
that can be used as a relay) are compromised, you can reinstall the server from
scratch and not lose a thing because all the server did was relay trafﬁc. (Keep in
mind that this approach could still incur downtime for your organization, so it is
still advisable to create a high-availability scheme that will minimize this risk.) 
■
Web servers are the most common form of DMZ-based hosts today. Other
services, such as DNS and e-mail, are needed, but if you really think about it, the
www.syngress.com
88
Chapter 2 • Windows DMZ Design

main reason DMZs even exist is because of the public Internet Web surfer feeding
frenzy.Almost every company in the world now has a publicly accessible Web site,
which means that just about every company worldwide either has an Internet
presence or is looking to have one. Because of all these personal invitations to their
corporate networks, it is imperative that you also think out your security
completely or your network could be exploited.
■
Organizations frequently have data they want to publish to the external network
via a Web server.To allow direct access to the Web server via the Internet while
the server is sitting in your private and protected LAN would be suicide. For that
reason, we allow an external Web server to be placed on the DMZ.This way, you
can allow all your visitors to come directly to your IIS server and not have them
exploit that server only to ﬁnd ways to get to other systems. If the IIS server is
external on the DMZ, you can at least have some defense against it if it is
compromised in any way.
■
The last (and very common) services to see on the DMZ both internally and
externally are the DNS servers for your organization. DNS services are now more
than ever the most common service used for name resolution. Because of DNS’s
growing use, it is important that when you lay out your Windows 2000/Windows
2003 network, you are able to design the Internet namespace and the external
namespace for the organization.
■
Once you have ﬁnalized the DMZ network segment design and placed your
systems where they need to be (and understand why they need to be there), you
have to consider trafﬁc and applications ﬂows,ACLs, and ﬁltering.
Windows DMZ Design Planning List
■
To successfully start your Windows DMZ implementation, you need to start with
our initial discussion on planning: network engineering, systems engineering, and
security analysis.
■
To properly plan your Windows DMZ, follow the steps in our checklist to get
yourself from start to ﬁnish.You can use the list incorporated in the end of this
chapter to do the planning you need.
www.syngress.com
Windows DMZ Design • Chapter 2
89

Q: I would like to protect my Windows DMZ. What do hackers use to test, check, and
penetrate my DMZ? 
A: Tools that allow people to eavesdrop on trafﬁc are freely available on the Internet and
can cause you much pain when you’re trying to build a Windows DMZ. Regardless of
the types of trafﬁc traversing your network, a network sniffer is all someone needs to
learn, map, and disable your network.You need to think about the problems you could
encounter while building your DMZ when you do let various types of trafﬁc traverse
your network and over the Internet.
Q: I need to look at allowing speciﬁc trafﬁc through my ﬁrewall, and I am unsure who
handles such assignments. Where should I look for this information? 
A: The Internet Assigned Numbers Authority (IANA) is responsible for managing port
numbers.The well-known port numbers range from 0 to 1023.The registered port
numbers range from 1024 to 49151.The dynamic and private ports range from 49152 to
65535. Most systems use the well-known port numbers to run system processes or privi-
leged programs. Most of the time they are used with nonsystem processes or nonprivi-
leged programs, such as an ordinary user running a program. Visit www.iana.org for
more information.
Q: What is the most common form of DMZ-based system in use today, and what is com-
monly seen on DMZs big or small?
A: Web servers are the most common form of DMZ-based hosts today. Other services are
needed, such as DNS and e-mail, but if you really think about it, the main reason DMZs
even exist is because of the public Internet Web surfer feeding frenzy. Because of all
these personal invitations to companies’ corporate networks, it is imperative that you also
think out security completely or your network could be exploited.
Q: I am planning out a new DMZ infrastructure. I am unsure about the hardware I need or
what vendor to select. What should I do to start my plan? 
A: When planning your infrastructure, you always need to ensure that you plan for the proper
equipment, no matter what vendor you pick. If you are purchasing that much equipment,
www.syngress.com
90
Chapter 2 • Windows DMZ Design
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 
PV27

presales support could be in order.Ask your vendor to show you user limits per device
(how many users can simultaneously use this device without affecting its performance) as
well as the type of trafﬁc you will be pumping through it. Many times, the vendor can
help you to design your network so that you don’t fall short on what you need or do not
go into overkill where you may not need the extra power.
Q: I want to implement a DMZ, but I am hearing from management that there might be a
future need for an e-commerce site. How does this affect my design now? Should I plan
for this functionality, even though I do not know exactly when it might happen? 
A: If there is a need to eventually set up a load-balanced solution with multiple IIS servers
and a possible back-end database cluster, you should plan for it in the design stages of
the initial DMZ setup so that you don’t have to repurchase new gear for it later.You
should also see if this can be amended into the project plan by the stakeholders and the
project manager so that, if possible, the need can be ﬁnalized and you can scale your
equipment for it before, not after, the fact.Always get a needs analysis and a future needs
analysis done early in the design phase of the project so that you know what you might
want to incorporate in the design (such as load balancing). If e-commerce is the need,
you need to scale the ﬁrewall, switches, and all other infrastructure to meet the needs for
a possible e-commerce site, a load-balanced cluster, and so on.
Q: Why would I need a site-to-site VPN, and how does it affect my Windows DMZ design?
A: If there is a need to add more bandwidth and site-to-site VPN services off the external
Internet routers, you should at least be familiar with the design and why you are imple-
menting it. For one, the VPN used in this manner replaces your current Frame Relay or
other WAN technologies, or if this is a new installation, you can forego using these
technologies in the ﬁrst place.All the VPN does is encrypt your data over a public or
private medium so that you can have the private-line feeling without the private-line
price premium.These are popping up left and right as companies try to save money, so
it is important that you know how to design them into your DMZ.You should also
ensure that you purchase models either with crypto cards (to use IPSec for VPNs)
installed or upgradeable to them.
Q: When I plan my Internet connection, I am unsure as to what type of switch I need
behind the external router, or if I even need a switch at all. Can’t I just use a crossover
cable to go from the router port to the ﬁrewall port? 
A: If you need to scale up the number of connections to the Internet, such as the need for
VPN services, intrusion detection systems, honey pots, other routers and so on, or you
have other services that will be added sooner rather than later, you might need to put a
switch in between the ﬁrewall and the external router.You might need more port avail-
ability on the switch so if you can get a switch, you have set yourself up to scale out in
the future if needed. If this need is not there, you can skip this implementation and
simply use a patch or crossover cable to connect your systems instead.
www.syngress.com
Windows DMZ Design • Chapter 2
91


Sun Solaris 
DMZ Design 
Solutions in this chapter:
■
New Features of Sun Solaris 10
■
Placement of Servers
■
The Firewall Ruleset
■
System Design
■
High Availability
■
Implementation: The Quick and Dirty
Details
■
Hardening Checklist for DMZ Servers and
Solaris
Chapter 3
93
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
Solaris is a commercial UNIX operating system distributed by Sun Microsystems.The com-
bination of Sun hardware and software makes systems that use Solaris some of the best-per-
forming servers in the world. However, Solaris can be used as more than just an ancillary of
services, such as database, Web, and mail. With roots in the Berkeley Software Distribution
(BSD) UNIX world, Solaris is well equipped to perform as a DMZ server.
In this chapter, we discuss the use of Sun hardware and Solaris as a DMZ system. We
begin with the new features of Sun Solaris 10, followed by a discussion of the placement of
servers in conﬁgurations to make the most of resources. We also discuss the use of ﬁrewall
rules and how they can be implemented to provide security to the private and public net-
work segments of a DMZ implementation.
After discussing the use of Solaris as a DMZ system, we focus on the Solaris system itself.
The object of this discussion is examining the factors in creating a secure system to act as the
DMZ server. Of the design, implementation, and maintenance phases common to every
server, we focus on the design and implementation phases. In the discussion of these phases,
we outline speciﬁc methods that can be applied to systems to create a secure design as well as
to maintain the system’s integrity during the implementation. Let’s begin with a discussion of
the new features of Sun Solaris 10 followed by the placement of Solaris DMZ servers.
New Features of Sun Solaris 10
Sun hardware platform supports Windows, Linux,Trusted Solaris, and the standard Solaris.
Sun has introduced new features to increase security, scalability, stability, and performance in
Solaris 10. Features such as predictive self-healing, ZFS ﬁle system, cluster volume manager,
Grand Uniﬁed Boot Loader (GRUB) on the x86 platform, OSPFv2 and BGP-4 routing
protocol support, IP Filter IPv6 support, SSL acceleration, IP Filter Firewall, Web console,
and zones deserve mention here.
Let’s look at some of the features that are helpful in deploying Sun Solaris as a DMZ
platform in your organization.
■
Zones Later in this book you will read about Juniper Networks’ virtualization
concepts. Zones are nothing but virtualized OS services, or simply put, multiple
instances of Solaris OS running on a single hardware platform. Sun calls them as
containers. This approach helps administrators decide on the amount of resources to
be allocated to applications and services without interfering with each other. For
security or manageability purposes, if you had considered running services such as
Web and mail in different server hardware, now you don’t need to do that. Run
multiple services on a single hardware platform, isolating them with zones. Failure
or nonperformance of one of the virtual operating systems doesn’t impact the per-
formance of another application running in a completely different OS instance.
Resources such as memory and CPU are shared among the virtual operating
www.syngress.com
94
Chapter 3 • Sun Solariz DMZ Design

system instances, however, appearing to the individual virtual OS as though the
resources are dedicated to itself.
■
ZFS Zettabyte File System, or ZFS, introduced in Sun Solaris 10, uses a concept
of pooled storage, bringing performance enhancement and integration of ﬁle systems
with volume management.
■
Reduced Networking Software Group Solaris 10 allows you to build a secure
server with only those services that are absolutely necessary for you to run a desig-
nated application.You get the control of what is installed and what is not from the
installation stage itself, facilitated by a text-based console and various administra-
tion utilities.You may add and remove software packages and enable or disable ser-
vices and network interfaces as needed.This ensures that you don’t enable some
services inadvertently, which could cause a security loophole later in the network.
For a complete list of new features, refer to www.sun.com/software/solaris/
whats_new.jsp.
Placement of Servers
We can draw a parallel between the placement of a Solaris system that will provide DMZ
services and the purchase of real estate with the mantra “location, location, location.” Just as
you do not want to purchase real estate that was previously a dump site, you don’t want to
put the DMZ server in a location on the network that is a metaphoric trash heap, cluttered
with the equivalent of network garbage. Placing the system that will function as the DMZ
server at a position in the network that is both efﬁcient and secure is of the utmost impor-
tance.
Placing the system on the DMZ usually depends on network requirements. Some net-
work conﬁgurations, such as smaller networks, may place the DMZ server directly behind
the router, as demonstrated in Figure 3.1.
Figure 3.1 Basic Implementation of a Solaris DMZ Server in a Small Network
Sun Solariz DMZ Design • Chapter 3
95
Public Network Switch
Private Network Switch
Solaris DMZ Server
Border Router
www.syngress.com

Although this is not the most ideal conﬁguration because it does not permit easy scaling
of network resources or easy integration of high availability, this design should be sufﬁcient
for smaller networks. We can see from the diagram that network trafﬁc ﬁrst enters via the
network router and next goes directly to the DMZ server.
From there, the trafﬁc proceeds to its next hop in the network infrastructure, which in
this case is a switch on the public or on the private network.The router has a valid routable
address on both interfaces.The DMZ server has a valid address on two interfaces, and on
one interface it has a private network address.Trafﬁc coming from and going to the private
interface is translated using Network Address Translation (NAT).
In this type of conﬁguration, the DMZ server is capable of handling a couple of net-
works. However, when trafﬁc grows to the point that the DMZ server can no longer handle
the load, the network needs to be redesigned to scale outward, to handle the additional
trafﬁc.
In addition, this conﬁguration makes it difﬁcult to monitor the network outside the
DMZ server with network intrusion detection (IDS) tools. However, for small ofﬁces or
businesses, this conﬁguration is a workable solution.
In Figure 3.2, we see a conﬁguration that is a little more advanced and scalable. When
trafﬁc enters the network, it crosses the border router. It then immediately goes to a switch,
where it is passed to the DMZ server. From the DMZ server, it proceeds to the switch on
the public network or the switch on the private network.
Figure 3.2 Advanced Implementation of a Solaris DMZ Server With External
Switches and NIDS
We should discuss a few noteworthy things in this conﬁguration. First, we have a switch
immediately behind the router.This is an important feature in the design because as the net-
www.syngress.com
96
Chapter 3 • Sun Solariz DMZ Design
Border Router
Public Switch
Private Switch
Solaris DMZ Server
Untrusted
Network Switch
Network IDS

work grows, we may potentially add address space. In doing so, we could decide to add this
network space to a different DMZ altogether due to business requirements. Placing a switch
immediately behind the router gives us the ability to expand or contract the network as nec-
essary. If a switch is not used, we could connect, via a patch or crossover cable, the border
router directly to the Solaris system.
Also worth noting in this conﬁguration is the IDS monitoring the network outside the
DMZ. Note that it is connected only to the network outside the DMZ and has no other
access.The host is connected to the outside network to provide monitoring of attempted
attacks. Information gathered from this sensor could be crucial in identifying attacked and/or
compromised hosts or, in most cases, a passive scan on the DMZ. Furthermore, this system
has no other network access because it is in an unprotected location and could potentially be
the victim of an attack itself.This situation can be mitigated through access controls on the
border router and DMZ systems, though the possibility will always exist due to the location
of the system.
However, IDS is outdated because it does not prevent an intrusion from happening.
Therefore, security administrators consider deploying an intrusion prevention system (IPS) to
detect and block intrusions. Sophisticated appliances are available in IPS to perform an appli-
cation layer level of scanning and detecting intrusions. Often these systems are used to block
denial of service (DoS) or distributed denial of service (DDoS), worms,Trojans, and back-
door attacks. IPS is also used to block application layer trafﬁc, such as chat programs and
peer-to-peer (P2P) applications, to enhance security in a corporate network. If you are plan-
ning to deploy IPS, you should consider modifying the network design because IPS is nor-
mally placed behind the ﬁrewall.This enables IPS to focus only on the trafﬁc that is already
permitted by the ﬁrewall and therefore concentrate only on the contents of a packet, to
detect malicious trafﬁc. Organizations that want to know where the attack is happening
(much before the ﬁrewall drops the trafﬁc) can still place the IPS between the router and the
ﬁrewall. However, you need to consider the performance impact before doing so.
We must also consider the need for high availability.The conﬁguration shown in Figure
3.3 differs slightly from the one shown in Figure 3.2 and illustrates a highly available 
conﬁguration.
This ﬁgure contains many features similar to those in Figure 3.2. However, what is dif-
ferent is that rather than one DMZ system connected to the external network switch, three
DMZs are connected to the external network switch.Additionally, there are several connec-
tions from these DMZ systems to the same public and private networks. We also see a con-
nection between the DMZ systems.You may also consider implementing ﬁrewall and server
load-balancing appliances such as BIG IP from F5, Cisco Content Service Switches (CSS),
or Nortel Networks Alteon load balancers.These dedicated load-balancing appliances can
ofﬂoad the load balancing and high-availability loads from the servers.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
97

Figure 3.3 Solaris DMZ Servers in a Conceptual Highly Available
Conﬁguration
This conﬁguration shows a DMZ server cluster.All systems in the cluster maintain an
active connection to other systems in the cluster via the switch.The only system in the
cluster that maintains active connections outside the failover information switch is the active
DMZ system. When the primary DMZ system fails, it deactivates (or is deactivated) via
information over the failover communication network, and the next system in the cluster
brings up its network interfaces to perform the job of the primary DMZ server.
These general network component conﬁgurations enhance network security. However,
this is only part of the design. Equally important is the ﬁrewall ruleset, which we discuss in
the next section.
The Firewall Ruleset
The ﬁrewall ruleset dictates the exact types of network activity permitted by the DMZ
server.As the implementers of a DMZ system, we are responsible for the ﬁrst line of security
of both the public and private networks.This important task cannot be taken lightly.
In this section, we focus more on the ﬁrewall rulesets as they relate to the various
requirements of the DMZ host. In each segment of the network handled by the DMZ
server, we have a different set of requirements and expectations. We start with the private
network rules, discussing the ideal private network ﬁrewall policy.
Following our discussion of the private network segment, we focus on the public net-
work requirements and ﬁrewall ruleset. Some of the inherent risks of public network access
www.syngress.com
98
Chapter 3 • Sun Solariz DMZ Design
Border Router
Switch
Switch
Server
Server
Server
Switch
Switch

are also outlined. We end our discussion of ﬁrewall rulesets with a brief examination of
requirements for local host security.
The Private Network Rules
Because the security of both the public and private networks depends on a secure DMZ
server, the ﬁrewall ruleset must be well conceived and sufﬁciently secure.Although the ﬁre-
wall ruleset must be secure enough to prevent attack and compromise, it is equally important
that the network at least be usable. Our quest to create a secure network should not necessi-
tate jackboots as work footwear and an iron ﬁst as a policy enforcement tool.
Therefore, we must evaluate the services a user needs to meet business requirements, and
we must balance our ﬁrewall policy against restricting the services a user does not need. It is
often easier to inventory the services users need than the services they don’t need.Although
business networks are typically inﬁnitely complex, let’s keep it simple and say that our users
need only Web, mail, and domain name service (DNS) access. Such a planning of permissible
trafﬁc is commonly referred to as whitelisting. It is always easy to downsize what you want
rather than list everything you do not want (blacklisting). Commonly used ﬁrewall rules
include a stealth rule that prevents any direct connection to the ﬁrewall (any to fw, drop,
meaning trafﬁc from any source with ﬁrewall as destination will be dropped).This rule is
placed on the top of the ruleset.The cleanup rule drops all the trafﬁc that any other rule does
not permit.This rule is normally placed last in the sequence of rules. Most of the ﬁrewalls
implement this rule as an implicit rule, which means that the rule exists, regardless of whether
you create it or not.
Conﬁguring & Implementing…
DMZs and Internet Chat Clients
Internet chat clients have become a popular means of communication, and busi-
ness is no exception to the trend. Often it is more productive and easier for
coworkers to open an instant message (IM) to communicate rather than to per-
form a context switch by turning away from the computer and picking up the
phone or physically leaving the workspace to consult with a colleague.
However, Internet chat clients are the bane of DMZ security. Many such
clients piggyback communication on top of other protocols to circumvent ﬁl-
tering or even to scan the ﬁrewall to determine how to reach the outside. Due to
problems inherent with these clients, it is possible for a remote user to exploit an
issue that would result in a client-side attack. The attacker could gain access to
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
99
Continued

the user’s system with the privileges of the user and thus initiate a connection to
the outside world that allows the attacker access.
It is difﬁcult to prevent the use of these clients at the DMZ level, and it
might be better to approach this issue with a security policy.
In Figure 3.4, we show a network design with a router at the top of the network. From
the router, we go to a switch, then to the DMZ server.The DMZ server connects to
switches on both the public and private networks. On the private network, we see a mail
server. On the public network, we see a mail server, a DNS server, and a Web proxy server.
Figure 3.4 A Solaris DMZ Server With Hosts on the Public and Private
Networks
Even though users do not need access to the mail server outside the private network,
the mail server on the private network needs the ability to access mail outside the network.
The most secure way to do this is to allow the internal mail server to contact the mail server
in the DMZ for mail rather than allowing the mail server in the DMZ to indiscriminately
send trafﬁc through the ﬁrewall on port 25 to the internal mail server.This can be done
using a tool such as rsync over SSH.Alternately, you may use the Fetchmail service over SSL
to deliver mails to the Sendmail mail service in the internal network. We want the internal
mail server to perform this task as a stateful action to prevent the piggybacking of trafﬁc on
the connection.
In terms of Web access, giving users unfettered access to the Web is, at the least, risky.
Wise network design involves using a proxy server to ﬁlter potentially malicious Web con-
tent. However, we do not want to keep this proxy server at a location where it could pose a
www.syngress.com
100
Chapter 3 • Sun Solariz DMZ Design
Name Server
Web Proxy
Mail Server
Mail Server
Private Network
Public Network
Border Router
Solaris DMZ Server

risk to the security of the private network.Therefore, we assume that the proxy server is in
the DMZ.
To maintain the security of the private network, we want to place a ﬁrewall rule entry
for the proxy server.This rule maintains the state of outgoing user connections to the proxy
server, like that of the mail server, except this rule goes to the proxy server. Once these two
rules are conﬁgured, we fall to our last rule in the ruleset, which expressly denies any other
incoming or outgoing trafﬁc.
Finally, we must take into consideration the domain name service. We use the domain
name server on the public network to provide this service to users.The ﬁrewall ruleset for
the private network permits querying of the name server from the private network. We see
an example of this conﬁguration in Figure 3.5.
Figure 3.5 An Example of Rules Implemented on the Solaris DMZ Server for
Private Network Trafﬁc
Now that we have a secure conﬁguration for our private network, let’s examine our
public network conﬁguration.
The Public Network Rules
The requirements for the public network often differ signiﬁcantly from those for the private
network.The public network usually provides a number of services available to the public
Internet and some for private network users as well.The biggest consideration here is that
the public network also requires accessibility by external users, which increases the exposure
to potential attacks.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
101
Name Server
WorkStation
Private Network
Public Network
Border Router
Untrusted Switch
Solaris DMZ Server
Private Network Rules
1. Allow UDP to port 53 on
Name Server and keep
state
2. Allow TCP to port 8080
on Proxy Server and keep
state
3. Deny all inbound and
outbound traffic

Public networks are conceptually much like private networks.They require giving users
the ability to access services and should limit users’ ability to deviate outside of accessing the
allowed service set. In the previous section, the services we discussed were mail, Web, and
name service. Let’s assume that these services are also required on the public network.
In terms of Web service, we have already established that users of the private network
will use a proxy server to access outside content.The proxy server needs access outside the
public network, so we create a rule that maintains state, allowing access from the proxy
server to networks outside the public network.The rule enforces the policy that the proxy
server process may connect to any system on any port and must maintain state. No outside
server is permitted to connect directly to the proxy server or the proxy server process.
The mail server on the public network requires different conﬁguration. SMTP is a two-
way protocol that requires the ability of the mail server to connect to outside mail servers as
well as receive connections from outside mail servers. In the previously described private
network conﬁguration, the mail server on the private network will likely forward the mail to
the public mail server. From the public mail server, the mail will then be sent to the appro-
priate receiving server.The public ruleset should be conﬁgured to allow both incoming and
outgoing connections that maintain state to the mail server process on the public mail server.
Finally, we must conﬁgure the public ﬁrewall ruleset for the domain name server. In the
previous section, we stated that the name server would accept resolution requests from hosts
on the private network. For the public network, we must alter this capability a bit. On the
public network, the name server should only accept replies from other name servers.This
name server should not be authoritative for the domain and should not otherwise accept res-
olution requests from users outside the public or private networks. Domain name service is
inherently insecure.Although the only means to ﬁx domain name service is a complete revi-
sion of the protocol itself, this conﬁguration will at least insulate the service against many
attacks.The public ﬁrewall rule should permit outbound requests from the domain name
service process to any host on port 53 and should permit only responses to requests, if pos-
sible. In Figure 3.6, we see a manifest of ﬁrewall rules applied to the public network.
NOTE
The site www.cve.mitre.org/cve/ maintains the list of common vulnerabilities
and exposures (CVE). Do a search on DNS to learn about the security threats
and exploits available on DNS. 
You can secure DNS by implementing DNS Security Extensions (DNSSEC).
This adds security to the domain name system. DNS security threats such as
cache poisoning can be avoided by using DNSSEC. For more information, visit
www.dnssec.net. 
Hardening tips, tricks, and techniques for bastion hosts located on the
public network-based DMZ can be found throughout this book. 
www.syngress.com
102
Chapter 3 • Sun Solariz DMZ Design

Figure 3.6 An Example of Rules Implemented on the DMZ Server for the
Public Network
Now that we have discussed the use of the Solaris DMZ server, let’s focus on the server’s
design and implementation details.
Server Rules
We have addressed the rules for both the public and private networks, but we have not dis-
cussed the rules for the host itself. Essentially, the DMZ host is the linchpin of the network,
and accordingly, it must be resilient to remote attacks.The ideal implementation keeps the
host unreachable, if not basically invisible, from all systems except the system from which
remote administration may be performed.
As such, the ﬁrewall ruleset implementation is pretty easy to conceptualize. Generally,
the best policy is to deny all trafﬁc to the host from all systems. Rules to permit trafﬁc to the
host for administration should be carefully implemented; we want to permit the administra-
tion host access to the administrative service on the DMZ server, but we do not want to
give the host total access, in the event that it is compromised.
In that same vein, it might be helpful to give hosts from which administrative access will
be performed a static IP address on the private network. It is generally not the best idea to
use DHCP to assign addresses to these hosts, since this could potentially allow another host
to acquire the address through either legitimate or illegitimate means. Furthermore, it makes
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
103
Name Server
Web Proxy
Mail Server
Mail Server
Private Network
Public Network
Border Router
Solaris DMZ Server
Public Network Rules
1. Allow UDP from port 53 on Name Server
to any outside server and keep state
2. Allow TCP from Proxy Server to TCP
port 80 on any host and keep state
3. Allow TCP to 8080 on Proxy Server from
private network interface of DMZ
server and keep state.
4. Allow inbound traffic from any external
system to TCP port 25 on mail server and 
keep state
5. Allow outbound TCP to any system TCP port
25 from mail server and keep state.
6. Deny all inbound and outbound traffic
Desktop

it possible in the ﬁrewall ruleset to speciﬁcally allocate access to the administrative interface
of the DMZ server from the private IP address of the administration station.This concept is
shown in Figure 3.7.
Figure 3.7 An Example of Rules Implemented on the Solaris DMZ Server to
Protect the DMZ Server
System Design
In the previous sections, we focused on the role of the DMZ server within the network. We
discussed DMZ design, ﬁrewall rulesets for private networks, and ﬁrewall rulesets for public
networks.These topics apply to the use of the DMZ server in the network environment; let’s
now focus our attention more closely on the design details of the server.
The process of deploying any type of server can be broken into three distinct phases:
1.
The planning phase
2.
The implementation phase
3.
The maintenance phase
Let’s look at a brief description of each of these phases.The planning phase typically
involves designing the system. Details such as operating system selection, hardware selection,
third-party software selection, operating system software installation details, and the like are
decided during this phase.The planning phase is followed by the implementation phase, which
entails assembling the hardware, securely installing the software according to speciﬁcations
www.syngress.com
104
Chapter 3 • Sun Solariz DMZ Design
Administration Station
Private Network
Border Router
Untrusted Switch
Solaris DMZ Server
Host Rules
1. Prohibit all network
connectivity to
192.168.1.1 from any
host.
2. Prohibit all connectivity
from any host to the
external network interface.
3. Prohibit all connectivity
from any host to the DMZ
network interface.
2. Allow TCP to port 22 on
DMZ Server from
192.168.1.254 and keep
state.
192.168.1.254
192.168.1.1

decided in the planning phase, conﬁguring the host to meet design requirements, and testing
the host to ensure stability and reliability.After the implementation phase has been com-
pleted, the system is placed into production, thus beginning the maintenance phase. During the
maintenance phase, the system is continually monitored for signs of intrusion and perfor-
mance issues.Additionally, the system is regularly patched with all critical and security-spe-
ciﬁc patches made available by the vendors of the software installed on the DMZ system
over the course of its production life.
Our focus in this section is on the planning phase. We discuss two of the more popular
ﬁrewall software packages available for Solaris. Selection of a ﬁrewall software package is
important during the planning phase. However, we also want to ﬁll in many of the other
blanks, such as the hardware on which the DMZ server will operate, the operating system
revision that will be used for the implementation, and similar details.
When a building is constructed, blueprints specify the minute details, from measure-
ments and plumbing to storage closets.The foundation must ﬁrst be designed before the
structural design can begin. Once the foundation is designed, ﬂoor upon ﬂoor of the
building climbs into the sky until the structure design is completed.Then the details such as
plumbing, drywall, and paint are applied to the building. Designing a DMZ server, or any
server for that matter, is not much different in concept. We start by designing the founda-
tion—selecting hardware. We then select software, which can be likened to designing the
structure.Then we complete the details such as service offerings, security features, and con-
ﬁguration details—the proverbial plumbing, drywall, and paint.
NOTE
Sun BluePrints offer industry-standard security and best practices. Topics cov-
ered include ﬁle system integrity, authentication, encryption, architecture of var-
ious security modules of Solaris and security tools such as auditing, ﬁngerprint
database, and Solaris Security Toolkit (SST). Sun BluePrints can be found at
www.sun.com/software/security/blueprints/.
Hardware Selection: The Foundation
It goes without saying that the hardware is the base of the entire system.The proper selec-
tion of hardware, to use another analogy, can be likened to buying a car. Sure, one can buy a
Ferrari if it is affordable. But the problem is, if we bought a Ferrari, once we marry and have
kids, we would be stuck with a two-seat car and have to buy another car to ﬁt our family
and lifestyle.Arguably, if you can afford a Ferrari, you are likely to be able to afford a decent
family car as well. However, if you are like everybody else working in technology these days,
thoughts are not of a nice, new, shiny Volvo but instead a 1974 Pinto station wagon with
minimal rust—paint optional.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
105

Hardware selection is a process of picking a system with enough room to handle the
current load yet scalable enough to add capacity for growth.This is a particularly important
factor to consider in selecting hardware for a DMZ server.The two reasons are growth of
network trafﬁc and expansion of administered networks.
Growth of network trafﬁc happens, plain and simple.A company could have an increase
in network trafﬁc thanks to increased popularity in the company Web site due to expanded
offerings or other reasons, constituting an increased load through the public network seg-
ment. In addition, more staff could be hired, all requiring access to the Internet, which could
constitute an increase in private network trafﬁc and thus more load on the DMZ server.
A system that handles network trafﬁc needs an abundance of two speciﬁc resources: pro-
cessing power and memory (RAM). It is in RAM that the trafﬁc is momentarily stored,
evaluated against the conﬁgured ﬁrewall ruleset, processed, and either rejected or sent on its
merry way to the destination.
Because of the resource needs as well as the likely possibility of growth, you should con-
sider hardware that is capable of being expanded. Minimally, select hardware that is capable
of adding RAM as well as faster processors.
An older example of such as system is the Sun E420R.This rack-mountable system is
designed to handle two disks internally, which is sufﬁcient for our purposes. On the main
board, the system is capable of handling 4GB of RAM and four Ultra-Sparc II processors.A
newer example of a system capable of handling our needs is the rack-mountable Sun V480
Server.This system, like the E420R, has the ability to handle two disks internally. It is capable
of handling up to four Ultra-Sparc III processors and up to 32GB of RAM. Sun’s newer
server range, based on AMD Opteron with four AMD processors and high-performance x64
computing, also offers the ability to handle large amounts of memory.The Sun x4600 series
with four or eight single- or dual-core AMD processors offers to support 128GB of RAM
when the 4GB memory chips are released. For more options before you decide on your Sun
hardware platform, visit www.sun.com/servers/ and view by processor family.
Another factor to consider is the ability to add network interfaces. Select a system with
space on the bus that’s sufﬁcient to add network interfaces. With Sun systems, two types of
interface are available. We discuss these interfaces in more detail in the network hardware
considerations section that follows.
From this discussion, we can draw a few conclusions about hardware selection.The ﬁrst
and more obvious is that we should select hardware capable of handling the load. Second, we
should select hardware that is capable of being scaled to ﬁt our current needs as well as our
future needs.The difference between selecting hardware that cannot be expanded and hardware
that can be expanded equates to purchasing and building a new DMZ server once a year.
Let’s focus in a little more detail on the common DMZ hardware requirements as well
as network hardware considerations.
www.syngress.com
106
Chapter 3 • Sun Solariz DMZ Design

Common DMZ Hardware Requirements
Solaris is predominantly used on Sun or Sun-clone hardware. In some instances, it is also
possible to use Intel-based Solaris to create a DMZ server and provide service to a network.
However, due to variances in Intel-based hardware and the idiosyncrasies involved in making
a working conﬁguration on this platform, we omit Intel Solaris from our discussion. Instead,
we focus this discussion entirely on Sun and Sun-clone hardware.
For the purpose of this discussion, Sun hardware is essentially the same across the board,
whether you’re using a 10BaseT (le) interface on a SparcStation20, a fast-Ethernet Interface
on an Ultra80, or Gigabit interface on an Enterprise system.
To create the standard three-legged DMZ system conﬁguration, we require at least three
network interfaces.These interfaces can be provided in one of two ways. We can use three
separate interfaces, such as single Ethernet cards, each using a separate opening on the bus.
This would provide us three separate cards, leaving the single point of failure on the system
bus rather than in one network component.
Another conﬁguration could be the use of a tool speciﬁcally designed for the job.This
tool comes in the form of a Sun quad interface card.These are single cards containing, as
their name implies, four network interfaces in one card.This gives us the beneﬁt of consoli-
dating all our network components into one slot on the system bus, leaving room for other
components such as ﬁber channel cards or the like.
Of the card types available, the Ethernet cards, used in a set of three, would comprise the
le0, le1, and le2 interfaces on the system.The corresponding quad Ethernet card would give
us interfaces qe0 through qe3.The Fast Ethernet cards would give us hme0 through hme2,
with the quad Fast Ethernet card giving us interfaces qfe0 through qfe3.
Network Hardware Considerations
We must take a couple issues into consideration when we’re planning to use a Solaris system
as the DMZ server.The ﬁrst of these issues is the speed of the cards the system will use to
service the network.The second issue is the hardware on the network to which the DMZ
server will provide service.
We must pay particularly close attention to the ﬁrst issue when we’re using separate
Ethernet interfaces. In this type of conﬁguration, the primary interface on the host will most
likely be used as one leg in the DMZ conﬁguration.Therefore, the additional two cards you
purchase should have similar characteristics.
For example, most Sun SparcStation20 systems were distributed with a stock 10BaseT
Ethernet interface.Therefore, wisdom would lead us to purchase additional 10BaseT
Ethernet interfaces.This train of thought applies to other systems, such as the Ultra80,
which, by default, includes a 10/100 fast Ethernet interface, and so forth.
In light of the ﬁrst issue, we must also consider the second issue, which are the require-
ments of our network neighbors. Where possible, we want to use hardware that is at least of
the same speed of the systems with which the DMZ server will be communicating.Typically,
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
107

we want to place a DMZ server in a location between switches or between a router and a
switch. In standard conﬁgurations, switches and routers have, at a minimum, Fast Ethernet
interfaces.
Although it is possible to get by using interfaces of slower speeds than our neighbors,
doing so creates a senseless bottleneck in the network. Minimal requirements should be
using interfaces of the same speed as our network neighbors.A rule of thumb is to use inter-
faces that are at least as fast and capable of higher speeds than our network neighbors for
future growth in network trafﬁc and changes in network conﬁguration.
Drawing on the previous section about DMZ hardware requirements, we must again
consider the type of cards we will use to get the job done. Current ability to perform and
future scalability are as important in this scenario as our budget. Getting the job done with
separate Ethernet cards could be the cheaper solution, but when the network grows in the
future, we will be forced to either replace the system with one that will provide additional
slots on the bus for single Ethernet cards or, more realistically, convert the single Ethernet
cards to quad Ethernet cards. Consider making this type of hardware a standard selection,
because it provides multiple interfaces of the same speed and offers immediate scalability in a
standard three-leg DMZ conﬁguration, since one interface on the quad card is free, as well as
the primary interface on the host.
Software Selection: The Structure
In the planning phase, the next most critical decisions concerning a DMZ server are the
selections of various software packages.These software packages include the operating system
that will run on the host as well as the ﬁrewall software package and any other third-party
software packages that might be required. In using Sun hardware, it is a given that Solaris is
the operating system of choice; it provides the best performance on the hardware, has the
best symmetric multiprocessing code of operating systems, and provides the best support for
Sun hardware.
Solaris is versatile enough to function well as a networking operating system, having its
roots in the Berkeley implementations of Unix. Like the Berkeley Operating Systems,
Solaris, with the appropriate hardware, is capable of acting as a router in its default imple-
mentation. Unlike the BSD Operating Systems, Solaris requires additional software to pro-
vide advanced features such as packet ﬁltering and stateful inspection.
One common theme across all networks is that no a single common software package is
used to implement DMZ and ﬁrewall services.The fact of the matter is that although most
available software packages offer a plethora of common features, the decision to use one par-
ticular type or brand of software often boils down to two factors: in-house expertise and
money.The questions,“Do we have the expertise to use this software?” and “Can we afford
this software?” are the two inﬂuences on which selection is ultimately made.
This is not to say that there are not a number of other factors that come into play. One
such factor is support. For example, some software might not offer the most cutting-edge
features. However, when the price and accessibility of support are factored in, the return on
www.syngress.com
108
Chapter 3 • Sun Solariz DMZ Design

investment signiﬁcantly increases.Along that same vein, having an in-house expert who is
capable of modifying the source code of a free software package to fulﬁll business require-
ments and resolve issues with the minimum amount of downtime can far outweigh the ini-
tial investment in software and support as well as the turnaround time typically required with
external support.
Popular Firewall Software Packages
There are many players in the ﬁrewall software market. Naming and describing them all
could easily turn into a chapter in and of itself. Instead, here we discuss Check Point
FireWall-1, which is the most commonly used ﬁrewall software package available for Solaris.
Check Point FireWall-1
Though the statistics are a couple years old, at one point it was estimated that FireWall-1 was
deployed on one of every four ﬁrewall implementations. FireWall-1’s feature set as well as its
complexity have made it quite popular with enterprises.The complexity of the software has
also led to the creation of several levels of certiﬁcation for use of the product itself.This says
little about the product but more about its widespread use.
Check Point has roughly everything one would expect from a standard ﬁrewall package.
It uses stateful packet ﬁltering, works with multiple interfaces, and can perform NAT ser-
vices. Some deployments can be conﬁgured to provide failover services in the event of loss
of one ﬁrewall.
Prior to using FireWall-1 for a DMZ implementation, it is recommended that people
using the software familiarize themselves with the package.Although the slick GUI for con-
ﬁguration could put some users at ease, inexperience with the software can minimally lead
to a very frustrating experience. Table 3.1 shows the Check Point NGX modules available
on Solaris platform.
Table 3.1 Check Point NGX Products on the Solaris Platform
Products
Available on Solaris UltraSPARC 8, 9, and 10
SmartConsole GUI
X*
SmartPortal
X
VPN-1 Power (VPN-1 Pro) 
X
including QoS, Policy Server
VPN-1 UTM (VPN-1 Express/
Express CI) 
VPN-1 VSX 
SmartCenter Server
X
SmartPortal
X
ClusterXL (VPN-1 Power Module)
X
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
109
Continued

Table 3.1 continued Check Point NGX Products on the Solaris Platform
Products
Available on Solaris UltraSPARC 8, 9, and 10
UserAuthority
X
Eventia Reporter—Server
X
SmartView Monitor
X
VPN-1 Accelerator Driver II
X
VPN-1 Accelerator Driver III
X
Performance Pack
X
SmartLSM—Enabled 
X
Management
SmartLSM—Enabled 
ROBO Gateways
SmartLSM—Enabled 
X
CO Gateways
Advanced routing
SecureXL TurboCard 
SSL Network Extender—Server
X
Provider-1/
SiteManager-1 Server
X
Provider-1/
SiteManager-1 GUI
X
* SmartConsole clients SmartView Monitor, SmartLSM, Eventia Reporter Client, and
the SecureClient Packaging Tool are not supported on Solaris UltraSPARC platforms.
Table 3.2 shows the minimum hardware requirements of Check Point NGX R61 (Sun).
Table 3.2 Minimum Hardware Requirements of Check Point NGX R61
Hardware
Minimum Requirement
VPN-1 Power SmartCenter 
Server or Enforcement Module
Processor 
UltraSparc II 
Memory 
128Mbytes RAM
(256Mbytes recommended)
Disk space 
100MB for installation 
Network interface 
1 or more network interfaces 
Media drive 
CD-ROM drive 
www.syngress.com
110
Chapter 3 • Sun Solariz DMZ Design
Continued

Table 3.2 continued Minimum Hardware Requirements of Check Point NGX
R61
Hardware
Minimum Requirement
SmartConsole 
Processor 
UltraSparc III 
Memory 
128Mbytes RAM 
Disk space 
100MB for installation 
Network interface 
1 network interface 
Media drive 
CD-ROM drive 
Graphics 
800x600 video adapter 
Eventia Reporter* 
Processor 
UltraSparc III 900Mhz 
Memory 
1GB RAM 
Disk space 
80MB for installation 60GB for database
Network interface 
1 network interface 
Media drive 
CD-ROM drive 
Graphics 
1024x768 video adapter 
* SmartConsole clients SmartView Monitor, SmartLSM, Eventia Reporter Client, and
the SecureClient Packaging Tool are not supported on Solaris UltraSPARC platforms.
TIP
For more information on Check Point hardware and software requirements, visit
www.checkpoint.com/ngx/upgrade/requirements.html.
You can install Check Point SmartCenter server and SmartConsole GUI on the same
server. However, in normal practice SmartConsole GUI is installed on the security adminis-
trator’s desktop. Figure 3.8 shows the SmartConsole GUI.
High Availability of the DMZ Server
Another design issue that should be addressed in the planning phase is high availability.
Designing, building, and deploying a DMZ server are crucial steps in securing a network.
However, if the DMZ server fails, an outage of all network resources occurs until the system
is either ﬁxed or replaced.This includes a public network outage, which means public-facing
systems in the DMZ cannot be reached by systems on outside networks.This also means
network connectivity from the private network to external networks is affected.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
111

Figure 3.8 The SmartConsole GUI 
Failure may occur for one of any number of reasons. Often, catastrophic failure such as
the failure of a component in the system can result in the system becoming completely
unavailable and requiring that the component is either repaired or replaced before normal
network operations can resume.The goal of high availability is to minimize the amount of
time lost when the DMZ server fails.
High availability is created by deploying two or more systems to perform the same job in
what is called a cluster. One system in the cluster sits by idly while the other system serves
client requests.The serving system continually monitors itself and sends information to its peers
about its current state of operation. Should the system performing the job fail, the next system
in the cluster identiﬁes the failure and takes over the job performed by the failed system.
Let’s discuss some high-availability packages in a little more detail.
Check Point Cluster
Check Point FireWall-1 has a diverse set of features. One of these features is high availability,
made possible through the ClusterXL module.
The ClusterXL module is diverse in its function. It can enable a cluster of FireWall-1
servers to act as failover systems. It can also be conﬁgured as a load-balancing system, which
can aid in handling networks prone to large spikes of network activity. If an HA module is
implemented, the ﬁrewall system acts as Active/Passive, in which one ﬁrewall acts as the pri-
mary ﬁrewall and the second remains a standby. When you deploy ClusterXL (additional
licensing required), the ﬁrewall system acts as Active/Active, in which both the ﬁrewalls
handle trafﬁc and perform load balancing. Figure 3.9 shows the Check Point cluster.
www.syngress.com
112
Chapter 3 • Sun Solariz DMZ Design

Figure 3.9 Check Point Firewall ClusterXL
After you install Check Point ﬁrewall modules on two separate servers for clustering,
SmartCenter management on another server, and the Smart Center GUI on a desktop or
administrator’s computer, you need to create a cluster object and add the two ﬁrewall mod-
ules as members in the cluster. Figure 3.10 shows cluster object members.
Figure 3.10 Cluster Object Members
ClusterXL may be conﬁgured in unicast or multicast mode. Both these modes require
speciﬁc conﬁgurations. Figure 3.11 shows ClusterXL properties. For more details, refer to the
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
113
Internet
Check Point Smart Center Management
Check Point Smart Center Console
Firewall Module
10.0.0.1
FIREWALL 1
Firewall Module
10.0.0.2
FIREWALL 2
10.0.0.4
192.168.1.1
192.168.1.2
Firewall HA Link
Cross-Cable
Active/Passive – HA Module
Active/Active - ClusterXL
Public IP x.x.x.1
Public IP x.x.x.3
Public IP x.x.x.2
DMZ  
DMZ  
Internal Network
Switch
Public_Cluster_IP
Internal_Cluster_IP
10.0.0.3

Check Point documentation at www.checkpoint.com/support/technical/documents/
docs_r61.html.
Figure 3.11 Cluster Object Members
Implementing a ﬁrewall cluster in a multicast mode means that both ﬁrewall modules
need to be reachable from the router all the time and therefore responding to multicast
queries.This could require that an ARP entry be added to the router. Multicast MAC
addresses can be found in the cluster advance properties screen. Use the following command
to add the entry:
router(conﬁg)# arp public_ip_of_the_cluster 0100.5e3c.6e42 arpa
IP Filter Firewall
Solaris provides conﬁguration ﬁles such as ipf.conf, ipnat.conf, and ippoo.conf. These ﬁles
are found in the /etc/ipf directory. By rightly editing these ﬁles you can utilize your Sun
Solaris server as a ﬁrewall or a NAT device.
You can conﬁgure packet ﬁltering and NAT rules using an IP ﬁlter ﬁrewall.The syntax
for a packet ﬁltering rule is:
action [in | out] option keyword, ...
For example:
block in quick from 192.168.10.0/24 to any
This rule will block all incoming trafﬁc from the network 192.168.10.0/24
www.syngress.com
114
Chapter 3 • Sun Solariz DMZ Design

You may also implement NAT rules using an IP ﬁlter ﬁrewall.The syntax to implement
a NAT rule is:
command interface-name parameters
If you want to translate the outgoing trafﬁc from the le0 interface that has a source net-
work address 192.168.10.0/24 to 10.1.1.0/24, you need to create this rule:
map le0 192.168.10.0/24 -> 10.1.1.0/24
Before you conﬁgure packet-ﬁltering rules or NAT rules, ensure that you know the
source and destination network or network objects, the type of protocol or service, and
whether you want to permit or reject the trafﬁc and/or translate.
Security Features of Sun Solaris 10
The Solaris 10 operating system comes bundled with an integrated packet-ﬁltering ﬁrewall
and IP ﬁlter. It is an open-source, cross-platform packet ﬁlter.The IP ﬁlter is used to manage
the type of trafﬁc and the trafﬁc ﬂow to and from a system.
Solaris also provides the Automated Security Enhancement Tool (ASET) that helps you
monitor and control system security.This eliminates any manual work of hardening.You
need to choose one of the security levels such as low, medium, or high. Once ASET is exe-
cuted, it increases your system security by tightening the ﬁle access.The Low level sets the
ﬁle system attributes at a standard level.At this level only a security check is performed.The
Medium level sets the ﬁle system to a security level that is adequate for most environments.
At this level system ﬁles and parameters are modiﬁed.The High level ensures that the
system’s security is set to the highest levels.This means that minimum access is available to
system ﬁles, and most of the ﬁle system parameters are modiﬁed.
ASET performs several tasks, including tuning system ﬁle permissions, system ﬁle
checks, user and group checks, system conﬁguration ﬁle checks, environment variable
checks, and EEPROM checks. More information is available on the security services
volume of Sun Solaris 10 system administration guide (http://docs.sun.com).
Veritas Cluster Server
Cluster Server by Veritas is another high-availability software package. Cluster Server is inde-
pendent of other applications on the system and is not dependent on any one application.
This independence offers the advantage of allowing a group of DMZ servers using ﬁrewall
software packages that are not highly available to be conﬁgured into a cluster of failover
hosts.
Cluster Server requires cluster conﬁgurations that have a means of communication
between all nodes in the cluster via a network interface.This is a circumstance in which our
previous discussion about the user of quad Ethernet cards applies. With an extra interface on
the DMZ server, we can group together the DMZ server and backups into a cluster, making
the network highly available.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
115

Sun Cluster
Sun Cluster is another high-availability package.As the name implies, it is distributed and
maintained by Sun. Sun Cluster is written speciﬁcally for Solaris and Sun hardware.
Like Veritas Cluster Server, Sun Cluster is independent of any particular application.Also
like Veritas Cluster Server, the Sun Cluster software package can be used to make roughly
any ﬁrewall software system highly available.
Host Security Software
Ensuring the reliability and integrity of the DMZ system means using host integrity-moni-
toring software to report activity that could indicate intrusion. Like many other security
measures, integrity monitoring is a reactive measure that involves notifying staff responsible
for the system in the event of noisy and messy compromise. However, knowing of a com-
promise after the fact is far better than never knowing about it at all.
For the most part, host integrity-monitoring software works in one of two ways. One
method that host integrity software uses to monitor the system is monitoring activity on the
local system’s ports to identify activity that could indicate a compromise.Any activity that is
known by the software to represent a likely intrusion is reported.
The other method is the creation of a database of cryptographic hashes of binaries
installed on the system. When the host integrity software is installed and conﬁgured, the
software crawls the directories it is conﬁgured to monitor and creates the hash database.The
host’s integrity is maintained by checking the hashes of the monitored binaries and directo-
ries against the hashes contained in the database.
Although it might seem intuitive to use software that monitors both the ports on the
DMZ server and the hashes of local binaries, it is best to use software that monitors only the
local hashes.The reason for this is a matter of exposure.The addition of any network-aware
services additionally exposes the system to attack.
Of the software available for host integrity monitoring, two packages are most com-
monly used.The ﬁrst is the commercially available Tripwire package.The other widely used
software package for this purpose is the Aide software package.
Cisco Security Agent, Cisco’s solution for end-point security is available for Sun Solaris
8 and 9 server platforms.
Other Software Considerations
To properly place a DMZ server in the network infrastructure, we typically put it in a location
that is ideal for a number of other services. Often, it seems like a good idea to place services on
the DMZ system that are used for the infrastructure of the network.These services can include
things such as Web servers, domain name servers, mail servers, or other such services.
You must resist this temptation.As we discuss in the conﬁguration section, the host that
will be providing DMZ and ﬁrewall infrastructure to the network should run with the min-
imal number of services possible.There are many reasons for this approach; here we focus on
two.
www.syngress.com
116
Chapter 3 • Sun Solariz DMZ Design

First, the DMZ server is dedicated to handling network trafﬁc.As previously stated, this
is extremely RAM- and processor-intensive activity. Running additional services consumes
additional resources that could otherwise be dedicated to handling network trafﬁc.Although
the impact might not be readily apparent on a lightly loaded network, as the network trafﬁc
load handled by the DMZ server increases, the impact becomes much more apparent. Often,
such a situation results in failure of systems to connect to hosts, because the system drops
packets due to limited resources.
Second and more important: Running network services on the system increases the
system’s exposure to potential vulnerabilities and thus potential attacks.The cornucopia of
past vulnerabilities in the Berkeley Internet Name Daemon (BIND), in addition to the likely
future continuation of the BIND vulnerability saga, is a prime example of the dangers of
deploying services on the host. Sendmail and the numerous and frequent vulnerabilities in
the software are other examples. Even intrusion detection software packages such as Snort
are not immune to remote vulnerabilities, as displayed recently in the Snort TCP Stream
Reassembly Buffer Overﬂow Vulnerability by the research team of Core Security
Technologies.
Increasing the exposure to remote vulnerabilities with the DMZ server is, to put it
bluntly, stupid. Should the system be compromised, an attacker is granted not only access to
all hosts on the DMZ but full access to all hosts on the private network segment as well.
Once the DMZ system is compromised, the network’s integrity can no longer be trusted,
and the attacker can direct trafﬁc to wherever whim may lead.
The selection of hardware and software is important in the reliability, stability, and per-
formance of the DMZ server. However, the next step in the planning phase has a far greater
impact on the security and integrity of the system. Let’s discuss the design of a secure system
conﬁguration.
Conﬁguration: The Plumbing and Other Details
The conﬁguration portion of system design is the stage in which we lay out the way the
host will be implemented. We previously discussed the selection of hardware and software
and the surrounding impact on performance; in this section we discuss the conﬁguration
details of hardware and software as they relate to security. Conﬁguration can make the differ-
ence between a stable, reliable DMZ server that is resistant to remote attacks and one that is
exposed and thus prone to attack and compromise when the next remote vulnerability is
discovered.
Creating a secure DMZ server conﬁguration requires the use of two distinct concepts: cre-
ating a secure conﬁguration and using layers of security in our conﬁguration. Because most
security measures are reactive in nature, making security the basis of conﬁguration at this stage
is a fundamental change to the way security is typically handled, making it a proactive measure.
Our network will be only as secure as the design of the DMZ server itself. We must
therefore create a conﬁguration that exposes our DMZ server to no more risks than neces-
sary. Let’s look in depth at creating a secure conﬁguration.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
117

Disk Layout and Considerations
Before you can decide on a disk design, you must ﬁrst gather some information. First, it is
necessary to determine the size of the disks.This information can be gathered from the doc-
umentation or marketing literature for the selected system hardware. Or, if the disks will be
hosted on a storage system such as a RAID cabinet, get the size information for the allocated
disks in the cabinet.
Now that you have the information about the disks, the next step is to decide on the
type of ﬁle system the host will use. In some conﬁgurations, such as a cluster, the stock UFS
ﬁle system might be sufﬁcient. However, in other conﬁgurations, it might be wise to use a
different ﬁle system, such as a journaling ﬁle system. One example of such a system is the
Veritas File System.
Another consideration is disk failover. Using a RAID cabinet simpliﬁes this issue, since
many RAID cabinets handle the disk issues on the storage server side, allowing us to merely
identify the device on which the data is located in the system PROM and conﬁguring the
disk cluster in the cabinet to worry about the failover for us. However, in conﬁgurations
such as our previously mentioned hardware, we could be using local disks. In this case, we
might have to use additional software to provide redundancy in the event of disk failure.
This task can be accomplished through other software packages, one of which is the
Solstice DiskSuite. DiskSuite is a soft solution to creating RAID conﬁgurations. Using disks
on the local system, DiskSuite can be used to create RAID 0, RAID 1, RAID 0+1 (also
called ten), and RAID 5 conﬁgurations. Depending on business needs and availability of
storage, the best solution is typically a RAID 0+1 conﬁguration.
Once we’ve attended to these details, we can decide the layout of the disk. For our pur-
poses, we assume the use of a 36GB disk.Although recommendations on disk layout vary, we
can safely allocate space of the following minimums to the various ﬁle systems:
■
For the root partition (/), a minimum for 500MB
■
For the swap partition, at least twice the amount of physical memory (RAM)
■
For the /usr partition, at least 1.5GB
■
For the /opt partition, at least 500MB
■
For the user home partition (typically /export/home), at least 1GB
■
For the /var partition, as much of the remaining space as possible
Allocating as much space as possible to the /var partition gives us the beneﬁts of plen-
tiful log space. Even with this minimum recommended conﬁguration, a system with 1GB of
physical memory and a 36GB disk will have 31.5GB of space for log information.Although
this might seem like a massive amount of space, a busy DMZ server with increased auditing
and logging enabled will easily gobble up this space (as we see in the next section). Logging
on a separate server from the DMZ will not only provide additional security—it also
improves the performance of the DMZ server itself.
www.syngress.com
118
Chapter 3 • Sun Solariz DMZ Design

Sun Solaris 10 introduces ZFS, which offers data integrity and scalability. With a pooled
storage model, it eliminates issues with respect to creating partitions and unutilized storage
space. File systems can draw storage for their requirements from a common pool of storage,
therefore utilizing only as much space as required.This model ensures that the combined
I/O bandwidth is available to all the ﬁle systems.
Backup and restore features of ZFS use snapshots to create full or incremental backups.
ZFS provides built-in compression facilities. ZFS offers signiﬁcant performance improve-
ments over UFS.
Increasing the Verbosity of Local Auditing
Local auditing is an important factor in preserving the integrity of a host.Audit data is the
ﬁrst line of information in which intrusion might be apparent.Audit trails also have a legal
signiﬁcance; whenever there is an intrusion, log data becomes evidence that may be admis-
sible in court. For these reasons, audit conﬁgurations must be increased in verbosity.
Solaris includes a number of auditing choices with a stock installation of software.As
with every UNIX implementation, Solaris provides the standard system-logging facility,
Syslog. Syslog is a good source of basic system information, but in addition to the standard
audit trail provided by Syslog, Solaris additionally implements other utilities, such as the
Basic Security Module, or BSM, as it is commonly known.
BSM is a highly conﬁgurable, robust, low-level auditing tool. It is disabled in default
implementations of Solaris but can easily be enabled. BSM logs data when system calls of an
interest in regard to security are invoked. Data written to the BSM ﬁles is in binary format.
The BSM conﬁguration ﬁle is located at /etc/security/audit_control. More information
about BSM is available through http://docs.sun.com.
You can enable BSM as a root user by issuing:
#/etc/telinit 1 (To bring the system to single-user mode)
# cd /etc/security
# ./bsmconv (To enable BSM)
Disable BSM by issuing:
# /etc/telinit 6 (To bring the system to single-user mode)
# cd /etc/security
# ./bsmconv
A typical audit_control ﬁle will look like this:
ﬂags:lo,ad,-all,^-fc
minfree:25
dir:/etc/security/audit/server1/ﬁles
#
#This is to audit when the ﬁle system of server1 is ﬁlled by at least 75%
#
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
119

The preceding script monitors server1, and as soon as the ﬁle system of server1 gets ﬁlled
up by at least 75 percent (minimum free is 25 percent, as per this example), it runs the
warning script.The ﬂags deﬁne that all logins and administrative operations should be
audited. ^-fc means that ﬁle system creation failures are to be ignored.All other failures must
be audited.
Increased auditing directly translates to log ﬁles of increased size. Often, data generated
by auditing falls into one of two categories: It is either too much and thus too cumbersome
to review, or it is not understood and thus auditing is turned off.These problems are often a
matter of proper BSM conﬁguration. However, it goes without saying that large amounts of
data can still be generated, even with proper conﬁguration.This data is important and should
be reviewed regularly. It should also be preserved for future reference, which we discuss in
the next section.
Backup Considerations
DMZ servers, like all systems, have data that is irreplaceable. On other systems, this data
could be customer information, credit card numbers, or other business information. On
DMZ servers, business information equates to system logs, audit data, and ﬁrewall logs.
As mentioned in the previous section, this data is crucial, especially from a legal aspect.
Therefore, this data must be backed up and saved for future reference and analysis. For this
reason, we must take into consideration the backup of DMZ servers.
Since a Solaris DMZ server is, at its root, a Solaris server, its backup differs little from
other systems. Designing a backup solution is the same process as for any other host.
However, we must consider the system’s sensitivity.
Because a DMZ server is often the linchpin of networks, and because compromise of
the system constitutes compromise of the network, we must make every effort to isolate the
DMZ server from attack, and backup is no exception.Although it is sufﬁcient for other sys-
tems to initiate backups via storage networks and backup servers, it is important for the
DMZ server to keep its data backed up in a location that is isolated from other systems.
Additionally, media should be, if possible, in an append-only conﬁguration.
Two other issues to consider are storage constraints and backup software. Will storage
constraints permit nightly backup of the entire system? Or is a better solution to back up
only the important ﬁles? These questions cannot be answered without evaluating the
resources at your site.
Backup software, on the other hand, is a much easier issue to tackle. If you’re using a
conﬁguration such as a master backup repository and NetBackup, the solution is pretty clear.
On the other hand, if nothing as formal is in place, ufsdump, included with Solaris and a
DLT drive, could be the best solution.
Remote Administration
Most servers are administered remotely through either a graphical tool or a tool that uses the
command-line interface. Often, the servers are stored in a location that either is uncomfortable
www.syngress.com
120
Chapter 3 • Sun Solariz DMZ Design

to work in, such as a cooled server room, or requires travel to the site to administer, which in
most operations departments, whether a remote colocation facility or the next room, is out of
the question. DMZ servers are no different than any other server in this regard.
You must plan for remote administration and the impact on DMZ servers. It is not rec-
ommended that you provide any remote services that could increase potential exposure to
attack, but sometimes this simply is not an option. If you’re using services for remote admin-
istration, you must provide access control for these services, such as ﬁrewall rules.
Additionally, the use of cryptographically secure services such as Secure Shell (SSH) is rec-
ommended because these services are less prone to peers and intermediaries on the network
eavesdropping on potentially sensitive information such as passwords.
Putting the Puzzle Together
Before we can create a secure conﬁguration, we must ﬁrst know what to expect from a
default conﬁguration.After we have selected our operating system and third-party software,
we need an idea of what to expect in terms of services, requirements, and default insecurities
caused by the interactivity of all components. Having this information will better equip us to
make informed decisions.
This is the phase in which we gather as much information as possible about the system
in question. In many cases we can go online to get most of the pertinent details about
default services started by the operating system and third-party software. Vendor sites as well
as other third-party sites contain a wealth of information that can help us determine hurdles
we might face in creating a secure conﬁguration.
Should this approach not yield sufﬁcient information or should we decide to take a
more hands-on approach for our speciﬁc conﬁguration, we can always create a test imple-
mentation.This implementation is really no more than an experiment.The installation pro-
cedure is not meant to be secure, and the software installation is not meant to be kept for
future production use.The idea is to put together all the components, hardware and software,
to see how they all interact with one another.
Once we have created a test implementation, we must gather information from it.To
gather local information about the default conﬁguration, we can usually use local system
tools.These tools include ps(1) and netstat(1M). We use ps to gather information about the
processes started by default on the system, as shown in Figure 3.12.
Once we have gathered process table information, we gather network socket table infor-
mation with netstat, as shown in Figure 3.13.
Once we have gathered this information, we can create a model of our design.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
121

Figure 3.12 Getting a List of Executing Processes With the ps Command
Figure 3.13 Getting a List of Listening Services With the netstat Command
Layering Local Security
The problem with most systems implemented on the Internet is that they are designed like
candy: Many have a hard exterior that is crunchy and difﬁcult to bite through, but once the
hard shell has been breached, the center is soft and chewy.
This problem is not the fault of any one person in particular. Vendors design and create
software this way.Administrators implement software this way. Security personnel run vul-
nerability scanners against the network and make the assumption that because there are no
scanner events detailing remotely exploitable bugs, the systems are secure.
To Sun’s credit, the company is making strides to combat this complacency. In Solaris
versions through 7, we have ﬁle access control lists, an extension of the UNIX permission
www.syngress.com
122
Chapter 3 • Sun Solariz DMZ Design

model designed to provide more granular access control. With Solaris 8, Sun implemented
role-based access control (RBAC), which can be used to add power to or remove power
from certain users. Security in 9 and 10 have been enhanced to meet the changing demands
Other third-party security software packages exist as well.Two additional features are
restricted shells and restrictive environments. Let’s brieﬂy focus on each of these topics.
File Access Control Lists
As previously mentioned, ﬁle access control lists are an extension of the UNIX permission
set.They are implemented at the ﬁle system level and designed to enforce security policy on
a much more granular level.The tools setfacl(1) and getfacl(1) are used to manipulate these
permissions.
The difference between standard permissions and ﬁle access control lists can be likened
to allowing an entire group access to a speciﬁc ﬁle versus being able to select exactly which
members of the group can access the ﬁle.Access control lists can also be used to limit which
users in the world can read or execute a world-readable and/or world-executable ﬁle.A brief
example of these programs appears in Figure 3.14.
Figure 3.14 Using setfacl and getfacl to Add and Restrict Access Permissions
for Individual Users
In implementations in which there is a small user base, ﬁle access control lists might be
handy. By adding granular access control lists to programs that might be sensitive, such as
setuid and setgid executables, you can effectively put these programs out of reach of the
unprivileged attacker.Although this solution cannot mitigate every single potential risk and
attack, it deﬁnitely raises the bar.
DMZ servers are not and should not be designed to handle local users outside of
administrative staff, due to the sensitivity of the system. However, this solution provides an
additional layer of security against unprivileged local users. It is not a useful countermeasure
in attacks that result in remote administrative compromise.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
123

Role-Based Access Control
Role-based access control, also known as RBAC, is another useful enhancement to the
UNIX permission model. RBAC is designed to allow administrators to delegate certain per-
missions within the system to roles, giving power to role users. RBAC can also be used to
remove power from users.
The removal of power from users consists of creating traditional UNIX user accounts as
roles.This way, you are given the ability to granularly specify exactly what the user can and
cannot do. Creating a role for these users can limit the impact of system compromise
through a speciﬁc user account.
Restricted Shells
Restricted shells are an older solution to untrusted user access.Their name implies exactly
what they are: shells that are restricted.The restriction comes in the form of not permitting a
user the ability to change certain proﬁle information or escape his or her home directory.
Restricted shells can be useful in the event of a compromise of a user account on the
DMZ system. If a user account is compromised through either a stolen password or a brute-
force attack, the attacker gains access to an account in which the user can only execute pro-
grams contained in the home directory. Used in combination with RBAC, this can be a
powerful conﬁguration, because the user has the ability to only change to a role. However, if
a program is made available within the directory that allows the user to execute shell com-
mands, as is the case with most text editors, it is possible for the user to escape the restricted
home directory by executing a standard shell.
Restrictive Environments
Restrictive environments are another useful means of mitigating risk locally. Like most other
security measures, restrictive environments are, at best, a ﬂaky solution if used as a sole means
of maintaining host security. However, when coupled with other security measures, restric-
tive environments can signiﬁcantly mitigate risk and increase the delta between a user
gaining unauthorized access to a system and discovery of that breach.
Restrictive environments are often implemented in the form of a root directory change,
also known as chroot.The principle is to create a pseudo-root directory from which a process
executes. If the process is ever compromised due to vulnerability in execution, the attacker
gaining access to the system with the privileges of the process is restricted to the pseudo-
root directory. Known problems with chroot in some implementations can allow a user to
escape the pseudo-root directory. However, as an additional layer of security, chroot is an
excellent obstacle that can increase the precious amount of time leading to discovery from
when a restricted account is compromised to when administrative privilege is compromised.
Auditing Local File Permissions
Local ﬁle permissions can be the boon or bane of a DMZ system security model, and they
have resulted in many heated arguments. In many modern UNIX systems, ﬁles installed on a
www.syngress.com
124
Chapter 3 • Sun Solariz DMZ Design

system during a default implementation could put the system at unnecessary risk.This is not
necessarily the fault of the vendor; the program is written based on a user request and often
given privileged execution status due to the need to access information or perform opera-
tions that require privilege. However, unintentional programming errors within the program
make it a risk to the integrity of the entire system.
It is possible to mitigate this risk through local ﬁle permission auditing.This is a process
that requires research and attention to detail. It is possible to reduce the execution permis-
sions of many programs. However, reckless removal of permissions can minimally result in
breaking applications on the system but can have more severe consequences, such as making
the system unusable.
Two methods can be used to enhance local ﬁle permissions and reduce privileges where
possible: manual auditing and automated security tools.The selection of methods is a matter
of both size of the job and personal preference. We discuss each method here.
Manual File Permission Auditing
Auditing ﬁle permissions manually can be tedious work, especially if the person doing the
auditing is not intimately familiar with the operating system’s idiosyncrasies. Not knowing
how to use tools supplied on the local system nor where to locate documentation and infor-
mation about various programs can cause the job to escalate from the level of an exercise in
frustration to the level of an exercise in restraining oneself from beating the system with a
sledgehammer, especially when the usual unrealistic deadlines loom.
For people who are more comfortable with the system or who at least have the luxury
of time, manual ﬁle system auditing can be beneﬁcial in that it both allows you to get even
more familiar with the operating system and allows you total control in local ﬁle permission
security.This discussion assumes that the previous idea of building a test system that is used
merely for information gathering in design is possible.
The two most useful system utilities for auditing local ﬁle permissions are ﬁnd(1) and
man(1). Using ﬁnd to locate ﬁles on the system installed with elevated privilege, as shown in
Figure 3.15, makes the task signiﬁcantly easier.
Upon compiling a list of executables installed with elevated privileges, you must under-
stand the purpose of the executable to determine whether or not permissions may be low-
ered. For example, the su(1M) program is installed with setuid root privileges. Removing the
setuid bit, however, usually has negative consequences because users can no longer use the su
program to log into a different account from the shell, including that of root.This is where
the man program becomes handy. Understanding the purpose of the program, how it inte-
grates into the environment, and whether or not it really needs elevated execution privileges
in the conﬁguration is essential and can only be obtained through research and wisdom.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
125

Figure 3.15 Using ﬁnd to Get a List of Files With setuid Privileges on a
Solaris System
For programs not documented in manual pages, other resources exist.A good starting
point is the Sun documentation site, at http://docs.sun.com. If documentation of the pro-
gram does not exist there, resorting to a search engine might be in order. If you can’t locate
any documentation on the program, the rule of thumb,“If it ain’t broke, don’t ﬁx it,” applies.
Automated File Permission Auditing
For readers with less time to perform ﬁle permission auditing or who are uncomfortable
with it, it is likely a relief to know that others have already done much of the work of ﬁg-
uring out which programs really need elevated privileges. If digging into the system is not
on your agenda for the day and you’re apt to trust free tools, one of two widely used pro-
grams can perform much of this work for you.
The ﬁrst of these programs is the Computer Oracle and Password System, or COPS.
Originally written by legendary security professionals Dan Farmer and Gene Spafford,
COPS audits the local system for insecure ﬁle permissions, executables with elevated privi-
leges, and weak passwords.Although it is somewhat dated, the program is well written and
still extremely useful. It can be downloaded from the U.S. Department of Energy Computer
Incident Advisory Capability at ciac.llnl.gov/ciac/ToolsUnixSysMon.html.
Another available tool is the Yet Another Solaris Security Package, or YASSP, as it is
commonly called.YASSP is written speciﬁcally for Solaris and performs many of the same
functions as COPS.This program is also a bit dated but is an excellent utility for enhancing
local ﬁle permission security.
One ﬁnal tool we will mention is the FixModes script. Written by Casper Dik of Sun
fame, FixModes is another utility designed speciﬁcally for Solaris. It audits the ﬁle system of
the host for programs with insecure permissions and makes changes necessary to enhance
local security.
www.syngress.com
126
Chapter 3 • Sun Solariz DMZ Design

Building the Model for Future Use
As a kid, I was astonished by models. My friends used to build incredibly detailed, scaled ver-
sions of things like planes, aircraft carriers, battleships, and helicopters. Because I lacked the
manual dexterity and artistic gifts of many of my peers, my ﬁnished models often left much
to be desired.An attempt at a model of the U. S. S. Enterprise once resulted in something that
resembled a model train wreck.
So, if the thought of creating a model of a system brings out your anxiety of past child-
hood shortcomings, worry not; for this model, we need little more than a text editor or a
pencil and paper if we want to use a low-tech solution.The process of creating a model can
be approached by two methods: either listing what we need or listing what we don’t need.
In most conﬁgurations, it is easier to take the former route to creating a model than it is to
take the latter.
In Table 3.3, we have created a model of a system using the method of listing what we
need.As you can see, we have speciﬁcally listed our requirements on the left, and on the
right we’ve made an inventory of items to fulﬁll our needs. We can be as minimal or as
fancy as we want with our model; what counts is that we list everything we need and every-
thing we are going to do to fulﬁll the requirements.
Table 3.3 A Model of a System Design Listing Only the Requirements of the
Host
Network Service 
Requirements Description
Inventory
Access to services required from the 
HTTP; SMTP; DNS
private network
Access to services required from the 
HTTP; SMTP
public network for the private network
Access to services required from the 
HTTP; SMTP; DNS; FTP
public network for untrusted sources
Access required to DMZ host
SSH from private network
Host Requirements Description
Inventory
Speed of network connections
100BaseT
Number of network interfaces 
Five
(minimum of three)
Number of disks
Two
Disk size
36GB 
Auditing utility
Basic Security Module
Backup method
Local DLT drive
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
127
Continued

Table 3.3 continued A Model of a System Design Listing Only the
Requirements of the Host
Host Requirements Description
Inventory
Remote administration
SSH
High-availability software
Veritas Cluster Server
Local intrusion detection software
Tripwire
Firewall software
IPFilter
Software to harden system
Solaris Security Toolkit
Here are some things to keep in mind when you’re building a model:
1.
Ensure that hardware includes all the components necessary to create a DMZ
server.This includes a minimum of three network interfaces.
2.
Ensure that sufﬁcient space is available for the conﬁguration on the available
drives, and allocate enough space for the ﬁle systems.Allocate as much space as
possible to the ﬁle system that will be maintaining logs.
3.
Plan to increase system audit verbosity.
4.
Ensure that the backup solution is sufﬁciently secure, and take into account any
limitations in storage that might exist.
5.
Do not install any more software than absolutely required to perform the job.
Third-party applications, such as ﬁrewall software, could have minimum software
requirements. Consult vendor documentation for speciﬁc details.
6.
Plan for high availability of the server.
7.
Plan on implementing host integrity-checking software.
8.
Plan to implement multiple layers of security.
9.
Plan to audit local ﬁle permissions.
10.
Disable all unnecessary processes.This is especially important of processes that are
network-aware and could expose the system to potential attack.
11.
Do not plan on providing network services from the DMZ server.
Once you’ve ﬁlled in as many of the blanks on these details as possible, you should pro-
ceed with design review.A peer review might also be helpful in this phase; a second set of
eyes of a person with different ideas on design could be helpful in identifying any missed
details or potential shortcomings in design. Upon successful review, implementation, which
we discuss next, can proceed.
www.syngress.com
128
Chapter 3 • Sun Solariz DMZ Design

Implementation: 
The Quick and Dirty Details
The implementation phase of a DMZ server is pretty straightforward.As with all systems, the
process consists of assembling the hardware, installing the software, installing the patches, then
conﬁguring the system.Whereas the process is the same across roughly all systems, we want to
take particular precautions to ensure the integrity of the system through the entire evolution.
In this section, we look at the details necessary to ensure host integrity through this
phase. Rather than giving a speciﬁc step-by-step outline of how you should install software
on a server, we instead create a list of general guidelines that can be used to provide the
maximum host security during the implementation process.
Media Integrity
A secure implementation cannot begin without ﬁrst obtaining valid media.Acquiring valid
media usually is done in one of two ways: It is purchased from the vendor and delivered by a
sales representative or mail, or it is downloaded via the Internet. Verifying the integrity of
media delivered in hard form, such as a CD, is relatively easy; simply look at the shrink-wrap
to see if it has been tampered with.
Verifying the integrity of media downloaded via the Internet, however, is a bit more dif-
ﬁcult.To verify the integrity of such media, the vendor must give us some secure means of
checking its validity.This is typically done through cryptography.
Often, the vendor makes available a ﬁle containing a one-way cryptographic hash value,
usually on the same page as the media or within a link of the media.The ﬁle is then signed
with a cryptographic key that can be veriﬁed as valid.This task is typically performed with a
utility such as Pretty Good Privacy (PGP) or GNU Privacy Guard (GPG). Once the
integrity of the media is veriﬁed, it is safe to proceed.
Physical Host Security
During the installation process, physical security of the host should be maintained. One way
to ensure physical security is to not leave the host unattended during the installation process.
However, if there is not adequate time to sit around and watch the installation bar slowly
progress from the left to the right side of the screen, another method is to ensure that the
system is stored in a secure location while unattended.
A secure location can be one of two things. One secure location is a locked ofﬁce.The
system can be placed in the ofﬁce with the door locked while unattended.Another secure
location is a rack. Both of these locations make the common assumption about locks, which
are designed to keep the honest man out.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
129

Host Network Security
As we’ve continuously emphasized in previous sections, the host should not be exposed to
any unnecessary risk. With that in mind, the system should not be connected to any network
resources at any point during the implementation phase. Keeping the system disconnected
eliminates the possibility of any incoming remote attacks by entirely eliminating the vector.
Even though it is considered generally safe to implement systems with a connection to
the network plugged into the host, this is making an assumption that could create a window
of exposure.Although none is currently known in Solaris, past vulnerabilities that could
permit a remote attacker to gain unauthorized access to the system have been discovered in
operating systems.This would be an ideal time for the attacker to compromise the host, since
it has little in terms of defense in place.
Additionally, just because no vulnerabilities are currently known in the installation pro-
cess does not mean they do not exist. Furthermore, even after installation, a window exists in
which vulnerable services executing on the host could be compromised.As we’re seen
recently, the time worms require to propagate across the Internet has signiﬁcantly decreased,
making any window of exposure unacceptable. In short, do not permit network connectivity
to the host at any point during the implementation phase.
Patch Application
Prior to attempting to apply to the implementation the secure conﬁguration details we have
developed, we should apply the recommended patch cluster to the host.This cluster, usually
downloaded from SunSolve, comes in the form of a large, tarred, and compressed archive of
updates to the system.
Conﬁguring & Implementing…
Solaris Patch Management
Like every other operating system, Solaris patches are periodically released. The
reasons for these patches vary, but they are often released for one of two rea-
sons: system stability or system security.
The main clearinghouse for Solaris patches is the SunSolve site, located at
http://sunsolve.sun.com. From this site, you can gain access to the latest patch
cluster via either HTTP or FTP download. In addition, automated tools are avail-
able to manage patches on Solaris systems, such as the Sun PatchManager utility
for Solaris 8 and 9. Sun Solaris 10 offers Sun Update Connection service that
delivers latest patches and updates to your Solaris 10 server. 
www.syngress.com
130
Chapter 3 • Sun Solariz DMZ Design

Although it requires network access to attain, the archive should be transferred to the
system in the most secure means possible. Often, this is by way of “sneakernet,” which is to
say archiving the patch cluster onto media and physically carrying it to the system.
Patches should be applied to the system before you attempt to implement conﬁguration
and hardening procedures.The reason for this is that when patches are applied to a system,
the details of a conﬁguration are often overwritten.Therefore, conﬁguring and hardening the
system, then applying the patches could result in the unexpected exposure of the system to
potential attack due to conﬁguration changes by the patches.
To summarize the creation of secure implementation leading up to hardening, we
should minimally fulﬁll the following requirements:
1.
Verify media integrity prior to system installation.This applies mainly to media
obtained from the Internet.
2.
Provide physical security to the host during the implementation phase.The system
should never be left unattended during the implementation phase without being
locked in a secure location, such as an ofﬁce or a rack.
3.
Protect the system from attacks via the network during the implementation phase.
This means not connecting the host to any network until the implementation
phase has been completed.
4.
Apply all patches to the system as a last step before conducting hardening and
secure conﬁguration procedures on the host. Patches will often change conﬁgura-
tions, which could leave the host exposed to remote attack.
Solaris System Hardening
In some groups, system hardening is thought of as a separate phase in the system life cycle.
However, system hardening is really just a subsection of system implementation. Hardening
occurs before the system is connected to any network and should be periodically reevaluated
and performed again.This is because conﬁguration is always apt to change, whether the
changes come from administrative staff or other sources such as system patches.
The hardening of the system amounts to no more than the application of the design
principles we developed during the planning phase. During the planning phase, we made
several decisions about disabling this and that, changing the permission on ﬁles, and so forth.
This phase of the implementation is where the rubber meets the road in terms of our 
original design.
Two methods can be used to harden a Solaris system, each with its beneﬁts and draw-
backs. One method, manual hardening, consists of making by hand the changes that we
detailed in our system model during the planning phase.This method has the beneﬁt of
giving us complete control over the hardening process.The drawbacks of this method are the
amount of time involved manually hardening the host, the esoteric knowledge required to
create a hardened conﬁguration, and human error. Manual hardening and conﬁguration of
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
131

Solaris DMZ servers is not for administrators who lack an intimate knowledge of UNIX
systems and Solaris.
The other method of hardening hosts is the use of automated hardening tools. We have
mentioned these tools before.Automated tools have the beneﬁt of giving us a speedy, hard-
ened conﬁguration.Automated tools are also not prone to missed details due to human
error. However, automated security tools have the distinct drawback of applying chainsaw
methodology to system security.Additionally, you must trust another person’s idea of a hard-
ened system, thus relinquishing control of the conﬁguration.
The decision of manual or automated hardening ultimately rests with the person imple-
menting the system.The two important factors that inﬂuence the decision are time and
expertise. In the next two sections, we discuss manual and automated hardening. In the
manual hardening section, we discuss the steps that are generally considered the hardening
best practices. In the automated hardening section, rather than discussing the functions of the
tools themselves (they essentially all work the same way), we discuss a few different available
tools and highlight some of their features.
Manual System Hardening
We should preface this discussion with a short deﬁnition of system hardening. In the pre-
vious sections, we have emphasized the importance of limiting exposure so many times, it is
almost painful to mention it again. However, be ready to feel the pain, because we are about
to discuss it again.
System hardening is, for the most part, the limiting of exposure.The way hardening dif-
fers from other security precautions is that although many other security precautions require
the addition of software to enhance security, hardening typically involves the removal of soft-
ware. In addition to the removal of software, it is also a procedural activity that typically
involves the changing of permissions on ﬁles and directories as well as the removal or dis-
abling of other components and features prone to abuse on the system.
Based on our initial design, we know which software and services we intend to keep.
Our ﬁrst step in hardening is to remove the software that we do not intend to keep.
Afterward, we remove the services we do not intend to keep. We follow this step with some
additional conﬁguration variables that may enhance security.
NOTE
You need to understand the architecture of Solaris, the purpose of individual
services and directories, and dependency of one service on another to function
smoothly before you start tweaking the system. Always ensure that you do one
change at a time, and check the system for stability before you proceed further.
Document every change you make, including the ﬁles removed, services
stopped, and conﬁguration ﬁle edits. 
www.syngress.com
132
Chapter 3 • Sun Solariz DMZ Design

Software Removal
No matter how much attention to detail we pay to the host during installation and how
careful we are about the software we install, we inevitably end up with unintended software
installed on the system.This is a fact that we must resign ourselves to and make plans to
spend time combing through the installed software, removing that which we do not need.
Post-installation, we can get a list of installed software using tools distributed with the
operating system.The two most important tools available for this job are the pkginfo(1) and
pkgrm(1M) tools, installed with all Solaris installations by default.The pkginfo tool allows users
to query the package database for installed packages in Sun package format, whereas pkgrm
allows users to remove packages installed in Sun package format.
To get a listing of installed packages, one must ﬁrst execute the pkginfo program.As
shown in Figure 3.16, pkginfo displays the contents of the entire package database with the
following information:
■
The category into which the package falls
■
The package instance
■
A brief description of the package
Figure 3.16 Getting a List of Installed Packages With the pkginfo Command
We can redirect this information to a list for review, because often the output is quite long.
Redirecting the output can be extremely helpful, since it can help us create a list of installed
packages to evaluate for removal, away from the console.We may also create a copy of this list
and edit it to contain only the packages that we want to remove from the system.This type of
list is useful if we want to write a script that invokes pkgrm to remove the packages.
Though the base of an end-user installation is relatively small, there is room for
improvement. Obviously, a DMZ server is not going to require a plethora of language-
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
133

compatibility packages to provide functionality. We can evaluate eliminating these to support
only the language or languages used within our region. In addition, other compatibility
packages, such as the packages for NFS, and the audio packages can also likely be removed.
Another suite of software packages to consider removing is the graphical desktop soft-
ware itself.This comes in the form of Common Desktop Environment (CDE) and
OpenWindows software on the Solaris platform.These software suites often contain
numerous programs that execute with elevated privileges and have been notoriously “buggy”
in the past. Unless required by other third-party applications that will be used on the system,
such as ﬁrewall software, these suites should also be removed.
Upon removing all packages not required for the stable operation of the system, we
should reboot the host and move on to disabling the unnecessary services and processes.
Disabling Services and Processes
The next most important part of hardening a system is the disabling of unnecessary services
and processes.The majority of unneeded services and processes should have been eliminated
in the software removal phase. We discussed this during the design phase—creating a model
of the system and knowing what to expect in terms of default services and processes.
However, in spite of our best efforts to eliminate the majority of unneeded software, some
issues could still linger.
As we demonstrated in the section “Putting the Puzzle Together,” we need to audit the
system process table and network sockets table to identify any remaining pieces that might
be disabled.The previously mentioned reference documentation,“Back to the Basics: Solaris
and inetd.conf” and “Back to the Basics: Solaris and init.d,” might also be of beneﬁt during
this stage as aids in locating the origins of these services and processes.
Once the service or process is disabled, it might also be beneﬁcial to modify the permis-
sions of the program.Though this step might seem paranoid, we must consider that if a con-
ﬁguration error is ever made, whether out of innocence or malice, preventing the program
itself from executing might be a failsafe that prevents a possible attack. It could seem rational
to remove the program entirely, although this practice is not recommended due to the possi-
bility of needing the program in some odd future circumstance. With the program in place,
to enable it again we merely change the permissions. If it is removed, we must reinstall the
program, which could create additional work, requiring reinstall of the program, the applica-
tion of any required patches, and the modiﬁcation of the host intrusion detection system.
Once we’ve completed this step in the hardening process, we might consider imple-
menting the host intrusion detection software, testing the host, and putting it in production,
or we could consider additional conﬁguration variables to further protect the host.This is as
much a matter of preference as it is time constraints. Let’s look in the next section at some
miscellaneous conﬁguration variables that could further enhance host security.
Miscellaneous Conﬁguration Variables
A few additional conﬁguration variables could also help enhance host security.Although not
critical in nature to protecting the integrity of our DMZ server, they might be helpful in
www.syngress.com
134
Chapter 3 • Sun Solariz DMZ Design

making the system more resistant to attack.These conﬁguration variables might or might not
be helpful in each particular conﬁguration, depending on the system requirements. In some
cases, these conﬁguration variables might be possible, though in some conﬁgurations they
could have a negative impact on performance or might not be possible due to software
requirements.
The nonexecutable stack setting could be helpful in some conﬁgurations.The variable is
designed to prevent the execution of code placed in stack memory on a system. In the stack-
overﬂow problem that is commonly reported in various programs, this can prevent an
attacker from exploiting the problem to execute arbitrary code, potentially resulting in privi-
lege elevation. On the plus side, this is useful to some extent because it eliminates the ability
to take advantage of a subsection of a class of vulnerabilities. On the negative side, it could
break software depending on executable stacks, and it does not insulate the system against
other types of overﬂows such as those occurring on the heap or other vulnerabilities such as
format string and input validation bugs.A nonexecutable stack can be enabled by placing the
following entry in the /etc/system ﬁle:
set noexec_user_stack=1
Systems that have enabled this conﬁguration send a segmentation violation signal
(SIGSEGV) to programs that attempt to execute code on the stack.This activity is logged by
the system log daemon, the log entry containing the name of the program the SIGSEGV
occurred in, the process ID of the program this occurred in, and the user ID of the system
user executing the program.This information could be useful debugging information if the
variable is set on a system with software requiring an executable stack.The logging of
attempts to execute code on the stack can also be disabled, if desired. It should also be noted
that, in some circumstances, it might be possible to bypass this protection.
Another conﬁguration variable that can make a host more resistant to attack is TCP
connection request queue size. Solaris implements two queues for handling TCP trafﬁc: the
connection request queue and the established connection queue.The separation of the two
queues is designed to make a system continuously available to systems that are already con-
nected when a SYN ﬂood occurs while independently handling the deluge of TCP SYN
requests in another. In the event that the DMZ server is ever attacked via a SYN ﬂood, the
second queue may help the system continue to function, keeping established connections
separated and functioning until they are terminated.
The default size of the TCP connection request queue is 1024 connections, although this
can be modiﬁed from a minimum of one connection to a maximum of 4,294,967,296 con-
nections.To modify the parameter, use the following conﬁguration of the ndd(1M) command:
ndd –set /dev/tcp tcp_conn_req_max_q0 <number>
Here, <number> represents the maximum number of requests to keep in the connection
request queue table. It is possible to insert this command into an initialization ﬁle to auto-
matically set this variable in the later stages of system bootstrap.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
135

Another conﬁguration variable worthy of investigation is the KEYBOARD_ABORT
parameter.This variable allows you to disable the keyboard abort key sequence (also known
as Stop-A) from the operating system level. Setting this variable will not prevent a user from
pressing Stop + A during a certain window of the system boot process. However, when the
system has fully booted, this variable will prevent a user from pressing Stop + A to enter the
EEPROM.
To set this variable, follow this procedure: In the /etc/default/kbd ﬁle, use a text editor
to monitor the following parameter:
#KEYBOARD_ABORT=enable
This will reﬂect the following conﬁguration:
KEYBOARD_ABORT=disable
One ﬁnal area of conﬁguration we discuss is that of the OpenBoot parameters.
OpenBoot is the ﬁrmware used in EEPROM of Sun systems. For the most part, OpenBoot
is used only to boot the operating system and to ensure the correct handling of some hard-
ware during boot, but it also has features that can make the system more resistant to attack.
These features are the security mode and the security password.
The security-mode parameter can be set to disable the modifying of OpenBoot parameters
without a password.Additionally, security-mode can be set to prevent the system from being
booted without knowledge of the OpenBoot password.The most ideal conﬁguration is to
use the latter type of conﬁguration, although one must evaluate business requirements before
instituting this change.
To conﬁgure the OpenBoot software to require a password to boot the system, make the
following conﬁguration changes. From the OpenBoot command line, execute the following
command to enable password protection:
setenv security-mode full
This command should be followed with the setting of the OpenBoot password.This can
be done with the following command, issued on the OpenBoot command line:
setenv security-password <newpassword>
Here <newpassword> is representative of the desired password for OpenBoot.
To enable only password protection on EEPROM conﬁguration changes, use the word
command in place of the word full.These parameters can also be manipulated from the com-
mand line using the eeprom command on a running Solaris system. Be careful in applying
this security mode. If you forget the password, you will not be able to modify the
OpenBoot environment, should the system require maintenance.
Now that we have discussed manual hardening techniques, let’s discuss a few of the tools
available to do the job for us.
www.syngress.com
136
Chapter 3 • Sun Solariz DMZ Design

Automated System Hardening
Essentially, automated system hardening involves using a prewritten tool to perform many if
not most of the activities we have just discussed. In the section on auditing ﬁle permissions,
we discussed a few of the more basic tools, including COPS,YASSP, and FixModes. In this
section, we mention a couple more and discuss the use of such tools.
All system hardening tools essentially work the same way.They are downloaded and
placed on the system that is being hardened, they’re unpacked, and if necessary, the source
code is written in whatever language is compiled into an executable. Most require some
conﬁguration information prior to execution, which can come in the form of a ﬂat text ﬁle;
others might prompt the user for this information when the program is executed.
Most of these tools are scripts and are interpreted by some shell such as Bourne Shell,
Korn Shell, or Perl.Tools that require compilation are typically written in C; therefore, a C
compiler such as the GNU C Compiler might be needed. It should be noted that a C com-
piler it not installed with Solaris, and any C compiler installed on Solaris systems should
minimally be installed with restrictive permissions, such as root read/write/execute only.
Let’s look at one such hardening toolkit from Sun.
Solaris Security Toolkit
The SST is the Solaris Security Toolkit, also known as the Jumpstart Architecture Security
Scripts (JASS). It is available from the Sun Blueprints portion of Sun Microsystems and owes
much of its heritage to Alex Noordergraaf, Glenn Burnette, and Keith Watson.You can
download it directly from the Sun Blueprints program.
SST is a highly conﬁgurable, extensive, ﬂexible tool. It can be run as part of a Jumpstart
conﬁguration, where a Solaris system is installed via the network from another Solaris
system, or it can be used in a standalone conﬁguration. It adds other security software to the
system, such as OpenSSH, when used in the recommended conﬁguration.
After you download and install the SST version 4.2 (available at www.sun.com/down-
load/products.xml?id=42e6becd), you need to execute the following command:
# ./jass-execute –h
The command executes the jass script in standalone mode.You may also execute the fol-
lowing command to harden the Solaris server with the speciﬁc driver:
# ./jass-execute –h –d secure.driver
TIP
You can ﬁnd the SST documentation at www.sun.com/products-n-
solutions/hardware/docs/Software/enterprise_computing/systems_management/
sst/index.html. 
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
137

When you execute this script, it performs speciﬁc hardening procedures, including
removing or disabling packages and process. If you face any problems after the hardening pro-
cess, you can reverse the same.To reverse the system changes, execute the following command:
# ./jass-execute –u
WARNING
Needless to say, you should understand these processes thoroughly before you
perform hardening. Ensure that appropriate backups are available for a quick
system restore. Never try these procedures on live production servers. You could
get unexpected results, including an unbootable Solaris server, when the some
critical packages that are required by other applications are removed by either
manual or automatic hardening. It is not recommended to run any other appli-
cation or services on a DMZ or a ﬁrewall server. However, in certain cases (for
example, integrating RSA token-based authentication, which requires some
agent ﬁles be placed directly on the ﬁrewall server), you might have to run
other applications from the ﬁrewall server. Use of appropriate version of Sun
Solaris, Check Point ﬁrewall modules, patches recommended by Check Point,
and patches and ﬁxes released by Sun is recommended. Always do one change
at a time and follow change management procedures. 
When we have completed the hardening process, we still have two issues that should be
addressed.After modiﬁcations to the system are complete, we must install, conﬁgure, and put
into production the host-based intrusion detection system (HIDS).This step should be per-
formed at the very end of the hardening process, since any changes to the system will cause
the system to generate an alert. Once we’ve ﬁnished this step, we should conduct perfor-
mance and stability testing.This can be done with the Sun Validation Test Suite (SunVTS), of
which more information is available at http://docs.sun.com.
For more hardening tips speciﬁc to Check Point installation, refer to
www.checkpoint.com/techsupport/documentation/FW-1_VPN-1_performance.html#solaris.
Designing & Planning…
Host-Based Intrusion Detection System Maintenance
HIDS require periodic maintenance. This is one of the burdens of monitoring the
base of installed software on a system.
www.syngress.com
138
Chapter 3 • Sun Solariz DMZ Design
Continued

You might need to periodically regenerate the checksum database from
which the IDS conducts its checks. This might be required when patches have
been applied to the system, because the checksums of some monitored programs
will likely change. This could also occur in the instance of software installation,
removal, or conﬁguration changes in some ﬁles.
Hardening Checklists 
for DMZ Servers and Solaris
Use this checklist as a starting point when hardening your Solaris DMZ servers:
■
Has a model or diagram of the host been made?
■
Is the host physically secured?
■
Has the host been kept segregated from all networks?
■
Have all the recommended patches been applied?
■
Has increased logging of system activity been implemented?
■
Are data backups secure from physical access?
■
Are data backups secure from being overwritten?
■
Have all remote administration utilities been sufﬁciently secured?
■
Has all unnecessary software been removed?
■
Has the system been hardened manually or by using an automated tool?
■
Have all unnecessary services been disabled?
■
Have all unnecessary processes been disabled?
■
Has host security been layered using:
■
Role-based access control?
■
Granular ﬁle access control lists?
■
Restrictive environments?
■
Have any additional security-enhancing system variables been set?
■
Has the ﬁrewall rule policy been implemented for the host?
■
Has the HIDS been installed?
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
139

Summary
In this chapter, we discussed the use of DMZ servers and Solaris. We began our discussion
with the new features of Sun Solaris 10 followed by details of the placement of DMZ
servers. We examined a Solaris DMZ server implemented as a host directly behind the
router, a host attached to a switch behind the router, and a cluster conﬁguration attached to
a switch behind the router. We came to the conclusion that conﬁguration is only part of the
equation.
In our discussion of ﬁrewall rules, we examined rulesets for both the public and private
networks. We asserted that our private network should deny all trafﬁc except for access to
services required for business needs. Our public network conﬁguration gave us enhanced
security by allowing only trafﬁc to the speciﬁed services required by both internal and
external users.
We shifted our discussion from network use of Solaris as a DMZ system to building a
Solaris DMZ system. We began with a discussion of selecting the right hardware to do the
job and acquiring a minimum of three network interfaces to perform the job. We also dis-
cussed the beneﬁts of using quad Ethernet cards.
Our hardware discussion was followed by an examination of software selection. We
stated the fact that additional software would be required to provide DMZ services with a
Solaris system, and we brieﬂy mentioned two software packages, Check Point FireWall-1 and
IP Filter ﬁrewall.This discussion was followed with another about selecting high-availability
software to keep a DMZ system available at all times. We examined the options of FireWall-
1, Veritas Cluster Server, and Sun Cluster. We advised against the dangerous tendency to
place additional network services on the DMZ server and thus put the integrity of the
server at risk.
Conﬁguration design was the subject of our next discussion, in which we examined sev-
eral of the software conﬁguration factors to consider in building a secure design. We exam-
ined disk layout, with an emphasis placed on creating a maximum amount of space for log
ﬁles. We also looked at increasing log verbosity and the reasons to do so, such as acquiring
legally admissible evidence. Considerations for backup and using media that is append-only
were also noted as desirable.
Regarding conﬁguration design, we also discussed putting the puzzle together by cre-
ating a test implementation of the software.This was done to give us an idea of what to
expect in a default conﬁguration, from which additional design decisions could be made. We
also discussed the importance of using multiple layers of security, including ﬁle access control
lists, RBAC, restricted shells, and restrictive environments.The necessity of auditing and
checking the permissions of programs that execute with privileges and automated programs
such as COPS,YASSP, and FixModes that do this job for us also was outlined.
The discussion of system design ended with building a system model. From our model, we
were able to make decisions about what services we would require, what services and processes
should be disabled, and what security precautions should be taken to protect the host. Our
design created a culmination of all the secure system details we had previously discussed.
www.syngress.com
140
Chapter 3 • Sun Solariz DMZ Design

Implementation was the next topic we examined. Our implementation phase detailed
general guidelines to use to preserve the integrity of a host.This included verifying the
integrity of media using cryptography, ensuring physical security of the host so as not to
allow unauthorized individuals access to the system, and securing the network side of the
host by not connecting it to network resources until the implementation is complete. In
addition, we noted that patch applications should be the ﬁnal part of implementation that
occurs prior to the hardening process.
We ended the chapter with an examination of the hardening process from both the
manual and automated points of view. Of the manual hardening process, we discussed steps
such as the removal of unnecessary software, disabling of unnecessary services and processes,
and manipulation of miscellaneous conﬁguration variables to enhance host security. We
addressed the automated hardening process from the perspective of available tools to perform
the job for us, including ASET and SST. We completed our implementation by installing
host-based intrusion detection software and a performance-testing software package available
for the host.
Solutions Fast Track
Placement of Servers 

DMZ servers should be placed behind network routers.

An ideal DMZ server conﬁguration is placing a switch between the network
router and the DMZ server.

High-availability conﬁgurations require the ability to connect multiple systems to
the same network segments.

High availability (simple Active/Passive conﬁguration) or clustering
(Active/Active) conﬁgurations require proper physical cabling and connectivity.
Firewall Ruleset

The ﬁrewall ruleset is as important as the proper design and conﬁguration of the
networks serviced by the DMZ.

Private networks should prohibit all network trafﬁc by default and permit
outbound access to systems that service business needs, such as Web proxy servers,
mail servers, and domain name servers.

Public networks should provide access to the required services while not allowing
users to deviate connections to reaching unauthorized ports on systems in the
DMZ.
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
141

System Design 

Hardware for the job should be evaluated for its expandability, and the proper
hardware for the job such as quad Ethernet cards should be used.

The proper software for the job, including ﬁrewall and high-availability packages,
should be selected to provide stable, reliable performance with minimal impact in
the case of a server failure.

It is wise to create a test installation of a system to evaluate its default state prior to
implementing the design.

A model should be created of the system design that will serve as a reference
during implementation.
Implementation:The Quick and Dirty Details

The system should be implemented with the express concern of preserving host
integrity.This involves checking media integrity, ensuring physical security of the
host, ensuring network security of the host, and applying the recommended patch
cluster.

The system should be hardened to make it resistant to attacks.This involves either
manually manipulating the operating system to create an attack-resistant
conﬁguration or using an automated tool to do the job.

Host-based intrusion detection software should be installed on the system after
hardening.
Hardening Checklist for DMZ Servers and Solaris

All services not speciﬁcally required for operation of the DMZ server should be
disabled.This involves auditing the inetd.conf ﬁle as well as the initialization script.

All processes not speciﬁcally required for system operation should be disabled.This
limits exposure to potential attack and lightens the load on system resources.

Additional conﬁguration variables that are not mandatory but might be helpful in
providing a more secure conﬁguration should be evaluated.These include
nonexecutable stacks and EEPROM passwords.

Ensure any script that claims to perform automatic hardening has a clear
documentation and reversing procedures.
www.syngress.com
142
Chapter 3 • Sun Solariz DMZ Design

Q: Can multiple DMZ servers exist behind one router?
A: Absolutely. One of the best reasons for putting a switch behind a router is to allow for
growth and distributing of DMZ services to other networks that might be implemented
to distribute the load.
Q: Why should all incoming and outgoing network trafﬁc be prohibited by default on the
private network?
A: The private network typically contains desktop systems, which often have sensitive
information stored on them. Prohibiting trafﬁc into and out of the network prevents the
propagation of some types of worms, such as those that use their own SMTP engines,
and prevents remote access in the event that a desktop system is compromised via a back
door.
Q: Should I implement an IDS or an IPS?
A: Use of IDS in an enterprise network is getting outdated. Consider intrusion prevention
system (IPS) that can offer more security compared to IDS, including application layer
protection and proactive defense in the absence of timely updates and ﬁxes for unknown
attacks.
Q: Why is host security focused on at the design stage rather than at the implementation
stage?
A: Making security the basis of design makes the system implementer less apt to miss details
such as increasing auditing, host-based intrusion detection, and ﬁxing ﬁle permissions.
Acknowledging these requirements early in design and reviewing them before imple-
menting also gives the implementer a chance to plug any holes in design that he or she
notices.
Q: Why is the name server for the private network on the public segment?
www.syngress.com
Sun Solariz DMZ Design • Chapter 3
143
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

A: Some domain name service packages are a double-barrel shotgun of vulnerability. In one
barrel, there is the ammunition of protocol problems in DNS that could lead to it being
exploited to deny service or incorrectly resolve domains for users. In the other barrel,
there are the consistent problems of remotely exploitable vulnerabilities that gain the
attacker access to the host as the name service daemon user; typically root. It is better to
place the server in a location in which, if it is compromised, it can only reach certain
public systems, rather than it having free reign of the private network.
Q: I have securely implemented a test server during the design phase and would like to
implement it into production. Should I do this?
A: If the integrity of the host can be trusted beyond the shadow of a doubt, why not?
Q: I was told never to install a C compiler on a sensitive system, especially one that services
the network. Why is it mentioned in this chapter?
A: The belief that a system is more prone to compromise because a C compiler is installed
on the host is a myth. First, an abundance of cheap SPARC hardware is ﬂoating around
that an attacker could acquire to precompile exploit tools. Second, sufﬁcient access con-
trols on the system will prevent an attacker with regular user privileges from executing
the C compiler.Third and ﬁnally, it is possible to do many if not most of the same
things done with a compiler with interpreters such as Perl.
Q: How important is hardening on a ﬁrewall or a DMZ server?
A: It is essential to optimize the system by running only those services that are required,
therefore increasing the performance and reducing the security risks arising out of com-
monly deployed (but unused) services. Start from minimal packages and add packages to
the server as and when required.
www.syngress.com
144
Chapter 3 • Sun Solariz DMZ Design

Wireless DMZs
Solutions in this chapter:
■
The Need for Wireless DMZs
■
Designing the Wireless DMZ
■
Wireless DMZ Examples 
■
Wireless LAN Security 
Best-Practices Checklist
Chapter 4
145
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
The Internet is in the air. Some cities, such as Philadelphia, have municipal WiFi; many cof-
feehouses such as Starbucks and bookstores such as Barnes and Noble have wireless Internet
services for their clientele. McDonald’s restaurants provide WiFi hotspots with the Wayport
service, and Boingo is another popular WiFi service provider. Wireless networks are every-
where, and their numbers continue to increase every day. If you are curious about the
number of wireless LANs (WLANs) in your neighborhood or around your town, it is a
simple matter to download some wardriving software and drive around with your laptop and
a WiFi network card. If you have never done this, you might be surprised at the number of
wireless access points (APs) that you ﬁnd.You might also be surprised to ﬁnd how many are
wide open, with no encryption and perhaps even the default conﬁguration just as the AP
came out of the box. Of course, this book is geared toward the enterprise, but it is important
to acknowledge the world of WLANs and their various roles in the different areas.
Many people feel as though a WLAN is, by its very nature, insecure.This is not neces-
sarily the case, since many tools are available to help administrators secure their wireless net-
works. Of course, administrators need to understand the risks inherent with running a
network over airwaves, and therefore they must be familiar with the options available for
security.The same tools are available for wired LANs, such as switches, routers, and ﬁrewalls,
and then there are the tools designed to protect the transmissions themselves, such as
WPA/WPA2 encryption and EAP/802.1x authentication. With proper care, administrators
can securely deploy WLANs inside their private networks and safely allow employees to uti-
lize this business critical resource while they are mobile around the ofﬁce. WLANs make it
possible for employees to take their laptops into the break room, conference room, or down
the hall to work with a colleague as well as allowing organizations such as hospitals to have
mobile Internet equipment for doctors and nurses.
Regardless of how you want to implement your WLAN, you need to be familiar with
the tools at your disposal for securing, monitoring, and managing your network. We discuss a
number of these tools throughout this chapter and provide you with some food for thought
on how you can deploy your network.
The Need for Wireless DMZs
Since WLANs can be made secure for the internal, private network, why then should we be
concerned with separating the WLAN into its own DMZ? Well, typically a DMZ is a net-
work designed to give the public access to speciﬁc internal resources, and you might want to
do the same thing for guests visiting your organization without compromising the integrity
of your internal resources. In other words, you might want to have your WLAN open to the
public so that they too can use the Internet while sitting in your lobby, sleeping in your
hotel, or dining in your restaurant.The Internet is so woven into everyday life that patrons to
your organization will look favorably on you if they can come to your location and access
the Internet with ease.
www.syngress.com
146
Chapter 4 • Wireless DMZs

NOTE
You will learn how to conﬁgure and implement a wireless DMZ in Chapter 5. 
It is necessary to understand why it’s important to secure your WLAN.The WLAN is
subject to the same network attacks to which any wired network could be vulnerable.
However, there are some attacks that are speciﬁc to a wireless network that would not be
possible if it weren’t broadcast through the air.These will help clarify why you don’t want to
leave an open access point (a.k.a. a rogue access point) lying around your internal private
network.
In general, attacks on wireless networks fall into four basic categories:
■
Passive attacks
■
Active attacks
■
Man-in-the-middle attacks
■
Jamming attacks
In the next sections, we examine these four categories in some detail to help you get an
idea of what can go wrong with a WLAN.
Passive Attacks on Wireless Networks
A passive attack occurs when someone listens to or eavesdrops on network trafﬁc.Armed
with a wireless network adapter that supports promiscuous mode and the right software, an
eavesdropper can capture network trafﬁc for analysis. When the network interface card
(NIC) is in promiscuous mode, every packet that goes past the interface is captured and dis-
played within the application window. Many tools are available that can sniff the wireless
network, completely unbeknown to the administrator. One of the more common wireless
sniffers is AiroPeek, from WildPackets (www.wildpackets.com).
A passive attack on a wireless network might not be malicious in nature. In fact, many in
the wardriving community claim that their wardriving activities are benign or “educational”
in nature.To function, wireless network cards need to scan and detect wireless networks, so
it’s even possible for someone to be driving around using their laptop and not even be aware
of the fact that their network card is scanning and possibly even connecting to open access
points as they go. Wireless communication takes place on unlicensed public frequencies that
anyone can use.This makes protecting a wireless network from passive attacks more difﬁcult.
However, by its very deﬁnition, a passive attack might not be an attack at all but merely a
reconnaissance mission—information gathering for a future attack.
Of course, the information gathered could be severely limited if you conﬁgure encryp-
tion on your access point.There is certain network information that an attacker could still
obtain, such as a Service Set Identiﬁer (SSID), the channel you’re using, MAC and IP
www.syngress.com
Wireless DMZs • Chapter 4
147

addresses, and the type of encryption and cipher being used, but as long as you are using
WPA/WPA2, the attacker isn’t likely to gain any more information than that without
attempting to crack your encryption key, which is no longer a passive activity.The supposed
“passive attacker” is merely a bystander.The relative “passivity” of the interaction completely
changes when there is criminal intent to either capture or change data on a network the
user is not explicitly authorized to access.
Passive attacks are, by their very nature, difﬁcult to detect. If an administrator is using
Dynamic Host Conﬁguration Protocol (DHCP) on the wireless network, he or she might
notice that an unauthorized Media Access Control (MAC) address has acquired an IP address
in the DHCP server logs.Then again, he or she might not. Perhaps the administrator notices
a suspicious-looking car sporting an antenna out one of its windows.
NOTE
DHCP is not usually recommended on a WLAN because it makes it just that
much easier for an attacker to gain access to your network. The idea is that if
the attacker can get past the rest of your conﬁgured security mechanisms,
having a DHCP lease offered to him or her is just the icing on the cake. It really
makes no difference, however, because they can also determine the network
address space in use by monitoring the management frames and the initial
communications between the client and the AP. Then they can simply choose a
static IP address to use instead. 
If the car is parked on private property, the driver could be asked to move or possibly be
charged with trespassing. However, the legal response may be severely limited, depending on
the laws in your jurisdiction. In comparison, circumstances under which the wardriver is sus-
ceptible to being charged with a data-related crime depend entirely on the country or state
in which the activity takes place.
Passive attacks on wireless networks are extremely common, almost to the point of being
ubiquitous. Detecting and reporting on wireless networks has become a popular hobby for
many wireless wardriving enthusiasts. In fact, this activity is so popular that a new term, war
plugging, has emerged to describe the behavior of people who actually want to advertise both
the availability of their access point (AP) and the services they offer by conﬁguring their
SSIDs with text such as “Get_food_here!”
Wardriving
There are many software packages publicly available for wardriving enthusiasts to choose
from. One popular Windows-based program is NetStumbler. Some other popular programs
that run on multiple operating systems are Kismet and Airsnort. For a list, visit
www.wardrive.net/wardriving/tools. Most wardrivers are young and interested in ﬁnding
www.syngress.com
148
Chapter 4 • Wireless DMZs

free/open WiFi hotspots. Some may be looking for a challenge and want to try to crack
WEP keys or WPA keys.You can easily thwart the casual wardriver simply by following the
best security practices outlined in this chapter.
NOTE
Wardrivers often make their own Yagi-type (tubular or cylindrical) antenna.
Instructions for doing so are easy to ﬁnd on the Internet, and effective antennas
have been made from such items as Pringles potato chip cans. Another type of
antenna that can be easily homemade is the dipole, which is basically a piece of
wire of a length that’s a multiple of the wavelength, cut in the center and
attached to a piece of cable that is connected to the wireless NIC.
Notes from the Underground…
Tools for Cracking WEP
Several software programs are readily available for cracking WEP by passively
monitoring network transmissions. With one of these tools, it could take just 10
minutes of eavesdropping on a busy network to capture enough data to com-
pute and recover WEP keys.
Aircrack/Aircrack-ng
AirSnort
WEPCrack
WEPlab
KisMAC
WPA may be cracked as well if you have it conﬁgured with a passphrase only
and that passphrase is susceptible to a brute-force attack. Therefore, it is recom-
mended that you use the WPA-Enterprise with server certiﬁcates and authentication.
Snifﬁng
Originally conceived as a legitimate network and trafﬁc analysis tool, snifﬁng remains one of
the most effective techniques in attacking a wireless network, whether it’s to map the net-
work as part of a target reconnaissance, to grab passwords, or to capture unencrypted data.
www.syngress.com
Wireless DMZs • Chapter 4
149

Snifﬁng is the electronic form of eavesdropping on the communications that computers
transmit across networks. In early networks, the equipment that connected machines allowed
every machine on the network to see the trafﬁc of all others.These devices, repeaters and
hubs, were very successful at getting machines connected, but they allowed an attacker easy
access to all trafﬁc on the network because the attacker only needed to connect to one point
to see the entire network’s trafﬁc.
Wireless networks function very similarly to the original repeaters and hubs. Every com-
munication across the wireless network is viewable to anyone who happens to be listening to
the network. In fact, the person who is listening does not even need to be associated with
the network in order to sniff!
The hacker has many tools available to attack and monitor a wireless network.A few of
these tools are AiroPeek for Windows, Ethereal (www.ethereal.com) for Windows, UNIX or
Linux and TCPDump or ngrep (http://ngrep.sourceforg.net) in a UNIX or Linux environ-
ment.These tools work well for snifﬁng both wired and wireless networks.
Active Attacks on Wireless Networks
Once an attacker has gained sufﬁcient information from the passive attack, he or she can
then launch an active attack against the network.There are potentially a large number of
active attacks that a hacker can launch against an open wireless network. For the most part,
these attacks are identical to the kinds of active attacks that are encountered on wired net-
works.These include, but are not limited to, unauthorized access, spooﬁng, DoS, and
ﬂooding attacks as well as the introduction of malware (malicious software) and the theft of
devices.
With the rise in popularity of wireless networks, new variations of traditional attacks
speciﬁc to wireless networks have emerged, along with speciﬁc terms to describe them, such
as drive-by spamming, in which a spammer sends out tens or hundreds of thousands of spam
messages using a compromised wireless network.
Due to the nature of wireless networks and the weaknesses of WEP, unauthorized access
and spooﬁng are the most common threats to wireless networks that use this insecure encryp-
tion method. Spooﬁng occurs when an attacker is able to use an unauthorized station to
impersonate an authorized station on a wireless network. MAC addresses are sent in the clear
on wireless networks, so it is also a relatively easy matter to discover authorized addresses if
someone has implemented MAC ﬁltering. It is also very simple to change the MAC address
associated with your network card via the Windows registry or a Unix command.
Once the attacker has authenticated and associated with the wireless network, he or she
can then run port scans, use special tools to dump user lists and passwords, impersonate users,
connect to shares, and, in general, create havoc on the network through DoS and ﬂooding
attacks.These DoS attacks can be traditional in nature, such as a ping ﬂood, SYN, fragment, or
DDoS attacks, or they can be speciﬁc to wireless networks through the placement and use of
rogue access points to prevent wireless trafﬁc from being forwarded properly (similar to the
practice of router spooﬁng on wired networks).
www.syngress.com
150
Chapter 4 • Wireless DMZs

Spooﬁng (Interception) and Unauthorized Access
One deﬁnition of spooﬁng is an attacker’s ability to trick the network equipment into
thinking that the address from which a connection is coming is one of the valid and allowed
machines from its network.There are several reasons that an attacker would spoof. If the net-
work allows only valid interfaces through MAC or IP address ﬁltering, an attacker would
need to determine a valid MAC or IP address to be able to communicate on the network.
Once that is accomplished, the attacker could then reprogram his interface with that infor-
mation, allowing him to connect to the network by impersonating a valid machine.
IEEE 802.11 networks introduce a new form of spooﬁng: authentication spooﬁng.As
described in their paper, Intercepting Mobile Communications:The Insecurities of 802.11, authors
Borisov, Goldberg, and Wagner identiﬁed a way to utilize weaknesses within WEP and the
authentication process to spoof authentication into a closed network.The process of authen-
tication, as deﬁned by IEEE 802.11, is very simple. In a shared-key conﬁguration, the AP
sends out a 128-byte random string in a cleartext message to the workstation that is
attempting to authenticate.The workstation then encrypts the message with the shared key
and returns the encrypted message to the AP. If the message matches what the AP is
expecting, the workstation is authenticated onto the network and access is allowed.
As described in the paper, if an attacker has knowledge of both the original plaintext
and ciphertext messages, it is possible to create a forged encrypted message. By snifﬁng the
wireless network, an attacker is able to accumulate many authentication requests, each of
which includes the original plaintext message and the returned ciphertext-encrypted reply.
From this, the attacker can easily identify the keystream used to encrypt the response mes-
sage.The attacker could then use it to forge an authentication message that the AP will
accept as a proper authentication.
The ability to forge authentication onto a wireless network is a complex process. No
off-the-shelf packages that provide these services are available.Attackers need to either create
their own tools or take the time to use AirSnort or WEPCrack to decrypt the secret key.
Denial of Service and Flooding Attacks
The nature of wireless transmission, especially the use of spread-spectrum technology, makes
a wireless network especially vulnerable to DoS attacks.The equipment needed to launch
such an attack is freely available and very affordable. In fact, many homes and ofﬁces contain
the equipment that is necessary to deny service to their wireless networks.
A DoS occurs when an attacker has engaged most of the resources a host or network
has available, rendering that host or network unavailable to legitimate users. One of the orig-
inal DoS attacks is known as a ping ﬂood.A ping ﬂood utilizes misconﬁgured equipment
along with bad “features” within IP to cause a large number of hosts or devices to send an
ICMP echo (ping) to a speciﬁed target. When the attack occurs, it tends to use a large por-
tion of the resources of both the network connection and the host being attacked.This
makes it very difﬁcult for valid end users to access the host for normal business purposes.
www.syngress.com
Wireless DMZs • Chapter 4
151

In a wireless network, several events can cause a similar disruption of service. Probably
the easiest way to trigger such an event is through a conﬂict within the wireless spectrum,
caused by different devices attempting to use the same frequency. Many new wireless tele-
phones use the same frequency as 802.11 networks.Through either intentional or uninten-
tional uses of another device that uses the 2.4GHz frequency, a simple telephone call could
prevent all wireless users from accessing the network.
Another possible attack would be through a massive number of invalid (or valid) authen-
tication requests. If the AP is tied up with thousands of spoofed authentication attempts,
authorized users attempting to authenticate themselves would have major difﬁculties in
acquiring a valid session.
As demonstrated earlier, the attacker has many tools for hijacking network connections.
If a hacker is able to spoof the machines of a wireless network into thinking that the
attacker’s machine is their default gateway, not only will the attacker be able to intercept all
trafﬁc destined for the wired network—he would also be able to prevent any of the wireless
network machines from accessing the wired network.To do this, the hacker needs only to
spoof the AP and not forward connections to the end destination, preventing all wireless
users from performing valid wireless activities.
Not much effort is needed to create a wireless DoS. In fact, many users create these situ-
ations with the equipment found within their homes or ofﬁces. In a small apartment
building, you could ﬁnd several APs as well as many wireless telephones, all of which
transmit on the same frequency. It would be easy for these users to inadvertently create DoS
attacks on their own networks as well as on those of their neighbors.
A hacker who wants to launch a DoS attack against a network with a ﬂood of authenti-
cation strings will in most cases not even need to be a highly skilled programmer. Many
tools are available to create this type of attack, so even the most unskilled of black hats, the
script kiddie, can launch one with little or no knowledge of how it works or why.
Many apartments and older ofﬁce buildings do not come prewired for the high-tech
networks in use today.To add to the problem, if many individuals are setting up their own
wireless networks without coordinating the installations, many problems can occur that will
be difﬁcult to detect. For instance, only a limited number of frequencies are available to
802.11 networks. Considering these problems, it is not hard to imagine the following situa-
tion occurring.
Let’s say that a person purchases a wireless AP and several network cards for his home
network. When he gets home to his apartment and conﬁgures his network, he is extremely
happy with how well wireless networking actually works.Then, suddenly, none of the
machines on the wireless network are able to communicate. He phones the tech support line
of the vendor that made the device.After waiting on hold for 45 minutes, he ﬁnds that his
network has magically started working again, so he hangs up.
Later that week, the same problem occurs, except that this time he decides to wait on
hold when he phones the vendor. While waiting, he goes onto his porch and begins dis-
cussing his frustration with his neighbor. During the conversation, his neighbor’s kids come
out and say that their wireless network is not working.
www.syngress.com
152
Chapter 4 • Wireless DMZs

So they begin to do a few tests (while still waiting on hold, of course). First, the man’s
neighbor turns off his AP (which is usually off unless the kids are online, to “protect” their
network). When this is done, the original person’s wireless network starts working again.
Then they turn on the neighbor’s AP again and the ﬁrst man’s network stops working again.
At this point, a tech support rep ﬁnally answers, and the caller describes what has hap-
pened.The tech support representative has seen this situation several times and informs the
user that he will need to change the frequency used in the device to another channel. He
explains that the neighbor’s network is utilizing the same channel, causing the two networks
to conﬂict. Once the caller changes the frequency, everything starts working properly.
Man-in-the-Middle 
Attacks on Wireless Networks
Placing a rogue AP within range of wireless stations is a wireless-speciﬁc variation of a man-
in-the-middle (MITM) attack. If the attacker knows the SSID the network is using (which,
as we have seen, is easily discoverable) and the rogue AP has enough strength, wireless users
might have no way of knowing that they are attempting to connect to an unauthorized AP.
Using a rogue AP, an attacker can gain valuable information about the wireless network,
such as authentication requests, the secret key that is in use, and so on. Often, the attacker
will set up a laptop with two wireless adapters, in which one card is used by the rogue AP
and the other is used to forward requests through a wireless bridge to the legitimate AP.
With a sufﬁciently strong antenna, the rogue AP does not have to be located in close prox-
imity to the legitimate AP.
For example, the attacker can run the rogue AP from a car or van parked some distance
away from the building. However, it is also common to set up hidden rogue APs (under
desks, in closets, or the like) close to and within the same physical area as the legitimate AP.
Because of their virtually undetectable nature, the only defense against rogue APs is vigilance
through frequent site surveys (using tools such as AirDefense,AirWave, WaveLink and Cisco’s
SWAN), visual site inspections, and physical security.
Frequent site surveys also have the advantage of uncovering the unauthorized APs that
company staff members might have set up in their own work areas, thereby compromising
the entire network and completely undoing the hard work that went into securing the net-
work in the ﬁrst place.This is usually done with no malicious intent but for the convenience
of the user, who might want to be able to connect to the network via his or her laptop in
meeting rooms, break rooms, or other areas that don’t have wired outlets. Even if your com-
pany does not use or plan to use a wireless network, you should consider doing regular wire-
less site surveys to see if someone has violated your company security policy by placing an
unauthorized AP on the network, regardless of their intent.
Network Hijacking and Modiﬁcation
Numerous techniques are available for an attacker to “hijack” a wireless network or session
once they are associated with an AP. However, unlike some attacks, network and security
www.syngress.com
Wireless DMZs • Chapter 4
153

administrators might be unable to tell the difference between the hijacker and a legitimate
“passenger.”
Many tools are available to the network hijacker.These tools are based on basic imple-
mentation issues within almost every network device available today.As TCP/IP trafﬁc goes
through switches, routers, and APs, each device looks at the destination IP address and com-
pares it with the IP addresses it knows to be local. If the address is not in the table, the
device hands the packet off to its default gateway.
This table is used to coordinate the IP address with the MAC addresses that are known
to be local to the device. In many situations, this list is a dynamic one that is built up from
trafﬁc that is passing through the device and through Address Resolution Protocol (ARP)
notiﬁcations from new devices joining the network.There is no authentication or veriﬁca-
tion that the request received by the device is valid.Thus a malicious user is able to send
messages to routing devices and APs stating that his MAC address is associated with a known
IP address. From then on, all trafﬁc that goes through that router destined for the hijacked IP
address will be handed off to the hacker’s machine.
If the attacker spoofs as the default gateway or a speciﬁc host on the network, all
machines trying to get to the network or the spoofed machine will connect to the attacker’s
machine instead of the gateway or host to which they intended to connect. If the attacker is
clever, he will only use this machine to identify passwords and other necessary information,
and he’ll route the rest of the trafﬁc to the intended recipients. If he does this, the end users
will have no idea that this “man in the middle” has intercepted their communications and
compromised their passwords and information.
Another clever attack can be accomplished through the use of rogue APs. If the attacker
is able to put together an AP with enough strength, the end users might not be able to tell
which AP is the authorized one that they should be using. In fact, most will not even know
that another is available. Using this technique, the attacker is able to receive authentication
requests and information from the end workstation regarding the secret key and where they
are attempting to connect.
These rogue APs can also be used to attempt to break into a WEP-conﬁgured wireless
AP. Utilizing tools such as AirSnort and WEPCrack requires a large amount of data to
decrypt the secret key.A hacker sitting in a car in front of your house or ofﬁce is noticeable
and thus will generally not have enough time to ﬁnish acquiring sufﬁcient information to
break the key. However, if the attacker installs a tiny, easily hidden machine in an inconspic-
uous location, this machine could sit there long enough to break the key and possibly act as
an external AP into the wireless network it has hacked.
Attackers who want to spoof more than their MAC addresses have several tools available.
Most of these tools are for use in a UNIX environment and can be found through a simple
search for ARP spoof at http://packetstormsecurity.org. With these tools, the hacker can
easily trick all machines on the wireless network into thinking that the hacker’s machine is
another machine on the network.Through simple snifﬁng on the network, an attacker can
determine which machines are in high use by the workstations on the network. If the
attacker then spoofs the address of one of these machines, the attacker might be able to
intercept much of the legitimate trafﬁc on the network.
www.syngress.com
154
Chapter 4 • Wireless DMZs

AirSnort and WEPCrack are freely available. It would take additional resources to build
a rogue AP, but these tools will run from any Linux machine. Once an attacker has identiﬁed
a network for attack and has become a valid member of the network, he or she can gain fur-
ther information that is not available through simple snifﬁng.
By simply ARP spooﬁng the connection with the AP to be that of the host from which
he or she wants to steal the passwords, the attacker can cause all wireless users who are
attempting to SSH into the host to connect to the rogue machine instead. When these users
attempt to sign on with their passwords, the attacker is then able to, ﬁrst, receive their pass-
words, and second, pass on the connection to the real end destination. If the attacker does
not perform the second step, it will increase the likelihood that the attack will be noticed,
because users will begin to complain that they are unable to connect to the host.
Jamming Attacks
The last type of attack is the jamming attack.This is a fairly simple attack to pull off and
can be done using readily available, off-the-shelf radio frequency (RF) testing tools
(although they were not necessarily designed to perform this function). Whereas hackers
who want to get information from your network would use other passive and active
types of attacks to accomplish their goals, attackers who just want to disrupt your net-
work communications or even shut down a wireless network can jam you without ever
being seen.The process of jamming a wireless LAN is similar in many ways to the way a
DoS attack would target a network; the difference is that in the case of the wireless net-
work, the attack can be carried out by one person with an overpowering RF signal.This
attack can be carried out using any number of products, but the easiest way is with a
high-powered RF signal generator, readily available from various vendors.
A jamming attack is sometimes the most difﬁcult type of attack to prevent, because the
attacker does not need to gain access to your network. He or she can sit in your parking lot
or even further away, depending on the power output of their jamming device.You might be
able to readily determine the fact that you are being jammed, but you could ﬁnd yourself
hard-pressed to solve the problem. Indications of a jamming attack include clients’ sudden
inability to connect to APs where there was previously no problem.
The problem will be evident across all or most of your clients (the ones within the range
of the RF jamming device), even though your APs are operating properly. Jamming attacks are
sometimes used as the prelude to further attacks. One possible example includes jamming the
wireless network, thereby forcing clients to lose their connections with authorized APs. In this
time, one or more rogue APs can be made available operating at a higher power than the
authorized APs. In some cases RF jamming is not always intentional and could be the result of
other, nonhostile sources, such as a nearby communications tower or another WLAN that is
operating in the same frequency range. Baby monitors, cordless telephones, microwave ovens,
and many other consumer products can also be sources of interference.
You can take some comfort in knowing that although a jamming attack is easy and
inexpensive to pull off, it is not the preferred means of attack. For most hackers, the only real
victory with a jamming attack is temporarily taking your wireless network ofﬂine.
www.syngress.com
Wireless DMZs • Chapter 4
155

Designing the Wireless DMZ
You’ve decided that you want to provide a public WiFi network. What do you need to
accomplish this goal? If you want to provide Internet access to guests, you might need just
an access point (AP) and an Internet router. If you want the wireless DMZ to share the
same Internet connection with the rest of your organization, however, you might want to
install a ﬁrewall or tie them into a new network interface of an existing ﬁrewall.An IDP
device and a bandwidth management solution is also a good idea, to ensure that the wireless
network is not capable of bringing down your Internet connection. If you need to secure
the wireless DMZ, you will also need an authentication server.
Placement of Wireless Equipment
Whether you are putting in one wireless access point (WAP) or covering a large campus,
you need to be aware of the limitations of the 2.4GHz frequencies.A wall can block your
signal or interference from other 2.4GHz devices, such as cordless phones and microwaves,
or other access points might cause too much noise and effectively cancel out your signal. If
you are more concerned about ensuring that others cannot attempt to snoop or hijack your
WLAN, you might want to consider attempting to block the frequency with electromag-
netic shielding.Therefore, where you place wireless equipment will depend on your require-
ments and the area you want to be available for your WLAN.You might want to conduct a
site survey to determine the proper number of access points you need based on the expected
number of users and your speciﬁc environment.
Access to DMZ Services
The process of conﬁguring access to DMZ services is the same whether you are using a
WLAN or a wired network.You should have a ﬁrewall in place, or at least a router with
access control lists (ACLs), to monitor and control connections in the DMZ.
Authentication Considerations
When choosing authentication methods for your WLAN, you must ﬁrst evaluate the secu-
rity level you want to achieve and the hardware that you have at your disposal. Some older
network cards and access points might not support the new WPA2 standard. If you want to
deploy a wireless network as an open access point, you would not consider authentication. If,
however, you need to provide a high level of security on your wireless LAN, you will want
to ensure that you can support the latest authentication and encryption standard WPA2-
Enterprise and utilize client-side certiﬁcates with smartcards, to have maximum security. If
you fall somewhere in the middle, you have a number of options that are deﬁnitely secure
enough for the typical network.
www.syngress.com
156
Chapter 4 • Wireless DMZs

WEP
WEP is the basic security encryption mechanism that was provided in the original 802.11b
speciﬁcation from the Institute of Electrical and Electronics Engineers (IEEE). It is based on
the RC4 stream cipher and is available in 64-bit and 128-bit implementations. WEP is
weakened by the use of a 24-bit initialization vector (IV) that is reused in a short period of
time, thus rendering WEP vulnerable to attack by several readily available cracking tools. In
late 2002 the Wi-Fi alliance changed the requirements for becoming Wi-Fi certiﬁed to
include Wi-Fi Protected Access (WPA).
EAP and 802.1x
Extensible Authentication Protocol (EAP) is deﬁned in RFC 3748
(www.ietf.org/rfc/rfc3748.txt) as an authentication framework that supports multiple
authentication methods. EAP is most commonly used with either Point-to-Point (PPP) or
IEEE 802, where IP layer connectivity might not be available. WPA and WPA2 use EAP as
the basis for their authentication mechanism. EAP can be used in either an enterprise mode,
which utilizes a central authentication server (such as RADIUS), or a simpliﬁed mode using
a preshared key.
802.1x is a subset of EAP that is deﬁned as port-based authentication; it plays a major
role in the IEEE 802.11i standard. Prior to authentication, only uncontrolled “ports” are
open on the AP, in which only EAP trafﬁc is allowed. Once a network client is authenti-
cated, a controlled “port” is open and the client can access additional network resources.
EAP Authentication Methods
There are over 40 EAP methods to choose from, but here we will only talk about four of
the best methods available to securely authenticate your users.
EAP-TLS
Transport Layer Security (TLS) is the most widely supported EAP method and was the ﬁrst
to be certiﬁed by the Wi-Fi alliance. EAP-TLS requires the use of a client-side certiﬁcate,
which also makes it the most secure method available.
EAP-FAST
Flexible Authentication via Secure Tunneling (FAST) was developed by Cisco Systems to ﬁx
the weaknesses of Lightweight Extensible Authentication Protocol (LEAP). EAP-FAST uses
something called a Protected Access Credential (PAC), which can be entered manually or
dynamically in the ﬁrst of three phases.A server certiﬁcate is optional but is recommended
to increase security.
www.syngress.com
Wireless DMZs • Chapter 4
157

EAP-TTLS
EAP-Tunneled TLS (TTLS) offers good security through the use of Public Key
Infrastructure (PKI) certiﬁcates on the server.This method of EAP is widely supported
across platforms.
PEAPv0/PEAPv1
PEAPv0/EAP-MSCHAPv2 combines Protected EAP and Microsoft Challenge Handshake
Authentication Protocol. It is the most common method of PEAP in use and is supported
by Microsoft, Cisco, and other vendors and open source channels. PEAPv1/EAP-GTC, sup-
ported by Cisco, was designed to be an alternative to PEAPv0 and allowed the use of an
inner authentication protocol other than Microsoft’s MSCHAPv2.
WPA/WPA2
Wi-Fi Protected Access (WPA) came about in 2002 and was designed to be an intermediary,
forward-compatible subset of standards based on 802.11i, which was in development by the
IEEE. WPA uses a 48-bit IV and takes 802.1x authentication and EAP from the 802.11i
standard and combines them with TKIP (pronounced “tee-kip”). TKIP resolves security
issues found in WEP by providing per-packet key mixing, a message integrity check (MIC)
called Michael, and a rekeying mechanism such that existing hardware could be utilized. In
short,TKIP replaces WEP without requiring hardware replacement. WPA2 implements the
full IEEE 802.11i standard (ratiﬁed in June 2004), but it might not work with some older
network cards.The main difference between WPA and WPA2 is that the Michael algorithm
was replaced by a message authentication code, Counter Mode with Cipher Block Chaining
Message Authentication Code Protocol (CCMP), that is considered fully secure, and RC4
was replaced by AES. Microsoft Windows XP fully supported WPA2 as of May 2005. Driver
upgrades for network cards may be required as well.
Companies deploying wireless networks with WPA/WPA2 should use the enterprise
model with an 802.1x authentication server; however, there is a less secure Pre-Shared Key
(PSK) method, which is much like WEP in that each user is given the same passphrase.
Although WPA-PSK is less secure than WPA-Enterprise, it is still more secure than WEP
alone. If a passphrase is used, the more characters (up to 63) used and the more random, the
better the security protecting against brute-force attacks.
Wireless DMZ Components 
Now it’s time to discuss the physical components of your wireless DMZ, such as access
points, network adapters, authentication servers, and wireless gateways. Figure 4.1 depicts a
standard DMZ arrangement in which the ﬁrewall provides three interfaces: public, private,
and DMZ.
www.syngress.com
158
Chapter 4 • Wireless DMZs

Figure 4.1 One Example of a Typical DMZ Arrangement
Access Points
In simple terms, an AP is a Layer 2 device that serves as an interface between the wireless
network and the wired network.APs are the wireless networking equivalent of a standard
Ethernet hub in that they allow multiple clients using the same network technology to
access the core network, with a shared amount of bandwidth available to all clients. What
sets the AP apart from its less advanced hub brethren is its ability to carry out many other
additional functions—functions that will become important to creating your complete solu-
tion. Of course, it’s no surprise that an AP is one of two items that forms the backbone of
the WLAN. When it comes to choosing an AP, however, you have a multitude of choices,
each presenting different beneﬁts and costs.The AP you choose should be complementary to
the wireless network adapter you choose—meaning that if you opt for a more powerful and
advanced AP, you should consider acquiring and using network adapters that can take advan-
tage of the often vendor-speciﬁc features provided in the AP.
Network Adapters
The second piece of the puzzle is the network adapter.This, again, should be no big surprise,
since you require the proper wireless network adapter to make the connection to begin
with.As with the AP, the type of network adapter you choose will determine the types of
security solution you can implement.
For example, let’s suppose that you decided to use a Cisco Aironet AP with Cisco’s Aironet
802.11a/b/g Wireless CardBus network adapters and the Cisco Aironet Desktop Utility soft-
ware on the client computers. Using this arrangement, you could increase your security by
taking advantage of EAP-Flexible Authentication via Secure Tunneling (EAP-FAST), Cisco
LEAP, EAP-Transport Layer Security (EAP-TLS), Protected Extensible Authentication
Protocol-Generic Token Card (PEAP-GTC), or PEAP-Microsoft Challenge Handshake
Authentication Protocol version 2 (PEAP-MSCHAPv2). In Chapter 5, we examine how this
combination of hardware and solutions can be used to provide increased security.
www.syngress.com
Wireless DMZs • Chapter 4
159
Public Network Segment
Private Network Segment
Firewall
Screening
Router
Internet
Clients

Authentication Servers
Authentication servers tie in with the wireless DMZ solution by enabling the AP to authen-
ticate clients that want to legitimately access the network.A Remote Authentication Dial-in
User Service (RADIUS) server could be used to verify the identity of the wireless client
that’s attempting to connect. When a user ﬁrst attempts to connect to an AP conﬁgured to
use EAP, the AP hands the authorization over to the authentication server.After successful
authentication, the AP opens the port and grants access to the client.
An authentication server can also participate in the 802.11i key management functions.
After authenticating a client, the server then provides a unique master key to the client.
From this key, a new key is generated and provided to the access point. From there, four
more keys are generated, including the Temporal Key 1 and 2 (TK1/TK2), which will be the
keys used to encrypt the communications.
Windows Authentication
Microsoft provides an Internet Authentication Service (IAS) server with RADIUS and proxy
capabilities to centralize AAA for many types of network access, including wireless connec-
tions in Windows Server 2003.The authentication protocols IAS supports for use with wire-
less networks are:
■
Extensible Authentication Protocol-Message Digest 5 CHAP (EAP-MD5 CHAP)
■
EAP-Transport Layer Security (EAP-TLS)
■
Protected EAP-MS-CHAP v2 (PEAPv0/EAP-MSCHAPv2)
RADIUS
Remote Authentication Dial-in User Service (RADIUS) servers provide network users
what’s known as AAA: authentication, authorization, and accounting. In short, RADIUS
servers are used on the back end of the network to provide a ﬂexible and scalable system to
authenticate users attempting to access network services. Originally developed for dial-in
access using modems, RADIUS has proven ﬂexible and powerful enough to handle authen-
tication of users through various other connection means, including those attempting to
make wireless connections to your network.
When RADIUS servers are combined with 802.1x port-based access control on APs,
users are effectively prevented from accessing the network past the AP until they have been
authorized against the RADIUS database. EAP-FAST, for example, takes advantage of 802.1x
port-based access controls to further increase the security of the wireless and wired network.
The RADIUS server performs the critical task of verifying that the user is authorized to
gain access to the network through either an internal (native) database or by using the
domain database (Active Directory).
www.syngress.com
160
Chapter 4 • Wireless DMZs

NOTE
RADIUS is deﬁned in RFC 2865. The behavior of RADIUS with EAP authentication
is deﬁned in RFC 2869. RFC can be searched and viewed online at www.rfc-
editor.org. 802.1x is deﬁned by the IEEE in the document located at http://stan-
dards.ieee.org/getieee802/download/802.1X-2001.pdf.
Enterprise Wireless Gateways and Wireless
Gateways
Driven by the uniquely special needs presented by WLANs and their security, the enterprise
wireless gateway (EWG) was created to provide enhanced security and management.An
EWG is a specially designed and built hardware device that performs several key functions in
one unit:
■
Router EWGs have at least two Ethernet interfaces, one for the wireless segment
and at least one for the wired segment. Many also offer additional failover inter-
faces for the wired segment.An EWG can also make certain that packets traversing
the network destined for other subnets get to their intended source.
■
Firewall Many of the EWGs currently on the market offer ﬁrewall-like services
by providing stateful inspection of all trafﬁc passing through them.
■
VPN server Most EWGs typically provide VPN support, allowing clients to
create VPN connections to the EWG (and thus the wired segment).They support
IPSec, L2TP, and PPTP as well as  authentication for larger implementation.
The EWG is placed between the AP segment and the wired segment to control net-
work access from the WLAN, as discussed in the next section. One example of an EWG is
Bluesocket’s WG-2000 Wireless Gateway, which is available with both copper or ﬁber
gigabit interface cards and encrypted throughput between 150Mbps and 200Mbps.
Firewalls and Screening Routers
Firewalls and screening routers can still play a role in creating and implementing the WLAN
DMZ.They provide the same protection and support that they would in a strictly wired net-
work but are not enough by themselves to account for the various security concerns associ-
ated with the WLAN.This is due to the fact that ﬁrewalls and screening routers are devices
primarily used for trafﬁc ﬁltering via user authentication. When used together with a well-
crafted WLAN DMZ security solution, they still have a useful purpose. Cisco, Check Point,
Netscreen, and ISA Server are all covered in later chapters of this book.
www.syngress.com
Wireless DMZs • Chapter 4
161

Other Segmentation Devices
Although not discussed here, there are several other segmentation devices that you should be
aware of for use in controlling both trafﬁc and access to your network.This list is presented
here in the interests of making our discussion more complete.All these devices (and many
more) can be used to segment portions of your network:
■
SSH2 servers
■
VPN servers
■
Virtual LANs (VLANs)
■
Layer 3 switches
Wireless DMZ Examples 
Armed with a brief introduction to the pieces that make up the wireless DMZ, let’s examine
a few different scenarios that you could implement for your network.
Figure 4.2 shows an example arrangement that you could use to provide RADIUS
authentication for wireless clients attempting to gain access to your network. In this
example, both the wireless network adapter and the AP are Cisco products that support the
use of WPA2.The process by which the client gains access to the network is outlined brieﬂy
here and explained in signiﬁcantly more detail in Chapter 5:
1.
The client computer requests to associate with the AP.
2.
The AP, using 802.1x port access controls, blocks all access to the wired network
segment.
3.
The user performs EAP-FAST authentication to the RADIUS server using the
required credentials.This process involves the RADIUS server and the client per-
forming mutual authentication.After this is done, the RADIUS server dynamically
generates a master key that will be used by the AP to generate the keys that will
secure the connection.
4.
The RADIUS server then delivers this dynamic key to the AP, which then gener-
ates four new keys with the client.
5.
The client and the AP use the WPA2 keys to securely communicate, and the client
is now associated with the AP. If required, a DHCP lease will be granted to the
wireless client.
6.
The client now securely accesses resources on the wired segment of the network.
www.syngress.com
162
Chapter 4 • Wireless DMZs

Figure 4.2 Using RADIUS to Authenticate Users
Figure 4.3 shows an example of how you might use a simple wireless gateway such as
Bluesocket’s WG-2000 to provide authentication and security through an IPSec VPN
tunnel, if required. In this scenario, the wireless clients authenticate against the internal
database of the WG-200 server, creating a VPN tunnel, if desired.
1.
The client computer associates with the AP.
2.
The wireless gateway (WG-2000) blocks access to the wired network pending suc-
cessful user authentication against its internal database.
3.
The user authenticates to the WG-2000 server.
4.
If required, a DHCP lease will be granted to the wireless client.
5.
If desired, a VPN tunnel is constructed to secure trafﬁc.
6.
The client now accesses resources on the wired segment of the network.
Figure 4.3 Using a Simple Wireless Gateway to Authenticate Users
Figure 4.4 shows an overview of the way you might implement an EWG on your net-
work, to provide security for the wireless segment. In this scenario, the wireless clients
www.syngress.com
Wireless DMZs • Chapter 4
163
Wireless
client
Switch
Access
Point
EAP-FAST authentication
Dynamic unicast key
delivered to the AP
Dynamic unicast and
broadcast keys
delivered to client
Private Network Segment
RADIUS
Server
Wireless
client
Switch
Access
Point
WG-2000
Private Network Segment
 IPSec VPN
Tunnel
User authentication
against internal database

authenticate against a RADIUS server with the added beneﬁt of a VPN tunnel being con-
structed by the EWG to further secure the trafﬁc.
1.
The client computer associates with the AP.
2.
The client computer creates a VPN tunnel with the EWG.
3.
The user performs authentication to the RADIUS server using the required cre-
dentials.The EWG acts as an authenticator (a go-between for the client and the
RADIUS server).
4.
The RADIUS server and the client authenticate per the VPN protocol being
used.
5.
If required, a DHCP lease will be granted to the wireless client.
6.
A VPN tunnel is constructed between the client and the EWG in which to
securely pass trafﬁc.
7.
The client now securely accesses resources on the wired segment of the network.
Figure 4.4 Using an Enterprise Wireless Gateway to Control Access
By now, you might be thinking that none of these solutions looks anything like a DMZ.
That might be true, but appearances can be deceiving. Remember that the purpose of the
DMZ is to keep unwanted (and potentially unsafe) trafﬁc out of the protected internal net-
work.All these solutions offer this capability by controlling access to your wireless network.
www.syngress.com
164
Chapter 4 • Wireless DMZs
Wireless
client
Access
Point
Switch
EWG
Switch
Private Network Segment
VPN
Tunnel
RADIUS
authentication
(on behalf of the client)
RADIUS
Server

Wireless LAN Security 
Best-Practices Checklist 
Although the primary focus here is the implementation of DMZ conﬁgurations, you can
implement several other “best practices” to further increase the security of your WLAN design.
In recent months, the practice of implementing wireless networks has become somewhat rou-
tine to many administrators. Unfortunately, there is nothing routine about any network design
and implementation.Administrators who want to implement wireless networks should exercise
due care and diligence by becoming as familiar as possible with operation and vulnerabilities of
wireless networks and all the available counter-measures for defending them.
Even though many currently implemented wireless networks support a wide range of fea-
tures that can potentially be enabled, the sad fact is that most administrators do not use them.
The media is full of reports of the informal results of site surveys conducted by wardrivers.
These reports provide worrisome information—for example, that most wireless networks are
not using encryption and that many wireless networks are using default SSIDs, not to mention
the advanced DMZ and VPN solutions we have brieﬂy outlined here. Many of these networks
are located in technology-rich areas, such as Silicon Valley, where you would think people
would know better, making the information a source of serious concern.
There is really no excuse for failing to implement security features that are available on
most wireless networks to minimize security threats.The following checklist is a summary of
common best practices that could be employed on many current or future wireless networks:
■
Perform a risk analysis of your network.
■
Develop relevant and comprehensive security policies and implement them
throughout your network.
■
Carefully review the available security features of wireless devices to see if they ful-
ﬁll your security requirements.The 802.11 and Wi-Fi standards specify only a
subset of features that are available on a wide range of devices. Over and above
these standards, supported features vary widely; this is where the DMZ or the
VPN comes into play.
■
Wireless vendors are continually addressing the security weaknesses of wireless net-
works. Check the wireless vendors’ Web sites frequently for ﬁrmware updates and
apply them to all wireless devices.You could leave your network exposed if you
fail to update even one device with the most recent ﬁrmware.
■
Always use WPA or WPA2 encryption.
■
Always change the default administrative password used to manage the AP.The
default passwords for wireless APs are well known. If possible, use a password gen-
erator to create a difﬁcult and sufﬁciently complex password. Never use a word
found in the dictionary.
www.syngress.com
Wireless DMZs • Chapter 4
165

■
Change the default SSID of the AP.The default SSIDs for APs from various ven-
dors are well known, such as tsunami and Linksys for Cisco and Linksys APs,
respectively.A fairly inclusive listing of default SSIDs can be found at
www.remote-exploit.org/index.php/Wlan_defaults.
■
Do not put any kind of identifying information in the SSID, such as the company
name, address, products, divisions, and so on. By doing so, you are either simply pro-
viding too much information and/or are advertising information that could make
your network appear to be of sufﬁcient interest to warrant further attacker effort.
■
If possible, disable SSID broadcasts.
■
Do not use shared-key authentication.Although it can protect your network
against speciﬁc types of DoS attack, other kinds of DoS attacks are still possible.
Shared-key authentication exposes your encryption keys to compromise.
■
Learn how to use site survey tools and conduct frequent site surveys to detect the
presence of rogue APs and to detect vulnerabilities in your own network.
■
Don’t place the AP near windows.Try to place it in the center of the building so
that interference will hamper the efforts of wardrivers and others trying to detect
your trafﬁc. Ideally, your wireless signal would radiate only to the outside walls of
the building and not beyond.Try to come as close to that ideal as possible.You
might want to look at some references focusing on wireless network signal radia-
tion patterns. For a start, see http://safari.awprofessional.com/1587051648/app02
and http://www.neugc.org/COMMON%20Corner%20Jan06.pdf.
■
If possible, purchase an AP that allows you to reduce the size of the wireless zone
(cell sizing) by changing the power output.
■
Educate yourself in the operation and security of wireless networks.
■
Educate your users about safe computing practices, in the context of using both
wired and wireless networks.
www.syngress.com
166
Chapter 4 • Wireless DMZs

Summary
Wireless LANs are attractive to many companies and home users because of the increased
productivity that results from the convenience and ﬂexibility of being able to connect to the
network without the use of wires. WLANs are especially attractive when they can reduce
costs by circumventing the need to install cabling to support users on the network. For these
and other reasons, WLANs have become very popular. However, WLAN technology has
often been implemented poorly and without due consideration given to network security.
For the most part, these poor implementations result from a lack of understanding of the
nature of wireless networks and the measures that can be taken to secure them.
WLANs that are not conﬁgured properly are inherently insecure due to the fact that
they radiate radio signals containing network trafﬁc that can be viewed and potentially com-
promised by anyone within range of the signal. With the proper antennas, the range of
WLANs is much greater than is commonly assumed. Many administrators wrongly believe
that their networks are secure; they think that the interference created by walls and other
physical obstructions, combined with the relative low power of wireless devices, will contain
the wireless signal sufﬁciently. Often, this is not the case.
The goal of the DMZ is to control trafﬁc crossing the network segment and to prevent
unauthorized trafﬁc from entering the protected private network; this result is offered by
implementing the solutions that were outlined in this chapter.The most important thing that
you, as the network administrator, can do is to fully understand your organization’s security
requirements and implement those requirements by making numerous solutions available.We
examine the actual conﬁguration and implementation of some of these solutions in Chapter 5.
Solutions Fast Track
The Need for Wireless DMZs 

Attacks on wireless networks fall into four basic categories: passive attacks, active
attacks, man-in-the-middle attacks, and jamming attacks.

Examining the common threats to both wired and wireless networks provides a
solid understanding in the basics of security principles and allows the network
administrator to fully assess the risks associated with using wireless and other
technologies.

Threats can come from simple design issues, where multiple devices utilize the
same setup, or intentional DoS attacks, which can result in the corruption or loss
of data.

Electronic eavesdropping, or snifﬁng, is passive and undetectable to intrusion
detection devices.
www.syngress.com
Wireless DMZs • Chapter 4
167


Tools that can be used to sniff networks are available for Windows (such as
Ethereal and AiroPeek) and UNIX (such as TCPDump and ngrep).

Snifﬁng trafﬁc allows attackers to identify additional resources that can be
compromised.

Even encrypted networks have been shown to disclose vital information, such as
the Service Set Identiﬁer (SSID), the channel you’re using, MAC addresses and IP
addresses, and the type of encryption and cipher being used.
Designing the Wireless DMZ

The ability to freely gain access to a wireless segment of a network and then
subsequently gain access to the wired segment is what makes implementing the
wireless DMZ different from implementing the typical wired network DMZ.
Therefore, the issue of creating a form of DMZ for the WLAN actually begins
with controlling access to that WLAN.

Whereas wired DMZs typically use ﬁrewalls and routers, WDMZs require other
network hardware components, such as APs, RADIUS servers, network adapters,
and EWGs.
Wireless DMZ Examples 

WDMZ designs can come in many forms.They all must, however, provide the
same basic function: authenticating users and controlling access to the WLAN.

You can opt to use a RADIUS-based solution to perform network authentication
and authorization.

You can use proprietary solutions such as EAP-FAST to provide additional
protection. VPNs can be used to further secure communications on wireless
clients.
Wireless LAN Security Best-Practices Checklist 

Perform a risk analysis and implement standardized security policies for your
wireless and wired networks.

In addition to deploying a WLAN DMZ, there are several other things that you
can do to add protection and increase security of your WLAN, such as placing
your AP in a secure location, disabling SSID broadcasts, and using WPA2
encryption along with 802.1x port-based authentication.
www.syngress.com
168
Chapter 4 • Wireless DMZs


Security begins with education.You should gain a full understanding of the
security threats your WLAN is subject to.You should then gain a full
understanding of how your wireless network hardware components can be used to
put together a robust security solution.
Q: Do I really need to understand the fundamentals of security in order to protect my net-
work?
A: Yes.You might be able to utilize the conﬁguration options available to you from your
equipment provider without a full understanding of security fundamentals. However,
without a solid background in how security is accomplished, you will never be able to
protect your assets from the unknown threats to your network through misconﬁgura-
tion, back doors provided by the vendor, or new exploits that have not been patched by
your vendor.
Q: Given all the problems with wireless network security, wouldn’t it be better to avoid
using a wireless network in the ﬁrst place?
A: Yes and no. How does the implementation of a properly secured wireless network
impact your business model? Does this wireless network provide a useful function to
your organization by allowing users to become more productive as they perform their
assigned tasks? The decision to implement a wireless network is one that should not be
taken lightly. Planning, just as with any network deployment, is the key to success. Don’t
simply put up a wireless network because it seems like a good idea; make sure that you
have a clear-cut reason and plan of action before you get started. It’s better to ﬁgure out
how to secure your wireless network before you actually start installing it, thus pre-
venting attackers from taking advantage of the easy pickings you have offered them.
Q: How can I protect my wireless network from eavesdropping by unauthorized 
individuals?
www.syngress.com
Wireless DMZs • Chapter 4
169
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

A: Certain eavesdropping is unavoidable unless you can contain your wireless network in a
Faraday cage.The best method to secure your communications is by encrypting the
trafﬁc with WPA or WPA2. No encryption will expose all your data to cleartext inspec-
tion and WEP can be cracked too easily.
Q: I’ve heard time and again that WEP is insecure. What makes WEP so insecure?
A: WEP is insecure mainly because the 24-bit initialization vector (IV) is too short and
because the same IV is reused.
Q: How can I prevent unauthorized users from authenticating and associating with my AP?
A: There are a number of ways to accomplish this goal.The best choice for enterprise net-
works is to enable WPA2 and 802.1x port access control such as that offered by EAP-
FAST with a back-end authentication server.
www.syngress.com
170
Chapter 4 • Wireless DMZs

Implementing
Wireless DMZs
Solutions in this chapter:
■
Implementing RADIUS With Cisco LEAP
■
Installing and Conﬁguring Juniper Steel-
Belted RADIUS
■
Implementing Windows Active Directory
Domain Authentication With Cisco EAP 
and RADIUS
■
Implementing PEAP 
Chapter 5
171
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
In Chapter 4, we examined the various reasons that your wireless network segment is not to be
trusted in the same way that you would normally trust a wired network segment. In addition,
we discussed the reasons that a wireless DMZ (WDMZ) is needed.We also looked at some
basic WDMZ designs; we implement those designs in this chapter. (For a refresher on WDMZ
fundamentals, please review Chapter 4.) With a wired DMZ, you are attempting to (for the
most part) control the type of trafﬁc going into and out of your network.This is not com-
pletely the case with WDMZ implementations.The number-one concern with WLANs is
controlling access—who can get on the wireless network and how we can control that access.
The ways you can implement security on a wireless network are varied and limited only
by imagination.As outlined in Chapter 4, measures taken to increase security are not limited
to implementing DMZs or VPNs but also include many actions that could be characterized
as good administrative practices. In the following sections, we examine some potential solu-
tions that you might implement to provide the net effect of a DMZ for your WLAN.
These solutions are certainly not all inclusive—you can add to them as you see ﬁt or even
create your own solutions.To increase your network’s security, you need to control access to
wireless networks.You’ll ﬁnd a wide range of products in the market to achieve this goal.
This chapter looks at a couple of products in depth so that you can utilize them imme-
diately within your WLAN infrastructure.
Implementing RADIUS With Cisco EAP
The use of Remote Authentication Dial In User Service (RADIUS) servers to authenticate
network users is a longstanding practice. Using a RADIUS server dynamic per-user, per-ses-
sion Wired Equivalency Privacy (WEP) keys, combined with initialization vector (IV) ran-
domization, is widely in practice. Enter Cisco’s proprietary offering, Lightweight Extensible
Authentication Protocol (LEAP).Though proprietary, LEAP is offered by Funk (now Juniper
Networks) as well.
LEAP is one of approximately 30 variations of the Extensible Authentication Protocol
(EAP). Other variants include EAP-MD5, EAP-TLS, EAP-TTLS, and Protected Extensible
Authentication Protocol (PEAP). EAP allows other security products (such as LEAP) to be
used to provide additional security to Point-to-Point Protocol (PPP) links through the use of
special Application Programming Interfaces (APIs) that are built into operating systems and,
in the case of the Cisco Aironet hardware, hardware device ﬁrmware.
LEAP (also known as EAP-Cisco Wireless) uses dynamically generated WEP keys,
802.1x port access controls, and mutual authentication to overcome the problems inherent in
WEP.The 802.1x protocol is an access control protocol that operates at the port level and
sites between any authentication method (LEAP, in this case) and the rest of the network.
The 802.1x protocol does not provide authentication to users; rather, it translates messages
from the selected authentication method into the correct frame format being used on the
network. In the case of our example, the correct frame format is 802.11, but 802.1x can also
www.syngress.com
172
Chapter 5 • Implementing Wireless DMZs

be used on 802.3 (Ethernet) and 802.5 (Token Ring) networks, to name a few. When you
use 802.1x, the choice of the authentication method and key management method is con-
trolled by the speciﬁc EAP authentication used (LEAP, in this case).The basic process by
which a user gains access to the network when LEAP and 802.1x are in use is explained in
Chapter 4.
NOTE
RADIUS is deﬁned by Request for Comment (RFC) 2865. The behavior of RADIUS
with EAP authentication is deﬁned in RFC 2869. RFCs can be searched and
viewed online at www.rfc-editor.org. The 802.1x protocol is deﬁned by the
Institute of Electrical and Electronics Engineers (IEEE) in the document located
at http://standards.ieee.org/getieee802/download/802.1X-2001.pdf.
LEAP creates a per-user, per-session dynamic WEP key that is tied to the network
logon, thereby addressing the limitations of static WEP keys. Since authentication is per-
formed against a back-end RADIUS database, administrative overhead is minimal after initial
installation and conﬁguration.
EAP-FAST (Flexible Authentication via Secure Tunneling), dubbed LEAPv2, implements
client/server security to encrypt transactions within a Transport Level Security (TLS) tunnel.
Strong shared keys are used to establish tunnels.These keys are unique to users.These shared
secrets are also known as Protected Access Credentials, or PACs. PACs can be distributed man-
ually or automatically to client devices. Number of messages exchanged are fewer than a PKI-
based deployment and thus faster. EAP-FAST is faster than other protocols.
LEAP Features
Through the use of dynamically generated WEP keys, LEAP enhances the basic security WEP
provides by signiﬁcantly decreasing the predictability to the user hoping to determine the
WEP key through the use of a WEP key-cracking utility. In addition, the WEP keys that are
generated can be tied to the speciﬁc user session and, if desired, to the network login as well.
Through the use of Cisco (or other third-party components that support LEAP) hardware
from end to end, you can provide a robust and scalable security solution that silently increases
network security, not only by authenticating users but also by encrypting wireless network
trafﬁc without the use of a VPN tunnel. (You can, however, opt for the additional network
overhead and implement a VPN tunnel as well to further secure the communications.)
Cisco LEAP provides the following security enhancements:
■
Mutual authentication Mutual authentication is performed between the client
and the RADIUS server. In addition, the AP and the RADIUS server perform
mutual authentication. Using mutual authentication between the involved compo-
www.syngress.com
Implementing Wireless DMZs • Chapter 5
173

nents prevents the introduction of both rogue APs and RADIUS servers.
Furthermore, you provide a solid authentication method to control access to the
wireless network segment (and thus the wired network behind it).All communica-
tions between the AP and the RADIUS servers is carried out using a secure
channel, further reducing any possibility of eavesdropping or spooﬁng. LEAP does
this by supporting dynamic derivation of session keys. It relies on a shared secret,
logon password, and challenge response between the user and the RADIUS server.
■
Secure-key derivation A preconﬁgured, shared-secret secure key is used to con-
struct responses to mutual authentication challenges. It is put through an irre-
versible one-way hash that makes recovery or replay impossible and is useful for
one time only at the start of the authentication process.
■
Dynamic WEP keys Dynamic per-user, per-session WEP keys are created to
easily allow administrators to quickly move away from statically conﬁgured WEP
keys, thus signiﬁcantly increasing security.The single largest security vulnerability
of a properly secured wireless network (using standard 802.11b security measures)
is the use of static WEP keys that are subject to discovery through special software
such as WEPcrack and AirCrack. In addition, maintaining static WEP keys in an
enterprise environment is administratively prohibitive. Using LEAP, the session-
speciﬁc WEP keys that are created are unique to that speciﬁc user and are not used
by any other user. In addition, the broadcast WEP key (which is statically conﬁg-
ured in the AP) is encrypted using the session key before being delivered to the
client. In 802.1x authentication, two WEP keys are used.To encrypt Unicast
trafﬁc, a per-user key is used.A broadcast key is used to encrypt broadcast and
multicast trafﬁc.This key is shared by all the clients associated with a speciﬁc AP.
Since each session key is unique to the user and can be tied to a network login,
LEAP also completely eliminates common vulnerabilities due to lost or stolen net-
work adapters and devices. In a static WEP key scenario, imagine that an employee
of your company lost his wireless adapter; anybody can pick up the hardware and
get access to your wireless LAN because the key is stored in the ﬁrmware.
■
Reauthentication policies You can set policies that force users to periodically
reauthenticate to the RADIUS server and thus receive fresh session keys.This
policy can further reduce the window for network attacks because the WEP keys
are rotated even more frequently.
■
Initialization vector changes The IV is incremented on a per-packet basis, so
hackers cannot ﬁnd a predetermined, predictable sequence to exploit.The capa-
bility to change the IV with every packet, combined with dynamic keying and
reauthentication, greatly increases security and makes it that much more difﬁcult
for an attacker to gain access to the wireless network.
www.syngress.com
174
Chapter 5 • Implementing Wireless DMZs

TIP
Do a Web search and you might ﬁnd many products for WEP cracking. Some of
the most commonly used utilities are WEPCrack, AirCrack, AirSnort, Kismet,
Airodump, and Aireplay.
NOTE
WEP is a shared-key authentication process that uses a pseudo-random number
generator and the RC4 stream cipher. The RC4 stream cipher is adequate; how-
ever, the weakness in WEP lies in the IV. In most implementations, the IV starts
at 0 and is incremented by 1 for each packet transmitted on the network. Given
the relatively small number of IVs available (224), the IV will roll over, given
enough time—as little as one to ﬁve hours in a busy network. The IV is trans-
mitted in clear text with each encrypted packet, thus allowing an attacker to
easily create a table of packets and compare known packet information to
determine the WEP key. Several freeware utilities are available for just this task. 
Building a Cisco LEAP Solution
To put together a Cisco EAP (LEAP) with RADIUS solution, you need the following 
components:
■
A Cisco Aironet AP that supports LEAP. Currently, this includes the 350, 1100, and
1200 models.The 350 is the oldest of the bunch and offers the least amount of
conﬁgurability.The 1100 is the newest and offers both CLI- and GUI-based man-
agement and conﬁguration.
■
A compatible network adapter that supports LEAP (for example, Cisco Aironet 21).
■
The most up-to-date network adapter driver, ﬁrmware, and Aironet Client Utility
(ACU).You can download this driver using the Aironet Wireless Software Selector
on the Cisco Web site at www.cisco.com/pcgi-
bin/Software/WLAN/wlplanner.cgi.
■
A RADIUS server application that supports LEAP. For our purposes, we use
Juniper’s Steel-Belted RADIUS/Enterprise Edition.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
175

NOTE
Cisco response to dictionary attacks on Cisco LEAP is an interesting read to learn
how to handle dictionary attacks. Read the Cisco technology document (which
requires CCO logon) at www.cisco.com/en/US/partner/products/hw/wireless/
ps430/prod_bulletin09186a00801cc901.html.
Installing and Conﬁguring 
Juniper Steel-Belted RADIUS
Steel-Belted RADIUS (SBR) is an implementation of the RADIUS protocol.Apart from
remote users, SBR supports wireless LANs and works with a wide range of network authen-
tication products and technologies. It helps you implement authentication and access control
policy for your organization.
NOTE
SBR is the authentication software from Funk Software, which is now a part of
Juniper Networks. When you visit www.funk.com. the Web site redirects you to
www.juniper.net/welcome_funk.html. 
The features of SBR are:
■
Support for wide range of network access components
■
Graphical administration
■
Centralized management and access control
■
Support for wide range of authentication protocols
■
Support for 802.1x-based APs
■
Wide range of authentication, including token-based and third-party authentica-
tion devices
SBR implements authentication (verifying the user), authorization (the level of access on
the protected network), and accounting (record of actual network activities, often used for
billing and diagnosis), on the basis of the RADIUS protocol.
The components of SBR solution include:
www.syngress.com
176
Chapter 5 • Implementing Wireless DMZs

■
Access Client, such as wireless clients, dial-in users, wired 802.1x users, and remote
ofﬁce users
■
Access Server/RADIUS client, including APs, Remote Access Servers (RAS),
802.1x compatible switches, and VPNs
■
RADIUS Server, which implements authentication, authorization, and accounting
■
Back-end resources, such as authentication server, SecurID,TACACS+, Remote
RADIUS servers, and external database (SQL,Windows Active Directory, or LDAP)
RADIUS Authentication Process
The following are the steps involved in the process (see Figure 5.1) of RADIUS authentication:
1
The supplicant initiates a connection request to a RADIUS client (in this scenario,
a wireless AP).
2
The RADIUS client passes the authentication request to the SBR server.
3
The SBR server refers to the local database (native) or external database (such as
SQL, LDAP, or Active Directory) to verify the user logon parameters provided by
the access client.
4
The SBR server authenticates the user and provides authorization attributes or
rejects the user if the parameters are incorrect.
5
If the user is authenticated successfully, the connection is accepted; otherwise, it’s
rejected.
Figure 5.1 RADIUS Authentication Process
www.syngress.com
Implementing Wireless DMZs • Chapter 5
177
Client Card
(Supplicant)
Access Point
(Authenticator)
Authentication Server
(Native Database)
(Optional)
External Database
SQL , LDAP or Active 
Directory
Connection Request
Authentication Request
User Lookup
(local)
User Lookup
(external)
Authentication 
&
Authorization Attributes
Accept Connection
or
Reject Connection

Installing Steel-Belted RADIUS
SBR is available on a wide range of platforms, including Windows, Linux, and Solaris. SBR
software components include:
■
SBR server
■
SBR administration software
■
Odyssey client (optional)
SBR can be implemented with Microsoft Windows XP native wireless client or third-
party clients such as Cisco Access Client Utility (ACU). SBR in a Cisco implementation
supports Cisco LEAP, EAP-FAST, and Microsoft PEAP-MS CHAPv2 protocols.
In this section, we look at the implementation of Juniper SBR with the Cisco LEAP
authentication protocol.To get started with your LEAP/RADIUS solution, you ﬁrst need to
install and conﬁgure the RADIUS server of your choice. Perform the following steps to get
SBR installed and conﬁgured for LEAP:
1.
Download the SBR installation package from the Juniper Networks Web site
(www.juniper.net/customers/support/products/sbr_series.jsp).You can download a
30-day trial if you are not ready to purchase.The current version is SBR 5.4. In
addition, download the Windows binaries SBRNT_Admin_54.exe, SBRNT_
ALL_54, and optionally, the Odyssey client (odyc45.exe). Execute  SBRNT_
ALL_54 to install the SBR server. On a test environment, both the administration
software and the server software can reside on the same physical server.
2.
Provide your name and your organization’s name as well your product key. Note
that you can opt to exercise the 30-day trial if you desire. Click Next to continue.
3.
On the next page, select the Enterprise Edition option and click Next to con-
tinue. Figure 5.2 shows Steel-Belted RADIUS server editions from which to choose.
Figure 5.2 The Steel-Belted RADIUS Server Editions
www.syngress.com
178
Chapter 5 • Implementing Wireless DMZs

4.
Click Yes to accept the end-user license agreement (EULA).
5.
Click Next to start the setup routine.
6.
Select your installation location.
7.
Select the SBR standalone server option and continue the installation.
8.
When the installation has completed, the Steel-Belted RADIUS server is installed
as a service.You may verify the installation from Start | Control Panel |
Administrative Tools | Services.
9.
Launch RADIUS Administrator.The admin application opens. Select the Local
option and click the Connect button, as shown in Figure 5.3.
Figure 5.3 The Steel-Belted RADIUS Administrator Window
10.
Close the SBR admin application to begin the conﬁguration of SBR for LEAP.
11.
Navigate to the SBR installation directory (c:\radius\service) and open the
Service folder. Locate and open the eap.ini ﬁle for editing. For this example, we
use native RADIUS authentication, meaning that users will be authenticating
directly against the SBR RADIUS database. (You can, optionally, conﬁgure SBR
for Windows domain authentication, as discussed later in this chapter.) Under the
[Native-User] heading, remove the semicolon from the ﬁrst three items to
enable LEAP. Save and close the eap.ini ﬁle (see Figure 5.4).
www.syngress.com
Implementing Wireless DMZs • Chapter 5
179

Figure 5.4 Conﬁguring SBR for LEAP
12.
From the Services console, located in the Administrative Tools folder, restart the
Steel-Belted RADIUS service to force it to reload the eap.ini ﬁle. Launch the
SBR Admin application and connect to the local server as shown in Figure 5.5.
Figure 5.5 Restarting the Steel-Belted RADIUS Service
13.
Click the RADIUS Clients option to conﬁgure SBR for the Cisco AP, as shown in
Figure 5.6. Note that the AP is the RADIUS client since it is performing authenti-
cation on behalf of the wireless network client. Click the Add button to create a
new client, and click OK to conﬁrm it. Next, specify the client IP address (the IP
address assigned to the AP) and the type of client (Cisco Aironet AP).
14.
Type a password in the Shared secret box to enter the shared secret to be used
for the AP and SBR servers to authenticate each other, as shown in Figure 5.6.
(Remember your shared secret; you will need it again when you conﬁgure the AP
later.) Click the OK button to conﬁrm the client details.
www.syngress.com
180
Chapter 5 • Implementing Wireless DMZs

Figure 5.6 Conﬁguring the RADIUS Client Properties
15.
Click the Users option to create native users (users internal to the SBR server), as
shown in Figure 5.7. Click the Add button to add a new username.After entering
the username and password, click OK to conﬁrm it.
Figure 5.7 Creating Native Users
16.
Click Windows Domain User and Windows Domain Group to conﬁgure
authentication methods while implementing authentication for Windows users.
17.
Click the Authentication Policies option to set the authentication methods (and
their order) to be used, as shown in Figure 5.8. Since we are using native users,
ensure that the Native User option is placed ﬁrst in the list. Choose LEAP and
MS-CHAP-V2. Click Save to conﬁrm the changes.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
181

Figure 5.8 Selecting the Authentication Methods
Conﬁguring Cisco LEAP
Once the RADIUS server is installed and conﬁgured, the hard work is behind you.All that is
left is to conﬁgure LEAP on the AP and the client network adapter.To conﬁgure LEAP on the
AP, perform the following steps. (Note that the exact screen will vary among various APs
models—the end conﬁguration is the same, however. For this discussion, a Cisco Aironet 1200
AP is used, with all conﬁgurations performed via the Web interface instead of the CLI.)
1.
Log in to your AP via the Web interface.
2.
Conﬁgure your network SSID and enable EAP authentication, as shown in Figure
5.9. Save your settings to the AP after conﬁguring them.
Figure 5.9 Enabling EAP Authentication
www.syngress.com
182
Chapter 5 • Implementing Wireless DMZs

3.
Enter a 128-bit broadcast WEP key, as shown in Figure 5.10. Save your settings to
the AP after conﬁguring them.
Figure 5.10 Entering the Broadcast WEP Key
4.
Conﬁgure your RADIUS server IP address and shared-secret key information, as
shown in Figure 5.11.
Figure 5.11 Conﬁguring the RADIUS Server Information
To enable the wireless client for LEAP, ﬁrst ensure that it is using the most recent
ﬁrmware and drivers, as discussed previously. Once you’ve got the most up-to-date ﬁles, pro-
ceed as follows to get the client conﬁgured and authenticated using LEAP:
www.syngress.com
Implementing Wireless DMZs • Chapter 5
183

1.
Launch the Cisco ACU, shown in Figure 5.12. Notice that the ACU reports that
the network adapter is not associated with the AP.This is normal at this point
because the AP is conﬁgured to require LEAP authentication.
Figure 5.12 Using the Cisco ACU
2.
Switch to the Proﬁle Management tab to create a new proﬁle, as shown in
Figure 5.13.Assign a name to the new proﬁle and enter testssid (or the name of
the SSID).
Figure 5.13 Creating a New Proﬁle
3.
Switch to the Security tab. Under Set Security Options, select the 802.1x
option and select LEAP from the drop-down list, as shown in Figure 5.14. After
selecting LEAP, click the Conﬁgure button.
4.
On the LEAP Settings page, ensure that the Use Temporary User Name and
Password option is selected with the Manually Prompt for LEAP User
Name and Password suboption. Remove the check mark from the Include
Windows Logon Domain with User Name option because we are using
Native mode authentication in this example (see Figure 5.15). Click OK after
making your conﬁguration.
www.syngress.com
184
Chapter 5 • Implementing Wireless DMZs

Figure 5.14 Conﬁguring the Authentication Method
Figure 5.15 Conﬁguring LEAP Options
5.
Click OK to view the new proﬁle in the Proﬁle Management tab (see Figure
5.16). Click the Activate button to activate the new proﬁle.
Figure 5.16 Activating the New Proﬁle
Implementing Wireless DMZs • Chapter 5
185
www.syngress.com

6.
Double-click on the new proﬁle to log in.
7.
Provide the username and the password of the native user you created in the SBR
section.
8.
If you look at the SBR Administrator application on the Statistics page, you can
see the number of successful and failed authentications (see Figure 5.17).
Figure 5.17 Monitoring the RADIUS Server Statistics
Windows Active Directory Domain
Authentication With LEAP and RADIUS
In the preceding sections, we only looked at creating native user accounts in Steel-Belted
RADIUS. It is also possible to create AD domain user accounts and have the RADIUS
server authenticate directly against Active Directory.This approach offers many advantages,
such as preventing dictionary attacks by enforcing account lockout policies.To use domain
user accounts for LEAP authentication, you need only perform the following additions and
modiﬁcations to the procedures outlined earlier in this chapter:
1.
Make modiﬁcations to the eap.ini ﬁle; to enable LEAP, under the [Windows
Domain] heading, remove the semicolon from the ﬁrst three items to enable
LEAP.
2.
From the Services console located in the Administrative Tools folder, restart the
SBR service to force it to reload the eap.ini ﬁle. Launch the SBR Admin applica-
tion and connect to the local server. On the Authentication Policies page, shown
in Figure 5.18, ensure that the Windows Domain User and Windows Domain
Group options are enabled and are at or near the top of the list.
www.syngress.com
186
Chapter 5 • Implementing Wireless DMZs

Figure 5.18 Checking Authentication Methods
3.
Go to the Users page and add a new user, as described previously.This time, how-
ever, you will have the option to select a domain user, as shown in Figure 5.19.
Select your domain user, and click OK.
Figure 5.19 Adding a Domain User
4.
Open the ACU and edit the proﬁle in use (the one you created previously).
Switch to the Security tab and click the Conﬁgure button next to the network
security type drop-down box (where LEAP is selected). In the LEAP settings
dialog box, ensure that the Use Windows User Name and Password option is
selected (instead of the options you selected for LEAP), as shown in Figure 5.20.
In addition, ensure that a check mark is placed next to the Include Windows
Login Domain with User Name option.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
187

Figure 5.20 Conﬁguring LEAP Options for Domain Authentication
5.
Click OK to save the settings and exit the proﬁle conﬁguration.
6.
Log into the network using LEAP and your domain user credentials.
LEAP Review
Now that you’ve had a chance to examine the workings of Cisco’s LEAP, you should see
quite a few beneﬁts to be gained through its use. LEAP, implemented with Juniper (Funk)
Software’s Steel-Belted RADIUS, is an ideal and very robust security solution for wireless
networks of any size. By forcing users to authenticate to a back-end RADIUS server and
creating per-user, per-session dynamic WEP keys, LEAP provides greatly enhanced authenti-
cation and security for your wireless network.
Cisco has licensed the LEAP technology to several third-party vendors, so you can
expect to see many more LEAP-compatible devices in the near future. For example,Apple’s
AirPort network adapter already supports LEAP with version 2 or better ﬁrmware.
Implementing PEAP
Protected Extensible Authentication Protocol (PEAP) is a member of the family of
Extensible Authentication Protocols (EAP). PEAP uses Transport Level Security (TLS) to
create an encrypted channel between the client supplicant and the RADIUS server. PEAP
provides additional security for client-side EAP authentication protocols, such as EAP-
MS-CHAP-V2, that can operate through the TLS encrypted channel. PEAP is used as an
authentication method for 802.11 wireless and wired client computers but is not sup-
ported for VPN or other remote access clients.
Security and ease of deployment make PEAP a popular choice for authentication.The
advantages of PEAP are:
www.syngress.com
188
Chapter 5 • Implementing Wireless DMZs

■
Windows Server 2003, Windows 2000, Windows XP, and Pocket PC 2002 offer
support for PEAP (either natively or with a system update), so there is no need for
you to install third-party client software.
■
Internet Authentication Service (IAS) is the Microsoft implementation of the
RADIUS protocol. Windows 2000 Server and Windows Server 2003 support
PEAP, so there is no need to install third-party RADIUS software.
NOTE
PEAP addresses many of the EAP security issues highlighted in the recently pub-
lished Internet Engineering Task Force (IETF) draft, available at
www.ietf.org/internet-drafts/draft-ietf-eap-rfc2284bis-0x.txt.
■
PEAP uses a TLS channel to protect the user credentials. Other password-based
methods (such as LEAP and EAP-MD5) do not create a TLS channel and are
exposed to ofﬂine dictionary attacks on the user credentials.
■
Using the TLS channel from the client to the authentication server, PEAP offers
end-to-end protection, not just over the wireless data link.This is particularly
important when a mobile user is using a public network to access a private net-
work. For non-TLS schemes (LEAP and EAP-MD5), the password is exposed to
attack on the wireless link and across the public network.
■
PEAP supports any EAP-compatible methods. PEAP is also deﬁned as an exten-
sible authentication method that can embrace new EAP authentication schemes as
they become ratiﬁed. Microsoft Windows PEAP supports passwords and certiﬁcate
authentication and allows any EAP-based method provided by partners to be used
within PEAP.
■
Within the TLS channel, PEAP hides the EAP type that is negotiated for mutual
client/server authentication.This helps prevent an attacker from injecting packets
between the client and the network AP.Also, because each packet sent in the TLS
channel is encrypted, the PEAP client and server can trust the integrity of the
authentication data.
■
PEAP offers strong protection against the deployment of unauthorized wireless
APs, because the client veriﬁes the RADIUS server’s identity before proceeding
with further authentication or connectivity.The wireless AP is unable to decrypt
the authentication messages protected by PEAP.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
189

■
PEAP offers highly secure keys that are used to encrypt the data communications
between the clients and wireless APs. New encryption keys are derived for each
connection and are shared with authorized wireless APs accepting the connection.
Unauthorized wireless APs are not provided with the encryption keys.
■
PEAP does not require the deployment of certiﬁcates to wireless clients. Only the
PEAP server (authentication server) needs to be assigned a certiﬁcate.The PEAP
server certiﬁcate can be managed using an internal certiﬁcation authority (CA)
product or acquired from a certiﬁcate management company, such as VeriSign or
Thawte.
■
Password-based schemes rely on strong passwords to help defend against brute-
force hacking. With PEAP, although you should still follow best practices for
strong passwords and management, users’ credentials are not exposed to the same
attack, because their credentials are protected by TLS.
■
Microsoft offers native support for PEAP so that a user can use the same logon
credentials for all network connections and applications. PEAP integrates seam-
lessly with Microsoft Windows domain policy, Group Policy, and logon scripts.
This means that PEAP by default transparently uses the same logon credentials you
type when you ﬁrst log into your network.Alternatively, you can specify that
PEAP authentication should use different logon credentials, if you are not con-
cerned about preserving the “single logon” experience for your users. Non-TLS
schemes (LEAP and EAP-MD5) do not support single logon, logon scripts, or
Group Policy.
■
Authentication schemes for which there are no standards or publicly available
speciﬁcations will not receive rigorous peer security review. PEAP is an open stan-
dard supported under the security framework of the IEEE 802.1X speciﬁcation
and has been submitted to the IETF.
■
Windows Server 2003 Group Policy features can be used to centrally conﬁgure
the properties of PEAP on all Windows XP (Service Pack 1 or later) or Windows
Server 2003 wireless clients.
■
PEAP offers security and efﬁciency when used with roaming wireless devices.
Authentication latency is frequently a concern with wireless networks because
users may need to reconnect to a network through a number of AP devices as they
roam.As a result, it is valuable to be able to quickly perform reauthentication.
PEAP supports this capability through the TLS session resumption facility, and any
EAP method running under PEAP can take advantage of it.
■
PEAP provides support for EAP authentication methods such as EAP-TLS and
EAP-MS-CHAPV2 that can perform computer authentication. LEAP does not
support computer authentication.
www.syngress.com
190
Chapter 5 • Implementing Wireless DMZs

■
The PEAP protocol speciﬁes an option of hiding a user’s name—that is, identity
privacy.The Microsoft implementation of PEAP does not support identity privacy
at this time.
Windows 2003 Environment PEAP Solution
The components required to implement PEAP in Windows 2003 are:
■
Windows 2003 domain controllers
■
Microsoft IAS server (RADIUS server) 
■
APs that allow EAP and PEAP (should be Advanced Encryption Standard, or AES,
compatible)
■
Client computers with Windows XP SP1, SP2, or better
The additional requirements for implementing PEAP are:
■
Server certiﬁcates
■
Group policy (to automatically conﬁgure the client computers)
The optional requirements for implementing PEAP are:
■
A management solution for the APs
■
Wireless LAN Solution Engine (WLSE)
■
Cisco Wireless Domain Service (WDS) 
After these requirements are met, you need to do the following to set up PEAP on
Windows 2003:
■
Set up a Microsoft Certiﬁcate Services
■
Create Wireless Group, Users, and Computers in Active Directory
■
Set up an Internet Authentication Service (IAS) Server
■
Conﬁgure Load Balancing and Redundancy for RADIUS server
Microsoft Certiﬁcate Services
The advantages of using Microsoft Certiﬁcate Services are:
■
Microsoft Certiﬁcate Services come with the Windows server operating system.
■
The service is convenient to use if the installation is integrated with Active
Directory.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
191

■
The certiﬁcate request and installation is straightforward and seamlessly integrated.
■
The authority is automatically installed on all domain computers.
■
After you generate the certiﬁcates for the RADIUS server(s), clients install the cer-
tiﬁcate in their trusted store.You can shut down the certiﬁcate server or install a
host ﬁrewall and block issuing of certiﬁcates for other purposes (such as EFS).This
ensures that the server runs only when there is a need to issue certiﬁcates.
■
If licenses and systems are an issue, the certiﬁcate server can be installed in the
same computer as the RADIUS server.
Notes from the Underground…
Pros and Cons of Getting a 
RADIUS Server Certiﬁcate from Various Vendors
You might get a certiﬁcate from one of these sources:
■
From an online certiﬁcation authority
The beneﬁt is that the client computers trust the certiﬁcates
issued by trusted third parties, such as VeriSign and others. The
drawback is that some additional cost is required for each certiﬁcate
(one certiﬁcate for each radius server).
■
From an implementation of Microsoft Certiﬁcate Services (this solu-
tion uses Microsoft Certiﬁcate Services)
The beneﬁts are that you can use the certiﬁcate for other pur-
poses (such as Web servers or EFS) and the propagation of the certi-
ﬁcation authority can be automated to all client computers. The
drawbacks include that there is one more service to maintain, and
you must understand the public key infrastructure.
■
From an implementation of a certiﬁcate using free software (OPEN
SSL)
The beneﬁts are that it comes free of cost and can be used for
other purposes. A disadvantage is that once you generate the certiﬁ-
cate for the root certiﬁcation authority, you need to manually dis-
tribute the certiﬁcate to all the clients that will use it and put it
under the Trusted Authorities.
www.syngress.com
192
Chapter 5 • Implementing Wireless DMZs

Conﬁguring a Microsoft Certiﬁcate Server 
Follow these steps to install and conﬁgure the Microsoft Certiﬁcate server:
1.
Install one or more servers with Windows 2003 domain controller.
2.
Install the Certiﬁcate Services integrated with Active Directory.
3.
Using the Certiﬁcate Request Wizard, request a certiﬁcate from the RADIUS
server (from the local certiﬁcates snap-in).
4.
Approve the certiﬁcate from the certiﬁcation authority (certiﬁcation authority
console).
5.
Install the certiﬁcate in the RADIUS server.
6.
Firewall the certiﬁcate server so no more certiﬁcates can be issued (which provides
better security for the computer system itself as well).
TIP
Refer to the Microsoft Technet article at www.microsoft.com/technet/
security/prodtech/windowsserver2003/build_ent_root_ca.mspx to set up and
conﬁgure a CA in a Windows 2003 domain.
Creating Wireless Group, Users,
and Computers in Active Directory
To create a Wireless User Group:
1.
Go to Start | Programs | Administrative Tools | Active Directory Users
and Computers.
2.
Right-click on Users and select New | Group. Provide the Group name and
leave the default group Properties.
3.
Click OK.
To create a Wireless Computer object:
1.
Go to Start | Programs | Administrative Tools | Active Directory Users
and Computers to open the Active Directory Users and Computers window, as
shown in Figure 5.21.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
193

Figure 5.21 The Active Directory Users and Computers Window
2.
Right-click Computers and select New | Computer. Provide the computer
name. Refer to Figure 5.22.
Figure 5.22 Creating a New Computer Object
3.
Click Next.
4.
If it’s a managed computer, provide the GUID; otherwise, click Next without
checking the This is a managed computer option (see Figure 5.23).
5.
Click Finish.
www.syngress.com
194
Chapter 5 • Implementing Wireless DMZs

Figure 5.23 Creating a New Computer Object
To create a Wireless User object:
1
Go to Start | Programs | Administrative Tools | Active Directory Users
and Computers.
2
Right-click Users and select New | User. Provide the User logon name and
other information and click Next.
3
Type the User password and other password options.
4
Click Finish.
5
Right-click the New Wireless User object and select Properties.
6
Switch to the Dial-in tab, and select the Allow access option.
7
Switch to the Member Of tab and click Add.
8
Choose the Wireless access group created earlier.
Setting Up an IAS Server
Follow these steps to install and conﬁgure IAS:
1.
Under the RADIUS Clients, add the IP address of each AP. Use a different pass-
word for every AP (recommended; see Figure 5.24). If your LAN environment is
100 percent switched and snifﬁng on the wired LAN is not possible, you might
want to opt to use same password for all the APs.To add the IP address of each AP,
go to Start | Programs | Administrative Tools | Internet Authentication
Service | RADIUS Clients, right-click, and select New RADIUS Client.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
195

Figure 5.24 Adding RADIUS Clients
2.
Provide a name and the IP address of the AP.
3.
Choose the AP vendor from the client vendor list.
4.
Provide the shared secret. (The same shared secret needs to be supplied in the AP
while conﬁguring the RADIUS server.)
Figure 5.25 illustrates the IAS authentication process to help you understand the steps
involved in the RADIUS authentication on Windows 2003.
Figure 5.25 The IAS Authentication Process
www.syngress.com
196
Chapter 5 • Implementing Wireless DMZs
Domain Controller
RADIUS Server (IAS)
Access Point
Client
Alternate
Domain Controller
Backup RADIUS
Server (IAS)
Certificate of
 Authority
Clients Trust the 
Certificates Issued by 
Trusted 3rd Party or 
Certificate Authority (CA)
CA Issues Certificates to 
RADIUS Servers
RADIUS Servers Check the 
Credentials With a Domain 
Controller
After Authentication, 
Authorization Credential 
are Passed
Request for Association 
With Supplied Credential
RADIUS Client (AP) Checks 
with RADIUS Server
Backup RADIUS Server in 
Case RADIUS Client is 
Unable to Reach the 
Primary Server
Backup Domain Controller 
in Case the RADIUS Server is 
Unable to Reach the 
Primary Domain Controller

Conﬁguring IAS Server Logging 
IAS server logs can provide insight on successful and rejected authentication requests. Figure
5.26 shows IAS log properties.
Figure 5.26 IAS Log Properties
IAS can store its logs in a ﬂat ﬁle or in a database on a Microsoft SQL Server (an ideal
solution if you do not have a management device).You can use Windows Event Viewer to
view the logs.This is a good starting point for troubleshooting.To view the logs in the Event
Viewer, select Remote Access Logging in the left pane to display Local File and SQL
Server options in the right pane. Right-click Local File and select Properties.You can cus-
tomize the log properties to include accounting and authentication requests, as shown in
Figure 5.27.
Figure 5.27 IAS Log Conﬁguration
Implementing Wireless DMZs • Chapter 5
197
www.syngress.com

Conﬁguring Remote Access Polices 
IAS allows you to have more than one policy on the RADIUS server. Place frequently used
policies at the top of the list. Figure 5.28 shows Remote Access Policies.
Figure 5.28 Remote Access Policies of IAS
To conﬁgure a remote access policy:
1.
Right-click Remote Access Policies in the left pane and select New Remote
Access Policy.The New Remote Access Policy Wizard will appear.
2.
Provide the policy name.
3.
Select the Wireless (Use for wireless LAN connections Only) option.
4.
Add the Wireless Group object.
5.
Select the authentication method (Protected EAP, PEAP).
6.
Choose the server certiﬁcate.
7.
Click Next and Finish to save the policy.
Repeat these steps to create additional policies.
The Wireless Policy
To conﬁgure the wireless policy, you need to meet two conditions. First, ensure that the
request comes from an AP and that not everyone has wireless access. Second, create a group
(as was discussed earlier) and place the computers or users who need wireless access in this
group.To conﬁgure the wireless policy:
www.syngress.com
198
Chapter 5 • Implementing Wireless DMZs

1.
Go to Start | Programs | Administrative Tools | Internet Authentication
Service | Select Remote Access Policies. On the right pane, right-click the
policy and select Properties.
2.
In the Wireless AP Policy Properties dialog box, as shown in Figure 5.29, click
Edit Proﬁle.
Figure 5.29 Wireless Policy Conditions
3.
Switch to the Authentication tab.
4.
Click EAP Methods.
5.
Click Edit.You can verify the server certiﬁcate in the EAP Protected Properties.
6.
Change the default conﬁguration of EAP Methods and Client Timeout Settings in
the policy. Figure 5.30 shows EAP methods conﬁguration.
Figure 5.30 EAP Methods 
Implementing Wireless DMZs • Chapter 5
199
www.syngress.com

7.
With dynamic WEP, the RADIUS server can force the clients to reauthenticate.A
new WEP key will be generated for the session. Generation of WEP keys adds to
the load of an IAS server. For higher security needs, the timeout can be further
reduced from 15 minutes to 3 minutes. Instead, use WPA, which uses a built-in
mechanism to rekey the session.You may modify the default timeout settings, as
shown in Figure 5.31.
Figure 5.31 Dial-in Constraints and Session Timeout
8.
Modify the EAP properties of the PEAP policy to choose the server certiﬁcate
and Fast Reconnect options. Fast Reconnect will allow a user to roam and elimi-
nates the need to reauthenticate. Choose a certiﬁcate that was issued for the
RADIUS server.Add EAP type MSCHAPv2 to allow usernames and passwords to
be used for authentication. Figure 5.32 shows the protected EAP properties.
Figure 5.32 Protected EAP Properties
www.syngress.com
200
Chapter 5 • Implementing Wireless DMZs

Securing IAS Server
It is quite safe to have a host ﬁrewall installed and enabled on the IAS server.The built-in
Windows 2003 ﬁrewall is adequate for this purpose.You may have to allow access to UDP
1645, 1646 or UDP 1812, 1813 (depending on the RADIUS server conﬁguration and the
ports conﬁgured on APs).Additional ports may be required for remote administration.You
can place IAS in a secured zone with only two open UDP ports.
Conﬁguring the Access Points 
The APs are generally not aware of the EAP methods that the client uses to authenticate to
the server.There is one speciﬁc conﬁguration for individual EAP methods such as EAP,
LEAP,TTLS, and EAP-TLS. Before you conﬁgure EAP, change the default password, default
SNMP communities, and SNMP location.
To conﬁgure the AP:
1.
Deﬁne the SSID.
2.
Enable EAP authentication for the SSID.
3.
Enable WEP encryption (mandatory requirement).
4.
Deﬁne the RADIUS server(s) required for the EAP authentication (same password
used in the RADIUS server).
You may also use the wizard that will conﬁgure these steps.
Group Policy
Use the new Group Policy extensions to conﬁgure the wireless LAN adapters of the client
computers.You may also write a small application or script that will modify wireless access
properties.Then you may send the instructions to apply this policy to the users through e-mail.
NOTE
When a group policy is applied:
■
It adds a SSID under the preferred networks of each client computer.
■
It applies to the entire organization (domain) or speciﬁc containers or
organization units.
■
The preferred network cannot be removed by the user under normal
circumstances.
■
You may add other SSIDs (such as home networks). 
■
The changes on Group Policy Objects are applied to client computers.
If you are using Windows Login Scripts in your environment, remember that Windows
XP brings up the login dialog box very quickly.The user might be able to log in with the
www.syngress.com
Implementing Wireless DMZs • Chapter 5
201

cached credentials before the wireless authentication process is ﬁnished—resulting in an
inability to process any login scripts.You may suggest the users to wait for 15 seconds before
logging in.
Conﬁgure a Windows policy to bring up the login script after the network connections
are up and running.This policy poses no issues when the wireless signal reception is good or
when there is no signal at all. It becomes a problem when the signal is very weak; the user
might be stuck in retransmissions trying to authenticate and so never get to the desktop.
Conﬁguring Load Balancing 
and Redundancy for RADIUS Server
Failure of the RADIUS server will bring the wireless network down (single point of failure).
Therefore, it is recommended to conﬁgure a set of APs (about 50 percent) to access the pri-
mary RADIUS server (server1) and a second set to access a secondary RADIUS server
(server2). Now conﬁgure the second set of APs with server2 as the primary server and
server1 as the secondary server, as shown in Figure 5.33.You may have to ensure that all the
APs are listed on both the RADIUS servers.
Figure 5.33 Conﬁguring Redundancy for RADIUS Servers
RADIUS Review
The following Phase 1 and Phase 2 steps summarize the RADIUS authentication process.
Figure 5.34 provides a pictorial representation of the radius process.
Phase 1
1.
AP -> client (EAP-Request Identity)
www.syngress.com
202
Chapter 5 • Implementing Wireless DMZs
Primary Link
Secondary Link
RADIUS Server 1
RADIUS Server 2
AP 1
(RADIUS Client)
AP 2
(RADIUS Client)

2.
Client -> AP (EAP-Response Identity with Username)
3.
AP -> RADIUS (EAP-Response Identity with Username)
4.
RADIUS -> Client (EAP-Request/Start PEAP )
5.
RADIUS <-> Client (a series of messages that create the TLS channel)
Phase 2:
1.
RADIUS -> Client (EAP-Request Identity)
2.
Client -> Radius (EAP-Response Identity with Username)
3.
RADIUS -> Client (EAP-Request/EAP-MS-CHAP-V2 Challenge with the
challenge string)
4.
Client -> RADIUS (Response to the challenge and a challenge to the server to
authenticate itself)
5.
RADIUS -> Client (Success, after checking with the Domain Controller, and
response to the challenge)
6.
Client -> RADIUS (Success)
7.
RADIUS -> AP (EAP Success)
8.
Client <-> AP (WEP Encrypted Trafﬁc)
Figure 5.34 RADIUS Process
www.syngress.com
Implementing Wireless DMZs • Chapter 5
203
TLS Channel Created
PEAP Authentication
User Level Authentication, MS CHAPv2 Over the TLS Channel
Key Material
WEP Traffic
Wireless Client
Access Point
(RADIUS Client)
RADIUS Server
Domain Controller, LDAP
or Directory Server

Summary
In this chapter we examined Juniper Steel-Belted RADIUS with Cisco LEAP and Microsoft
Windows 2003 PEAP solutions that can be implemented fairly quickly and easily in your
network to create the effect of a DMZ. Recall that in most cases the standard DMZ men-
tality does not apply to wireless networks.You can, however, still create the net effect of lim-
iting trafﬁc and controlling access using these (and many other) types of solutions.The
solution you choose will be decided in part by your needs and in part by what you can
acquire in your price range.
Cisco’s LEAP is a variation of the standard EAP protocol that provided superior 802.1x
port-based access control between LEAP-compliant network adapters and APs. Using a
back-end RADIUS server designed to work speciﬁcally with LEAP, you can achieve a
superb level of security through the use of mutual authentication. PEAP can be deployed
easily in Windows 2003 environments. Use Windows 2003 group policies to gain granular
control.
Solutions Fast Track
Implementing RADIUS with Cisco LEAP
■
LEAP addresses all the problems inherent in the use of WEP in a wireless
network.The largest vulnerabilities come from static WEP keys and the
predictability of IVs. LEAPv2 is further strengthened and should be considered for
all newer deployments.
■
LEAP creates a per-user, per-session dynamic WEP key that is tied to the network
logon, thereby addressing the limitations of static WEP keys. Since authentication
is performed against a back-end RADIUS database, administrative overhead is
minimal after initial installation and conﬁguration.
■
Policies can be set to force users to reauthenticate to the RADIUS server more
often and thus receive fresh session keys.This approach can further reduce the
window for network attacks because the WEP keys are rotated even more
frequently.
■
Protected Extensible Authentication Protocol (PEAP) is a member of the family of
Extensible Authentication Protocol (EAP) protocols. PEAP uses Transport Level
Security (TLS) to create an encrypted channel between the client supplicant and
the RADIUS server. PEAP provides additional security for the client-side EAP
authentication protocols, such as EAP-MSCHAPv2.
www.syngress.com
204
Chapter 5 • Implementing Wireless DMZs

Q: Isn’t just using WEP enough protection from both an authentication and an encryption
standpoint?
A: No. Certain tools can break all WEP keys by simply monitoring the network trafﬁc
(generally requiring less than 24 hours to do so).
Q: Why is WEP (by the IEEE 802.11b standard) insecure?
A: WEP is insecure for a number of reasons.The ﬁrst is that the 24-bit IV is too short.
Because a new IV is generated for each frame and not for each session, the entire IV key
space can be exhausted on a busy network in a matter of hours, resulting in the reuse of
IVs. Second, the RC4 algorithm WEP uses has been shown to use a number of weak
keys that can be exploited to crack the encryption.Third, because WEP is implemented
at Layer 2, it encrypts TCP/IP trafﬁc, which contains a high percentage of well-known
and predictable information, making it vulnerable to plain-text attacks.
Q: Where can I ﬁnd more information on WEP vulnerabilities?
A: Besides being one of the sources that brought WEP vulnerabilities to light,
www.isaac.cs.berkeley.edu has links to other Web sites that cover WEP insecurities.
Q: How can I protect my wireless network from eavesdropping by unauthorized individuals?
A: Because wireless devices are half-duplex devices, you cannot wholly prevent your wire-
less trafﬁc from being listened to by unauthorized individuals.The only defense against
eavesdropping is to encrypt Layer 2 and higher trafﬁc whenever possible.
Q: Is LEAP the end-all security solution for wireless networks?
A: No.As we’ve seen, as good a solution as LEAP is, it still has its weaknesses and vulnera-
bilities—however small and controllable they might be.The wireless security ﬁeld is one
of the most rapidly changing ones in the area of IT and information security. Newer
alternatives, such as EAP-TTLS, are available, and many more will be available in the
next few years.The bottom line is that you must ﬁnd the security solution that offers
you the ideal balance—one that gives you the required level of security while still main-
taining the desired level of usability.
www.syngress.com
Implementing Wireless DMZs • Chapter 5
205
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

www.syngress.com
Implementing Wireless DMZs • Chapter 5
206

Firewall Design:
Cisco PIX and ASA
Solutions in this chapter:
■
PIX and ASA Basics
■
Securing Your Network Perimeters
■
Cisco PIX and ASA Versions and Features
■
Making a DMZ and Controlling Trafﬁc 
■
PIX and ASA Firewall Design and
Conﬁguration Checklist
Chapter 6
207
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
There are many ways to design and build your DMZ, and with so many products on the
market, it might be difﬁcult to decide which product is right for you. In the next few chap-
ters we discuss several enterprise-level ﬁrewall solutions, including Cisco’s PIX and ASA,
Check Point’s FireWall-1, and Microsoft’s ISA 2004. We provide the information you need
so that you can decide which ﬁrewall meets your DMZ needs in terms of security, perfor-
mance, functionality, manageability, stability, and reliability.Although all these products pro-
vide viable security solutions, they all have different requirements, features, and conﬁguration
methods that could lead you to choose one over the other. It is important to understand
these products’ capabilities and choose the one that meets your DMZ infrastructure perfor-
mance needs and maintains a high level of security, one that you are comfortable supporting.
Reading this chapter, you will learn how to design and build a DMZ using Cisco’s PIX
and ASA ﬁrewalls. We will advise you on the features of the PIX and the ASA, guide you in
the selection of the appropriate PIX and ASA hardware, and discuss different ﬁrewall
arrangements, as well as direct you on how to conﬁgure your ﬁrewall to securely pass trafﬁc.
By the end of this chapter you should be able to decide whether the PIX or ASA is the
right ﬁrewall for your DMZ infrastructure and, if you choose it, be able conﬁgure, manage,
and support the PIX and ASA.
PIX and ASA Basics
Cisco’s PIX ﬁrewall is one of the industry’s best-selling ﬁrewalls, providing customers with
high levels of security, performance, and reliability. PIX, which stands for Packet Internet
Exchange, was developed by Network Translation, Inc., in 1994 and purchased by Cisco in
October 1995.The PIX ﬁrewall is a network appliance that does not use a general operating
system like UNIX or Windows; therefore, inherent weaknesses in these operating systems
will not degrade the ﬁrewall’s overall security.The PIX utilizes the Adaptive Security
Algorithm (ASA) to analyze every inbound packet, ensures that the network you are pro-
tecting is secure, and allows only legitimate trafﬁc to pass through it. Some other features
include Network or Port Address Translation (NAT or PAT), URL ﬁltering, content ﬁl-
tering, IPSec VPN tunneling, and intrusion detection.
In 2005 Cisco released a new product to its ﬁrewall security product portfolio known as
the Cisco Adaptive Security Appliance (ASA, not to be confused with the Adaptive Security
Algorithm).The ASA is built on the same basic foundation as the Cisco PIX ﬁrewall,
including running the same basic software (known as the PIXOS). However, unlike the PIX,
which is designed as a purpose-driven ﬁrewall, the ASA is designed as a multifunction secu-
rity device by incorporating not only the same basic PIX ﬁrewall functionality but advanced
application inspection capabilities through integrated intrusion prevention system function-
ality as well as integrated ﬂexible VPN connectivity. In a manner of speaking, the Cisco ASA
combines the functionality of the PIX ﬁrewall, the IPS 4200 Intrusion Prevention System
www.syngress.com
208
Chapter 6 • Firewall Design: Cisco PIX and ASA

(IPS), and the VPN 3000 VPN Concentrator into a single device, allowing the ASA to ﬁlter
trafﬁc through the use of traditional access control lists as well as through the use of the
advanced application ﬁltering capabilities of an IPS. In many ways it appears that Cisco is
ultimately positioning the ASA as the logical replacement of the PIX ﬁrewall.
Cisco provides a complete line of PIX and ASA ﬁrewalls to meet your DMZ require-
ments, ranging from small ofﬁce/home ofﬁce (SOHO) to carrier-class ﬁrewalls.The entire
PIX and ASA line uses the same security algorithm but varies in performance, number of
interfaces supported, and interface types.Additionally, the ASA can utilize the IPS function-
ality to ﬁlter based on signatures and trafﬁc-matching patterns deﬁned in the IPS engine.
Depending on the chassis and license agreement, the PIX can support up to 10 interfaces;
the ASA can support up to 12 interfaces (eight of which can be active at any given time).
Additionally, the PIX can support up to 150 virtual interfaces (VLANs), whereas the ASA
supports up to 200 virtual interfaces, allowing the DMZ architect to design a large DMZ
infrastructure. Cisco’s PIX and ASA ﬁrewall line gives you the ﬂexibility to support your
DMZ infrastructure’s needs, no matter its size, complexity, or budget.
As with all Cisco products, hardware and software failures within the PIX and ASA are
rare, but they can happen.The PIX and ASA both offer high availability via either
Active/Active or Active/Standby failover features.This means that a second PIX or ASA can
provide stateful hot standby redundancy, which can maintain current open sessions so that
users won’t notice that the primary unit has failed. In an Active/Standby scenario, the second
ﬁrewall is not used at all, remaining in a standby state in the event of a failure. In an
Active/Active scenario, the two ﬁrewalls can be used for different functionality (for example,
housing different DMZ segments), with the functionality contained in one ﬁrewall failing
over to the other ﬁrewall only in the event of a failure.This setup has the beneﬁt of not
having a ﬁrewall sitting around unused except in the event of a failure.The PIX and ASA
security features, purpose-built operating system, long mean time between failures (MTBF),
resiliency, and low cost make them some of the most popular ﬁrewalls.
NOTE
To avoid confusion as you read this chapter, we use the terms PIX/ASA or ﬁre-
wall when we refer to functionality or information that is the same for both
devices. Where device-speciﬁc information needs to be called out, the device in
question (PIX or ASA) is speciﬁcally mentioned.
Securing Your Network Perimeters
The PIX/ASA is a powerful and versatile tool for securing your network. It can be used to
secure your internal network from external parties—for example, with Internet connections
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
209

to third parties and business partners.The PIX/ASA can also be used on the internal net-
work to protect sensitive data, not only from outside parties but also from unauthorized
employees or from employees who might have malicious intent.This book focuses on the
network perimeter and the DMZ, but some of the same designs and security features can
also be used internally.
The Cisco Perimeter Security Solution 
The PIX/ASA provides the DMZ architect with a variety of design possibilities. In the next
section, we go through several design possibilities, including a traditional “three-legged” ﬁre-
wall, a multi-DMZ infrastructure using physical interfaces, a multi-DMZ infrastructure using
virtual interfaces, and a dual-ﬁrewall DMZ infrastructure using an external and an internal
ﬁrewall. We also discuss adding ﬁrewall redundancy so that a single ﬁrewall failure would not
bring down the entire infrastructure.
Three-Legged Firewall
The most commonly implemented DMZ design in many small and medium-sized corpora-
tions is the traditional “three-legged” ﬁrewall.This design meets the needs of a site or sites in
which internal users require the ability to access the Internet securely as well as send e-mails,
access a locally hosted company Web site, or transfer ﬁles. Figure 6.1 shows how the tradi-
tional “three-legged” ﬁrewall ﬁts into the network.The internal interface of the PIX ﬁrewall
allows internal users to access both the DMZ and the Internet.The external interface con-
nects the PIX/ASA to your local ISP router.The DMZ interface is where Web, FTP, e-mail
relay servers, and any other services that the Internet community needs to access are located.
This design is very effective for low- to medium-trafﬁc volume DMZ infrastructures that do
not require high availability and can afford to have extended downtime in the event of a
ﬁrewall failure. Remember, if the ﬁrewall is down, internal users will not be able to access
the Internet, and DMZ services will not be accessible to the Internet community until the
ﬁrewall is serviced.
If high availability is required, the DMZ architect can consider adding a second
PIX/ASA in conjunction with the PIX/ASA’s failover feature, which allows the secondary
PIX/ASA ﬁrewall to back up the primary PIX/ASA in the event of a failure. Figure 6.2
shows how redundancy can be added to the traditional “three-legged’’ ﬁrewall design.This
design is ideal for corporations of all sizes, where the Internet/DMZ infrastructure is essen-
tial to the business and therefore the organization cannot afford downtime and requires a
resilient, highly available solution. Both the primary and secondary PIX/ASA ﬁrewalls need
to be identical models and have the same interface options. Each PIX/ASA will have an
interface on the internal, external, and DMZ LANs. When set up as a redundant pair, the
PIX/ASA has the ability to detect problems within the units or on any one of the interfaces
and automatically fail over to the backup unit.The PIX/ASA offers the option of stateful
failover, which means that any open sessions on the primary unit will be automatically trans-
www.syngress.com
210
Chapter 6 • Firewall Design: Cisco PIX and ASA

ferred to the secondary unit without client sessions disconnecting, so the failure is trans-
parent to end users. For the PIX/ASA to support failover, some additional hardware is
required, such as an additional interface to support the optional stateful failover feature and a
Cisco proprietary cable for heartbeats between the primary and secondary units. We discuss
the PIX/ASA failover feature and its requirements in detail later in this chapter.
Figure 6.1 A Traditional “Three-Legged” Firewall
Figure 6.2 A Traditional “Three-Legged” Firewall with Redundancy
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
211
Internal LAN
DMZ
Web
Server
E-Mail
Server
FTP
Server
Users
Internet
Internet
Router
PIX
Internal LAN
DMZ
Web
Server
E-Mail
Server
FTP
Server
Users
Internet
Primary Pix
Secondary
Pix
Internet
Router

Multi-DMZ Infrastructure Using Physical Interfaces
When you’re given the task of building a DMZ in a large DMZ environment or when you
need to support multiple service types, it might be desirable to separate them by adding
additional “legs” to the DMZ.There are two reasons you might want to use a DMZ leg:
■
An additional leg might be necessary if the number of servers has exceeded the
number of available IP addresses for hosts on the DMZ subnet. By adding a DMZ
interface, you can assign another IP range and add more servers.
■
It’s a good idea to separate service types onto different DMZ segments. Service
types are Web, FTP, e-mail, DNS, VPN, and remote access.
For example, Figure 6.3 shows a multiple-DMZ environment with Web servers, e-mail
relays, and FTP servers on the ﬁrst DMZ leg (DMZ 1) and services such as VPN and dial-in
user access on a second DMZ leg (DMZ 2).This setup separates the functions of the DMZs.
DMZ 1 supports services that are publicly available over the Internet, such as the company’s
Web site. DMZ 2 supports remote users accessing resources on the internal LAN via a dial-
in or VPN. By making remote users traverse the PIX/ASA, we make the internal LAN envi-
ronment secure because rules can be set up to restrict remote user access.Adding DMZ legs
helps keep the ﬁrewall rulesets manageable, especially when each DMZ has different access
requirements. It also isolates any errors in conﬁguration, because a change on an access con-
trol list (ACL) for one DMZ will not affect the ACL of another DMZ interface.
Figure 6.3 A Multi-DMZ Infrastructure
www.syngress.com
212
Chapter 6 • Firewall Design: Cisco PIX and ASA
Internal LAN
DMZ 1
Web
Server
E-Mail
Server
FTP
Server
User
s
Internet
DMZ 2
Internet
Router
PIX
PSTN
VPN Concentrator
Remote Access
Server

You can add redundancy by adding a secondary PIX/ASA, similar to the redundant tra-
ditional “three-legged’’ ﬁrewall design. One of the additional beneﬁts you can take advantage
of in a redundant ﬁrewall design with multiple-DMZ segments is an Active/Active failover.
In an Active/Active scenario, each ﬁrewall is actively used for functionality.This traditionally
occurs by assigning each DMZ segment to a different ﬁrewall as the primary ﬁrewall to use.
So for example, DMZ1 would be assigned to Firewall1, and DMZ2 would be assigned to
Firewall2. In this example, DMZ1 would only fail over to Firewall2 in the event that there
was a failure with Firewall1.This approach provides the advantage of being able to run ser-
vices across both ﬁrewalls, effectively load balancing services while at the same time pro-
viding full redundancy and failover for all network segments. We discuss the PIX/ASA
failover feature and its requirements in detail later in this chapter.
A Multi-DMZ Infrastructure Using Virtual Interfaces
A multi-DMZ infrastructure using virtual interfaces is functionally the same as any other
multi-DMZ infrastructure. However, in a physical infrastructure you are limited in the
number of DMZ segments that can be created by the number of physical interfaces the ﬁre-
wall supports. If you need more DMZ segments, you need to purchase additional ﬁrewalls
(and absorb all the related costs, such as maintenance and upkeep). With the latest versions of
the PIX/ASA software, you can create virtual interfaces that each belong to a different
VLAN.This potentially allows for the creation of hundreds of DMZ segments (with each
DMZ segment belonging to a unique VLAN). Building on the example in Figure 6.3, then,
you could further segment either physical segment into multiple logical segments. So, for
example, DMZ1 could be further segmented into a DMZ for Web services, a DMZ for FTP
services, and a DMZ for e-mail services. DMZ2 could then be separated into a DMZ for
remote access and a DMZ for VPN access. Each logical interface has its own unique ACLs
and rulesets, allowing each ruleset to be managed independently.This approach allows for a
much more granular degree of control over the types of trafﬁc that need to be allowed into
any given DMZ segment.
Keep one cautionary statement in mind regarding virtual interfaces: For virtual interfaces
to be used effectively, the switch that the ﬁrewall is connected to must support the use of
VLANs, to isolate trafﬁc.This setup is less secure than using separate physical switches,
because it is possible for trafﬁc to cross VLANs without going through the ﬁrewall. With
separate physical switches, that scenario is not possible, because the switches have no connec-
tion other than going through the ﬁrewall.This type of vulnerability is typically known as a
VLAN-hopping attack.Although it is not a trivial task to perform and it is extremely rare for
such an attack to be successful, it is within the realm of possibility, so it is something to con-
sider.A highly secure environment should probably not use any virtual interfaces, whereas
most other environments could potentially take advantage of this functionality. Because of
the potential security implications of using VLANs in a DMZ environment, it is recom-
mended that you only use VLANs for DMZs of similar security levels. So, for example, it
might be appropriate to separate your Web, FTP, and e-mail trafﬁc into distinct VLANs
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
213

because they are all at a similar security level.You would not want to separate your internal
network and any of your DMZ networks using virtual interfaces and VLANs, however,
because they have dramatically different security levels, and if an attack was successful, the
attacker could potentially gain access to more valuable internal resources.
A Dual-Firewall DMZ Infrastructure 
Using External and Internal Firewalls
The designs we’ve discussed previously are ideal for standard, multipurpose DMZ environ-
ments, but the internal/external ﬁrewall design (see Figure 6.4) is intended for the speciﬁc
purpose of supporting an e-commerce site for which various levels of security are required.
Large e-commerce sites separate the servers’ functions into three components, consisting of a
Web server cluster, an application server cluster, and a database cluster, most commonly
known as a three-tier design. In this design, Internet users accessing an e-commerce site
interact with only the Web servers on DMZ1.The job of the Web server is to be the front-
end GUI for the e-commerce site.The Web servers in turn call on the application servers on
DMZ2 to provide content.The application servers’ job is to collect the information the user
is requesting and provide content back to the Web server for the user to view.
The application server requests information by making SQL calls to the database servers
on DMZ3, which houses the site’s data. Each component has a different security require-
ment, which allows only necessary communication among DMZ1, 2, and 3.The external
PIX/ASA only allows users to access the Web site on DMZ1 via HTTP or HTTPS (SSL-
enabled HTTP).The user community will not need to access any other part of the site,
because the Web server will serve all the necessary content to the users; therefore, access is
restricted to DMZ1.The external PIX/ASA will allow the Web servers to make requests to
only the application servers on DMZ2 for content. DMZ2 is located between the internal
and external ﬁrewall sets, with a Layer 3 switch acting as the default gateway for DMZ2 as
well as routing trafﬁc though this environment.The internal ﬁrewall only allows the applica-
tion servers to send SQL requests to the database servers located on DMZ3.The internal
ﬁrewall also allows administrators on the internal LAN to manage the e-commerce environ-
ment. For simplicity, Figure 6.4 does not show redundancy, but the internal and external
PIX/ASA ﬁrewalls can be set up with failover. With the layered security approach, this solu-
tion provides a highly scalable and secure design that makes it difﬁcult for hackers to com-
promise.
Since this is a Cisco-centric chapter, the ﬁgure depicts PIX/ASA ﬁrewalls being used for
both the internal and external ﬁrewalls. From a security perspective it is generally recom-
mended that you use two different manufacturers and models of ﬁrewall for the internal and
the external ﬁrewalls, to help reduce the likelihood of a successful attack against both types
of ﬁrewall. It is common to implement the PIX/ASA for the external ﬁrewall while using a
more advanced application proxy ﬁrewall such as Microsoft ISA Server 2004, Secure
Computing Cyberguard TSP, or Secure Computing Sidewinder G2 for the internal ﬁrewall.
www.syngress.com
214
Chapter 6 • Firewall Design: Cisco PIX and ASA

NOTE
To understand the trafﬁc ﬂows of the DMZ design just described, you should
look closely at Figure 6.4 and follow the trafﬁc patterns from host to host. It is
imperative that when you design a DMZ, you follow the notes listed here;
always draw your scenario and plan it logically before you implement it physi-
cally. Because deploying a DMZ scenario is no easy task, your deployment will
go more smoothly if you follow this advice. 
Figure 6.4 An Internal/External Firewall Sandwich
Cisco PIX/ASA Versions and Features
Cisco’s PIX/ASA ﬁrewall solution provides several different chassis, software features, and
licensing and interface options. In this section, we cover in detail the PIX and ASA hard-
ware, features, and options that will help you decide whether the PIX or ASA will provide
functionality and performance to meet your DMZ requirements.
Cisco PIX Firewalls 
The PIX ﬁrewall line consists of ﬁve models, ranging from the SOHO model, PIX 501, to
the high-performance service provider model, PIX 535.To determine the PIX to choose for
your needs, you must ﬁrst identify the requirements of your enterprise’s Internet and DMZ
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
215
Internal LAN
DMZ 1
Web
Server
Users
Internet
External Pix
Internet
Router
Internal
Pix
DMZ 2
Database
Server
VLAN 10
VLAN 30
VLAN 20
L3 Switch
Application
Server
DMZ 3
Database
Server
Database
Server
Web
Server
Web
Server
Application
Server
Application
Server

infrastructure.To choose the proper ﬁrewall, you need to know some basic information: the
number of DMZs (legs or interfaces) the ﬁrewall needs, approximate throughput required,
number of users accessing resources through the ﬁrewall, and whether redundancy is
required.
Once you have collected the requirements and have decided on a design, it’s time to
select the proper hardware that will protect your DMZ infrastructure. With the release of the
PIX 7.0 software, the PIX ﬁrewall operating system is slightly different for the various PIX
models.The PIX 501 and PIX 506E ﬁrewalls do not support the PIX 7.0 software release.
That means that although all the PIX software versions have the same interface and share
probably 90 percent of the same commands and functionality (so features such as NAT, URL
ﬁltering, content ﬁltering, and VPN tunneling can be found across the entire line, depending
on the software license purchased), some speciﬁc pieces of functionality are unique to the
PIX 7.0 software. We will talk about those software differences later in this chapter. Notice
that the basic differences between the models mostly deal with the chassis interface options,
performance, and cost.
The next section details the ﬁve PIX model types and presents the information you
need to choose the right chassis for your DMZ infrastructure.
The Cisco PIX 501 Firewall 
The Cisco PIX 501 is an entry-level ﬁrewall designed to meet the needs of small or home
ofﬁces.The PIX 501 provides SOHO users with the same security level and features as its
bigger brothers, but performance is limited.The PIX 501 can support an unlimited number
of users concurrently and incorporates a four-port 10/100Mb switch, so home users with
broadband service can easily set up a network without purchasing an additional switch.The
PIX 501 has a ﬁxed chassis and cannot be upgraded to support additional interfaces, so it
does not have the capability to add a third leg (or DMZ leg).
The PIX 501 is strictly designed to be a plug-and-play ﬁrewall for very small networks
that have broadband access and want to securely access the Internet as well as connect to a
central or regional ofﬁce via a VPN tunnel. It is not designed to support a DMZ infrastruc-
ture.
Key items of the PIX 501 ﬁrewall include the following:
■
A 10-user license allows 10 internal IP addresses to access the Internet simultane-
ously, and the DHCP server feature supports up to 32 DHCP address assignments
■
A 50-user license allows 50 internal IP addresses to access the Internet simultane-
ously, and the DHCP server feature supports up to 128 DHCP address assignments
■
An unlimited user license allows an unlimited number of users to access the
Internet simultaneously
■
Fixed chassis, integrated four-port switch 10/100Mbps plus one Internet-facing
10/100Mbps port
www.syngress.com
216
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
A 133MHz processor, 16MB RAM, and 8MB Flash
■
Does not support the PIX 7.0 software; at the time of writing, the most recent
software version available is the PIX OS 6.3(5)
■
60Mbps clear-text throughput
■
Optional encryption licenses are necessary if 168-bit 3DES or 56-bit DES VPN
tunnels are needed
■
6Mbps DES VPN throughput
■
3Mbps 3DES VPN throughput
■
4.5Mbps 128-bit AES VPN throughput
■
3.4Mbps 256-bit AES VPN throughput
■
Ten VPN peers
■
Small chassis (not rack mountable) 
The Cisco PIX 506E Firewall 
The Cisco PIX 506E, the next level up from the 501, is designed to meet the needs of a
remote or branch ofﬁce. Unlike the 501, it is sold only with an unlimited license restriction
that does not limit the number of users concurrently traversing the PIX.The 506E has a
clear-text throughput of 100Mbps, which means you will probably max out the Internet
connection at the remote site before the PIX becomes oversubscribed.This model supports
no speciﬁc number of users because turning on features such as VPN tunneling or intrusion
detection can reduce overall throughput.
As a guideline, you should not have more than 250 light to moderate Internet users, and
if you need VPN tunneling, this number should be reduced further.The PIX 506E is also a
ﬁxed chassis and cannot be upgraded to support additional interfaces, so it does not have the
capability to add a third leg (or DMZ leg). It does, however, support two virtual interfaces,
allowing for the creation of up to two DMZs through the use of virtual interfaces and
VLANs.This model has two embedded 100BaseT Ethernet ports, which allow for an
internal (protected) interface and an external (Internet-facing) interface.
The PIX 506E is ideal for a small to medium-sized remote or branch ofﬁce that requires
secure Internet connectivity. It also has greater VPN performance that allows for 25 VPN
peers. Not only can a VPN tunnel connect the remote/branch site to a central site, but it
can also accept remote users to VPN directly to ofﬁce.
Key characteristics of the PIX 506E ﬁrewall include the following:
■
No user restriction license 
■
Fixed chassis, two embedded 10/100Mbps interfaces (internal/Internet facing)
■
Two virtual interfaces
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
217

■
A 300MHz processor, 32MB SDRAM, and 8MB Flash
■
Does not support the PIX 7.0 software; at the time of writing, the most recent
software version available is the PIX OS 6.3(5)
■
100 Mbps clear-text throughput
■
An optional encryption license is necessary if 168-bit 3DES or 56-bit DES VPN
tunnels are needed
■
20Mbps DES VPN throughput
■
16Mbps 3DES VPN throughput
■
30Mbps 128-bit AES VPN throughput
■
25Mbps 256-bit AES VPN throughput
■
Twenty-ﬁve VPN peers
■
Small chassis (not rack mountable) 
NOTE
It is important that you know the differences between the PIX ﬁrewall versions.
This knowledge is imperative to solid DMZ design, because some models simply
can’t be used to create a DMZ, and you don’t want to waste your money or
your time researching what you do not need. It is clear, however, that if you
want to deploy a DMZ segment, your efforts must start with the PIX 515E. 
The Cisco PIX 515E Firewall 
Previously, we talked about the lower-end Cisco PIX ﬁrewalls, which are ﬁxed models, sup-
port a small to intermediate number of users, and are not capable of supporting a traditional
DMZ. Now let’s discuss Cisco’s enterprise-level ﬁrewall, which is modular, more powerful,
and supports additional/multiple interfaces where a traditional DMZ can reside.
The Cisco PIX 515E, the ﬁrst model in the modular line of PIX ﬁrewalls, is designed
for small to medium-sized businesses but if scaled properly can also be used in larger organi-
zations.The PIX 515E has two embedded 10/100 Ethernet interfaces and can accommodate
a variety of interface types, including one- or four-port Fast Ethernet interface cards (used to
create the DMZ ports) and/or a VPN accelerator card+ (VAC+) via two internal PCI slots.
As we mentioned, optional modules inserted into the PIX 515E can be conﬁgured to sup-
port a DMZ by adding one- or four-port Fast Ethernet interface cards used to create DMZ
legs.The VAC can allow moderate-volume mobile users to remotely access corporate
resources or connect remote sites to headquarters via site-to-site IPSec VPN tunnels.The
www.syngress.com
218
Chapter 6 • Firewall Design: Cisco PIX and ASA

PIX 515E provides the security, performance, versatility, and cost that make it very popular
among network security and DMZ architects.
The PIX 515E is versatile enough to support a signiﬁcant number of users as well as a
DMZ environment that contains Web, e-mail, and FTP servers with volume that will not
exceed its 190Mbps throughput.This is adequate for sites that have dual T3s (45Mbps each)
or less to the Internet.You might ask,“Two T3s account for 90Mbps total, and it’s only half
the PIX’s 190Mbps limitation?” It must be understood that dual T3s will push 90Mbps in
each direction, accounting for 180Mbps of total throughput. However, if you are averaging
70 percent or more utilization or looking for scalability (if plans call for adding a T3 in the
future), you should consider upgrading or choosing another chassis such as the PIX 525.
Key characteristics of the PIX 515E ﬁrewall include the following:
■
License choices are Restricted with a Single DMZ and Unrestricted with Failover
(Active/Active or Active/Standby)
■
Modular chassis consists of two embedded 10/100 Ethernet ports and two PCI
slots (32-bit/33MHz) for optional Fast Ethernet ports or VAC
■
Maximum of six Fast Ethernet ports (including the two embedded 10/100
Ethernet ports); this is limited to three (including the two embedded 10/100
Ethernet ports) with the Restricted/DMZ license
■
Ten (restricted) or 25 (unrestricted) virtual interfaces
■
A 433MHz processor, 64MB (Restricted) or 128MB (Unrestricted) of SDRAM,
and 16MB Flash
■
190Mbps clear-text throughput
■
130, 000simultaneous sessions
■
Five security contexts
■
Optional encryption license is necessary if 168-bit 3DES or 56-bit DES VPN tun-
nels are needed
■
20Mbps (Restricted) or 63Mbps (Unrestricted w/VAC) or 135Mbps (Unrestricted
with VAC+) 3DES VPN throughput
■
130Mbps with VAC+ 128-bit AES VPN throughput
■
130Mbps with VAC+ 256-bit AES VPN throughput
■
2,000 VPN tunnels
■
Active/Active and Active/Standby Failover (Unrestricted and Failover)
■
Rack-mountable chassis (one rack unit)
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
219

NOTE
As with all networking hardware, you need to have a good idea of the type and
amount of trafﬁc traversing your network as well as future growth before you
can decide to purchase a particular type of hardware. This practice is known as
doing a trafﬁc-ﬂow analysis on your network segments. Remember, PIX
throughput can be adversely affected by turning on features such as NAT, PAT,
VPN, intrusion detection, and so on. Keep this in mind when you’re sizing your
ﬁrewall.
The Cisco PIX 525 Firewall 
The Cisco PIX 525 ﬁrewall is designed to secure large enterprise locations and DMZs with
high-volume Web trafﬁc. In addition to the increased throughput, the PIX 525 also can
accommodate a wider variety of interface types, including Fast Ethernet, Gigabit Ethernet,
and/or a VAC+.The PIX 525 has two embedded 10/100 Ethernet interfaces and is the ﬁrst
model in the PIX line that supports the optional Gigabit Ethernet interface.The PIX 525’s
capability of supporting up to eight Fast Ethernet interfaces also gives the DMZ architect
the freedom to cost-effectively scale the DMZ.
The PIX 525 is ideal for enterprises with large user populations and moderate to heavy
Internet access requirements and/or that have DMZ environments requiring signiﬁcant
throughput (not exceeding 370Mbps).With the optional VAC installed, it can also serve as
the head end for a remote user VPN and/or a site-to-site VPN WAN, where some or all of
your remote sites can be connected to the central enterprise location via IPSec VPN tunnels.
Key characteristics of the PIX 525 ﬁrewall include the following:
■
License choices are Restricted and Unrestricted with Failover (Active/Active or
Active/Standby)
■
The modular chassis consists of two embedded 10/100 Ethernet ports and three
PCI slots (32-bit/33MHz) for optional Fast Ethernet ports, Gigabit Ethernet, or
VAC 
■
A maximum of ten 10/100 interfaces (including the two embedded 10/100
Ethernet ports) or 3 Gigabit Interfaces in addition to the two embedded 10/100
Ethernet Ports
■
25 (restricted) or 100 (unrestricted) virtual interfaces
■
A 600MHz Processor, 128MB (Restricted) or 256MB (Unrestricted) of SDRAM,
and 16MB Flash
■
330Mbps clear-text throughput
www.syngress.com
220
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
500, 000 simultaneous sessions
■
Up to 50 security contexts (unrestricted license only)
■
Optional encryption license is necessary if 168-bit 3DES or 56-bit DES VPN tun-
nels are needed
■
30Mbps (Restricted) or 70Mbps (Unrestricted with VAC) or 145Mbps
(Unrestricted with VAC+) 3DES VPN throughput
■
135Mbps with VAC+ 128-bit AES VPN throughput
■
135Mbps with VAC+ 256-bit AES VPN throughput
■
2,000 VPN tunnels (Unrestricted with VAC+)
■
Active/Active and Active/Standby Failover (Unrestricted and Failover)
■
Rack-mountable chassis (two rack units)
The Cisco PIX 535 Firewall 
The PIX 535 is Cisco’s top-of-the-line ﬁrewall, providing the greatest performance and
interface versatility designed for the service provider market.The PIX 535 has over two and
a half times more throughput than its predecessor, with clear-text throughput reaching
1.7Gbps.The PIX 535 has nine PCI slots, which can support up to 10 Fast Ethernet inter-
faces, nine Gigabit Ethernet interfaces, a VAC, or a combination of the three.The PIX 535,
with an unrestricted license, can support up to 14 interfaces, but you must consult the docu-
mentation before combining interfaces, to determine the number of interface types that can
work together.This process can be quite tricky and could cause the ﬁrewall not to boot
properly.You can ﬁnd more information about installing a PCI card into the PIX 535 at
www.cisco.com/univercd/cc/td/doc/product/iaabu/pix/pix_v53/inst-535/board.htm.
The PIX 535 is ideal for Internet service providers or enterprise locations that offer ser-
vices to a very large user community, including support for a huge DMZ trafﬁc load.As with
the PIX 525, you can install an optional VAC in the PIX 535, and it can also serve as the
head end for a remote user VPN and/or a site-to-site VPN WAN, where some or all your
remote sites can be connected to the central enterprise location via IPSec VPN tunnels.
Key characteristics of the PIX 535 ﬁrewall include the following:
■
License choices are Restricted and Unrestricted with Failover (Active/Active or
Active/Standby)
■
The modular chassis consists of nine PCI slots (four 64-bit/66MHz and ﬁve 32-
bit/33MHz) for optional Fast Ethernet ports, Gigabit Ethernet, or VAC 
■
Offers a maximum of 14 interfaces
■
50 (restricted) or 150 (unrestricted) virtual interfaces
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
221

■
A 1000MHz processor, 512MB (Restricted) or 1024MB (Unrestricted) of
SDRAM, and 16MB Flash
■
1.7Gbps clear-text throughput
■
500,000 simultaneous sessions
■
Up to 50 security contexts (unrestricted license only)
■
An optional encryption license is necessary if 168-bit 3DES or 56-bit DES VPN
tunnels are needed
■
45Mbps (Restricted) or 100Mbps (Unrestricted with VAC) or 425Mbps
(Unrestricted with VAC+) 3DES VPN
■
495Mbps with VAC+ 128-bit AES VPN throughput
■
425Mbps with VAC+ 256-bit AES VPN throughput
■
2,000 VPN tunnels (Unrestricted with VAC)
■
Active/Active or Active/Passive Failover (Unrestricted and Failover)
■
Redundant power supplies
■
Rack-mountable chassis (three rack units)
Cisco ASA Firewalls 
This Cisco ASA ﬁrewall line consists of ﬁve hardware models that range from a SOHO
model, the ASA 5505, to the high-performance service provider model,ASA 5550.The
Cisco ASA ﬁrewall line also differs from the PIX ﬁrewall line in that in addition to the
actual hardware models, each model can be further ﬁne tuned into one of ﬁve different tai-
lored packages (known as editions) that are designed to meet location-speciﬁc needs.The two
broad categories of edition are the Enterprise Edition and the Business Edition.The
Enterprise Edition is further broken down into four location-speciﬁc editions: the Firewall
Edition, the IPS Edition, the Anti-X Edition, and the VPN Edition.These editions are
offered as either bundles of each speciﬁc ASA model or through the use of a la carte pricing
and the implementation of speciﬁc hardware modules in conjunction with software licensing
and conﬁguration.An ASA can functionally provide the services of any edition in and of
itself, or it can be conﬁgured as a combination of the four Enterprise Editions (excluding
combining the IPS and Anti-X editions, since only one Security Services Module (SSM) can
be installed at a time). Here are some details:
■
Firewall Edition The Firewall Edition is the base edition for all Cisco ASA ﬁre-
walls.The Firewall Edition essentially provides the same base ﬁrewall functionality
that would be provided by a Cisco PIX ﬁrewall running the 7.0 PIX software. For
all intents and purposes, an ASA running the Firewall Edition is functionality
interchangeable with a PIX ﬁrewall.
www.syngress.com
222
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
IPS Edition The IPS Edition is designed to provide advanced inspection capabil-
ities to a base ASA through a combination of software licensing and the Advanced
Inspection and Prevention Security Services Module (AIP-SSM).There are two
models of AIP-SSM: the SSM-AIP-10, which is designed for the ASA 5510 and
the ASA 5520, and the SSM-AIP-20, which is designed for the ASA 5520 and the
ASA 5540.The IPS Edition cannot be combined with the Anti-X Edition.
■
Anti-X Edition The Anti-X Edition is designed to provide advanced ﬁltering of
network threats including viruses, worms, spyware, spam, and phishing while con-
trolling unwanted e-mail and Web content. Like the IPS Edition, the Anti-X
Edition functionality is provided through a combination of software licensing and
the Content Security and Control Security Services Module (CSC-SSM).The
CSC-SSM utilizes integrated Trend Micro software functionality to provide the
appropriate content-ﬁltering functionality.There are two models of the CSC-SSM:
the CSC-SSM-10, which is designed for the ASA 5510 and the ASA 5520, and the
CSC-SSM-20, which is designed for the ASA 5510,ASA 5520, and ASA 5540.
The Anti-X Edition cannot be combined with the IPS Edition.
■
VPN Edition The VPN edition is designed to provide highly dense VPN con-
nectivity to the ASA ﬁrewall through the use of software licensing.This allows an
ASA to support up to 5000 VPN peers.The VPN Edition is designed, by and
large, to replace the functionality provided by the Cisco VPN 3000 series concen-
trators.
■
Business Edition The Business Edition is targeted at the small to medium-sized
business (SMB) segment and combines ﬁrewall, VPN, and anti-X capabilities into
the ASA 5510. Essentially, the Business Edition is an ASA 5510 with the CSC-
SSM module installed.
To determine the ASA to choose for your needs, you must ﬁrst identify the require-
ments of your enterprise’s Internet and DMZ infrastructure as well as whether you have any
location-speciﬁc needs such as anti-X or IPS functionality.To choose the proper ﬁrewall, you
need to know some basic information: the number of DMZs (legs or interfaces) the ﬁrewall
needs, approximate throughput required, number of users accessing resources through the
ﬁrewall, and whether redundancy is required.
Once you have collected the requirements and have decided on a design, it’s time to
select the proper hardware that will serve to protect your DMZ infrastructure.The ASA ﬁre-
walls use the same operating system and, if conﬁgured with a speciﬁc edition, run the same
edition-speciﬁc software.This means that all the ASA software versions have the same inter-
face and share the same commands and functionality (so features such as NAT, URL ﬁl-
tering, content ﬁltering, and VPN tunneling can be found across the entire line, depending
on the software license purchased).Additionally, the edition-speciﬁc software is the same for
all models, so conﬁguring the IPS Edition software on an ASA 5510 is the exact same pro-
cess as conﬁguring an ASA 5540. Notice that the basic differences between the models
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
223

mostly deal with the chassis interface options, performance, and cost.The next section details
the four ASA model types and presents the information you need to choose the right chassis
for your DMZ infrastructure.
The Cisco ASA 5505 Firewall
The Cisco ASA5505 is the ﬁrst model in the line of ASA ﬁrewalls; however, it differs from
the rest of the ASA ﬁrewall product lines because it is not as modular as the rest of the ASA
ﬁrewalls tend to be.The ASA 5505 is a small form factor device, similar in size to the PIX
501 ﬁrewall.The ASA 5505 is designed for the SOHO environment and is perfect for users
such as telecommuters and very small remote ofﬁces.The ASA 5505 contains an eight-port
integrated switch with 2 power over Ethernet ports. Unlike the rest of the ASA ﬁrewall, the
ASA 5505 does not support the use of the SSM. Instead, it uses what is known as the
Security Services Card (SSC).As of this writing, there are no SSCs produced by Cisco, but it
is expected that the company will offer similar functionality to what is offered through the
larger SSMs.
The ASA 5505 is designed predominantly to support a small environment; however, it
does support up to three VLANs, one of which can be used as a restricted or fully functional
DMZ, depending on licensing. It is designed to support trafﬁc volumes not exceeding
150Mbps and supports 10 or 25 VPN peers, again depending on licensing.The ASA 5505 is
being positioned as the logical replacement for the Cisco PIX 501 ﬁrewall and is designed to
operate effectively in the same environments (while typically delivering better performance
than the PIX).
Key points of interest related to the ASA 5505 include the following:
■
License choices are the Base 5505 or the 5505 Security Plus, which provides for
stateless Active/Standby Failover
■
Quasi-modular chassis consists of an integrated eight-port 10/100 Ethernet switch
and one SSC expansion slot
■
Supports up to three virtual interfaces
■
256MB of SDRAM, and 64MB Flash
■
150Mbps clear-text throughput
■
10,000 or 25,000 simultaneous sessions (based on licenses)
■
10 to 25 IPSec VPN peers (based on licenses)
■
10 to 25 SSL VPN peers (based on licenses)
■
Up to 100Mbps 3DES/AES VPN throughput
■
Nonrack-mountable chassis 
www.syngress.com
224
Chapter 6 • Firewall Design: Cisco PIX and ASA

The Cisco ASA 5510 Firewall
The Cisco ASA 5510, the ﬁrst model in the modular line of ASA ﬁrewalls, is designed for
small to medium-sized businesses but if scaled properly can also be used in larger organiza-
tions.The ASA 5510 has ﬁve embedded 10/100 Ethernet interfaces. Depending on the
license, the ASA 5510 supports three interfaces and one out-of-band (OOB) management
interface (ASA 5510) or ﬁve interfaces (ASA 5510 Security Plus).The ASA 5510 also has a
Software Services Module (SSM) port allowing a CSC-SSM,AIP-SSM or a 4GE-SSM to be
installed.
The ASA 5510 is versatile enough to support a signiﬁcant number of users as well as a
DMZ environment that contains Web, e-mail, and FTP servers with volume that will not
exceed its 300Mbps throughput (150Mbps with the AIP-SSM-10).The ASA 5510 is logically
positioned as a replacement for the PIX 515E ﬁrewall and is designed to operate effectively in
the same environments (while typically delivering better performance than the PIX).
Key characteristics of the ASA 5510 ﬁrewall include the following:
■
License choices are the Base 5510 or the 5510 Security Plus, which provides for
Active/Standby Failover
■
Modular chassis consists of ﬁve embedded 10/100 Ethernet ports and one SSM
expansion slot
■
Maximum of ﬁve Fast Ethernet ports for the ASA 5510 Security Plus; this is lim-
ited to three with the ASA 5510
■
10 (5510) or 25 (5510 Security Plus) Virtual Interfaces
■
256MB of SDRAM, and 64MB Flash
■
300Mbps clear-text throughput
■
150Mbps of threat mitigation throughput with the AIP-SSM-10
■
130,000 simultaneous sessions (50,000 for the ASA 5510)
■
250 IPSec VPN peers
■
10 to 250 SSL VPN peers (based on licenses)
■
Up to 170Mbps 3DES/AES VPN throughput
■
Active/Standby Failover (ASA 5510 Software Plus)
■
Rack-mountable chassis (one rack unit)
The Cisco ASA 5520 Firewall
The Cisco ASA 5520 ﬁrewall is designed to secure large enterprise locations and DMZs
with high-volume Web trafﬁc.The ASA 5520 provides an increased throughput over the
5510 and generally supports a greater number of VPN clients.The ASA 5520 is also the ﬁrst
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
225

ASA that supports native gigabit network connectivity,Active/Active failover, and multiple
security contexts.
The ASA 5520 is ideal for enterprises with moderate to large user populations and mod-
erate to heavy Internet access requirements and/or that have DMZ environments requiring
signiﬁcant throughput (not exceeding 450Mbps).The ASA 5520 is designed as a logical
replacement for the PIX 515 or PIX 525 ﬁrewalls and is designed to operate effectively in the
same environments (while typically delivering better performance than the PIX).
Key characteristics of the ASA 5520 ﬁrewall include the following:
■
Modular chassis consists of four embedded 10/100/1000 Ethernet ports, one
embedded 10/100 Ethernet port, and one SSM expansion slot
■
100 virtual interfaces
■
Up to 10 security contexts
■
1024MB of SDRAM, and 64MB Flash
■
450Mbps clear-text throughput
■
375Mbps of threat mitigation throughput with the AIP-SSM-20 (225Mbps
throughput with the AIP-SSM-10)
■
4000,000 simultaneous sessions (50,000 for the ASA 5510)
■
750 IPSec VPN peers
■
Ten to 750 SSL VPN peers (based on licenses)
■
Up to 225Mbps 3DES/AES VPN throughput
■
Active/Standby or Active/Active Failover
■
VPN clustering and load balancing
■
Rack-mountable chassis (one rack unit)
The Cisco ASA 5540 Firewall
The Cisco ASA 5540 ﬁrewall is designed to secure large enterprise locations and DMZs
with high-volume Web trafﬁc.The ASA 5540 provides an increased throughput over the
5520 and generally supports a greater number of VPN clients, security contexts, and virtual
interfaces.
The ASA 5540 is ideal for large enterprises with large user populations and heavy
Internet access requirements and/or that have DMZ environments requiring signiﬁcant
throughput (not exceeding 650Mbps).The ASA 5540 is designed as a logical replacement for
the PIX 525 ﬁrewall and is designed to operate effectively in the same environments (while
typically delivering better performance than the PIX as well as the ASA 5520).
Key characteristics of the ASA 5540 ﬁrewall include the following:
www.syngress.com
226
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
Modular chassis consists of four embedded 10/100/1000 Ethernet ports, one
embedded 10/100 Ethernet port and one SSM expansion slot
■
200 Virtual Interfaces
■
Up to 50 Security Contexts
■
1024MB of SDRAM, and 64MB Flash
■
650Mbps clear-text throughput
■
450Mbps of threat mitigation throughput with the AIP-SSM-20
■
650,000 simultaneous sessions
■
5,000 IPSec VPN peers
■
10 to 2500 SSL VPN peers (based on licenses)
■
Up to 325Mbps 3DES/AES VPN throughput
■
Active/Standby or Active/Active Failover
■
VPN clustering and load balancing
■
Rack-mountable chassis (one rack unit)
The Cisco ASA 5550 Firewall
The Cisco ASA 5550 ﬁrewall is designed to secure large enterprise and service provider
locations and DMZs with high-volume Web trafﬁc.The ASA 5550 provides the largest
amount of throughput of any ASA and supports a greater number of VPN clients.The ASA
5550 also supports the largest number of interfaces of any ASA.The ASA supports a total of
12 interfaces, eight 10/100/1000 Ethernet interfaces and four Small Form-Factor Pluggable
(SFP) ﬁber interfaces (in addition to the 10/100 management interface). Of these 12 inter-
faces, only eight may be active at any given time.The ASA 5550 is designed to function as
either a ﬁrewall or a VPN concentrator and does not support running the AIP-SSM or the
CSC-SSM. (The SSM slot is actually ﬁlled with a combination four-port Gigabit Ethernet,
four-port SFP SSM expansion card.)
The ASA 5550 is ideal for extremely large enterprises or service providers with large
user populations and extremely heavy Internet access requirements and/or that have DMZ
environments requiring signiﬁcant throughput (not exceeding 1.2Gbps).
Key points of interest related to the ASA 5550 ﬁrewall include the following:
■
Modular chassis consists of eight embedded 10/100/1000 Ethernet ports, four
Small Form-Factor Pluggable (SFP) ﬁber interfaces, and one embedded 10/100
Ethernet port; only eight of the 10/100/1000 Ethernet or SFP interfaces can be
active at a time
■
200 virtual interfaces
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
227

■
Up to 50 security contexts
■
4096MB of SDRAM, and 64MB Flash
■
1.2Gbps clear-text throughput
■
Does not support the CSC-SSM or the AIP-SSM (the SSM slot contains a four-
port Gigabit Ethernet SSM)
■
650,000 simultaneous sessions
■
5,000 IPSec VPN peers
■
10 to 5000 SSL VPN peers (based on licenses)
■
Up to 425Mbps 3DES/AES VPN throughput
■
Active/Standby or Active/Active Failover
■
VPN clustering and load balancing
■
Rack-mountable chassis (one rack unit)
Cisco Firewall Software 
With the advent of the Cisco ASA ﬁrewalls as well as the two distinct version paths (the 6.x
version and the 7.x version) of the PIX Operating System (OS), it can be confusing to
understand which operating system will do what is required for an environment.The easiest
way to sort it all out is to look at the software features that are shared by all versions of the
ﬁrewall software (both PIX OS versions as well as the ASA OS) and then look at the features
supported by the ASA OS and the 7.x version of the PIX OS.
Common Firewall Software Features
All versions of the PIX and ASA operating system share the same core functionality because
they all come from the same base operating system (the PIX 6.x version OS).The PIX/ASA
OS is a feature-ﬁlled OS that provides a high level of security and performance. Because it is
designed solely for the purpose of securing your network infrastructure and has an OS
speciﬁcally built for it, it doesn’t have the weaknesses inherent to general OSs such as
Windows or UNIX. However, the PIX/ASA OS’s lack of a general OS does not mean that
the PIX/ASA has fewer features than its competitors.The PIX/ASA has a full set of security
features and, with its streamlined OS and specially designed hardware, it has the ability to
outperform many of its competitors.
Features include:
■
Purpose-built operating system Eliminates the weaknesses found in most 
general OSs.
www.syngress.com
228
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
Adaptive security algorithm (ASA) Method the PIX/ASA uses to provide
stateful packet ﬁltering, which analyzes each packet to ensure only legitimate
trafﬁc traverses the PIX/ASA.
■
URL ﬁltering Can limit URLs accessed by the user’s base on a policy deﬁned
by the network administrator or a security policy. Requires an external
Netpartner’s WebSense server or N2H2 server.This URL ﬁltering should not be
confused with the ﬁltering provided on the Cisco ASA ﬁrewall through the CSC-
SSM expansion module.
■
Content ﬁltering Can block ActiveX or Java applets.This content ﬁltering
should not be confused with the ﬁltering provided on the Cisco ASA ﬁrewall
through the CSC-SSM expansion module.
■
NAT and PAT Hides internal addressing from the Internet and makes more efﬁ-
cient use of private address space.
■
Cut-through proxy Authenticates users accessing resources through the
PIX/ASA.
■
VPN Capable of handling mobile user access and site-to-site VPNs utilizing
DES, 3DES, and AES encryption methods.
■
Intrusion detection Enables the PIX to protect against various forms of mali-
cious attack with features such as DNSGuard, FloodGuard, MailGuard, and
IPVerify as well as the ability to identify attacks via attack “signatures.”This intru-
sion detection should not be confused with the intrusion prevention provided on
the Cisco ASA ﬁrewall through the AIP-SSM expansion module.
■
DHCP Can act as a DHCP client and/or server.
■
Routing functionality  Can support static routes, RIP, and OSPF.
■
Support for RADIUS or TACACS+ Authenticating, authorizing, and
accounting for users passing through the PIX or to enabled authentication for
those connecting to the PIX’s management interfaces.
■
Failover Provides a resilient, high-availability solution in case of failure.
■
PPP over Ethernet (PPPoE) support Compatible with xDSL and cable
modems.
■
Common Criteria EAL4 Certiﬁcation Certain PIX OS versions have
achieved the highest level of certiﬁcation handed out by Common Criteria, an
independent international security organization.You can ﬁnd more information
about Common Criteria at www.commoncriteria.org.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
229

NOTE
In this chapter we have discussed how the PIX/ASA would provide stateful
inspection. Let’s take a closer look at this topic; it is very important to security
because stateful inspection provides a deeper level of ﬁltering than ACLs found
in routers, which may only ﬁlter based on header information. Firewalls that
perform stateful inspection analyze individual data packets as they traverse the
ﬁrewall. In addition to the packet header, stateful inspection also assesses the
packet’s payload and looks at the application protocol. It can ﬁlter based on the
source, destination, and service requested by the packet. The term stateful
inspection refers to the ﬁrewall’s ability to remember the status of a connection
and thereby build a context for each data stream in its memory. With this infor-
mation available to it, the ﬁrewall is able to make more informed policy deci-
sions as well as being able to dynamically permit the return trafﬁc of all
requests, without the need for an administrator manually deﬁning the ACL.
ASA and PIX 7.x Firewall Software Features
With the introduction of the PIX 7.x software line, Cisco took the PIX ﬁrewall in two dis-
tinct directions.The SOHO ﬁrewalls (PIX 501 and PIX 506E) remained on the 6.x software
base, while the enterprise class ﬁrewalls began supporting a more advanced base OS.
Additionally, the ASA ﬁrewalls were released with the ASA OS 7.x, which is virtually iden-
tical to the PIX OS 7.x software. Building on the features contained in the 6.x PIX software,
the ASA and PIX 7.x software included a number of additional features:
■
Layer 2 Transparent Firewall  Enables the ﬁrewall to operate in line with
existing network connections, without requiring any addressing or routing
changes.
■
Advanced Web Security Services  Enables deep inspection of Web trafﬁc,
giving administrators control over what HTTP commands and methods will be
allowed by the ﬁrewall.
■
Tunneling Application Control  Allows applications such as instant messenger
(such as AOL Instant Messenger, Microsoft Messenger and Yahoo Messenger) or
peer-to-peer ﬁle sharing applications (such as KaZaA and Gnutella) that tunnel
trafﬁc over HTTP to be blocked.
■
3G Mobile Wireless Security Services  Supports 3G Mobile Wireless services
using the General Packet Radio Service (GPRS) Tunneling Protocol standard
(GTP) while providing advanced GTP inspection to ﬁlter trafﬁc accordingly.
www.syngress.com
230
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
Enhanced Failover  In addition to the basic Active/Standby failover, supports
Active/Active standby failover, allowing both systems to simultaneously pass data.
■
VPN Stateful Failover  Provides Active/Standby stateful failover of VPN con-
nections to ensure that VPN connections are not terminated in the event of a
failover.
■
Security Contexts  Allows a single physical ﬁrewall to be treated as multiple log-
ical ﬁrewalls (security contexts).This allows each security context to have a unique
set of security policies, logical interfaces, and administrative domains.Also allows
multiple physical ﬁrewalls to be consolidated into a single physical appliance while
maintaining the separation of management and functionality between each security
context.
■
Virtual Interfaces  Supports the creation of VLAN-based virtual interfaces,
allowing a single physical interface to have multiple logical addresses, with each
virtual interface having a unique security policy.
ASA Firewall Software Features
Although the PIX and ASA OS share many features and functionalities, the ASA ﬁrewall
software supports some additional features and functionality through either the ASA OS itself
or additional software to support the AIP-SSM or CSC-SSM software.The AIP-SSM actu-
ally runs the Cisco Intrusion Prevention 5.x software to provide the IPS functionality, while
the CSC-SSM utilizes software from Trend Micro, known as Trend Micro InterScan, to pro-
vide the advanced content ﬁltering and anti-X functionality.
ASA-speciﬁc ﬁrewall software features include:
■
Advanced Intrusion Prevention  In conjunction with the AIP-SSM and the
Cisco Intrusion Prevention software, the ASA provides signature-based intrusion
prevention functionality, allowing the ASA to ﬁlter and block trafﬁc not only by
the security policy ruleset but based on the conﬁguration of the IPS.
■
Advanced Content Filtering and Anti-X Services In conjunction with the
CSC-SSM and the Trend Micro InterScan software, the ASA provides the ability
to perform advanced content ﬁltering of known and unknown attacks and threats,
including malware, worms, viruses,Trojans, spyware, adware, phishing, spam, and
email and Web content ﬁltering.
■
Remote Access VPN Clustering and Load Balancing  The ASA supports
improved VPN scalability and reliability by allowing the ASA to be conﬁgured as a
member of Cisco VPN 3000 Series Concentrators or ASA 5500 Series VPN clus-
ters of up to 10 devices.This allows for the ASA 5500 to potentially support
50,000 concurrent VPN connections.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
231

The Cisco PIX Device Manager 
Cisco provides a few different options to conﬁgure and manage PIX ﬁrewalls running the
6.x software or earlier, including command-line (CLI) based serial console connection,
Telnet, Secure Shell (SSH), and an application with a GUI called the PIX Device Manager
(PDM).The PDM provides administrators with a browser-based GUI and gives people who
might not be well versed in the PIX CLI the ability to easily conﬁgure and monitor the PIX
via a Web browser. It is also very secure because the transmissions between the browser and
the PIX are made secure by SSL.The PDM provides administrators with conﬁguration wiz-
ards, performance graphs, and historical data to help with conﬁguration and troubleshooting
tasks. Even though the PDM covers most of the commands needed to conﬁgure, manage,
and support the PIX, it does not support some commands that can be conﬁgured only via
the CLI.
The 501 and 506E are initially set up to work out of the box with PDM, but with the
higher-end models, it is necessary to initially turn on PDM via the CLI prior to managing it
via the PDM.The PDM works on a single device at a time and must be installed on the
ﬁrewall separately from the PIX OS.To run the PDM, you need an activation key that
enables Data Encryption Standard (DES) or Triple DES (3DES).You can ﬁnd more informa-
tion about installing the PDM at www.cisco.com/en/US/customer/products/sw/net-
mgtsw/ps2032/products_installation_guides_books_list.html.
NOTE
The PDM software is separate from the PIX OS and is located in a separate ﬁle
on the PIX Flash. Therefore, when you’re upgrading software on the PIX, you
might also need to upgrade the PDM software. The PDM is available for PIX OS
version 6.0 mainline on all chassis types. The PDM does not require a license,
but since it supports only encrypted communication to the browser (SSL), an
encryption license is required to run the PDM. Cisco provides a no-cost DES
license or a 3DES license for a fee.
NOTE
The PDM is limited in that it can manage only one PIX at a time. If you have a
large environment and manage a large number of PIX ﬁrewalls, you might con-
sider using CiscoWorks VPN and Security Management (VMS) Suite, which pro-
vides a Web-based GUI by which an administrator can manage many ﬁrewalls
from one console. This tool makes managing ﬁrewalls easier by deﬁning poli-
cies, standardizing conﬁgurations, and reducing human conﬁguration errors.
www.syngress.com
232
Chapter 6 • Firewall Design: Cisco PIX and ASA

The Cisco Adaptive Security Device Manager
With the release of the PIX OS 7.x and the ASA ﬁrewall, Cisco elected to provide a new
and more robust management GUI known as the Cisco Adaptive Security Device Manager
(ASDM).The ASDM is effectively the upgrade to the PDM for all PIX and ASA ﬁrewalls
that are running the 7.x version of software. Like the PDM, the ASDM is a separate software
ﬁle on the ﬁrewall. In addition to a browser-based GUI, the ASDM supports a client appli-
cation that can be installed on the administrator workstation and then connected over the
network to multiple ﬁrewalls (though each ﬁrewall must be managed independently).
Because the ASDM is supported only when running the PIX or ASA 7.x software, it is
not supported on the PIX 501 or PIX 506E (you must use the PDM).The ASDM provides
administrators with an application or browser-based GUI and gives people who might not
be well versed in the PIX/ASA CLI the ability to easily conﬁgure and monitor the
PIX/ASA via a Web browser or the ASDM client application. It is also very secure because
the transmissions between the browser/application and the PIX/ASA are made secure by
SSL.The ASDM provides administrators with conﬁguration wizards, performance graphs,
and historical data to help with conﬁguration and troubleshooting tasks. Even though the
ASDM covers most of the commands needed to conﬁgure, manage, and support the PIX, it
does not support some commands that can only be conﬁgured via the CLI. Otherwise the
ASDM and PDM have a very similar GUI and essentially serve the same purpose: to provide
a remote management GUI to simplify and augment the traditional console,Telnet, or SSH
based CLI.
Cisco PIX Firewall Licensing 
Cisco’s PIX ﬁrewall licensing requires some clariﬁcation.There are four categories of license
type for all PIX ﬁrewalls:
■
User licenses
■
Platform licenses
■
Feature licenses
■
Encryption licenses
User Licenses
As the name implies, user licenses are used to deﬁne how many internal users can concur-
rently access the Internet or other external resources.There are three user license levels.The
10-user license and 50-user license are used for the PIX 501 ﬁrewall.All other ﬁrewalls
include an unlimited user license.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
233

Platform Licenses
For the higher-end models (515E and greater), four main license options are available:
Restricted (R), Unrestricted (UR), Failover (FO), and Failover-Active/Active (FO-AA).The
Restricted license is just that—restricted. It limits the ﬁrewall’s capabilities; for instance, it
does not allow for failover, it limits interface density, and it is shipped with reduced RAM,
compared with the Unrestricted license.The Unrestricted license provides all the capabilities
of the Restricted license but adds increased LAN interface density, more RAM, VPN accel-
eration, and failover.The Failover license is used in conjunction with the Unrestricted license
to provide Active/Standby failover for the ﬁrewall.The backup or redundant PIX can be
purchased with the Failover license at reduced cost, which makes the PIX one of the more
cost-effective ﬁrewalls when it’s conﬁgured as a redundant pair. In a scenario in which the
primary ﬁrewall fails the secondary unit with the Failover license, the device will continue to
perform all the capabilities the primary device supported. (The secondary unit must have the
same optional PCI cards as the primary.) The Failover-Active/Active license is functionally
similar to the Failover license, but it supports running the ﬁrewalls in an Active/Active
failover mode.
NOTE
PIX licenses can be upgraded. When you purchase an upgrade package, you will
receive a new activation key that unlocks the software enhancements of the
new license as well as any additional hardware to bring the PIX to the correct
hardware level to support the license’s features. For example, if you upgrade a
PIX 515E Restricted license to an Unrestricted license, you will receive an activa-
tion key and be able to beneﬁt from another 32MB of RAM and a VAC.
NOTE
For the secondary or backup PIX with a Failover license to support a VPN client
or the PCM as the primary, it is necessary to obtain a separate 56-bit DES IPSec
license or the 168-bit 3DES IPSec licenses for both the primary and the backup
units.
Feature Licenses
Feature licenses are used on the PIX 515E, 525, and 535 ﬁrewalls to provide advanced fea-
tures such as security contexts or GTP/GPRS inspection for the ﬁrewall. Security context
www.syngress.com
234
Chapter 6 • Firewall Design: Cisco PIX and ASA

licensing supports 5, 10, 20, and 50 contexts, with the maximum number of supported secu-
rity contexts depending on the model of PIX.
Encryption Licenses
When encryption is required to support IPSec VPNs or to enable the ASDM/PDM, it is
necessary to obtain either the 56-bit DES encryption license or the 3DES (168-bit )/AES
(128, 192 or 256-bit) encryption license.The encryption licenses are available for all models.
Cisco ASA Firewall Licensing
The Cisco ASA licensing is very similar to the PIX licensing.ASA licensing does not include
user licensing (all ASA ﬁrewalls have an unlimited user license), but it utilizes platform, fea-
ture, CSC-SSM, and encryption licenses.
Platform Licenses
The ASA 5510 contains a platform license option that is unique to the 5510.This is known as
the 5510 Security Plus.The 5510 Security Plus enables an increased number of concurrent
connections and an increased number of virtual interfaces, and most important, it allows for
high-availability support.All other ASA devices have a single platform license for all features.
CSC-SSM Licenses
The CSC-SSM is licensed in two ways.The ﬁrst license is a platform license to support a
number of users. By default the CSC-SSM-10 supports 50 users, whereas the CSC-SSM-20
supports 500 users.These licenses can be upgraded to support up to 500 users (CSC-SSM-
10) or 1,000 users (CSC-SSM-20).
The CSC-SSM also supports two feature licenses.The base license is included in all
CSC-SSMs and provides for antivirus, antispyware, and ﬁle-blocking capabilities.This func-
tionality can be enhanced with the Plus License, which adds antispam, antiphishing, content-
ﬁlter, URL blocking, and URL ﬁltering functionality.
Feature Licenses
Feature licenses are used on the ASA ﬁrewalls to provide advanced features such as security
contexts or GTP/GPRS inspection for the ﬁrewall. Security context licensing supports 5,
10, 20, and 50 contexts, with the maximum number of supported security contexts
depending on the model of PIX.
Encryption Licenses
When encryption is required to support IPSec VPNs or to enable the ASDM, it is necessary
to obtain either the 56-bit DES encryption license or the 3DES (168-bit )/AES (128, 192 or
256-bit) encryption license.The encryption licenses are available for all models.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
235

Cisco PIX Firewall Version 6.3 
PIX Firewall version 6.3 is the latest mainline release of the PIX operating system for the
PIX 501 and PIX 506 ﬁrewalls. PIX version 6.3 offers many new features as well as perfor-
mance enhancements.Although many of the new features in this release of code pertain to
VPN and support for Voice over IP (VoIP), this release does provide several enhancements
that could be useful in a DMZ environment, such as VLAN and OSPF support. PIX OS
version 6.3 also ﬁxes several bugs and vulnerabilities found in the previous release.This code
does not yet meet the Common Criteria EAL4 certiﬁcation, but its additional functionality
might compel you to upgrade.
New features implemented in PIX version 6.3 include:
■
VLAN support Enables the PIX to support multiple virtual interfaces via VLAN
trunking.
■
OSPF Supports the Open Shortest Path First (OSPF) dynamic routing protocol.
■
Advanced Encryption Standard (AES) Support for a new international
encryption standard.
■
VPN Acceleration Card+ (VAC+) The ﬁrst release to offer support for the
new VAC+ PCI Card option.
■
VPN NAT transparency Circumvents issues arising from using a VPN when
NAT/PAT is implemented by dynamically wrapping IPSec VPN packets in a
UDP packet Cisco Secure PIX.
■
Access banner The PIX will display a message to anyone who tries to connect
to the PIX’s CLI. It is important to conﬁgure a banner for legal purposes.
■
Management enhancements Several enhancements have been made to the
CLI, including ACL editing, syslog formats, access banners, and console inactivity
timeouts.
For more information on PIX OS 6.3, visit www.cisco.com/warp/customer/cc/
pd/fw/sqfw500/prodlit/pix63_ds.htm.
Cisco PIX and ASA Firewall Version 7.2
PIX OS and ASA OS 7.2 is the latest mainline release of the PIX and ASA operating system
for all models of PIX or ASA except the PIX 501 and PIX 506E. PIX/ASA OS 7.2 is built
on the 6.x software but provides many advanced features and performance enhancements. In
addition, the PIX/ASA OS 7.2 makes some fundamental changes to the method and manner
in which ﬁrewalls, and in particular interfaces and security policies, are conﬁgured. Many of
these changes will be familiar to users of the Cisco Internetwork Operating System (IOS).
For a full breakdown of the changes between the 6.x and 7.x releases, visit www.cisco.com/
en/US/products/sw/secursw/ps2120/products_upgrade_guides09186a0080369ee2.html.
www.syngress.com
236
Chapter 6 • Firewall Design: Cisco PIX and ASA

New features implemented in PIX/ASA version 7.2 include:
■
Application Inspection and Control  Provides enhanced application inspec-
tion and control of a number of new protocols.This functionality is not to be con-
fused with the functionality provided by the AIP-SSM or CSC-SSM.
■
Remote Access and Site-to-Site VPN Provides improved VPN functionality,
including support for Network Admission Control (NAC) and L2TP over IPSec.
■
Network Integration  Provides enhanced network integration capabilities
through the support of Point-to-Point Protocol over Ethernet (PPPoE) client
functionality, Dynamic DNS, multicast routing enhancements, and private and
automatic MAC address assignment for multiple contexts and expands DNS
domain name usage when conﬁguring AAA or the ping, traceroute, and copy com-
mands.
■
Resiliency and Scalability  Supports subsecond (under a second) failover and
standby ISP links to deﬁne and activate a secondary route in the event that the
primary ISP fails.
■
Management and Serviceability  A number of management and serviceability
enhancements have been made, including the addition of the traceroute command,
packet tracer functionality that allows the life span of a packet to be traced through
the ﬁrewall to determine whether the ﬁrewall is behaving as expected. It also
includes support for Web Cache Communication Protocol (WCCP) as well as
IPv6 security enforcement of IPv6 addresses. Finally, support for inspection, IPS,
CSC, and Web ﬁltering has been added to WebVPN clients.
PIX Firewall PCI Card Options
In the previous section, we referred to several of the optional PCI cards that make the
higher-end PIX chassis very versatile.These cards give the PIX the ability to handle multiple
DMZ legs and increase VPN performance. In this section, we clarify the capabilities of these
cards and their uses.
For 10/100Mbps Ethernet requirements, the PIX offers two types of PCI card: a single-
port Fast Ethernet card and a four-port Fast Ethernet card. Even though the Fast Ethernet
cards are 32-bit/33MHz PCI cards, they can ﬁt in either the 32-bit/33MHz or the 64-
bit/66MHz PCI slots on the PIX and can be conﬁgured for 10/100Mbps at either half or
full duplex.The PIX 525 and 535 both support the Gigabit Ethernet 64-bit/66MHz PCI
card.The Gigabit Ethernet multimode ﬁber PCI interface card can be inserted into either
the 32-bit/33MHz or the 64-bit/66MHz PCI slots on the PIX. If you recall, the PIX 535
has both 32-bit/33MHz and 64-bit/66MHz PCI slots, but when inserted into 32-
bit/33MHz, the cards will severely degrade device performance, so ﬁll the 64-bit/66MHz
PCI slots before inserting a card into the 32-bit/33MHz.The PIX 525 only has 32-
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
237

bit/33MHz PCI slots, so you have no choice but to install the card there and not receive the
card’s full throughput.
The PIX offers VACs, which ofﬂoad all CPU-intensive encryption calculations, DES,
3DES, or AES, from the main processor and onto the VAC hardware.This improves not only
VPN throughput but also overall ﬁrewall performance. Without the VAC installed, the
encryption algorithm and its computations are performed by the PIX OS and the main
CPU, which causes the PIX’s overall performance to be severely impacted as the number of
IPSec VPN tunnels and load are increased. If you need extensive use of IPSec VPN tunnels,
consider installing the optional VAC, because it provides notable improvement in perfor-
mance and security.At the time of this writing, there were two VAC options: the original
VAC and the newer, improved VAC+. Besides increased performance, the VAC+ adds AES
hardware acceleration, whereas the original VAC supports only DES and 3DES. It must be
noted that VAC+ is only supported by PIX OS version 6.3(1) and later.At some point Cisco
will “end of life” the original VAC and sell only the VAC+ as a separate option and include
it in the Unrestricted license bundle.
Installing a New PCI Card
You have many things to think about when you’re upgrading hardware on the PIX.You
must take into account license restrictions, types of interfaces supported by each PIX model,
available PCI slots, and cost.
For example, let’s say that you are the administrator of an enterprise network and your
boss tells you there is a project in the works whereby the company’s new Web site will be
hosted at your location.You need to build a DMZ environment to accommodate the Web
servers.You take a look at your Internet infrastructure; it currently utilizes a PIX 515E,
which supports only user access to the Internet.The PIX was originally shipped with the
Restricted software license and the two embedded Fast Ethernet interfaces, which are both
used by the inside and outside interfaces, and it has no optional PCI cards installed.To sup-
port a DMZ where the Web servers will reside, you need to add a third Fast Ethernet inter-
face to the PIX.
You look at Cisco’s product catalog for the PIX and notice two options: a one-port Fast
Ethernet PCI card and a four-port Fast Ethernet PCI card.Your ﬁrst inclination might be to
order the four-port Fast Ethernet PCI card for scalability reasons, but as we discussed earlier
in the chapter, it is important to understand the limitations of the Restricted license. On the
PIX 515E, the Restricted license allows for only a total of three Fast Ethernet interfaces, so
if you purchase the four-port Fast Ethernet PCI card, you would also have to purchase the
Unrestricted license upgrade to take advantage all the installed interfaces.This can be an
expensive solution, since most of the PIX’s cost is not in the hardware but in the licensing.
Another solution is to order the one-port Fast Ethernet PCI card, which will meet your
current DMZ requirements, does not require a license upgrade, and costs a fraction of the
price of the previous option but does not provide for scalability.
www.syngress.com
238
Chapter 6 • Firewall Design: Cisco PIX and ASA

Adding a PCI card to the PIX 515E is a fairly simple process, similar to adding a PCI
card to a regular PC. First, shut down and unplug the unit. Remove the top cover from the
ﬁrewall, exposing the internal components. Next remove the PCI slot faceplate located at
the rear of the PIX (fastened by two screws).This action exposes the PCI slots.You can now
add the optional PCI card into an open slot (start at the top) and press the PCI card ﬁrmly
into place. On the faceplate, remove one of the blank PCI slot covers to expose the newly
inserted card, then reattach the faceplate and screws. Next, power on the ﬁrewall.To verify
that installation of the PCI card was successful, you can use the show version command,
which will display the number of interfaces installed. Refer to the Cisco Web site for further
installation procedures, or once you order the extra PCI card, examine its accompanying
manual.
ASA Firewall SSM Options
The biggest thing that differentiates an ASA from a PIX ﬁrewall is the SSM and the corre-
sponding functionality that it provides.The ASA supports three types of SSM: the AIP-SSM,
the CSC-SSM, and the 4GE-SSM.
■
AIP-SSM This card provides the Intrusion Prevention System functionality that
the ASA can utilize for advanced ﬁltering and blocking of trafﬁc.The AIP-SSM
runs its own intrusion prevention software in conjunction with the ASA 7.x soft-
ware and can be managed and conﬁgured independently of the ASA software. In a
manner of speaking, the AIP-SSM combines the features of the Cisco IPS 4200
series sensor and the ASA ﬁrewall into a single device.
■
CSC-SSM  This card provides the enhanced content ﬁltering and anti-X func-
tionality that the ASA can utilize for advanced content ﬁltering and blocking of
malware.The CSC-SSM runs its own software, provided by Trend Micro, in con-
junction with the ASA 7.x software that can be managed independently of the
ASA software. In a manner of speaking, the CSC-SSM combines the features of
the Trend Micro InterScan and the ASA ﬁrewall into a single device.
■
4GE-SSM  This card provides four ports of 10/100/1000 Ethernet as well as four
SFP ﬁber ports, allowing the ASA to be expanded to include any combination of
the eight ports on the module. Keep in mind that the ASA supports only eight
active interfaces at any given time, so, for example, if the four embedded interfaces
are in use, only four ports (either Ethernet or SFP) from the 4GE-SSM may be
active.
Installing a New SSM
Installing a new SSM is similar to installing a PCI card in a PIX in terms of simplicity.The
ASA supports only one SSM at a time, so the only question regarding the SSM and the ASA
is which SSM you want to install.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
239

The actual installation is very straightforward: Simply power off the ASA and remove the
two screws from the rear left of the chassis that holds the SSM slot cover in place. Insert the
SSM into the slot using the provided channels and screw the SSM into the chassis.At that
point you merely need to power the SSM back on and connect the SSM to the network,
and you are ready to conﬁgure the SSM accordingly.
Designing & Planning…
Putting It All Together
If a DMZ is correctly planned and designed, it will make simple the tasks of imple-
menting, maintaining, and supporting the DMZ infrastructure. It is important to
note that a DMZ cannot be properly designed without a clear vision of what the
DMZ will support. Will the DMZ environment contain a handful of servers that
provide the enterprise with basic services and therefore does not require much
performance or resiliency? Or will the DMZ environment contain major services
that the enterprise needs to be productive and proﬁtable and therefore will need
to be in operation at all times? Alternatively, will it be somewhere between these
two scenarios? Do you need to perform advanced content ﬁltering or intrusion
prevention? There is only one way to determine the category your DMZ infras-
tructure will ﬁt into: You need to understand the business, the role the DMZ will
play, the type of trafﬁc the DMZ will support, the performance you require, and
plans for future growth. 
Now let’s say that you are the network architect for a company called
Automania that sells wholesale auto parts. Automania is a standard “bricks and
mortar” company that normally does business by in-store sales, phone, fax, and
catalog orders, but the company is looking to add the ability to sell auto parts on
the Internet. The company sees Internet sales as a way to attract new customers
and offer new and existing customers the ability to make purchases 24 hours a
day, seven days a week, 365 days a year, which cannot be done without signiﬁ-
cant expense using conventional methods. The company has hired a consulting
ﬁrm to design and build the Automania.com Web site, where customers can
shop over the Internet. The site’s developers have designed an e-commerce site
with a shopping cart feature so Internet users can browse for items, check prices,
and ﬁnally, purchase auto parts. The company projects that the Internet business
will show moderate sales at ﬁrst as regular customers move from the conven-
tional ordering system to the Web-based system, but the business could grow as
the site attracts new customers. 
Due to budgetary constraints, the developers have designed a small site
that requires only two servers—a server that will contain the Web and applica-
tion functions and a separate server for the database. The developers also had
www.syngress.com
240
Chapter 6 • Firewall Design: Cisco PIX and ASA
Continued

the forethought to design a scalable server environment in which the number of
servers supporting the site can expand as demand increases. The business expects
about 10,000 hits and 1,000 transactions a day at ﬁrst, then steady growth. 
As the network architect for the company, you are given the task of sup-
plying the infrastructure to support the new Automania Web site. The company
already has Internet connectivity via a broadband connection, and you are pro-
tecting your network using a low-end ﬁrewall that was easy to install and worked
well but does not have the ability to support a DMZ. Now you realize that you
must upgrade for entire Internet infrastructure to host the new Web site. It is
now time to gather the information and requirements so you can design and
build a DMZ infrastructure that will be able to support the new Web site for its
launch and into the future. 
You need to begin gathering information, starting with the facts and
requirements:
■
The facts are that the company is making a strategic move to offer
its customers a new method to purchase auto parts as well as to
attract new customers.
■
The site is important to the growth of the business. 
■
The Web site will start out small but could grow as sales over the
Internet increase. 
■
The site will be a scalable server environment with a single
Web/application server and a database server.
■
A DMZ will need to be built on site to support the new
Automania.com Web site.
■
The infrastructure currently in place is not capable of supporting the
new Web site.
■
The site is estimated to reach 10,000 hits and 1000 transactions a
day at ﬁrst, then grow steadily.
You next ask questions so you can be informed of data that was missing so
that you can move on to designing a solution:
■
How much Internet bandwidth is required to support the site?
■
What kind of security is needed? Will there be a need for both Web
trafﬁc and SSL trafﬁc?
■
Does the site require high availability?
■
What are the connectivity requirements among the internal network,
the Web/application server, and the database server?
■
What is the budget for the DMZ infrastructure?
After you asked the questions, the developers and business managers come
back to you with their answers. They tell you that since the site will receive only
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
241
Continued

10,000 hits and 1,000 transactions a day, they initially need two T1s; as the site
grows, they will add bandwidth. Since the site will be processing credit card
transactions, both Web trafﬁc (TCP port 80) and SSL (TCP port 443) need to be
allowed to access the Web/application server from the Internet. The database
should be accessed by only the internal LAN and should respond to Web/appli-
cation server requests for information. 
All Web servers and switches are 100Mbps full-duplex capable devices. Even
though the servers can be a single point of failure, the DMZ infrastructure should
be built with redundancy. The DMZ infrastructure should be built with scalability
in mind, with close attention to the budget—in other words, do not over-engi-
neer the infrastructure. 
From this information, you can now start to develop your solution.
Analyzing the requirements, you decide that the multileg DMZ with redundant
ﬁrewalls offers you the most secure and scalable solution that ﬁts your budget.
The multileg DMZ allows you to separate the Web/application server into sepa-
rate DMZs to allow for greater security. DMZ1 will contain the Web/application
server, and DMZ2 will contain the database servers. Because users will access only
the Web/application server, the ﬁrewall rules will be conﬁgured so it accesses only
the server on DMZ1 via the Web port (TCP port 80) and SSL port (TCP port 443).
DMZ2 will allow no connectivity from the Internet; it will only respond to
requests made for data by the Web/application server or by the internal LAN for
management. Separating the Web/application server and the database servers
into different DMZs allows for greater security in the event the Web/application
server is compromised by an intruder. Since the Web/application server is directly
accessible by the Internet, it is always the most vulnerable. Furthermore, the
design allows for the addition of a redundant ﬁrewall that will take over for the
primary, should the primary go ofﬂine. 
The next step is to decide on a make and model of the ﬁrewall to use for
this solution. You choose the Cisco PIX or ASA ﬁrewall line because it is a pur-
pose-built ﬁrewall appliance and it has a Web-based and a CLI-based manage-
ment interface, a modular design, strong security features, and performance. As
you research the PIX model options, you immediately can cross off the 501 and
506E models because they do not support a third leg (interface) or failover. So
you move onto higher-end models. The 515E, 525, and 535 can all meet the
needs of your solution in terms of interfaces, failover, and performance, but since
the requirements of our DMZ infrastructure are in the low to moderate level and,
due to our restrictions on cost, we can choose the PIX 515E. The PIX 515E comes
with two embedded 10/100Mbps interfaces (one for the internal interface, one
for the outside interface), but since the requirement is for two DMZs, you will
need to order the four-port Fast Ethernet PCI card (two for interfaces DMZ1 and
DMZ2, one interface for stateful failover, and one interface free). Since high avail-
ability is needed in this solution, you need to purchase two PIX 515E ﬁrewalls—
one with the Unrestricted license and the second with the Failover license. 
If your requirements deﬁne that you need content ﬁltering or intrusion pre-
vention, you could easily replace the PIX ﬁrewall with an ASA ﬁrewall to provide
www.syngress.com
242
Chapter 6 • Firewall Design: Cisco PIX and ASA
Continued

the required functionality. For example, let’s say that in addition to the already
deﬁned requirements in this example, you also need to provide intrusion preven-
tion functionality. You could replace the PIX 515E with an ASA 5510 Security Plus
or PIX 5520 and meet the organizational needs.
For this example, let’s skip the Internet connectivity planning and design;
they are discussed in detail in Chapter 9. Once you have gathered all the require-
ments, designed a solution, and purchased the equipment, you will be ready to
conﬁgure, test, and launch the site.
Making a DMZ and Controlling Trafﬁc 
This section covers how to conﬁgure the PIX and ASA’s basic and advanced security features
to meet your solution’s needs. We discuss in detail how to securely access the PIX/ASA and
deﬁne security levels, NAT, access rules, routing, failover, and other security features.
NOTE
As a general rule, all command examples provided here are the same for both
the PIX and the ASA. In most cases, the commands are based on the PIX/ASA
7.x OS. In cases where there are different commands for the PIX 6.x OS, we pro-
vide examples of both commands.
Securely Managing the PIX
There are several ways to access the PIX/ASA to conﬁgure, troubleshoot, or monitor its
status, including console access,Telnet, SSH, PDM (PIX 6.x), and ASDM (PIX 7.x and
ASA). In this section, we discuss the advantages and disadvantages of each access method as
well as how to conﬁgure some of the more secure methods. We also discuss how to authen-
ticate users and manage them via an external RADIUS or TACACS+ server.
The Console
Out of the box, the higher-end PIX chassis, including the PIX 515E and all ASA ﬁrewalls,
must be initially set up via the console port. Whereas the lower end PIX (PIX 501 and PIX
506E) can also be initially set up via the console port, they are both designed to function as
a DHCP server, allowing you to connect over the network using the PDM for the initial
setup and conﬁguration.The initial setup can be accomplished using the same method as
you use to connect to a Cisco router or switch.You need a terminal program, such as
HyperTerminal, conﬁgured with the following parameters on the appropriate COM port:
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
243

■
Bits per second to 9600
■
Data bits to 8
■
Parity to None
■
Stop bits to 1
■
Flow control to Hardware
Connect your PC’s COM port to the PIX or ASA’s Console port using the adapter and
the rolled ribbon cable that came with the PIX/ASA.You now have direct serial access to
the PIX or ASA CLI.Access to the console port can be protected by a password or authenti-
cated via a TACACS or RADIUS server.This type of access can be used for general mainte-
nance and monitoring or when access via other methods such as Telnet or SSH is useless due
to conﬁguration errors or malfunctions.Accessing the PIX/ASA via the console might be
your last option to correct the problem before you have to call Cisco’s Technical Assistance
Center (TAC) for assistance.
NOTE
Cisco’s TAC is responsible for providing Cisco customers with assistance for
technical and conﬁguration issues for all Cisco’s hardware and software prod-
ucts, including the PIX ﬁrewall. Cisco’s TAC can be contacted by phone or via
the following URL: www.cisco.com/en/US/support/index.html. 
Telnet
The PIX/ASA provides the ability to Telnet to the command-line interface.The PIX/ASA
allows for ﬁve simultaneous Telnet sessions from hosts or networks you specify via the Telnet
address [netmask] [interface_name] command.This command allows you to identify the host(s)
that can initiate a Telnet session as well as the interface in which to accept the connection.
Telnet access to the PIX/ASA ﬁrewall is allowed on all interfaces. However, for increased
security on the most vulnerable interface, the outside of the interface with security level 0
(usually the interface facing the Internet), the PIX will accept Telnet sessions to the interface
only if it is IPSec protected.Therefore,Telnet access to the outside interface requires extra
conﬁguration to support IPSec. Some administrators implement this for remote administra-
tion of PIX/ASA ﬁrewalls, but use this feature with great caution and only if absolutely nec-
essary.As was the case with the console port,Telnet access can be protected by a password or
authenticated via a TACACS or RADIUS server. Remember that Telnet trafﬁc, when not
used in conjunction with IPSec, is sent in clear text. If someone is snifﬁng your network,
they can easily capture the PIX or ASA Telnet password or enable password, or if you are
www.syngress.com
244
Chapter 6 • Firewall Design: Cisco PIX and ASA

using AAA, they will be able to obtain a user ID and password and use them later to open
holes in the ﬁrewall or perform other malicious activity.
In sum, using Telnet is not recommended, because you could lose your credentials to a
malicious attacker who is eavesdropping on your network.A more appropriate solution is to
console in, as mentioned previously.An even better in-band alternative is SSH.
SSH
One of the major weaknesses inherent to a Telnet session is that all data is sent in clear text.
This can be a serious security vulnerability if someone is able to sniff your Telnet session to
the ﬁrewall.The PIX/ASA can also support SSH version 1.x (version 2.x is supported in the
7.x software), which gives the administrator secure access to the PIX or ASA CLI.All trafﬁc
between the administrator’s workstation and the PIX/ASA is encrypted, which makes it dif-
ﬁcult for a hacker to capture IDs and passwords or credentials in general. Unlike Telnet,
which is available by default on almost every operating system, an SSH version 1.x or 2.x
client is required and usually needs to be installed on the workstation(s) that need to manage
the PIX/ASA via SSH.As with Telnet, the PIX/ASA will allow ﬁve simultaneous SSH ses-
sions from hosts or networks you specify via the ssh command.As with the other access
methods, the PIX/ASA can be protected by a password or authenticated via a TACACS or
RADIUS server. Unlike Telnet, the PIX/ASA allows SSH connectivity on all interfaces,
including the outside interface.To conﬁgure SSH, the PIX/ASA ﬁrewall needs a DES or
3DES activation key to generate an RSA key pair and support encrypted communication
between the client and the PIX/ASA.
The ﬁrst task in setting up SSH is to create an RSA key pair and save it to the PIX’s
Flash.The conﬁguration shown in Figure 6.5 identiﬁes the code necessary to generate an
RSA key pair, which consists of the PIX or ASA hostname and domain name.Two different
commands will need to be run, depending on whether the ﬁrewall is running a 6.x OS
(Figure 6.6) or 7.x. For the 7.x OS, the crypto key generate rsa command generates an RSA
key pair with a key modulus of 1024 (which is the default). For the 6.x OS, the command ca
generate rsa key 1024 generates an RSA key pair with a key modulus of 1024 bits (the
default is 768 bits).This code will not show in the PIX/ASA conﬁguration, but the RSA
key-pair conﬁguration can be viewed by executing the sh crypto key mypubkey rsa (7.x) or
show ca mypubkey rsa (6.x) command. If you are using the 6.x OS to save the generated RSA
key pair so it will be available after a reboot, you need to save it into Flash by entering the ca
save all command. With the 7.x OS, the RSA key pair is saved when the conﬁguration is
saved by running the copy running-conﬁg startup-conﬁg command.
After the RSA key pair is generated, it is time to conﬁgure SSH.The example shows a
workstation with the IP address 192.168.0.2 that is authorized to initiate an SSH session to
the PIX’s or ASA’s inside interface. Use the ssh address [netmask] [interface_name] command to
deﬁne the IP host or IP address range that can access the PIX as well as on which interface
to accept this connection.The ssh timeout command sets the amount of idle time, in minutes,
before the session is disconnected.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
245

Figure 6.5 7.x OS SSH Conﬁguration Example
pixﬁrewall(conﬁg)# hostname ASA5520
ASA5520(conﬁg)# domain-name syngress.com
ASA5520(conﬁg)# crypto key generate rsa
ASA5520(conﬁg)# copy running-conﬁg startup-conﬁg
ASA5520(conﬁg)# ssh 192.168.0.2 255.255.255.255 inside
ASA5520(conﬁg)# ssh timeout 60
Figure 6.6 6.x OS SSH Conﬁguration Example
pixﬁrewall(conﬁg)# hostname Pix515
Pix515(conﬁg)# domain-name syngress.com
Pix515(conﬁg)# ca generate rsa key 1024
Pix515(conﬁg)# ca save all
Pix515(conﬁg)# ssh 192.168.0.2 255.255.255.255 inside
Pix515(conﬁg)# ssh timeout 60
An authorized workstation—in this case, 192.168.0.2—with an SSH client can complete
a session with the PIX.The SSH client will require a username and password, but if you are
using only local passwords, you might ask,“What is my username?” In this case, the user-
name is pix, but if AAA is conﬁgured, the username is your TACACS+ or RADIUS user-
name and password.
The PIX Device Manager
The PDM provides administrators with a browser-based GUI that can be used to conﬁgure
the PIX (running the 6.x OS) without having to know how to administer the CLI.The
PDM provides administrators who are not well versed in the PIX CLI the ability to easily
conﬁgure and monitor the PIX via a Java applet.All transmission between the browser and
the PIX is secure via SSL.The PDM will provide you with conﬁguration wizards, perfor-
mance graphs, and historical data.To run the PDM, you need an activation key that enables
DES or Triple DES 3DES on the PIX. It is important to remember that the PDM software
is separate for the PIX OS (although the PDM is dependent on the ﬁrewall running the 6.x
OS) and needs to be loaded into Flash separately (assuming it was not shipped with the PIX
already loaded) before it can be used to manage the PIX.The PDM feature is not enabled
on the higher-end PIX models (PIX 515E and greater) by default. For the PIX to accept
and respond to HTTP requests, you need to enable the HTTP server within the PIX OS
with the http server enable command.As with the other methods, you need to specify the
interface and the IP address or IP range that can access PDM.
www.syngress.com
246
Chapter 6 • Firewall Design: Cisco PIX and ASA

NOTE
Unlike the Web-based management interface on Cisco routers, PDM is a very
useful tool for novice and even advanced ﬁrewall administrators. Besides the
PDM providing a powerful GUI, all the trafﬁc between the PIX and the browser
is encrypted, which is lacking from the router’s HTTP server implementation. As
with all unused services, if you are not planning to use PDM, make sure the
HTTP server is disabled. 
Figure 6.7 shows how to enable the HTTP server and specify that the host with the IP
address 192.168.0.2 is the only device able to access the PDM. Once the PDM is enabled
(and assuming you’ve already conﬁgured the interfaces on the PIX), you will be able to
access the PIX via your Web browser using this URL: https://192.168.0.1. (In this example,
the IP address of the PIX’s inside interface is 192.168.0.1.)  
You will be prompted to accept certiﬁcates and then prompted for a username and pass-
word. If you are using RADIUS or TACACS+ to authenticate access to the PIX, use the
username and passwords assigned to you. If you are not using RADIUS or TACACS+, leave
the username prompt empty and enter the enable password at the password prompt. In this
chapter, we concentrate on the PIX CLI as the preferred method of conﬁguring and man-
aging the PIX, and as we mentioned earlier, there some advanced commands that the PDM
does not support. If you do not need the PDM, make sure you disable the HTTP server on
the PIX using the no http server enable command.Although the PDM can be very useful for
managing and supporting the PIX, we recommend using SSH as the only form of device-
centric remote administration of the PIX. For monitoring multiple ﬁrewalls, CiscoWorks
VMS should be considered. Even though the PDM provides secure communication, it might
be wise to disable it to reduce the entry points in the PIX’s management interface, therefore
limiting the PIX’s exposure to attacks. SSH provides secure communication as well as access
to all the PIX’s CLI commands.
Figure 6.7 PDM Conﬁguration Example
Pix515(conﬁg)# http server enable
Pix515(conﬁg)# http 192.168.0.2 255.255.255.255 inside
The Adaptive Security Device Manager
As previously mentioned, the ASDM is the logical replacement of the PDM for all PIX and
ASA running the 7.x software. Like the PDM, the ASDM is a separate software image and
must be installed independently of the OS, even though it depends on the OS to function.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
247

ASDM is a Java-based GUI used to manage the Cisco PIX ﬁrewall. It consists of a soft-
ware image that runs from Flash memory on the PIX ﬁrewall, enabling administrative access
via a Secure Sockets Layer (SSL) encrypted HTTPS session.ASDM completely replaces
PDM, which was available for versions before 7.0.ASDM allows ﬁrewall administrators to
work from a variety of authorized workstations conﬁgured with a compatible browser and
includes nearly all PIX CLI functionality. For example, using ASDM, administrators can add,
modify, and delete ﬁrewall rulesets, conﬁgure NAT, or set up a VPN.
In addition to altering PIX conﬁgurations,ASDM facilitates administrative monitoring
of the PIX ﬁrewall through powerful graph and table displays for near-real-time insight into
PIX performance.This chapter introduces ASDM and provides detailed information for
using it to conﬁgure and monitor the PIX ﬁrewall.
There are two methods of accessing the ASDM from a client computer.The ﬁrst
method is by using a Web browser in the same fashion as with the PDM.The second
method is by using a client application known as the Cisco ASDM Launcher.The ASDM
Launcher provides a browser-independent method of connecting to the ASDM. In both
cases the trafﬁc between the client is securely transmitted via SSL.
Figure 6.8 shows how to enable the HTTP server on the ﬁrewall, specify the ASDM
image to load on the ﬁrewall (an optional command that is required ibkt if you have mul-
tiple ASDM images installed on the ﬁrewall), and specify that the host with the IP address
192.168.0.2 is the only device able to access the ASDM. Once the ASDM is enabled (and
assuming you’ve already conﬁgured the interfaces on the PIX/ASA), you will be able to
access the PIX/ASA via your Web browser using the URL https://192.168.0.1 or via the
ADSM Launcher using the IP address 192.168.0.1. (In this example, the IP address of the
PIX/ASA’s inside interface is 192.168.0.1.)  
Figure 6.8 ASDM Conﬁguration Example
ASA5520(conﬁg)# http server enable
ASA5520(conﬁg)# asdm image ﬂash:/asdm-521.bin
ASA5520(conﬁg)# http 192.168.0.2 255.255.255.255 inside
NOTE
Some corporate security managers only access the PIX or ASA console port via a
secure, nonnetworked terminal in the data center or another form of secure
out-of-band management. To reduce the risk of a hacker breaking into the PIX
or ASA using admin accounts and making unauthorized changes for other pos-
sible attacks, they will not permit access methods such as Telnet, SSH, the PDM,
ASDM, or CSPM. Although this access method is very secure, it makes PIX/ASA
management and support very difﬁcult.
www.syngress.com
248
Chapter 6 • Firewall Design: Cisco PIX and ASA

Authenticating Management Access to the PIX
Suppose you have a large organization in which many administrators have access to the
PIX/ASA for management and the security policy calls for each admin to have a unique ID
and password so that changes to the PIX/ASA can be tracked and administrators can be held
accountable.
To accomplish this task, the PIX/ASA has a feature called authentication, authorization, and
accounting (also known as AAA).AAA can authenticate users managing the PIX/ASA via
CLI,ASDM, or the PDM tool.AAA can be applied to admins accessing the PIX/ASA via
the following methods: console,Telnet, SSH, and HTTP. With AAA conﬁgured, the
PIX/ASA will authenticate the username and password information with a local ID or an
external RADIUS or TACACS+ server. If the PIX/ASA receives an “Accept” response from
the RADIUS or TACACS+ server, the user will be allowed to gain access to the PIX/ASA.
If a “Reject” message is received, the user will be denied access.The AAA feature can also
limit the commands by authorizing each command an admin enters.This tool is useful if
you have many administrators who have access to the PIX/ASA.You might want an admin-
istrator to have the ability to troubleshoot the PIX/ASA, which requires the use of show and
clear commands, and provide other senior or advanced administrators the ability to make
conﬁguration changes to interfaces, access rules, routing, and so on. Unlike Cisco routers and
switches, the PIX/ASA currently does not support accounting, which logs changes adminis-
trators make. However, the PIX/ASA can provide AAA services for trafﬁc passing through
the PIX/ASA, as we discuss in detail later in this chapter.
Figure 6.9 details the conﬁguration needed to implement authentication of administra-
tive access to the PIX/ASA.The aaa-server command sets the server that will authenticate the
admin IDs to either RADIUS or TACACS+.This command is also used to identify the
interface on the PIX/ASA in which the RADIUS or TACACS+ resides, its IP address, and
the encryption key used for encrypted communication between the PIX/ASA and the
server and assigns it a group tag. In this example, we authenticate to a TACACS+ server.The
IP address of the server is 192.168.1.50, the shared encrypted key is mykey, and we assigned
it the group tag of AuthAdmin.The aaa authentication command speciﬁes the access method
and matches it to a group tag.This example shows how to conﬁgure authentication for each
of the methods discussed in this section.The last line in this example enables command
authorization using the aaa authorization command. Before you enable command authoriza-
tion, make sure that you are logged into the ﬁrewall with a user account that is authorized to
run commands or you may ﬁnd yourself locked out of the ﬁrewall.You can do this by run-
ning the command show curpriv and verifying that the user you are logged in as is deﬁned on
the AAA server and has the appropriate command authorization level.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
249

NOTE
The Cisco Secure Access Control Server (ACS), which can act as either a
TACACS+ or RADIUS server, also needs to be conﬁgured to complete the AAA
implementation. You can ﬁnd more information on ACS on Cisco’s Web site at
www.cisco.com/univercd/cc/td/doc/product/access/acs_soft/csacs4nt/acs31/acsuse
r/index.htm.
Figure 6.9 Conﬁguring AAA for the 6.x OS
Pix515(conﬁg)# aaa-server AuthAdmin protocol tacacs+
Pix515(conﬁg)# aaa-server AuthAdmin (inside) host 192.168.1.50 mykey
timeout 5
Pix515(conﬁg)# aaa authentication serial console AuthAdmin
Pix515(conﬁg)# aaa authentication Telnet console AuthAdmin
Pix515(conﬁg)# aaa authentication ssh console AuthAdmin
Pix515(conﬁg)# aaa authentication http console AuthAdmin
Pix515(conﬁg)# aaa authentication enable console AuthAdmin
Pix515(conﬁg)# aaa authorization command AuthAdmin
The same basic commands are used to conﬁgure AAA for either the 6.x or 7.x PIX/ASA
software.The only minor difference is that on the PIX 7.x software the aaa-server commands
bring you into an AAA server conﬁguration mode, from which you must exit before run-
ning the rest of the commands. Figure 6.10 illustrates the 7.x conﬁguration commands.
Figure 6.10 Conﬁguring AAA for the 7.x OS
ASA5520(conﬁg)# aaa-server AuthAdmin protocol tacacs+
ASA5520(conﬁg-aaa-server-group)# exit
ASA5520(conﬁg)# aaa-server AuthAdmin (inside) host 10.21.120.46 mypubkey timeout
5
ASA5520(conﬁg-aaa-server-host)# exit
ASA5520(conﬁg)# aaa authentication ssh console AuthAdmin
ASA5520(conﬁg)# aaa authentication serial console AuthAdmin
ASA5520(conﬁg)# aaa authentication Telnet console AuthAdmin
ASA5520(conﬁg)# aaa authentication http console AuthAdmin
ASA5520(conﬁg)# aaa authentication enable console AuthAdmin
ASA5520(conﬁg)# aaa authorization command AuthAdmin
www.syngress.com
250
Chapter 6 • Firewall Design: Cisco PIX and ASA

PIX/ASA Conﬁguration Basics
In this section, we cover the basic conﬁguration steps needed to set up the PIX/ASA to pro-
vide internal user access to the Internet, support for a DMZ, and connectivity to the
Internet. Here we discuss how to deﬁne interfaces, conﬁgure NAT, set access rules, and
enable routing. By the end of this section, you will be familiar with the basic conﬁguration
steps for the PIX/ASA and be able to apply these steps to the conﬁguration of your
PIX/ASA ﬁrewall.
Deﬁning Interfaces
Before conﬁguring the interfaces on the PIX/ASA, you must have your design laid out and
know the function of each PIX/ASA interface.This process includes:
■
Naming the interface
■
Assigning a security level
■
Conﬁguring an IP address 
■
Setting the speed and duplex of the interface
The commands required to perform these tasks differ based on whether the ﬁrewall is
running the 6.x or 7.x version of the OS. We will ﬁrst look at the 6.x OS commands, then
the 7.x OS commands. Figure 6.11 shows a design for a traditional “three-legged” ﬁrewall,
detailing the number of interfaces and their IP addresses required to implement this environ-
ment.The switches connecting the PIX/ASA to the inside, outside, and DMZ LANs are all
capable of running at 100Mbps full duplex. Once the basic information has been compiled,
we can begin to add the conﬁguration needed to set up the interfaces on the PIX/ASA.
Figure 6.11 PIX/ASA Interface Conﬁguration 
Firewall Design: Cisco PIX and ASA • Chapter 6
251
Internal LAN
DMZ
Web
Server
E-Mail
Server
FTP
Server
Users
Internet
Internet
Router
PIX
 Inside Interface
IP Address
192.168.0.1 /24
Outside Interface
IP Address 
11.1.1.1/28
DMZ Interface
IP Address
11.1.2.1 /24
www.syngress.com

In conﬁguring the interface, the ﬁrst step is to name and deﬁne a security level for each
active interface. When the PIX/ASA boots up, it assigns a hardware ID to each interface it
detects and is licensed for. In this example, we have a PIX 515E with an optional one-port
Fast Ethernet card inserted into one of the chassis’ open PCI slots.The two embedded PIX
515E Fast Ethernet interfaces are assigned the hardware IDs ethernet0 and ethernet1.The
optional one-port Fast Ethernet card is assigned ethernet2.The PIX will allow you to logi-
cally name the PIX’s interfaces, so you can rename them something more relevant.The only
exception to this is the 6.x OS, which requires the interface with security level 100 (we dis-
cuss security levels in the next paragraph) to be named inside. For example, the default inter-
face name for the optional one-port Fast Ethernet is intf2, but we will rename it to better
describe its usage and call it DMZ, since it will house the DMZ LAN.
Once we choose the function and naming convention for the PIX’s or ASA’s interfaces,
we must now decide on a security level for each interface.You can assign a security level
between 0 and 100, where 0 is the least secure interface and 100 is the most secure interface.
The most secure interface on the PIX/ASA is always the inside interface, which has a secu-
rity level of 100, and the least secure is usually your Internet-facing interface, or the outside
interface, which has a security level of 0.The security levels are designed to let the PIX/ASA
know how to treat packets entering its interfaces. Sessions originating and entering the
PIX/ASA on an interface with a high security level will be permitted by default to travel
through PIX/ASA on any interface with a lower security level and allow packets associated
with this session to return.
However, a session originating from a lower security interface will not be forwarded to
an interface with a higher security level unless explicitly permitted by an ACL. Other inter-
faces, such as the DMZ interface in Figure 6.11, need to be assigned a value between 1 and
99, which signiﬁes semitrusted networks and treats them as such, allowing them only default
access to the lower security interfaces, such as the outside interface or another DMZ inter-
face with a lower security level.
For example, a user on the internal LAN can access a Web site on the Internet because
the user’s HTTP request will originate from the PIX/ASA’s inside interface and be per-
mitted to exit the outside interface and return due to the fact the inside interface has a
greater security level than the outside interface.The same is true if the user wants to access a
Web site located on the DMZ interface of the PIX/ASA, because the inside interface has a
greater security level than the DMZ interface. If the user moved his or her workstation to
the DMZ LAN, he or she would still be able to access a Web site on the Internet because
the DMZ interface has a greater security level than the outside interface. However, if the
user tried to access any resources on the PIX/ASA’s inside interface, access would be denied
because the DMZ interface has a lower security level than the inside interface unless access
was explicitly allowed. Packets originating from the Internet and entering the PIX/ASA
from the outside interface will not be forwarded on any of the PIX/ASA’s other interfaces
unless explicitly allowed via an ACL. Later in this chapter, we will discuss how to conﬁgure
the PIX/ASA to allow access from an interface with a lower security level to an interface
with a higher security level using ACLs.
www.syngress.com
252
Chapter 6 • Firewall Design: Cisco PIX and ASA

NOTE
Prior to PIX OS version 5.3, it was necessary to deﬁne the outside interface as
Ethernet0 and the inside interface as Ethernet1. Although this is not a require-
ment for PIX OS version 5.3 and greater, it is recommended that you continue
to use this convention. 
PIX OS 6.x Interface Conﬁguration
The naming and assignment of the security level of an interface is implemented differently
for the PIX 6.x OS and the PIX/ASA 7.x OS. For the PIX 6.x OS, it is implemented using
the nameif command. Figure 6.12 shows how to conﬁgure the DMZ infrastructure pictured
in Figure 6.11. Within the nameif command, you need to associate the hardware ID to a log-
ical name and a security level. In this case, Ethernet0 and Ethernet1 are left at their defaults,
which are outside with a security level of 100 and inside with a security level of 0, respec-
tively.The default conﬁguration on Ethernet2 is overwritten and changed to DMZ with a
security level of 50.
Figure 6.12 Conﬁguring Interface Names and Security Levels
Pix515(conﬁg)# nameif ethernet0 outside security0
Pix515(conﬁg)# nameif ethernet1 inside security100
Pix515(conﬁg)# nameif ethernet2 DMZ security50
NOTE
For the 6.x OS, the interface assigned security level 100 can only be named
inside. This is no longer the case with the PIX/ASA 7.x OS. When assigning secu-
rity levels, keep expansion in mind and allow some space between security
levels in case you have to add another interface with a security level that sits
between two previously conﬁgured interfaces. 
The next step is to conﬁgure the IP addresses for each of the active interfaces on the
PIX. IP addresses should always be statically assigned to each active interface, except in the
case where you are connecting to a broadband service provider that is assigning IP addresses
dynamically to the PIX’s outside IP address via DHCP.The ip address if_name ip_address [net-
mask] command is used to assign static IP addresses to each of the PIX’s interfaces, as shown
in Figure 6.13.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
253

Figure 6.13 Conﬁguring IP Addresses
Pix515(conﬁg)# ip address inside 192.168.0.1 255.255.255.0
Pix515(conﬁg)# ip address outside 11.1.1.1 255.255.255.240
Pix515(conﬁg)# ip address DMZ 11.1.2.1 255.255.255.0
The last step in the conﬁguration of the PIX’s interfaces is to set the speed and duplex
and turn up the interface. By default, all the PIX’s interfaces are disabled and set to autode-
tect speed and duplex settings. In the prior DMZ example, we said that all the segments
were capable of running at 100Mb full duplex.
Figure 6.14 shows the use of the interface hardware_id [hardware_speed] [shutdown] com-
mand to conﬁgure each interface as 100Mbps full duplex as well as activating each interface
by simply not adding the shutdown keyword to the interface command.
Figure 6.14 Setting Interface Speed and Duplex
Pix515(conﬁg)# interface ethernet0 100full
Pix515(conﬁg)# interface ethernet1 100full
Pix515(conﬁg)# interface ethernet2 100full
NOTE
It is always a good idea to hard-code the speed and duplex settings into both
the PIX and the switch. It is common for the autodetect feature not to detect
the correct settings, and you could end up with a speed or duplex mismatch,
which will cause errors on the interfaces. In addition, if you have already conﬁg-
ured your PIX but you do not think it is performing optimally, check these set-
tings on the PIX and the switch to make sure they match. This is one of the
major culprits in performance-related issues, especially in new installations.
PIX OS 7.x Interface Conﬁguration
For the PIX/ASA 7.x OS, the same fundamental tasks need to be performed: naming and
assigning a security level to an interface, assigning an IP address, and setting the interface
speed and duplex. However, the commands to perform these tasks are different. With the
PIX/ASA 7.x OS, Cisco made the interface conﬁguration functions work more like they do
in the Cisco IOS.This means that instead of using multiple commands to perform each task,
you enter an interface conﬁguration mode and perform the conﬁguration of the naming,
security-level assignment, IP address assignment, and speed and duplex settings from there, as
www.syngress.com
254
Chapter 6 • Firewall Design: Cisco PIX and ASA

shown in Figure 6.15.The conﬁguration uses the interface conﬁguration subcommand
nameif to assign the appropriate name to the interface.The command security-level is used to
assign the appropriate security level.The ip address ip_address [netmask] command is used to
assign an IP address to the interface.The command speed is used to assign the interface speed
(default is auto), whereas the command duplex is used to assign the interface duplex mode
(default is auto).
Figure 6.15 PIX/ASA 7.x Interface Conﬁguration
ASA5520(conﬁg)# interface ethernet0
ASA5520(conﬁg-if)# nameif outside
ASA5520(conﬁg-if)# security-level 0
ASA5520(conﬁg-if)# ip address 11.1.1.1 255.255.255.240
ASA5520(conﬁg-if)# speed 100
ASA5520(conﬁg-if)# duplex full
# The next 6 lines conﬁgure the inside interface
ASA5520(conﬁg-if)# interface ethernet1
ASA5520(conﬁg-if)# nameif inside
ASA5520(conﬁg-if)# security-level 100
ASA5520(conﬁg-if)# ip address 192.168.0.1 255.255.255.0
ASA5520(conﬁg-if)# speed 100
ASA5520(conﬁg-if)# duplex full
# The next 6 lines conﬁgure the DMZ interface
ASA5520(conﬁg-if)# interface ethernet2
ASA5520(conﬁg-if)# nameif DMZ
ASA5520(conﬁg-if)# security-level 50
ASA5520(conﬁg-if)# ip address 11.1.2.1 255.255.255.0
ASA5520(conﬁg-if)# speed 100
ASA5520(conﬁg-if)# duplex full
Verifying the Interface Conﬁguration
Use the show interface command to display all interfaces on the PIX/ASA as well as its name,
status, IP address, statistics, and settings.The display in Figure 6.16 shows a PIX with three
interfaces (the output is from the 7.x OS; the 6.x OS is the same command with slightly dif-
ferent output).This command displays a good deal of useful information, but for the purpose
of setting up the ﬁrewall’s interface, let’s focus on the ﬁrst line of each interface, which dis-
plays the status of that particular interface, IP address, and the speed and duplex settings
(highlighted in bold in the ﬁgures).The ﬁrst line for each interface shows you the name of
the interface as the availability of the interface would, shown as either “up” or “down.”This
line also shows the status of the line protocol. If line protocol is “up,” the interface is opera-
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
255

tional and able to send and receive trafﬁc; or it will show “down” when the cable is not
plugged in or there is a problem with the cable.You can also use this command to view the
automatically or statically discovered speed and duplex settings as well as the IP address
assigned to each interface.
Figure 6.16 Show Interface Display
Pix515# show interface
Interface Ethernet0 “outside”, is up, line protocol is up
Hardware is i82559, BW 100 Mbps
Full-Duplex(Full-duplex), 100 Mbps(100 Mbps)
MAC address 0004.9ad0.b5a0, MTU 1500
IP address 11.1.1.1, subnet mask 255.255.255.240
0 packets input, 0 bytes, 0 no buffer
Received 0 broadcasts, 0 runts, 0 giants
0 input errors, 0 CRC, 0 frame, 0 overrun, 0 ignored, 0 abort
0 L2 decode drops
196 packets output, 12544 bytes, 0 underruns
0 output errors, 0 collisions, 0 interface resets
0 babbles, 0 late collisions, 0 deferred
0 lost carrier, 0 no carrier
input queue (curr/max blocks): hardware (128/128) software (0/0)
output queue (curr/max blocks): hardware (0/14) software (0/1)
Trafﬁc Statistics for "outside":
0 packets input, 0 bytes
196 packets output, 5488 bytes
0 packets dropped
1 minute input rate 0 pkts/sec,
0 bytes/sec
1 minute output rate 0 pkts/sec,
0 bytes/sec
1 minute drop rate, 0 pkts/sec
5 minute input rate 0 pkts/sec,
0 bytes/sec
5 minute output rate 0 pkts/sec,
0 bytes/sec
5 minute drop rate, 0 pkts/sec
Interface Ethernet1 “inside”, is up, line protocol is up
Hardware is i82559, BW 100 Mbps
Full-Duplex(Full-duplex), 100 Mbps(100 Mbps)
MAC address 0004.9ad0.b5a1, MTU 1500
IP address 192.168.0.1, subnet mask 255.255.255.0
47552 packets input, 4385636 bytes, 0 no buffer
Received 37037 broadcasts, 0 runts, 0 giants
0 input errors, 0 CRC, 0 frame, 0 overrun, 0 ignored, 0 abort
0 L2 decode drops
www.syngress.com
256
Chapter 6 • Firewall Design: Cisco PIX and ASA

13512 packets output, 5890064 bytes, 0 underruns
0 output errors, 0 collisions, 0 interface resets
0 babbles, 0 late collisions, 0 deferred
0 lost carrier, 0 no carrier
input queue (curr/max blocks): hardware (128/128) software (0/26)
output queue (curr/max blocks): hardware (0/40) software (0/1)
Trafﬁc Statistics for "inside":
47531 packets input, 3693104 bytes
13517 packets output, 5674180 bytes
25966 packets dropped
1 minute input rate 5 pkts/sec,
412 bytes/sec
1 minute output rate 2 pkts/sec,
257 bytes/sec
1 minute drop rate, 2 pkts/sec
5 minute input rate 3 pkts/sec,
342 bytes/sec
5 minute output rate 0 pkts/sec,
0 bytes/sec
5 minute drop rate, 2 pkts/sec
Interface Ethernet2 “DMZ”, is up, line protocol is up
Hardware is i82559, BW 100 Mbps
Full-Duplex(Full-duplex), 100 Mbps(100 Mbps)
MAC address 0003.47dd.ec4d, MTU 1500
IP address 11.1.2.1, subnet mask 255.255.255.0
0 packets input, 0 bytes, 0 no buffer
Received 0 broadcasts, 0 runts, 0 giants
0 input errors, 0 CRC, 0 frame, 0 overrun, 0 ignored, 0 abort
0 L2 decode drops
2 packets output, 128 bytes, 0 underruns
0 output errors, 0 collisions, 0 interface resets
0 babbles, 0 late collisions, 0 deferred
0 lost carrier, 0 no carrier
input queue (curr/max blocks): hardware (128/128) software (0/0)
output queue (curr/max blocks): hardware (0/1) software (0/1)
Trafﬁc Statistics for "DMZ":
0 packets input, 0 bytes
2 packets output, 56 bytes
0 packets dropped
1 minute input rate 0 pkts/sec,
0 bytes/sec
1 minute output rate 0 pkts/sec,
0 bytes/sec
1 minute drop rate, 0 pkts/sec
5 minute input rate 0 pkts/sec,
0 bytes/sec
5 minute output rate 0 pkts/sec,
0 bytes/sec
5 minute drop rate, 0 pkts/sec
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
257

Conﬁguring NAT
Network Address Translation (NAT) is one of the basic features of the PIX/ASA ﬁrewall.
NAT converts private, internal IP addresses into publicly routable addresses.You might want
to translate, or to NAT (using the term as a verb to describe this process), your internal
addresses because they are nonroutable private addresses or to discourage attacks from the
Internet. Request for Comment (RFC) 1918 lists the addresses that are available for private
use on the internal network.The Internet Assigned Numbers Authority (IANA) has reserved
the following three blocks of the IP address space for private networks:
■
10.0.0.0 through 10.255.255.255 (10 /8 preﬁx)
■
172.16.0.0 through 172.31.255.255 (172.16 /12 preﬁx)
■
192.168.0.0 through 192.168.255.255 (192.168 /16 preﬁx)
NOTE
You can learn more about RFC 1918 by visiting the RFC document online:
www.cis.ohio-state.edu/cgi-bin/rfc/rfc1918.html.
If you are using these addresses on your internal LAN and clients on the internal LAN
need to communicate with Internet resources, you need to NAT these addresses to public
addresses to be routed throughout the Internet. Public addresses are typically IP addresses
assigned to your organization by the Network Information Center (NIC) or by your ISP.
The problem facing IPv4 is that the public address pool is being slowly depleted, so network
administrators may no longer be able to assign public addresses to all clients on their internal
LANs and have them access Internet resources without the use of NAT. For this reason,
administrators are forced to assign private addresses to internal clients and use their allocated
public addresses for NAT address pools and for DMZ-provided services directly accessible by
the Internet, such as Web and e-mail relays.
NAT makes it possible for a small number of public IP addresses to provide Internet
connectivity for a large range of hosts. PAT is sometimes used synonymously with NAT.
However, NAT and PAT function slightly differently. NAT can provide a static one-to-one
IP mapping between private and public addresses or dynamically map a large number of
internal private addresses to a pool of public addresses.The problem with Dynamic NAT is
that once the pool of public addresses has been exhausted, the PIX/ASA will not be able to
NAT additional internal address until an address in the public pool is free, whereas PAT can
map very large numbers of private addresses to a single public IP address. PAT dynamically
maps a connection requested from the private address range and assigns it a unique port
www.syngress.com
258
Chapter 6 • Firewall Design: Cisco PIX and ASA

number on a single public address as a connection is requested.As a result, a single public IP
address can support up to 65,535 connections.
Table 6.1 shows four addresses PAT’d to a single IP address. Notice that the only differ-
ence is the translated port.The PIX will hold a similar table in memory so that it knows to
which real address to send the reply trafﬁc.
Table 6.1 Port Address Translation 
Real Address
Real Port
Translated Address
Translated Port
192.168.1.2
1234
11.1.1.1
1024
192.168.1.3
1444
11.1.1.1
1025
192.168.1.4
1500
11.1.1.1
1026
192.168.1.5
1234
11.1.1.1
1027
For the PIX 6.x OS, NAT conﬁguration statements are required for all connectivity
through the PIX/ASA, even if NAT is not required.You need to conﬁgure the PIX not to
NAT and let the real address ﬂow through without being translated. With the 7.x OS, this is
no longer the case. Cisco introduced the nat-control command, which eliminates the require-
ment for address translation policies to be in place. We will talk more about nat-control later
in this chapter.
In this section, we break down the NAT conﬁguration into two parts—outbound NAT
and inbound NAT—because they require different commands to implement. Outbound
NAT occurs when a device on a secure interface needs to communicate through a less
secure interface to reach its destination. Inbound NAT occurs when a device on a less secure
interface needs to communicate through a more secure interface to reach its destination. We
will also break down the examples into both 6.x and 7.x OS sections because Cisco funda-
mentally changed some of the NAT conﬁgurations and functionality in the 7.x OS for both
the PIX and the ASA.
NOTE
This book details how to set up a DMZ environment, but the PIX/ASA and all its
features, including NAT, can be conﬁgured to accommodate many different
requirements or designs. In this NAT section, we focus on how to set up NAT for
some conventional DMZ designs. Keep in mind that the PIX’s and ASA’s NAT
and PAT features can be conﬁgured for a variety of scenarios, including con-
necting networks with conﬂicting IP addressing. You might have conﬂicting net-
work addresses when your company acquires a company (or your company
becomes acquired) with the same internal network numbering scheme. In
today’s world of mergers and acquisitions, this conﬁguration will become a def-
inite reality for most ﬁrewall administrators. 
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
259

Outbound NAT
With the PIX/ASA 7.x OS, Cisco introduced a new command that fundamentally changed
how the ﬁrewall handled NAT. Historically, whether you actually intended to perform NAT
or not, you always needed to conﬁgure NAT on the ﬁrewall, even if the conﬁguration was
nothing more than conﬁguring the ﬁrewall to not NAT any trafﬁc. If you did not do this,
the ﬁrewall would simply not permit any outbound trafﬁc. In the 7.x OS, this behavior was
changed to allow the ﬁrewall, by default, to permit all outbound trafﬁc, even if NAT is not
conﬁgured.The command that controls this functionality is the nat-control command.
By default, the nat-control command is disabled (no nat-control), which conﬁgures the ﬁre-
wall to allow trafﬁc from a higher security-level interface (for example, inside) to pass to a
lower security level interface (for example, outside) without NAT. If you want the ﬁrewall to
perform outbound NAT, you must run the nat-control command, as shown in Figure 6.17.
The rest of this section assumes that nat-control has been conﬁgured on the ﬁrewall, thus
requiring NAT or PAT conﬁguration commands to allow the ﬁrewall to pass outbound
trafﬁc.
Figure 6.17 Conﬁguring nat-control on a Firewall
houqepixfw01(conﬁg)# nat-control
For the 6.x OS, when a connection from a more secure interface to a less secure inter-
face is necessary, a NAT or PAT statement needs to be conﬁgured, regardless of whether you
need to NAT or PAT the address on the interface with the higher security interface. For the
7.x OS, if the nat-control command has been enabled, a NAT or PAT statement also needs to
be conﬁgured.This tells the PIX/ASA whether or not to NAT or PAT the packets as they
pass through the PIX. For example, if users on the inside interface, which are on private
address space, need to access the Internet, they must be translated to a public address space
that is routable on the Internet.The three options to conﬁgure outbound address translation
are Static NAT, Dynamic NAT, and Dynamic PAT.
Outbound connections usually call for Dynamic NAT or Dynamic PAT. Conﬁguring
outbound NAT usually requires two steps.The ﬁrst step is to identify whether NAT is
required for a speciﬁed range of IP addresses and, if it is, assign it a NAT ID.The second step
is to assign the NAT ID to a public address pool for Dynamic NAT or a single public
address to be used by PAT.
The nat [(real_ifc)] nat_id real_ip [mask [dns] [outside | norandomseq] [max_conns
[emb_limit]]]] (6.x OS) or nat (real_ifc) nat_id real_ip [mask [dns] [outside] [[tcp] tcp_max_conns
[emb_limit]][udp udp_max_conns] [norandomseq]] (7.x OS) command is used to complete Step
1.As you can see, the commands are very similar, with the 7.x command having a few new
options.The nat command requires you to conﬁgure the interface to which the NAT should
be applied, the NAT ID, the range of IP addresses to be translated, and connection limits.
The real_ifc parameter tells the PIX to NAT connections initiated from the speciﬁed PIX
www.syngress.com
260
Chapter 6 • Firewall Design: Cisco PIX and ASA

interface that match the IP address range speciﬁed by the real_ip mask parameters.The nat_id
parameter is used to group the hosts to be translated and will be used later, in Step 2. If the
nat_id parameter is set to 0, the PIX will not NAT the speciﬁed range.
The max_conns, tcp_max_conns, udp_max_conns, and emb_limit parameters specify the con-
nection limits and the embryonic limit, respectively.The connection limit is the number of
simultaneous connections allowed by the PIX initiated by the speciﬁed IP range. In the 6.x
OS, the maximum number of connections is deﬁned as a single value (max_conns) for both
TCP and UDP connections. In the 7.x OS, you can deﬁne separate maximum connection
values for TCP (tcp_max_conns) or UDP (udp_max_conns) accordingly.The embryonic limit is
the number of connections that have started but have not completed, meaning that they have
not completed the three-way handshake. By default, both these parameters are set to 0,
which means that the PIX will allow an unlimited number of active connections and an
unlimited number of embryonic connections or incomplete connections. Setting these
parameters to numbers other than 0 allows the PIX to limit the number of connections
made by the speciﬁed IP range and protect your network from propagating (but not being
targeted by) SYN or ﬂood attacks.
These parameters are relevant in both internally and externally initiated connections set-
tings.They will also protect your network from SYN or ﬂood attacks initiated from the
Internet. Since this type of protection is more relevant on connections initiated outside your
network, we discuss the importance of setting these parameters later in the “Inbound NAT”
section. Keep in mind that if you know the number of connections your internal users need
and want that will prevent internal clients from acting as a propagation point for ﬂood
attacks, it’s a good idea to set the connection and embryonic limits to a value other than 0.
Be careful not to set them too low, which would prevent valid connections passing through
the PIX. Once they’re set, you need to monitor the number of connections from time to
time to verify that increased usage from normal growth is not about to eclipse your limits, in
which case you need to adjust your settings.
The dns, outside, and norandomseq parameters are generally not used in most environ-
ments.The dns parameter causes the ﬁrewall to rewrite the DNS A record from the mapped
value to the real value.The outside parameter is required if the interface you are conﬁguring
NAT on is on a lower security level than the interface than the interface that will be identi-
ﬁed by the corresponding global statement (the second step in conﬁguring outbound NAT).
This is known as outside or bidirectional NAT.The norandomseq parameter disables TCP ISN
randomization protection.TCP sequence randomization is a security enhancement that
limits an attacker’s ability to successfully achieve a TCP hijack attack. It should be disabled
only if there is another inline ﬁrewall that is also randomizing sequence numbers, because
both ﬁrewalls randomizing the sequence numbers can scramble the data.
The nat [(real_ifc)] 0 access-list acl_name command tells the PIX not to NAT packets that
match the criteria set by an access list.The use of an access list gives the PIX ﬂexibility not
only based on source IP addresses, as the standard nat command does, but also on destination
IP address. For this command to function, it requires the creation of an ACL and the nat
command with the 0 access-list option.The ACL used with the nat command only matches
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
261

on Layer 3 and must not contain any port speciﬁcation. (We explore ACLs in depth later in
this chapter.) Although this functionality might sound similar to the no nat-control function-
ality in the 7.x OS, there is a subtle difference. With the no nat-control command, you are not
using NAT on the ﬁrewall at all. With the NAT 0 command, you are using NAT on the
ﬁrewall but are conﬁguring a mechanism to bypass NAT for a speciﬁc scenario.Although
functionally the trafﬁc is not being NAT’d in either case, it’s important to understand that
subtle difference.
The second step assigns the NAT ID to a global address pool for Dynamic NAT or a
single public address to be used by PAT.The global [(mapped_ifc)] nat_id {mapped_ip[-mapped_ip]
[netmask mask] | interface} command is used to tie the IP address range speciﬁed with the nat
command to an IP address or a range of global IP addresses. In an outbound connection sce-
nario where internal users need to access resources on the Internet, the global addresses need
to be in the public address range so they can be routed throughout the Internet.The mapped_ifc
parameter is the outbound interface where the translated IP address will exit.The nat_id
parameter ties the global command to the nat command, which identiﬁes the IP addresses that
need to be translated.The next parameter speciﬁes whether the ﬁrewall should perform
Dynamic NAT or Dynamic PAT. If only one global IP address is speciﬁed in the mapped_ip
parameter, the ﬁrewall will perform Dynamic PAT, but if a range of global IP addresses is speci-
ﬁed (mapped_ip-mapped_ip], the ﬁrewall will perform Dynamic NAT.The mask parameter spec-
iﬁes the mask for the global IP addresses. If the nat command has a 0 speciﬁed as its nat_id, no
global command is needed, since the 0 NAT ID means “do not NAT.”
We use the diagram in Figure 6.18 as an example of how the nat and global commands
work together to provide Dynamic NAT and PAT. We have a network with two internal
LAN subnets, a PIX to provide secure access to the Internet for internal users and to support
a DMZ with Web, e-mail, and FTP servers. Since the two-user subnet is on private address
space, the IP addresses of internal PCs need to be translated to a public IP address to access
Internet resource.The servers on the DMZ already have public addresses, so they can initiate
connections to resources on the Internet without the aid of NAT.The setup has several
requirements, which are listed in Table 6.2. We need to conﬁgure PAT so that all user PCs
on internal LAN A can access the Internet via a single public address. Users on internal
LAN B also need to access the Internet, but they have a special requirement that will enable
the ﬁrst seven addresses to be dynamically NAT’d and the rest can be translated via PAT.All
access from the internal LAN to the DMZ should not be translated, nor should any access
from the DMZ to the Internet.
www.syngress.com
262
Chapter 6 • Firewall Design: Cisco PIX and ASA

Figure 6.18 NAT Example 
Table 6.2 Outbound NAT
Network/Device
Actual Address
Translated Address
Method
Internal LAN A
192.168.1.0 /24
11.1.1.2 /28
All PAT
Internal LAN B
192.168.2.0 /24
11.1.1.3–11.1.1.9 /28
Dynamic NAT (ﬁrst
seven addresses)
Internal LAN B
192.168.2.0 /24
11.1.1.10 /28
PAT (remaining
addresses)
Web server
11.1.2.2 /24
11.1.2.2 /24
No NAT
E-mail server
11.1.2.3 /24
11.1.2.3 /24
No NAT
FTP server
11.1.2.4 /24
11.1.2.4 /24
No NAT
Figure 6.19 exhibits the conﬁguration necessary to fulﬁll the PAT requirements of
internal LAN A and the special NAT and PAT requirements of internal LAN B.The ﬁrst
step is to assign each internal LAN a separate NAT ID via the nat command. NAT ID 1 is
assigned to internal LAN A, and NAT ID 2 is assigned to internal LAB B. Using the global
command with a single global IP address and specifying NAT ID 1 will enable Dynamic
PAT for all IP address on internal LAN A.All communication initiated from internal LAN A
will exit the PIX with an IP address of 11.1.1.2.To meet the special needs of internal LAN
B, we ﬁrst have to use the global command with a NAT ID of 2 and a global IP address
range between 11.1.1.3 and 11.1.1.9, which allows for seven dynamic one-to-one NAT
translations. Once the Dynamic NAT pool has been depleted, the remaining connections
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
263
Internal LAN A
DMZ
Web
Server
11.1.2.2
E-Mail
Server
11.1.2.3
FTP
Server
11.1.2.4
John’s PC
192.168.1.10
Internet
Internet
Router
PIX
Interface Inside
IP Address
192.168.0.1 /24
Interface Outside IP
Address 11.1.1.1 /28
Interface DMZ
IP Address
11.1.2.1 /24
Internal LAN B
Lisa’s PC
192.168.2.20
Fast Ethernet 0/2
IP Address
192.168.2.1 /24
Fast Ethernet 0/1
IP Address
192.168.1.1 /24

will be dynamically PAT’d to 11.1.1.10. If an IP address in the Dynamic NAT pool is freed
up, the next connection request will be dynamically NAT’d before returning to PAT.
Figure 6.19 Outbound NAT Conﬁguration, Part 1
Pix515(conﬁg)# nat-control
#This command is only required for the 7.x OS
Pix515(conﬁg)# nat (inside) 1 192.168.1.0 255.255.255.0 0 0
Pix515(conﬁg)# nat (inside) 2 192.168.2.0 255.255.255.0 0 0
Pix515(conﬁg)# global (outside) 1 11.1.1.2 netmask 255.255.255.240
Pix515(conﬁg)# global (outside) 2 11.1.1.3-11.1.1.9 netmask 255.255.
255.240
Pix515(conﬁg)# global (outside) 2 11.1.1.10 netmask 255.255.255.240
Figure 6.20 exhibits the conﬁguration necessary to fulﬁll requirements where internal
users can access the DMZ and servers on the DMZ can access the Internet without NAT.To
allow all internal users access to the DMZ without NAT requires the nat command with 0
access-list option.This form of the nat command is necessary because, as you might recall, we
already assigned the internal LAN A and LAN B NAT IDs that call for NAT.To override
this behavior when internal users access the DMZ, we must speciﬁcally tell the PIX not to
NAT internal LAN IP addresses when they access the DMZ.
The ﬁrst step is to specify an ACL called Inside2DMZ, which speciﬁes the source
address as the internal address ranges (192.168.1.0 /24 and 192.168.2.0 /24) and the destina-
tion address of the DMZ address range (11.1.1.2.0 /24) to be excluded from the NAT trans-
lation.The next step is to apply the access list to the nat command, which lets the PIX know
not to NAT internal IP addresses accessing the DMZ.To satisfy the last requirement, which
lets the servers on the DMZ access the Internet with the aid of NAT, we specify the DMZ
interface and the DMZ IP address range with the NAT ID of 0, which means to not NAT
this range on this interface.
Figure 6.20 Outbound NAT Conﬁguration, Part 2
Pix515(conﬁg)# access-list Inside2DMZ permit ip 192.168.1.0 255.255.255.
0 11.1.2.0 255.255.255.0
Pix515(conﬁg)# access-list Inside2DMZ permit ip 192.168.2.0 255.255.255.
0 11.1.2.0 255.255.255.0
Pix515(conﬁg)# nat (inside) 0 access-list Inside2DMZ
Pix515(conﬁg)# nat (DMZ) 0 11.1.2.0 255.255.255.0 0 0
Inbound NAT
By default, the PIX/ASA will not allow access from an interface with a lower security level
to access an interface with a higher security level.This type of inbound access has to been
www.syngress.com
264
Chapter 6 • Firewall Design: Cisco PIX and ASA

explicitly deﬁned.The ﬁrst step to allow this type of access is to deﬁne a NAT statement; the
second step is to apply access rules. In this section, we discuss how to set up NAT to allow
users on the Internet to access the PIX/ASA semisecure interfaces or DMZ interfaces.
Access initiated directly from the Internet to the inside interface, or internal LAN, should be
prohibited. Normal security policies prevent such access and only allow clients on the
Internet to interact with devices on the DMZ.
As with outbound NAT, for the PIX 6.x OS it is necessary to conﬁgure a NAT state-
ment, regardless of whether network address translation needs to take place. With the
PIX/ASA 7.x OS, this is not the case. Inbound NAT also has two options to conﬁgure
address translation: Static NAT and Static PAT. In setting up a DMZ, the most common
option is the Static NAT option, where there is a one-to-one IP address mapping. Because
there is a one-to-one mapping, this does not save public address space.
Another common conﬁguration is Static PAT. Unlike Static NAT, Static PAT does save
address space because it uses one public IP address and, depending on the port on which a
request comes in, it translates to any number of private addresses. For example, you can have
one IP address exposed to the Internet and have clients on the Internet make requests to this
IP address for services such as Web content (TCP port 80) or SMTP (TCP port 25).
Depending on the port the request is received on, the PIX will map and forward the request
to the real IP of the Web or mail servers, respectively.This section focuses on the Static NAT
and PAT commands needed to set up access to the DMZ.To conﬁgure Static NAT, the static
command is used.As with the nat command, the static command is slightly different,
depending on whether you are using the 6.x or 7.x OS. For the 6.x OS, the command is
static (real_ifc, mapped_ifc) {mapped_ip | interface} {real_ip [netmask mask] | access-list
acl_name} [dns][norandomseq] [max_conns [emb_limit]]. For the 7.x OS, the command is static
(real_ifc,mapped_ifc) mapped_ip {real_ip [netmask mask] | access-list access_list_name | interface}
[dns] [[tcp] max_conns [emb_limit]] [udp udp_max_conns] [norandomseq [nailed]].As with the
nat command, the static commands are fundamentally the same, although the 7.x OS supports
more parameters. Many of the parameters for the static command have the same meaning
and function as with the nat command, so we won’t review them again. What is important
are the functions and meanings of the parameters that are unique to the static command.
The syntax of this command can be confusing, so special attention is required because
the command asks for the interface names in the reverse order than it asks for the IP
addresses. In this form, the static command maps a virtual IP address on the less secure inter-
face to the actual IP address on the more secure interface, creating a one-to-one IP map-
ping.The real_ifc, the interface with the higher security level, and mapped_ifc, the interface
with lower security level, parameters specify the PIX’s interfaces on which the address trans-
lation needs to occur.The mapped_ip parameter is the virtual IP on the PIX’s less secure
interface that will be mapped to the real IP address speciﬁed by the real_ip parameter on the
PIX’s more secure interface.The mask parameter in one-to-one static mapping is set to
255.255.255.255 or host mask but can also be used for a net static.A net static is useful in a
situation in which you need to translate an entire network but want to keep the host por-
tion of the IP address the same. Figure 6.21 is an example of how to change the netmask so
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
265

that all hosts on network 11.1.1.0 /24 (outside) translate to a host on 10.1.2.0 /24 (DMZ).
In other words, 11.1.1.1 will be translated into 10.1.2.1, 11.1.1.2 to 10.1.2.2, 11.1.1.3 to
10.1.2.3, and 11.1.1.254 to 10.1.2.254.
Figure 6.21 Inbound Net Static NAT Example
Pix515(conﬁg)# static (DMZ,outside) 11.1.1.0 10.1.2.0 netmask 255.255.
255.0 0 0
Figure 6.22 is an example of a one-to-one NAT conﬁguration. In this example, there is
a DMZ interface on the PIX with servers on the 10.1.2.0 /24 subnet. Since the 10.1.2.0
/24 subnet is in the private range of addresses, it cannot be routed on the Internet.The
PIX’s outside interface is on the 11.1.1.0 /28 subnet, which is in the public address range.
We have a Web server on the DMZ with an IP address of 10.1.2.2 that needs to accessed by
the Internet, but since it’s on a private address, it cannot be accessed by the Internet, so we
need to conﬁgure NAT using the static command. In this example, we create a one-to-one
IP mapping between 10.1.2.2 and 11.1.1.11. Users on the Internet will now be able to
access the Web server via the 11.1.1.11 address, and the PIX will then translate the destina-
tion address to the real address, 10.1.2.2, and forward the packet to the Web server.The Web
server will then reply to the HTML request with the source address 10.1.2.2 and the desti-
nation address of the user.The PIX will receive the return packet and this time change the
source address from 10.1.2.2 to 11.1.1.11 and forward the packet.The user on the Internet
will receive the Web page and will never know that NAT has taken place.
Figure 6.22 Inbound NAT Conﬁguration with NAT
Pix515(conﬁg)# static (DMZ,outside) 11.1.1.11 10.1.2.2 netmask 255.255.
255.255 0 0
As we mentioned earlier, a NAT statement is required for the inbound connectivity,
even if address translation is not required (this is true for all versions of OS software). In this
case the static command has a slightly different syntax, static (real_ifc, mapped_ifc) real_ip real_ip
[netmask][conn_limit [em_limit]]. You can see that the mapped_ip parameter has been replaced
by a duplicate real_ip parameter.This simply tells the PIX not to NAT the speciﬁed the IP
address or range and make the IP address visible to the less secure interface “as is.”This is
known as identity NAT. Figure 6.23 is an example of an inbound identity NAT conﬁgura-
tion.The network 11.1.2.0 /24, located on the PIX’s DMZ interface (refer back to Figure
6.18), is made visible to the outside interface, so clients on the Internet can directly commu-
nicate with the servers on the DMZ without the use of NAT.
www.syngress.com
266
Chapter 6 • Firewall Design: Cisco PIX and ASA

Figure 6.23 Inbound NAT Conﬁguration Without NAT
Pix515(conﬁg)# static (DMZ,outside) 11.1.2.0 11.1.2.0 netmask 255.255.
255.0 0 0
Conﬁguring Static PAT, also known as port redirection, is slightly different from conﬁg-
uring Static NAT in that you do not specify a mapping based only on an IP address but also
on the port.The static (real_ifc, mapped_ifc) (tcp, udp) mapped_ip_mapped_port real_ip real_port
[netmask][max_conns [emb_limit]] command is used to deﬁne Static PAT; as you might notice,
it is very similar to Static NAT except that you are also deﬁning ports. Static PAT works
with only TCP and UDP packets. Figure 6.24 shows how to conﬁgure Static PAT for Web
and SMTP trafﬁc. In this example, if a request came to the IP address of the PIX’s outside
interface on TCP port 80 (WWW) or TCP port 25 (SMTP), it would be translated and for-
warded to the real IP addresses of the Web server (10.1.2.2) and mail server (10.1.2.3),
respectively. Notice that we supplemented the parameter mapped_ip with the keyword inter-
face, which means to use the IP address of the outside interface as the mapped_ip.
Figure 6.24 Inbound Static PAT Conﬁguration
Pix515(conﬁg)# static (DMZ,outside) tcp interface www 10.1.2.2 www
Pix515(conﬁg)# static (DMZ,outside) tcp interface smtp 10.1.2.3 smtp
In the previous section, we mentioned how setting the connection and embryonic limits
could protect your internal network from propagating SYN attacks; in this section, we dis-
cuss how to protect the servers on your DMZ from SYN and ﬂood attacks initiated from
the Internet. If you recall, the connection limit is the number of simultaneous connections
allowed by the PIX/ASA initiated by the speciﬁed IP range, and the embryonic limit is the
number of connections that have started but have not completed, meaning that the three-
way handshake has not been completed. Setting the embryonic limit (emb_limit) parameter
in the static command to a value other than 0 (0 means unlimited) enables SYN attack pre-
vention via the PIX/ASA’s TCP Intercept feature. Once the embryonic threshold is
exceeded, the PIX will enter TCP Intercept mode, where the PIX/ASA will complete the
three-way handshake on behalf of the server by intercepting all SYN packets and reply on
behalf of the server with an empty SYN/ACK.The PIX/ASA will keep the state informa-
tion, drop the packet, and wait for a reply from the client.
If the client replies with an ACK, the PIX/ASA will then complete the three-way hand-
shake with the server, and the server will be able to communicate with the client. If the
client fails to respond, the PIX/ASA sends exponential backoffs to the client.The PIX/ASA
will operate in TCP Intercept mode until the number of embryonic connections falls below
the threshold.
It is also a good idea to set the connection limit (max_conns) to a value other than the
default unlimited connection setting. Setting the connection limit can help mitigate the
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
267

risk of ﬂood attacks to servers that might be incapable of protecting themselves from this
form of attack. For example, if you have an e-mail server that never exceeds a speciﬁc
number of open sessions with other e-mail servers or clients and you would like to pro-
tect it from ﬂood attacks, which can render the server useless, consider setting the con-
nection and embryonic limit on the PIX/ASA’s static command. Figure 6.25 shows a
Static NAT conﬁguration for an e-mail server located on the PIX’s DMZ interface.The
e-mail server’s real IP address is 10.1.2.3 and is mapped to a publicly accessible address of
11.1.1.12.The connection and embryonic connection limits are set to 100 and 25,
respectively, meaning that the PIX will allow a no more than 100 simultaneous connec-
tions. If there are more than 25 embryonic connections, the PIX goes into TCP
Intercept mode to protect the e-mail server from SYN or ﬂood attacks. Be careful not
set the limit too low, because that will prevent valid connections to pass through the
PIX/ASA. Once the limit is set, you need to monitor the number of connections from time
to time to verify that increased usage from normal growth is not about to eclipse your limits,
in which case you will need to adjust your settings.
Figure 6.25 Preventing SYN and Flood Attacks
Pix515(conﬁg)# static (DMZ,outside) 11.1.1.12 10.1.2.3 netmask 255.255.
255.255 100 25
NOTE
In PIX OS version 5.2 and later, the PIX/ASA will operate in TCP Intercept mode
(also known as Flood Defender) once the embryonic limit has been reached. In
TCP Intercept mode, the PIX/ASA will complete the three-way handshake on
behalf of the server by intercepting all SYN packets and reply on behalf of the
server with an empty SYN/ACK. The PIX/ASA will keep the state information,
drop the packet, and wait for a reply from the client. If the client replies with an
ACK, the PIX/ASA will then complete the three-way handshake with the server,
and the server will be able to communicate with the client. If the client fails to
respond, the PIX/ASA sends exponential backoffs to the clients. The PIX/ASA will
operate in TCP Intercept mode until the number of embryonic connections falls
below the threshold. Prior to PIX OS version 5.2, if the PIX’s embryonic limit was
reached, it would allow no new connections to the server until the number
embryonic connections fell below the threshold—in essence, accomplishing
what a hacker wanted to do, which was to disrupt services provided by the
server.
www.syngress.com
268
Chapter 6 • Firewall Design: Cisco PIX and ASA

Verifying and Monitoring NAT
The PIX/ASA provides several commands in order to properly maintain, support, and trou-
bleshoot the NAT feature.The show xlate and clear xlate commands provide the ability to
show and clear NAT translations (also known as translation slots), respectively.The show xlate
command shows active NAT and PAT translations.The clear xlate command clears active
NAT or PAT translations and should be used when certain conﬁguration changes are
made to the PIX/ASA, including any changes related to the aaa-server, access-list, alias, con-
duit, global, nat, route, or static commands. It can also be useful for troubleshooting NAT or
PAT problems.The show conn command is useful to identify all active connections and can
be used to decide on values for the connection limit parameter in the nat and static com-
mands.The show static command can be used to view all the static NAT translations.
Conﬁguring Access Rules
One of the PIX/ASA’s most important features is the ACL feature, which is used to create
access rules that determine what connections can ﬂow outbound from the PIX/ASA (egress
ﬁltering) or inbound to protected resources (ingress ﬁltering).The ACLs allow the PIX/ASA
to permit or deny access based on source IP address and/or port and destination IP address
and/or port. Creating an ACL requires the use of the access-list command, where the ﬁrewall
administrator can permit or deny access based on set criteria. It is important to remember
that ACLs operate on a ﬁrst-match basis, meaning that the PIX/ASA will work its way down
the list and, when it ﬁnds a match, it will perform the speciﬁed action, whether a permit or
deny. It will stop without proceeding to the next line.As you create an ACL, remember that
order is important, especially with complex ACLs. Be careful to not permit access to an item
higher in the list and then have an explicit deny for it later in the ACL, or vice versa. If
ACLs are not carefully thought out, they might not have the desired effect of tight security,
leaving security holes in your network. Furthermore, at the end of all ACLs is in implicit
deny, meaning that if the PIX/ASA ﬁnished processing the access list lines and did not ﬁnd a
match, the trafﬁc will be denied.
The creation of an ACL requires the access-list command.This command is very similar
to the access-list command found in Cisco’s router IOS. With the PIX/ASA 7.x OS, Cisco
made some changes to how the access-list command functions. In the 6.x OS, an access list
was simply an access list. With the 7.x OS, however, the access-list command was made to
function even more like the Cisco IOS by supporting multiple types of access lists. For
example, the access-list standard is used to identify the destination IP addresses of OSPF
routes, whereas the access-list webtype command is used to for WebVPN trafﬁc.The access-list
extended command, however, is the access-list mechanism that provides the same functionality
as the PIX 6.x access-list command.The examples in this section will use the 7.x access-list
extended syntax, but you should realize that the commands can be used with minor syntax
modiﬁcations for any PIX running the 6.x OS.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
269

For the PIX 6.x OS, the syntax of the access-list command is access-list id [line line-num]
{deny | permit}{protocol | object-group protocol_obj_grp_id{source_addr source_mask} | object-
group network_obj_grp_id [operator port [port] | interface if_name | object-group
service_obj_grp_id] {destination_addr | remote_addr} {destination_mask | remote_mask} | object-
group network_obj_grp_id [operator port [port] | object-group service_obj_grp_id]} [log [[disable
| default] | [level]]] [interval secs]]. For the PIX/ASA 7.x OS, the syntax of the access-list
command is access-list id [line line-number] [extended] {deny | permit}{protocol | object-
group protocol_obj_grp_id}{src_ip mask | interface ifc_name | object-group network_obj_grp_id}
[operator port | object-group service_obj_grp_id] {dest_ip mask | interface ifc_name | object-
group network_obj_grp_id} [operator port | object-group service_obj_grp_id | object-group
icmp_type_obj_grp_id][log [[level] [interval secs] | disable | default]] [inactive | time-range
time_range_name].
At this point the odds are probably in favor of looking at those two complex syntaxes
and thinking,“There is no way I am going to be able to sort this command out.”The good
news is that for most ACLs and for the purposes of the examples in this chapter, the access-list
command syntax can be broken down into a number of commonly implemented parame-
ters. For the 6.x OS, the basic syntax is access-list id action protocol source_address operator src_port
destination_address operator dest_port. For the 7.x OS, the basic syntax is access-list id extended
action protocol source_address operator src_port destination_address operator dest_port. These com-
mands allow the ﬁrewall administrator to specify the actions, permit or deny, to packets that
match a certain criteria and logically group them so they can be applied as a set of rules to a
speciﬁc interface.The id parameter is used to logically group and name a list of access rules
that will later be used by the access-group command to assign the rules list to an interface.The
id can be a number or a name.The action parameter tells the PIX what to do with the packet
if there is a match.The valid values are permit, which allows the packet to be forwarded, or
deny, which drops the packet and does not allow connectivity.The protocol parameter is the
name or number of the IP protocol, which includes but is not limited to IP,TCP, UDP, and
ICMP.The source_address, src_port, destination_address, and dest_port parameters specify the ele-
ments on which the PIX/ASA will determine a match.To be considered a match, the packet
in question must identically match all the conﬁgured parameters, which can include the IP
address and/or port of the source and/or destination. If no source or destination port is
speciﬁed, the PIX/ASA assumes you will permit or deny access regardless of the port, but if
port speciﬁcation is required, an operator is necessary. Valid operators include lt for less than,
gt for greater than, eq for equal, neq for not equal, and range for an inclusive range.
NOTE
Although the PIX/ASA 7.x OS, uses a slightly different syntax for the access-list
command (notably the use of the extended parameter), you can actually enter
an access list on the 7.x OS using the PIX 6.x access-list syntax. In that instance,
the PIX/ASA will automatically assume that the access list is an extended access
list.
www.syngress.com
270
Chapter 6 • Firewall Design: Cisco PIX and ASA

To apply an ACL to an interface, use the access-group command. For the PIX 6.x OS
PIX,ACLs can only be applied inbound to an interface. With the PIX/ASA 7.x OS, this has
been changed to work in a similar fashion to the Cisco IOS by allowing the ACL to be
applied to either inbound or outbound trafﬁc on the interface. The access-group id [in | out]
interface if_name command is straightforward.There are only three parameters that you will
typically need to deal with.The id is the name or number of the ACL created with associ-
ated access-list command.The if_name parameter sets the ACL to the speciﬁed interface. For
the 6.x OS, the in parameter is used to specify that the ACL is applied to inbound trafﬁc. For
the 7.x OS, you can use either the in or the out parameter, with the out parameter applying
the ACL to outbound trafﬁc in the interface. Only one ACL can be applied per interface in
the 6.x OS, whereas you can have one inbound and one outbound ACL applied per inter-
face in the 7.x OS.
NOTE
Like the Cisco router IOS ACLs, the PIX processes its ACLs on a ﬁrst-match basis
and has an implicit deny all at the end of the ACL. However, unlike Cisco router
IOS, PIX ACLs do not use a wildcard; instead, they use a regular subnet mask in
the ACL deﬁnition.
Creating an Outbound 
Access Control List (Egress Filtering)
The PIX/ASA, by default, allows all connections initiated from a higher security-level inter-
face to a lower-level interface. If you want to control access from the more secure interface,
you can do so by creating an ACL and applying it to the interface with the higher security
level. For example, if your security policy states that users from the internal network cannot
initiate FTP sessions with servers on the Internet, you could prevent FTPs by implementing
an outbound ACL.An outbound ACL allows the PIX/ASA to permit or deny access based
on source IP address and/or port. Destination IP address and/or port or can be used with
user authentication to assign an ACL to a speciﬁc user. In this section, we discuss ﬁltering
only up to Layer 4 (the transport layer), but we do discuss user authentication and content
ﬁltering, such as URL,ActiveX, and Java ﬁltering, later in this chapter.To create and apply an
outbound ACL is a two-step process.The ﬁrst step is to create the ACL with the access-list
command, and the second step is to apply the ACL to an interface with the access-group
command.
If you recall the diagram in Figure 6.18, we had a PIX connecting two internal LANs, a
DMZ, and the Internet. Figure 6.26 shows how to conﬁgure the PIX to allow only internal
LAN A to connect to Internet sites via the standard Web port (WWW port 80), secure Web
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
271

sites (SSL port 443), FTP sites (FTP port 21) on the Internet, and the local DMZ. Internal
LAN B can access only the local DMZ.The ﬁrst three lines of this ACL permit internal
LAN A to access any resource on the Internet via TCP ports 80, 443, and 21.The next two
lines allow both internal LAN A and LAN B to access the DMZ. Because access to the
Internet was not explicitly permitted from internal LAN B, it will be denied.The last line in
Figure 6.26 applies the ACL named OutboundACL inbound to the inside interface of the
PIX.The syntax used in this example is the PIX 6.x syntax since it is valid for both the 6.x
and 7.x OS.
Figure 6.26 Conﬁguring and Applying Outbound ACLs
Pix515(conﬁg)# access-list OutboundACL permit tcp 192.168.1.0 255.255.
255.0
any eq www
Pix515(conﬁg)# access-list OutboundACL permit tcp 192.168.1.0 255.255.
255.0
any eq 443
Pix515(conﬁg)# access-list OutboundACL permit tcp 192.168.1.0 255.255.
255.0
any eq ftp
Pix515(conﬁg)# access-list OutboundACL permit ip 192.168.1.0 255.255.
255.0 11.1.2.0 255.255.255.0
Pix515(conﬁg)# access-list OutboundACL permit ip 192.168.2.0 255.255.
255.0 11.1.2.0 255.255.255.0
Pix515(conﬁg)# access-group OutboundACL in interface inside
NOTE
Conduits, outbound, and apply commands have all been replaced by the access-
list and the access-group commands. If you are still using these commands,
consider converting them to the new commands. As of PIX/ASA OS 7.x, these
commands are no longer supported and can no longer be entered into the ﬁre-
wall conﬁguration.
Creating an Inbound Access 
Control List (Ingress Filtering)
Unlike outbound connections, the PIX/ASA, by default, will not permit trafﬁc initiated
from a less secure interface to a more secure interface. For example, for a client on the
Internet to be permitted to access the Web server on the local DMZ, an explicit ACL that
www.syngress.com
272
Chapter 6 • Firewall Design: Cisco PIX and ASA

permits port 80 trafﬁc must be created; otherwise, access will be denied. Inbound access lists
are created and applied to interfaces using the same steps as outbound connections. Because
the inbound ACL gives users on the Internet connectivity to your protected resources, it is
very important to understand the importance of the inbound ACL.Any mistakes on this
ACL can open security holes that hackers can exploit and use to enter your network for
malicious purposes.
When creating inbound ACLs, be sure to be speciﬁc as possible. Figure 6.27 shows how
to conﬁgure access from the Internet to speciﬁc TCP ports on the servers on the DMZ.The
ACL allows any host of the Internet to access Web content (TCP port 80 or WWW) on the
Web server, send mail to the mail relay server (TCP port 25 or SMTP), and send FTPs
(TCP port 21 or FTP) to the FTP server.As with all ACLs, any access not explicitly per-
mitted will be denied via an implicit deny statement at the end of the ACL.The ACL is
applied to the outside interface using the access-group command.The syntax used in this
example is the PIX 6.x syntax since it is valid for both the 6.x and 7.x OS.
Figure 6.27 Inbound Access List Conﬁguration
Pix515(conﬁg)# access-list InboundACL permit tcp any host 11.1.2.2 eq www
Pix515(conﬁg)# access-list InboundACL permit tcp any host 11.1.2.3 eq smtp
Pix515(conﬁg)# access-list InboundACL permit tcp any host 11.1.2.4 eq ftp
Pix515(conﬁg)# access-group InboundACL in interface outside
NOTE
It’s important to remember that the concept of an inbound or outbound ACL is
typically not a technical term; rather, it’s just a term of convenience used to log-
ically describe the ACL and the type of trafﬁc that is being ﬁltered. You should
also not confuse it with the in and out parameters of the access-group com-
mand. If you will recall, on the PIX/ASA you can only have one ACL applied to
an interface in the case of the 6.x OS or one ACL in any given direction in the
case of the 7.x OS. This is an important concept to grasp, particularly as it
relates to a one-armed DMZ segment. In that scenario, the ACL that you will
wind up building is likely going to be both an inbound and an outbound ACL
since the trafﬁc going from the DMZ to the inside network is considered
“inbound,” whereas the trafﬁc going from the DMZ to the outside is considered
“outbound.” This ACL will then be applied to the DMZ interface using the
access-group command with the in parameter (since you want to ﬁlter trafﬁc
coming from the DMZ).
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
273

Creating Turbo ACLs
The PIX OS version 6.2 adds a new feature called Turbo ACL, which decreases the time it
takes to search long access lists.Turbo ACL does this by compiling the ACL so that searches
are deterministic and take fewer CPU cycles.The problem with uncompiled ACLs is that as
they get larger, it takes more time to ﬁnd a match, because the ACL is searched in a linear,
top-down, fashion.A PIX with large, complex ACLs can cause a performance lag as well as
increase latency for packets that pass through it.The PIX can decrease search times for ACLs
with 19 lines or more when the global access-list compiled command or the individual ACL
access-list acl_name compiled command is used.Turbo ACLs should be applied only to ACLs
that have 19 or more lines, because compiled ACLs with fewer than 19 lines do not pro-
vide a performance upgrade compared with uncompiled ACLs.To conﬁgure a turbo
ACL, you need to conﬁgure the ACL as you normally would, then apply the global or
individual ACL compile command.The global compile command compiles all conﬁg-
ured ACLs that have 19 or more lines.The individual command allows you select a spe-
ciﬁc ACL to compile, but the ACL must have 19 or more lines. If a change is made to a
compiled ACL, the PIX will automatically recompile the ACL, so the change is reﬂected
in the compiled ACL table.
With PIX software version 7.x, there is no longer a need to compile access lists.The
software now automatically optimizes access list processing. From an upgrade perspective, any
existing access-list statements with a compiled keyword are ignored and no longer accepted.
NOTE
The PIX requires approximately 2.1MB of Flash to run Turbo ACL, which limits
chassis that can support this feature. This feature might not work properly on
the PIX 501 and the PIX 506E chassis because they come with only 8MB of Flash
installed and cannot be upgraded. 
Time-Based ACLs
The PIX/ASA 7.x OS introduces support for time-based ACLs, where individual access list
entries can be conﬁgured to be active and enforced during a speciﬁed time period.This new
capability has been implemented via a new command (time-range) and the extension of the
existing access-list command with a new keyword (time-range).To implement time-based
restrictions for an access list entry, perform the following steps:
1.
Deﬁne a time range via the new time-range command.
2.
Create or modify an access list entry to use that time range via the time-range key-
word in the access-list command.
www.syngress.com
274
Chapter 6 • Firewall Design: Cisco PIX and ASA

The format of the time-range command is:
time-range name
The name parameter assigns a name to the time range you are deﬁning. Once you enter
this command, you enter time range conﬁguration mode. Within this mode, you use the
absolute, periodic, and default commands to deﬁne the time range parameters.The absolute com-
mand deﬁnes an absolute time when a time range is in effect. Its format is:
absolute [end time date] [start time date]
■
The meaning of the start and end keywords is obvious.
■
The format of the time parameters is HH:MM (e.g., 20:00 for 8 P.M.), and the
format of the date parameters is day month year (e.g., 1 January 2006).
The periodic command deﬁnes a periodic time when the time range is in effect. Its
format is:
periodic days-of-the-week time to [days-of-the-week] time
The parameters and keywords of the periodic command are identiﬁed and described here.
The ﬁrst occurrence of the days-of-the-week parameter speciﬁes the starting day or day of
the week for the time range.The potential values for days-of-the-week are any single day or
combinations of days, including Monday,Tuesday, Wednesday,Thursday, Friday, Saturday, and
Sunday. In addition, the following values are valid:
■
Daily 
■
Weekends
■
Weekdays
The second occurrence speciﬁes the ending day or day of the week for the time range.
The second occurrence is optional and can be omitted if the ending days are the same as the
starting days.
The ﬁrst occurrence of the time parameter speciﬁes the starting time; the second occur-
rence speciﬁes the ending time and is not optional.The format of the time parameters is
HH:MM (e.g., 20:00 for 8 P.M.). Multiple periodic commands are permitted per time-range
command. In addition, if a time-range command has both absolute and periodic values speciﬁed,
the periodic commands are evaluated only after the absolute start time is reached and are not
further evaluated after the absolute end time is reached.
The default command restores the default conﬁguration settings to the time-range com-
mand absolute and periodic keywords.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
275

NOTE
Obviously, the time range feature relies on the accuracy of the PIX clock. Best
practice would include the synchronization of the PIX clock with an NTP server.
Now that a time range has been deﬁned using the time-range command, you must use it
to specify an active time period for an access-list entry via the access-list command.The gen-
eral format of this command with respect to time ranges is:
access-list id [line line-number] [extended] {deny | permit} {tcp | udp} {host
sip | sip mask | any} [operator port] {host dip | dip mask | any} [operator port]
time-range time_range_name
To make an access-list statement active for a particular time range, simply include the
time-range keyword and the time_range_name, which is the name of a time range previously
deﬁned using the time-range command.
For example, suppose Secure Corporation has a business requirement to exchange data
with a partner via FTP.The company has implemented an FTP server in its DMZ to pro-
vide a staging point for the exchange of ﬁles, as shown in Figure 6.28.The exchange of data
via FTP occurs nightly at a speciﬁed time. Because Secure Corporation does not want the
DMZ FTP server exposed unnecessarily when it is not being used, it has chosen to imple-
ment a time-based ACL to allow FTP trafﬁc to/from the server only when necessary.
Figure 6.28 Time-Based ACL
PIX515(conﬁg)# static (DMZ,outside) 11.1.2.0 11.1.2.0 netmask 255.255.
255.0 0 0
PIX515(conﬁg)# time-range PARTNER_FTP_TIME
PIX515(conﬁg-time-range)# periodic weekdays 20:00 to 22:00
PIX515(conﬁg-time-range)# exit
PIX515(conﬁg)# access-list INTERNET_TO_DMZ permit tcp any host11.1.2.4 eq ftp
time-range PARTNER_FTP_TIME
PIX515(conﬁg)# access-list INTERNET_TO_DMZ permit tcp any host11.1.2.4 eq ftp-
data time-range PARTNER_FTP_TIME
PIX515(conﬁg)# access-group INTERNET_TO_DMZ in Outside
PIX515(conﬁg)# exit
Monitoring ACLs
The PIX/ACL has a couple of commands that can display and monitor ACLs as well as
check to which interface they are bound.The show access-list command shows the contents
of an access list, the number of hits (matches) per entry, and whether the ACL is a Turbo
www.syngress.com
276
Chapter 6 • Firewall Design: Cisco PIX and ASA

ACL or a standard uncompiled ACL.The show access-group command displays how the ACLs
are bound to the PIX’s interfaces.You can also use the log parameter in the access-list com-
mand to cause the ﬁrewall to log ACLs with matching entries for troubleshooting and diag-
nostic information.
Conﬁguring & Implementing…
Tips on Inbound ACLs
Understanding how to properly create an ACL is very important to the integrity
of your network. A mistake on an ACL can open holes that hackers can easily
exploit. It is very important to be very speciﬁc when you’re deﬁning an access-list
entry. The more speciﬁc the ACL, the fewer holes the hacker has to exploit. 
The order of the ACE in the access list is also important. Many people make
the mistake of making broad permit statements, then later in the ACL using a
speciﬁc deny, or vice versa. Always remember that the PIX/ASA will stop pro-
cessing the ACL when the ﬁrst match is made, and any lines below the match will
not take effect. We have put together some tips on how to conﬁgure an ACL for
some common services and we present them here.
All access lists should start with an antispooﬁng ACL, which will prevent
spooﬁng of the private address range (RFC 1918) from the Internet. A line for any
public address space that your company has for internal use (not advertised to
the Internet) should also be added here.
! To block spooﬁng of RFC 1918 Address ranges
Pix515(conﬁg)# access-list InboundACL deny ip 10.0.0.0
255.0.0.0 any
Pix515(conﬁg)# access-list InboundACL deny ip 172.16.0.0
255.240.0.0 any
Pix515(conﬁg)# access-list InboundACL deny ip 192.168.0.0
255.255.0.0 any
This section of the ACL is quite simple. It allows users from the Internet to
access the Web server via the standard Web port, TCP port 80, as well as SSL, TCP
port 443.
! Allow WWW and SSL connections to the web server
Pix515(conﬁg)# access-list InboundACL permit tcp any host
11.1.2.2 eq www
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
277
Continued

Pix515(conﬁg)# access-list InboundACL permit tcp any host
11.1.2.2 eq 443
This section allows the use of Active or Passive FTPs to the FTP server.
Because of the Application Inspection feature, you will not need to open any port
besides TCP port 21. FTP usually requires ports 20, 21, and ports greater than
1023 to be open to support Active or Passive FTPs, but not the PIX/ASA.
Application Inspection is discussed later in this chapter.
! Allow Active or Passive FTPs to the FTP server
Pix515(conﬁg)# access-list InboundACL permit tcp any host
11.1.2.4 eq ftp
Since ICMP is connectionless, you need to explicitly allow ICMP echo replies
to be allowed to re-enter the PIX/ASA and forwarded back to the client on the
internal LAN to initiate the echo via the ping utility. If you notice that the desti-
nation address is not the internal LAN IP address range but is the address of the
outside interface IP range, this occurs because, as an echo request from the
internal LAN is sent through the PIX/ASA, it is translated to an address on the out-
side interface IP range (as conﬁgured in the previous NAT section of this chapter).
The echo reply will be sent to the translated address; therefore, the ACL should
specify the translated address as the destination and not the real internal address
range.
! Allow ICMP echo reply from a ping initiate from an
internal interface
Pix515(conﬁg)# access-list InboundACL permit icmp any 11.1.1.0
255.255.255.240
echo-reply
Routing Through the PIX
The ﬁnal step in the basic conﬁguration of the PIX/ASA is to enable routing. By default,
the PIX/ASA has no routes conﬁgured, so it does not know how to forward trafﬁc.The
PIX/ASA has three routing options: static routes, RIP, and OSPF. In this section we discuss
how to conﬁgure static routing as well dynamic routing using the RIP and OSPF dynamic
routing protocols.
Static Routing
Most PIX/ASA ﬁrewalls are conﬁgured using static routes because they are the simplest and
most secure form of routing. Static routing hard-codes the next hop of a remote network so
that the PIX/ASA knows in which direction to send trafﬁc when a network is not directly
connected. Usually a PIX/ASA has a default route pointing to the Internet and static
www.syngress.com
278
Chapter 6 • Firewall Design: Cisco PIX and ASA

route(s) pointing to networks or subnets on the internal LAN.The route if_name ip_address
netmask next_hop [metric] command is used to deﬁne a static route.The if_name parameter
identiﬁes the route’s outgoing interface.The ip_address and netmask parameters make up the
remote network that you want the PIX/ASA to route to, and the next_hop parameter is the
IP address to which the PIX/ASA will forward trafﬁc that matches the speciﬁed remote net-
work.The metric parameter sets a weight to a route in case there are multiple paths to the
remote network.The route with the smallest metric to the same remote network will be
selected unless it becomes unavailable; then the next hop with second smallest weight will be
selected to reach a remote network.
To illustrate how static routes are conﬁgured, let’s use our familiar network setup shown
in Figure 6.29. In the diagram, three networks are directly connected to the PIX: the inside
interface (192.168.0.0 /24), the DMZ interface (11.1.2.0 /24), and the outside interface
(11.1.1.0 /28).These networks do not require any type of routing, either static or dynamic,
because they are directly connected, and the PIX will simply ARP for hosts located on these
interfaces. However, the internal LANs are not directly connected; therefore, they require
static routes so that the PIX can forward trafﬁc to the appropriate next hop. In this case, the
next hop for both internal LANs (LAN A 192.168.1.0 /24 and LAN B 192.168.2.0 /24) is
the Internal LAN router, or 192.168.0.2.
The ﬁrst two conﬁguration lines in Figure 6.30 show how to conﬁgure the static
routing for both internal LANs. Now that we accounted for routing the internal LANs, we
must turn our attention to conﬁguring routing so that devices on the internal LAN and the
DMZ can access the Internet.This could a daunting task if we had to conﬁgure static routes
for every network on the Internet, but the PIX has an option that lets you deﬁne a default
route for trafﬁc for which the PIX does not have a speciﬁc route. In this case, the default
route is the Internet router, or 11.1.1.14.The last conﬁguration line in Figure 6.24 shows
how to conﬁgure a default route to point the next hop, the Internet router. Notice that the
syntax of the route command has been simpliﬁed by the use of double zeroes for the
ip_address and netmask parameters.The expanded syntax of a default route is route outside
0.0.0.0 0.0.0.0 11.1.1.14 1, but the PIX allows you to abbreviate 0.0.0.0 for both the IP
address and the mask to a simple double zero (0 0).The PIX/ASA will accept either the
expanded or the abbreviated default route syntax.Assuming that the internal router is con-
ﬁgured with a default route to point to the PIX as the next hop, the PIX is now capable of
routing among the internal LAN, the DMZ, and the Internet. We discuss routing on the
Internal and Internet routers in detail in Chapter 9.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
279

Figure 6.29 Conﬁguring Static Routes
Figure 6.30 Static Route Conﬁguration
Pix515(conﬁg)# route inside 192.168.1.0 255.255.255.0 192.168.0.2 1
Pix515(conﬁg)# route inside 192.168.1.0 255.255.255.0 192.168.0.2 1
Pix515(conﬁg)# route outside 0 0 11.1.1.14 1
Enabling RIP
In most PIX ﬁrewall implementations, the use of static routing meets the requirements for
most DMZ designs. However, the PIX/ASA does offer dynamic routing capabilities that
include support for Routing Information Protocol (RIP) versions 1 and 2 and OSPF. In this
section, we discuss how to conﬁgure RIP, a distance-vector protocol that uses hop count to
determine a route’s metric.A device running RIP periodically updates its neighbors of the
routes it knows about. Since the scope of this book is directed toward building a DMZ
infrastructure, we assume that if you are going to conﬁgure RIP, you are well versed in its
capabilities, so we will not go into RIP’s details any further.
RIP was a common interior dynamic routing protocol before the more robust routing
protocols such as OSPF and EIGRP came into play. Nevertheless, RIP can be found on
many networks today, and the PIX can “talk” to devices, like routers, that run RIP to elimi-
nate the administrative burden of adding a new static route to the PIX each time a new
LAN is added to the internal network.
RIP is conﬁgured differently depending on whether you are running the 6.x or the 
7.x OS.
www.syngress.com
280
Chapter 6 • Firewall Design: Cisco PIX and ASA
Internal LAN A
DMZ
Web
Server
11.1.2.2
E-Mail
Server
11.1.2.3
FTP
Server
11.1.2.4
Internet
Internet
Router
PIX
Interface Inside
IP Address
192.168.0.1 /24
Interface Outside
IP Address 
Interface DMZ
IP Address
11.1.2.1 /24
Internal LAN B
Fast Ethernet 0/2
IP Address
192.168.2.1 /24
Fast Ethernet 0/1
IP Address
192.168.1.1 /24
Fast Ethernet 0/0
IP Address
192.168.0.2 /24
Fast Ethernet 0/0 
11.1.1.14 /28
Internal
LAN Router
11.1.1.1 /28
IP Address

Enabling RIP for PIX 6.x
The rip command is used to enable RIP on the PIX. Figure 6.31 shows how to conﬁgure
RIP on the internal LAN or inside interface of the PIX. (Refer back to Figure 6.29 for the
network setup.) In this case, the internal router is running RIP version 2 with MD5 authen-
tication.The PIX needs to be able to communicate with the internal router so that the
router can periodically update the PIX’s RIP routing table.The PIX, in turn, needs to
inform the internal router of the default route so that the internal router knows where to
forward packets destined for the Internet. Once conﬁgured, if a new LAN is added to the
Internal router, the router will send an update to the PIX notifying it of the new LAN
without any extra conﬁguration or static routes added to the PIX.
The ﬁrst conﬁguration line in Figure 6.31 enables RIP version 2 with MD5 authentica-
tion on the inside interface of the PIX. Note that MD5 authentication must also be set on
the internal router, and the key (mykey) and key ID (1) must match for routing updates to
take place between the router and the PIX. In this example, RIP is set to Passive mode, and
the PIX will listen to only RIP version broadcast updates and update its RIP routing table
accordingly.The second conﬁguration line allows the PIX to advertise a default route back
to the internal router so that it will know where to send trafﬁc for which it does not have a
speciﬁc route.The third line is the same as in the static route example, where the PIX will
forward Internet-bound trafﬁc to the Internet router.
Figure 6.31 PIX 6.x RIP Routing Conﬁguration
Pix515(conﬁg)# rip outside passive version 2 authentication md5 mykey 1
Pix515(conﬁg)# rip inside default version 2 authentication md5 mykey 1
Pix515(conﬁg)# route outside 0 0 11.1.1.14 1
Enabling RIP for PIX/ASA 7.x
With the PIX/ASA 7.x command, Cisco changed the RIP conﬁguration to work virtually
identically to the conﬁguration of RIP using the Cisco IOS.The rip command has been
replaced by the router rip command, which places the ﬁrewall into the RIP router conﬁgura-
tion mode.The RIP router conﬁguration mode supports the following commands and is
where the RIP routing conﬁguration occurs:
■
auto-summary Enable automatic network number summarization.
■
default-information Control distribution of default route information.
■
distribute-list Filter networks in routing updates.
■
network Add/remove interfaces to/from routing process.
■
passive-interface Suppress routing updates on an interface.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
281

■
redistribute Redistribute information from another routing process.
■
version Set routing protocol version.
Conﬁguring authentication for RIP is not performed in the RIP router conﬁguration
mode; rather, it is performed in the interface conﬁguration mode of the interface that RIP
will be running on.The command rip authentication mode is used to deﬁne the authentication
method that will be used.The command rip authentication key is used to deﬁne the key and
key ID that will be used for the authentication. So, working on the previous example, you
would conﬁgure RIP for a PIX/ASA running the 7.x OS, as shown in Figure 6.32.
Figure 6.32 PIX/ASA 7.x RIP Routing Conﬁguration
Pix515(conﬁg)# router rip
Pix515(conﬁg-router)# passive-interface outside
Pix515(conﬁg-router)# version 2
Pix515(conﬁg-router)# default-information originate
Pix515(conﬁg-router)# network 192.168.0.0
Pix515(conﬁg-router)# interface eth1
Pix515(conﬁg-if)# rip authentication mode md5
Pix515(conﬁg-if)# rip authentication key mypubkey key_id 1
OSPF
Starting with PIX OS version 6.3, the PIX/ASA supports the OSPF link-state routing pro-
tocol. Many large networks implement OSPF as the dynamic routing protocol and with this
new feature allow the PIX/ASA to communicate with routers on the network running
OSPF to dynamically update the routing tables on both the PIX/ASA and routers on the
network. Since OSPF is fairly complex, we will not go into its conﬁguration on the
PIX/ASA, but be aware that the PIX/ASA can support it if necessary. For both the 6.x and
7.x OS, OSPF is conﬁgured by running the router ospf command to access the OSPF router
conﬁguration mode.The PIX/ASA’s implementation of OSPF is robust and can support
almost all the OSPF functions and features found in Cisco’s router IOS.As with all routing
protocols, if you decide to use this feature, be sure to use the OSPF authentication feature to
ensure that you are sending and receiving routing information to trusted neighbors.
Conﬁguring Advanced PIX/ASA Features
The PIX/ASA has many additional features that enable it to provide high availability, appli-
cation layer security, and PIX/ASA management and support.The PIX/ASA supports fea-
tures such as DHCP and VPNs that are out of the scope of this book. In this section, we
www.syngress.com
282
Chapter 6 • Firewall Design: Cisco PIX and ASA

cover topics such as failover, content ﬁltering, cut-through proxy, application layer security,
and securing some of PIX/ASA’s management features.
PIX/ASA 7.x Security Contexts
One of the most interesting new features of the PIX/ASA 7.x OS is the introduction of vir-
tual ﬁrewalls, or security contexts. Security contexts provide a means for allowing a single piece
of hardware to function logically as multiple virtual ﬁrewalls. When you set up a security
context, each context has its own security policies, interfaces, and supported features.This
means that not all PIX ﬁrewall features are supported in security contexts. Some that are not
supported when you have multiple security contexts include:
■
Dynamic routing protocols
■
VPN
■
Multicast
When you start the PIX in single-context mode and convert to multiple-context mode,
a new ﬁle called admin.cfg is created on the built-in Flash.This is the default administrator
security context.You can store multiple security contexts on the same Flash, or you can have
the PIX download them from the network using TFTP, FTP, or HTTP(s).
NOTE
When you convert from single security context mode to multiple security con-
text mode, the original startup conﬁguration is not saved, so always make a
backup when you work with security contexts. The running conﬁguration is
used to make the two new security context ﬁles.
Use the mode command to place the Cisco PIX ﬁrewall in multiple security context
mode. Our options for the mode command are:
PIX515(conﬁg)# mode ?
conﬁgure mode commands/options:
multiple
Multiple mode; mode with security contexts
noconﬁrm
Do not prompt for conﬁrmation
single
Single mode; mode without security contexts
PIX515(conﬁg)#
To go from single mode to multimode:
PIX515(conﬁg)# mode multiple
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
283

WARNING: This command will change the behavior of the device
WARNING: This command will initiate a Reboot
Proceed with change mode? [conﬁrm]
Convert the system conﬁguration? [conﬁrm]
WARNING: This command will initiate a Reboot
Proceed with change mode? [conﬁrm]
Convert the system conﬁguration? [conﬁrm]
!!
The old running conﬁguration ﬁle will be written to ﬂash
The admin context conﬁguration will be written to ﬂash
The new running conﬁguration f
***
*** --- SHUTDOWN NOW ---
***
*** Message to all terminals:
***
***
change mode
ﬁle was written to ﬂash
Security context mode: multiple
Rebooting...
When you conﬁrm, the Cisco PIX will reboot itself to enable the new mode. We can
conﬁrm the mode by using the show command:
PIX515# show mode
Security context mode: multiple
PIX515#
To restore the Cisco PIX to single mode security context, we need to copy the original
(you did make a backup, right?) to Flash:
PIX515(conﬁg)# copy ﬂash:old_running.cfg startup-conﬁg
Then we will set the mode back to single:
PIX515(conﬁg)# mode single
WARNING: This command will change the behavior of the device
WARNING: This command will initiate a Reboot
Proceed with change mode? [conﬁrm]
www.syngress.com
284
Chapter 6 • Firewall Design: Cisco PIX and ASA

As you will see in the next section, one of the most valuable uses of security contexts is
in conﬁguring Active/Active failover.
The PIX/ASA Failover Services 
When your DMZ design calls for a highly available ﬁrewall solution because downtime due
to a problem with the ﬁrewall hardware will not be tolerated, consider using the PIX’s
failover feature. Historically, the PIX has supported failover in an Active/Standby mode of
operation. What this means is that the failover feature allows you to set up a second PIX in
Standby mode, and if the primary, or active, PIX should go ofﬂine, the secondary PIX will
switch to Active mode and take over for the failed PIX. With the PIX/ASA 7.x OS soft-
ware, Cisco introduced a new type of failover known as Active/Active failover.Active/Active
failover is very similar to Active/Standby failover in terms of functionality, with one impor-
tant difference—each ﬁrewall is conﬁgured to pass network trafﬁc.This is done by running
each ﬁrewall in multiple-context mode, with one context being active on the ﬁrst ﬁrewall
(and passive on the second ﬁrewall) while the other context is active on the second ﬁrewall
(and passive on the ﬁrst ﬁrewall). Each security context is then added to a failover group,
which deﬁnes a group of security contexts.The failover group is then used to deﬁne the
physical ﬁrewall that will be considered the primary ﬁrewall for the failover group and the
ﬁrewall that will be considered the standby ﬁrewall for the failover group. Functionally, a
failover group works similarly to the way the traditional Active/Standby failover functions.
Consequently, unless otherwise noted, the failover concepts discussed in this section are
applicable to both types of failover.
NOTE
When we talk about the primary and secondary ﬁrewall, we are referring to
either the physical ﬁrewalls in an Active/Standby failover conﬁguration or the
physical ﬁrewalls for each failover group in an Active/Active failover conﬁgura-
tion.
If the optional stateful failover feature is conﬁgured, the secondary PIX/ASA can main-
tain operating state for active TCP connections during failover, so users will not lose their
sessions as the PIX/ASA fails over to its backup unit.To enable failover, the primary and sec-
ondary PIX/ASA ﬁrewalls need to be identical in terms of chassis, OS version, and hardware
options. We cover the requirements for failover later in this section.
The PIX offers two options that provide connectivity for the primary and secondary
PIX ﬁrewalls to exchange heartbeats and conﬁguration information.The ﬁrst option is a
Cisco proprietary high-speed serial cable connected to a special serial failover port on the
PIX.This option is not available to the ASA ﬁrewall.The second option is to use one of the
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
285

PIX/ASA LAN interfaces to carry heartbeat and conﬁguration trafﬁc.The advantage of
using the Cisco proprietary high-speed serial cable to send heartbeat and conﬁguration
trafﬁc is that it will not waste a LAN interface for a rather small amount of trafﬁc. Instead, it
uses a serial port speciﬁcally designed for failover.The disadvantage is that the high-speed
serial cable is rather short (six feet long), and if the PIX ﬁrewalls are not physically located
close together, you cannot use the cable-based solution, because the cable cannot be
extended. If you have a situation in which the PIX/ASA ﬁrewalls are not physically located
together, you can consider the second option, a LAN-based failover, which uses interfaces on
each PIX/ASA to provide dedicated media for heartbeat and conﬁguration trafﬁc.The disad-
vantage of this option is that an interface on each PIX/ASA will be wasted just for heartbeat
and conﬁguration trafﬁc. It is important to note that heartbeat and conﬁguration trafﬁc
should not be confused with state trafﬁc used for the stateful failover option, which the
active PIX/ASA uses to send the standby PIX/ASA TCP state information.Although you
can conﬁgure the PIX/ASA to carry heartbeat, conﬁguration, and state trafﬁc all on one
interface on each PIX/ASA using the LAN-based failover option, doing so is not recom-
mended.
When failover occurs, the standby PIX/ASA assumes all the IP addresses and MAC
addresses on all interfaces of the failed PIX/ASA. Because there is no change to the IP address
or MAC address information, other devices on the network will not be aware of a failure and
that they are now communicating through a different device.Another feature of failover is that
when a conﬁguration change is made to the primary, it is automatically copied to the sec-
ondary PIX/ASA, and when a write memory command to save the conﬁguration to Flash is
issued on the primary, it also copies the conﬁguration to the secondary’s Flash.
What Causes Failover to Occur
To determine the health status of each PIX/ASA, the primary and secondary PIX/ASA poll
each other.The poll interval is set using the failover polltime (failover poll for PIX 6.x) com-
mand; the default is 15 seconds. Polls, also called heartbeats, are sent over all interfaces,
including the failover cable. If either PIX/ASA misses two consecutive heartbeats, each
PIX/ASA will go through a series of tests to determine which PIX/ASA is in trouble. Each
unit goes through four tests to determine its health: a Link Up/Down test, a Network
Activity test, an ARP test, and a Broadcast Ping test. Each PIX/ASA ﬁrewall performs one
test at a time. If one unit passes a test and the other unit does not, the PIX/ASA that passed
will take over. If both PIX/ASA units fail, they move on to the next test.At the default poll
interval (15 seconds), the PIX units can take up to 45 seconds to run through all the tests
and determine whether failover should take place.
www.syngress.com
286
Chapter 6 • Firewall Design: Cisco PIX and ASA

NOTE
When cable-based failover is implemented, the PIX will be able to immediately
fail over to the secondary unit and skip the series of tests if the primary unit
loses power due to a power failure or it is simply shut off. This is not possible
with LAN-based failover, where a power failure of the primary unit must be
detected via a series of tests.
Failover Requirements
To implement failover, you must make sure you have met all the following requirements
before conﬁguring failover:
■
Both the primary and secondary PIX ﬁrewalls must be identical models. Only the
PIX 515E, 525, and 535 support the failover feature.
■
Both the primary and secondary ASA ﬁrewalls must be identical models.All ASA
models support failover (the ASA 5510 must be running the Security Plus license).
■
Run the same PIX or ASA OS version.
■
Have the same amount of RAM and Flash.
■
Have the same interface options.
■
If encryption is required, the ﬁrewalls must run the same encryption type (DES 
or 3DES).
If you are conﬁguring the stateful failover feature with the Cisco proprietary high-speed
serial cable, the following items are required in addition to the standard requirements:
■
Cisco proprietary high-speed serial to carry heartbeat and conﬁguration trafﬁc
■
A dedicated interface on each PIX to carry TCP state trafﬁc
■
The interface used for stateful trafﬁc must be, at minimum, set at 100Mb full
duplex or at least as fast as the PIX’s fastest interface
If you are conﬁguring the stateful failover feature using the LAN-based failover option,
the following items are required in addition to the standard requirements:
■
A dedicated interface on each PIX/ASA to carry heartbeat and conﬁguration
trafﬁc
■
A separate dedicated interface on each PIX/ASA to carry TCP state trafﬁc
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
287

■
The interface used for stateful trafﬁc must be, at minimum, set at 100Mb full
duplex or at least as fast as the PIX/ASA’s fastest interface
The last, but an important, requirement is to make sure you have the proper PIX/ASA
license.At least one of the PIX/ASA’s must have the Unrestricted license.The other unit can
have the Unrestricted license, a Failover license, or a Failover Active/Active license.
Conﬁguring Active/Passive Stateful 
Failover with a Failover Cable (PIX Only)
In this section, we cover how to conﬁgure stateful failover using the Cisco proprietary high-
speed serial cable. In this setup, the serial cable is used to carry heartbeat and conﬁguration
trafﬁc, and TCP state trafﬁc is transferred to the secondary unit via a dedicated LAN interface.
TCP state information needs to be passed from the active PIX to the standby PIX, so if a
failure should occur, the secondary PIX can take over and the users will not lose their sessions.
As we mentioned earlier, cable-based failover uses a proprietary high-speed serial cable
to carry heartbeat and conﬁguration trafﬁc between the primary and secondary PIX ﬁre-
walls.The cable is labeled on each end with “Primary” and “Secondary” and should be con-
nected to the each PIX’s failover serial port. If you are using a combination of Unrestricted
license and Failover license, you must plug the “Primary” end of the serial cable into the
PIX with the Unrestricted license and the end labeled “Secondary” into the PIX with the
Failover license. Figure 6.33 shows the rear of both the primary and secondary PIX units
and where to plug in the serial cable.The diagram also shows the interfaces of the PIX.
Notice that both PIX units have a total of four Fast Ethernet ports. Fast Ethernet interfaces
0, 1, and 2 are assigned to the outside, inside, and DMZ interfaces, respectively.The last
remaining interface, Fast Ethernet interface 3, is dedicated to carrying state information from
the primary unit to the secondary unit.
Figure 6.33 The Physical Layout of the Cable-Based Failover Setup
www.syngress.com
288
Chapter 6 • Firewall Design: Cisco PIX and ASA
Cisco Proprietary High Speed Serial Cable
(Heartbeat and Configuration Traffic Only)
VLAN 30
VLAN 30
(TCP State Traffic Only)
Serial Port
Serial Port

Before you start to conﬁgure cable-based stateful failover, you should ﬁrst cable the units
together, but make sure the secondary unit is shut down until the failover conﬁguration has
be entered into the primary PIX.The actual conﬁguration differs depending on whether
you are running the PIX 6.x or 7.x OS.
PIX 6.x OS Stateful Failover with a Failover Cable Conﬁguration
First, start your failover conﬁguration by conﬁguring the interfaces. In Figure 6.34, we show
the conﬁguration for all the active interfaces on the PIX.The inside, outside, and DMZ
interfaces you’ve seen before in our previous examples, but we added conﬁguration state-
ments for the interface that carries TCP state trafﬁc called “stateful.” Notice that the security
level is set higher than the DMZ interface, the interface speed is set to 100Mb full duplex,
and an IP address of 192.168.4.1 is assigned.
Figure 6.34 PIX OS 6.x Failover Preconﬁguration 
Pix515(conﬁg)# nameif ethernet0 outside security0
Pix515(conﬁg)# nameif ethernet1 inside security100
Pix515(conﬁg)# nameif ethernet2 DMZ security50
Pix515(conﬁg)# nameif ethernet3 stateful security90
Pix515(conﬁg)# interface ethernet0 100full
Pix515(conﬁg)# interface ethernet1 100full
Pix515(conﬁg)# interface ethernet2 100full
Pix515(conﬁg)# interface ethernet3 100full
Pix515(conﬁg)# ip address inside 192.168.0.1 255.255.255.0
Pix515(conﬁg)# ip address outside 11.1.1.1 255.255.255.240
Pix515(conﬁg)# ip address DMZ 11.1.2.1 255.255.255.0
Pix515(conﬁg)# ip address stateful 192.168.4.1 255.255.255.0
Once the interfaces have been conﬁgured, we move on to the failover section of the
PIX conﬁguration. Figure 6.35 shows the command necessary to conﬁgure cable-based
failover.The failover command enables the failover feature.The failover poll command sets the
poll interval in which the PIX units send heartbeats to determine the health of the units. In
this case, the poll interval is set to 5 seconds, and if two consecutive heartbeats are missed,
both PIX units will run a series of tests to determine whether you should be active. We
reduced the poll interval from the 15-second default, so the time it takes to initiate failover
tests and determine the active PIX is reduced.At the default settings, it could take up to 45
seconds to determine the healthy PIX, but at the new setting we reduced that number to
about 25 seconds, and should a failure occur, it would be less noticeable.
The failover ip address command sets the IP address of the failover unit for each interface.
When this conﬁguration is copied to the secondary unit, it will use this address to commu-
nicate with the primary unit as well as allow you to Telnet or SSH into the secondary unit
for management.The failover link command enables the optional stateful failover feature and
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
289

tells the PIX on which interface to send the TCP state information. In this example we use
the interface we named stateful to carry state information.
Figure 6.35 PIX OS 6.x Conﬁguration of Stateful Failover with Failover Cable
Pix515(conﬁg)# failover
Pix515(conﬁg)# failover poll 5
Pix515(conﬁg)# failover ip address outside 11.1.1.13
Pix515(conﬁg)# failover ip address inside 192.168.0.3
Pix515(conﬁg)# failover ip address DMZ 11.1.2.5
Pix515(conﬁg)# failover ip address stateful 192.168.4.2
Pix515(conﬁg)# failover link stateful
At this point you are ready to power on the secondary unit.The PIX will automatically
detect that the secondary unit is online, and the primary unit will then copy the conﬁgura-
tion to the Flash on the secondary PIX. Once the pair is synchronized, the PIX units will
function as an Active/Standby pair. We discuss how to manage and maintain failover status
later in this section.
PIX 7.x OS Stateful Failover with a Failover Cable Conﬁguration
Fundamentally you must perform the same failover tasks using the PIX 7.x OS as you do
with the PIX 6.x OS, but the actual commands that you run have changed.The ﬁrst step is
to deﬁne the stateful failover interface and conﬁgure all the interfaces with the primary and
secondary IP addresses that they should use. Instead of using the failover ip address command,
the secondary IP address is assigned to the interface using the standby parameter of the ip
address command. Figure 6.36 details the failover preconﬁguration steps.
Figure 6.36 PIX 7.x Failover Preconﬁguration
Pix515(conﬁg)# interface ethernet0
Pix515(conﬁg-if)# nameif outside
Pix515(conﬁg-if)# security-level 0
Pix515(conﬁg-if)# ip address 11.1.1.1 255.255.255.240 standby 11.1.1.2
Pix515(conﬁg)# interface ethernet1
Pix515(conﬁg-if)# nameif inside
Pix515(conﬁg-if)# security-level 100
Pix515(conﬁg-if)# ip address 192.168.0.1 255.255.255.0 standby 192.168.0.2
Pix515(conﬁg)# interface ethernet3
Pix515(conﬁg-if)# nameif dmz
Pix515(conﬁg-if)# security-level 50
Pix515(conﬁg-if)# ip address 11.1.2.1 255.255.255.0 standby 11.1.2.2
Pix515(conﬁg)# interface ethernet4
www.syngress.com
290
Chapter 6 • Firewall Design: Cisco PIX and ASA

Pix515(conﬁg-if)# nameif stateful
Pix515(conﬁg-if)# security-level 90
Pix515(conﬁg-if)# ip address 192.168.4.1 255.255.255.0 standby 192.168.4.2
Once the failover preconﬁguration settings have been conﬁgured, the next step is to
conﬁgure the actual failover settings as shown in Figure 6.37.
Figure 6.37 PIX 7.x Conﬁguration of Stateful Failover with Failover Cable
Pix515(conﬁg)# failover
Pix515(conﬁg)# failover polling 5
Pix515(conﬁg)# failover link stateful
At this point you are ready to power on the secondary unit.The PIX will automatically
detect that the secondary unit is online, and the primary unit will then copy the conﬁgura-
tion to the Flash on the secondary PIX. Once the pair is synchronized, the PIX units will
function as an Active/Standby pair. We discuss how to manage and maintain failover status
later in this section.
Conﬁguring Active/Passive 
Stateful LAN-Based Failover
In this section, we cover how to conﬁgure stateful failover using the LAN-based solution.
Instead of using the proprietary high-speed serial cable, which limits the physical distance the
PIX ﬁrewalls can be set apart from each other as well as not being supported with the ASA,
the LAN-based solution uses one of the PIX/ASA’s interfaces for heartbeat and conﬁgura-
tion trafﬁc.You can connect the interfaces via a switch or a crossover cable, which enables
the PIX/ASA units to be set further apart.
There are a few drawbacks to this method.The ﬁrst is that an interface on each
PIX/ASA will be used solely for the purpose of heartbeat and conﬁguration trafﬁc.The
second is that a power failure in either unit will take longer to detect. Finally, the conﬁgura-
tion requires conﬁguring both units before failover will function.
Figure 6.38 shows how the LAN-based stateful failover is physically laid out.The dia-
gram shows a pair of PIX ﬁrewalls with six Fast Ethernet interfaces. Fast Ethernet interfaces
0, 1, and 2 are assigned to the outside, inside, and DMZ interfaces, respectively.The fourth
interface, Fast Ethernet interface 3, is a dedicated interface assigned to carry state informa-
tion from the primary unit to the secondary unit.The ﬁfth interface, Fast Ethernet interface
4, is a dedicated interface assigned to carry heartbeat and conﬁguration trafﬁc from the pri-
mary unit to the secondary unit. Cisco recommends that the heartbeat and conﬁguration
trafﬁc (shown on VLAN 40) and TCP state trafﬁc (shown on VLAN 30) be located on sepa-
rate switches or connected via a crossover cable.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
291

Figure 6.38 Physical Layout of LAN-Based Failover Setup
Unlike the cable-based solution, both PIX/ASA ﬁrewalls need to be conﬁgured before
failover is fully operational. We begin with the primary unit, for which we need to deﬁne an
interface for the heartbeat and conﬁguration trafﬁc, assign IP addresses to the failover unit,
deﬁne the unit as a primary, and conﬁgure the stateful failover option.The conﬁguration in
Figure 6.39 should be combined with the conﬁguration in Figure 6.34, which deﬁnes many
of the interfaces, including the interface used for stateful failover.
In addition to the interfaces deﬁned in Figure 6.34, we need to deﬁne another interface
for heartbeat and conﬁguration trafﬁc. Figure 6.39 shows how to conﬁgure an interface
named heartbeat with a security level of 95, an IP address of 192.168.5.1, and a speed deﬁned
as 100Mb full duplex.As with cable-based failover, we use the failover command to enable
failover, set the poll interval to 5 seconds with the failover poll command, and set the IP
addresses for all interfaces on the secondary unit using the failover ip address command.
The next group of commands is used to deﬁne the LAN-based failover.The failover lan
unit primary command deﬁnes the PIX/ASA unit as the primary.The failover lan interface
command tells the PIX/ASA on which interface to send and receive heartbeat and conﬁgu-
ration trafﬁc. In this example, we use the interface named heartbeat. For extra security, the
PIX/ASA encrypts heartbeat and conﬁguration trafﬁc between the primary and secondary
units by using shared keys.To specify the shared key, use the failover lan key command. We set
the shared key in this example to mykey.The failover lan enable command lets the PIX know
to disable cable-based failover and enable LAN-based failover.As with cable-based failover,
the failover link command enables the optional stateful failover feature and tells the PIX/ASA
on which interface to send the TCP state information. In this example, we use the interface
we named stateful to carry state information.
Figure 6.39 Conﬁguration of LAN-Based Failover (Primary)
Pix515(conﬁg)# nameif ethernet4 heartbeat security95
Pix515(conﬁg)# ip address stateful 192.168.5.1 255.255.255.0
Pix515(conﬁg)# interface ethernet4 100full
Pix515(conﬁg)# failover
www.syngress.com
292
Chapter 6 • Firewall Design: Cisco PIX and ASA
VLAN 30
VLAN 30
(TCP State Traffic Only)
VLAN 40
VLAN 40
(Heartbeat and Configuration Traffic Only)
Primary PIX
Secondary PIX

Pix515(conﬁg)# failover poll 5
Pix515(conﬁg)# failover ip address outside 11.1.1.13
Pix515(conﬁg)# failover ip address inside 192.168.0.3
Pix515(conﬁg)# failover ip address DMZ 11.1.2.5
Pix515(conﬁg)# failover ip address stateful 192.168.4.2
Pix515(conﬁg)# failover ip address heartbeat 192.168.5.2
Pix515(conﬁg)# failover lan unit primary
Pix515(conﬁg)# failover lan interface heartbeat
Pix515(conﬁg)# failover lan key mykey
Pix515(conﬁg)# failover lan enable
Pix515(conﬁg)# failover link stateful
At this point, you need to conﬁgure the secondary PIX/ASA with the minimal number
of statements shown in Figure 6.40 so it will be able to bring up the heartbeat interface.
Once this process is completed, the primary PIX/ASA will be able to communicate to the
secondary PIX/ASA via the LAN-based failover and copy its conﬁguration to the secondary
PIX’s ﬂash.
Figure 6.40 Conﬁguration of LAN-Based Failover (Secondary) 
Pix515(conﬁg)# nameif ethernet4 heartbeat security95
Pix515(conﬁg)# ip address stateful 192.168.5.1 255.255.255.0
Pix515(conﬁg)# interface ethernet4 100full
Pix515(conﬁg)# failover
Pix515(conﬁg)# failover poll 5
Pix515(conﬁg)# failover ip address heartbeat 192.168.5.2
Pix515(conﬁg)# failover lan unit secondary
Pix515(conﬁg)# failover lan interface heartbeat
Pix515(conﬁg)# failover lan key mykey
Pix515(conﬁg)# failover lan enable
Conﬁguring Active/Active Stateful 
Failover with a Failover Cable (PIX Only)
Conﬁguring Active/Active stateful failover with a failover cable is almost the exact same pro-
cess as conﬁguring Active/Standby stateful failover with a failover cable.As with
Active/Standby failover, plug in the failover cable, being careful to connect the primary end
to the primary ﬁrewall and the secondary end to the secondary ﬁrewall. Each interface on the
primary ﬁrewall also needs to be connected to the corresponding interface on the secondary
ﬁrewall through either a switch or a crossover cable. Leave the secondary ﬁrewall powered
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
293

off, and turn on the primary ﬁrewall. Next we conﬁgure the clock on the primary ﬁrewall
using the clock command.
NOTE
Do not power on the secondary ﬁrewall until the primary ﬁrewall is fully 
conﬁgured.
We must assign active and standby IP addresses to each interface on the primary ﬁrewall
and enable the interfaces. In multiple-context mode, IP addresses must be conﬁgured from
within each context, so use the changeto context command to switch between contexts.After
conﬁguring the active and standby IP addresses, the next step is to conﬁgure failover groups
and designate if the ﬁrewall will be primary or secondary for each failover group.The com-
mand syntax is simple—for example, if the ﬁrewall will be primary for failover group 1, and
secondary for failover group 2:
PIX515(conﬁg)# failover group 1
PIX515(conﬁg-fover-group)# primary
PIX515(conﬁg-fover-group)# exit
PIX515(conﬁg)# failover group 2
PIX515(conﬁg-fover-group)# secondary
PIX515(conﬁg-fover-group)# exit
All security contexts must be mapped to a failover group.The admin context and any
unassigned contexts will automatically be mapped to failover group 1.The command syntax is:
PIX515(conﬁg)# context context_name
PIX515(conﬁg-context)# join-failover-group { 1 | 2 }
PIX515(conﬁg-context)# exit
At this point, simply enter the failover command on the primary unit. Boot up the sec-
ondary unit and enter the failover command.The conﬁguration is complete! To enable
stateful failover, follow the same steps as enabling stateful active/standby failover.
Conﬁguring Active/Active 
Stateful LAN-Based Failover
To conﬁgure LAN-based Active/Active stateful failover, follow the same conﬁgurations as
Active/Standby failover except for creating failover groups and preferences and assigning
contexts to failover groups. So for example, you would assign different security contexts to
different failover groups, allowing each failover group (and by extension security contexts) to
operate independently in an active/active fashion. In essence, the actual implementation of
www.syngress.com
294
Chapter 6 • Firewall Design: Cisco PIX and ASA

active/active stateful LAN-based failover is no different from standby failover—it’s just a
manner of planning so that your security contexts are in different failover groups, thus
allowing them to be assigned to different physical ﬁrewalls.
Testing and Monitoring Failover
The status of the failover feature can be viewed using the show failover command.This show
command details whether failover is active, the status of each interface on both the primary
and secondary units, and several other statistics.You might be confronted with a situation in
which you need to force failover to occur for maintenance reasons or force the primary unit
back into an active state after a fault has been ﬁxed. Both these situations call for the use of
the failover active command.
For example, to take the primary unit out of service for maintenance reasons, you can
perform the no failover active command, which forces the primary unit to give up its active
status and the standby or secondary unit to become active. When the maintenance on the
primary unit is complete, you will use the failover active command to return the primary unit
to active status.The failover active command is not limited to the primary unit; it can be used
on either the primary or secondary, but if it’s operational, all conﬁgurations changes should
be performed on the primary unit.
NOTE
Should a fault occur and the PIX (conﬁgured for stateful failover) automatically
fail over to the secondary unit, it will maintain state for TCP connections.
However, once the fault on the primary unit is repaired and the primary PIX is
forced to active status, all TCP will be disconnected because the secondary PIX
does not send TCP state data to the primary unit. In other words, stateful
failover occurs only from primary to secondary, not vice versa. You should con-
sider returning the primary unit to active state after business hours or during
times of low utilization, to minimize the loss of connections.
Blocking ActiveX and Java
Many security managers consider ActiveX and Java applets a security risk and require the
ﬁrewall to block hosts on the internal LAN from downloading them from Web sites.
ActiveX controls (also known as OCX controls) and Java can be downloaded by users who
access Web sites that call for and download ActiveX controls and Java applets.ActiveX and
Java can add functionality to a Web site in the form of interactive forms, calendars, and cal-
culators. However, they can also be used for malicious activities, including taking control of
the desktop, causing PCs to crash, collecting sensitive information, and initiating attacks on
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
295

other machines.The PIX/ASA is able to block ActiveX and Java applets by commenting out
the <APPLET>, </APPLET>, <OBJECT>, and </OBJECT> tags in the HTML code
that so they cannot be executed.The PIX/ASA cannot discriminate between legitimate or
malicious content, so the PIX/ASA will indiscriminately comment out this code.Therefore,
all Web pages that rely on ActiveX and Java will not function properly.
Conﬁguring the PIX/ASA to block ActiveX controls and Java applets is simple. Figure
6.41 shows the ﬁlter commands necessary to block them on TCP port 80 (the standard Web
port).You can also narrow the scope of the ActiveX and Java ﬁltering by specifying the
source and/or destination addresses with the ﬁlter command.
Figure 6.41 Conﬁguring ActiveX and Java Blocking
Pix515(conﬁg)# ﬁlter activex 80 0 0 0 0
Pix515(conﬁg)# ﬁlter java 80 0 0 0 0
NOTE
The PIX will inspect each packet containing the speciﬁed port and look for and
comment out the <APPLET>, </APPLET>, <OBJECT CLASSID>, <OBJECT>,
and </OBJECT> tags in the HTML code, but if the tag is spread across multiple
packets, the PIX might not be able to block the ActiveX control or Java applet.
Content Filtering
The PIX/ASA does support content ﬁltering, but it does so by utilizing a separate server
running either the WebSense or N2H2 server.The WebSense or Secure Computing
SmartFilter (formerly N2H2) server must be purchased separately from the PIX/ASA.All
versions of PIX/ASA OS software support URL ﬁltering (the ﬁltering of HTTP requests).
In addition, the PIX/ASA 7.x OS software supports ﬁltering of HTTPS and FTP trafﬁc
through the external content ﬁltering server.
The URL ﬁltering feature is useful for limiting access to Web sites that could contain
content that violates company policies, such as pornography and gambling.The PIX/ASA
communicates with the WebSense or SmartFilter server to determine whether the Web con-
tent the user is requesting should be ﬁltered or allowed.
Figure 6.42 shows how to conﬁgure the PIX to communicate with a WebSense server
located on the PIX/ASA’s inside interface with the IP address of 192.168.1.50 using the url-
server command.The ﬁlter url http command speciﬁes the range of source IP addresses that
require HTTP ﬁltering through the WebSense server.The allow keyword tells the PIX/ASA
to allow all HTTP requests (even to ﬁltered Web sites) to ﬂow should connectivity be lost to
www.syngress.com
296
Chapter 6 • Firewall Design: Cisco PIX and ASA

the WebSense server.The ﬁlter url except command allows you the specify IP ranges that
should be exempt from WebSense screening. In this case, users on the 192.168.2.0 /24 net-
work are allowed to surf the Internet without URL ﬁltering by the WebSense server.
Figure 6.42 Conﬁguring URL Filtering
Pix515(conﬁg)# url-server (inside) vendor websense host 192.168.1.50
Pix515(conﬁg)# ﬁlter url http 0 0 0 0 allow
Pix515(conﬁg)# ﬁlter url except 192.168.2.0 255.255.255.0 0 0
For the PIX/ASA 7.x OS, conﬁguring HTTPS and FTP ﬁltering is also relatively
straightforward once the URL server has been deﬁned.This ﬁltering is performed using the
ﬁlter https and ﬁlter ftp commands, respectively, as shown in Figure 6.43.
Figure 6.43 Conﬁguring HTTPS and FTP Filtering
Pix515(conﬁg)# ﬁlter https 443 0 0 0 0 allow
Pix515(conﬁg)# ﬁlter ftp 21 0 0 0 0 allow
Cut-Through Proxy
The cut-through proxy feature allows the PIX/ASA to authenticate users who access HTTP,
FTP, and Telnet for inbound and outbound connections. Unlike standard proxy servers, the
PIX/ASA authenticates users to an external RADIUS or TACACS+ database and, if
allowed, the connection will be permitted directly between the client and the server.Access
for HTTP, FTP, and Telnet services through the PIX/ASA can be applied on a per-user basis.
When a user tries to access these services through the PIX/ASA, the PIX/ASA will prompt
the user to enter a user ID and password. If the user has the required permission, the
PIX/ASA will allow the requested connection to ﬂow. If authorization is conﬁgured in con-
junction with authentication, you can speciﬁcally restrict the Web, FTP, and Telnet hosts that
a user can access.
The conﬁguration in Figure 6.44 shows how to conﬁgure a cut-through proxy using
the PIX 6.x OS.The conﬁguration is similar to the AAA for management access to the PIX.
We start by using the aaa-server command to conﬁgure the type of authentication server
(RADIUS or TACACS+), IP address, interface, encryption key, and group tag.The next
three commands enable the PIX to authenticate, authorize, and track all requests for HTTP
access through the PIX initiated from the inside interface using the aaa authentication, aaa
authorization, and aaa accounting commands.To complete the cut-through proxy implementa-
tion, the RADIUS or TACACS+ server also needs to be conﬁgured; refer to your RADIUS
or TACACS+ documentation for information on how to do so.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
297

Figure 6.44 Conﬁguring User Authentication and Cut-Through Proxy for the
PIX 6.x OS
Pix515(conﬁg)# aaa-server AuthOut protocol tacacs+
Pix515(conﬁg)# aaa-server AuthOut (inside) host 192.168.1.50 mykey
timeout 5
Pix515(conﬁg)# aaa authentication include http inside 0.0.0.0 0.0.0.0
0.0.0.0 0.0.0.0 AuthOut
Pix515(conﬁg)# aaa authorization include http inside 0.0.0.0 0.0.0.0
0.0.0.0 0.0.0.0 AuthOut
Pix515(conﬁg)# aaa accounting include http inside 0.0.0.0 0.0.0.0 0.0
0.0 0.0.0.0 AuthOut
As you would expect, conﬁguring user authentication and cut-through proxy for the
PIX/ASA 7.x OS is similar to the AAA for management access to the PIX. First you must
conﬁgure the AAA server settings, and then you deﬁne the authentication, authorization, and
accounting commands, as shown in Figure 6.44.The process of conﬁguring user authentica-
tion and cut-through proxy for HTTP (you could just as easily substitute FTP or Telnet) is
detailed in Figure 6.45.
Figure 6.45 Conﬁguring User Authentication and Cut-Through Proxy for the
PIX/ASA 7.x OS
Pix515(conﬁg)# aaa-server AuthOut protocol tacacs+
Pix515(conﬁg-aaa-server-group)# exit
Pix515(conﬁg)# aaa-server AuthOut (inside) host 10.21.120.46 mypubkey timeout 5
PIX515(conﬁg-aaa-server-host)# exit
Pix515(conﬁg)# aaa authentication include http inside 0.0.0.0 0.0.0.0
0.0.0.0 0.0.0.0 AuthOut
Pix515(conﬁg)# aaa authorization include http inside 0.0.0.0 0.0.0.0
0.0.0.0 0.0.0.0 AuthOut
Pix515(conﬁg)# aaa accounting include http inside 0.0.0.0 0.0.0.0 0.0
0.0 0.0.0.0 AuthOut
NOTE
If you require a cut-through proxy with user authorization, consider using
TACACS+, because the PIX does not support authorization with RADIUS. In
addition, if you require extensive HTTP authorization, consider using the URL ﬁl-
tering feature.
www.syngress.com
298
Chapter 6 • Firewall Design: Cisco PIX and ASA

Application Inspection
Translating network addresses can cause problems if an application embeds an address or port
information into the payload of a packet. If this situation occurs, it could cause the applica-
tion to reject the packet or session if the address or port in the header does not match the
information in the payload.
To overcome this problem, Cisco has developed the Application Inspection feature. In
the PIX 6.x software, this is also known as the ﬁxup. In the PIX/ASA 7.x software, Cisco
replaced the ﬁxup command with the inspect command from the Cisco IOS.As packets are
translated and pass through the PIX on known problematic application ports, the Application
Inspection feature will check the payload of the packet for embedded addresses or ports,
make the appropriate translations, and update the checksum.The packet is then forwarded to
its destination, and the client or server on either end will be none the wiser that application
inspection has taken place.
Application inspection also monitors applications that open secondary connections on
separate ports to improve performance and allows dynamic ports to be opened for speciﬁc
sessions. FTP is an application that requires application inspection because it starts a connec-
tion on the well-known TCP port 21 and then dynamically opens another port to transmit
data.Application inspection is conﬁgured differently for the PIX 6.x OS than it is for the
PIX 7.x OS.
Conﬁguring PIX 6.x OS Application Inspection
The PIX 6.x application inspection functionality is conﬁgured through the ﬁxup command.
The conﬁguration is relatively straightforward: Simply specify the protocol that the ﬁxup will
be applied to and specify any ports or additional information required by the given ﬁxup. By
default, application inspection is enabled for several well-known applications, including DNS,
FTP, H323, HTTP, RSH, RTSP, SIP, SKINNY, SMTP, SQLNET, and TFTP, as of PIX OS
6.3(5). In addition to these defaults, you can also enable ﬁxup for CTIQBE, ESP-IKE, ICMP,
ILS, MGCP, PPTP and SNMP, as of PIX OS 6.3(5).
The conﬁguration example in Figure 6.46 shows how to conﬁgure application inspec-
tion for HTTP on port 8080 using the ﬁxup protocol command.Application inspection can
also protect mail servers by only allowing certain SMTP commands to be executed on the
mail server.This feature, also called MailGuard, allows only the following commands to be
executed on the mail servers: HELO, MAIL, RCPT, DATA, RSET, NOOP, and QUIT.
Figure 6.46 Conﬁguring Application Inspection
Pix515(conﬁg)# ﬁxup protocol http 8080
Pix515(conﬁg)# ﬁxup protocol smtp 25
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
299

Conﬁguring PIX/ASA 7.x OS Application Inspection
The application inspection conﬁguration commands were signiﬁcantly changed in the
PIX/ASA 7.x OS.The commands were largely changed to coincide with how application
inspection is performed in the Cisco IOS, also known as Modular Policy Framework (MPF).This
resulted in the ﬁxup features being replaced by the MPF and protocol inspection features.
NOTE
You can still use the ﬁxup command to conﬁgure application inspection in the
PIX/ASA 7.x OS, but the command is automatically converted into the new pro-
tocol inspection commands. Consequently, it’s a good idea to get into the habit
of using the new commands.
Prior to MPF, most of these application inspection actions were an all-or-nothing
proposition: Either all trafﬁc transiting an interface was subject to the same policies, or none
of the trafﬁc was. With MPF, 7.x provides granularity to allow you to pick subsets of trafﬁc
from the whole and apply policies to it. MPF is new to PIX 7.x; there were no pre-7.x
equivalents.Arguably, you could have some of this functionality in pre-7.x by cobbling
together various parameters, but nothing as granular or ﬂexible as MPF.
Depending on the protocol, inspection may or may not be enabled by default.All pro-
tocol inspection in PIX version 7.x is conﬁgured through the use of the MPF, which is a
versatile and powerful way to apply protocol inspection to your ﬁrewall.
MPF has four main steps:
1.
Deﬁning a trafﬁc class
2.
Associating the trafﬁc class with one or more actions
3.
Customizing the parameters of the application inspection for the protocol in 
question
4.
Applying the deﬁned inspection to an interface
Deﬁning a Trafﬁc Class
Deﬁning a trafﬁc class is done through the use of the class-map command.The idea behind
this command is that you want to identify a certain subset of the total trafﬁc ﬂowing
through an interface.There are a number of possible methods of matching trafﬁc, including:
■
Using an access list
■
Matching all trafﬁc
■
Using a list of predeﬁned default IP protocols
www.syngress.com
300
Chapter 6 • Firewall Design: Cisco PIX and ASA

■
Matching trafﬁc based on DSCP values
■
Using a ﬂow-based policy
■
Matching speciﬁed TCP or UDP ports (without using an access list)
■
Matching trafﬁc based on IP precedence values
■
Matching trafﬁc based on RTP port numbers
■
Matching a speciﬁed tunnel group
Prior to conﬁguring any of these match conditions, the ﬁrst step to conﬁguring a trafﬁc
class is to deﬁne the trafﬁc class and give it a name.To create a trafﬁc class called class1, enter:
PIX515(conﬁg)# class-map class1
PIX515(conﬁg-cmap)#
You will notice that following this command, your prompt changes to conﬁg-cmap, indi-
cating that you are now in class-map conﬁguration mode and may enter commands relating
to the speciﬁc class map (in this case, class1) that you have deﬁned.At this prompt, you have
the option of entering a description for this trafﬁc class:
PIX515(conﬁg-cmap)# description sample trafﬁc class
You also have the ability to rename the trafﬁc class without removing and recreating it.
In this case, we will rename the trafﬁc class from class1 to class2:
PIX515(conﬁg-cmap)# rename class2
The next step is to conﬁgure the trafﬁc class to match certain trafﬁc.To see all possible
matching options:
PIX515(conﬁg-cmap)# match ?
mpf-class-map mode commands/options:
access-list
Match an Access List
any
Match any packet
default-inspection-trafﬁc
Match default inspection trafﬁc:
ctiqbe----tcp--2748
dns-------udp--53
ftp-------tcp--21
gtp----udp--2123,3386
h323-h225-tcp-1720
h323-ras-udp-1718-1719
http------tcp--80
icmp------icmp
ils-------tcp--389
mgcp---udp--2427,2727
netbios---udp--137-138
rpc-------udp--111
rsh-------tcp--514
rtsp------tcp--554
sip-------tcp--5060
sip-------udp--5060
skinny----tcp--2000
smtp------tcp--25
sqlnet----tcp--1521
tftp------udp--69
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
301

xdmcp-----udp--177
dscp
Match IP DSCP (DiffServ CodePoints)
ﬂow
Flow based Policy
port
Match TCP/UDP port(s)
precedence
Match IP precedence
rtp
Match RTP port numbers
tunnel-group
Match a Tunnel Group
To match trafﬁc by access list, you must conﬁgure an access list prior to conﬁguring the
trafﬁc class. For example, to conﬁgure an access list called acl1 that matches all trafﬁc on TCP
port 1111 and then apply it to the trafﬁc class class2:
PIX515(conﬁg)# access-list acl1 permit tcp any any eq 1111
PIX515(conﬁg)# class-map class2
PIX515(conﬁg
-cmap)# match access-list acl1
To match any trafﬁc, simply enter:
PIX515(conﬁg-cmap)# match any
The PIX default inspection trafﬁc ports are shown in Table 6.3 (the table is courtesy of
Cisco; see http://www.cisco.com/en/US/partner/products/sw/secursw/ps2120/products_
conﬁguration_guide_chapter09186a00804231c0.html,Table 21-2).
Table 6.3 PIX Default Inspection Ports
Protocol Name 
Protocol 
Port 
ctiqbe 
tcp 
2748 
dns 
udp 
53 
ftp 
tcp 
21 
gtp 
udp 
2123,3386 
h323 h225 
tcp 
1720 
h323 ras 
udp 
1718-1719 
http 
tcp 
80 
icmp 
icmp 
N/A 
ils 
tcp 
389 
mgcp 
udp 
2427,2727 
netbios 
udp 
N/A 
rpc/sunrpc 
udp 
111 
www.syngress.com
302
Chapter 6 • Firewall Design: Cisco PIX and ASA
Continued

Table 6.3 continued PIX Default Inspection Ports
Protocol Name 
Protocol 
Port 
rsh 
tcp 
514 
rtsp 
tcp 
554 
sip 
tcp, udp 
5060 
skinny 
tcp 
2000 
smtp 
tcp 
25 
sqlnet 
tcp 
1521 
tftp 
udp 
69 
xdmcp 
udp 
177 
To match the PIX default inspection trafﬁc ports, simply enter:
PIX515(conﬁg-cmap)# match default-inspection-trafﬁc
To match trafﬁc based on DSCP value, you may enter one or more of the following
parameters, separated by a space:
PIX515(conﬁg-cmap)# match dscp ?
mpf-class-map mode commands/options:
<0-63>
Differentiated services codepoint value
af11
Match packets with AF11 dscp (001010)
af12
Match packets with AF12 dscp (001100)
af13
Match packets with AF13 dscp (001110)
af21
Match packets with AF21 dscp (010010)
af22
Match packets with AF22 dscp (010100)
af23
Match packets with AF23 dscp (010110)
af31
Match packets with AF31 dscp (011010)
af32
Match packets with AF32 dscp (011100)
af33
Match packets with AF33 dscp (011110)
af41
Match packets with AF41 dscp (100010)
af42
Match packets with AF42 dscp (100100)
af43
Match packets with AF43 dscp (100110)
cs1
Match packets with CS1(precedence 1) dscp (001000)
cs2
Match packets with CS2(precedence 2) dscp (010000)
cs3
Match packets with CS3(precedence 3) dscp (011000)
cs4
Match packets with CS4(precedence 4) dscp (100000)
cs5
Match packets with CS5(precedence 5) dscp (101000)
cs6
Match packets with CS6(precedence 6) dscp (110000)
cs7
Match packets with CS7(precedence 7) dscp (111000)
default
Match packets with default dscp (000000)
ef
Match packets with EF dscp (101110)
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
303

If you want to match trafﬁc based on a TCP or UDP port without using an access list,
you can use the match port command. For example, to match the same TCP port 1111 as in
the preceding example:
PIX515(conﬁg-cmap)# match port tcp eq 1111
Note that the match port command allows you to specify ranges of ports.To do so, substi-
tute eq with range, and then specify a lower and upper limit to the ports to match. For
example, to match TCP ports 1111 through 1120:
PIX515(conﬁg-cmap)# match port tcp eq 1112
To match trafﬁc based on its IP precedence, you may enter precedence values by name
or number. For example, to match precedence values 2, 4, and 6:
PIX515(conﬁg-cmap)# match precedence 2 4 6
NOTE
The PIX supports multiple match commands only for the tunnel-group and
default-inspection-trafﬁc types. You may conﬁgure one of these commands in
conjunction with any other match command. However, all other match com-
mands cannot be conﬁgured at the same time; you must remove one before
adding another.
Associating a Trafﬁc Class with an Action
Once you have identiﬁed trafﬁc of interest, the next step is to associate that trafﬁc with a
particular action, to actually perform the protocol inspection.To do so, the ﬁrst step is to
deﬁne a policy map. For example, to create a policy map named pol1:
PIX515(conﬁg)# policy-map pol1
PIX515(conﬁg-pmap)#
At this point, you will notice that the prompt is changed to conﬁg-pmap, indicating that
all subsequent commands apply to the policy map. Just as with a class map, you have the
option of adding a description to the policy map or renaming it.The next step is to specify
one or more trafﬁc classes to the policy map. For example, to specify the trafﬁc class we cre-
ated earlier (class2):
PIX515(conﬁg-pmap)# class class2
PIX515(conﬁg-pmap-c)#
www.syngress.com
304
Chapter 6 • Firewall Design: Cisco PIX and ASA

Notice that now the prompt has changed to conﬁg-pmap-c, indicating that subsequent
commands apply to the class map within the policy map.To enable protocol inspection, you
may now use the inspect command.The following protocol inspection engines are available:
PIX515(conﬁg-pmap-c)# inspect ?
mpf-policy-map-class mode commands/options:
ctiqbe
dns
esmtp
ftp
gtp
h323
http
icmp
ils
mgcp
netbios
pptp
rsh
rtsp
sip
skinny
snmp
sqlnet
sunrpc
tftp
xdmcp
For example, to enable FTP protocol inspection:
PIX515(conﬁg-pmap-c)# inspect ftp
Once you have completed the inspect conﬁguration, you might want to return to the
policy map conﬁguration mode to deﬁne additional trafﬁc classes.To do so:
PIX515(conﬁg-pmap-c)# exit
PIX515(conﬁg-pmap)#
Notice that the prompt has now returned to conﬁg-pmap.You may now enter additional
conﬁguration, or exit again to return to the main conﬁguration mode.
Customizing Application Inspection Parameters
Although in general, protocol inspection will function without modifying the default param-
eters, at times you might want to tune the various options associated with a protocol inspec-
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
305

tion engine.To do so, you must use application maps.Application maps are available for a
number of protocols, and we will go into detail on how to conﬁgure these, when available,
in each application-speciﬁc section of this chapter.An application map called httpmap1 is
applied within the policy map conﬁguration as follows:
PIX515(conﬁg-pmap-c)# inspect http httpmap1
Applying Inspection to an Interface
The ﬁnal step to enabling protocol inspection is to apply the inspection you have conﬁgured
to one interface, multiple interfaces, or all interfaces.To do so, use the service-policy command.
For example, to apply the aforementioned policy map to the outside interface:
PIX515(conﬁg)# service-policy pol1 interface
outside
Similarly, if you want to apply this policy to all interfaces:
PIX515(conﬁg)# service-policy pol1 global
Intrusion Detection 
The PIX/ASA’s Intrusion Detection System (IDS) analyzes packets that enter a speciﬁed
interface or interfaces on a PIX/ASA and compares them to 55 predeﬁned attack signatures.
The types of attack signature the PIX/ASA inspects for are related to the most common
DoS attacks and information-gathering scans. Should the PIX/ASA detect a match, it can
instantly drop or reset the session or send an alert. Figure 6.46 shows how to conﬁgure the
PIX/ASA to inspect all packets coming in on the outside interface of the PIX/ASA. Should
a match to an attack signature occur, all packets related to the malicious session will be
dropped and the attack will be thwarted.
Figure 6.46 Conﬁguring IDS
Pix515(conﬁg)# ip audit name DropAttacks attack action drop
Pix515(conﬁg)# ip audit interface outside DropAttacks
NOTE
This intrusion detection functionality should not be confused with the intrusion
prevention functionality provided by the ASA with the AIP-SSM. Although the
native PIX/ASA intrusion detection functionality provides some very basic and
rudimentary intrusion detection and prevention capabilities, the AIP-SSM is a
robust and full-featured intrusion prevention system that provides a tremen-
www.syngress.com
306
Chapter 6 • Firewall Design: Cisco PIX and ASA

dous amount of functionality and ﬂexibility. If you require IPS functionality with
your ﬁrewall, you should use an ASA with the AIP-SSM instead of a PIX ﬁrewall.
The AIP-SSM conﬁguration is beyond the scope of this book.
FloodGuard and DNSGuard
The PIX/ASA has many features that protect it and resources it is protecting from DoS
attacks.The FloodGuard feature protects the PIX/ASA from a form of DoS attack in which
an attacker tries to overload the PIX with user authentication requests.To protect itself, the
PIX/ASA actively closes certain half-open or idle connections to reclaim resources.This fea-
ture is enabled in PIX 6.x OS by the use of the ﬂoodguard enable command, a feature that is
enabled by default. In the PIX/ASA 7.x OS, the ﬂoodguard command no longer exists,
since ﬂoodguard is enabled by default and is always on.
DNSGuard identiﬁes an outbound DNS query request and allows only a single DNS
response back.A host may query several DNS servers for a response, and the PIX/ASA
allows only the ﬁrst answer to the query back in; additional responses from other servers are
dropped. DNSGuard is enabled by default and cannot be conﬁgured or disabled.
Securing SNMP and NTP
Network management systems can manage the PIX’s status via Simple Network
Management Protocol (SNMP). For security reasons, the PIX/ASA allows only read-only
SNMP access.To securely conﬁgure SNMP on the PIX/ASA, a shared key, or community
string, is required to authenticate requests to and from the management system.The key
must match on both the management system and the PIX/ASA ﬁrewall.As shown in Figure
6.47, the SNMP key is set to mySNMPstring using the snmp-server community command.The
snmp-server host command speciﬁes the management station that will communicate with the
PIX/ASA and the interface in which the management station resides. In this example, the
management station is 192.168.1.50, and it is located on the PIX/ASA’s inside interface.
Only devices speciﬁed with this command and the proper community string will be able to
communicate with the PIX/ASA via SNMP.The snmp-server host command also allows you
to specify whether the PIX/ASA will be polled by the management system (with the poll
keyword) or whether the PIX/ASA will send traps to the management system (with the trap
keyword).
Figure 6.47 Conﬁguring SNMP
Pix515(conﬁg)# snmp-server community mySNMPstring
Pix515(conﬁg)# snmp-server host inside 192.168.1.50 poll
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
307

Network Time Protocol (NTP) allows the PIX/ASA to synchronize its clock with a
time source. It is a good idea to have the clock set on all network devices, especially
security devices, so that if an attack occurs, it will be easier to identify the sequence of
events of an attack. Figure 6.48 shows how to conﬁgure NTP with authentication to
ensure that the PIX/ASA is receiving its time from a trusted time source. In the
example, the key is set to myNTPkey, and the NTP server is located on the PIX/ASA’s
inside interface and has the IP address of 192.168.1.50.
Figure 6.48 Conﬁguring NTP
Pix515(conﬁg)# ntp authenticate
Pix515(conﬁg)# ntp trusted-key 1
Pix515(conﬁg)# ntp authentication-key 1 md5 myNTPkey
Pix515(conﬁg)# ntp server 192.168.1.50 key 1 source inside
PIX/ASA Firewall Design and
Conﬁguration Checklist
Use this checklist in designing and conﬁguring your PIX ﬁrewall:
1.
Gather DMZ requirements.
2.
Design the DMZ environment to the speciﬁcation of the requirements.
3.
Select one of the ﬁve PIX or four ASA ﬁrewall chassis.
4.
Select the optional components of the PIX/ASA ﬁrewall.
5.
Select the correct PIX/ASA OS license (Restricted, Unrestricted, Failover, and
Failover Active/Active).
6.
Optionally, select an encryption license (DES and 3DES).
7.
Conﬁgure the PIX/ASA’s console and terminal interfaces.
8.
Set security levels on the PIX/ASA interfaces.
9.
Set IP addresses and speed/duplex settings on the active interfaces.
10.
Conﬁgure outbound NAT statements.
11.
Conﬁgure inbound NAT statements.
12.
Conﬁgure outbound access rules controlling access from internal resources to spe-
ciﬁc resources on the Internet or other less secure interfaces.
www.syngress.com
308
Chapter 6 • Firewall Design: Cisco PIX and ASA

13.
Conﬁgure inbound access rules controlling access to resources on the DMZ.
Remember to be as speciﬁc as possible.
14.
Conﬁgure static or dynamic routing.
15.
Should high availability be required, conﬁgure the failover or stateful failover fea-
ture.
16.
If required, conﬁgure URL ﬁltering, cut-through proxy, application inspection, and
intrusion detection.
17.
Lock down SNMP and NTP.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
309

Summary
The PIX and ASA ﬁrewalls are powerful tools for protecting the enterprise’s internal net-
work and its DMZ. Built on a purpose-built operating system, the PIX and ASA ﬁrewall
appliances can provide the security, performance, resiliency, and ﬂexibility to meet all your
DMZ infrastructure needs. Five PIX and four ASA ﬁrewall models can provide network
architects with several different options to meet their needs—from a small DMZ environ-
ment to service provider-class environments.This chapter discussed several popular DMZ
designs that will meet the needs of many DMZ planners. Use these designs to create the
DMZ that best ﬁts your requirements. Remember to choose your design based on your
technical requirements and ﬁnancial constraints.The PIX/ASA operating system is purpose-
built and packed with features, which makes the PIX/ASA highly secure but at the same
time provides many of the features found in ﬁrewalls based on general operating systems.
The PIX/ASA can be conﬁgured via a Web-based conﬁguration and management tool
called the Adaptive Security Device Manager (or, for the 6.x OS, the PIX Device Manager,
or PDM) or via a command-line interface. In managing the PIX/ASA, always use a secure
form of communication, such as SSH, which encrypts trafﬁc between the client and the
PIX/ASA, instead of Telnet, which communicates in clear text.This makes the PIX/ASA
easy to conﬁgure and manage for both the novice and the advanced ﬁrewall administrator.
We covered how to conﬁgure many of the PIX/ASA’s basic functions, including
deﬁning interfaces, NAT/PAT, access rules, and routing, which are essential to the
PIX/ASA’s secure operation.The PIX/ASA gives the DMZ planner the ﬂexibility to indi-
vidually set security levels to each DMZ interface, which can be used to control trafﬁc and
maintain the network’s integrity. NAT and PAT can be used to hide network internal
addresses or convert private IP addresses into publicly routable addresses.Access rules allow
the DMZ planner to limit access to resources on the DMZ via predeﬁned ACLs.The
PIX/ASA can support a variety of routing protocols, including RIP and OSPF, but most
DMZ infrastructures utilize static routing for its security, simplicity, and effectiveness.To pro-
vide additional functionality, we also covered how to conﬁgure failover for high availability,
content ﬁltering, and application layer security.
At this point, you have all the information you need to decide whether the PIX or ASA
ﬁrewall is the right device for your DMZ infrastructure in terms or features, functions, and
performance. Perhaps more important, this chapter gave you a good idea of how the PIX
and ASA are conﬁgured and managed.
www.syngress.com
310
Chapter 6 • Firewall Design: Cisco PIX and ASA

Solutions Fast Track
Basics of the PIX/ASA

The PIX is a network security appliance with a purpose-built operating system,
which reduces the risk of security ﬂaws inherent in ﬁrewalls built on general-
purpose operating systems.

The ASA is a network security appliance based on the PIX operating system,
which includes advanced IPS and Anti-X functionality into a single purpose-built
device.

There are ﬁve PIX models that can provide a high level of security and
performance for networks of any size, from SOHO to a large enterprise or service
provider.

There are four ASA models that can provide a high level of security and
performance for networks of any size, from SOHO to a large enterprise or service
provider.

The Adaptive Security Algorithm (ASA) allows the PIX to provide stateful
inspection ﬁrewall services, track the state of all communications, and prevent
unauthorized network access.
Cisco PIX/ASA Versions and Features

The fact that the PIX/ASA has a purpose-built operating system does not mean it
does not have the features of a ﬁrewall built on a general OS. In fact, the
PIX/ASA has a strong security algorithm along with features that include but are
not limited to URL ﬁltering, content ﬁltering, DHCP, and intrusion detection.

In addition to securing the network, the PIX can support mobile user and site-to-
site VPNs.

The ASA devices can be conﬁgured in one of ﬁve editions: Firewall Edition, IPS
Edition,Anti-X Edition, VPN Edition, and Business Edition.

The PIX and ASA share a common OS.The latest main release of the PIX/ASA
operating system is PIX OS version 7.2, which includes enhancements to VPN
features, support for VLANs and virtual interfaces, support for virtual ﬁrewalls and
security contexts, Layer 2 transparent ﬁrewalls, advanced Web ﬁltering, tunneling
application control, enhanced failover, and support for new, optional hardware.
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
311


The ASA can be enhanced beyond traditional ﬁrewall functionality through the
use of the AIP-SSM or CSC-SSM to provide integrated IPS functionality or threat
protection and content control, respectively.
Securing Your Network Perimeters

The PIX/ASA provides several design possibilities to secure your network and the
DMZ, including the traditional “three-legged” ﬁrewall, multi-DMZ, and dual
ﬁrewall internal/external ﬁrewall sandwich conﬁgurations.

The PIX/ASA can support DMZs of all sizes and capabilities, including high-
volume e-commerce sites.

All the designs can also support high availability with the use of a second
PIX/ASA as a hot standby ﬁrewall in the event of failure of the primary
PIX/ASA.This can be conﬁgured in either an Active/Standby or an Active/Active
failover conﬁguration.
Making a DMZ and Controlling Trafﬁc 

Apply security levels to active interfaces so that the PIX/ASA knows how to
protect and restrict access networks and devices on each interface.

NAT or PAT enables the PIX/ASA to hide addresses and translate private
addressing to public addresses that are routable throughout the Internet. For the
PIX to pass trafﬁc between interfaces, either no nat-control or a NAT and/or PAT
statement is required.

Access control lists enable the PIX/ASA to restrict access to devices on all
interfaces, including the DMZ.

Routing allows the PIX/ASA to forward trafﬁc out the correct interface and on
to the receiving device or next hop.The PIX/ASA supports static and dynamic
routing in the form of RIP and OSPF.
Advanced PIX/ASA Features

Failover enables the PIX/ASA to provide high availability in case of a failure in
either an Active/Standby or Active/Active fashion. In addition, the PIX/ASA
supports stateful failover, so user connections through the PIX/ASA should remain
active as failover occurs.

URL, Java, and ActiveX ﬁltering prevents access to restricted sites and protects
users from downloading dangerous content and applications.
www.syngress.com
312
Chapter 6 • Firewall Design: Cisco PIX and ASA


IDS and application inspection delve into the packets to make sure there is no
malicious activity ﬂowing through the PIX/ASA.
PIX/ASA Firewall 
Design and Conﬁguration Checklist

Use the checklist at the end of the chapter when you are designing and
conﬁguring your PIX/ASA ﬁrewall.
Q: Does the PIX/ASA support other desktop protocols, such as AppleTalk and IPX?
A: The PIX/ASA supports only IP. If you need to pass AppleTalk or IPX protocols through
the PIX/ASA, you must encapsulate them within an IP tunnel.Tunneling of protocols
through the PIX can be dangerous and should only be done in a controlled environ-
ment.
Q: What routing protocols does the PIX/ASA support?
A: The PIX/ASA can support static routing, RIP (versions 1 and 2), and OSPF.The
PIX/ASA does not support EIGRP and IGRP, Cisco’s proprietary routing protocols.
Q: Can the PIX/ASA protect the internal LAN from viruses or worms?
A: By default, the PIX/ASA does provide some application-level protection for popular
applications such as FTP and mail. In addition, the PIX does have IDS feature that can
protect against 55 predeﬁned attack signatures, providing protection against some pop-
ular DoS attacks. However, to protect against viruses and/or worms, you should consider
an ASA with the AIP-SSM or CSC-SSM instead of PIX ﬁrewall to take advantage of
the advanced ﬁltering capabilities the AIP-SSM and CSC-SSM provide.
Q: Can a PIX 515 and PIX 515E used together for failover?
www.syngress.com
Firewall Design: Cisco PIX and ASA • Chapter 6
313
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

A: No. Both PIX/ASA units must be exactly the same model and must have the same
amount of memory, Flash, and interface cards. Even though the PIX 515E is an
enhanced version of the PIX 515, the models cannot be used together as a failover pair.
Q: Does the PIX/ASA have packet-capture capabilities, similar to a sniffer?
A:Yes. PIX/ASA version 6.2 supports packet-capture capabilities that allow the adminis-
trator to capture packets on speciﬁc interfaces and to ﬁlter captured packets via ACLs.
The capture buffer can be viewed via the CLI or downloaded via a TFTP server.
Q: Does the PIX/ASA cut-through proxy work the same as a proxy server?
A: No.The PIX/ASA’s cut-though proxy feature does not work like a standard proxy
server, because the PIX/ASA will authenticate the user, and if permitted, the PIX/ASA
will allow the client to communicate directly with the remote server.A standard proxy
server will act as intermediate device where the client will request a connection to a
remote device; it intercepts all requests to the real server to see if it can fulﬁll the
requests itself. If it cannot, it forwards the request to the real server on behalf of the
client, so the client never directly communicates to the remote server.
www.syngress.com
314
Chapter 6 • Firewall Design: Cisco PIX and ASA

Firewall and DMZ
Design: Check Point 
Solutions in this chapter:
■
Basics of Check Point Firewalls
■
Securing Your Network Perimeters
■
Conﬁguring the DMZ
■
Conﬁguring the Firewall
■
Conﬁguring the Security Rulebase
■
Conﬁguring the 
Address Translation Rulebase
■
Conﬁguring Network and 
Application Protections
■
The Check Point NG Secure DMZ Checklist
Chapter 7
315
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
A key component of any security policy is a well-designed DMZ. Because hosts in the
DMZ are externally accessible over the Internet, your DMZ’s design can make or break the
overall security of your network.The DMZ can be the entry point through which mali-
cious-minded individuals can enter your network.
There are two types of trafﬁc to keep in mind when you’re considering controlling
trafﬁc ﬂowing to and from a DMZ: trafﬁc originating from or destined for your internal
network and trafﬁc originating from or destined for the Internet.Although the connection
point to the Internet is the most vital one, it is equally important to consider the access
point to the internal network. Not only does this consideration provide a second layer of
inspection for trafﬁc traversing the DMZ to reach internal hosts, it also allows you to protect
your network from malicious activity originating from within—an occurrence that’s growing
more and more common.
In this chapter, we review the basics of Check Point ﬁrewalls to give you a solid under-
standing of how ﬁrewalls operate and the feature they make available to you. We then go
into detail about several features of Check Point’s ﬁrewalls that are critical to developing a
well-secured DMZ.These details include how to best conﬁgure Check Point’s features to
secure your network perimeters. Finally, we document the steps to set up the DMZ from
scratch using Check Point ﬁrewalls, from the setup of the physical interface to rulebase con-
ﬁguration.
Basics of Check Point Firewalls
Check Point Software Technologies’ ﬁrewalls are full-featured ﬁrewalls that run on a variety
of platforms.These platforms include open systems and dedicated appliances manufactured
by Nokia as well as a dozen other companies such as Crossbeam, Sun, IBM, and others.
Additionally, Check Point ﬁrewalls run on top of a variety of operating systems (OSs),
including SecurePlatform, Nokia’s IPSO, Sun Solaris, Microsoft Windows 2000/2003, and
Red Hat Linux.
Designing & Planning…
Operating System Selection
Choosing the operating system to use for your Check Point ﬁrewall is important
to the overall effectiveness of the product in securing your network. In reality,
Check Point installs as a driver at the network card level of the OS, and so the
www.syngress.com
316
Chapter 7 • Firewall and DMZ Design: Check Point
Continued

security that Check Point provides under one operating system is, for the most
part, the same as in any other. However, the features, performance, and mainte-
nance options vary widely, depending on the underlying operating system. 
In terms of features, Check Point usually implements additional features on
SecurePlatform and Nokia IPSO that are not available in other OSs, such as ISP
redundancy and route-based VPNs. In terms of performance, operating systems
with large overheads, such as Microsoft Windows, will have a detrimental impact
on the performance that a ﬁrewall can offer. In terms of maintenance, keeping the
appropriate patches installed, ensuring full compatibility with all features, and
having easy-to-use backup and restore functions are extremely important. Only
SecurePlatform and Nokia IPSO provide the enterprise with patches that are easy to
install with the appropriate ﬁrewall version and with integrated backup and restore
functions that allow for complete disaster recovery in 30 minutes or less. 
NOTE
Once you select your underlying operating system, the next decision is what
platform to use. If you plan to use Solaris, AIX, or IPSO, you simply need to
select the available appliances you will use (the Nokia appliances are discussed
in greater detail in the next chapter). If you plan to use Microsoft Windows or
Red Hat Linux, you can select an open system based on Intel or AMD processors
from your preferred hardware vendor; see the Check Point Hardware
Compatibility list at www.checkpoint.com/products/supported_platforms/secure-
platform.html ﬁrst. For SecurePlatform systems, you can also select an open
system from your hardware vendor, or select from over a dozen different ven-
dors, such as Crossbeam, Resilience, HP, Sun, Nortel, and others, that manufac-
ture preinstalled SecurePlatform appliances.
Key features of Check Point ﬁrewalls are stateful inspection, network address translation,
multiple types of authentication mechanisms, SmartDefense, Web intelligence, and content
inspection; they provide malicious activity detection, antivirus, and other high-level applica-
tion protections against activities such as port scanning, FTP bounce attacks, URL worms,
spyware, and adware.
Check Point ﬁrewalls also have signiﬁcant VPN capabilities for both site-to-site and
remote access conﬁgurations. Check Point’s site-to-site VPN is interoperable with products
from all other major ﬁrewall vendors that implement the IKE and IPSec standards. For user
VPN access, there are several VPN client alternatives: SecuRemote, a free VPN client from
Check Point; SecureClient, a licensed VPN client that integrates a centrally managed per-
sonal ﬁrewall; and the SSL Network Extender, an SSL-based client that is ActiveX or Java
based and downloads from a standard browser.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
317

Choosing the Right Check Point Solution
Even for experienced Check Point professionals, keeping track of the various Check Point
versions and commercial offerings is difﬁcult. With a software-only solution, you can cur-
rently be running Check Point software purchased ﬁve or 10 years ago and have them
updated to the latest available version.
Check Point Releases: From 1.0 to NGX R61
It’s worthwhile to look at a quick timeline of Check Point releases. Check Point’s original
FireWall-1 solution ran on Solaris and was then ported to Windows NT. Constant version
upgrades led to VPN-1/FireWall-1 version 4.1 and Check Point 2000, which became the
most predominant version that Check Point had around 2000 and 2001.
In 2001, Check Point released NG (Next Generation), which could be considered ver-
sion 5.0. Later Check Point released NG Feature Pack 1, Feature Pack 2, and Feature Pack 3
(versions 5.1, 5.2, and 5.3, respectively) and, in 2003, NG with Application Intelligence was
released, with Release R54 (version 5.4). R54 included enhanced SmartDefense function-
ality. Subsequent releases included R55, which is still very widely used today, and R55W and
R57, which included Web intelligence and content inspection functionality, although they
are not widely deployed. In mid-2005, Check Point introduced NGX, a major upgrade from
R55, with release R60.This release added Web intelligence to the regular product line. In
April 2006, NGX R61 was released, adding content inspection (virus protection) for all
product lines.
Keep in mind that you can have a license purchased in 2001 at version 4.1 and through
the annually recurring Software Subscription be able to use that license to run NGX R61
software.
Check Point Solutions
The myriad of available Check Point versions can run on different platforms and with dif-
ferent packaged options. Until NG with Application Intelligence, there was an Enterprise
product line, with FireWall-1 and VPN-1/FireWall-1 available for purchase, and the
SmallOfﬁce line for businesses of up to 100 protected IPs.There was also a short-lived VPN-
1 Net product that was licensed based on VPN tunnels.
In 2003, Check Point changed its licensing scheme to the VPN-1 Pro and VPN-1 Express
lines and discontinued VPN-1 Net and SmallOfﬁce.All solutions included ﬁrewall and VPN
functionality.The Pro line includes quality-of-service (QoS) capabilities and extended support
for more VPN clients as well as unlimited gateway licensing.The Express line is limited to 500
users or fewer. In April 2006, Check Point once again changed its products to the VPN-1
UTM and VPN-1 Power lines.The UTM line includes ﬁrewall,VPN, IPS, and virus protec-
tion in one license, whereas the Power line includes ﬁrewall,VPN, IPS, QoS, and acceleration.
There is also a UTM Power line, which includes ﬁrewall,VPN, IPS, QoS, acceleration, and
virus protection.
www.syngress.com
318
Chapter 7 • Firewall and DMZ Design: Check Point

The VPN-1 UTM Edge and Check Point Software Safe@Ofﬁce round out the current
product offerings.These are small, integrated appliances, as shown in Figure 7.1, with local
Web-based administration; they include ﬁrewall, VPN, QoS, IPS, and antivirus for a small
business of up to 100 users.The two products are nearly identical with the exception that
the Edge products can be centrally managed from a SmartCenter, whereas Safe@Ofﬁce can
only be centrally managed through a dedicated product called a Security Management
Portal.There are four hardware varieties: wired, wired with ADSL modem, wireless, and
wireless with ADSL modem.
Figure 7.1 The VPN-1 UTM Edge Product Line
Management Architecture
Check Point’s ﬁrewalls use a distributed architecture, where the management server, or
SmartCenter, and the enforcement points, or gateways, can run on separate servers.As a
result, it is possible to manage multiple gateways with a single SmartCenter or even have
multiple SmartCenters with a high-availability conﬁguration.
Check Point provides a comprehensive set of graphical user interfaces (GUIs), collec-
tively called SmartConsole, to be used as a single conﬁguration point for all ﬁrewall func-
tionality.The SmartDashboard GUI provides separate views for the objects used in rulebases
(computers, gateways, networks, services, and groups); the various rulebases; a VPN Manager;
and a graphical view of your network.There are also the SmartView Monitor, SmartView
Tracker, and other components, which run on either Windows or Solaris.
TIP
The SmartConsole for Solaris, also called the Motif GUI, requires the purchase of
a separate license from Check Point and is less functional than the free
Windows-based client. Unless you have a requirement for using a Solaris GUI,
use the Windows version or run a virtual Windows machine in a *NIX system.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
319

Because of the three-tiered architecture—SmartConsole, SmartCenter, and Security
Gateway, as shown in Figure 7.2—there is a corresponding increase in management func-
tionality compared with  other models that use direct management access to the enforce-
ment points. Moreover, all elements are independent of one another. If the SmartCenter is
undergoing maintenance, the Security Gateway continues to work uninterrupted with the
last policy installed.
Figure 7.2 Check Point’s Three-Tiered Architecture
Stateful Inspection
The underlying technology behind Check Point ﬁrewalls is a proprietary inspection system
known as stateful inspection.The premise behind stateful inspection is that it is ineffective for a
ﬁrewall to determine whether to allow or deny each packet based solely on that packet’s
individual characteristics.
Check Point takes numerous other factors into account in examining packets, including
data from all layers within the packet, data from previous related packets, and information
received from related applications. Combine this with the capability to manipulate data
within each packet as it ﬂows through the ﬁrewall, and Check Point moves from the realm
of simple packet ﬁlter to a much more robust solution capable of doing advanced Layer 7
protections. It’s worthwhile to note that Check Point has a patent on stateful inspection and
that other manufacturers’ implementations of stateful inspection are not as complete.
Higher-Level Protections
Since the release of Check Point NG Feature Pack 2 and NG with Application Intelligence,
SmartDefense was added to the ﬁrewall functionality. SmartDefense concentrates on net-
work- and application-level protections, with an integrated intrusion prevention system (IPS)
www.syngress.com
320
Chapter 7 • Firewall and DMZ Design: Check Point
Security
Gateway
SmartCenter
Server
SmartConsole
The
SmartConsole 
controls the 
SmartCenter
The SmartCenter
controls one or more
Security Gateways

that is updated through the SmartDefense Subscription.The application-level protections are
particularly useful for securing normally insecure services.
Later on, with R55W and now NGX, Web intelligence was added to the available fea-
tures; it is a dedicated application-level ﬁrewall for Web trafﬁc. Express CI and NGX R61
added content inspection, where you have the option of integrated antivirus protection from
Computer Associates for Web, FTP, and e-mail trafﬁc crossing the gateway. We will discuss
SmartDefense, Web intelligence, and content inspection later in this chapter.
Securing Your Network Perimeters
Before conﬁguring your DMZ, it is critical that you have a general security policy that
addresses your network’s overall security. It does no good to have a perfectly secure DMZ if
other aspects of your ﬁrewall’s security conﬁguration are ﬂawed and allow unintended access
into your network.
The network perimeter is the interface or interfaces on your ﬁrewall that face a source
that is not trusted.The most common example of this perimeter is an interface out to the
Internet, but it is possible to have additional network perimeters—such as a connection to
another organization’s network or a second ISP—and the conﬁguration for these would be
the same.
Firewall Modes 
Check Point ﬁrewalls can be used in any conceivable DMZ conﬁguration, including the tra-
ditional “three-legged” design, a multi-DMZ setup, and the dual-ﬁrewall “sandwich” or
“back-to-back” conﬁguration, where separate ﬁrewalls protect the external and internal net-
works from each other.
Because Check Point’s management architecture can involve separation of the
SmartCenter from the gateways as well as separation of the SmartConsole from the
SmartCenter, it is important to plan the location of each of these components when you’re
designing your network. Figure 7.3 illustrates a typical “three-legged” ﬁrewall design, with
SmartConsole and SmartCenter separate from the gateway.
In this case, the SmartCenter is in the DMZ, whereas the SmartConsole GUI is on the
internal LAN. Having the SmartCenter in the DMZ allows you to use that console to
manage ﬁrewalls that are located on external networks, either on the Internet or on third-
party networks, should you so desire. If the SmartCenter is to be used only to manage ﬁre-
walls on the local network, it could be located on the internal LAN, which would provide
additional security, since it would not be in a zone accessible from untrusted networks or
from servers accessible from untrusted networks.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
321

Figure 7.3 “Three-Legged” Firewall With Distributed Check Point
Architecture
Note that the SmartCenter could be located on the internal LAN and still be able to
manage external ﬁrewalls through NAT. However, this setup adds complexity to the manage-
ment architecture.
Figure 7.4 illustrates a “back-to-back” conﬁguration, where two ﬁrewall layers are used
to separate internal resources from those that can be accessed from outside the perimeter.
Figure 7.4 “Sandwich” or “Back-to-Back” Firewalls With Distributed Check
Point Architecture
www.syngress.com
322
Chapter 7 • Firewall and DMZ Design: Check Point
Check Point
Firewall
SmartCenter
Server
Internet
DMZ
SmartConsole
LAN
SmartCenter
Server
SmartConsole
Internet
External DMZ
LAN
Internal DMZ
Internal
Firewall
External
Firewall

Routing Through Check Point 
It is important to keep IP routing in mind when you are conﬁguring the ﬁrewall.All routing
functionality is handled by the operating system on which the ﬁrewall is installed; Check
Point assumes that proper routing is in place to allow access to deﬁned networks. Initial
troubleshooting for any connectivity issue should be to determine whether appropriate
routing has been conﬁgured on the operating system running the ﬁrewall.
Due to the fact that routing functionality is not part of the ﬁrewall’s conﬁguration, a dis-
cussion of that topic is out of scope here. Consult the documentation of your operating
system or ﬁrewall appliance for information on how to conﬁgure static or dynamic routing
in each environment. Both SecurePlatform Pro (an option for SecurePlatform) and Nokia’s
IPSO have built-in dynamic routing support for OSPF, RIP, and BGP.
Conﬁguring Your DMZ
There is a wide variety of options that you might want to implement or have available on
your DMZ, such as a redundant cluster, redundant connectivity, quality of service, and so on.
Since a DMZ usually contains some of the most valuable IT resources in your enterprise,
you want to ensure that it has the best possible connectivity.
ISP Redundancy
A feature that is very useful for highly available environments is the ability to have two ISPs
connected to interfaces on the ﬁrewall, as shown in Figure 7.5. Check Point’s ISP
Redundancy option, available in SecurePlatform R55 and Nokia NGX, can be found in the
Topology section of the gateway, in the SmartDashboard.You can have two different external
interfaces, along with their default gateways, and choose whether a Primary/Backup conﬁg-
uration or a Load Sharing conﬁguration will be used.You can even select speciﬁc nodes to
monitor so that an upstream router can be checked.
NOTE
Any ISP failover will result in the interruption of all connections, which will have
to be reestablished through the second ISP. You also need to have a method for
redirecting incoming connections through your second ISP, whether using your
own IP addresses and BGP, Dynamic DNS, multiple DNS entries, or Check Point’s
ISP Redundancy DNS solution.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
323

Figure 7.5 ISP Redundancy
WARNING
In an ISP redundancy primary/backup conﬁguration, the ﬁrewall will overwrite
the default gateway route of the backup gateway. This will force all trafﬁc to
exit through the primary ISP, even if an externally originating connection
accessed the DMZ though the backup ISP. If there is a failover event, the OS’s
default gateway will be overwritten with the second ISP’s gateway.
Clusters
All current Check Point products have a built-in high-availability option, whereby you pur-
chase an additional gateway, usually at 80 percent of the original gateway price, and create an
active/passive cluster that will act as a single entity for all purposes.An additional ClusterXL
license can be purchased to create an active/active cluster for improved performance.This
license is not required for Nokia IPSO clusters. Clusters behave like individual ﬁrewall
objects.
SecureXL
SecureXL is an acceleration technology, originally developed by Nokia, which signiﬁcantly
enhances the throughput of a ﬁrewall by implementing pass/reject decisions at the network
driver level.This license is now included in the VPN-1 Power line. Certain features such as
ﬁngerprint scrambling and QoS are incompatible with SecureXL and you will have to
choose which feature is more important to you.
www.syngress.com
324
Chapter 7 • Firewall and DMZ Design: Check Point
Primary ISP
SmartConsole
LAN
Secondary ISP
DMZ
Check Point
Firewall

SecureXL is activated through the cpconﬁg program in the operating system running
the ﬁrewall and selecting the option to Enable SecureXL.To verify it is working, use the
fwaccell stat command from the command line.
Quality of Service
DMZ servers offer important services to both internal and external users. It is therefore prefer-
able to guarantee a certain bandwidth, priority, or level of service to trafﬁc accessing the DMZ.
Check Point’s QoS functions, previously called Floodgate, can offer both relative and absolute
prioritization. For example, you could assign 1Mb to e-mail trafﬁc, or assign it a higher priority
than regular trafﬁc. QoS is compatible with standards such as differentiated services (DiffServ)
classes and low latency queuing (LLQ) systems, and it is conﬁgured in the QoS rulebase in the
SmartDashboard. Conﬁguring QoS is outside the scope of this discussion.
Conﬁguring the Firewall
Once you decide on the kind of a DMZ you will have and the operating system, platform,
and options you will implement, you need to conﬁgure the ﬁrewall object in the
SmartDashboard, as shown in Figure 7.6. We assume that you have already installed the
system, established Secure Internal Communication (SIC) if needed, and opened the Check
Point SmartDashboard interface to the SmartCenter. Many of the steps to install a gateway
are covered in the following chapter for both SecurePlatform and Nokia.
Figure 7.6 Conﬁguring the Firewall Object in SmartDashboard
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
325

Conﬁguring Interfaces
Setting up a DMZ requires at least two and usually three or more physical interfaces conﬁg-
ured on the ﬁrewall. First you need to have the speciﬁc interfaces available on the server or
appliance on which your ﬁrewall runs. Ensure that the interfaces are conﬁgured and recog-
nized in the operating system. Both of these tasks are outside the scope of this discussion;
consult your hardware and operating system documentation for more information.
Once the interfaces are available and ready to use, the next step is to update the list of
interfaces of your ﬁrewall object. Edit the Properties of your ﬁrewall object, and choose
Topology, and you will see the screen shown in Figure 7.7.
Figure 7.7 Conﬁguring the Topology of a Gateway
Click Get… and select Interfaces and Topology. If communication is established with
the gateway, the SmartCenter will retrieve the list of interfaces and their topology.The
topology is generated by pulling the static route list of the gateway.You might see the
SmartCenter create new networks and groups so that each interface can be assigned a group
containing the networks behind that interface.This process has been simpliﬁed. Previously
each interface had to be entered manually by the administrator, who also had to ensure that
the interface names were the same as in the operating system.That process is now automati-
cally done by the Check Point software.
www.syngress.com
326
Chapter 7 • Firewall and DMZ Design: Check Point

Conﬁguring Interface Antispooﬁng
One popular method of breaching a network perimeter is via IP spooﬁng.A malicious user
could attempt to use IP spooﬁng to manipulate his or her source IP address, appearing to
originate from an address from within your network.The goal of this attack is to bypass deny
rules you have in place, since the ﬁrewall may perceive the user’s trafﬁc as being part of your
internal network.
To prevent IP spooﬁng, Check Point contains a comprehensive antispooﬁng feature.To
conﬁgure antispooﬁng, ﬁrst open the Check Point SmartDashboard and bring up the
Properties of your ﬁrewall object. Choose the Topology tab, shown in Figure 7.8.
Figure 7.8 Conﬁguring Interface Antispooﬁng Protection
Each interface of the ﬁrewall is listed here.The ﬁeld “IP Addresses behind interface”
relates to the antispooﬁng conﬁguration and speciﬁes the type of host residing on that inter-
face.The example shown in Figure 7.8 lists three interfaces: eth0, the internal network; eth1,
the external, Internet-facing network; and eth2, the DMZ. If the ﬁeld “IP Addresses behind
interface” does not appear, this is because the addresses are deﬁned as a host and not a
gateway. Right-click the object and select Convert to Gateway….
Highlight eth2, choose Edit, and then choose the Topology tab that appears, as in
Figure 7.8.
Specify whether this interface is external, which means it faces untrusted networks, or
internal, which applies to all other interfaces. Next, you need to specify the IP addresses
hosted by this interface.Although there is a Not Deﬁned setting, this choice is not recom-
mended, because it removes the antispooﬁng capability for this interface.
Choose Network deﬁned by the interface IP and Net Mask if the only network
behind this interface matches the network deﬁned in the General tab.Alternatively, choose
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
327

Speciﬁc and specify a previously deﬁned network object, usually a group that contains net-
works, if there are additional networks hosted behind this interface.
By choosing either of the latter two options, you provide the ﬁrewall with the informa-
tion it needs to perform antispooﬁng on this interface. More speciﬁcally, because the ﬁrewall
is aware of the IP addresses behind each interface, it is able to check that trafﬁc originating
from each address is actually sourced at the matching interface.
To enable antispooﬁng, turn on Perform Antispooﬁng based on interface
topology.You can also specify the tracking method the ﬁrewall should take when spooﬁng
is detected. It is important to track spooﬁng so that you can take additional preventive action
against the malicious user and his or her network.
Repeat this procedure for each interface on the ﬁrewall, and be sure to install the policy
to have these changes take effect.
Conﬁguring & Implementing…
Antispooﬁng Dropping Valid Packets
It is important to remember that when antispooﬁng is conﬁgured, you must
ensure that all IP networks behind an interface are speciﬁed in the topology con-
ﬁguration. If a network is left out, the ﬁrewall will assume that trafﬁc from that
network is spoofed, and it will drop those packets. Therefore, when adding a new
network to your ﬁrewall, it is important to remember the extra step of updating
the topology information for the interface that will host that network. Also, if
you inadvertently specify that the interface connected to the Internet is an
internal interface, all connectivity to the outside world will be blocked until you
correct the conﬁguration.
In a critical failure, use the fw unloadlocal command from the gateway’s
operating system so that you restore control over the gateway and can send a
ﬁxed security policy.
Customizing Stateful Inspection
Another important aspect to securing the network perimeters is the ability to customize
FireWall-1’s stateful inspection mechanism. By adjusting these values as circumstances change
around the network, you can ensure that you are taking full advantage of this powerful feature.
To access the stateful inspection properties, open the Check Point SmartDashboard,
choose Policy, and then choose Global Properties, as shown in Figure 7.9. Next select
Stateful Inspection.
www.syngress.com
328
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.9 Stateful Inspection
The ﬁrst set of deﬁnable values is for session timeouts.All these values relate to the
number of seconds that must elapse for various aspects of a TCP, UDP, and ICMP session. By
shortening these values, you reduce the risk of DoS attacks penetrating your network
perimeter. However, if the timeout values are too low, you could end up dropping valid con-
nections to the network that are slow for other reasons, such as poor network or server per-
formance.The default values are a good starting point and can be adjusted as required based
on the performance of valid network trafﬁc and the characteristics of malicious trafﬁc.
Next are settings for stateful UDP. Selecting Accept stateful UDP replies for
unknown services instructs the ﬁrewall to allow UDP connection replies, even if it is
unaware of the service type. Enabling this option also allows you to select Accept stateful
UDP replies from any port for unknown services, which allows UDP connection
replies on any port, as opposed to only the port on which the connection originated.
Similarly, you can conﬁgure the way the ﬁrewall deals with ICMP requests in the next
section: Accept Stateful ICMP.These settings relate to ICMP packets that are allowed
based on stateful information about TCP or UDP connections. Selecting Replies allows
ICMP reply packets, whereas selecting Errors permits ICMP error packets.
Selecting Accept Stateful other IP protocols replies for unknown services relates
to packets that are not TCP, UDP, or ICMP.This choice instructs the ﬁrewall to accept these
packets, provided they meet the usual state criteria.
Finally, the Out of State Packets section deﬁnes what the ﬁrewall should do with
TCP, UDP, and ICMP packets that are determined to be out of state (those that the ﬁrewall’s
inspection mechanism doesn’t know about or hasn’t anticipated)—whether they should be
dropped, logged, or both. For example, asymmetric routing (where an inbound path is dif-
ferent than the outbound path) will be a source of out-of-state packets. If you see a lot of
these packets for seemingly valid connections, check the routing conﬁguration in your oper-
ating system.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
329

Conﬁguring the Security Rulebase
Once the network perimeters have been conﬁgured, the next step is securing them.This
section covers the setup and conﬁguration of the Security Rulebase that will apply to the
perimeters.This section covers adding network objects and conﬁguring access rules to allow
access to and from the DMZ.
Creating Objects and Servers
Once the DMZ interface is conﬁgured and ready for use, the next step is to install and con-
nect the servers that are to reside in the DMZ to this interface. In general, you would con-
nect the ﬁrewall DMZ interface to a switch and then connect the DMZ-residing servers to
that switch. In this example, we have one Web server and one mail server sitting behind the
DMZ, with IP addresses 192.168.200.2 and 192.168.200.3, respectively.
Deﬁne each server to sit in the DMZ as a network object by choosing Manage |
Network Objects | New | Nodes | Host (see Figure 7.10).
Figure 7.10 Creating a New Host
To conﬁgure the host, set the name, IP address, and an optional comment and color for
it. By clicking the Conﬁgure Servers… button in the Host General Properties, you can
specify the server role, as shown in Figure 7.11.There are three possible roles to select from.
These roles classify the machine as a Web, mail, and/or DNS server, and classiﬁcation will
open up new protections to conﬁgure. For example, if you are creating a Web server, you
can select its operating system (Windows, Solaris, Linux) and application engine (PHP,ASP,
Perl, etc.), the port(s) it uses, and the ﬁrewall that protects it.You can also select which Web
intelligence (WI) protections to activate for the server. For a mail server, you can select the
www.syngress.com
330
Chapter 7 • Firewall and DMZ Design: Check Point

OS and the ports used for POP3, IMAP, and SMTP access. For a DNS server, you can select
the domain authorized for that server, which means which external queries can be accepted
to that server, or networks allowed for reverse DNS queries.
Figure 7.11 Conﬁguring Hosts as Servers
Deﬁne a network for administrator access by choosing Manage | Network Objects |
New | Nodes | Network and entering a name, network address, netmask, and comment
for it, as shown in Figure 7.12.
Figure 7.12 Creating a New Network 
Creating Services
In some situations, a DMZ server may be utilizing a proprietary service.This service can use
either a proprietary protocol or one that simply had its port number changed to hide the
service from others. Check Point allows you to create any service that you want, with any
port number, and to even specify that well-known services are running on different ports.
Services can be categorized as TCP, Compound TCP, Citrix TCP, UDP, RPC, ICMP, DCE-
RPC, and others.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
331

To deﬁne a new service, choose Manage | Services | New… and select the type of
service you want to create. For example, to create a new FTP service that answers to port 2121
instead of port 21, click the Advanced button of the TCP Service Properties dialog box.
This will open a new dialog box where you will be able to select the protocol type, as shown
in Figure 7.13. Select FTP for this example.This will allow FTP protections to be applied to
the trafﬁc as well as allow data connections in response to a request on port 2121.
Figure 7.13 Creating a New FTP Service
Creating Rules
Next we will deﬁne rules for HTTP and HTTPS access to the Web server and SMTP access
to the mail server (see Figure 7.14).
The ﬁrst rule permits any source IP address to access the HTTP (80) and HTTPS (443)
TCP ports of the Web server; the second rule permits any source IP address to access the
SMTP (25) port of the mail server.
Rule 3 allows only downloads from an FTP server on port 2121.To create such a rule,
select Manage | Resources | New | FTP… and create a resource named
Download_Only. In the Match section of the resource, select only PUT.Add the resource
to rule 3 by selecting Add with Resource in the Service column, using FTP and the
download resource you created.
Rule 4 allows access from the Administrators_Network to the DMZ using some man-
agement protocols such as SSH or Remote_Desktop (follow the previous procedure to
create a Remote_Desktop TCP service with port 3389).
Rule 5 then blocks all other access to the DMZ.
www.syngress.com
332
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.14 Rulebase for DMZ Access
Two additional rules could be necessary.The ﬁrst, Rule 6, allows HTTP and HTTPS
access from the mail server to an antivirus update server, which can be a frequent request to
keep the mail servers’ software updated.
Finally, Rule 7 blocks all trafﬁc originating from the DMZ. In the remote case that a
DMZ server is compromised, it’s important to prevent it from attacking the internal net-
works or other DMZs.
Combine a rulebase such as this with all the other perimeter security procedures men-
tioned in this chapter and you will have signiﬁcantly increased the security of your DMZ
hosts.
Conﬁguring the 
Address Translation Rulebase
As is standard on most ﬁrewalls, Check Point supports Network Address Translation (NAT)
with a variety of options. NAT is available in one of two modes: Hide and Static. In Hide
mode, many hosts are hidden behind one routable IP address. In Static mode, there is a one-
to-one mapping between internal and external IP addresses. Check Point also allows you to
manipulate the service of translated packets.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
333

You can use NAT in any number of scenarios when private IP addresses are used and
need to access, or be accessed from, external networks. One of the most common instances
where NAT is used is for access from workstations on the internal network to the Internet,
for activities such as Web browsing or ﬁle transfers.
For a DMZ, you could use routable IP address on your servers or add another layer of
security by using NAT to allow trafﬁc to these servers. If you don’t use NAT, your ISP will
need to route the DMZ segment (which will probably be different from your external IP
segment) to the external IP address of your ﬁrewall, which will then route connections to
the DMZ. If you use NAT, you should use Check Point’s automatic Address Translation rules
so that the ﬁrewall publishes the ARP entries necessary for it to respond to the NAT IPs.
Figure 7.15 shows an example of how to conﬁgure Automatic NAT rules for a DMZ Server
statically to another IP.
Figure 7.15 Automatic Address Translation Conﬁguration
The Address Translation rulebase will be automatically updated with the appropriate
rules. Moreover, it is usually unnecessary to NAT the connections from the internal net-
works to the DMZ networks.You can add a Manual NAT rule to the top of the rulebase, as
shown in Figure 7.16.
www.syngress.com
334
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.16 The Address Translation Rulebase
Designing & Planning…
DMZ with Network Address Translation 
Although using NAT for DMZ servers does provide an additional layer of security,
it is also important to keep in mind the extra load it places on your ﬁrewall; trans-
lating large amounts of packets consumes its resources. Therefore, if you have a
DMZ host that will have very high throughput levels, such as a busy Web server,
it might not be practical to use private addressing.
Conﬁguring Network
and Application Protections
Check Point provides you with a number of tools to allow you to effectively secure your
network perimeter.There are four distinct areas in which additional protections can be con-
ﬁgured.These are protections that neither a packet ﬁlter nor even a stateful-inspection-only
ﬁrewall can provide.These protections are network security in SmartDefense, which concen-
trates on things like scans and denial of service; application intelligence in SmartDefense,
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
335

which concentrates on protection for high level services like SQL Server, peer-to-peer, and
instant-messaging applications; Web intelligence, dedicated to protecting Web trafﬁc only, and
content inspection, dedicated to virus protection.
SmartDefense Network Security
SmartDefense is a very competent intrusion prevention system (IPS) that brings together
various attack detection and notiﬁcation systems present in previous Check Point versions.
With all these options conﬁgurable from one location, the task of conﬁguring your ﬁrewall
to detect attacks is greatly simpliﬁed. Most of the features also have a monitor-only option.
This makes it possible to monitor the trafﬁc coming into the DMZ without responding to
an attack. As with any IPS, it is important to get a sense of the trafﬁc coming into and out
of the DMZ and to try to identify and characterize legitimate trafﬁc. When you turn on
protection in Monitor-Only mode, you will see a small set of eyes in the check box, indi-
cating that the ﬁrewall will only “look” at the connection.
To access the SmartDefense conﬁguration dialog box, open the Check Point
SmartDashboard and go to the SmartDefense conﬁguration section, located next to the
Security and Address Translation rulebases (shown in Figure 7.17).
Figure 7.17 SmartDefense General Settings
In the General section, you have the option to make an Online Update, where you will
need to authenticate to the Check Point User Center.This option checks to see if any new
versions of SmartDefense are available, and if there are, it allows you to install these updates.
www.syngress.com
336
Chapter 7 • Firewall and DMZ Design: Check Point

There is also a link here to open the SmartView Tracker with a predeﬁned SmartDefense
ﬁlter.You can also use the Central Conﬁguration button to globally activate, deactivate, set to
monitor, or set to default settings for the SmartDefense conﬁgurations.
If you select Anti Spooﬁng Conﬁguration Status, you can see if any gateways’ anti-
spooﬁng conﬁgurations need to be ﬁxed.
Select Denial of Service and Non-TCP Flooding in the left side of the
SmartDashboard window, as shown in Figure 7.18.
Figure 7.18 SmartDefense Non-TCP Connections
A denial of service (DoS) attack involves an attacker sending a large number of requests
for particular services. Because the attack keeps your network so busy dealing with all the
excessive requests, it is not able to respond to valid requests, or at least not at its usual pace.
SmartDefense provides protection against three types of DoS attack: teardrop attacks,
which can crash servers by sending overlapping IP fragments; ping-of-death attacks, which
can crash servers by sending ICMP packets exceeding the normal maximum packet size; and
LAND attacks, which can affect network devices by sending packets with speciﬁc properties.
New since R55 is the non-TCP ﬂooding protection, which can limit the number of allowed
non-TCP connections as a percentage of total connections.
To enable each of the three types of DoS attack protection, expand the drop-down list
of attack types under the main Denial of Service option, and check each type of attack to
enable. By default, all three are enabled, and it is probably wise to leave them enabled unless
you have a speciﬁc reason to do otherwise.The single option available for each attack is the
tracking setting, which speciﬁes how the ﬁrewall should track detected attacks of that type.
Next is the IP and ICMP section.There are four types of veriﬁcation in this category:
packet sanity, max ping size, IP fragments, and network quota.The packet sanity veriﬁcation
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
337

looks at a number of aspects of each packet, such as headers and ﬂags, searching for anything
out of the ordinary.The max ping size setting allows you to specify how large ICMP request
packets may be.The most useful conﬁguration here for a DMZ is the network quota option,
where you can create a block or alert when there are more than a speciﬁed number of con-
nections per second from a speciﬁc source.This is very useful for blocking potential attackers
before they can make a dent in your ﬁrewall performance.The Advanced section allows you
to select network objects to which the protection will not apply as well as conﬁgure how
long an attacker will be blocked.The software can then check to see if the attacker is still
active, as shown in Figure 7.19.
Figure 7.19 Network Quota
A SYN ﬂood can slow down or stop a server by sending multiple incomplete handshake
sequences.The acknowledgment step of the sequence is left out, so the server continually
attempts to signal for this response, tying up its resources.
By choosing Override modules’ SYNDefender conﬁguration, you can enable SYN
attack protection on enforcement modules, even if they have SYNDefender, a component of
previous versions of Check Point FireWall-1/VPN-1, enabled. Disabling this option enables
the Early version SYNDefender conﬁguration option, which contains the traditional
SYNDefender settings.
To enable SYN ﬂood protection, choose Activate SYN Attack protection and then
Conﬁgure, as shown in Figure 7.20.
www.syngress.com
338
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.20 SYN Attack Conﬁguration
With the SYN Attack Conﬁguration dialog box you can set the tracking option for
SYN attacks detected and whether to track activity that is identiﬁed as part of a broad attack
rather than individual occurrences.The timeout value speciﬁes the number of seconds the
ﬁrewall should wait for the acknowledgment part of the handshake before marking the ses-
sion as possibly being part of an attack.The Attack Threshold sets the number of sessions
without acknowledgments that must occur before the ﬁrewall concludes that a SYN attack is
in progress. Finally, set Protect external interface only to ignore unusual SYN activity on
all other interfaces other than external interfaces.This option is normally selected because
SYN attacks originate on the Internet and usually from forged IP addresses.
The remaining two options in the TCP section are Small PMTU, Spoofed Reset
Protection and Sequence Veriﬁer.The Small PMTU section allows you to specify the
smallest packet size allowed.This capability is useful because of the potential for an attack
that involves sending a high number of very small packets, causing the network to slow
down or stop because it is busy processing all these packets.The Spoofed Reset Protection
can detect an abnormal number of RST packets in a speciﬁed time and block further RST
packets from the source.
The Sequence Veriﬁer function veriﬁes that packets are being sent in the correct
sequence.This prevents attacks that relate to packet sequence number manipulation.You have
the option to track out-of-state packets that are anomalous or suspicious, or all out-of-state
packets.
The Fingerprint Scrambling protection is useful for increasing the security of DMZ
servers by making it harder to identify the operating systems running your DMZ server.You
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
339

can activate ISN spooﬁng,TTL, and IP ID conﬁgurations, and they will change systems’
normal responses to different queries. Be aware that these protections disable any kind of
performance acceleration you have enabled, such as SecureXL, as described earlier in this
chapter.
By selecting the Retrieve and Block Malicious IPs option in the DShield Storm
Center section, you give the ﬁrewalls access to a list of active, malicious IP ranges detected
by SANS’s Dshield.org.This list is updated every three hours, and your ﬁrewalls would
immediately block and report any connection originating from those IPs.
The ﬁnal option in Network Security is the Port Scan detection. It can detect a host
port scan, where a single machine receives a directed scan to list all its open ports, and a
sweep port scan, where a speciﬁc service is scanned among different machines to determine,
for example, which machines are running Web servers.There are options to exclude network
objects or services from the scan.To block such scans, you will need to modify the Global
Properties | Log and Alert | Alert Commands and create a user-deﬁned script such as
sam_alert –I –src –t 600 to block the source of the attack for 10 minutes (you can look at
sam_alert syntax from a command line: sam_alert –h. sam_alert is part of the default Check
Point installation).
SmartDefense Application Intelligence
The Application Intelligence (AI) part of SmartDefense creates an application layer ﬁrewall
and is continually updated to add new protections and protocols. By implementing AI, you
can control and protect the use of many common and not-so-common protocols. It will
even protect you from those ever-increasing critical vulnerabilities in an operating system or
server application you are using.Although it is impossible to detail all the AI protections
available (and Check Point is constantly adding new ones), let’s examine some of the more
useful current protections in NGX’s Application Intelligence that relate to protecting DMZ
servers.
Mail
In Mail | POP3/IMAP Security, you can apply protection to all mail trafﬁc or to partic-
ular hosts deﬁned as mail servers.You can block the use of identical usernames and passwords
as well as set a maximum length for each.Additionally, you can block binary data or
unknown commands in the mail trafﬁc, as shown in Figure 7.21. Implementing this protec-
tion for a DMZ mail server is very useful, but you should closely monitor your logs when
implementing any changes so that you can detect any inadvertent drops of valid e-mail.
www.syngress.com
340
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.21 Mail protection
DNS
Next, click DNS. Here you have the option of implementing DNS protocol enforcement
for UDP and TCP.You can also create a list of domains that will be blocked when querying
the DNS servers.This is useful to block speciﬁc attacks such as worms.You should also acti-
vate the DNS Cache Poisoning protection, where you can implement scrambling, drop
inbound requests, and block mismatched replies, as shown in Figure 7.22.
Figure 7.22 DNS Protection
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
341

Peer-to-Peer and Instant Messengers
A great functionality of AI is being able to quickly and effectively block the use of peer-to-
peer protocols such as Kazaa, Gnutella, eMule, BitTorrent, SoluSeek, DirectConnect, IRC,
and Winny and instant messengers such as MSN Messenger, Skype,Yahoo! Messenger, ICQ,
and Googletalk. Protection against these protocols is enabled by simply checking the boxes
for those protocols, as shown in Figure 7.23. For each individual protocol, you can choose to
block or to monitor only. In addition, you can block on the speciﬁc proprietary protocol or
block the protocol when it tries to masquerade over the HTTP protocol. For MSN
Messenger, you can even control which features you will block (ﬁle transfer, application
sharing, white board, and remote assistant).You can also create a global list of exclusions for
services or network objects that will be allowed to use these protocols.
Figure 7.23 P2P Protection
Microsoft Networks
One feature that’s relatively unique to Check Point is that it can block propagation of worms
within the Microsoft network protocols. In the File and Print Sharing section shown in
Figure 7.24, you can block or monitor worms with a single click. Other protections include
blocking null CIFS sessions and WINS attacks.
www.syngress.com
342
Chapter 7 • Firewall and DMZ Design: Check Point

Figure 7.24 Microsoft Networks Protection
Microsoft SQL Server
Many database servers are located in DMZs, and the protections Check Point offers for
Microsoft SQL Servers are especially powerful.You can block four types of attack on the
SQL Monitor protocol: buffer overﬂow, version information, heap overﬂow, and network
DoS attacks. Even more interesting is the protection for the SQL Server protocol, where you
can select which port the SQL server uses, block attempts to log in with a blank password (a
common default conﬁguration mistake), block the execution of stored and extended stored
procedures, enforce Windows Authentication (and block the less secure SQL authentication),
and perform the protection on port 2433 as well, as shown in Figure 7.25.
VPN Protocols
The protections in this section relate to the VPN protocols that traverse the gateway.Two
useful conﬁgurations in SSH enforcement are to Block SSH v1, which is a version known
to have serious security ﬂaws, and to Block IKE Aggressive Exchange in IKE, which has
inherent authentication risks.
Routing Protocols
If you’re using dynamic routing protocols in your network, you could activate Check Point’s
protections, which will block OSPF, BGP and RIP protocols that are not MD5 authenti-
cated. However, you could be exposed to a DoS attack from external interfaces, so activate
them mostly on internal networks.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
343

Figure 7.25 SQL Server Protection
Tools & Traps…
Keeping Your SmartDefense Up to Date
SmartDefense is continually updated, sometimes with four or more updates a
week. These updates can be additional protections for existing protocols—for
example, for new vulnerabilities discovered or new protocols being protected.
You should read the full description of the available updates, both to learn what
new protections are available and to prevent valid trafﬁc from being blocked by
a new update. You should subscribe to the SmartDefense Advisories and Updates
mailing list by sending an e-mail to listserv@amadeus.us.checkpoint.com with
the text “SUBSCRIBE SMARTDEFENSE-NEWS” in the e-mail body.
Web Intelligence
The Web Intelligence section provides deep protection for Web trafﬁc, with advanced features
that rival most dedicated Web security gateways. One caveat is that most of the Web intelli-
gence protections, especially those that apply to hosts deﬁned as Web servers, require the addi-
tional Web Intelligence license from Check Point. Most of the Web intelligence protections
can have a protection scope that applies to all HTTP trafﬁc or that applies only to selected
Web servers (from among those hosts conﬁgured with the Web Server property).You can also
www.syngress.com
344
Chapter 7 • Firewall and DMZ Design: Check Point

select to monitor only the protections or to send an error page if blocked.The error page
option can be a predeﬁned HTML page that you conﬁgure or a redirection to another URL.
Be aware that activating the error page has a performance impact on the ﬁrewall.
Malicious Code
Two important protections can be found in the Web Intelligence section: General HTTP
Worm Catcher and Malicious Code Protection. With the General HTTP Worm Catcher,
shown in Figure 7.26, you can activate protection against URL-based worms such as
CodeRed and Nimda.You can also deﬁne or import additional worm patterns.As with
many of the protections in Web intelligence, you have the Monitor Only option to set to
monitor the protection and to send an error page if the attack is blocked.
Figure 7.26 General HTTP Worm Catcher
The other protection in this section is the Malicious Code Protector.This protection
works like a virtual machine that disassembles machine code to detect attacks such as buffer
overﬂows in URLs, HTTP requests, and bodies. It is very powerful, and you can customize it
through two categories: memory consumption and speed and the search method, as shown
in Figure 7.27.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
345

Figure 7.27 Malicious Code Protector
Application Layer
Application Layer Web protections refer to the use of commands within the HTTP stream
that can be used to execute commands in misconﬁgured Web servers.You can activate pro-
tections against cross-site scripting, LDAP injection, SQL injection, command injection, and
directory traversal attacks.The ﬁrst three can be ﬁne-tuned to accommodate commands that
you would like to permit or speciﬁcally block.
Information Disclosure
With header spooﬁng, you can replace the responses that a Web server might send to iden-
tify its operating system, make, and version, to make it harder for attackers to speciﬁcally
target vulnerabilities in a speciﬁc Web server or version.You can, for example, replace all
headers containing the characters IIS in the value, to a simple IIS-only response.This hides
the particular version in use. Other options you can activate prevent directory listings as well
as error concealment. Error concealment will replace standard error message pages that a
Web server sends and that usually identify the Web server or dangerous programming-related
errors with a basic ﬁrewall-generated message or a customized error page.You can conﬁgure
which error codes will be concealed and which application engines will be detected.
HTTP Protocol Inspection
With these protections enabled, as shown in Figure 7.28, you can specify the maximum size
of URLs and HTTP headers and the maximum number of HTTP headers. In addition, you
can conﬁgure which HTTP methods will be allowed as well as whether ASCII-only requests
www.syngress.com
346
Chapter 7 • Firewall and DMZ Design: Check Point

and response headers will be accepted.These protections can be applied to all HTTP trafﬁc,
to selected Web servers, or to connections related to URI resources.These protections pre-
vent attacks that attempt to exploit poorly conﬁgured Web servers and unknown or zero-day
Web vulnerabilities.
Figure 7.28 HTTP Format Sizes
HTTP Protocol Inspection and Header Rejection
The header rejection protections are especially powerful because they allow all kinds of
applications that use the Web protocol to be detected and blocked. SmartDefense updates
these signatures that detect spyware, adware, and other applications, including MSN
Messenger.You can also deﬁne your own signatures to detect speciﬁc applications.This func-
tion works by examining headers within the Web protocol and looking for particular header
names and values that will identify speciﬁc applications (see Figure 7.29).
Content Inspection
With VPN-1 Express CI (in R57 and NGX 60A) and VPN-1 UTM (R61), Check Point
has added content inspection to its product line. Right now content inspection means
antivirus protection of SMTP, POP3, FTP, and HTTP through a partnership with Computer
Associates.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
347

Figure 7.29 HTTP Header Rejection
To enable virus protection, you need to edit the Gateway properties and select
AntiVirus within the Check Point products installed.That option will only be available if
the selected version is R57, R60A, or R61. Once the option is selected, you can edit the
interfaces in the Topology section of the Interface Properties dialog box and check the
box next to Interface Leads to DMZ, as shown in Figure 7.30.
Figure 7.30 Conﬁguring an Interface That Leads to the DMZ
www.syngress.com
348
Chapter 7 • Firewall and DMZ Design: Check Point

Within the Content Protection tabs, there are several settings to conﬁgure. Signature
Updates allows you to see the latest signatures downloaded and select Automatic
Signature Updates. Once you enter your UserCenter Credentials, signatures can be
uploaded automatically to the gateways, either directly from Check Point or from the local
SmartCenter.
For each of the four protected services, you can select whether the trafﬁc scanned will
be by ﬁle direction or by IPs. By ﬁle direction uses the interfaces deﬁned as leading to the
DMZ, as in Figure 7.31.The available options are:
■
Scan incoming ﬁles arriving to the DMZ and internal networks, internal networks,
or the DMZ
■
Scan outgoing ﬁles leaving the DMZ and internal networks, internal networks, or
the DMZ
■
Scan internal ﬁles passing between the DMZ and internal networks or between all
internal networks 
Figure 7.31 Conﬁguring Antivirus Protection for the DMZ
You can select network objects that will be exempt from the inspection. Checking
Activate Continuous Downloads will prevent client timeouts when you’re scanning large
ﬁles.Also, you can select Advanced Options to conﬁgure the alerts that will be generated
when a ﬁle is scanned, contains a virus, or is blocked. In addition, you can specify the notiﬁ-
cation messages, and for SMTP and POP3 trafﬁc you can specify whether to block TLS
trafﬁc and scan MS Exchange speciﬁc data.
In the File Types section, you can select which ﬁle types to scan, pass, or block and
whether they will have continuous downloads active.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
349

Finally, in the Settings section, you can set the maximum ﬁle size to scan in Mbytes and
whether large ﬁles will be blocked or passed without scanning. For archived ﬁles, you can
conﬁgure the maximum nesting level and compression ratio, as well as the behaviors for
when the antivirus engine is overloaded, if the scan fails, or if the engine fails to initialize.
Check Point NG Secure DMZ Checklist
Here is a checklist of the key elements to take into account when you’re building a secure
DMZ in a Check Point NG environment. Keep these in mind as you prepare and imple-
ment your DMZ, because they will greatly aid in both the ease of setup and the overall
functionality and security of your Check Point NG DMZ:
■
All ﬁrewall interfaces have IP addresses speciﬁed in their topology conﬁguration.
■
All ﬁrewall interfaces have antispooﬁng enabled.
■
New network interfaces are added and conﬁgured in the operating system.
■
Routable networks are assigned by the ISP and routed to the ﬁrewall.
■
Deﬁne network objects for DMZ hosts.
■
NAT is conﬁgured for outbound access from the internal network.
■
Rules are added to the rulebase to allow access to DMZ hosts from the Internet.
■
Rules are added to the rulebase to allow access to DMZ hosts from the internal
network.
■
Static or dynamic routing is conﬁgured in the operating system.
■
SmartDefense is conﬁgured to detect, block, and log DoS and other attacks.
■
Web intelligence is conﬁgured to protect against attacks on Web trafﬁc.
■
Content inspection is conﬁgured to detect and block viruses coming into or out
of the DMZ.
www.syngress.com
350
Chapter 7 • Firewall and DMZ Design: Check Point

Summary
Because the nature of a DMZ is to allow access from the Internet to hosts on your network, it
is important to maintain a complete security policy surrounding access to these hosts. Building
a secure DMZ with Check Point involves many aspects of the ﬁrewall’s feature set. It is impor-
tant to use these features to ensure that there are no weak links in your security policy.
Check Point’s stateful inspection architecture provides a solid fundamental inspection
layer for all trafﬁc traversing the ﬁrewall to reach DMZ hosts. More effective than a simple
packet ﬁlter, the ability to make ﬁltering decisions based on packet state and context is a
powerful mechanism from which your DMZ security will beneﬁt.
Add to this the attack-prevention systems that are part of SmartDefense, such as applica-
tion intelligence, Web intelligence, and content inspection, and the full picture of what it
takes to build a secure DMZ comes into focus. Deﬁning rules to allow speciﬁc access to
hosts within the DMZ is a ﬁnal step that must be done, keeping in mind only the access that
is actually required to and from these hosts.
Solutions Fast Track
Basics of Check Point Firewalls

Stateful inspection provides enhanced ﬁltering based on state, context, and other
information about each packet.

NAT, conﬁgured manually or automatically, allows for translation of source,
destination, and service for each packet.

A distributed management architecture provides additional security by eliminating
a direct connection between conﬁguration client and enforcement point.
Securing Your Network Perimeters

Enable antispooﬁng for all interfaces on the ﬁrewall to prevent spoof attacks.

Use SmartDefense to protect your network from multiple types of attack,
including DoS attacks.

Customize stateful inspection to catch the maximum number of out-of-state
packets.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
351

Making a DMZ and Controlling Trafﬁc

Install DMZ hosts on a separate interface on the ﬁrewall.

Add rules to the rulebase to allow access from the Internet to the DMZ and from
the internal network to the DMZ.

Conﬁgure static or dynamic routing in the operating system to allow access to and
from the DMZ.
The Check Point NG Secure DMZ Checklist

Follow the Check Point Secure DMZ Checklist when you’re planning and
running a Check Point DMZ.
Q: Do I need a separate physical interface on the ﬁrewall for the DMZ, or can I share
another interface?
A: For the maximum level of security, you should have a separate interface for the DMZ.
Using VLANs or other techniques, you could share another interface for the DMZ, but
the ﬁrewall will not be able to protect the DMZ from trafﬁc on the shared interface.
Q: The ﬁrewall is dropping legitimate packets because it reports they are out of state. How
do I correct this?
A: One common cause of this problem is a conﬁguration in which trafﬁc is delivered to a
node on one ﬁrewall interface and the node transmits the response on a different ﬁrewall
interface.The stateful inspection engine will not recognize this trafﬁc as legitimate.The
solution is to ensure that all trafﬁc moving to and from each node is using the same
interface.
Q: Is it necessary to restrict trafﬁc to or from the internal network to or from the DMZ?
Can’t I just open all access between them?
www.syngress.com
352
Chapter 7 • Firewall and DMZ Design: Check Point
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

A: It is important to keep in mind that not all malicious activity comes from the Internet.
You need to protect your DMZ from internal attacks as well, and so it is good security
practice to only allow access that is actually required, even between the internal and
DMZ segments.
Q: What is the best way to deal with alerts generated by SmartDefense?
A: In general, if SmartDefense has detected a security violation, it is a good idea to block all
access from the offending host to your network, if possible.You can then notify the
administrator of that network so that he or she can deal appropriately with the
offending user.
Q: Is it necessary to have separate hosts for the enforcement point, SmartCenter, and GUI?
A: No.Your ﬁrewall will operate normally if two or all three of these components are
installed on the same host. However, by dividing them into separate hosts, you gain the
advantage of additional ﬂexibility in terms of being able to manage multiple enforce-
ment points.There is also an increased level of security if the SmartCenter is not on a
host accessible to the Internet, such as the enforcement point.
www.syngress.com
Firewall and DMZ Design: Check Point • Chapter 7
353


Firewall and 
DMZ Design:
SecurePlatform and
Nokia Firewalls
Solutions in this chapter:
■
Basics of SecurePlatform Firewalls
■
Basics of Nokia Firewalls
■
Using cpconﬁg
■
Nokia Firewall and DMZ Design Checklist
Chapter 8
355
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
As we saw in the previous chapter, Check Point Software Technologies’ ﬁrewalls can run on a
variety of platforms.You can use open systems based on Intel or AMD processors or dedicated
appliances manufactured by Nokia and a dozen other companies. However, two of the most
popular and most powerful platforms continue to be Nokia’s IPSO operating system and
Check Point’s SecurePlatform operating system.This chapter addresses these two platforms,
including installation, initial conﬁguration, and setting up Check Point for the ﬁrst time.
SecurePlatform is a Linux-based operating system created by Check Point. It has been
hardened and does not require an additional license for its use (except for the
SecurePlatform Pro, required for dynamic routing). Since its introduction with NG Feature
Pack 2, SecurePlatform has become one of the most widely deployed platforms, along with
Nokia. Check Point has been doing all its research and development on SecurePlatform,
with other operating systems being done later. SecurePlatform runs on almost any open
system available: white-box systems with Intel Pentium IIs and 128Mb of RAM, up to dedi-
cated server-class appliances running multiple CPUs and RAID conﬁgurations. In fact,
SecurePlatform can run inside virtual machines from VMWare and Virtual PC, which is
great for testing, troubleshooting, and more.The illustrations in this chapter were done while
running on Microsoft’s Virtual PC.
The Nokia IP Series is dedicated appliances that provide ﬁrewall services using Check
Point ﬁrewalls. Nokia’s underlying OS, IPSO, is based on the FreeBSD operating system.The
IPSO OS has been hardened and does not require a license for its use. In addition, the IPSO
OS is highly optimized for trafﬁc forwarding. IPSO also provides a wide range of routing
services and protocols.All Nokia IP Series appliances use IPSO, except for the IP40 appli-
ances, a separate product line similar to the Check Point VPN-1 Edge appliances, which uti-
lize different technology and are not discussed in this chapter.
Both SecurePlatform and IPSO have advantages over other operating systems for run-
ning your Check Point ﬁrewalls.Among these advantages are improved compatibility, more
features, easier installation, easier upgrades and patches, and better maintenance and backup
functionality.
This chapter refers to a Check Point NGX R61 installation in a distributed environ-
ment, which is the recommended way to plan your installation of NGX, and with a DMZ.
A distributed installation consists of separating the SmartCenter Server from the security
gateway.As we said in the previous chapter, the SmartCenter Server contains all the objects,
security policies, user databases, time objects, logs, and so on that are required to push a secu-
rity policy to a gateway.The security gateway will contain an inspect script that it received
from your SmartCenter Server.The gateway will then determine whether or not to pass the
trafﬁc, according to the security policy it received.
www.syngress.com
356
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Basics of SecurePlatform Firewalls
Check Point has been doing all its research and development on SecurePlatform, with other
operating systems being done later. SPLAT (shorthand for SecurePlatform) has been taking
over the market since its arrival with Check Point Next Generation Feature Pack 2. We will
take a tour of SecurePlatform, looking at the various operating system capabilities and the
Check Point-supported add-ons. Check Point has placed lot of emphasis on SPLAT, and
many other operating systems have been replaced by an Intel-based system to run SPLAT as
their underlying OS to run VPN-1 Pro. With the popularity of appliance devices in the
market and the cost-effectiveness of utilizing Intel-based hardware instead of more expensive,
proprietary hardware, Check Point is offering more ﬂexible and cost-effective solutions by
continuing to develop the SecurePlatform Operating System.
Even if you choose a dedicated appliance like Nokia for your ﬁrewalls, using a
SecurePlatform system for your SmartCenter can save you a lot of money while giving you
the performance and management you need.
Choosing the Right SecurePlatform Option
There are basically two hardware options if you decide to use a SecurePlatform system: dedi-
cated appliances or open systems. Open systems are machines that you create, purchase, or
customize yourself from any number of hardware vendors and then use the SPLAT CD to
reformat the machines. It is usually less expensive to use an open system, and you would
only get hardware support from your manufacturer.At the Check Point OPSEC Web site at
www.opsec.com, you can ﬁnd a list of recommended systems, performance ratings, and sug-
gested prices from makers like IBM, Sun, Dell, and HP. It’s very important to check the
Hardware Compatibility list at www.checkpoint.com/products/supported_platforms/secure-
platform.html before you make any purchases and then ﬁnd out your system, NIC, or RAID
card is incompatible.
Dedicated appliances come preinstalled with SPLAT, ready to be conﬁgured.They are
also ﬁne-tuned and pre-tested to avoid any incompatibilities.You can also beneﬁt from your
manufacturer’s support team, which will be more familiar with Check Point-related prob-
lems than a generic vendor.You can ﬁnd appliances from vendors such as Crossbeam,
Corrent, i-Security, Resilience, SecureGuard, and Sun also listed at www.opsec.com.
Conﬁguring SecurePlatform
The installation of SecurePlatform is designed to be a very easy process. In this section, we
cover the installation process and the conﬁguration of SecurePlatform as a SmartCenter
Server.Although we will mostly use the command-line interface, there is a very complete
Web graphical user interface (GUI) offered over HTTPS.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
357

Installing SecurePlatform
To install SecurePlatform, use CD 1 of the Check Point Media Kit. (Up to R55, the media
kit was a single CD; in NGX, it is two CDs, and in R61 you get a four-CD media kit.)
Power on your machine with the SecurePlatform CD-ROM in the drive and a monitor and
keyboard attached.The SecurePlatform installation program automatically starts and asks you
to press Enter to continue, as shown in Figure 8.1. If your machine does not have a CD-
ROM drive, you can use alternative methods for installation, such as a diskette or network
boot. Refer to the user guide in the Check Point CD for further instructions.
Figure 8.1 SecurePlatform Installation Welcome Screen
When the welcome screen appears, press Enter.The installation program boots and
loads the necessary drivers for the hardware it detects.After the SecurePlatform installation
program is ﬁnished booting, you are presented with a screen summarizing the hardware
probing results, as shown in Figure 8.2.This is a critical screen because if the machine
doesn’t ﬁnd appropriate mass-storage devices (such as a hard drive), the installation will not
continue, and if it doesn’t detect your network cards you can also be looking at compatibility
problems. In this screen you can add Linux or SPLAT drivers that you might have. If your
system is suitable for SPLAT, press OK.
The next screen asks you which version you want to install.The options are
SecurePlatform or SecurePlatform Pro. Unless your infrastructure requires advanced routing
options such as OSPF or BGP, most users should choose SecurePlatform. Otherwise you
need to purchase a SecurePlatform Pro license.
www.syngress.com
358
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Figure 8.2 Welcome Screen After Hardware Scanning
The next screen asks for some localization information. Choose the proper information
to match your hardware.The next step asks which Ethernet device to conﬁgure.The default
is the ﬁrst NIC the system recognizes. In most cases, you will want to have the primary
interface (and the IP address the hostname is tied to) be the external address—especially for
VPNs. Once you select which NIC to conﬁgure, you can enter the IP address, network
mask, and default gateway for the machine. Other NICs are conﬁgured once you reboot.
The next screen asks if you want to enable an HTTPS server for server conﬁguration. If
you plan to use the Visitor Mode feature of remote access VPNs, you should change the
port to any other you like.
You are prompted to conﬁrm the formatting of the hard drive, and then the installation
program begins copying the SecurePlatform ﬁles.After this step is completed, you are
prompted to reboot the machine, as shown in Figure 8.3.
Figure 8.3 SecurePlatform Complete Installation Screen
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
359

Initial Conﬁguration
Once SecurePlatform is installed, you can access the command line via a monitor and key-
board, an ssh connection, or a serial connection. If you choose to use a serial connection,
you should set your terminal program to 9600 baud, 8 data bits, no parity, and 1 stop bit and
connect to COM1.This sequence is designed so that the SPLAT box can be set in a rack
environment, without the need for a console or keyboard.
The default username and password are admin and admin. Once logged in, you must
change your password to a strong password, and optionally change the username.After that,
you will enter the Check Point restricted shell (CPShell), a Linux interface that provides you
only a limited set of commands.To access the full Linux OS, use the expert command and
enter the expert password, which initially is the same one as the admin user, but you are given
the option of changing it.The expert password, in Linux terms, is the root user password.
WARNING
For users who are familiar with the Linux operating system, it might seem easier
or more efﬁcient to conﬁgure the SecurePlatform manually via the ﬁle system. It
is very important to utilize the tools Check Point supplies to conﬁgure the oper-
ating system, because the Check Point tools could alter more conﬁguration ﬁles
than is apparent.
The ﬁrst thing you should do is use the sysconﬁg, which will show the Welcome Wizard
the ﬁrst time it is run.Type n for Next to advance among the wizard’s screens.You will ﬁrst
see the Network Conﬁguration screen, as shown in Figure 8.4. From here you should set the
hostname (particularly important for a SmartCenter installation, so choose your hostname
wisely), the domain name, the domain name servers, the network connections, and routing
conﬁguration.You should have no trouble conﬁguring the ﬁrst three sections.
Figure 8.4 The Welcome Wizard Network Conﬁguration Screen
www.syngress.com
360
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Let’s look at the Network Connections Conﬁguration screen, as shown in Figure 8.5.
You have the option to conﬁgure a network connection, which you need to do for the
interfaces to which you have not assigned an IP. In Linux, Ethernet interfaces have the preﬁx
eth, and numbering starts at zero. Conﬁgure each interface with an IP address and network
mask, and you can usually leave the broadcast address to the default.You can even set if as a
dynamic interface, so that it receives its IP address via DHCP.
Figure 8.5 The Network Connections Conﬁguration Screen
Two important options in the Network Connections Conﬁguration screen are “Add
new connection” and “Remove connection.” SecurePlatform has built-in support for
VLANs, and you can add up to 1024 VLAN interfaces to a single machine. Once you add a
VLAN interface, you will be prompted for the VLAN tag (2-1024), and the new interface
will then be named ethX.Y, where X is the physical interface and Y is the VLAN tag.You
can also add secondary IPs to physical interfaces, even though from a security perspective it’s
not recommended. Other interfaces such as PPPoE, PPTP, and ISDN can be conﬁgured as
well. When you’re done, exit back to the Network Conﬁguration screen.
The last option in the screen is the Routing option, which only allows you to set a
default gateway if you didn’t set it when initially conﬁguring an interface.After the Network
Conﬁguration screen is the Time, Date, and Timezone screen.They are self-explanatory to
conﬁgure.
You will then see a screen where you can Import a Check Point conﬁguration ﬁle from
a TFTP server. If you have made a backup on another system that you want to import into a
new system, you can use this interface to import the backup and restore all conﬁgurations.
Initial Check Point Conﬁguration
Once you step through these Welcome Wizard screens, you’ll get to the Check Point instal-
lation wizard, as shown in Figure 8.6. Press N for Next, and in the next screen accept the
license agreement and press Y.You will be prompted to select whether to install Check
Point Enterprise/Pro or Express. Eventually those will be replaced by options for VPN-1
Power or UTM. In any case, select Pro. Even if you have an Express license, it will work
with a Pro installation. In the next screen you also have the option of creating a new installa-
tion or importing a Check Point conﬁguration from a previous installation.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
361

Figure 8.6 Check Point Installation Wizard Welcome Screen
For a new conﬁguration, you can now select the Check Point products to install, as
shown in Figure 8.7. For a SmartCenter, you should choose SmartCenter, and optionally
UserAuthority (a single sign-on product from Check Point), Integrity (available only on
NGX R61 and higher), Eventia Reporter, and SmartPortal (a limited Web-based inter-
face to the SmartCenter). For a security gateway, choose VPN-1 Pro and optionally the
Performance Pack. If you selected a SmartCenter installation, you have to decide if it’s
Primary, Secondary, or Log only.You can have only a single Primary SmartCenter conﬁg-
ured. Before installing the products selected, you need to conﬁrm your selections.
Figure 8.7 Check Point Product Selection Screen
www.syngress.com
362
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Once the products are installed, you’ll see the prompts to ﬁnalize conﬁguration of your
Check Point installation: licenses, administrators, and GUI clients for SmartCenters, or acti-
vation key for security gateways.Then you will need to reboot your machine.You can then
use the SmartConsole to log into a SmartCenter or use an existing SmartCenter to establish
Secure Internal Communication (SIC) with the SmartCenter over a security gateway.
Remember that if you have a security gateway, once you reboot it you won’t be able to
access it until a policy is installed into it.
SecurePlatform Conﬁguration
After the initial SecurePlatform and Check Point conﬁguration, you will eventually need to
change or add some conﬁgurations. Use the sysconﬁg utility to see the screen shown in
Figure 8.8.
Figure 8.8 The sysconﬁg Utility
Some options that are available here include a full routing conﬁguration for static routes
and conﬁguration of the built-in DHCP server in SPLAT. From the Products Installation
option you can add products that you didn’t install originally, such as Integrity or Eventia
Reporter.The Products Conﬁguration option opens the cpconﬁg utility to conﬁgure all
Check Point options. With the Export Setup option, you send a conﬁguration copy to a
TFTP server.
SecurePlatform Maintenance
Some of the advantages of SecurePlatform as an operating system are all the built-in features
for maintenance of the platform.You do not have to worry about patching the underlying
OS, since Check Point patches and upgrades inclusive OS ﬁxes as well.You can use the
Backup and Restore commands for simple backups, Snapshot and Revert commands for com-
plete disk copies, and the Patch command to install patches and upgrade your platform.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
363

Backup, Scheduled Backup, and Restore
An extremely useful pair of utilities is backup and restore, for obvious reasons. Backup enables
you to create a backup of the system conﬁguration ﬁles and save them locally or send them
to a TFTP or SCP server.All backups are stored in the /var/CPbackup/backups directory.
Use the backup command with no parameters to create a backup on the local system.
Some available options are –l, to include logs in the backup (which could then increase to
several gigabytes or more); -t, to send to a TFTP server; —scp, to send to an SCP server; and
–sched, to schedule a recurring backup. For example, the command backup —sched on 00:00 -
w Sunday would schedule a backup to run every Sunday at midnight.
Restore enables you to rebuild a system quickly after it is on the network.As with backup,
you can restore a backup from a local ﬁle, a TFTP server, or an SCP server. Using restore
without any command-line switches presents you with a menu that will walk you through
the restore process, after you input the expert password.You will have the option to restore
the system conﬁguration and/or the Check Point conﬁguration. If you ﬁnd that the option
to restore the Check Point conﬁguration is not available, make sure that all the products
installed on the backed-up server (i.e., Reporter, SmartPortal, etc) are installed on the server
you’re trying to restore.
Snapshot, Revert, and Snapshot Image Management
The snapshot utility enables you to create a full image of your SecurePlatform machine.After
a snapshot is created, the Snapshot Image Management option is available at boot time.
To create a snapshot of your system, run the snapshot command and you will see an
interactive menu where you can create a new local image or save it to TFTP or SCP and
then proceed. It can take 20 minutes or more to create a snapshot.
An important difference between backup and snapshot is that in a backup, you only have
the conﬁguration ﬁles, whereas in a snapshot you have the entire contents of the disk.Also,
to perform a backup you only need to exit the SmartConsole, but all Check Point services
continue running. In a snapshot, all services stop (including the ﬁrewall and all trafﬁc
through it).You cannot schedule a snapshot.
The revert utility enables you to replace the current system state to a snapshot you cre-
ated earlier.To revert to a snapshot, run the revert command and you’ll see an interactive
menu the reverse of the snapshot menu.You can also access the Snapshot Image
Management option at the SecurePlatform bootup menu, as shown in Figure 8.9.You will
be prompted for the expert password, and then you can revert from a TFTP or SCP server.
It would be possible to format a new server, reboot, go into the Snapshot Image
Management section, and reimage the machine in less than 20 minutes total.
www.syngress.com
364
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Figure 8.9 Snapshot Image Management
Patch Add
Periodically, you might need to add or update packages.You can add packages from either
SmartUpdate or from the SecurePlatform command line. SmartUpdate is deﬁnitely the eas-
iest way to upgrade, but if you have a management station running SecurePlatform or do
not have a SmartUpdate license (which is included with a SmartCenter Pro license), you will
be required to upgrade from the command line.
You should always read the release notes before upgrading.You can upgrade using a CD,
a TFTP server, an SCP server, or ﬁles that you have copied over to the SecurePlatform
machine. For example, to install a patch from a CD, use patch add cd, and the OS will read
the CD and present a list of the available packages.To install a patch from a ﬁle on the local
system, simply use patch add <full_patch_path>.
Basics of Nokia Firewalls
Nokia offers multiple platforms ranging from the IP40 series for the SOHO environment to
the IP2200 series for carrier-class demands, as shown in Figure 8.10. One of the Nokia plat-
form’s key strengths is the use of a platform-independent OS and third-party applications,
called IPSO. Current versions of IPSO can be used across most platforms, with the excep-
tion of the IP40/IP45, which is directly related to Check Point’s VPN-1 Edge and therefore
outside the scope of this chapter. Nokia uses Check Point ﬁrewalls to provide ﬁrewall ser-
vices across all platforms, and they have the same behavior, the only difference being perfor-
mance and hardware features.Another of Nokia’s key strengths is the use of diskless
platforms. Most of the current offerings can run directly from industrial-grade, solid-state
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
365

Flash memory storage, thereby eliminating the use of spinning media for their operation.
This allows them to offer higher reliability and longer mean time before failure (MBTF).
Nokia is the only hardware vendor that offers diskless platforms for running Check Point
ﬁrewalls.
Figure 8.10 Nokia’s Current Firewall Appliances
Choosing the Right Platform
Since the smallest Nokia IP appliance offers at least three 10/100 Ethernet interfaces, it is
possible to design a DMZ solution with each appliance. In addition, Check Point FireWall-
1/VPN-1 functionality is enabled by the features of the license, not by the software package.
Since Check Point FireWall-1/VPN-1 is limited only by its license, it is important to choose
the correct platform for the intended environment. In the next section, we discuss the cur-
rent Nokia Platforms available and the environments in which they should be deployed.
Nokia IP260/265 Appliances
The IP260/265 appliances are rack-mountable, half-width 1RU platforms intended for the
small to medium-sized enterprise environment.They contain four embedded 10/100
Ethernet interfaces, on-board hardware encryption acceleration, and full IPSO IP routing
functionality. However, they are not expandable beyond the default conﬁguration.The IP260
is a standard disk-based platform; the IP265 is diskless. With a 250Mb throughput, they are
suitable for branch ofﬁces and small business.
www.syngress.com
366
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Nokia IP390 Appliances
The IP390 appliance, released around March 2006, is an extremely capable platform for
medium-sized to large companies. It ships with four embedded 10/100/1000 Ethernet inter-
faces, and there are two slots to add quad-port fast Ethernet cards or dual-port Gigabit Fiber
cards. With a throughput of up to 3Gbps in a 1RU form factor, the IP390 can handle
demanding environments at an affordable price. It is a diskless platform, although you can
add a hard drive for local logging and additional storage.
Nokia IP560 Appliances
The IP560 appliance was released in late 2005, and it brings performance to new levels for
the large enterprise. With a throughput of up to 6Gps, it can handle any job you throw at it
with ease. It ships with four embedded 10/100/1000 Ethernet interfaces, and there are three
slots to add quad-port Fast or Gigabit Ethernet cards or dual-port Gigabit Fiber cards. It is
also a diskless platform, although you can add a hard drive for local logging and additional
storage.
Nokia IP1220/1260 Appliances
The IP1220 and IP1260 are a carrier-class appliances, with a 2RU form factor and redun-
dant features.They ship with four embedded 10/100 Ethernet interfaces, and there are four
slots to add quad-port Fast or Gigabit Ethernet cards or dual-port Gigabit Ethernet or Fiber
cards. It has the option of being a disk-based, diskless, or diskless with hard drive platform.
The IP1260 includes redundant power supplies and mirrored disks; these features are options
for the IP1220.
Nokia IP2250 Appliances
The IP2250 is the top-of-the-line, carrier-class appliance from Nokia. It has a 3RU form
factor, redundant features, and hot-swappable options. It ships with four embedded 10/100
Ethernet interfaces and redundant power supplies.There are four slots to add quad-port
Gigabit Ethernet or Fiber cards, eight-port Fast Ethernet cards, or even a single-port
10GBase-SR interface card. It is a diskless platform, with Accelerated Data Path technology,
which incorporates trafﬁc decisions in processors installed directly on the network cards.
Discontinued Appliances
Like many other hardware vendors, Nokia has an end-of-sale (EOS) policy for its appliances.
Once an appliance is released, you can count on a minimum of a three-year sales life.
However, once EOS is announced, Nokia has a generous three-year support time frame,
during which the company supports and guarantees appliances under contract.After EOCS
(end of contracted support), you’re on your own. Many popular appliances are now EOS or
EOCS. Some of them are:
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
367

■
IP110/IP120/IP130 Small desktop-based appliances for running small ofﬁces, up
to around 100 users.They have a maximum throughput of 100Mbps and 3 10/100
Ethernet interfaces.The main difference among the IP110, IP120, and IP130 is
that they have 64Mb, 128Mb, and 256Mb of RAM, respectively.
■
IP330  A Nokia workhorse some ﬁve years ago, this 1U appliance has a max-
imum throughput of 100Mb, 256Mb of RAM, up to ﬁve 10/100 Ethernet inter-
faces, and the option of a modem or WAN interface.
■
IP350/IP355/IP380/IP385 Although not ofﬁcially EOS in the Americas, Nokia
will soon stop selling these great 1RU appliances.They have two slots for quad-
port 10/100 cards or dual-port Fiber cards.The 3x5 models are Flash based.
■
IP440 The most popular Nokia appliance ﬁve years ago. Very scalable, it could
have up to 16 10/100 interfaces or a variety of WAN interfaces.
■
IP530 A 2U appliance for the mid- to large enterprise. Had good performance,
Fiber card support, and good expansion capabilities.
■
IP650 An older 2RU appliance with features similar to those of the IP530, lower
performance, but with optional redundant power supplies and disks.
■
IP710/IP740 Carrier-class 3RU appliances, the ﬁrst that had Gigabit ﬁrewall
performance; it can have redundant power supplies and disks.
Nokia Appliance Comparisons
Table 8.1 lists all the platforms we’ve talked about and compares the most important features
among them.
Table 8.2 lists some of the appliances that are EOS or EOCS.
www.syngress.com
368
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Table 8.1 Currently Available Nokia Platform Speciﬁcations
IP260/
IP350/
IP1220/
IP265
IP380
IP390
IP560
IP1260
IP2250
Form factor
1 RU
1 RU
1 RU
1 RU
3 RU
3 RU
Maximum FW throughput
248Mbps/ 
350Mbps/ 
3Gbps
6Gbps
2.4Gbps/
7.5Gbps
227Mbps
1.5Gbps
4Gbps
Maximum 3DES 
112Mbps
130Mbps/
500Mpbs
1.7Gbps
1.19Gbps/
1.9Gbps
VPN throughput
313Mbps
1.49Gbps
Default memory conﬁguration 512Mb
256Mb/
1Gb
1Gb
1Gb
2Gb
1Gb
Maximum memory 
512Mb
512Mb/ 
2Gb
2Gb
2Gb
2Gb
conﬁguration
1Gb
Default # of 10/100 
4
4/4
0
0
4
4
Ethernet ports
Max # of 10/100 
4
12/12
8
16
20/20
36
Ethernet ports
Default # of 10/100/
0
0/2
4
4
0
0
1000 Ethernet ports
Max # of 10/100/1000 
0
4/4
8
16
8/8
8
Ethernet ports
Maximum connections 
5.5k/4.8k
16k/19k
30k
58k
39k/62k
99k
per second
Redundant power supply
N/A
N/A
N/A
N/A
Option/
Integrated
integrated
Flash-based (diskless)
IP265
IP355/385
Yes
Yes
Option
Yes
Mirrored disks
N/A
N/A
N/A
N/A
Option/
Integrated
integrated
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
369

Table 8.2 Nokia Appliances No Longer Available for Sale
IP120/
IP710/
IP130
IP330
IP440
IP530
IP650
IP740
Form factor
Desktop
1 RU
4 RU
2 RU
2 RU
3 RU
Maximum FW throughput
117Mbps/
130Mbps
236Mbps
460Mbps
317Mbps
1.3Gbps/
100Mbps
2Gbps
Maximum 3DES VPN 
30Mbps/
18Mbps
93Mbps
115Mbos
85Mbps
140Mbps
throughput (with 
3Mbps
accelerator, if available)
Default memory 
128Mb/
256Mb
128Mb
256Mb
256Mb
512Mb/1Gb 
conﬁguration
256Mb
Maximum memory 
128Mb/
256Mb
512Mb
1Gb
768Mb
1Gb
conﬁguration
256Mb
Default # of 10/100 
3
3
0
4
4
4
Ethernet ports
Max # of 10/100 
3
5
16
16
20
20
Ethernet ports
Default # of 10/100/1000 
0
0
0
0
0
0
Ethernet ports
Max # of 10/100/1000 
0
0
0
4
8
8
Ethernet ports
Redundant power supply
N/A
N/A
N/A
N/A
Option
Option/
integrated
Mirrored disks
N/A
N/A
N/A
Option
Option
Option/
integrated
www.syngress.com
370
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Nokia Support
Nokia’s support is among the ﬁnest in the industry.The company has top-notch personnel
who can assist in both Nokia and Check Point issues around the clock, with an excellent
response time. Even better, appliance issues and Check Point software issues can both be
handled by Nokia engineers.The company offers two support options, Essentials Support
and Access Support. Both include access to the latest Nokia software versions, access to the
company’s help knowledgebase, and advanced hardware replacement for appliances.Access
support allows customers to directly open cases with the Nokia TAC, whereas Essentials sup-
port is designed so that only authorized resellers can open cases on behalf of their customers.
It is highly recommended that you always have a valid support contract.You can ﬁnd more
information at http://support.nokia.com.
Conﬁguring the Nokia Appliance
The Nokia appliance arrives from the factory without conﬁguration but with the most
recent IPSO version and Check Point version installed.The initial conﬁguration is usually
done through the serial console port, and all Nokia appliances have a console port to con-
nect to for conﬁguration.They do not have display, keyboard, or mouse ports and so are
designed for unattended rack installation.
Initial Appliance Conﬁguration
The Nokia appliance arrives from the factory without conﬁguration.All Nokia appliances
have a console port to connect to for conﬁguration.The console cable, a standard RS232
null modem cable, is provided with the Nokia appliance. Using a terminal emulator pro-
gram, you can connect to the Nokia via a serial connection to begin the conﬁguration.The
terminal connection should be conﬁgured to use 9600 bits per second, 8 data bits, no parity,
1 stop bit, and no ﬂow control. If you use the HyperTerminal program, be sure to use the
latest, fully patched version; otherwise, it could activate the BIOS setup screen.
Once you have properly conﬁgured your terminal emulator and connected to the Nokia
appliance, turn on the machine.You will see the initial startup screen and are prompted to
enter a hostname for the appliance.You will also be prompted to choose and conﬁrm a pass-
word for the user admin, as shown here:
Please choose the host name for this system.
This name will be used
in messages and usually corresponds with one of the network hostnames
for the system.
Note that only letters, numbers, dashes, and dots (.)
are permitted in a hostname.
Hostname? panama
Hostname set to "panama", OK? [y]
Please enter password for user admin:
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
371

Please re-enter password for conﬁrmation:
Once you’ve chosen a password, you will be prompted to choose between using a
remote Web browser Voyager or using the CLI to conﬁgure the Nokia appliance, as shown
in the following example. Choose option 1 to use a remote Web browser. Choose option 2
if you do not have IP connectivity to conﬁgure the Nokia appliance.You may use either
Lynx or CLISH, depending on the IPSO version you have.You will then be prompted to
conﬁgure an interface for IP connectivity:
You can conﬁgure your system in two ways:
1) conﬁgure an interface and use our Web-based Voyager via a remote
browser
2) conﬁgure an interface by using the CLI
Please enter a choice [ 1-2, q ]: 1
Select an interface from the following for conﬁguration:
1) eth1
2) eth2
3) eth3
4) eth4
5) quit this menu
Enter choice [1-5]: 1
Enter the IP address to be used for eth1: 10.1.0.1/16
Do you wish to set the default route [ y ] ?
Enter the default router to use with eth1: 10.10.200.200
This interface is conﬁgured as 10 mbs by default.
Do you wish to conﬁgure this interface for 100 mbs [ n ] ? y
This interface is conﬁgured as half duplex by default.
Do you wish to conﬁgure this interface as full duplex [ n ] ? y
You have entered the following parameters for the eth1 interface:
IP address: 10.1.0.1
masklength: 16
www.syngress.com
372
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Default route: 10.10.200.200
Speed: 100M
Duplex: full
Is this information correct [ y ] ?
After this process, you will get a few more prompts and eventually reach a login prompt.
Then you can access the appliance via Voyager on a normal Web browser.
Nokia Voyager
The most common way of accessing and conﬁguring Nokia appliances is the Nokia Voyager.
Voyager is a complete Web-based interface that is installed with every IPSO installation,
accessible via either HTTP or HTTPS. In IPSO versions up to 3.9, Voyager had a frameless
Web interface and could also be accessed via a command-line utility called Lynx, essentially a
command-line browser. However, with IPSO 4.0 and later, Voyager has received a complete
overhaul and has become a frame-based interface incompatible with Lynx. In IPSO 4.0, the
left-hand frame contains a menu tree that expands and collapses to show different settings. In
IPSO 3.9, you would ﬁnd those settings by scrolling down the Web page, as shown in Figure
8.11. Once you ﬁnd the functions in either Voyager 3.9 or 4.0, they have very similar con-
ﬁguration options.
Figure 8.11 IPSO 3.9 and Earlier Voyager 
Voyager has two main sections, the conﬁguration and the monitor sections, as Figure
8.12 shows for IPSO 4.0. In the Conﬁguration section, you can change your passwords,
manage the ﬁrewall and other packages installed in your appliance, get a conﬁguration sum-
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
373

mary (useful to print and keep as a reference), and conﬁgure the following areas: interface,
system, high availability, routing, trafﬁc management, router services, IPv6, and asset informa-
tion. In the Monitor section, you can monitor a cluster, transparent mode groups, the for-
warding table, routes, and interfaces, and you can access sections for system utilization,
reports, health, logs, routing, hardware monitoring, and IPv6 monitoring.
Figure 8.12 IPSO 4.0 Voyager Sections
Designing & Planning…
Using Voyager
Voyager is a Web-based conﬁguration tool used to conﬁgure the Nokia appli-
ance. Voyager is intuitive and easy to use. We could go into each Voyager section
to show you how to conﬁgure the Nokia appliance, but doing so would occupy
too many pages for the purpose of this chapter. Instead, download the Voyager
Guide from Nokia’s support site at https://support.nokia.com for a full guide to
Voyager conﬁguration. For complex conﬁgurations, you can use CLISH to set up
the Nokia appliance.
www.syngress.com
374
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Using CLISH
Nokia introduced CLISH in IPSO 3.6 for IPSO conﬁguration, and in IPSO 4.0 it has taken
a predominant conﬁguration role through the command line. Remember, Lynx has been
eliminated from the regular distributions.
CLISH is a robust CLI that allows the administrator to deﬁne IPSO settings step by step
or automatically through the use of a text ﬁle. CLISH is extremely useful when you have
multiple appliances to conﬁgure.The syntax for the commands is the same whether they are
input manually or through the use of a text ﬁle.To manually input the settings one by one,
invoke CLISH by typing clish.To have CLISH read the input automatically from a text ﬁle,
invoke the following command. In this case, the –s ﬂag saves the conﬁguration:
Nokia[admin]#clish –f <ﬁlename> -s.
Here are some other common commands and their uses.To conﬁgure the default
gateway, use this command:
Nokia>set static-route default nexthop gateway address 205.226.27.2 
priority 1 on 
To conﬁgure a static route, use the following command:
Nokia>set static-route 10.254.253.0/24 nexthop gateway address 10.254.254.2
priority 1 on  
To conﬁgure an interface’s physical settings, use this command:
Nokia>set interface eth-s2p1 auto-advertise on duplex full speed 10M
active on link-recog-delay 6
To conﬁgure an interface’s logical settings, use these commands:
Nokia>add interface eth-s2p1c0 address 10.254.254.1/24
Nokia>set interface eth-s2p1c0 enable
To conﬁgure a proxy ARP entry, use the following command:
Nokia>add arpproxy address 10.254.254.152 interface eth-s2p1c0
Developing a standard template is very useful if you want to plan ahead and conﬁgure
the Nokia appliances.A standard template is also very helpful if you conﬁgure Nokia appli-
ances on a consistent basis.You will save conﬁguration time by having the settings read into
IPSO.You may use the pound sign (#) to insert comments. CLISH will not read the text
preceding the # as conﬁguration lines.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
375

Here is a sample template ﬁle:
#Set Default gateway
set static-route default nexthop gateway address a.b.c.d priority X on  
#Set Physical Interface
set interface eth-sXpX auto-advertise on duplex full speed XM active on link-
recog-delay X
#Set Logical interface
add interface eth-sXpXcX address a.b.c.d/x
set interface eth-sXpXcX enable
#Set Static route
set static-route a.b.c.d/x nexthop gateway address a.b.c.d priority X on
#Set Proxy ARP
add arpproxy address a.b.c.d interface eth-sXpXcX
For more information or additional command syntax, consult the Command Line
Reference Guide for IPSO, available for download at https://support.nokia.com.
Time Constraints
Know how much time you have to implement the solution.You should have a pretty good
idea of how much time is needed to implement your solution. Unfortunately, sometimes
things do not go smoothly, and you will need to allocate time for troubleshooting.
Estimate your time window to complete the project, and add some time for trou-
bleshooting if something goes wrong.
You should also have an emergency backup plan in case the solution cannot be imple-
mented in the time frame allocated.This is especially important when you’re integrating a
DMZ into an existing production environment. It is very easy to back out from changes
in IPSO. Before you begin configuring an existing environment, you should back up the
current configuration using Voyager.You can do so using the Configuration | System
Configuration | Backup and Restore functions, and be sure to back up the System
and Check Point settings.You may then restore to your original configuration at any
time.
www.syngress.com
376
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Operating System and Software Installation
The Nokia appliance comes preinstalled with IPSO and partner applications, including
Check Point. However, it is not guaranteed that the latest software binaries are installed.The
latest IPSO versions are available at http://support.nokia.com.All Check Point binaries must
be obtained from Check Point’s Web site. Keep in mind that you must have a separate valid
logon and software subscription for each site.
Using Voyager
Choose Conﬁg | System Conﬁguration Section | Install New IPSO Image in IPSO
3.9 or Conﬁguration | System Conﬁguration | Images | Upgrade Image in IPSO
4.0 to upgrade the IPSO operating system. Choose Conﬁg | System Conﬁguration
Section | Manage Installed Packages | FTP and Install Packages in IPSO 3.9 or
Conﬁguration | System Conﬁguration | Packages | Manage Packages to upgrade
or install third-party applications (i.e. Check Point). However, we recommend using the
command-line interface for both, since they provide more feedback about the process and
are not subject to timeouts that a browser could have.
Command-Line Installation of IPSO images
New IPSO images should be obtained from Nokia.These images are usually called ipso.tgz,
but you should probably rename them to something like ipsoX.XbYY, to indicate the major
IPSO version and the build version—for example, ipso39b45.tgz.Transfer the image to the
appliance via SCP or FTP and then use the newimage command, as shown in Figure 8.13.
The –l switch indicates that a locally stored image will be used, whereas the –k switch
prevents the image installation from deactivating the currently active packages. Once the
image is installed, go to Conﬁguration | System Conﬁguration | Images | Manage
Images, select the image to be used, and reboot.You can also Test Boot, which will reboot
the machine, but if the new image is not conﬁrmed within a set amount of time, the plat-
form will reboot with the previous image.
The newimage command carries over the settings from the previous IPSO installation,
unless it’s an unsupported downgrade (check the release notes).To return a Nokia appliance
to factory default settings, remove the /conﬁg/active link using the command rm
/conﬁg/active at the command prompt and reboot the appliance. Use this command with cau-
tion because you will lose your settings on reboot.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
377

Figure 8.13 IPSO newimage Command
Installing the Check Point Software
Use the newpkg command to install a third-party partner application. In this case you should
have ready a Check Point package, usually called IPSO_wrapper_Rxx.tgz.Transfer the
package to the appliance via SCP or FPT, and run newpkg as shown in Figure 8.14.The –m
LOCAL switch indicates that the package is installed locally, and the –n switch indicates
which package to install. Use the –o switch to indicate that an upgrade from a previous ver-
sion should be made—for example, –o $FWDIR.
Figure 8.14 IPSO newpkg Command
Once you install the Check Point package, you have to log out and then log in so that
you can conﬁgure the package initially with cpconﬁg. Since most Nokia appliances are used as
security gateways, Figure 8.15 shows a sample initial cpconﬁg with the appropriate answers.
www.syngress.com
378
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

Figure 8.15 Initial cpconﬁg on Nokia Platforms
Using cpconﬁg
Once you have an installation of Check Point on your preferred operating system, you need
to do some basic conﬁguration to enable the graphical user interface (SmartConsole) to
work.This is done through the cpconﬁg utility, which you will also use for adjustments after
the initial conﬁguration.The options available in cpconﬁg for SmartCenters and security gate-
ways are different.
Common options that can be conﬁgured on cpconﬁg include these:
■
Licenses Check https://usercenter.checkpoint.com/pub/usercenter/faq.html for
licensing information in the Check Point UserCenter.
■
SNMP extensions  Use it to start the Check Point daemon so that SNMP tools
can query the ﬁrewall.
■
Random pool  Used in various cryptographic operations.
Using cpconﬁg on SmartCenters
On SmartCenters, the cpconﬁg options are those shown in Figure 8.16.
The options include:
■
Administrator This will be a user who can connect to the SmartConsole and
conﬁgure the ﬁrewall through the GUI. In NGX, you can deﬁne only one
Administrator in cpconﬁg; the others are conﬁgured in SmartDashboard.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
379

Figure 8.16 Using cpconﬁg on SmartCenters
■
GUI Clients  This is a list of IPs from which Administrators can connect to the
SmartConsole. If you select speciﬁc IPs, implied rules will be created to allow
access from those locations. If you select networks, hostnames, or Any, you will
need to create rules that allow the CPMI service from those locations.
■
Certiﬁcate Authority Use this option to change the name used for the certiﬁ-
cate authority.You normally shouldn’t need to do this.
■
Certiﬁcate’s Fingerprint  Use this option to view or save the ﬁngerprint of the
certiﬁcate used by the management so that you can compare it to the one pre-
sented by the SmartConsole for authentication purposes.
Using cpconﬁg on Security Gateways
On security gateways, the cpconﬁg options are those shown in Figure 8.17.
Figure 8.17 Using cpconﬁg on Security Gateways
www.syngress.com
380
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls

The options include:
■
Group Permissions Used to select an OS group that can run the ﬁrewall ser-
vices.You don’t need to modify this option.
■
PKCS#11 Token Used to select a PKCS#11 token that the gateway can use.
■
Secure Internal Communication  Used to change the SIC and reset the acti-
vation key the SmartCenter uses to take control of the gateway. If you change this
setting, the security policy will be disabled and the gateway will wait for a
SmartCenter to contact it and establish SIC.
■
Disable (or Enable) cluster membership for this gateway Depending on
whether or not the gateway will be part of the cluster, select or deselect this option.
■
Enable (or Disable) Check Point SecureXL Enables (or disables) the software
acceleration provided by SecureXL, which requires a separate license unless you’re
using the VPN-1 Power gateways that now include it.
■
Automatic start of Check Point products Use this option to select the prod-
ucts that will start automatically with the gateway. Normally you don’t need to
change this setting.
Nokia Firewall 
and DMZ Design Checklist
Here is a sample checklist for planning your Nokia DMZ:
■
Know what the DMZ will be used for.
■
Read your corporate security policy dealing with DMZs.
■
Have an accurate network diagram.
■
Know how sensitive the internal network is.
■
Select the proper DMZ to implement based on your corporate security policy.
■
Develop a proper backup procedure.
■
Set a reasonable time frame to implement the solution and include time to trou-
bleshoot.
■
Select the appropriate operating system or appliance for your needs.
■
Decide on a standalone or distributed conﬁguration.
■
Always keep backups of current conﬁgurations with a maintenance schedule.
■
The wizards guide you through the initial conﬁguration.
■
Use cpconﬁg to change options you need at a later time.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
381

Summary
Check Point ﬁrewalls can be run on many platforms. SecurePlatform and Nokia ﬁrewalls are
very secure and easy to use in implementing a DMZ solution. Check Point’s SecurePlatform
and Nokia’s IPSO operating systems are highly secured OSs optimized to forward trafﬁc and
for ﬁrewall duties. In addition, their wide range of conﬁguration tools makes them a very
strong solution.
SecurePlatform is based on Linux and comes with the standard Check Point media kit.
You can install SPLAT in an Intel- or AMD-based box in less than 20 minutes and conﬁgure
it using all the provided wizards. Even if your security gateway runs on dedicated Nokia
appliances, using SecurePlatform for a SmartCenter is a popular and intelligent choice. OS
maintenance is handled through Check Point’s hotﬁxes, and it has robust backup and restore
functionality in case disaster recovery is needed.
IPSO is based on FreeBSD and is included on all Nokia IP appliances starting with the
IP100 series.At the low end, the IP260 offers 250Mb of ﬁrewall throughput, whereas the
IP2255 can offer 7.5Gb of throughput.These appliances are rock-solid and the only ones
that can run Check Point in a diskless environment.Their support is among the best in the
industry and highly recommended. Nokias also have robust backup and restore features for
speedy disaster recovery.
Finally, it is important to remember that integrating DMZs and ﬁrewalls into your net-
works is only part of the whole security solution.Active log auditing, integrating intrusion
detection devices, authentication, and security awareness training are some of the other inte-
gral components of corporate information management security.
Solutions Fast Track
Basics of SecurePlatform Firewalls

SecurePlatform is a Linux-based operating system created by Check Point. It has
been hardened and does not require an additional license for its use.

Check Point has been doing all its research and development on SecurePlatform,
with other operating systems being done later.

There are basically two hardware options if you decide to use a SecurePlatform
system: dedicated appliances or open systems.

To install SecurePlatform, use CD 1 of the Check Point Media Kit and power on
your machine.
www.syngress.com
382
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls


The default username and password are admin and admin. Once logged in, you
must change your password to a strong password, and optionally change the
username.

The ﬁrst thing you should do is use sysconﬁg, which will show the Welcome
Wizard and help you conﬁgure the system.

SecurePlatform has robust maintenance features, including Backup/Restore and
Snapshot/Revert.
Basics of Nokia Firewalls

The Nokia platform comes from the factory without conﬁguration.The initial
conﬁguration must be done via local console access only.

The Nokia platform can be managed via a console using a console cable provided
by Nokia or by remote dial-in using an external modem or a PCMCIA modem.

The Nokia platform can be remotely managed via SSH,Telnet, HTTP, or HTTPS.
These settings are conﬁgured in Voyager. Refer to the Voyager Reference Guide for
details on conﬁguration.

CLISH is the command-line interface shell for IPSO conﬁguration.

The newimage –i command is used to upgrade your IPSO operating system.

The newpkg command upgrades or installs third-party applications.

The Nokia appliance might not arrive with the latest software installed.Always
check the Nokia and Check Point Web sites for the latest available software.
Using cpconﬁg

Once you have an installation of Check Point, you need to use cpconﬁg to make
basic conﬁgurations that enable the use of the graphical user interface
(SmartConsole).

The options available in cpconﬁg for SmartCenters and security gateways are
different.

Common options include licenses and SNMP extensions.

On SmartCenters, options include administrator, GUI client, and certiﬁcate
authority.

On security gateways, options include secure internal communications, cluster
membership, and SecureXL.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
383

Q: What is an ideal setup for my Check Point DMZ system in terms of installation and
gateways?
A: You should always try to have a distributed installation, where the SmartCenter is sepa-
rate from the security gateway.This type of installation has performance, security, and
disaster recovery beneﬁts. For the SmartCenter, SecurePlatform is by far the best choice
available. For security gateways, dedicated appliances like Nokia have signiﬁcant advan-
tages, especially regarding hardware replacement and support options.
Q: Does Nokia and/or SecurePlatform support the use of 802.1q VLANs?
A: Yes, both support 802.1q VLAN conﬁgurations.As a matter of fact, this conﬁguration is
recommended over multihoming an interface, since Check Point sees each logical inter-
face as a separate interface.This creates a cleaner interaction with Check Point when
you’re dealing with antispooﬁng issues.
Q: I want to use one of Nokia’s high-availability solutions, VRRP or IP clustering. Will I
have to conﬁgure anything differently?
A: The basic principles and conﬁguration still apply. If you are using high availability, you
must create a gateway cluster in your Check Point-1 conﬁguration. If you are using
Check Point Sync to synchronize the state tables, you will lose one interface per Nokia
as the dedicated sync interface. If you are using Nokia IP Clustering, you will lose
another dedicated interface to IP Clustering Sync in addition to the Check Point sync
interface. Plan ahead for your hardware requirements and choose the right platform.
Q: Does Check Point support port forwarding with its external IP address?
A: Check Point fully supports this functionality.This is another conﬁguration of Static Port
NAT where it takes advantage of the fact that the ﬁrewall is not listening on some ports,
such as Port 80 for Web services. Since it is not used, some vendors allow the listening
port to be used by an internal host on the DMZ.
www.syngress.com
384
Chapter 8 • Firewall and DMZ Design: Secure Platform and Nokia Firewalls
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

Q: Does Check Point support other network protocols, such as IPX or AppleTalk?
A: No, Check Point supports only TCP/IP.
Q: What routing protocols does IPSO support?
A: IPSO supports static routing, RIP (versions 1 and 2), OSPF, IGRP, and BGP.You must
conﬁgure Check Point security rules to accept this trafﬁc.
Q: What routing protocols does SecurePlatform support?
A: SecurePlatform supports static routing only. With SecurePlatform Pro, it supports RIP
(versions 1 and 2), OSPF, and BGP.
Q: How often do I need to interact with the operating system?
A: You will need to conﬁgure the operating system for changing interfaces and routes (and
then get the topology in the GUI), rebooting the appliance, using cpconﬁg, reestablishing
the SIC, and making backups.All other ﬁrewall conﬁguration is done through the
SmartConsole.
www.syngress.com
Firewall and DMZ Design: Secure Platform and Nokia Firewalls • Chapter 8
385


Firewall and 
DMZ Design:
Juniper NetScreen
Solutions in this Chapter
■
NetScreen Basics
■
Securely Managing Juniper NetScreen
Firewalls
■
NetScreen Conﬁguration Basics
Chapter 9
387
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
The Juniper NetScreen ﬁrewall helps implement solutions such as virtual systems, virtual
routers, and zones that help you design, conﬁgure, and manage your enterprise DMZ.These
solutions provide you with granular control over your network’s security and help effectively
identify DMZ boundaries.With this architecture, you can achieve optimal design, high secu-
rity, and performance.This chapter introduces you to the solutions and the product range of
Juniper’s NetScreen and provides a brief summary of their technical speciﬁcations and features.
NetScreen Basics
Juniper Networks’ premier security platform is the NetScreen ﬁrewall product line.The
product line provides integrated ﬁrewall and IPSec virtual private network (VPN) solutions
in a single appliance.The core of a NetScreen ﬁrewall is based on the stateful inspection
technology, which provides a connection-oriented security model that veriﬁes the validity of
every connection while still providing high-performance architecture.The NetScreen ﬁre-
walls are based on a custom-built architecture consisting of the Application-Speciﬁc
Integrated Circuit (ASIC) technology.ASIC is designed to perform a speciﬁc task and to do
that task at a higher performance level than a general-purpose processor.ASIC connects over
a high-speed bus interface to the core processor of the ﬁrewall unit, a Reduced Instruction
Set Computer (RISC) CPU.
The ﬁrewall platform also contains additional technologies to increase your network’s
security. NetScreen products support deep inspection, which allows you to inspect trafﬁc at
the application level to detect application-level attacks.This can help prevent the next attack
on your Web servers, or deter someone trying to send illegal commands to your SMTP
server.The deep inspection technology uses a frequently updated database and provides the
ability to create your own regular expression-based signatures.
The Juniper NetScreen Security Solution
Juniper NetScreen Security solution includes ﬁrewalls, intrusion detection and prevention
(IDP), the Secure Sockets Layer (SSL) VPN appliance, and security management software. In
line with this discussion we will see how to implement the Juniper NetScreen-based DMZ
for an enterprise network. We will discuss the products and features, the methods to manage
NetScreen ﬁrewalls and conﬁgure interfaces, routing and policies, and NetScreen’s advanced
features, such as high availability, virtual systems, and content ﬁltering.
Juniper NetScreen Versions and Features
The ﬁrewall product line has several tiers of appliances and systems.The newest range of
Integrated Security Gateway (ISG) from Juniper offers ﬁrewall, VPN, and IDP. Juniper also
offers a SSL VPN product under the product line known as Secure Access.The Secure
www.syngress.com
388
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Access series offers a clientless remote access solution and a collaboration tool.The SSL VPN
product line also includes the Secure Meeting application, enabling online collaborative
meetings in which users can share their desktops and engage in instant messaging. Juniper’s
IDP prevents malicious trafﬁc from residing on the network, compared to some products
that only detect incoming trafﬁc.
Juniper NetScreen Firewalls
The following is a quick review of all the products in the current NetScreen product line—
from low-end appliances to high-end systems. Later in this section, we review the enterprise
management options that Juniper Networks offers.
NetScreen 5XT and NetScreen 5GT
The NetScreen-5 series is designed for small ofﬁces, remote ofﬁces, and distributed
enterprise networks. NetScreen-5GT ships in several versions: 5-GT 10-user and Plus,
5-GT ADSL 10-user and Plus, and 5-GT Wireless 10-user and Plus. NetScreen-5XT is
available in 10-user and Elite versions.The Plus versions offer unrestricted IP addresses
support.Table 9.1 summarizes the versions of NetScreen-5 series and their features.
Table 9.1 NetScreen-5 Series Feature Summary
5-GT ADSL
5-GT 10-
10-User 
5-GT 
5-XT 10-User 
Features
User and Plus
and Plus
Wireless Plus
and Elite
Interfaces
5 x 10/100 
5 x 10/100 
5 x 10/100 
5 x 10/100 
Ethernet 
Ethernet + 1
Ethernet + 1
ADSL 
802.11 b/g 
Wireless Radio
Ethernet 
Users
10 or 
10 or 
10 or 
10 or 
unrestricted 
unrestricted 
unrestricted 
unrestricted 
Firewall 
75Mbps 
75Mbps 
75Mbps 
70Mbps 
throughput
3DES VPN 
20Mbps 
20Mbps 
20Mbps
20Mbps 
throughput
Concurrent 
2000
2000 
2000 
2000 
sessions
VPN tunnels
10 
10 
10 
10 
Maximum 
100 
100 
100 
100 
policies
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
389
Continued

Table 9.1 continued NetScreen-5 Series Feature Summary
5-GT ADSL
5-GT 10-
10-User 
5-GT 
5-XT 10-User 
Features
User and Plus
and Plus
Wireless Plus
and Elite
Security zones 2 (trusted and 
2 (trusted and 
4 
2 (trusted and 
untrusted), 
untrusted), 
untrusted), sup-
support for 3 
support for 3 
port for 3 security 
security zones 
security zones 
zones when 
when conﬁgured when conﬁgured
conﬁgured in 
in Home/Work
in Home/Work 
Home/Work mode
mode
mode
Virtual routers 3 
3 
3 
3 
Additionally, the 5-GT products have embedded antivirus and antispam support, which
the 5-XT products lack.
NetScreen-25 and NetScreen-50
The NetScreen-25 and NetScreen-50 series are designed for remote ofﬁces, small to
medium-sized companies, and enterprise branch ofﬁces.Table 9.2 summarizes the features of
NetScreen-25 and NetScreen-50.
Table 9.2 NetScreen-25 and NetsScreen-50 Feature Summary
Features
NetScreen-25
NetScreen-50
Interfaces
4 x 10/100 Ethernet 
4 x 10/100 Ethernet 
interfaces
interfaces
Users
Unrestricted number of IP 
Unrestricted number of IP 
addresses in Trusted 
addresses in Trusted 
interfaces
interfaces
Firewall throughput
100Mbps 
170Mbps 
3DES VPN throughput
20Mbps 
45Mbps 
Concurrent sessions
32,000 
64,000 
VPN tunnels
125
500 
Maximum policies
500 
1000 
VLANs
16 
16 
Security zones
4 
4 
Virtual router
3 
3 
www.syngress.com
390
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen
Continued

Table 9.2 continued NetScreen-25 and NetsScreen-50 Feature Summary
Features
NetScreen-25
NetScreen-50
Routing protocol
OSPF, BG, RIPv1/v2 routing 
OSPF, BG, RIPv1/v2 routing 
protocols support
protocols support
High availability (HA)
High availability through 
High availability mode: 
HA Lite
Active or Passive
Both NetScreen 25 and NetScreen 50 are available in basic versions that offer fewer ses-
sions and VPN tunnels.These models also do not support VLANs and OSPF or BGP. Only
HA Lite is supported for high availability. HA Lite relies on conﬁguration synchronization
only and does not provide tunnel and session synchronization.
NetScreen-204 and NetScreen-208
NetScreen-204 and NetScreen-208 are designed for medium-sized to large enterprises.Table
9.3 summarizes the features of NetScreen-200.
Table 9.3 The NetScreen-200 Series Feature Summary
Features
NetScreen-204
NetScreen-208
Interfaces
NetScreen-204: 4 x 10/100
NetScreen-204: 4 x 10/100 
Ethernet interfaces
Ethernet interfaces
Users
Unrestricted number if IP 
Unrestricted number if IP 
addresses are in Trusted 
addresses are in Trusted 
interfaces
interfaces
Firewall throughput
375Mbps
375Mbps 
3DES VPN throughput
175Mbps 
175Mbps 
Concurrent sessions
128,000 
128,000 
VPN tunnels
1000
1000 
Maximum policies
4000 
4000 
VLANs
32 default VLANs  (can 
32 default VLANs  (can scale 
scale up to 96) 
up to 96) 
Security zones
4—can be up to 10
8—can up to 10
Virtual router
3—can be up to 5
3—can be up to 5
Routing protocol
OSPF, BG, RIPv1/v2 routing 
OSPF, BG, RIPv1/v2 routing 
protocols support
protocols support
High Availability
Active/Passive, Active/Active
Active/Passive, Active/Active,
Active/Active Full Mesh
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
391

Both NetScreen-204 and NetScreen-208 are available in basic versions.These versions
have only 64,000 sessions and 500 VPN tunnels and support only RIPv1/v2 and
Active/Passive high-availability options.These versions cost less than the advanced models.
NetScreen Security Manager (NSM) can conﬁgure and manage all these appliances.
NetScreen-500
NetScreen-500 ships in two models: NetScreen-500 and NetScreen-500 General Packet
Radio Services (GPRS). Refer to Table 9.4 for the feature summary of NetScreen-500.
Please refer to the datasheet on the Juniper Web site for NetScreen-500 GPRS features.
Table 9.4 NetScreen-500 Feature Summary
Features
NetScreen-500
Slots
4 
Interfaces
8 x 10/100 Ethernet interfaces, 8 Mini-GBIC or 4 GBIC
Users
Unrestricted number if IP addresses in Trusted interfaces
Firewall throughput
700Mbps  
3DES VPN throughput
250Mbps  
Concurrent sessions
250,000  
VPN tunnels
5000 site-to-site VPN tunnels
10,000 remote-user (dial-up) VPN tunnels
Maximum policies
20,000  
Virtual systems (VSYS)
Up to 25 virtual systems (by default you get 0 VSYS)
VLANs
100 default VLANs  
Security zones
8 security zones (can go up to 50)
Virtual routers
2 virtual routers (can go up to 25)
Routing protocols
OSPF, BG, RIPv1/v2 routing protocols support
High Availability
High-availability modes: Active/Passive, Active/Active,
Active/Active Full Mesh
The basic version of NetScreen-500 offers 128,000 sessions, 1000 VPN tunnels, RIP-
only support, and Active/Passive high-availability mode.
NetScreen-5200 and NetScreen-5400
NetScreen-5200 and NetScreen 5400 are designed for large enterprises, Internet service
providers (ISPs), and data centers.This is a high-end, high-performance offering from
NetScreen.Table 9.5 summarizes the features of the NetScreen-5000 series.
www.syngress.com
392
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Table 9.5 NetScreen 5000 Series Feature Summary
Features
NetScreen-5200
NetScreen-5400
Slots
2 
4 
Interfaces
2 x Fast Ethernet, 10GigE 
6 x Fast Ethernet, 10GigE or 24 
or 8 Mini-GBIC or 2 Mini-
Mini-GBIC or 6 Mini-GBIC + 72 
GBIC + 24 x 10/100 
x 10/100 Ethernet interfaces
Ethernet interfaces
Users
Unrestricted number of IP 
Unrestricted number of IP 
addresses in Trusted interfaces addresses in Trusted interfaces
Firewall throughput
10Gbps 
30Gbps  
3DES VPN throughput 5Gbps  
15Gbps  
Concurrent sessions
1,000,000  
1,000,000  
VPN tunnels
25,000  
25,000  
Maximum policies
40,000  
40,000  
Security zones
Default 16 (up to 1000)
Default 16 (up to 1000)
Virtual routers
3 (up to 500)
3 (up to 500)
Routing protocols
OSPF, BG, RIPv1/v2 routing 
OSPF, BG, RIPv1/v2 routing 
protocols support
protocols support
High availability
High-availability mode: 
High-availability mode: 
Active/Passive, Active/Active,
Active/Passive, Active/Active, 
Active/Active Full Mesh
Active/Active Full Mesh
The Juniper NetScreen ISG Series
The ISG series includes linear ﬁrewall and IPSec VPN performance and provides integrated
ﬁrewall, VPN, and intrusion detection and prevention functionalities.Table 9.6 summarizes
the NetScreen ISG features.
Table 9.6 NetScreen ISG Series Feature Summary
Features
NetScreen ISG 1000
NetScreen ISG 2000
Interfaces
4 x ﬁxed 10/100/1000 plus 
Up to 8 x Mini-GBIC (SX or 
up to 4 x Mini GBIC (SX or 
LX), or up to 28 x 10/100
LX), or up to 8 x 10/100/
1000, or up to 20 x 10/100
Users
Unrestricted number of IP 
Unrestricted number of IP 
addresses in Trusted interfaces addresses in Trusted interfaces
Firewall throughput
1Gbps 
4Gbps  
3DES VPN throughput
1Gbps 
2Gbps  
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
393
Continued

Table 9.6 NetScreen ISG Series Feature Summary
Features
NetScreen ISG 1000
NetScreen ISG 2000
Concurrent sessions
250,000  
512,000  
VPN tunnels
2000  
10,000  
Maximum policies
10,000  
30,000  
Virtual systems
0 to 10  
0 to 50  
VLANs
250  
500  
Security zones
20 default (up to 40)
26 default (up to additional
100)
Virtual routers
3 (up to 10)
3 (up to additional 50)
Routing protocol
OSPF, BG, RIPv1/v2 
OSPF, BG, RIPv1/v2  
High Availability
High-availability mode: 
High-availability mode: 
Active/Passive, Active/Active,
Active/Passive, Active/Active, 
Active/Active Full Mesh
Active/Active Full Mesh
IDP upgrade
Optional upgrade kit for 
Optional upgrade kit for 
Integrated IDP
Integrated IDP
In its basic edition, ISG-1000 offers 125,000 sessions, 1000 VPN tunnels, 50 VLANs,
and RIP only and Active/Passive high-availability mode. ISG 2000 in its baseline edition
provides 256,000 sessions, 1000 VPN tunnels, 100 VLANs, and RIP only and Active/Passive
high-availability mode.
Juniper NetScreen Firewall Software
In the core of the Juniper NetScreen ﬁrewall is ScreenOS. In this section, we look at
ScreenOS architecture, functions, and licensing options.
ScreenOS
ScreenOS, the operating system (OS) for NetScreen ﬁrewall, provides services such as
dynamic routing, high availability, and management and virtualizes a single device into mul-
tiple virtual devices.This OS is designed as a real-time operating system (RTOS), which can
respond to external world events in a time frame deﬁned by the external world. On an
RTOS CPU, performance is a concern because only one task can run at a time.Therefore,
the idea is to minimize the time it takes to set up the CPU and begin executing a task.
Another challenge for RTOS is memory allocation.Allocating this memory takes time and
can slow down the OS while it’s executing a task.As a result, ScreenOS preallocates memory
to ensure that there is enough memory available to provide a sustained rate of service.
ScreenOS is more secure than open source operating systems because the general public
cannot review the source code for vulnerabilities. ScreenOS also does not have the security
www.syngress.com
394
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

exposure of Microsoft Windows.As a result, ScreenOS is exposed to fewer people, denying
them a chance to learn about the OS or possible exploits for it.
Today’s ﬁrewalls have to provide much more than just the regular Layer 3 and Layer 4
inspection. Filtering your ports, protocols, and IP addresses might not provide the security
necessary for preventing sophisticated attacks.You need the ability to scan the packet for spe-
ciﬁc threats to the data. Deep inspection technology is the next step in the evolution of ﬁre-
walls. Deep inspection allows you to inspect trafﬁc at the application layer, relying on regular
expressions (regex) to determine what content in a packet is malicious. For example, a virus
spreading on the Internet attempts to exploit your Internet Information Server (IIS) vulner-
abilities by sending a speciﬁc string of characters to your Web server.To identify this string,
you can write a custom signature.You can then apply the custom signature to a policy to
inspect the trafﬁc in the policy for that speciﬁc string. Deep inspection implemented
through ScreenOS is truly a jump in terms of evolution for the ﬁrewall.
Screen OS Licensing
ScreenOS licensing is a simple process. Every appliance comes with a serial number that you
need to register at the Juniper licensing site. In addition, you need to enter into the support
contract so that you get access to downloads, upgrades, and updates for your appliance.A
valid support contract also ensures that you get telephone and e-mail support. Most impor-
tant, your system’s defense mechanisms are up to date.
You also need licenses for additional services such as content management (URL ﬁl-
tering or antivirus add-ons).You might have to buy additional virtual systems if they’re
required for your networks. We will learn about virtual systems and their beneﬁts in a later
section.You can upgrade entry-level appliances that come with 10-user support to unre-
stricted versions by buying additional upgrade licenses.
From the WebUI (introduced later in this chapter), go to Conﬁguration | Update |
ScreenOS/Keys to see the licensing information applicable on your appliance.The following
is the licensing information of the NetScreen 208 used for the exercises in this chapter:
Model:
Baseline
Sessions:
64064 sessions
Capacity:
unlimited number of users
NSRP:
ActivePassive
VPN tunnels:
500 tunnels
Vsys:
None
Vrouters:
3 virtual routers
Zones:
15 zones
VLANs:
0 vlans
Drp:
Disable
Deep Inspection:
Disable
Deep Inspection Database Expire Date: Disable
AV:
Enable
Url Filtering:
Disable
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
395

Securely Managing 
Juniper NetScreen Firewalls
The ﬁrst step to implementing NetScreen ﬁrewall security is learning how to manage it.
Every NetScreen management utility centers around two types: the Web user interface
(WebUI) and the command-line interface (CLI).There is a third type of management, an
enterprise class of security, called the NetScreen Security Manager (NSM). WebUI and CLI
are a requirement for managing the NetScreen ﬁrewall.
Each management utility has a few strengths and weaknesses, and you should not imple-
ment only one utility. Instead, you should take advantage of the range that NetScreen offers
and use multiple conﬁgurations. For each type of utility, there is a different way to update
ScreenOS, and some options may be more effective than other options.
Finally, it is critical that only authorized administrators have authentication rights and
access to use these utilities to manage your ﬁrewall’s conﬁguration. NetScreen management
utilities are console, Secure Shell (SSH), Web interface, and NetScreen Security Manager.
Console
The serial console is a nine-pin female serial connection.This option gives CLI access to the
ﬁrewall.The console is used to initially connect to your device and to conduct out-of-band
management. Out-of-band management is management that is not network-based, such as
access via a modem.A serial console provides you with certain beneﬁts that you do not get
from using any other type of connection.The console provides a secure, physical, and dedi-
cated access. Network connectivity issues cannot interrupt this connection, and no one can
intercept your management trafﬁc. It is completely secure because of its direct connection to
the device.
When conﬁguring the ﬁrewall over a serial port, you do not use network connectivity.
As a result, using the serial console is an excellent option when you need to change Internet
Protocol (IP) addressing on the ﬁrewall and guarantee connectivity. Only the serial console
lets you view and interact with the booting process.This cannot be accomplished remotely
because the OS has not started and it is unable to provide management services. Many
devices, such as Unix-type servers and other embedded devices, use serial consoles to pro-
vide serial console management. On the NetScreen 5XP/5GT/5XP and NetScreen-500, use
a DB9 female to DB9 male straight through serial cable to connect for console management.
On the NetScreen 25/50/204/208/ISG 2000/5200/5400, use an RJ-45 serial cable with a
DB9 female connector.Table 9.7 outlines the settings for connecting with a serial terminal
or serial terminal emulator.
www.syngress.com
396
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Table 9.7 The Serial Terminal Settings
Setting
Value
Speed
9600 bps
Character Size
8 bit
Parity
None
Stop Bit
1
Flow Control
None
SSH
Another form of command-line management is Secure Shell, or SSH. Like Telnet, SSH is a
remote command-line utility, but without Telnet’s security concerns. SSH provides an
encrypted command-line session to the NetScreen ﬁrewall. It also provides protection from
IP spooﬁng and Domain Name Service (DNS) spooﬁng attacks. SSH has two versions, v1
and v2.The versions are not backward-compatible. Version two is considered more popular
because of its higher level of security.You require an SSH client that is compatible with the
version of SSH you are using. Many UNIX-based operating systems include clients, but
Windows-based operating systems do not.You can use a client named putty for Windows. It
is free and easy to use.You can download it from
www.chiark.greenend.org.uk/~sgtatham/putty/download.html.
WebUI
WebUI is the easiest management utility to use. Because of its simple point-and-click
options, it gives the end user a jump-start into managing the NetScreen ﬁrewall.You can see
in Figure 9.1 that the interface is simple. On the left side of the browser is the menu column
that lets you choose from the various conﬁguration options.This menu can be either
Dynamic HyperText Markup Language (DHTML) based, the default, or Java based.The
functionality of each type of menu is the same, but the look and feel is slightly different. By
default the WebUI is conﬁgured to work over the Hyper Text Transfer Protocol (HTTP)
only. It can, however, be conﬁgured to work over Hyper Text Transfer Protocol Secure
(HTTPS), which provides a mechanism to secure your Web management trafﬁc.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
397

Figure 9.1 The WebUI Interface
The NetScreen Security Manager
The NSM is a tool that can be used to manage multiple NetScreen devices.The NSM runs
as an application on either a Solaris server or a Red Hat Linux server. It requires a separate
license, and it is based on how many devices you want to manage.This product is most
effective if you want to manage multiple devices at the same time. Figure 9.2 shows the
NetScreen Security Manager interface.
Figure 9.2 The NetScreen Security Manager Interface
NetScreen Conﬁguration Basics
While the NetScreen ﬁrewall platform was being designed, ideas were invited from the
developers as to how a ﬁrewall should work by combining both conventional and original
398
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen
www.syngress.com

security concepts.These concepts are essential to effectively design your organization’s net-
work security and deploy, conﬁgure, and manage NetScreen ﬁrewalls. Let’s look at these
NetScreen core concepts before we start the conﬁguration process.
Virtualization
Juniper NetScreen ﬁrewalls work on the concept of virtualization. Virtualization allows you
to extract maximum performance from the ﬁrewall appliance (or system) and provides gran-
ular control over the security administration, users, network objects, VPN tunnels, and
routing tables.This feature raises a doubt in the conventional method of thinking only two
types of network exist: trusted and untrusted. How trusted are the trusted networks? This
question leads to the concept of zones.
Security Zones
Zones are the core of the NetScreen architecture.A zone can be deﬁned as a logical area.
Several types of zones can exist on a NetScreen ﬁrewall.The ﬁrst and the commonly used
zone is the security zone.The two commonly used security zones are trust and untrust.The
trust zone is assigned to the internal LAN, and the untrust zone is assigned to the Internet.
Security zones are a key component of the policies and are used in policy conﬁguration.
Different types of security zones are:
■
Layer 3 zones Untrust, trust, DMZ, and global.
■
Layer 2 zones V1-Untrust, V1-Trust, and V1-DMZ.
■
Function zones Null, Self, Mgt, and HA are zones deﬁned for speciﬁc purposes.
■
Tunnel zones Untrust-Tun zone for VPN tunnels.
Virtual Systems
A virtual system (VSYS) is a unique security domain within a NetScreen ﬁrewall. Each vir-
tual system contains its own address book, user lists, custom service deﬁnitions, VPNs, and
policies. Virtual systems also have their own virtual system administrators.These administra-
tors have access to a speciﬁc virtual system only.This limits VSYS administrators to their
own virtual system, denying them access to other virtual systems and the root system.
Administering a virtual system is the same process as administering a regular appliance.
The only difference is that you can have only one read/write administrator and one read-
only administrator.A read/write administrator for a VSYS has the same privileges as a
read/write administrator for an appliance.As the name goes, the read-only administrator can
only view the conﬁguration of the virtual system.The read-only administrator may review
the ﬁrewall logs and conﬁguration but is not allowed to make any conﬁguration changes.
The root administrator of the entire ﬁrewall device is allowed to create and delete vir-
tual systems.The root administrator is also required to give resources to the virtual systems.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
399

For example, if you want to give a virtual system access to interfaces or virtual routers, you
need to be connected to the system as the root administrator.A VSYS administrator cannot
perform this type of task. Once the VSYS administrator has the interfaces or virtual routers
(VRs) in the VSYS, it can do whatever it wants with them, but only after the root adminis-
trator gives the VSYS access to the resource.
Tools & Traps…
Sharing Nicely with Others
We have begun to discuss the idea of “shared” objects. A shared object is an
object that can be used by multiple systems residing on the same physical ﬁre-
wall. On a virtual system, these consist of zones, interfaces, and virtual routers.
Sharing the same objects across several virtual systems allows for the efﬁcient
distribution of resources.
In situations in which you are using a NetScreen-500 and it is conﬁgured
with the maximum eight Ethernet interfaces, you want to ensure that in the long
term you have enough resources available to you. This is where efﬁcient sharing
among all the available virtual systems and the root system is important. If you
have long-term expansion goals, you will want your initial design to reﬂect these
goals. You never want to be stuck in a situation where you need to redesign your
network after several months of deployment because you failed to see the bigger
picture in the beginning.
Virtual Routers
A ﬁrewall is nothing more than a gloriﬁed router. It essentially sends trafﬁc from one loca-
tion to another, determining the best path based on its routing table.A normal device that
uses IP has a single routing table.The routing table contains all the known or learned routes.
A NetScreen device uses the concept of the virtual router, or VR.
A VR is a logical construct within a NetScreen device. It provides you with multiple
routing tables on the same device.The VR has many uses. VRs are bound to zones, and the
zones are bound to interfaces.The NetScreen router will function much like a standard ﬁre-
wall device with one routing table. However, using two separate routing tables gives you the
ability to separate your routing domains. For example, if you were to run Open Shortest
Path First (OSPF) internally and Border Gateway Protocol (BGP) externally, you would have
two separate routing domains.This allows you to securely separate your internally trusted
routes with your externally untrusted routes.
www.syngress.com
400
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Using a VR may seem like a complex process at ﬁrst. However, it is just like using a tra-
ditional routing device.Think about multiple virtual routers in your ﬁrewall as having mul-
tiple real routers.The VRs will function the same way. Zones are bound to virtual routers.
This determines which routers are used on your ﬁrewall. If your ﬁrewall supports it, you can
create additional VRs. Figure 9.3 shows the WebUI VRs of a NetScreen appliance.
Figure 9.3 Virtual Routers
Interface Modes
A NetScreen ﬁrewall, by default, operates initially as a router. It allows each physical interface
to use an IP address, allowing trafﬁc to be forwarded between each interface.A NetScreen
ﬁrewall, however, is not limited to this traditional type of ﬁrewall conﬁguration.
The ﬁrewall allows its physical interfaces to run in a special mode called transparent mode.
Transparent mode allows you to put the NetScreen ﬁrewall into Layer 2 mode, allowing the
ﬁrewall to act as a bridge while still providing normal ﬁrewall ﬁltering. Layer 2 mode is
sometimes referred to as drop-in mode, where no IP reconﬁguration of the network is
required.The ﬁrewall is inserted between the router and the internal network.This setup is
useful when you want to test the ﬁrewall’s capabilities, with minimal or no reconﬁguration
of your network.The ﬁrewall offers full functionality, including VPN.You also have route
mode, in which no address translation is performed, and NAT mode, in which address transla-
tions are performed. Interfaces that belong to trust zones are automatically conﬁgured to be
in NAT mode, and untrust zone interfaces are in route mode.
Deﬁning Interfaces
The following are the steps to deﬁne interfaces:
1
Assign zones to virtual routers.
2
Bind an interface to a zone.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
401

3
Set up IP addressing.
4
Conﬁgure basic network routing.
After these steps are complete, you conﬁgure security policies. Security policies are discussed
later in this chapter.
Assigning Zones to Virtual Routers
First, let’s look at the zones we have conﬁgured on our device.This can be done from the
command line as well as the WebUI.To view the zones using the WebUI, access Network |
Zones. You can issue this command through a console connection. Figure 9.4 shows a
Telnet connection established to a ﬁrewall.
Figure 9.4 Network Zones
It is a simple task to create a zone. However, before creating a zone, you should know
the following:
■
Name What you want to name your zone. It helps to be descriptive. If you have
a DMZ for Web servers, naming it WebDMZ is more helpful than simply
choosing DMZ02.This is really a personal preference. If you are creating a Layer 2
security zone, preﬁx the zone name with L2-.
■
Type of zone You can create three types of zone: security Layer 3 zones, security
Layer 2 zones, and tunnel zones.
To create a zoneusing WebUI:
1.
Access Network | Zones and click New.
2.
Provide a zone name.
3.
Choose the virtual router to which you want the zone to be assigned.
4.
Select the type of zone (Layer 3, Layer 2, or tunnel zones).
www.syngress.com
402
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

You may select other security options for the zone. Once a zone is created, you can
modify any of its properties except its name.To change the name, you must delete the zone
and recreate it using the desired name.
A NetScreen ﬁrewall can contain several types of interface.An interface allows trafﬁc to
enter a zone and leave a zone. If you want an interface to pass trafﬁc, you need to bind it to
a zone. Once you bind an interface to a zone, you can apply an IP address to the interface.
Binding an Interface to a Zone  
First, let’s bind an interface to a zone.We will bind the trust zone to the trust interface.This
can be done in both the WebUI and the CLI. However, to change the zone you must ﬁrst
remove the IP address of the interface by setting it to 0.0.0.0/0.Then you can select a new
zone.
To bind an interface to a zone using the CLI, enter the command set interface inter-
facename zone zonename, where interfacename is the name of the interface you want to bind
and zonename is the name of the zone to which you want to bind the speciﬁed interface.
Setting Up IP Addressing
We will now assign the interface an IP address of 192.168.1.1 with a 24-bit subnet mask.
This can be done in both the WebUI and the CLI. Modifying the IP address of an interface
is the same as setting it up for the ﬁrst time.
To assign an IP address to an interface using the CLI, enter the command set interface
interfacename ip ipaddress netmask, where interfacename is the name of the interface, ipaddress
is the IP address you want to assign, and netmask is the netmask.
Tools & Traps…
Follow the Right Sequence
Consider an example: You have several soup bowls of increasing sizes. You place
the smallest bowl upside down on the table and start placing the bigger bowls
on top, one by one. Now try to pull out the innermost bowl! You can’t. 
Similarly, the sequence to deﬁne interfaces that we’ve just described needs
to be followed. If you have already assigned an interface to a zone, you cannot
assign it to a virtual router. To achieve this goal, you have to unbind the interface
from the zone, disassociate the zone from the virtual router, and start afresh.
Otherwise, you could receive the error message “#untrust has interface bound.
Remove them ﬁrst.”
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
403

Conﬁguring Basic Network Routing
Our ﬁrewall is not yet fully functional. We need to follow these additional steps to com-
pletely set up the ﬁrewall:
1.
Conﬁgure routing.
2.
Create user, computer, and network objects.
3.
Create service objects (if required).
4.
Create policies.
When you want to connect to a remote network, you need to inform your ﬁrewall of the
remote network’s location.You would do this by adding network routes on your ﬁrewall.
These routes tell the ﬁrewall where the remote network can be found. In this section, we
look at adding a static route to access a remote network. We will also add a default route.A
default route is also known as the route of last resort. So, if a packet on a device needs to get
to a location and no other routes on the device are able to identify the next gateway for it to
go to, it will use the default gateway. When a system is determining what route to use, it will
always use the most speciﬁc route to the destination network ﬁrst.
To add a static route using the CLI, enter the command set route ipaddress/netmask
interface interfacename gateway gatewayip, where ipaddress is the virtual router’s IP address,
netmask is the virtual router’s netmask, interfacename is the next-hop gateway, and gatewayip is
the IP address of the next-hop gateway.
To add a static route via the WebUI, access Network | Routing | Destination and
click the New button on the top-right corner.Add the destination network and netmask.
Choose the Next Hop Virtual Router Name (untrust-vr) or Gateway (interface and
Gateway IP address). Click OK to conﬁrm.
Note that, in ScreenOS 5.3, you will ﬁnd a Routing menu with four options:
Destination, Source, Source Interface, and Virtual Routers. Previous versions have Routing
Entries, Source Routing, and Virtual Routers options.
NOTE
Assume that we have ethernet1 bound to a trust zone and in trust-vr. Ethernet3
is in an untrust zone and in untrust-vr. All the packets that need to be routed to
the Internet from trust-vr will have untrust-vr as the next hop. Untrust-vr will
have a default route, 0.0.0.0/0, routed through ethernet3, which is connected
to the Internet router. In essence, there is no direct connectivity to the Internet
router from the trust-vr. 
www.syngress.com
404
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Conﬁguring Security Policies
A policy or access rule permits, denies, or tunnels speciﬁed types of trafﬁc between two points.
You must ﬁrst determine the source and destination zones for each policy.The source zone is
where the source trafﬁc is coming from.The destination zone is the location to which the
destination trafﬁc is going. Because zones are bound to interfaces, you are also inherently
choosing which interface the trafﬁc will use.This may help you when you’re creating a
policy, because the concept of zones is different from many other ﬁrewall products.
On a NetScreen ﬁrewall, there are three types of policy. Each policy contains the same
ﬁve core components (Source Address, Destination Address, Service, Direction,Action).The
only difference is the zones that each policy contains.A policy is classiﬁed by the source and
destination zones that are used in the policy.There are three types of policy:
■
Intrazone policies In an intrazone policy, the source and destination zones are
the same.
■
Interzone policies In an interzone policy, the source and destination zones are
different.
■
Global policies In a global policy, the source and destination zones are both in
the global zone.The global zone is a special-purpose zone discussed later in this
chapter.
NetScreen ﬁrewalls also have a default out-of-the-box policy that will drop any trafﬁc
that does not match any other policies.This default policy is a hidden global policy. Juniper
offers it as a security feature to ensure that any trafﬁc that you do not want to allow through
is automatically dropped.This mitigates the risk of the ﬁrewall on the network by dropping
any unmatched trafﬁc. It is possible to change the behavior of this trafﬁc from the CLI.
To override the default behavior (and therefore allow all trafﬁc), enter the following
command:
set policy default-permit-all
To change the ﬁrewall to deny all trafﬁc by default, enter the following command:
unset policy default-permit-all
Components of a Security Policy
A policy is a single access control statement. When you create a policy, you must deﬁne ﬁve
separate components:
■
Source address (local area network or a speciﬁc computer)
■
Destination address (remote network, remote server or a computer or domain)
■
Service (HTTP, HTTPs, FTP, SMTP, and so on)
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
405

■
Direction (inbound or outbound trafﬁc)
■
Action (permit, deny, or encrypt)
Address Book Entries
Source and destination IP addresses required to create a security policy are created and
maintained in the address book. When using the command-line interface, you must create all
your address book entries before you make your policies. However, when using the WebUI
to create policies, you can create new address book entries as you create the policy. If you
choose this latter method of creating address book entries while creating a policy in the
WebUI, you can only specify the IP address and netmask for the entry.You will have to go
back at a later time and edit the address book entry if you want to associate a name with the
it. Figure 9.5 shows the WebUI address entry creation screen.
Figure 9.5 NetScreen WebUI Address Entry
However, when you create a single network object, the netmask should be 32. Figure
9.6 shows a single computer object.The use of inappropriate netmask while creating the
address book entries may produce varying results.
Figure 9.6 Creating An Address Book Entry for a Single Computer Object
406
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen
www.syngress.com

As you begin to amass many address objects, you will want a method to bring all of
them together into logical containers.This is accomplished with the use of address groups.An
address group is a logical container that groups together address objects.Address groups are
very handy in creating policies.
Services
The next component in creating your policy is services. Services are the protocols that you
use to access a system over the network. Services on a NetScreen ﬁrewall are represented by
service objects.A service object is used to specify the applications that can be used in a policy.
Every NetScreen ﬁrewall comes with a predeﬁned set of services.The set of services that
comes on your ﬁrewall varies by the version of ScreenOS you are running on your ﬁrewall.
Some protocols are also predeﬁned because they function in a nonstandard way. One
example is the FTP protocol. Because FTP sends special port redirects during its communi-
cation, Juniper has created a special mechanism to read inside the FTP connection to deter-
mine which ports to open up during the communication. Even though the predeﬁned
service allows only TCP port 21, the ﬁrewall is still able to dynamically allow ports based on
the FTP communication.
It would be impractical for Juniper to create every service that exists. Juniper allows you
to create your own custom service objects.These custom service objects can be used just like
a predeﬁned service object in your policy.To create a custom service object, you mention
the protocol the custom service uses (TCP, UDP, or other), the source port, and the destina-
tion port.
Creating an Outbound Policy
Now that you are familiar with the components of creating policies, you can begin creating
them. Polices are the main reason you are implementing your ﬁrewall in the ﬁrst place—to
control network trafﬁc.You start by choosing the source zone and destination zone. In the
policy creation screen, you choose the source network, destination network, service, and
action. Optionally you may enable logging to monitor the trafﬁc. Figure 9.7 shows an out-
bound policy.
Creating an Inbound Policy
Based on the network design, we might have to provide access to external users or networks
to access services located in the internal network. Similar to the outbound policy, you have
to choose the source and destination zones, source and destination networks, services that
require access, and action (permit, deny, or tunnel). Dial-up VPN or remote ofﬁces may
require access to your internal network. Careful planning is required when you’re providing
access to users outside your network.Additional security mechanisms such as virtual private
network and authentication should be considered prior to allowing inbound access.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
407

Figure 9.7 Conﬁguring an Outbound Policy
NOTE
Trafﬁc returning as a response to a request from the internal network permitted
by a security policy is not considered inbound trafﬁc. Therefore, you may not
require an explicit inbound policy to allow such trafﬁc.
Conﬁguring Network Address Translation
Juniper NetScreen has well-deﬁned address translation architecture, functionality, and fea-
tures. Probably no other ﬁrewall product has such clarity in deﬁning Network Address
Translation (NAT). Network professionals who are used to other ﬁrewalls may require a syn-
chronization of terminologies from the other schools of thought to the NetScreen school of
thought. Juniper NetScreen NAT features include:
■
Source NAT Provides address translation on the source IP address. Source Port
Address Translation (PAT) provides address translation on the source port.There
are several methods of source NAT:
■
Interface-based Source NAT Provides the ability to NAT ingress trafﬁc
received in the deﬁned interface, with NAT enabled with the last known
egress interface. Source NAT is also performed by default.
■
Managed IP (MIP) Provides a static NAT functionality for one-to-one
address translation.This feature can be used for either source or destination
NAT capabilities.
www.syngress.com
408
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

■
Policy-based Source NAT Similar in functionality to Interface-based
Source NAT; the conﬁguration is done on a ﬁrewall rule rather then a global
interface setting.
■
Destination NAT Provides address translation on the destination IP address.
Destination PAT is another feature set that can be enabled at the same time, which
provides address translation for the destination port.There are several methods of
Destination NAT:
■
Virtual IP (VIP) Provides one-to-many address translation functionality.
This feature can be used to translate the destination IP and the destination
port at the same time.
■
MIP Can also be used in a destination one-to-one address translation and
can be used for either Source or Destination NAT capabilities.
■
Policy-based Destination NAT Similar in functionality to Policy-based
Source NAT except that it performs address translation on the destination IP
or destination port on a per-ﬁrewall rule deﬁnition.
Source NAT
Source NAT is the most widely deployed method of address translation provided by vendors.
It provides the ability to translate a source IP address to another IP address. By default (in
NetScreen solutions), Source NAT is enabled on the interfaces by using the Trust security
zone.
MIP
MIP provides the ability to perform a one-to-one mapping translation, which is referred to
as Static NAT.This setting ensures that a host gets the same NAT every time trafﬁc traverses
the ﬁrewall, whether it’s ingress or egress trafﬁc.A MIP deﬁnition performs only NAT (not
PAT); therefore, the IP address changes, but the protocol ports remain the same. Once a MIP
is deﬁned, a ﬁrewall rule is needed to allow access to the MIP.
All MIP deﬁnitions are placed within a global zone, no matter which security zone
originally deﬁned the MIP. Once a MIP has been deﬁned, a ﬁrewall rule must be set up to
allow for trafﬁc destined for the MIP address. Within the ﬁrewall rule creation, the destina-
tion MIP selection can be from a global zone or the zone the MIP address was originally
deﬁned in.
The following example shows a typical MIP scenario. MIP is deﬁned for you to access a
Web server located on your private network from the Internet.Although this typically means
an incoming translation, the Web server automatically gets the public IP for outbound trans-
lation, too.
To deﬁne the MIP on the Untrust interface (Ethernet3):
1.
Go to Network | Interface | Ethernet3 | MIP | New (see Figure 9.8).
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
409

Figure 9.8 Deﬁning MIP
2.
Fill in the following:
Mapped IP: 192.168.2.240
Netmask: 255.255.255.255
Host IP Address: 192.168.1.100
Host Virtual Router Name: Trust-VR
3.
Deﬁne the ﬁrewall rule to permit trafﬁc to the MIP. Go to Policies | FROM |
Untrust | TO | Trust | New (see Figure 9.9).
4.
Fill in the following:
Source Address: Any
Destination Address: MIP (2.2.2.10)
Services: HTTP
Action: Permit
Note that in the lab scenario, the 192.168.2.0 range of addresses is used instead of public
IP addresses.The 192.168.1.0 network is referred to as the internal network.
Policy-Based Source NAT
Policy-based source translations are accomplished by creating a ﬁrewall rule with Source NAT
enabled. By default, the outbound interface’s or egress interface’s IP address in the destination
zone is used as the newly translated source address. PAT is also enabled by default.The
NetScreen policy is to use source NAT for trafﬁc sourcing from the Trust side to the Untrust
side.The Source NAT address will be the egress interface IP, in this case the Untrust Ethernet
interface.Address objects must be deﬁned before any ﬁrewall rule is created.Two address
objects are created for this example, one for the Trust zone and one for the Untrust zone.
www.syngress.com
410
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Figure 9.9 Conﬁguring a Policy to Permit Trafﬁc to the MIP
Dynamic IP 
Several other methods can be used to translate the source address via the policy.These
methods are primarily due to the functionality of dynamic IP pool (DIP pool) deﬁnitions.A
DIP can be either a host range deﬁnition or a pool of address deﬁnitions. If it is a pool of
address deﬁnitions, the pool must be in consecutive order.Therefore, it is important to note
that no other IP(s) within that pool can be used anywhere else (e.g., a MIP deﬁnition).
DIP pool deﬁnition also offers the option to disable or enable PAT. Since the DIP pool
is used only in Source NAT scenarios, PAT on the source ports can be utilized to increase
the amount of usage for each address within the pool. Figure 9.10 illustrates the creation of
DIP pool on the untrust (ethernet3) interface.
Figure 9.10 Creating a DIP Pool on the Untrust Interface
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
411

A DIP pool can also contain one IP range. For example, in deﬁning the single IP address
2.2.2.2 within a DIP pool, the IP address range would be 2.2.2.2 ~ 2.2.2.2.This is an alter-
native way of using a different IP address than the one currently deﬁned on the egress inter-
face. It is recommended that you enable PAT within the DIP pool deﬁnition when you’re
creating for one IP range. Figure 9.11 shows the conﬁguration of source translation by using
DIP pool for the internal network.To access the Advanced Policy Settings screen, choose any
policy and click the Advanced button at the bottom of the screen.
Figure 9.11 Conﬁguring Source Translation Using the DIP Pool
NOTE
When PAT is disabled in a DIP pool, the IP pool assignment remains the same
for the host for all concurrent sessions. When PAT is enabled, the IP pool assign-
ments rotate in a round-robin fashion for each new session.
Destination NAT
The following section illustrates how the NetScreen ﬁrewall solution handles destination
address translations.
VIP
A VIP provides a one-to-many mapping scenario, whereas an MIP provides a one-to-one
mapping.The one-to-many mappings a VIP performs are more related to a combination of
destination Network Address Port Translations, or NAPTs.
VIP deﬁnitions are placed into the global zone, no matter which interface/security zone
they were originally deﬁned in. Once a VIP is deﬁned, a ﬁrewall rule must be set up to
412
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen
www.syngress.com

allow for trafﬁc destined for the MIP address. Within the ﬁrewall rule creation, the VIP can
be selected from a global zone or the zone that the VIP address was originally deﬁned in.
Refer to the product documentation to ﬁnd out the VIP capacity of various ScreenOS ver-
sions. Figure 9.12 shows single VIP 192.168.2.241 mapped to three different servers
(192.168.1.10, 192.168.1.11, 192.168.1.12) offering HTTP, FTP, and SMPT services.As
mentioned earlier, in real-life scenario 192.168.2.241 this example will be substituted with a
public IP.
Figure 9.12 Conﬁguring a Virtual IP
Policy-Based Destination NAT
Policy-based Destination NAT is also a subset setting within a ﬁrewall rule. Just like the
Source-based NAT conﬁguration, there is a separate deﬁnition in place to deﬁne a
Destination NAT. Unlike Source NAT, there are no requirements to predeﬁne settings on
the interfaces. For example, you do not need to create a DIP pool before actually creating a
destination NAT ﬁrewall rule.The address schemes for the newly translated destination are
all deﬁned within the ﬁrewall rule. Besides Destination NAT, a Destination PAT can also be
deﬁned.The options available to perform Destination NAT are as follows:
■
Destination NAT to another IP
■
Destination NAT to another IP with PAT to a different port
■
Destination NAT to an IP range
NOTE
When you’re using Destination NAT, it is important to know the NetScreen
packet ﬂow. Route lookup on the NetScreen device occurs before and after
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
413

policy lookup. Policy lookup also entails Policy-based NAT functions. Therefore,
there might be a need to create a route before or after a Policy-based NAT func-
tion takes place. Syngress Publishing has published a book, Conﬁguring
NetScreen Firewall (www.syngress.com/catalog/?pid=3120), that discusses these
topics in detail. 
Routing
NetScreen supports static routing and dynamic routing protocols such as RIP, OSPF, and
BGP. Let’s look brieﬂy at conﬁguring static and dynamic routing on NetScreen ﬁrewalls.
Static Routing
Static routing is often a simple way to set up a ﬁrewall and get it up and running within few
minutes.A static route works well as long as the network is small and uncomplicated.
However, when you have large networks, static routing might not be the right choice.You
might have to implement routing protocols to perform automatic routing. However, static
routes are always required. For example, when you want conﬁgure the default gateway on
the untrust interface, you use static routing.You would require static routes when you con-
ﬁgure the device to be in transparent mode.
To add a static route using the CLI, enter the command set route ipaddress/netmask
interface interfacename gateway gatewayip, where ipaddress is the virtual router’s IP address,
netmask is the virtual router’s netmask, interfacename is the next-hop gateway, and gatewayip is
the IP address of the next-hop gateway.
Routing Information Protocol 
The Routing Information Protocol (RIP) is one of the oldest routing protocols available
today. It is highly inefﬁcient, but this of course is made up for by its simple conﬁguration.
Almost all routing devices typically support the RIP protocol, even home user Cable/DSL
routers.There are two versions of RIP: RIP version 1 and RIP version 2. NetScreen ﬁre-
walls support RIP version 2. Even though the RIP protocol is old, it is mature and functions
well in small networks.
RIP Concepts
The RIP protocol sends update messages to connected routers at regular intervals and when
the network changes.This makes RIP a “chatty” routing protocol because it constantly sends
information out to the network. RIP uses only one mechanism to determine the best route. It
counts a hop or how many hops away a network is. It has a limitation of using up to 15 hops
of distance. If a route’s metric reaches 16 hops, the destination is considered unreachable.
www.syngress.com
414
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Basic RIP Conﬁguration
RIP is created on a per-virtual-router basis.To use RIP, you need to perform four simple
steps on your ﬁrewall:
1
Conﬁgure a virtual router ID.
2
On the virtual router, create a RIP routing instance.
3
Activate the new RIP instance.
4
Conﬁgure the network interfaces to have RIP enabled.
Use the following steps to conﬁgure RIP via the WebUI:
1.
Access Network | Routing | Virtual Router.
2.
Click the Edit link of the virtual router you want to modify.
3.
Enable the Virtual Router ID option.
4.
Use the Custom ﬁeld to enter an ID for the RIP.
5.
Click Apply.
6.
Click Create RIP Instance.
7
Enable the Enable RIP option (Figure 9.13).
8.
Click OK.
9.
Access Network | Interface.
10.
Click the Edit link of the interface on which you want to enable RIP.
11.
Click the RIP link at the top of the page.
12.
Enable the Enable option.
13.
Click OK.
Figure 9.13 Enabling RIP
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
415
www.syngress.com

Use the following to conﬁgure RIP via the CLI:
ns208-> set vrouter trust-vr router-id 255
ns208-> set vrouter trust-vr protocol rip
ns208-> set vrouter trust-vr protocol rip enable
ns208-> set interface ethernet3 protocol rip enable
Use the following to verify RIP conﬁguration via the CLI:
ns208-> get vrouter trust-vr
ns208-> get interface ethernet3
Open Shortest Path First
OSPF is a link-state protocol and is considered one of the best protocols to run for your
internal network.The Open in OSPF represents that it is an open-standard protocol. OSPF
sends out only periodic updates and is not considered a chatty protocol. It is extremely efﬁ-
cient and is supported by most modern routing equipment.
OSPF Concepts
Let’s review a few OSPF concepts.These concepts are common throughout the conﬁgura-
tion of OSPF as well as across various vendors’ devices. Routers are grouped into areas. By
default, all routers participating in OSPF are grouped into area 0, also known as area 0.0.0.0.
On occasion you will want to divide your network into multiple areas.This is typically done
in large networks.
Each router that participates in an OSPF network is classiﬁed as one of four types of
router:
■
Internal router A router with all interfaces belonging to the same area.
■
Backbone router A router that has an interface in the backbone area.The back-
bone area is also known as area 0.
■
Area border router A router that connects to multiple areas.
■
AS boundary router A router that borders another autonomous system (AS).
Basic OSPF Conﬁguration
Conﬁguring OSPF is similar to conﬁguring RIP because it is enabled on a per-virtual-
router basis. Each virtual router is capable of supporting one instance of OSPF at a time.To
use OSPF, you need to perform four simple steps on your ﬁrewall:
1
Conﬁgure a virtual router ID.
2
On the virtual router, create an OSPF instance.
www.syngress.com
416
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

3
Activate the new OSPF instance.
4
Conﬁgure the network interfaces to have OSPF enabled.
Use the following steps to conﬁgure OSPF via the WebUI:
1.
Access Network | Routing | Virtual Router.
2.
Click the Edit link of the virtual router for which you will conﬁgure OSPF.
3.
Enable the Virtual Router ID option.
4.
Enter an ID in the text box labeled Custom, next to the radio button you
selected.
5.
Click Apply.
6.
Click Create OSPF Instance.
7.
Enable the OSPF Enabled option.
8.
Click OK.
9.
Access Network | Interface.
10.
Click the Edit link of the interface you want to enable OSPF on.
11.
Click the link labeled OSPF.
12.
Enable the Enable Protocol OSPF option.
13.
Click OK.
Use the following to conﬁgure OSPF via the CLI:
ns208-> set vrouter trust-vr router-id 255
ns208-> set vrouter trust-vr protocol ospf
ns208-> set vrouter trust-vr protocol ospf enable
ns208-> set interface ethernet3 protocol ospf enable
Use the following to verify OSPF conﬁguration via the CLI:
ns208-> get vrouter trust-vr
ns208-> get interface ethernet3
Border Gateway Protocol 
BGP is the core routing protocol used on the Internet. BGP routing information is not
broadcast like RIP or OSPF.Two BGP peers connect to each other form a Transmission
Control Protocol (TCP) session.This session is then used to transmit all the routing data.
BGP is a very complex protocol to implement and manage.
Use the following steps to conﬁgure BGP via the WebUI:
1.
Access Network | Routing | Virtual Router.
2.
Click the Edit link of the virtual router on which you will create a BGP instance.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
417

3.
Enable the Virtual Router ID option.
4.
Enter an ID in the Custom ﬁeld next to the radio button you selected.
5.
Click Apply.
6.
At the bottom of the page, click the Create BGP Instance link.
7.
Enter the number of your autonomous system in the AS Number ﬁeld.
8.
Enable the BGP Enabled option.
9.
Click OK.
10.
Access Network | Interface.
11.
Click the Edit link of the interface that you want to enable BGP on.
12.
Click the BGP link.
13.
Enable the Enable Protocol BGP option.
14.
Click OK.
Use the following to conﬁgure BGP via the CLI:
ns208-> set vrouter trust-vr router-id 255
ns208-> set vrouter trust-vr protocol bgp 10245
ns208-> set vrouter trust-vr protocol bgp enable
ns208-> set interface ethernet3 protocol BGP enable
Use the following to verify BGP conﬁguration via the CLI:
ns208-> get vrouter trust-vr
ns208-> get interface ethernet3
NetScreen Advanced Features
Because standard ﬁrewall features are not strong enough for more demanding environments,
the mid- to high-range NetScreen ﬁrewalls provide support for the NetScreen Redundancy
Protocol (NSRP).This protocol is the heart of all the high-availability (HA) options covered
here. NSRP has been available for several years and was originally referred to as HA. HA
setups are now commonly referred to as NSRP setups or just running NSRP. NetScreen ﬁre-
walls can be implemented in Active/Passive,Active/Active, and Full-Mesh conﬁgurations.
Figure 9.14 shows a Full-Mesh, highly available network design.
NetScreen Failover
NSRP is the protocol that redundant NetScreen devices use to talk to each other when
they’re running in various HA conﬁgurations. It is the language that allows them to
exchange state information and make decisions. One of the main goals of HA is to have
multiple redundant systems, wherein a second system can take over in case the ﬁrst one fails.
This is commonly achieved by duplicating the hardware.As with the NetScreen ﬁrewalls,
any HA setup that is using NSRP implies that there are at least two ﬁrewalls of the same
model working together.This group of ﬁrewalls is called an NSRP cluster or simply a cluster.
www.syngress.com
418
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Figure 9.14 Full-Mesh Network Design
Virtualizing the Firewall
To minimize the amount of downtime caused when the ﬁrst system in a cluster fails, it is
important to ensure that the second system knows precisely what the ﬁrst system is doing so
that it can pick up without any interruption. In effect, what you want to do is shift the
entire running ﬁrewall onto new hardware. When looked at this way, it makes sense to turn
the actual ﬁrewall into a virtual ﬁrewall that has some hardware associated with it.This is
precisely what is done in NetScreen ﬁrewalls. When NSRP is enabled, a virtual security
device (VSD) is created, and the conﬁguration for the physical interfaces change to apply to
virtual interfaces called virtual security interfaces (VSI).The fact that these virtual interfaces
are in turn associated with actual hardware is not important; all the conﬁgurations are done
on the VSI. NSRP then takes care of associating the VSI to the correct physical interface.
By abstracting the ﬁrewall in this manner, it becomes relatively easy to move the ﬁrewall
between different hardware units as necessary. It also becomes possible to have more than
one VSD per physical ﬁrewall.A VSD is not a standalone entity; rather, it is always part of a
VSD group, which spans both of the NetScreens in the cluster.There is one VSD per VSD
group on each cluster member, and the VSD conﬁguration is identical everywhere. VSD
only acts as a container for the VSIs. Other conﬁguration items, such as policies and routing,
apply across all VSDs on a NetScreen.
Within a VSD group, one VSD is the designated master VSD.This VSD is the currently
active VSD that is processing and forwarding trafﬁc.The other VSD in the VSD group is the
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
419
Router 1
Firewall 1
Switch 1
Router 2
Firewall 2
Switch 2
High Availability Heart beat links between two devices
Secondary links for redundancy
Primary Links
External 
Network
Internal
Network

backup, which is located on the other NetScreen.The backup VSD is not processing trafﬁc,
which means that only one of the ﬁrewalls is active and processing trafﬁc at any given time.
This is known as an Active/Passive setup.
It is important to note that IP addresses assigned to a VSI follow the master VSD.This is
slightly different from how Virtual Router Redundancy Protocol (VRRP) works. In VRRP,
the backup unit has its own IP address and simply acquires the primary IP address upon
failover.With NSRP, only one interface IP address ﬂoats between the NetScreens as necessary.
The manage-ip settings stay bound to the physical interface and do not follow the VSD.
It would not be very useful if the IP addresses were also moved across to the active ﬁrewall,
since that would render the backup ﬁrewall unreachable for management purposes.Thus,
when the backup ﬁrewall becomes the master, it already has the manage IP address and then
simply adds the VSI address.
Understanding NSRP States
As mentioned, the fundamental concept of NSRP is duplicating hardware—to be able to
move the ﬁrewall functionality around as necessary using VSDs.As a consequence, at any
given time each VSD is in one of six states, which determines the current role of the VSD.
The possible states are:
■
Master
■
Primary backup
■
Backup
■
Initial
■
Ineligible
■
Inoperable
Understanding which state is used for what purpose is central to monitoring and con-
trolling your NSRP cluster. Instead of simply explaining what each state is, let’s look at the
order in which the VSD transitions between the states.
When a VSD is ﬁrst created, either due to a reboot or a conﬁguration change, it is put
in the initial state. While in this state, the VSD learns which other NetScreens are partici-
pating in the VSD group, synchronizes that state with the other VSDs if needed, and possibly
partakes in the election process for the VSD that should become the master.
From the initial state, the VSD can move into either the master or backup state. If it wins
the election process, this VSD takes on the task of processing trafﬁc. If it does not win, it
transitions into the backup state.
The election process used to determine the master VSD is reasonably straightforward.
First, if there is no other VSD available, this VSD automatically wins the election. Second, if
two VSDs are starting up at the same time, the winner is determined based on the conﬁg-
ured priorities (set nsrp vsd-group id X priority N).The unit with the lowest priority
www.syngress.com
420
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

value is the preferred VSD. If both VSDs have the same priority or if the priority is not con-
ﬁgured, the VSD with the lowest Media Access Control (MAC) address wins.
Normally, an election is held only if there is no master VSD in the VSD group.
However, if the starting VSD has preemption enabled (set nsrp vsd-group X preempt), it
can force an election, which it would probably win due to having a better priority than the
old master VSD.
A VSD in the backup state checks to see if there is already a primary backup VSD, and if
there isn’t, it makes itself the primary backup for the VSD group.As the primary backup, it is
responsible for taking over the trafﬁc processing should the master fail or step down. From the
primary backup state, there are generally two directions the VSD can take: It either ends up
promoted to master due to the old master VSD disappearing or it goes into the inoperable state.
A VSD puts itself into the inoperable state if it detects a failure that would prevent it
from processing trafﬁc. If this VSD were the master, any failure that resulted in a failover
would result in this VSD becoming inoperable. In this state, the VSD does not participate in
elections for the position of master VSD; however, it does continue to check for the failure
condition. If that condition is remedied, as can be the case if the failure was caused by a
monitored interface going down and subsequently brought back up, the VSD will progress
from the inoperable state back into the initial state again.
The ineligible state is entered only by manual intervention. It is the administratively down
state of the VSD. If for any reason you want to prevent the VSD from participating in the
master election, thereby preventing it from processing trafﬁc, you can put the VSD into the
ineligible state using the set nsrp vsd-group id X mode ineligible command.The VSD group stays
in that state until you use the corresponding unset command or NetScreen is rebooted
without having saved the conﬁguration. (The ineligible state can be kept across reboots if
you save the conﬁguration after entering the command.)
This explains the various NSRP states that a VSD can be in. If you are conﬁdent in this
knowledge, you will have no problem understanding what the VSDs in your cluster are doing.
Building an NSRP Cluster
Before you can conﬁgure the NetScreens to be used in your NSRP cluster, you must do the
cabling. For the trafﬁc links, the three main choices are to connect the ﬁrewalls directly to
the routers, connect the ﬁrewalls to the routers via switches or connect the ﬁrewalls in a full
mesh.The HA links can either be directly connected between the NetScreens or connected
via switches.
Adding a NetScreen to an NSRP Cluster
To add a NetScreen to an NSRP cluster, additional conﬁguration is needed.The good news
is that this is easy to do for a simple NSRP cluster. Once you have made it part of the
cluster, you will probably want to add a few more conﬁguration settings to make it fail over
when appropriate.A NetScreen that has an NSRP cluster ID greater than zero is considered
part of a cluster; valid cluster IDs range from 1 to 7.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
421

Synchronizing the Conﬁguration
Once you have cabled the NSRP cluster the way you want it, you must address the conﬁgu-
ration side of things. Cluster members must have near-identical conﬁgurations to operate
properly.The reason for near-identical and not identical is that some aspects must be unique
to each NetScreen, including things such as the hostname and the management IP addresses.
Although it is possible to copy the cluster conﬁguration from another cluster member
using the exec nsrp sync global-conﬁg command, personal experience leads us to recommend con-
ﬁguring from scratch because it might not take a long time to conﬁgure an NSRP cluster.
The advantages of synchronizing the conﬁguration using this method are that you know
precisely what is going on at all times and there is no real risk of duplicate IP addresses con-
ﬂicting with each other between the ﬁrewalls.This makes it possible to use this procedure
safely when you’re logged in remotely.Also, having the conﬁguration ﬁles stored side by side
makes it easy to compare them and see the differences using the diff command for UNIX
and the WinDiff command for Windows.
Determining When to Failover–The NSRP Ways
Similar to the options provided on the low-end range of NetScreen ﬁrewalls, NSRP pro-
vides a number of methods that you can use to determine when a failover should be initi-
ated.The options in some cases might seem identical to their low-end cousins, but do not
confuse them—they are distinctly different, albeit subtly so.
Here is a list of reasons to fail over:
■
Software crashes
■
Hardware or power failure
■
Link failure on monitored interfaces or zones
■
Unavailability of one or more tracked IP addresses
The ﬁrst two items, software and hardware failure, are detected automatically, without any
need for explicit conﬁguration.The last two items are available to provide ﬂexibility in deter-
mining whether to fail over or not and must be explicitly enabled to be in effect.The NSRP
IP tracking feature checks for the availability of a particular IP by regularly contacting it.
Looking into an NSRP Cluster
It would be impossible to provide listings of all the possible outputs from get nsrp, and we
won’t attempt to do so here.Also, there is a wealth of information available from the NSRP
subcommand printouts; do a get nsrp? to see the options. Issue a get nsrp command on
one of the cluster members and go through the output.
Taking Advantage of the Full NSRP
NSRP-Lite, a scaled-down version of NSRP, has a limitation. In the case of failover, any
existing session and VPN information (among other things) is lost. Juniper NetScreen has an
www.syngress.com
422
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

answer to this problem. It is called Run-Time Object (RTO) mirroring, and it is available only
with the full NSRP. Enabling RTO means all the dynamic information is actively mirrored
between the VSDs. In case of a failover, all this state information is already available on the
new master VSD and can resume operation with a minimum of interference to the trafﬁc
ﬂow. Examples are ARP cache entries, session table entries, IPSec Phase 2 security associa-
tions, certiﬁcates, and DHCP leases.
Another shortcoming of NSRP-Lite is that in an NSRP cluster, one ﬁrewall ends up
sitting unutilized for most of the time. It can be hard to justify the purchase of an additional
ﬁrewall when management counters with the argument,“It says here that it will not actually
be used. Why do you expect me to spend money on something that will not be used?” Such
setups are known as Active/Passive setups—one ﬁrewall is active and the other is passive.
NSRP provides the ability to create Active/Active conﬁgurations, in which both ﬁrewalls
actively handle trafﬁc. Designing the network for Active/Active setups requires careful con-
sideration, but once you have it set up and working, your network will run very nicely.
Failing Over
A chapter on HA and NSRP would not be complete without a more in-depth dissection of
what happens when a failover occurs.We have already seen the reasons that a failover could
occur.Additionally, the administrator can manually request a failover for maintenance purposes.
Once the primary backup VSD has determined that it must become the master VSD, a
few things happen. First, the VSD promotes itself to master to prevent any other VSD from
doing the same thing. Second, if the VSD has any links down, an attempt is made to bring
them up. If a monitored link cannot be brought up, the VSD relinquishes its role as master
and puts itself in the inoperable state.
Assuming that the VSD is the newly promoted master VSD with all relevant links up, it
proceeds to send out gratuitous ARP requests.This is a very important aspect of the failover.
These ARP requests tell the neighboring network nodes that the IP addresses conﬁgured on
the VSIs are now reachable via a different path than before.This will cause switches to
update their forwarding tables and routers to update their ARP tables. By default, four ARP
packets are sent out on each interface.
As soon as the neighboring nodes have adjusted to this change, trafﬁc is sent to this VSD
instead of the old one. If RTO mirroring was enabled before the failover, this VSD already
has a copy of the all run-time state and proceeds to handle trafﬁc with no further disruption.
Note that some packets might be lost during the time it takes for the neighboring nodes to
reroute their trafﬁc ﬂows to the second NetScreen.
Conﬁguring a Stateful Failover
Conﬁguring failover includes creating NSRP clusters and deﬁning VSD, VSI, and the inter-
faces to be monitored for a failover.
1.
From the WebUI Network | NSRP | Cluster, provide the cluster ID and 
passwords for secure communication and authentication (Figure 9.15).
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
423

Figure 9.15 Creating NSRP Cluster
2.
From the WebUI Network | NSRP | VSD Group | Conﬁguration, set the
group priority (Figure 9.16).
Figure 9.16 Setting VSD Group Priority
3.
From the WebUI Network | NSRP | Monitor | Interface | Edit, choose
the interfaces to be monitored and their priorities (weight) (Figure 9.17).
4.
From the WebUI Network | NSRP | Monitor | Zone | Edit, you may
choose the zones to be monitored and the weight (Figure 9.18).
5.
From the WebUI Network | NSRP | Synchronization, choose the synchro-
nization parameters (Figure 9.19).
www.syngress.com
424
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Figure 9.17 Monitoring Interfaces
Figure 9.18 Monitoring Zones
Figure 9.19 NSRP Synchronization Parameters
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
425

WARNING
For a successful failover for Active/Passive, Active/Active, and Full-Mesh conﬁgu-
rations, apart from the NetScreen conﬁgurations, cabling the devices appropri-
ately plays an important role. Physical wiring from the ﬁrewalls to internal
switches and routers and between the ﬁrewalls requires careful planning. 
Web Filtering
URL or Web ﬁltering is the process of examining HTTP requests for content. Requests to
inappropriate sites like those that host pornography, racism, or other offensive material can
be blocked using this feature.This works by comparing the requested URL against a
database of classiﬁed sites. URLs can be categorically permitted or denied with a variety of
conﬁguration settings, which depend on the ﬁltering server/service used.These services
charge a recurring fee for updates to the database because new sites are constantly created on
the Internet.The URL ﬁltering software provides Internet usage reports and also keeps track
of repeat violators.
NetScreen ﬁrewalls now support the SurfControl Redirect protocol as well as the
WebSense Redirect protocol, but not both at the same time. New integrated mode on the
NS-HSC, NS-5GT, NS-25, and NS-50 provides URL ﬁltering by loading a ﬁlter database
directly on the device. Figure 9.20 shows the URL Redirect mode selection screen.
Figure 9.20 Choosing the URL Redirect Mode
WebSense Redirect Mode
It is fairly straightforward to conﬁgure on the NetScreen device; the majority of work
required is on the WebSense server side: conﬁguring users, user groups, policies, and excep-
tions.To use WebSense with ScreenOS 5.3, select it as the protocol to use for URL ﬁltering.
www.syngress.com
426
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

From the ﬁrewall side of things, setup is a snap. First, enable the Enable URL Filtering
option. Next, type the IP address (or DNS domain name if conﬁgured for your WebSense
server and your NetScreen has a DNS server conﬁgured) into the Server Name ﬁeld. Enter
the port number that the WebSense server is listening on for URL validation requests into
the Server Port ﬁeld (the default port is 15868). Now set a reasonable Communication
Timeout value (10 is the default, but you might need more if the WebSense server is being
accessed via a VPN).At this point, if the server is up and properly conﬁgured, a click on the
yellow circle next to Server Connection Status should show that the server is running.
Figure 9.21 shows the WebSense conﬁguration screen.
There’s also an option to set the behavior of the ﬁrewall in the event that the URL
server cannot be contacted. Using this option to either block all HTTP or permit all HTTP
is a policy decision you’ll have to make on your own, depending on your business require-
ments and the stability of your WebSense setup.
Figure 9.21 URL Filtering Conﬁguration with WebSense  
Once you conﬁgure WebSense and conﬁrm its reachability, you might want to conﬁgure
the policy to enable URL ﬁltering. Edit the already created policy or create a new policy and
enable the URL ﬁltering check box to monitor the trafﬁc and perform URL ﬁltering. Figure
9.22 shows a policy with URL ﬁltering enabled. Notice the WWW icon under the options.
SurfControl Redirect Mode
SurfControl Web Filter for Juniper Networks Security Devices is a competitor to WebSense,
and with ScreenOS you now have a choice of URL ﬁltering services to select from. Like
WebSense, SurfControl will work with 512MB of RAM, but 1GB or more is preferred.
SurfControl requires either an external MS-SQL database or an internal Microsoft Desktop
Engine 2000 (MSDE2000) database. If an MSDE2000 database is not already installed,
SurfControl will download and install it for you, similarly to the way WebSense handles a
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
427

missing Web server, which is very handy. But unlike WebSense, SurfControl has an
Integrated mode that uses public servers and does not require local installation.
Figure 9.22 A Policy With URL Filtering Enabled
Since it’s essentially the same concept, the conﬁguration settings for SurfControl Redirect
mode are the same as WebSense Redirect mode.To use SurfControl with ScreenOS 5.3, you’ll
ﬁrst need to select it as the protocol to use for URL ﬁltering.Then ﬁll in the options as you
would in WebSense, such as turning on Enable URL Filtering, setting a Server Name,
Server Port (the default for the Surf Control Filter Protocol (SCFP) is 62252), and a
Communications Timeout value. Now it’s time to check the server availability.
SurfControl Integrated Mode
This mode is available on only the newer low- to midrange model NetScreen ﬁrewalls: the
NS-HSC, NS-5GT, NS-25, and NS-50. SurfConrol Integrated mode also requires a feature
key to activate.To use SurfControl with ScreenOS 5.3, you’ll ﬁrst need to select it as the
protocol to use for URL ﬁltering.The protocol used for this mode is the SurfControl
Content Portal Authority (SC-CPA) protocol.
Once Integrated mode is selected, conﬁguration options for this mode appear.
Integrated mode URL ﬁltering supports the concept of blacklists (always deny regardless of
classiﬁcation) and whitelists (always permit regardless of classiﬁcation) right on the device.
These lists, as well as custom URL lists, are created by accessing the Screening | URL
Filtering option. In the custom list edit window, add a name to this category (Whitelist,
Blacklist, Competitors, etc.), add your ﬁrst URL, and click the Apply button.The category
name will be saved and locked and the URL added to the list.Add more URLs (up to a
maximum of 20) by entering them in the URL ﬁeld and clicking the Apply button. When
you are done adding URLs, click the OK button to save.
Antivirus 
ScreenOS 5.0 introduced the new antivirus engine from Trend Micro.This feature is sup-
ported on middle- to low-end devices from NS-HSC through NS-208.A license key is
www.syngress.com
428
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

required to activate the feature. Files sent via HTTP, FTP, POP3, IMAP, and SMTP are
inspected for viruses right on the device.Access Screening | Antivirus to conﬁgure global
antivirus parameters.
An antivirus is only as good as its virus database, so to stay protected, you need to stay
updated.These settings are found by accessing Screen | Antivirus | Scan Manager in
your WebUI. In this page, you will ﬁnd important information such as AV license entitle-
ment as well as how current your virus deﬁnitions are.
Activating AV couldn’t be easier. Currently, there is only one AV object on the device
(once the license is activated). Click Objects, and select Antivirus. Select the scan-mgr
object from the Available AV Object Names column, and click the << button to move
it to the Attached AV Object Names column. Be sure to click the OK button to save
the setting. Do this for each policy that needs antivirus scanning on any of the supported
protocols.
Summary
Juniper NetScreen presents a variety of options, from low-end appliances for remote ofﬁces
to high-end systems. Deep inspection (DI) technology, SecureOS, and features such as Web
ﬁltering and antivirus scanning extend the functionality of a ﬁrewall.
Solutions such as security zones, virtual routers, and virtual systems are a boon for enter-
prise security administrators to use to nail down the access and security levels using well-
deﬁned policies. Web-based interface and graphical NSM provides all the tools you’ll need
for remotely conﬁguring and managing security devices.
The Juniper NetScreen product range provides comprehensive security for enterprises
that are considering strengthening their DMZs. Enterprises can consider building a complete
solution based on NetScreen ﬁrewall appliances, IDP, and SSL-VPN appliances.
Solutions Fast Track
NetScreen Basics

The Juniper NetScreen ﬁrewall products have both the ICSA and Common
Criteria certiﬁcations.

Trend Micro antivirus is used for virus scanning on the ﬁrewall product line.

Zones are used to separate logical areas inside of the ﬁrewall.

Virtual routers allow for multiple routing tables in a single device.

Deep inspection allows you to look inside of a packet for speciﬁc attacks.

The Juniper NetScreen ﬁrewall design is based on ASICs, to increase its
performance.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
429

Securely Managing Juniper NetScreen Firewalls

There are three methods for managing your ﬁrewall: the WebUI, the CLI, and the
NSM.

Physical interfaces can host multiple IP addresses on each interface.

A policy is used to allow or deny trafﬁc that passes through the ﬁrewall gateway.
NetScreen Conﬁguration Basics

There are three types of policy on a NetScreen ﬁrewall: intrazone, interzone, and
global.

The WebUI and the CLI can both be used for creating policies. However, it might
be easier for people to use the WebUI because of its GUI nature.

Each virtual router contains its own routing domain and routing table.

Every NetScreen ﬁrewall supports at least two virtual routers.

Virtual routers allow you to separate your routing design into separate routing
domains on the same device.

RIP is a distance vector protocol. Using RIP is the easiest of all the dynamic
routing protocols supported by the NetScreen ﬁrewall.

OSPF is an efﬁcient link-state routing protocol. OSPF is more complicated to
conﬁgure than RIP.

BGP is used as the primary routing protocol on the Internet and requires careful
planning to conﬁgure.

Source NAT and Destination NAT options are available for address translation.

A virtual system is a unique security domain inside a NetScreen ﬁrewall.

Virtual systems can use components shared by the root system.

You can deﬁne a virtual system so it will use its own virtual router.

HA is all about risk mitigation; ﬁnding the right balance between availability and
cost is not always easy.

NSRP is the protocol used between ﬁrewalls conﬁgured in redundant clusters.

VSDs are the logical containers used in conﬁguring NSRP.

VSIs are logical interfaces belonging to a VSD, which are conﬁgured with the IP
addresses that should be possible to transfer between the ﬁrewalls when a failover
occurs.
www.syngress.com
430
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen


When a failover occurs, the newly elected master VSD sends out gratuitous ARPs
to announce the topology change to neighboring network nodes.

SurfControl and WebSense are the two URL ﬁltering options available with the
Juniper NetScreen appliances.

TrendMicro Antivirus is available on low-end appliances and can be integrated
into policies for checking trafﬁc viruses and malicious content.
Q: Security zones seem like a confusing concept. Other vendors get along with out them,
so why use them?
A: Zones are excellent tools to provide logical separation between multiple areas of your
network.As you will see in later chapters, in creating policies, zones simplify the process
by identifying the two separate areas of your network you want to access each other.
This can prevent you from accidentally creating access rules that will allow access to sec-
tions of your network that you did not intend to be accessible.
Q: Why would NetScreen limit the total number of policies that each device can have?
A: Each NetScreen device is designed to provide a speciﬁc rate of performance. Each
NetScreen device could most likely support more policies, but that could degrade its
performance. For each policy in the list, the NetScreen ﬁrewall checks it from a top-
down perspective.Therefore, the longer the list of policies, the more time it takes to tra-
verse the line.
Q: I have looked at the command-line interface and I do not feel that it is very effective to
use. Why should I even use it when the WebUI is easier and quicker?
A: The WebUI is a very useful tool and it should be used in conjunction with the CLI.
Each has its own pros and cons. Console access and CLI are useful when either the IP
address of the management interface is not known or you want to set basic conﬁgura-
tion parameters before accessing the WebUI.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
431
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

Q: Is it possible to use IP address ranges as address objects?
A: When creating address book objects, you can only create objects based on subnetting.
Even when you make a single host object, you are making it with a 32-bit mask only
allowing for a single host. If you require a range of hosts, see if you can ﬁt it into a
subnet. If not, however, you will be required to create each host individually and then
place them into a group.
Q: I am familiar with using other ﬁrewall software, and I am confused about why you
would bind address objects to zones.
A: Having address objects inside of zones just furthers the zone concept. It is essentially
binding that object into the logical location of a zone. Because most other ﬁrewall soft-
ware programs do not use zones, they essentially have no need to organize address
objects in any way other than by type.
Q: When would you need more than one virtual router?
A: Most people using NetScreen ﬁrewalls today are using only a single virtual router.This
makes the NetScreen ﬁrewall function like a traditional routing ﬁrewall. However, when
you want to use dynamic routing protocols on your device, using a virtual router is a
great idea.This allows you to separate your two routing domains easily and effectively.
Q: What is the point of virtual routers?
A: Virtual routers are very effective when you’re using dynamic routing protocols.This is
typically when they are used.
Q: What are the purposes of using dynamic routing?
A: Dynamic routing allows you to dynamically update your network conﬁguration. It is
usually a requirement when you’re using multiple locations with multiple subnets.
Integrating it onto your ﬁrewall allows for seamless updates to your network and can
ensure that resources can be accessed from almost anywhere in case of a link failure.
Q: Why doesn’t the NetScreen ﬁrewall support IGRP or EIGRP?
A: Both IGRP and EIGRP are Cisco proprietary protocols.
Q: What are the advantages of using NAT?
A: NAT conserves IP addresses, provides a hidden identity for host(s), has the ability to use
nonroutable addresses from the RFC 1918 space, addresses overlapping subnets, and
maintains a cohesive network.
www.syngress.com
432
Chapter 9 • Firewall and DMZ Design: Juniper NetScreen

Q: What is the difference between a MIP and a VIP?
A: MIP provides a one-to-one Static NAT function, whereas VIP provides a one-to-many
NAT function.
Q: What are the advantages of using Policy-based NAT over Interface-based NAT?
A: The number-one reason to choose Policy-based NAT over Interface-based NAT is the
scalability. With Interface-based NAT, you are limited to performing address translation
in only one ﬂow direction; only the source address can be translated, you cannot turn off
PAT, and it requires all ingress trafﬁc to be translated. With Policy-based NAT, you can
uniquely deﬁne address translation on a per-ﬁrewall rule deﬁnition, giving you the
ability to control address translation ﬂows, perform source and/or destination translation,
and the turn PAT on and off.
Q: Can Interface-based NAT and Policy-based NAT conﬁgurations co-exist?
A: Yes. Interface-based NAT and Policy-based NAT can co-exist together. It is recom-
mended that Interface-based NAT be disabled (set to Route mode) and that you use
Policy-based NAT for your address translation needs.
Q: What is a DIP?
A: A DIP is used for Policy-based Source NAT functionality.A DIP can consist of one to
many IP ranges.
Q: Virtual systems seem like a great idea, but are they practical for my environment?
A: Organizations very rarely use virtual systems.They are only practical to use when you
require many separate ﬁrewalls. Only large organizations and ISPs have the type of envi-
ronment that requires virtual systems. Even though the application of virtual systems
may be beneﬁcial to you, the cost may be prohibitive.
www.syngress.com
Firewall and DMZ Design: Juniper NetScreen • Chapter 9
433


Firewall and 
DMZ Design: 
ISA Server 2005
Solutions in this chapter:
■
Network Services Segment Conﬁguration Options
■
ISA Firewall Stateful Packet Inspection and Request/Response
Paths
■
Multiple Departmental Networks/Security Zones Connected to a
Backbone Network
■
Example Network and Perimeter Network Design 
■
Creating the ISA Firewall Network Representing the Corporate
Network on the Network Services Perimeter
■
Creating the Corpnet ISA Firewall Network 
■
Creating the Network Rule on the Network Services Perimeter
ISA Firewall, Setting a Route Relationship between the
Corporate Network and the Network Services Segment
■
Creating an Intradomain Communications Access Rule on the
Network Services Perimeter ISA Firewall and a DNS Server
Publishing Rule
■
Making Access Rules Running Outbound Access from the
Network Services Segment on the Perimeter ISA Firewall
■
Creating the Network Services Access Rules Giving Corpnet
Clients Access to Network Services
■
Conﬁguring the Default Internal Network on the Edge ISA
Firewall
■
Creating a Routing Table Entry on the Edge ISA Firewall
■
Joining the Edge ISA Firewall to the Domain
■
Making Access Rules on the Edge ISA Firewall; Controlling
Outbound Access from Corpnet Hosts; Hosts on the Network
Services Segment
■
Making Publishing Rules on the Edge ISA Firewall for Inbound
Connections to Exchange Server Mail Services
■
Creating a Routing Table Entry on Network Clients (Required
Only If No LAN Routers Are Installed)
Chapter 10
435

■
Joining the Network Clients to the Domain
■
Creating and Conﬁguring DNS Entries in the Domain DNS
■
Conﬁguring the Firewall and Web Proxy Client Settings on the Edge ISA Firewall, and
Enabling Autodiscovery
■
Installing the Firewall Client Share on the Network Services Segment File Server
■
Installing the Firewall Client on the Network Clients
■
Connecting the Corporate Network Clients to the Network Services Segment 
Introduction
The ISA ﬁrewall can act in a number of roles: as a front-end edge ﬁrewall that sits in front of
the entire company, as a back-end ﬁrewall located behind another edge ﬁrewall that might
be an ISA ﬁrewall or another type of ﬁrewall, or as a perimeter network ﬁrewall that walls
off critical network servers and services from the rest of the network. We’ll focus on the
third conﬁguration in this chapter.
In spite of eye-catching headlines about the death of the DMZ and the imminent
demise of network security zones, the fact is that we who live in the trenches still need to
live with the current reality, where network perimeters need to be deﬁned to provide access
controls on hosts connecting to other hosts belonging to different security zones.And
although Network Access Protection (NAP; expected to be implemented in
Longhorn/Vista) and IPSec-based domain isolation hold a lot of promise, there are and will
be signiﬁcant technological hurdles that have to be jumped before those methodologies will
be applicable for widespread use.
Instead of proclaiming the death of the DMZ, security experts should be making the
clarion call for increased perimeterization.You’ll go a long way toward improving your net-
work’s security position by grouping hosts into different security zones, and putting ﬁrewalls
and other network security devices between those zones that enable strong access controls
on communications between those zones.
In this chapter, we’ll examine the requirements and procedures involved with creating a
network services segment separated from the rest of the corporate network by an ISA ﬁre-
wall.You can put an ISA ﬁrewall in front of the network services located on the services seg-
ment to help protect those critical network services from being adversely affected by
outbreaks that take place on other network segments.
The key concept here is that only required communications are allowed to and from the
network services segment; all other communications are blocked. In addition to limiting
communications only to the hosts and protocols that are required for access, we will leverage
the ISA ﬁrewall’s advanced stateful packet and application layer inspection mechanisms to
help secure the communications allowed to the network services segment.
www.syngress.com
436
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Network Services 
Segment Conﬁguration Options
As with all network security devices, and especially for network ﬁrewalls, there is no such
thing as “one size ﬁts all” when it comes to conﬁguration.There is no replacement for
understanding how your ﬁrewall works, and how to conﬁgure it to meet your organization’s
speciﬁc requirements.
We should look at two scenarios before proceeding with a step-by-step example for
conﬁguring a network services segment behind an ISA ﬁrewall.These scenarios are:
1.
Scenario 1 A local area network (LAN) router separates the edge ISA ﬁrewall
from the rest of the corporate network.
2.
Scenario 2 No LAN router separates the edge ISA ﬁrewall from the rest of the
corporate network.
Although there are variations on the second theme, our discussions of these two sce-
narios will hopefully make clear what your conﬁguration options are when you do and don’t
have a LAN router on your network.
Scenario 1: A LAN Router between 
the ISA Firewall and Corporate Network
A high-level view of scenario 1 appears in Figure 10.1. In this scenario, there is a LAN
router between the edge ISA ﬁrewall and the rest of the network.There also is a Route rela-
tionship between all internal networks located behind the edge ISA ﬁrewall. Network
address translation (NAT) is used only for communications to the Internet.
In this scenario, hosts on the corporate network in front of the network services
perimeter ISA ﬁrewall use a default gateway that is the local address of the LAN router.The
LAN router is conﬁgured with a route of last resort (which allows it to access the Internet)
that is the internal address on the edge ISA ﬁrewall.The LAN router is conﬁgured with a
routing table entry that provides a route to the network ID located behind the network ser-
vices perimeter network ISA ﬁrewall.
When a user makes a request to a server on the network services segment located
behind the network services perimeter ISA ﬁrewall, the request is forwarded to the client’s
default gateway address, because the connection is to a nonlocal (remote) network.The
packet is forwarded based on the routing table entry on the LAN router to the Internet
Protocol (IP) address on the external interface of the network services perimeter ISA ﬁre-
wall, and then the network services perimeter ISA ﬁrewall routes the request to the server
on the network services segment.
The black arrows in Figure 10.1 show the request path, and the red arrows show the
response path.The server on the services segment sends the response to its default gateway,
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
437

which is the IP address on the internal interface of the network services segment perimeter
ISA ﬁrewall.The response is forwarded directly to the client making the request because the
ISA ﬁrewall has knowledge of all network IDs to which it is directly connected.The
response is not forwarded to the LAN router and then back to the client. Note that the
request and response paths are not the same.
Figure 10.1 A LAN Router Separating the Edge ISA Firewall from the Rest of
the Corporate Network
Figure 10.2 shows the request and response paths for connections made to the Internet.
Notice in this case that the request and response paths are the same.
Scenario 2: No LAN Router between 
the ISA Firewall and Corporate Network
Now let’s look at scenario 2, where there is no router between the ISA ﬁrewall and the rest
of the network (see Figure 10.3). In this case, the clients on the corporate network use the
internal interface of the edge ISA ﬁrewall as their default gateway address.The edge ISA ﬁre-
wall is conﬁgured with a routing table entry informing the edge ISA ﬁrewall of the correct
route to network ID 10.0.0.0/24.The ISA ﬁrewall forwards the connection to the IP address
on the external interface of the network services perimeter ISA ﬁrewall, which then routes
the connection to the server on the network services segment.
www.syngress.com
438
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
Edge ISA firewall
Services perimeter firewall
LAN Router
Network ID 192.168.1.0/24
Network ID 10.0.1.0/24
Network ID 10.0.0.0/24
File Server
Domain Controller
`
`
`
Exchange Server

Figure 10.2 Request and Response Paths for Connections Made to the
Internet
The response from the server on the network services segment is forwarded to the
server’s default gateway address, which is the IP address on the internal interface of the net-
work services perimeter ISA ﬁrewall, which in turn forwards the response directly to the
client machine that made the request. Notice that the request and response paths are not the
same.This scenario works because the ISA ﬁrewall handling trafﬁc has knowledge of and is
not dealing with response trafﬁc to connections it is not aware of.This will be made clear in
the next ﬁgure.
ISA Firewall Stateful Packet 
Inspection and Request/Response Paths
Figure 10.4 shows a scenario where a system on the network services segment needs to ini-
tiate a connection to a host on the corporate network.A network management server on the
network services segment makes a connection to a workstation on the corporate network in
front of the network services perimeter ISA ﬁrewall.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
439
Edge ISA firewall
Services perimeter firewall
LAN Router
Network ID 192.168.1.0/24
Network ID 10.0.1.0/24
Network ID 10.0.0.0/24
File Server
Domain Controller
`
`
`
Exchange Server

Figure 10.3 No Router between the ISA Firewall and the Rest of the
Network
The connection is ﬁrst sent to the network services perimeter ISA ﬁrewall’s internal
interface, as this is the default gateway of the network management server.The connection is
then sent directly to the workstation, because the ISA ﬁrewall has knowledge of all networks
to which is it directly connected.That is to say, the ISA ﬁrewall can do an Address
Resolution Protocol (ARP) broadcast to get the Media Access Control (MAC) address of
the workstation and send the request directly to that workstation.
A problem arises when the workstation tries to respond to the management server on
the network services segment. Because the destination IP address of the management server
is on a network remote from the workstation’s network ID, the workstation sends the
response to its default gateway, which is the internal interface of the edge ISA ﬁrewall.The
response trafﬁc is denied by the ISA ﬁrewall because the client is sending a SYN-ACK mes-
sage back to the management server, but the ISA ﬁrewall never “saw” the SYN message from
the management server to the workstation. Because the ISA ﬁrewall is a stateful packet
inspection ﬁrewall, it drops the SYN-ACK because it isn’t associated with a preceding SYN.
You can deal with this issue in several ways:
■
Make sure that no servers on the network services segment behind the perimeter
ISA ﬁrewall ever need to create new outbound Transmission Control Protocol
(TCP) connections to hosts on the corporate network in front of the network ser-
vices perimeter ISA ﬁrewall.This means that not only can you not place servers
making outbound connections through the network services perimeter ISA ﬁrewall,
but you also cannot use protocols where the clients make primary connections to
the servers on the network services segment and require secondary connections from
the servers on the network services segment.
www.syngress.com
440
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
Edge ISA firewall
Services perimeter firewall
Network ID 10.0.1.0/24
Network ID 10.0.0.0/24
File Server
Network Manager Server
Domain Controller
`
`
`
Exchange Server

Figure 10.4 A System on the Network Services Segment Initiating a
Connection to a Host on the Corporate Network
■
Put a LAN router between the edge ISA ﬁrewall and the rest of the corporate
network.
■
Put a LAN router between the network services segment perimeter ISA ﬁrewall
and the rest of the network.
■
Create routing table entries on the hosts located on the corporate network in front
of the network services perimeter ISA ﬁrewall so that they know the gateway
address to reach the network services segment, which in this case would be the IP
address on the external interface of the network services perimeter ISA ﬁrewall.
■
Use multiple network interface cards (NICs) on the edge ISA ﬁrewall and place
the network services segment on an ISA ﬁrewall network associated with one of
the NICs.This avoids the routing and “network with a network” scenario.
Most enterprise networks will have LAN routers in place, so it’s easy for these organiza-
tions to create the appropriate routing table entries to support this scenario. For small orga-
nizations that do not have LAN routers in place, you can get complete support for
connections to and from the network services segment by automating routing table entries
on the corporate network hosts located in front of the network services segment perimeter
ISA ﬁrewall.You could use a logon script to enter these routing table entries on the clients
using the route add –p command.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
441
Edge ISA firewall
Services perimeter firewall
Network ID 10.0.1.0/24
Network ID 10.0.0.0/24
File Server
Network Manager Server
Domain Controller
`
`
`
Exchange Server
X
X

Multiple Departmental
Networks/Security Zones 
Connected to a Backbone Network
Note that the issues mentioned earlier are speciﬁc for the “network within a network” sce-
nario and when clients systems are “on a subnet” with an edge ISA ﬁrewall that must be
reached from a host on a remote subnet that is part of the same ISA ﬁrewall network.This is
not a problem when you have a backbone network conﬁgured and all the clients and servers
are behind ISA ﬁrewalls.
For example, consider the network in Figure 10.5. In this scenario, we do not run into
similar problems because there are no host systems on the backbone network, and therefore
no host systems on a subnet of the edge ISA ﬁrewall’s internal interface.All ISA ﬁrewalls
contain routing table entries directing them to the external interface of the appropriate ISA
ﬁrewall to reach the appropriate network ID(s) located behind any speciﬁc ISA ﬁrewall.
Hosts behind each ISA ﬁrewall use the internal interface of their local ISA ﬁrewall as their
default gateway, and the routing table entries on the ISA ﬁrewalls route the connection to
the correct ISA ﬁrewall’s external interface for the remote networks.
Note that we are assuming a Route relationship between all ISA ﬁrewall networks in
this scenario.A mix of route and NAT relationships will work too, and can potentially sim-
plify the routing table entries because segments that use a NAT relationship do not require
routing table entries on the ISA ﬁrewall to reach the addresses behind the NAT.The
responder only needs to reach the IP address on the external interface of the ISA ﬁrewall
sending the connection, and in a backbone network scenario, all the external interfaces are
likely on the same network ID. Whether you decide to use a route or NAT relationship
depends on the type of access required.
Figure 10.5 A Network with No Host Systems on the Backbone Network
www.syngress.com
442
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
Edge ISA Firewall
ISA Firewall
Network ID 10.0.0.0/24
Domain Controller
`
`
`
Exchange Server
ISA Firewall
ISA Firewall
Network ID 10.0.1.0/24
Network ID 10.0.2.0/24
Network ID 10.0.3.0/24

Note that for the route conﬁguration to work most efﬁciently, each ISA ﬁrewall requires
the appropriate routing table entries.You could get around this requirement if each ISA ﬁre-
wall used the edge ISA ﬁrewall as its default gateway, and the edge ISA ﬁrewall contained
the appropriate routing table entries.This solution could potentially work, but performance
would be abysmal because the edge ISA ﬁrewall would be routing connections between all
network IDs on the corporate network.
Example Network and 
Perimeter Network Design
In this chapter, we will use the sample network shown in Figure 10.6 and outlined here:
■
The default gateway for all servers on the network services segment will be the IP
address on the internal interface of the network services perimeter ISA ﬁrewall.
■
The default gateway for all hosts on the corporate network containing client sys-
tems is the IP address on the internal interface of the edge ISA ﬁrewall.
■
Client systems are conﬁgured with a routing table entry that forwards connections
to network ID 10.0.0.0/24 to the IP address on the external interface of the net-
work services perimeter ISA ﬁrewall.This is required because we do not have a
LAN router in this conﬁguration.
Figure 10.6 Our Sample Network
A Windows 2000 ﬁle server and an Exchange 2003 server are located on the network ser-
vices segment.The Exchange server is also a domain controller, domain name system (DNS)
server,Windows Internet Name Service (WINS) server, Dynamic Host Conﬁguration
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
443
Edge ISA firewall
Services perimeter firewall
Network ID 10.0.1.0/24
Network ID 10.0.0.0/24
File Server
`
XP Service Pack 2 Client
Exchange Server
10.0.1.1
10.0.1.15
Routing Table Entry for 
10.0.0.0/24
10.0.0.25
10.0.1.2
10.0.0.1
10.0.0.2
Default Gateway for all 
Hosts on this Network is:
10.0.0.1
Default Gateway for all 
Hosts on this Network is:
10.0.1.1

Protocol (DHCP) server, certiﬁcate server, and Remote Authentication Dial-in User Service
(RADIUS) server.We will create Access Rules that enable connections to all the network ser-
vices on the Exchange server and to ﬁle shares on the ﬁle server.The ﬁle server will host the
Firewall client installation ﬁles so that we can avoid allowing ﬁle sharing protocols to any por-
tion of the ISA ﬁrewall’s local host network.The network services perimeter ISA ﬁrewall is
already joined to the domain.
We will perform the following procedures:
■
Create an ISA ﬁrewall network representing the corporate network on the net-
work services perimeter ISA ﬁrewall.
■
Create a network rule on the network services perimeter ISA ﬁrewall that sets a
Route relationship between the corporate network and the network services network.
■
Create an intradomain communications Access Rule on the network services
perimeter ISA ﬁrewall that allows corporate network hosts access to the domain
controller on the services segment for intradomain communications, and a DNS
Server Publishing Rule that enables the DNS application layer inspection ﬁlter.
■
Create Access Rules controlling outbound access from the network services seg-
ment on the perimeter ISA ﬁrewall.
■
Create network services Access Rules on the network services perimeter ISA ﬁre-
wall enabling client access to network services, such as Outlook Web Access
(OWA), Outlook Messaging Application Programming Interface (MAPI), Simple
Mail Transfer Protocol (STMP), Postofﬁce Protocol version 3 (POP3), and Internet
Message Access Protocol version 4 (IMAP4), and ﬁle shares.
■
Create a routing table entry on the edge ISA ﬁrewall providing a path to the net-
work services segment network ID.
■
Join the front-end ISA ﬁrewall to the domain.
■
Create a routing table entry on the network clients (required only if no LAN
routers are installed) providing route information to reach the network services
segment network ID.
■
Join the network clients to the domain.
■
Create a WPAD entry in DNS to enable autodiscovery for ﬁrewall and Web proxy
clients.
■
Conﬁgure the Firewall client settings on the edge ISA ﬁrewall (including Web
proxy client conﬁguration).
■
Install the Firewall client share on the network services segment ﬁle server.
■
Install the Firewall client on the network clients.
■
Connect the corporate network clients to resources on the network services 
segment and the Internet.
www.syngress.com
444
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Creating the ISA Representing 
the Corporate Network on the 
Network Services Perimeter
One of the most prevalent misconceptions regarding ISA ﬁrewall networks and how the ISA
ﬁrewall sees the network world is how the ISA ﬁrewall deals with the default external net-
work. Let’s set the record straight:The default external network on the ISA ﬁrewall is deﬁned
as any IP address that is not part of any other ISA ﬁrewall network deﬁned on the ISA ﬁrewall.
This means you can conﬁgure any collection of IP addresses that aren’t part of another
ISA ﬁrewall network to be part of a custom ISA ﬁrewall network.This includes the IP
address(es) bound to the external interface of the ISA ﬁrewall (although the addresses on the
external interface of the ISA ﬁrewall will always belong to the local host network).
This allows us to create a custom ISA ﬁrewall network that includes the IP addresses
used on the corporate network between the edge ISA ﬁrewall and the network services
perimeter ISA ﬁrewall.These addresses do not need to be part of the default external net-
work, even though the corporate network is on the same network ID as the external interface
of the ISA ﬁrewall.The term external interface only means that it’s the interface with the
default gateway conﬁgured on it, which typically is the closest to the Internet.
NOTE
Although the term external interface is used to denote the NIC that has the
default gateway conﬁgured on it, the fact is that you can conﬁgure an ISA ﬁre-
wall that has no default gateway. This ISA ﬁrewall won’t be able to access the
Internet, and hosts serviced by that ISA ﬁrewall won’t be able to access the
Internet, but it illustrates that an ISA ﬁrewall does not require an external 
interface.
The value in making the corporate network located between the edge ISA ﬁrewall and
the network services perimeter ISA ﬁrewall a separate ISA ﬁrewall network is that you can
control the routing relationship between that network and any other network deﬁned on the
ISA ﬁrewall.
In the example network used in this chapter, conﬁguring a custom corporate ISA ﬁre-
wall network on the network perimeter services segment ISA ﬁrewall will enable us to
create a Route relationship between the default internal network behind the back-end ISA
ﬁrewall and the corporate network located between the edge ISA ﬁrewall and the network
services ISA perimeter ISA ﬁrewall. We can also create Access Rules controlling trafﬁc
moving to and from any ISA ﬁrewall network.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
445

Creating the Corpnet 
ISA Firewall Network
Perform the following steps on the network services perimeter ISA ﬁrewall to create the
Corpnet ISA ﬁrewall network:
1.
In the ISA ﬁrewall console, expand the server name and then expand the
Conﬁguration node. Click the Networks node.
2.
On the Networks node, click the Networks tab in the Details pane. Click the
Tasks tab in the Task pane and then click the Create a New Network link.
3.
On the Welcome to the New Network Wizard page, enter a name for the
network in the Network name text box. In this example, we’ll name the network
Corpnet. Click Next.
4.
On the Network Type page, select the Perimeter Network option and click
Next.
5.
On the Network Address page, click the Add button.
6.
In the IP Address Range Properties dialog box, enter the Starting address and
Ending address for the Corpnet ISA ﬁrewall network. In this example, we’ll enter
10.0.1.0 for the Starting address and 10.0.1.255 for the Ending address (see
Figure 10.7). Note that you don’t have to include the entire network ID; you can
include only the addresses that are actually in use on that network, or you can get
even more granular and include only the addresses that you want to have a Route
relationship with the default Internet network behind the network services
perimeter ISA ﬁrewall so that you can later create another ISA ﬁrewall network rep-
resenting other addresses on the corporate network that you want to create a NAT
relationship with. Click OK, and then click Next. Figure 10.8 shows the results.
Figure 10.7 Entering IP Address Range Properties
446
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
www.syngress.com

Figure 10.8 Network Address Ranges
8.
Click Finish on the Completing the New Network Wizard page. Figure 10.9
shows the results.
Figure 10.9 The Corpnet ISA Firewall Network
Creating the Rule on the Network
Services Perimeter ISA, Setting a Route
Relationship between the Corporate
Network and Network Services Segment
In the scenario discussed in this chapter, the hosts on the corporate network are members of
a domain that has its domain controllers located behind the network services perimeter ISA
ﬁrewall.
An Access Rule must be created allowing hosts on the corporate network to communi-
cate with the domain controller on the network services segment. Intradomain communica-
tions require that you have a Route relationship between the source and destination
networks. For this reason, we will create a network rule that sets a Route relationship
between the corporate network and the default internal network located behind the net-
work services perimeter ISA ﬁrewall.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
447

It’s important to note that although there will be a Route relationship between the net-
work services perimeter ISA ﬁrewall’s default internal network and the Corpnet network,
there will still be a NAT relationship between the network services perimeter ISA ﬁrewall’s
default internal network and the Internet.This is fully supported (and required), because pri-
vate addresses are used on all networks behind the edge ISA ﬁrewall (in this scenario).
Creating the Network Rule Deﬁning a Route
Relationship between the Corpnet ISA Firewall
Network and the Default Internal Network
Perform the following steps to create the network rule creating a Route relationship
between the Corpnet network and the default internal network behind the network services
perimeter ISA ﬁrewall:
1.
In the ISA ﬁrewall console, expand the server name and then expand the
Conﬁguration node in the left pane of the console. Click the Networks node.
2.
On the Networks node, click the Network Rules tab in the Details pane of the
console, then click the Create a New Network Rule link in the Tasks tab of
the Task pane.
3.
On the Welcome to the New Network Rule Wizard page, enter a name for
the rule in the Network rule name text box. In this example, we’ll name the
rule Corpnet—Internal (the default internal network behind the network ser-
vices perimeter ISA ﬁrewall represents the network services segment). Click Next.
4.
On the Network Trafﬁc Sources page, click the Add button.
5.
In the Add Network Entities dialog box, click the Networks folder and then
double click the Corpnet network. Click Close (see Figure 10.10).
Figure 10.10 Adding Network Entities
448
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
www.syngress.com

6.
Click Next on the Network Trafﬁc Sources page.
7.
Click Add on the Network Trafﬁc Destinations page.
8.
Click the Networks folder and then double click the Internal entry. Click
Close.
9.
On the Network Relationship page, select the Route option and click Next
(see Figure 10.11).
Figure 10.11 Specifying That the ISA Server Should Send Trafﬁc between the
Source and Destination Network Entities
10.
Click Finish on the Completing the New Network Rule Wizard page.
Figure 10.12 shows the results.
Figure 10.12 The Completed Network Rule 
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
449

Creating an Intradomain
Communications Access Rule on the
Network Services Perimeter ISA Firewall
and a DNS Server Publishing Rule 
Multiple protocols are required to allow intradomain communications between hosts on the
corporate network and domain controllers on the corporate network.Table 10.1 provides the
details of this Access Rule.Table 10.2 provides details of the DNS Server Publishing Rule.
Table 10.1 Access Rule Allowing Intradomain Communications between the
DMZ Host and the Domain Controller on the Default Internal Network behind
the Back-End ISA Firewall
Name
Intradomain Corpnet—Internal
Action
Allow
Protocols
Microsoft CIFS (TCP)
Microsoft CIFS (UDP)
Kerberos-Adm (UDP)
Kerberos-Sec (TCP)
Kerberos-Sec (UDP)
LDAP
LDAP (UDP)
LDAP GC (Global Catalog)
RPC (all interfaces)
NTP (UDP)
Ping
From
Corpnet
To
Domain Controller
Users
All
Schedule
Always
Content Types
All Content Types
Table 10.2 DNS Server Publishing Rule 
Name
Publish Domain DNS
Action
Allow
Protocols
DNS Server
Listener
Corpnet
www.syngress.com
450
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
Continued

Table 10.2 continued DNS Server Publishing Rule 
To
10.0.0.2
Schedule
Always
Note that we are using an Access Rule rather than a Publishing Rule to allow access
from the Corpnet ISA ﬁrewall network and the network services segment network.This is
because we have a Route relationship between these two networks.As such, we have no
need or ability to hide the addresses of the servers on the network services segment.
You might be concerned that you won’t be able to leverage the ISA ﬁrewall’s deep
application layer inspection application ﬁlters when using Access Rules, but the fact is that
you can beneﬁt from the application layer ﬁlters for most protocols. If you check the pro-
tocol deﬁnitions associated with the application ﬁlters, you’ll see that both inbound and out-
bound protocol deﬁnitions have the application layer inspection ﬁlters bound to them.
Unfortunately, the DNS ﬁlter is not one of the ﬁlters that you can use for both inbound
and outbound access to stateful application layer inspection. Even though you can bind the
DNS application layer inspection ﬁlter to the outbound DNS protocol deﬁnition in the user
interface, the ﬁlter will have no effect.
You can test this yourself by binding the DNS application layer inspection ﬁlter to the
outbound DNS protocol and then creating an Access Rule from the Corpnet network to
the network services segment network using this DNS protocol deﬁnition. Now block DNS
zone transfers in the Enable Intrusion Detection and DNS Attack Detection dialog
box.After creating the Access Rule and conﬁguring DNS intrusion detection, try to perform
a DNS zone transfer using the nslookup utility and issuing the ls –d <domain_name.> com-
mand.You’ll ﬁnd that you can perform the zone transfers. In contrast, if you created a DNS
Server Publishing Rule, the zone transfer would fail because the DNS application layer
inspection ﬁlter would detect the intrusion.
For this reason, we will create two rules: a Server Publishing Rule for DNS communica-
tions and an Access Rule for all other intradomain communications.Although we could sim-
plify the conﬁguration by including the DNS protocol in the intradomain communications
Access Rule, we would miss out on the added protection provided by the DNS ﬁlter.
Creating the Intradomain Communications Rule
Perform the following steps to create the intradomain communications Access Rule on the
network services perimeter ISA ﬁrewall:
1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node in the left pane of the console.
2.
On the Firewall Policy node, click the Tasks tab in the Task pane and click the
Create New Access Rule link.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
451

3.
On the Welcome to the New Access Rule Wizard page, enter the name of
the rule in the Access Rule name text box. In this example, we’ll name the rule
Intradomain Corpnet—Internal. Click Next.
4.
Select the Allow option on the Rule Action page.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list. Click Add.
6.
Click the Add Protocols folder and then double click the following protocols:
Microsoft CIFS (TCP)
Microsoft CIFS (UDP)
DNS
Kerberos-Adm (UDP)
Kerberos-Sec (TCP)
Kerberos-Sec (UDP)
LDAP
LDAP (UDP)
LDAP GC (Global Catalog)
RPC (all interfaces)
NTP (UDP)
Ping
7.
Click Close in the Add Protocols dialog box.
8.
Click Next on the Protocols page (see Figure 10.13).
Figure 10.13 Selecting Protocols to Which to Apply Rules
9.
On the Access Rule Sources page, click the Add button.
10.
In the Add Network Entities dialog box, double click the Corpnet entry and
then click Close.
www.syngress.com
452
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

11.
Click Next on the Access Rule Sources page.
12.
Click Add on the Access Rule Destinations page.
13.
In the Add Network Entities dialog box, click the New menu and then click
Computer.
14.
In the New Computer Rule Element dialog box, enter a name for the domain
controller on the internal network (the network services segment). In this
example, we’ll name the computer Object Domain Controller. Enter the IP
address of the domain controller in the Computer IP Address text box. Enter an
optional Description if you like. Click OK (see Figure 10.14).
Figure 10.14 Naming the Domain Controller on the Internal Network
15.
In the Add Network Entities dialog box, click the Computers folder and then
double click on the Domain Controller entry. Click Close.
16.
Click Next on the Access Rule Destinations page (see Figure 10.15).
Figure 10.15 Specifying Access Rule Destinations
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
453

17.
Accept the default setting, All Users, on the User Sets page and click Next.
18.
Click Finish on the Completing the New Access Rule Wizard page.
Creating the DNS Server Publishing Rule 
The next step is to create the DNS Server Publishing Rule. Perform the following steps on
the network services perimeter ISA ﬁrewall to create the DNS Server Publishing Rule:
1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab in the Task pane and then
click the Create a New Server Publishing Rule link.
3.
On the Welcome to the New Server Publishing Rule Wizard page, enter a
name for the rule in the Server Publishing Rule name text box. In this
example, we’ll name the rule Publish Domain DNS. Click Next.
4.
On the Select Server page, enter the IP address of the DNS server for the
domain in the Server IP address text box. In this example, the domain’s DNS
server is located on the domain controller, which is at IP address 10.0.0.2. We
enter this IP address into the text box and click Next (see Figure 10.16).
Figure 10.16 Selecting a Server
5.
On the Select Protocol page, select the DNS Server option from the Selected
protocol list. Click Next (Figure 10.17).
6.
On the IP Address page, put a checkmark in the checkbox next to Corpnet and
click Next (see Figure 10.18).There is an interesting vagary to this setting, which
I’ll talk more about at the end of this section.
www.syngress.com
454
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.17 Selecting the Protocol
Figure 10.18 Choosing the Networks That Will Listen for Requests
7.
Click Finish on the Completing the New Server Publishing Rule Wizard
page.
I mentioned that there is an interesting twist to Server Publishing Rules when you have
a Route relationship between the source and destination ISA ﬁrewall networks.To fully
appreciate the situation, let’s ﬁrst examine what happens when there is a NAT relationship
between the published server and the external client.
When there is a NAT relationship between the published server and the external client,
the external client reaches the published server using the IP address on the external interface of
the ISA ﬁrewall conﬁgured to listen for incoming connections for that speciﬁc Server Publishing
Rule.
For example, if there were a NAT relationship between the published DNS server and
the Corpnet network, we could choose the IP address 10.0.1.2 on the external interface of
the network services perimeter ISA ﬁrewall as the listening address. Hosts that need to reach
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
455

the published server would send DNS queries to the IP address used in the Server
Publishing Rule listener, not the actual IP address of the published Web server.
In contrast, when there is a Route relationship between the source and destination ISA
ﬁrewall networks, the external client reaches the published DNS server (or any other server
except a Web server published using a Web Publishing Rule) using the actual IP address of the
published server. So, even though we’ve created a DNS Server Publishing Rule that has a lis-
tener on the external interface of the network services perimeter ISA ﬁrewall, the external
clients must use the actual IP address to reach the DNS server, which in this case is 10.0.0.2.
The ISA ﬁrewall uses a method referred to as port stealing to make this possible.
Creating Access Rules 
Controlling Outbound Access 
from the Network Services Segment 
on the Perimeter ISA Firewall
You must create Access Rules allowing new outbound connections from hosts on the net-
work services segment and any other network. In most cases, the only outbound connections
you’ll want to allow are those that enable access to the Windows update site or the Windows
Server Update Service (WSUS) server on the corporate network.You would also likely want
to enable outbound access to public DNS servers if your domain DNS servers are also pro-
viding Internet host name resolution.
Exactly what you want to allow as outbound from the servers on the network services
segment is going to be very speciﬁc to your own implementation. In our current example,
we’re going to allow only outbound DNS trafﬁc from the DNS server and outbound
Hypertext Transfer Protocol (HTTP) and Hypertext Transfer Protocol Secure (HTTPS)
trafﬁc from all hosts on the network services segment to the Windows Update sites.
NOTE
You do not need to create outbound Access Rules from the network services
segment to the Corpnet ISA ﬁrewall network to support the inbound Access
Rules from the Corpnet ISA ﬁrewall network to the network services segment
network. The ISA ﬁrewall is a stateful packet inspection ﬁrewall and will auto-
matically allow responses to requests made from hosts on the Corpnet network.
www.syngress.com
456
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Creating the Access Rule Allowing DNS Trafﬁc
from the DNS Server to the Internet
Perform the following steps to create the Access Rule:
1.
At the back-end ISA ﬁrewall, in the ISA ﬁrewall console, expand the name of the
server and then click the Firewall Policy node in the left pane of the console.
2.
Click the Create New Access Rule link on the Tasks tab in the Task pane.
3.
In the Welcome to the New Access Rule dialog box, enter a name for the rule
in the Access Rule name text box. In this example, we’ll name the rule DNS to
External. Click Next.
4.
On the Rule Action page, select the Allow option and click Next.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list. Click Add.
6.
Click the Common Protocols folder and then double click the DNS entry.
Click Close.
7.
Click Next on the Protocols page.
8.
On the Access Rule Sources page, click the Add button.
9.
In the Add Network Entities dialog box, click the Computers folder and
double click the Domain Controller entry. Click Close.
10.
Click Next on the Access Rule Sources page.
11.
On the Access Rule Destinations page, click the Add button.
12.
In the Add Network Entities dialog box, click the Networks folder. Double
click the External network. Click Close.
13.
Click Next on the Access Rule Destinations page.
14.
On the User Sets page, accept the default entry, All Users, and click Next.
15.
Click Finish on the Completing the New Access Rule Wizard page.
Creating the Access Rule Allowing Outbound
Windows Update and Microsoft Reporting
Perform the following steps to create the HTTP/HTTPS Access Rule allowing access to the
Windows Update and Reporting sites:
1.
At the back-end ISA ﬁrewall, in the ISA ﬁrewall console, expand the name of the
server and then click the Firewall Policy node in the left pane of the console.
2.
Click the Create New Access Rule link on the Tasks tab in the Task pane.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
457

3.
In the Welcome to the New Access Rule dialog box, enter a name for the rule
in the Access Rule name text box. In this example, we’ll name the rule
Outbound to WU and MS Reporting. Click Next.
4.
On the Rule Action page, select the Allow option and click Next.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list. Click Add.
6.
Click the Common Protocols folder and then double click the HTTP and
HTTPS entries. Click Close.
7.
Click Next on the Protocols page.
8.
On the Access Rule Sources page, click the Add button.
9.
In the Add Network Entities dialog box, click the Networks folder and double
click the Internal entry. Click Close.
10.
Click Next on the Access Rule Sources page.
11.
On the Access Rule Destinations page, click the Add button.
12.
In the Add Network Entities dialog box, click the Domain Name Sets folder.
Double click the Microsoft Error Reporting sites and System Policy
Allowed Sites entries. Click Close.
13.
Click Next on the Access Rule Destinations page.
14.
On the User Sets page, accept the default entry, All Users, and click Next.
15.
Click Finish on the Completing the New Access Rule Wizard page.
16.
Click Apply to save the changes and update the ﬁrewall policy.
17.
Click OK in the Apply New Conﬁguration dialog box.
Your ﬁrewall policy should look like Figure 10.19.
Figure 10.19 The Completed Firewall Policy
www.syngress.com
458
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Creating the Network Services Access
Rules Enabling Corpnet Clients Access
to Network Services
Now we’re ready to create Publishing Rules and Access Rules that allow hosts on the
Corpnet ISA ﬁrewall network and external clients on the Internet to access Exchange server
and ﬁle server resources on the network services segment. Hosts on the Corpnet ISA ﬁrewall
network will be able to connect to Exchange server and ﬁle server resources by going
through the network services segment perimeter ISA ﬁrewall. Hosts on the Internet will
need to traverse both the edge ISA ﬁrewall and the network services segment perimeter ISA
ﬁrewall. Later we will create the rules on the edge ISA ﬁrewall to enable access to network
services perimeter resources.
In this section, we will do the following:
■
Create an OWA Web Publishing Rule on the network services perimeter ISA 
ﬁrewall.
■
Create SMTP, POP3, and IMAP4 Server Publishing Rules.
■
Create an Access Rule allowing access to ﬁle shares on the ﬁle server.
In our scenario on creating network services segments using ISA ﬁrewalls, I will assume
that you have already deployed your certiﬁcate infrastructure and have already requested the
appropriate Web site certiﬁcates to support Secure Sockets Layer/Transaction Layer Security
(SSL/TLS) connections to the Exchange server’s e-mail services.
If you haven’t done this and are not sure how to start, I highly recommend the ISA
Server 2004/Exchange Server deployment kit documents I created for Microsoft at
http://download.microsoft.com/download/1/8/8/188ab94a-4ec5-4746-ac0f-
a18177040fbf/isa2004se_exchangekit-rev%201%2005.doc (note that this is a very large doc-
ument; if you need an individual Word ﬁle that applies to your network conﬁguration from
one of the chapters in the deployment kit doc, write to me at tshinder@isaserver.org and I’ll
send you the separate doc).
In the scenario used in this chapter, we’ve bound certiﬁcates to the OWA Web site, the
SMTP site, the POP3 site, and the IMAP4 site on the Exchange server on the network ser-
vices segment.Table 10.3 shows the common/subject names on the certiﬁcates bound to
each site.
Table 10.3 Common/Subject Names Bound to Exchange Server Services
Exchange Server Service
Common/Subject Name on Web Site Certiﬁcate
OWA
owa.msﬁrewall.org
SMTP
mail.msﬁrewall.org
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
459
Continued

Table 10.3 continued Common/Subject Names Bound to Exchange Server
Services
Exchange Server Service
Common/Subject Name on Web Site Certiﬁcate
POP3
pop3.msﬁrewall.org
IMAP4
imap4.msﬁrewall.org
In the following sections, we will create Access Rules, Web Publishing Rules, and Server
Publishing Rules with the characteristics listed in Table 10.4.
Table 10.4 Resulting Firewall Policy on the Network Services Perimeter ISA
Firewall
Order
Name
Action
Protocols
From/Listener
To
Condition
1
Exchange 
Allow
IMAPS 
Corpnet
10.0.0.2
N/A
Server 
Server
IMAPS 
Server
Allow
POP3S 
Corpnet
10.0.0.2
N/A
2
Exchange 
Server
Server 
POP3S 
Server
3
Exchange 
Allow
SMTP 
Corpnet
10.0.0.2
N/A
Server 
Server
SMTP 
Server
4
Exchange 
Allow
IMAP4 
Corpnet
10.0.0.2
N/A
Server 
Server
IMAP4 
Server
5
Exchange 
Allow
POP3 Server Corpnet
10.0.0.2
N/A
Server POP3
Server
6
Exchange 
Allow
SMTPS 
Corpnet
10.0.0.2
N/A
Server 
Server
SMTPS 
Server
7
Publish 
Allow
HTTPS
OWA 
owa.ms
All 
OWA
Listener
ﬁrewall.org
Authen-
ticated Users
8
Publish DNSAllow
DNS Server Corpnet
10.0.0.2
9
DNS to 
Allow
DNS
Domain 
External
All Users
External
Controller
www.syngress.com
460
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
Continued

Table 10.4 continued Resulting Firewall Policy on the Network Services
Perimeter ISA Firewall
Order
Name
Action
Protocols
From/Listener
To
Condition
10
Outbound Allow
HTTP
Internal
Microsoft 
All Users
WU and 
HTTPS
Error 
MS 
Reporting
Reporting
Sites
System 
Policy 
Allowed Sites
11
Intradomain Allow
Kerberos-
Corpnet
Domain 
All Users
Corpnet—
Adm (UDP)
Controller
Internal
Kerberos-
Sec (TCP)
Kerberos-
Sec (UDP)
LDAP
LDAP (UDP)
LDAP GC 
(Global 
Catalog)
Microsoft 
CIFS (TCP)
Microsoft 
CIFS (UDP)
NTP (UDP)
Ping
RPC (all 
interfaces)
12
File 
Allow
Microsoft 
Corpnet
File Server 1
All Users
Server 
CIFS (TCP)
Access
Microsoft 
CIFS (UDP)
To simplify the conﬁguration, we’ll leverage the ISA ﬁrewall’s Mail Server Publishing
Wizard to create multiple Publishing Rules simultaneously.
Creating an OWA Publishing Rule on the
Network Services Perimeter ISA Firewall
Perform the following steps on the network services perimeter ISA ﬁrewall to create the
Web Publishing Rule that publishes the OWA Web site:
1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
461

2.
On the Firewall Policy node, click the Tasks tab in the Task pane and then
click the Publish a Mail Server link.
3.
On the Welcome to the New Mail Server Publishing Rule Wizard page,
enter a name for the rule in the Mail Server Publishing Rule name text box.
In this example, we’ll name the rule Publish OWA. Click Next.
4.
On the Select Access Type page, select the Web client access: Outlook Web
Access (OWA), Outlook Mobile Access, Exchange Server ActiveSync
option and click Next.
5.
On the Select Services page, select the Outlook Web Access checkbox and
click Next (see Figure 10.20).
Figure 10.20 Selecting Services to Publish 
6.
On the Bridging Mode page, select the Secure connection to clients and
mail server option.This enables SSL-to-SSL bridging. Click Next (see 
Figure 10.21).
Figure 10.21 Enabling SSL-to-SSL Bridging
462
Chapter 10 • Firewall and DMZ Design: ISA Server 2005
www.syngress.com

7.
On the Specify the Web Mail Server page, enter the name on the Web site cer-
tiﬁcate bound to the OWA Web site. In this example, the name is
owa.msﬁrewall.org. Keep in mind that the ISA ﬁrewall will need to resolve this
name to the actual IP address of the OWA site on the network services segment.You
can do this with a HOSTS ﬁle entry on the ISA ﬁrewall, or set up a split DNS
infrastructure.
The split DNS infrastructure might be challenging in this scenario, because as
you’ll see later, we would need to create a triple split DNS to support name reso-
lution for the ISA ﬁrewall itself, for hosts on the corporate network, and for hosts
located on the Internet.Although putting together a well-designed split DNS
infrastructure is fairly simple, some network admins have misconceptions that it’s
either insecure or difﬁcult to manage. Both misconceptions are patently incorrect
and you should not fall prey to them. We will create the HOSTS ﬁle entry on the
network services perimeter ISA ﬁrewall after we’ve created all the Publishing and
Access Rules. Click Next (see Figure 10.22).
Figure 10.22 Specifying the Web Mail Server
8.
On the Public Name Details page, select the This domain name (type
below) in the Accept requests for list. Enter the common/subject name on the
Web site certiﬁcate that will be bound to the Web listener for this Web Publishing
Rule. In this example, we have exported the Web site certiﬁcate bound to the
OWA Web site and imported it into the machine certiﬁcate stored on the ISA
ﬁrewall. Because this is the same certiﬁcate, it has the same common/subject name.
Therefore, we enter owa.msﬁrewall.org in the Public name text box. Click
Next (see Figure 10.23).
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
463

Figure 10.23 Specifying the Public Domain Name
9.
On the Select Web Listener page, click the New button.
10.
On the Welcome to the New Web Listener Wizard page, enter a name for the
listener in the Web listener name text box. In this example, we’ll name the Web
listener OWA Listener. Click Next.
11.
On the IP Addresses page, put a checkmark in the Corpnet checkbox and click
Next.
12.
On the Port Speciﬁcation page, remove the checkmark from the Enable
HTTP checkbox and put a checkmark in the Enable SSL checkbox. Click the
Select button.
13.
Select the OWA Web site certiﬁcate from the list in the Select Certiﬁcate dialog
box and click OK (see Figure 10.24).
Figure 10.24 Selecting a Certiﬁcate
www.syngress.com
464
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

14.
Click Next on the Port Speciﬁcation page.
15.
Click Finish on the Completing the New Web Listener page.
16.
On the Select Web Listener page, click the Edit button.
17.
On the OWA Listener Properties dialog box, click the Preferences tab.
18.
On the Preferences tab, click the Authentication button.
19.
In the Authentication dialog box, remove the checkmark from the Integrated
checkbox. Click OK in the dialog box informing you that you don’t have any
authentication methods conﬁgured. Put a checkmark in the OWA Forms-based
checkbox. Put a checkmark in the Require all users to authenticate checkbox.
Click OK (see Figure 10.25).
Figure 10.25 Specifying Authentication Methods and Settings
20.
Click OK in the OWA Listener Properties dialog box.
21.
Click Next on the Select Web Listener page (see Figure 10.26).
22.
On the User Sets page, click the All Users entry and click Remove. Click the
Add button.
23.
In the Add Users dialog box, double click the All Authenticated Users entry
and click Close.
24.
Click Next on the User Sets page.
25.
Click Finish on the Completing the New Mail Server Publishing Rule
Wizard page.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
465

Figure 10.26 Selecting the Web Listener
Your ﬁrewall policy should like that in Figure 10.27.
Figure 10.27 The Completed Firewall Policy
Creating SMTP, POP3, 
and IMAP4 Server Publishing Rules 
The next step is to create the Server Publishing Rules that publish the rest of the Exchange
server services.These include Server Publishing Rules for Secure Exchange RPC, SMTP,
POP3, and IMAP4. We have the option to create these rules separately or all at once by
using the Mail Server Publishing Wizard. We’ll use the latter option to simplify things.
You might notice that we’re not going to create a secure Exchange RPC Server
Publishing Rule in this example, for the following reasons:
■
We’re using a Route relationship between the Corpnet ISA ﬁrewall network and
the network services segment.
www.syngress.com
466
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

■
The intradomain communications Access Rule is conﬁgured to allow inbound
TCP 135 communications (the RPC [all interfaces] protocol deﬁnition).
Because we are using a Route relationship rather than a NAT relationship between the
source and destination networks, we can’t bind a speciﬁc IP address to the listener used in
the Server Publishing Rule. When you use a Route relationship, the Server Publishing Rule
listens on all addresses bound to the external interface using a feature known internally as
port stealing. Because both the Secure Exchange RPC Server Publishing Rule and the RPC
(all interfaces) component of the intradomain communications Access Rule are listening for
similar communications, we end up with a conﬂict that prevents Outlook MAPI clients from
connecting to Directory Services.
If there were a NAT relationship between the Corpnet network and the network ser-
vices segment, we could bind multiple IP addresses to the external interface of the network
services perimeter ISA ﬁrewall.Then we could create two rules—one for Secure Exchange
RPC publishing and the other for RPC (all interfaces)—and use a different listening address
for each rule. Machines on the Corpnet ISA ﬁrewall network would then connect to Secure
Exchange RPC services or RPC (all interfaces) services using the IP address used for their
respective rule’s listener.This works because connections are made to the IP addresses on the
ISA ﬁrewall’s external interface when you have a NAT relationship between the network
services segment and the Corpnet ISA ﬁrewall network.
It doesn’t work when there is a Route relationship between the network services seg-
ment and the Corpnet ISA ﬁrewall network because hosts on the Corpnet ISA ﬁrewall net-
work connect to the Exchange server using the actual IP address of the Exchange server. Because
the hosts are connecting to the IP address of the Exchange server itself and not an IP address
on the external interface of the ISA ﬁrewall, the ISA ﬁrewall’s port stealing mechanism must
listen and intercept RPC communications on all IP addresses of the external interface.This
breaks the granularity required to allow both a Secure Exchange RPC Server Publishing
Rule and an RPC (all interfaces) Access Rule on the same ISA ﬁrewall when there is a
Route relationship between the source and destination ISA ﬁrewall networks.
You can conﬁrm this by creating a secure Exchange RPC Server Publishing Rule in the
scenario used in this chapter.Then attempt to make a connection to the Exchange server
from the full Outlook MAPI client using RPC (don’t use RPC/HTTP, because the inbound
connection is HTTP, so the ISA ﬁrewall doesn’t see the RPC communications tunneled in
the HTTP header).You’ll see that the connection seems to establish successfully, but if you
open the Connection Status window in Outlook 2003, you’ll ﬁnd that the RPC connec-
tions are successful only to the Exchange server’s Mail Services. No connection is established
to Directory Services.
Creating Server Publishing 
Rules for POP3, IMAP4, and SMTP
Perform the following steps to create the Server Publishing Rules on the network services
perimeter ISA ﬁrewall:
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
467

1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and click the
Publish a Mail Server link.
3.
On the Welcome to the New Mail Server Publishing Rule Wizard page,
enter a name for the rule in the Mail Server Publishing Rule name text box.
In this example, we’ll name the rule Exchange Server. Click Next.
4.
On the Select Access Type page, select the Client access: RPC, IMAP, POP3,
SMTP option and click Next (see Figure 10.28).
Figure 10.28 Selecting the Access Type
5.
On the Select Services page, put a checkmark in each checkbox.This will allow
us to connect to the Exchange server on the network services segment through
the network services perimeter ISA ﬁrewall for all the services listed on this page
(with the exception of the Exchange server’s Network News Transfer Protocol
[NNTP] service; we could create a separate rule for that if required). Note the
comment on the page regarding the SMTP Message Screener. We will not deploy
the message screener in this example, but you might want to consider it in your
own deployment.You can install the SMTP Message Screener on the ISA ﬁrewall
to ﬁlter both inbound and outbound mail. Even though the SMTP Message
Screener won’t be enabled, the SMTP ﬁlter is enabled and will protect SMTP
communications moving through the network services perimeter ISA ﬁrewall.
Click Next (see Figure 10.29).
www.syngress.com
468
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.29 Selecting the Services to Publish
6.
On the Select Server page, enter the IP address of the Exchange server in the
Server IP address text box. In this example, the Exchange server’s IP address is
10.0.0.2, so we enter that value. Click Next.
7.
On the IP Addresses page, put a checkmark in the Corpnet checkbox. Click
Next.
8.
Click Finish on the Completing the New Mail Server Publishing Rule
Wizard page.
Your ﬁrewall policy should appear similar to that in Figure 10.30. Note that the Mail
Server Publishing Rule Wizard added seven new Server Publishing Rules. Click Apply to
save the changes and update the ﬁrewall policy. Click OK in the Apply New
Conﬁguration dialog box.
Figure 10.30 The Completed Firewall Policy
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
469

Creating an Access Rule Allowing 
Access to File Shares on the File Server
Now we can create the Access Rule allowing connections to ﬁle shares on the ﬁle server on
the network services segment. We can enable either NetBIOS protocols or Direct Hosting
(TCP 445). In this example, we’ll enable only Direct Hosting, which is more efﬁcient than
NetBIOS protocols.
Perform the following steps to create the Direct Hosting Access Rule on the network
services perimeter ﬁrewall:
1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab in the Task pane and then
click Create New Access Rule.
3.
On the Welcome to the New Access Rule Wizard page, enter a name for the
rule in the Access Rule name text box. In this example, we’ll name the rule
Publish File Server. Click Next.
4.
Select the Allow option on the Rule Action page and click Next.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list and then click Add.
6.
In the Add Protocols dialog box, click the All Protocols folder and then
double click the Microsoft CIFS (TCP) and Microsoft CIFS (UDP) proto-
cols. Click Close (see Figure 10.31).
Figure 10.31 Adding Protocols
www.syngress.com
470
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

7.
Click Next on the Protocols page.
8.
Click Add on the Access Rule Sources page.
9.
In the Add Network Entities dialog box, click the Networks folder and then
double click the Corpnet entry. Click Close (see Figure 10.32).
Figure 10.32 Adding Network Entities
10.
Click Next on the Access Rule Sources page.
11.
Click Add on the Access Rule Destinations page.
12.
In the Add Network Entities dialog box, click the New menu and then click
Computer.
13.
In the New Computer Rule Element dialog box, enter a name for the ﬁle
server in the Name text box. In this example, we’ll name it File Server 1. Enter
the IP address of the ﬁle server located in the network services segment in the
Computer IP Address text box. Enter an optional description if you like. Click
OK (see Figure 10.33).
14.
Click the Computers folder in the Add Network Entities dialog box, double
click the File Server 1 entry, and click Close.
15.
Click Next on the Access Rule Destinations page.
16.
Click Next on the User Sets page.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
471

Figure 10.33 Specifying the New Computer Rule Element
17.
Click Finish on the Completing the New Access Rule Wizard page.
Your ﬁrewall policy should look like that in Figure 10.34.
Figure 10.34 The Completed Firewall Policy
Conﬁguring the Default Internal
Network on the Edge ISA Firewall
When the edge ISA ﬁrewall was installed, it took its deﬁnition of the default internal net-
work from the routing table on the edge ISA ﬁrewall device.The routing table entries indi-
cated to the ISA ﬁrewall installer that the addresses 10.0.1.0 through 10.0.1.255 should be
included in the deﬁnition of its default internal network.This is a correct conﬁguration if
the only network behind the edge ISA ﬁrewall was on network ID 10.0.1.0/24. However, in
our scenario, this is an incorrect conﬁguration and will cause problems with access controls
on connections to and from the network services segment through the edge ISA ﬁrewall.
www.syngress.com
472
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

NOTE
If the ISA ﬁrewall device’s routing table had been conﬁgured with a routing
table entry for the network services segment located behind the network ser-
vices segment perimeter ﬁrewall, the ISA ﬁrewall software’s installer program
would have seen this routing table entry and included that network ID as part
of the edge ISA ﬁrewall’s deﬁnition of its default internal network.
The reason for the problem with the initial settings for the default internal network on
edge ISA ﬁrewall is that there is a Route relationship between the Corpnet ISA ﬁrewall net-
work (which is the edge ISA ﬁrewall’s default internal network) and the default internal net-
work behind the network services segment ISA ﬁrewall. Because there is a Route
relationship, connections from SecureNAT clients located behind the network services
perimeter ISA ﬁrewall will reach the edge ISA ﬁrewall with their original client IP address
included as the source address (note that this is not the case with proxied connections by
Winsock [Firewall] and Web proxy clients). If we leave the edge ISA ﬁrewall’s default
internal network deﬁnition as it is now, connections from SecureNAT clients located behind
the network services perimeter ISA ﬁrewall will be detected as spoofed packets.
ISA ﬁrewall networks are used to determine the validity of connections reaching the
interface that is the “root” of a particular ISA ﬁrewall network. For the edge ISA ﬁrewall, the
root of its default internal network is the internal interface which is on network ID
10.0.1.0/24.Any connections with a source IP address on that network ID are seen as valid.
That is to say, they are seen as not being spoofed.
However, if a connection with a source IP address that is not part of the edge ISA ﬁre-
wall’s default internal network’s deﬁnition is made through the interface that is the root of
the edge ISA ﬁrewall’s default internal network (which is the internal interface of the edge
ISA ﬁrewall), the connection is dropped as a spoof attempt.The ISA ﬁrewall assumes that it’s
not possible for an interface to accept a connection from a host on an ISA ﬁrewall network
that isn’t the same as that for which the interface is root.
NOTE
I’m using the term root to represent a point of exit and departure. The term
root does not imply that the NIC’s IP address or network ID deﬁnes what net-
work IDs or subnets can be placed behind a NIC. You can put contiguous or dis-
continuous network IDs behind any NIC. The only requirements are that all IP
addresses located behind any NIC on the ISA ﬁrewall must be included in the
ISA ﬁrewall network for which that NIC is “root,” and that no other ISA ﬁrewall
network includes the same addresses. Another thing to keep in mind, which
makes this concept easier to understand, is that addresses always lie behind an
ISA ﬁrewall NIC. No addresses are ever in front of a NIC.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
473

We can easily solve this problem by adding the IP addresses included in the network ser-
vices perimeter ISA ﬁrewall’s default internal network (which is the network services seg-
ment) to the deﬁnition of the edge ISA ﬁrewall’s default internal network deﬁnition.
Adding IP Addresses of the Network 
Services Perimeter Segment to the Front-End
ISA Firewall’s Default Internal Network
Perform the following steps to add the IP addresses of the network services perimeter ISA
ﬁrewall’s default internal network to the deﬁnition of the front-end ISA ﬁrewall’s default
internal network:
1.
In the ISA ﬁrewall console, expand the server name and then expand the
Conﬁguration node. Click on the Networks node.
2.
On the Networks node, click the Networks tab in the Details pane, then
double click the Internal network.
3.
In the Internal Properties dialog box, click the Addresses tab.
4.
On the Addresses tab, click the Add button.
5.
In the IP Address Range Properties dialog box, enter the Starting address
and the Ending address in the text boxes. In this example, we’ll enter 10.0.0.0
and 10.0.0.255, respectively. Click OK (see Figure 10.35).
Figure 10.35 Specifying IP Address Range Properties
Click OK in the Internal Properties dialog box (see Figure 10.36).
www.syngress.com
474
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.36 The IP Address Ranges Included in the Network
IP addressing information for hosts on the Corpnet network is determined by your
requirements.The most secure conﬁguration is to not provide users with a default gateway
address that provides a route to the Internet.This forces all users to use the Firewall client and
Web proxy conﬁguration, which can be used to enforce strong user/group-based access con-
trols, as well as block applications installed on users’ computers from accessing the Internet.This
also prevents users from using non-Winsock or Web proxy-compliant applications, such as
Internet Control Message Protocol (ICMP) utilities such as PING and TRACERT.
Administrative users and servers can be conﬁgured with gateway addresses that route to
the Internet.Administrators require the use of ICMP-based utilities, and servers do not have
logged-on users, so both admins and servers require the facilities provided by the
SecureNAT client conﬁguration.
I should note that this can be problematic for networks that have LAN routers, as you
must conﬁgure the clients to use the LAN routers as their default gateways. However, if you
are using the ISA ﬁrewall as your edge ﬁrewall, this will not be a problem, as you can allow
only administrative users access to non-Winsock protocols, such as ICMP and virtual private
network (VPN) protocols.
Creating a Routing Table 
Entry on the Edge ISA Firewall
A routing table entry must be conﬁgured on the edge ISA ﬁrewall so that it knows the path
to take to reach the network services segment.The ISA ﬁrewall should always be conﬁgured
with routing table entries for all network IDs that can’t be reached using the default gateway.
In practice, this usually means that except for Internet addresses, there should be a routing
table entry on the ISA ﬁrewall for all network IDs on your corporate network.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
475

Note that if your ISA ﬁrewall is conﬁgured with a default gateway pointing to a LAN
router, and all network IDs are reachable from that router, there’s no reason to enter all net-
work IDs in the ISA ﬁrewall’s routing table, because the LAN router is performing the
router duties.
At the edge ISA ﬁrewall, open a command prompt and enter the following:
route add –p 10.0.0.0 MASK 255.255.255.0 10.0.1.2
In the preceding code, 10.0.0.0 is the network ID for the network services segment
behind the network services perimeter ISA ﬁrewall, 255.255.255.0 is the subnet mask for
that network ID, and 10.0.1.2 is the IP address on the external interface of the back-end
ISA ﬁrewall.
Figure 10.37 shows an example of conﬁguring the routing table entry.
Figure 10.37 Conﬁguring the Routing Table Entry
Joining the Edge 
ISA Firewall to the Domain
The edge ISA ﬁrewall should be a member of the domain so that you can fully leverage
both the ﬁrewall and the Web proxy client conﬁguration.Although you can use RADIUS
authentication for Web proxy clients, there are signiﬁcant limitations to RADIUS authenti-
cation in both the logging and the management realms. For this reason, I recommend that
you avoid RADIUS authentication if at all possible. In addition, you must make the edge
ISA ﬁrewall a domain member if you want to fully leverage the enhanced security and ﬂexi-
bility provided by the Firewall client.
The edge ISA ﬁrewall will be able to use the intradomain communications Access Rule
created on the network services perimeter ISA ﬁrewall to access the domain controller.The
edge ISA ﬁrewall is conﬁgured to use the DNS server on the network services segment, which
is conﬁgured to support name resolution within the network and for Internet host names.
www.syngress.com
476
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

I should note that making the edge ISA ﬁrewall a domain member is speciﬁc for this
scenario only, where the clients are located directly behind the edge ISA ﬁrewall. If you
encounter resistance to joining the edge ISA ﬁrewall to the domain, you can easily place
another ISA ﬁrewall in front of the edge ISA ﬁrewall in this scenario and then create rules
that allow the required inbound and outbound connections, only not requiring any type of
authentication. In this type of deployment, the ISA ﬁrewall would be acting in the same way
as a typical “hardware” ﬁrewall.
Creating Access Rules on the Edge 
ISA Firewall, Controlling Outbound
Access from Corpnet Hosts and Hosts
on the Network Services Segment
Firewall policy on the edge ISA ﬁrewall will be highly customized based on your network’s
security requirements.You will need to decide together with your network security team
who should have access to what Web sites and at what times of the day. Firewall policy is
deﬁnitely something where one size does not ﬁt all.
In the example provided by our sample network conﬁguration, all hosts on the Corpnet
ISA ﬁrewall network are conﬁgured as Firewall and Web proxy clients and are not conﬁgured
as SecureNAT clients.The only exception is for administrator workstations, because network
administrators will need access to non-Winsock protocols and utilities, such as PING and
TRACERT.
We will create the following Access Rules:
■
An Access Rule allowing the domain controller on the network services segment
access to DNS outbound.
■
An Access Rule allowing all authenticated users outbound access to all protocols.
Note that in a production environment, you would create more granular access
controls and create ISA ﬁrewall groups that allow users to access only the content
they require to get their jobs done.
■
An Access Rule allowing the servers on the network services segment access to the
Windows reporting and Microsoft Update sites. We need this rule because the
servers on the network services segment do not have logged-on users, so we will
not be able to leverage the Firewall client to force authentication from server con-
nections.
Table 10.5 shows the salient characteristics of these Access Rules.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
477

Table 10.5 Access Rules on the Edge ISA Firewall
Order
Name
Action
Protocols
From/Listener
To
Condition
1
MU and 
Allow
HTTP
Network 
Microsoft 
All Users
Error 
HTTPS
Services 
Error 
Reporting–
Segment
Reporting 
Servers
Sites
System Policy
Allowed Sites
2
Outbound 
Allow
DNS
DNS Server*
External
All Users
DNS for 
DNS Server
3
All Open—
Allow 
All Out-
Internal
External
All 
Authenti-
bound 
Authenti-
cated
Trafﬁc
cated Users
* We will discuss the From conﬁguration for this Access Rule shortly.
Creating the Outbound 
DNS for the DNS Server Access Rule 
Perform the following steps to create the Access Rule allowing the domain controller on the
network services segment outbound access to the DNS protocol:
1.
On the edge ISA ﬁrewall, open the ISA ﬁrewall console and click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and click
Create New Access Rule.
3.
On the Welcome to the New Access Rule Wizard page, enter a name for the
rule in the Access Rule name text box. In this example, we’ll name the rule
Outbound DNS for DNS Server. Click Next.
4.
Select the Allow option on the Rule Action page. Click Next.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list and click Add.
6.
In the Add Protocols dialog box, click the Common Protocols folder and
double click on the DNS entry. Click Close.
7.
Click Next on the Protocols page.
8.
On the Access Rule Sources page, click the Add button.
9.
In the Add Network Entities dialog box, click the New menu and click
Computer.
www.syngress.com
478
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

10.
In the New Computer Rule Element dialog box, enter a name for the com-
puter in the Name text box. In this example, we’ll name the computer DNS
Server. Enter the IP address of the external interface of the network services seg-
ment perimeter ISA ﬁrewall. Note that we use the IP address of the external inter-
face of the perimeter ISA ﬁrewall because there is a NAT relationship between the
perimeter ISA ﬁrewall’s default internal network and its default external network.
Because the DNS queries the DNS server makes are to the Internet-based DNS
server, the connection will be NATed. When the connection is NATed, the source
IP address of the outbound connection is the primary IP address on the external
interface of the perimeter ISA ﬁrewall. In this example, the IP address is 10.0.1.2,
so we’ll enter that address. Enter an optional description if you like. Click OK (see
Figure 10.38).
Figure 10.38 Adding a New Network Entity
In the Add Network Entities dialog box, click the Computers folder and
double click the DNS Server entry. Click Close (see Figure 10.39).
Figure 10.39 Adding Network Entities
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
479
www.syngress.com

12.
Click Next on the Access Rule Sources page.
13.
Click Add on the Access Rule Destinations page.
14.
In the Add Network Entities dialog box, click the Networks folder and then
double click External. Click Close.
15.
Click Next on the Access Rule Destinations page.
16.
Click Next on the User Sets page.
17.
Click Finish on the Completing the New Access Rule Wizard page.
Creating the All Open 
Rule for Authenticated Users
Perform the following steps to create the outbound Access Rule allowing all authenticated
users outbound access to all protocols and sites:
1.
On the edge ISA ﬁrewall, open the ISA ﬁrewall console and click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and click
Create New Access Rule.
3.
On the Welcome to the New Access Rule Wizard page, enter a name for the
rule in the Access Rule name text box. In this example, we’ll name the rule All
Open—Authenticated. Click Next.
4.
Select the Allow option on the Rule Action page. Click Next.
5.
On the Protocols page, select the All outbound trafﬁc option from the This
rule applies to list and click Next.
6.
Click Next on the Protocols page.
7.
On the Access Rule Sources page, click the Add button.
8.
In the Add Network Entities dialog box, click the Networks folder and then
double click Internal. Click Close.
9.
Click Next on the Access Rule Sources page.
10.
Click Add on the Access Rule Destinations page.
11.
In the Add Network Entities dialog box, click the Networks folder and then
double click External. Click Close.
12.
Click Next on the Access Rule Destinations page.
13.
On the User Sets page, click the All Users entry and click Remove. Click Add.
14.
In the Add Users dialog box, double click on the All Authenticated Users
entry and click Close (see Figure 10.40).
www.syngress.com
480
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.40 Adding Authenticated Users
15.
Click Next on the User Sets page.
16.
Click Finish on the Completing the New Access Rule Wizard page.
Creating the Microsoft Update 
and Error Reporting Sites Access Rule 
Perform the following steps to create the Access Rule allowing servers on the network ser-
vices segment access to the Windows Update sites and the Microsoft Error Reporting sites:
1.
On the edge ISA ﬁrewall, open the ISA ﬁrewall console and click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and click
Create New Access Rule.
3.
On the Welcome to the New Access Rule Wizard page, enter a name for the
rule in the Access Rule name text box. In this example, we’ll name the rule
MU and Error Reporting—Servers. Click Next.
4.
Select the Allow option on the Rule Action page. Click Next.
5.
On the Protocols page, select the Selected protocols option from the This
rule applies to list and click Add.
6.
In the Add Protocols dialog box, click the Common Protocols folder and
double click on the HTTP and HTTPS entries. Click Close.
7.
Click Next on the Protocols page (see Figure 10.41).
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
481

Figure 10.41 Selecting the Protocols to Which the Rule Applies
8.
On the Access Rule Sources page, click the Add button.
9.
In the Add Network Entities dialog box, click the New menu and click
Address Range.
10.
In the New Address Range Rule Element dialog box, enter a name for the
address range in the Name text box. In this example, we’ll name it Network
Services Segment. Enter the start and end addresses in the Start Address and
End Address text boxes. Enter an optional description and then click OK (see
Figure 10.42).
Figure 10.42 Specifying the Range of IP Addresses
11.
In the Add Network Entities dialog box, click the Address Ranges folder and
double click the Network Services Segment entry. Click Close (see Figure
10.43).
www.syngress.com
482
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.43 Adding Network Entities
12.
Click Next on the Access Rule Sources page.
13.
Click Add on the Access Rule Destinations page.
14.
In the Add Network Entities dialog box, click the Domain Name Sets folder
and double click Microsoft Error Reporting sites and System Policy
Allowed Sites. Click Close (see Figure 10.44).
Figure 10.44 Selecting Domain Name Sets
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
483

15.
Click Next on the Access Rule Destinations page.
16.
Click Next on the User Sets page.
17.
Click Finish on the Completing the New Access Rule Wizard page.
Before applying the conﬁguration to the ISA ﬁrewall’s ﬁrewall policy, make sure that
you put the unauthenticated Access Rules before the authenticated rules.This is a good gen-
eral approach to ordering ﬁrewall rules on your ISA ﬁrewall.
Click Apply to save the changes and update the ﬁrewall policy. Click OK in the Apply
New Conﬁguration dialog box.Your ﬁrewall policy should look like that in Figure 10.45.
Figure 10.45 The Completed Firewall Policy
Creating Publishing Rules on 
the Edge ISA Firewall to Allow 
Inbound Connections to the Exchange
Server Mail Services
Now we’re ready to create Publishing Rules allowing access to Exchange server services for
users on the Internet. We’ll create Server Publishing Rules that allow access to the OWA,
Secure Exchange RPC, SMTP, POP3, and IMAP4 services.
Creating an SSL Server Publishing Rule on 
the Network Services Perimeter ISA Firewall
We begin by creating an SSL Server Publishing Rule on the front-end ISA ﬁrewall. We must
create a Server Publishing Rule rather than a Web Publishing Rule because the OWA form
generated by the network services perimeter ISA ﬁrewall cannot be delivered through a Web
proxy connection on the edge ISA ﬁrewall.The SSL Server Publishing Rule will enable a
secure, end-to-end connection but will not allow the edge ISA ﬁrewall to perform stateful
application layer inspection on the SSL connection moving through the edge ISA ﬁrewall.
The edge ISA ﬁrewall will be limited, like a typical “hardware” ﬁrewall, to simple stateful
packet inspection.
This is a limitation of our sample network design and should not be construed to imply
that you can never use OWA FBA in a back-to-back ISA ﬁrewall conﬁguration. For
www.syngress.com
484
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

example, suppose you have a back-to-back ISA ﬁrewall conﬁguration with a DMZ between
the front-end and back-end ISA ﬁrewalls.You can use FBA on the front-end ISA ﬁrewall
and conﬁgure its OWA Web Publishing Rule to forward basic credentials to the back-end
ISA ﬁrewall’s Web Publishing Rule.The back-end ISA ﬁrewall is conﬁgured to use basic
authentication. In this case, we have single sign-on with FBA.
Creating the Network Services Perimeter
Network OWA Web Publishing Rule 
Perform the following steps on the edge ISA ﬁrewall to enable inbound access to the net-
work services perimeter ISA ﬁrewall’s OWA Web Publishing Rule:
1.
In the ISA ﬁrewall console, expand the server name and click the Firewall Policy
node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and then
click the Publish a Secure Web Server link.
3.
On the Welcome to the SSL Web Publishing Rule Wizard page, enter a
name for the rule in the SSL Web Publishing Rule name text box. In this
example, we’ll name the rule SSL tunnel to OWA. Click Next.
4.
On the Publishing Mode page, select the SSL Tunneling option and click
Next (see Figure 10.46).
Figure 10.46 Specifying the Publishing Mode
5.
On the Select Server page, enter the IP address of the external interface of the
network services perimeter ISA ﬁrewall.This is the address used by the listener on
the OWA Web Publishing Rule on the network services perimeter ISA ﬁrewall. In
this example, the IP address is 10.0.1.2, so we’ll enter that address and click Next
(see Figure 10.47).
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
485

Figure 10.47 Entering the IP Address of the External Interface of the
Network Services Perimeter ISA Firewall
6.
On the IP Addresses page, put a checkmark in the External checkbox and click
Next.
7.
Click Finish on the Completing the New SSL Web Publishing Rule Wizard
page.
At this point, your ﬁrewall policy should look like that in Figure 10.48.
Figure 10.48 The Completed Firewall Policy
Creating Secure Exchange RPC, SMTP, 
POP3, and IMAP4 Server Publishing Rules 
The next step is to create the Server Publishing Rules on the edge ISA ﬁrewall that provide
access to the Server Publishing Rules conﬁgured on the network services perimeter ISA
ﬁrewall.These Server Publishing Rules enable Internet-based hosts access to the Exchange
server services on the network services segment.
www.syngress.com
486
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Creating the Mail Server Publishing Rules
Perform the following steps to create the Server Publishing Rules on the edge ISA ﬁrewall:
1.
In the ISA ﬁrewall console, expand the server name and then click the Firewall
Policy node.
2.
On the Firewall Policy node, click the Tasks tab on the Task pane and click the
Publish a Mail Server link.
3.
On the Welcome to the New Mail Server Publishing Rule Wizard page,
enter a name for the rule in the Mail Server Publishing Rule name text box.
In this example, we’ll name the rule Exchange Server. Click Next.
4.
On the Select Access Type page, select the Client access: RPC, IMAP, POP3,
SMTP option and click Next (see Figure 10.49).
Figure 10.49 Selecting the Access Type
5.
On the Select Services page, put a checkmark in each checkbox.This will allow
us to connect to the Exchange server on the network services segment through
the network services perimeter ISA ﬁrewall for all the services listed on this page.
Note the comment on the page regarding the SMTP Message Screener. We will
not deploy the message screener in this example, but you might want to consider
it in your own deployment.You can install the SMTP Message Screener on the
ISA ﬁrewall to ﬁlter both inbound and outbound mail. Even though the SMTP
Message Screener won’t be enabled, the SMTP ﬁlter is enabled and will protect
SMTP communications. Click Next (see Figure 10.50).
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
487

Figure 10.50 Selecting the Services to Publish
6.
On the Select Server page, enter the IP address of the Exchange server on the
network services segment in the Server IP address text box. In this example, the
IP address is 10.0.0.2, so we enter that value. Click Next.
7.
On the IP Addresses page, put a checkmark in the External checkbox. Click
Next.
8.
Click Finish on the Completing the New Mail Server Publishing Rule
Wizard page.
Your ﬁrewall policy should appear similar to that in Figure 10.51. Note that the Mail
Server Publishing Rule Wizard added seven new Server Publishing Rules. Click Apply to
save the changes and update the ﬁrewall policy. Click OK in the Apply New
Conﬁguration dialog box.
Figure 10.51 The Completed Firewall Policy
www.syngress.com
488
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

We need to do one more thing on the edge ISA ﬁrewall to make the Server Publishing
Rules work correctly. Because there is a Route relationship between the Corpnet ISA ﬁre-
wall network and the network services segment, we will need to change the Server
Publishing Rules on the edge ISA ﬁrewall so that the client requests appear to come from
the edge ISA ﬁrewall.This allows us to use the Server Publishing Rules we created on the
network services perimeter ISA ﬁrewall where the listener is listening on the Corpnet ISA
ﬁrewall network.
Conﬁguring the Server Publishing Rules to Use the
ISA Firewall’s Address as the Source IP Address
For each Server Publishing Rule created by the Mail Server Publishing Wizard, perform the
following steps:
1.
Double click on one of the Server Publishing Rules created by the Server
Publishing Rule Wizard.
2.
In the Properties dialog box for that rule, click the To tab.
3.
On the To tab, select the Requests appear to come from the ISA Server
computer option. Click OK (see Figure 10.52).
Figure 10.52 Specifying the Network Address of the Server to Publish
4.
Repeat the procedure for all the Server Publishing Rules created by the Mail
Server Publishing Rule Wizard.
5.
Click Apply to save the changes and update the ﬁrewall policy.
6.
Click OK in the Apply New Conﬁguration dialog box.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
489

Creating a Routing Table Entry 
on Network Clients (Required Only 
If No LAN Routers Are Installed)
Clients on the Corpnet ISA ﬁrewall network need to know the route to the network ser-
vices segment.As discussed earlier in this chapter, you have two options: Use LAN routers
that contain the appropriate routing table entries to reach the network services segment, or
conﬁgure the clients with a routing table entry.
In this chapter, we’ll create routing table entries on the clients.You can automate this
process by using a logon script that contains the Route add command used to add the routing
table entry.The command required is:
Route add –p 10.0.0.0 MASK 255.255.255.0 10.0.1.2
In the preceding command, –p makes the routing table entry permanent, 10.0.0.0 is the
network ID of the network services segment, 255.255.255.0 is the subnet mask for the net-
work services segment, and 10.0.1.2 is the gateway address used to reach that network.
Joining the Network 
Clients to the Domain
All the pieces are now in place to add the network clients to the domain.The network ser-
vices perimeter ISA ﬁrewall has the appropriate Access Rules in place to join hosts on the
Corpnet ISA ﬁrewall network to the domain.The procedure varies with the operating
system you’re joining to the domain. In this chapter, we’re joining a Windows XP client to
the domain.
Creating and Conﬁguring DNS Entries in
the Domain DNS, Including WPAD Entries
DNS infrastructure design is critical for all Windows environments. One of the most common
reasons for connectivity and performance issues is a poorly designed DNS infrastructure.
Proper DNS infrastructure is critically important in ISA ﬁrewall networking because the ISA
ﬁrewall uses DNS name resolution for access control and security monitoring.
Clients on the Corpnet ISA ﬁrewall network will be conﬁgured as both Web proxy and
Firewall clients. Web proxy and Firewall clients need to be able to locate the edge ISA ﬁre-
wall to access the Internet.Although you can manually conﬁgure each host with the proper
information, it’s much easier to automate the process using Web Proxy Auto Discovery
(WPAD) entries in DNS and/or DHCP.
www.syngress.com
490
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Web proxy and Firewall clients use WPAD entries in DNS and/or DHCP to ﬁnd the
address of the ISA ﬁrewall.After the clients ﬁnd the address of the ISA ﬁrewall, the clients
obtain conﬁguration information from the ISA ﬁrewall. By default, the ISA ﬁrewall adver-
tises conﬁguration information on TCP port 80, which can be changed if required.
However, if you use DNS-based WPAD entries, you must use TCP port 80. If you use
DHCP for WPAD information, you can use any port you like to advertise autodiscovery
information.
In this chapter, we will use DNS WPAD publishing. We will create a WPAD CNAME
record based on the Host (A) record for the edge ISA ﬁrewall.The Host (A) record for the
edge ISA ﬁrewall maps the name of the edge ISA ﬁrewall to the IP address on the internal
interface of the edge ISA ﬁrewall.
Perform the following steps to create the WPAD entry on the domain DNS server on
the network services segment:
1.
At the DNS server, click Start, point to Administrative Tools, and click DNS.
2.
In the DNS console, expand the server name and then expand the Forward
Lookup Zones node. Click on the domain, which in this case is msﬁrewall.org.
3.
Right click the domain name and click New Alias (CNAME).
4.
In the New Resource Record dialog box, enter wpad in the Alias name 
(uses parent domain if left blank) text box. Click the Browse button (see
Figure 10.53).
Figure 10.53 Entering an Alias Name
5.
Double click the server name in the Records section, and then double click the
Forward Lookup Zone entry. Double click the domain name and then double
click the entry for the edge ISA ﬁrewall. In this example, the name of the edge
ISA ﬁrewall is remoteisa, so double click that one (see Figure 10.54).
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
491

Figure 10.54 Selecting the Edge ISA Firewall
6.
Click OK in the New Resource Record dialog box (see Figure 10.55).
Figure 10.55 Applying Changes
7.
The new CNAME record appears in the right pane of the console, as shown in
Figure 10.56.
Note that the edge ISA ﬁrewall’s IP address is included in the domain DNS because it
was automatically added when the ﬁrewall joined the domain. If your domain DNS is not
conﬁgured to enable automatic registration of DNS records, you’ll need to create the Host
(A) record yourself before you can create the CNAME record.
www.syngress.com
492
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.56 The New CNAME Record
Conﬁguring the Firewall and Web 
Proxy Client Settings on the Edge ISA
Firewall, and Enabling Autodiscovery
In my experience, one of the least understood issues with ISA ﬁrewall conﬁguration relates
to the settings in the Firewall client conﬁguration on the ISA ﬁrewall. For each ISA ﬁrewall
network, you can conﬁgure Firewall client settings that are used by Firewall client systems
located on that ISA ﬁrewall network.These settings allow you to set how the Firewall client
software ﬁnds the ISA ﬁrewall, what destination addresses should be remoted to the ISA ﬁre-
wall, and which ones should not be serviced by the Firewall client software.
The best way to learn how these settings work is to get into the conﬁguration interface.
Perform the following steps on the edge ISA ﬁrewall to conﬁgure the Firewall client settings:
1.
In the ISA ﬁrewall console, expand the server name and then expand the
Conﬁguration node. Click the Networks node.
2.
On the Networks node, double click the default Internal Network entry.
3.
In the Internal Properties dialog box, click the Firewall Client tab. On the
Firewall Client tab, conﬁrm that there is a checkmark in the Enable Firewall
client support for this network checkbox. When this option is enabled, the
Firewall client listener port,TCP 1745, is enabled and listens for connections from
the Firewall clients on that ISA ﬁrewall network. In the ISA Server name or IP
address text box, enter the fully qualiﬁed domain name of the ISA ﬁrewall.This is
a critical setting.The default entry in this text box is the NetBIOS name of the
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
493

ISA ﬁrewall, which can create problems with name resolution.The name you enter
into this text box is the name Firewall clients on the network will use to access the
ISA ﬁrewall. If you leave just the NetBIOS name in this text box, there could be
problems with name resolution related to fully qualifying the unqualiﬁed name.
Although I am not saying that it won’t work to leave just the NetBIOS name in
this text box, I am saying that you will avoid difﬁcult-to-troubleshoot issues with
Firewall clients if you use a fully qualiﬁed domain name (FQDN) in this text box.
Put a checkmark in the Automatically detect settings checkbox and do not
enable the Use automatic conﬁguration script and Use a Web proxy server
checkboxes.You will get autoconﬁguration information by using autodiscovery,
and you don’t need the Use a Web proxy server setting because the client will
ﬁnd the Web proxy ﬁlter component of the ISA ﬁrewall using the wpad settings
(see Figure 10.57).
Figure 10.57 Enabling Firewall Client Settings
4.
Click the Domains tab. On this tab, you enter your internal domain names so
that the Firewall clients do not use the Firewall client software to handle connec-
tions to hosts on the internal domains.This is a tricky setting on multihomed ISA
ﬁrewalls with multiple internal ISA ﬁrewall networks, but in this example, the edge
ISA ﬁrewall has only a single internal network, so we won’t run into those issues.
In this example, we have a single internal domain, which is msﬁrewall.org. Click
Add to enter the internal network domain (see Figure 10.58).
5.
In the Domain Properties dialog box, enter the name of the internal domain in
the Enter a domain name to include text box. Click OK (see Figure 10.59).
www.syngress.com
494
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Figure 10.58 The Domains Tab
Figure 10.59 Entering a Domain Name
We can also conﬁgure the Web proxy client settings in the Properties dialog box of the
ISA ﬁrewall network. Continue with the following steps to conﬁgure the Web proxy client
conﬁguration:
1.
In the Internal Properties dialog box, click the Web Browser tab. On the Web
Browser tab, conﬁrm that there are checkmarks in the Bypass proxy for Web
server in this network and Direct access computers speciﬁed in the
Domains tab.The Bypass proxy for Web servers in this network setting allows
the Web proxy client machines to bypass their Web proxy conﬁguration when
connecting to servers using a single label name. For example, http://server1 is a
single label name. When the single label name is used, the Web browser ignores
the Web proxy settings and connects directly to the Web server.This is known as
Direct Access. When Direct Access is used, the client system must be able to resolve
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
495

the name itself, as the ISA ﬁrewall does not handle the connection and therefore
does not perform name resolution on behalf of the client.
The Directly access computers speciﬁed in the Domains tab option enables
the Web proxy client system to bypass the Web proxy conﬁguration when con-
necting to hosts that belong to a domain included in the Domains tab.This is a
useful option because the Web proxy client bypasses its Web proxy conﬁguration
and the ISA ﬁrewall when connecting to internal, trusted servers on the corporate
network.
You can also add servers, domains, and addresses for Direct Access by clicking the
Add button next to the Directly access these servers or domains list.You
might want to put all the addresses in the ISA ﬁrewall network in the Direct
Access list. For example, because we’re in the Internal Properties dialog box, we
could include all the addresses in the default Internal network. In a multihomed,
multiple internal network design, this can be used for authenticated access control.
2.
Conﬁrm that there is a checkmark in the If ISA Server is unavailable, use this
backup route to connect to the Internet checkbox and that the Direct
Access option is selected (see Figure 10.60).
Figure 10.60 The Web Browser Tab
The last thing we need to do in the Internal Properties dialog box is enable
Autodiscovery publishing. Perform the following steps to enable the ISA ﬁrewall to publish
autodiscovery information:
1.
Click the Auto Discovery tab in the Internal Properties dialog box.
2.
On the Auto Discovery tab, put a checkmark in the Publish automatic dis-
covery information checkbox. Leave the default port listed in the Use this
www.syngress.com
496
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

port for automatic discovery request text box as 80. We must use TCP port
80 because we are using DNS for our WPAD entry (see Figure 10.61).
Figure 10.61 The Auto Discovery Tab
3.
Click OK in the Internal Properties dialog box.
4.
Click Apply to save the changes and update the ﬁrewall policy.
5.
Click OK in the Apply New Conﬁguration dialog box.
Installing the Firewall Client Share on the
Network Services Segment File Server
The Firewall client software will be installed on all the client systems on the Corpnet ISA
ﬁrewall network. Note that you should install the Firewall client software only on network
client systems, and avoid installing it on servers.Although it is possible to install the Firewall
client software on servers, there is little reason to do so, because servers typically do not have
logged-on users (that is, interactive logons).You will avoid difﬁcult-to-diagnose connectivity
issues if you do not install the Firewall client software on network servers.
Although some ISA ﬁrewall administrators choose to install the Firewall client share on
the ISA ﬁrewall itself, I highly recommend against this practice, as it requires Windows ﬁle
sharing protocol connections to be made to the ISA ﬁrewall device itself.This creates an
increase in the ISA ﬁrewall’s attack surface that doesn’t need to be there. Instead, install the
Firewall client share on a ﬁle server on the network services segment. Remember, the ISA
ﬁrewall is a network-level security device and connections to and from the ISA ﬁrewall
device should be severely limited.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
497

Perform the following steps on the ﬁle server computer on the network services segment:
1.
At the ﬁle server on the network services segment, place the ISA Server 2004
CD into the CD-ROM drive.The autorun menu will appear. If the autorun
menu does not appear, double click the isaautorun.exe ﬁle on the CD.
2.
In the ISA Server 2004 Setup autorun menu, click the Install ISA Server
2004 link.
3.
Click Next on the Welcome to the Installation Wizard for Microsoft ISA
Server 2004 page.
4.
Select the I accept the terms in the license agreement option on the
License Agreement page and click Next.
5.
Enter your user information and product serial number on the Customer
Information page and click Next.
6.
Select the Custom option on the Setup Type page.
7.
On the Custom Setup page, click the ISA Server Management icon and click
the This feature will not be available option. Click the Firewall Client
Installation Share icon and click the This feature, and all subfeatures, will
be installed on local hard drive option. Click Next (see Figure 10.62).
Figure 10.62 Selecting the Program Features to Install
8.
Click Install on the Ready to Install the Program page.
9.
Click Finish on the Installation Wizard Completed page.
10.
Close the Internet Explorer window that presents a page on how to Protect
the ISA Server Computer.
11.
Click the Exit link on the ISA autorun menu.
www.syngress.com
498
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

Installing the Firewall 
Client on the Network Clients
The Firewall client share is now installed on the ﬁle server and can be accessed using the
\\server_name\mspclnt\setup.exe Universal Naming Convention (UNC) path.Any user
logged on as a local administrator can install the Firewall client software. However, if some of
your users do not run as local administrators, you’ll need to ﬁnd another way to install the
Firewall client software.
Fortunately, the ideal solution to this problem is Active Directory Group Policy-based
software installation. Because the client machines must be domain members to fully utilize
the ﬂexibility and increased security provided by the Firewall client, those domain members
can have their Firewall client software installed automatically via Group Policy.
In the following procedure, we will create an Organizational Unit (OU) for machines
that should have the Firewall client software automatically installed. We do this to prevent
the Firewall client software from being installed on servers.There may be more elegant ways
to approach this, such as using Group Policy ﬁltering, but I’ll leave that up to the Active
Directory guys to ﬁgure out the most efﬁcient way to assign the Firewall client software
only to client systems and not to servers.
Note that in the following example, we’ll create an OU that provides a Group Policy
Object (GPO) linked to the OU that installs the Firewall client software. In a production
environment, you will want to link other GPOs to the OU and order the GPO links appro-
priately.
Perform the following steps to create the OU, place a client system in the OU, and then
use Software Installation to assign the Firewall client software to members of the OU:
1.
On the domain controller on the network services segment, open the Active
Directory Users and Computers console from the Administrative Tools
menu.
2.
Right click on the domain name, point to New, and click Organizational Unit.
3.
In the New Object—Organizational Unit page, enter Firewall Client
Systems in the Name text box. Click OK.
4.
Click the Computers node and right click the client system name in the right
pane of the console. Click Move.
5.
In the Move dialog box, click the Firewall Client Systems node and click OK.
6.
Right click the Firewall Client Systems OU and click Properties.
7.
In the Firewall Client Systems Properties dialog box, click the Group Policy
tab.
8.
On the Group Policy tab, click the New button. Name the new GPO Firewall
Client Installation and click Edit.
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
499

9.
In the Group Policy Object Editor console, expand the Computer
Conﬁguration node and then expand the Software Settings node. Right click
Software installation, point to New, and click Package.
10.
In the Open dialog box, enter the UNC path to the Firewall client installation
package ﬁle. In this example, the path is \\Win2k\mspclnt\MS_FWC.msi.
Click Open (see Figure 10.63).
Figure 10.63 Entering the UNC Path to the Firewall Client Installation
Package File
11.
In the Deploy Software dialog box, select the Assigned option and click OK
(see Figure 10.64).
Figure 10.64 Selecting the Deployment Method
12.
Close the Group Policy Object Editor.
13.
Close the Firewall Client Systems Properties dialog box.
www.syngress.com
500
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

14.
Close Active Directory Users and Computers.
15.
Open a command prompt on the domain controller, enter gpupdate, and press
Enter. When the client systems restart, the Firewall client software will install
automatically.
Connecting the Corporate Network
Clients to Resources on the Network
Services Segment and the Internet
Now the clients on the Corpnet ISA ﬁrewall network are ready to connect to resources on
the network services segment and the Internet.
Open the Web browser on the client and go to www.isaserver.org.You’ll see log ﬁle
entries on the edge ISA ﬁrewall that appear similar to those in Figure 10.65.
Figure 10.65 Log File Entries on the Edge ISA Firewall
Now open a share on the ﬁle server on the network services segment.You’ll see entries
like those in Figure 10.66.
Figure 10.66 Entries in a Share on the File Server on the Network Services
Segment
www.syngress.com
Firewall and DMZ Design: ISA Server 2005 • Chapter 10
501

Summary
We began this chapter with an in-depth discussion on network perimeters and how to
design a functional network services segment via perimeterization. In subsequent sections,
we provided detailed concepts and step-by-step instructions on how to conﬁgure the edge
and network services perimeter ISA ﬁrewall to support secure connections from hosts
located on the corporate network outside the perimeter to selected Exchange server services
from Internet hosts.
www.syngress.com
502
Chapter 10 • Firewall and DMZ Design: ISA Server 2005

DMZ Router 
and Switch Security
Solutions in this chapter:
■
Securing the Router
■
Securing the Switch
■
IOS Bugs and Security Advisories
■
DMZ Router and Switch Security 
Best-Practice Checklists
Chapter 11
503
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
When people think about securing their DMZs, they mostly think about ﬁrewalls, IDSs,
VPNs, and hardening of servers within the DMZ.These are all parts of the process, but there
is more to securing a DMZ than considering just these items. Some DMZ planners overlook
hardening the routers or switches supporting the DMZ so that they cannot be exploited and
used as tools to penetrate the network. Routers and switches provide the connectivity, both
within the DMZ environment and to other areas of the network to which the DMZ is con-
nected.This makes routers and switches prime targets for hackers to exploit and glean infor-
mation about the network or simply use as springboards to other devices. Routers and
switches on the DMZ, and anywhere else on the network, can also be used to protect
resources that they connect via security features, including ACLs, port security, and private
VLANs, to name a few.This chapter presents information on how to design and conﬁgure
some important router and switch security features that enable them to run securely and
protect the devices that they connect.
Securing the Router
This section covers how routers are implemented within a DMZ environment. We discuss
topics such as the placement of routers in traditional DMZ environments, routing trafﬁc into
and out of the DMZ, applying access restrictions, and how to lock down the router’s many
features and services. In this chapter we use the Cisco router and IOS as the baseline for the
examples. If you are using another vendor’s router or switch, you might want to consult that
vendor’s appropriate documentation. Regardless of whose router or switch you use in your
enterprise, the concepts introduced and discussed in this chapter are applicable across the
board.
The conﬁguration of the Cisco router Internetwork Operating System (IOS) is consis-
tent across the entire Cisco router product line, especially as it relates to security.This makes
it very easy to standardize security measures and policies across the network.This standard-
ization allows the network administrator to create security templates that are applied to new
router implementations.
The following sections provide valuable recommendations, techniques, and conﬁguration
information that will increase the integrity and security of your DMZ so that hackers will
ﬁnd it difﬁcult, if not impossible, to hack into your network via the DMZ by exploiting
your Internet-facing routers.
Router Placement in a DMZ Environment
In this section, we focus our attention on the routers involved in connecting the DMZ envi-
ronment to the internal network and the Internet. Figure 11.1 illustrates an enterprise loca-
tion with two internal LANs, a DMZ, and connectivity to the Internet.The diagram shows
the use of three routers. One is a multilayer switch, which is a switch with routing capabili-
www.syngress.com
504
Chapter 11 • DMZ Router and Switch Security

ties (for simplicity, we’ll call it a router from now on).A multilayer switch can increase routing
performance when your network has a large number of users or VLANs, since the hardware
that routes the trafﬁc between VLANs is internal to the switch chassis and does not require
any external connections. In Figure 11.1, the multilayer switch is directing trafﬁc on the
internal LAN.
The second device is an Internet router that provides connectivity to the Internet via a
link to an ISP. Between these two routers is a ﬁrewall, which is just a router with the added
ability to intelligently ﬁlter packets based on session state, among other things.The ﬁrewall is
used to protect the internal LAN and provide secure connectivity to the DMZ’s resources.
In this example, we assume that static routes are conﬁgured correctly on the ﬁrewall, but if
you need further details on how to conﬁgure the ﬁrewall to route trafﬁc, refer back to the
ﬁrewall conﬁguration chapters earlier in this book.At this point we need to set up routing so
that internal users can access resources on the Internet and so that a user on the Internet can
access resources on the DMZ.
Figure 11.1 Router Placement in a Traditional DMZ Environment
www.syngress.com
DMZ Router and Switch Security • Chapter 11
505
Web 
Server
11.1.2.2
E-Mail 
Server
11.1.2.3
FTP 
FTPP
FTPP
FTP
FTP
Internet 
Router
Firewall
VLAN 20
VLAN 20
VLAN 
30
VLAN
 30
VLAN 
10
DMZ
Switch
VLAN 20
VLAN 20
User
192.168.1.2
User
192.168.2.2
VLAN 11
VLAN 12
Interface E 0/0
IP: 11.1.1.2 /28
Outside Interface
IP: 11.1.1.1 /28
Inside Interface
IP: 192.168.0.1 /24
Interface VLAN 10
IP: 192.168.0.2 /24
Interface VLAN 12
IP: 192.168.2.1 /24
Interface VLAN 11
IP: 192.168.1.1 /24
DMZ Interface
IP: 11.1.2.1 /24
Interface S 0/0
IP: 11.1.254.1 /30
Interface S 0/0
IP: 11.1.254.2 /30
External
Switch
 ISP 1
Internet
Internal
Router
FTP
Server
11.1.2.4

In Figure 11.1 you see a basic DMZ conﬁguration. We placed a switch on the external
leg of the ﬁrewall, connecting the router to the ﬁrewall.You could use a crossover cable to
make this connection, but we placed it here because you could place a honeypot or IDS
sensor outside the ﬁrewall. Either way, this setup is highly ﬂexible based on your needs, but
you should be aware of the reason we placed the routers and switches where they are in the
graphic.
First, let’s work on routing trafﬁc from the internal LAN to the Internet. In this
example, we assume that there isn’t a proxy server and that users will access the Internet
directly via a default route.All routers on the internal LAN need to know where to send
trafﬁc destined for a resource on the Internet.This can be accomplished by using a static
route or a dynamic routing protocol such as OSPF or EIGRP.This could be a daunting task
if you had to add static routes or dynamically route each network on the Internet (since
there are currently over 150,000 Internet routes) on the internal routers—not to mention
that it would take a lot of memory and CPU cycles.
NOTE
If you want to use a proxy server, make sure that the internal users can access
the proxy server and in turn the proxy server can access the Internet. Proxy
servers are usually located on the DMZ, which requires ﬁrewall conﬁguration to
allow users to access the proxy server as well as allow the proxy server to access
the Internet. This approach prevents any direct communication between clients
on the protected internal network and untrusted Internet resources; all commu-
nication must ﬂow through the proxy server on the DMZ.
To reduce the amount of administration and computing power needed on internal
routers, we will use a default route or gateway of last resort to route trafﬁc to the Internet.
This means that if a router does not have a speciﬁc route to a destination, it will forward the
packet to its conﬁgured default route. In the example in Figure 11.1, the internal multilayer
switch provides connectivity for the internal LAN segments. For users on the internal LAN
who require access to the Internet, the internal router must have its default route or gateway
of last resort set to the ﬁrewall’s inside IP address. In this case, the router’s default route
would be 192.168.0.1. In turn, the ﬁrewall should check its routing table and forward the
packet to the Internet router, 11.1.1.2.
Before the ﬁrewall forwards this packet, it needs to perform a NAT on the packet source
address.The 192.168.0.0/16 network is a private network that could potentially be used in
every IP network in the world; therefore, we need to translate the address to a public address
that is assigned to our network, so we can be sure the return packets will make it back. In
this case, we will use the external IP address of the ﬁrewall for the NAT, to conserve address
space and simplify the conﬁguration. We could have just as easily used an available address in
www.syngress.com
506
Chapter 11 • DMZ Router and Switch Security

the 11.1.1.0/28 network, if we were so inclined.The Internet router will then forward the
packet to the ISP, where it will be routed to its destination, based on the ISP’s dynamic pro-
tocols.The internal router requires two commands to implement a static route, as shown in
Figure 11.2.The ip route command sets the default to 192.168.0.1 (the inside interface of the
ﬁrewall), and the ip classless command lets the router route to unknown subnets.
Figure 11.2 Conﬁguring a Default Route
InternalRouter(conﬁg)# ip route 0.0.0.0 0.0.0.0 192.168.0.1
InternalRouter(conﬁg)# ip classless
NOTE
If there are other routers in addition to the multilayer switch on the internal
network and you are using a dynamic routing protocol, you should redistribute
the default route into the routing protocol. This allows the default route to
propagate dynamically to the other routers in the routing domain and saves you
the effort of statically conﬁguring the default route on every router. Also, if your
topology contains redundant links, the dynamic protocol can automatically
route around failed links. The redistribution procedure might differ, depending
on the dynamic routing protocol in use. Refer to the following URL for more
information on advertising a default route and selecting the routing protocol(s)
used on your network: www.cisco.com/univercd/cc/td/doc/product/software/
ios122/122cgcr/ﬁpr_c/ipcprt2/index.htm.
At this point we have discussed how requests from the internal LAN are routed to the
Internet. Now we must look at how the replies are routed back and how requests initiated
from the Internet are routed to resources on the DMZ.The routing protocol of choice on
the Internet is Border Gateway Protocol (BGP), which enables the dynamic routing of net-
works across the Internet. BGP is an Exterior Gateway Protocol (EGP) used to connect
autonomous systems. In Figure 11.1, we showed the Internet router connecting to ISP 1 for
connectivity to the Internet. In some cases, this router is provided and managed by the ISP,
so the enterprise administrators do not have to worry about its conﬁguration; they simply
point their default route on the ﬁrewall to the Internet router’s local Ethernet interface
(11.1.1.2).The ISP will worry about advertising the enterprise’s public addresses (11.1.1.0
/28 and 11.1.2.0 /24) across the Internet so that everyone will know how to reach these
networks. However, if you (meaning the enterprise) manage the Internet router on your
premises and the ISP manages the connection on its end, there usually will be two options.
The ﬁrst option is to point a default route to the ISP’s border router on the serial connec-
tion, and the ISP will statically route your public address space (11.1.1.0 /28 and 11.1.2.0
www.syngress.com
DMZ Router and Switch Security • Chapter 11
507

/24) to your end as well as advertise it across the Internet. Figure 11.3 shows the routes
needed to conﬁgure the Internet router for a default route to the Internet via the ISP as
well as routes to reach the DMZ located on the DMZ leg of the ﬁrewall.
The second option is to use BGP to send and receive routing updates to and from the
ISP. For networks with a single Internet link, there is generally no need to run BGP, since
there is only one way in and out, but it can still be used if you prefer to employ some sort of
dynamic routing protocol. Many enterprises aren’t willing to suffer the downtime associated
with an Internet link failure, though, so they will have multiple Internet links and routers.
With multiple links, the enterprise can run BGP with each ISP and dynamically advertise
their networks.The rest of the Internet will learn of the multiple paths to the enterprise’s
network, and the trafﬁc can take the best path to the enterprise, depending on which paths
are currently available. We will discuss BGP in more detail in the next section.
Figure 11.3 Conﬁguring a Default Route
InternetRouter(conﬁg)# ip classless
InternetRouter(conﬁg)# ip route 0.0.0.0 0.0.0.0 11.1.254.1
InternetRouter(conﬁg)# ip route 11.1.2.0 255.255.255.0 11.1.1.1
Table 11.1 shows the routing tables for all enterprise-managed devices that are involved
when static routes are used to conﬁgure the network shown in Figure 11.1. Notice how the
Internet router has no knowledge of the internal LAN routes (192.168.0.0 /24, 192.168.1.0
/24, and 192.168.2.0 /24).This is because the private address space is not routable through
the Internet; furthermore, the ﬁrewall translates the internal source addresses to public
addresses on the 11.1.1.0/28 subnet.
Table 11.1 Routing Table
Device 
Route
Next Hop
Internal Router
192.168.0.0 /24
Local—VLAN10
192.168.1.0 /24
Local—VLAN11
192.168.2.0 /24
Local—VLAN12
Default
192.168.0.1
Firewall
192.168.0.0 /24
Local—inside interface
11.1.2.0 /24
Local—DMZ interface
11.1.1.0 /28
Local—outside interface
192.168.1.0 /24
192.168.0.2
192.168.2.0 /24
192.168.0.2
Default
11.1.1.2
www.syngress.com
508
Chapter 11 • DMZ Router and Switch Security
Continued

Table 11.1 Routing Table
Device 
Route
Next Hop
Internet Router
11.1.1.0 /28
Local—interface E 0/0
11.1.254.0 /30
Local—interface S 0/0
11.1.2.0 /24
11.1.1.1
Default
11.1.252.1
Border Gateway Protocol
As we mentioned in the previous section, BGP is the routing protocol used to dynamically
route packets across the Internet. If you are using BGP in your environment, you will want
to be sure that you sufﬁciently secure it so that hackers can’t easily attack your BGP session.
Let’s ﬁrst go through a quick review of how the BGP protocol works and then examine
some options about how to secure it.
The design and conﬁguration of BGP has been the topic of many books and articles,
including the BGP Case Studies document located on Cisco’s Web site at
www.cisco.com/warp/public/459/bgp-toc.html. We assume that if you are considering
administering a BGP connection to your ISP, you have extensive knowledge of the protocol
and are comfortable supporting it.
BGP routes trafﬁc between networks that are under different administrative controls.
These networks are known as autonomous systems (ASs). If you are running BGP, you will
have an AS number assigned to your organization, just as each of your ISPs will have its own
unique AS number assigned to it. BGP is able to scale to such large internetworks, such as
the Internet, because it doesn’t concern itself with what is inside the network of any partic-
ular AS.The details of the routing inside an AS are left to the Interior Gateway Protocols
(IGPs) such as OSPF, RIP, and EIGRP. Instead of tracking every router hop that must be tra-
versed to reach a destination, like IGP protocols, BGP tracks only the ASs that must be tra-
versed to get there.This design allows for the AS to grow to a massive size, with hundreds or
thousands of routers, and BGP won’t need to treat it any differently than when the AS had
only 10 routers. BGP allows government, education, and enterprise networks across the
world to communicate with each other seamlessly. BGP is highly scalable, ﬂexible, and very
robust—and it needs to be, because there are well over 150,000 BGP routes on the Internet.
Some of the key features of BGP are:
■
It is a path-vector protocol.
■
It uses TCP port 179 to communicate, or peer, with neighbors.
■
It supports classless interdomain routing (CIDR) to reduce the size of the
Internet’s routing tables by classless summarization.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
509

■
It is currently in version 4.
■
BGP running between routers in two different autonomous systems is considered
external BGP (eBGP), whereas BGP running between routers in the same AS is
considered internal BGP (iBGP).
■
It has an extensive number of BGP attributes that are used to decide the best path.
NOTE
AS numbers are assigned by the American Registry for Internet Numbers (ARIN).
For the enterprise to receive its own AS, it must meet some requirements,
including that the site must be multihomed, meaning that it has connectivity to
more than one ISP. For more information on AS number registration, visit ARIN’s
Web site at www.arin.net/registration/asn/index.html. 
BGP uses multiple attributes to describe every route entry in the BGP table and uses
these attributes in the route decision process.These attributes can be classiﬁed into four 
categories:
■
Well-known, mandatory
■
Well-known, transitive
■
Optional, transitive
■
Optional, nontransitive
The well-known attributes are required to be recognized by all implementations of
BGP, regardless of vendor.They are further divided into the mandatory attributes, which are
required to describe every route, and the discretionary attributes, which are not.The optional
attributes do not have to be supported by every BGP implementation and are divided into
the transitive attributes, which can be propagated to other ASs, and the nontransitive attributes
that cannot leave the originating AS. Some of the attributes that BGP uses are:
■
Next hop A well-known, mandatory attribute that contains the address of the
next-hop router that is used to reach the destination.
■
Origin A well-known, mandatory attribute that deﬁnes how a network was orig-
inated. Values are IGP for routes originated in the same AS, EGP for routes
learned outside the AS, and incomplete for routes injected into BGP through
another protocol (redistribution).
■
AS-Path The third well-known, mandatory attribute; records a list of the AS
numbers that are between the local router and the route destination. When a
www.syngress.com
510
Chapter 11 • DMZ Router and Switch Security

router sends a route to a neighboring AS (via eBGP), it prepends its own AS
number to the AS-Path.You will see later how this attribute is used in the decision
process, but it is also used for loop prevention. If a router receives a route with its
own AS number in the AS-Path, it can safely ignore the update so that loops are
not created.Trafﬁc should never pass through any particular AS more than once.
■
Weight A Cisco proprietary parameter used to select the preferred path to a des-
tination.This attribute is used only for decisions on the local router and is not
propagated to any neighbor routers.
■
Local preference A well-known, discretionary attribute that is also used to select
a preferred path to a destination.This is a similar attribute to weight, except it is
propagated throughout an AS so that all routers within an AS recognize and use
the path with the highest local preference.
■
Multi-exit discriminator (MED) An optional, nontransitive attribute that is
used to suggest to an external AS the preferred route into an AS, when multiple
paths exist.This attribute should not be propagated past the directly attached AS
and does not have to be honored by the neighboring AS.The lower MED value is
the preferred path.
■
Community An optional, transitive attribute that provides a way of grouping
destinations, to which routing decisions can be applied.You can think of this
attribute as a tag that can be applied to a route or a group of routes.The BGP
neighbor can decide to take certain actions with packets that match routes that are
“tagged” with a certain community value. Just as with the MED value, a neigh-
boring AS does not have to take any action just because a community has been
assigned to a route.
On a Cisco router, BGP determines the best path for a route by applying the fol-
lowing 10 routing decisions, in order:
1.
If the path speciﬁes a next hop that is inaccessible, do not consider it.
2.
Prefer the path with the largest administrative weight.
3.
If the weights are the same, consider the path with the higher local preference.
4.
If the local preferences are the same, prefer the path from which the local router
originated.
5.
If no route was originated, prefer the route with the shortest AS path.
6.
If all routes have the same AS-path length, prefer the path with the best origin
code. IGP is better than EGP, which is better than Incomplete.
7.
If the origin codes are the same, prefer the path with the lowest MED metric.
8.
If the paths have the same MED, prefer external paths over internal paths.
9.
If the paths are still the same, prefer the path through the closest IGP neighbor.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
511

10.
Lastly, prefer the path with the lowest IP address for the unique BGP router ID.
BGP is a very complex routing protocol.Trying to explain all its nuances in this brief
section would not be possible. However, we do cover some basic features as well as how to
secure BGP updates, because that is what you will be concerned about while securing your
DMZ infrastructure.
NOTE
If you are taking in full BGP routes from your ISP, make sure that you have
enough memory in the routers supporting BGP. Because the Internet has over
150,000 routes, you need a minimum of 128MB of RAM. 
As we mentioned in the previous section, all ISPs offer a managed service that provides
the customer with the equipment, conﬁguration, and support needed for the links con-
necting the site to the Internet.This means that the ISP will take care of managing all
aspects of running the Internet router pictured in Figure 11.4.All the customer has to do is
connect the Internet router’s Ethernet interface to the external switch (assuming the same
topology as Figure 11.1) and conﬁgure a default on the ﬁrewall route to point to the
Internet router. Easy, right? Well, if you’ve ever dealt with some ISPs, you know it can be
difﬁcult to get them to make changes, or even have them provide performance reports and
statistics for the router and the Internet link. However, in many cases this is still the best
option if you have limited technical resources and only one ISP.
Should you have multiple links to different ISPs and the technical resources required, it
could be advantageous to control the Internet-facing router(s) yourself.This solution will
allow you more control of the way Internet trafﬁc enters and exits you network via the dif-
ferent ISPs. BGP has many “knobs and switches” (attributes) that allow you to shape the ﬂow
of trafﬁc so that the best path is taken. Controlling the Internet-facing router(s) also gives
you complete access into the router for detailed reports and statistics of router and Internet
link performance as well as more visibility for applying and managing security and for trou-
bleshooting problems.
In Figure 11.4, we show connectivity to the Internet via a link to ISP 1. For simplicity,
we break ARIN’s multihomed requirement for this example.The enterprise has a registered
public address space (11.1.1.0 /28 and 11.1.2.0 /24) and an AS number (AS 200) that it
wants advertised to the Internet so that internal users can access the Internet and users on
the Internet can access resources on the DMZ.To accomplish this task, we need to conﬁgure
BGP on the Internet router to advertise the enterprise’s public addresses to its BGP
neighbor at ISP 1 (which is fully managed by the ISP) as well as receive routing updates
from ISP 1.
www.syngress.com
512
Chapter 11 • DMZ Router and Switch Security

In global conﬁguration mode, we enable BGP and set the AS number to 200 on the
Internet router using the router bgp command, as shown in Figure 11.5.The no synchronization
command disables BGP from checking its interior gateway protocol (IGP) for reachability
before it advertises the route to its neighbor.
We use the network statement to tell BGP what local networks to advertise. In this case,
we need to advertise the 11.1.1.0 /28 and 11.1.2.0 /24 subnets to the Internet.The network
statement has the restriction that it will advertise the conﬁgured network only if it is in the
local routing table of the router.The subnet 11.1.1.0 /28 is directly connected to the router,
so it knows how to reach the subnet. However, subnet 11.1.2.0 /24 is not directly connected
but is located on the ﬁrewall’s DMZ interface.To advertise this route, we must add a static
route for 11.1.2.0 /24 (the ﬁrst line in the example), since we are not running an IGP in
our DMZ.This allows the Internet router to advertise this route to its BGP neighbor,
because it now exists in the routing table. Once we have established the AS and the networks
we need to advertise, we can move on to establishing a neighbor to the ISP router.
Figure 11.4 A Single BGP Neighbor to an ISP
To conﬁgure a neighbor, we use the neighbor remote-as command to specify the neighbor
IP address and AS number. In this example, the IP address of the neighbor is 11.1.254.1, and
the AS for ISP 1 is 100. It is also a good idea to add a route map, distribution list, ﬁlter list, or
preﬁx list to limit the routes being advertised or received by your AS. If you are in a multi-
homed environment and you do not have ﬁlters in place to limit what is advertised to your
ISPs, you can mistakenly become a transit AS by advertising all routes received from one
provider to the other. If this happens, it can inundate your Internet link with unwanted trafﬁc.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
513
Web 
Server
11.1.2.2
E-Mail 
Server
11.1.2.3
FTP
Server
FTP
11SeSe.1.2.4
erver
rve
Internet 
Router
AS 200
Firewall
VLAN 20
VLAN 20
VLAN 
30
VLAN
30
External
Switch
DMZ
Switch
VLAN 20
VLAN 20
 ISP 1
AS 100
Interface E 0/0
IP: 11.1.1.2 /28
Outside Interface
IP: 11.1.1.1 /28
DMZ Interface
IP: 11.1.2.1 /24
Interface S 0/0
IP: 11.1.254.2 /30
Interface S 0/0
IP: 11.1.254.1 /30
To the 
Internal 
LAN
Internet
FTP
Server
11.1.2.4

In the example, we use a route-map to allow the router to advertise only the enterprise’s
registered public address space (11.1.1.0 /28 and 11.1.2.0 /24) to the ISP using the neighbor
route-map command and a route map that calls on access list 5.The no auto-summary com-
mand disables the autosummarization of advertised routes to their classful boundaries, such as
11.0.0.0/8.Assuming that the ISP has conﬁgured its end, at this point you should be able to
establish a neighbor peering with the ISP and be able to share BGP routing information.To
view the status of BGP neighbors, use the show ip bgp neighbors command or the show ip bgp
summary; to view BGP routes, use the show ip bgp command.
Figure 11.5 BGP Example
InternetRouter(conﬁg)# ip route 11.1.2.0 255.255.255.0 11.1.1.1
InternetRouter(conﬁg)# route-map RoutesOut permit 10
InternetRouter(conﬁg-route-map)# match ip address 5
InternetRouter(conﬁg)# access-list 5 permit 11.1.1.0 0.0.0.15
InternetRouter(conﬁg)# access-list 5 permit 11.1.2.0 0.0.0.255
InternetRouter(conﬁg)# router bgp 200
InternetRouter(conﬁg-router)# no synchronization
InternetRouter(conﬁg-router)# network 11.1.1.0 mask 255.255.255.240
InternetRouter(conﬁg-router)# network 11.1.2.0 mask 255.255.255.0
InternetRouter(conﬁg-router)# neighbor 11.1.254.1 remote-as 100
InternetRouter(conﬁg-router)# neighbor 11.1.254.1 route-map RoutesOut out
InternetRouter(conﬁg-router)# no auto-summary
At this point, we have a pretty standard BGP conﬁguration. We should be receiving any
routes that we are conﬁgured to receive from our ISP (default-only, local customer, or full
routing table, as examples) and we are advertising our networks, allowing our networks to be
reachable across the Internet. Now we need to concern ourselves with how to secure our
BGP session from tampering.To do this, we will enable the MD5 authentication feature,
which can be used on a per-neighbor basis.This feature will generate an MD5 hash from the
packet contents and then attach it to the update before it is sent to the neighboring device.
The neighbor will then verify that the packet has not been tampered with by verifying the
hash value before accepting the update.You will use the neighbor password command, which is
shown in Figure 11.6, to enable this feature. Not all ISPs require this option to be set, but it
is a good idea to implement it so that hackers spooﬁng the ISP can’t inject bad routes into
your Internet router.You will need to agree on a password and an implementation time, in
advance, with your ISP because the BGP session will not stay connected unless both sides
are conﬁgured with the same password.
Figure 11.6 Securing BGP with MD5 Authentication
InternetRouter(conﬁg)# router bgp 200
InternetRouter(conﬁg-router)# neighbor 11.1.254.1 password myBGPpassword
www.syngress.com
514
Chapter 11 • DMZ Router and Switch Security

It is important to note that the password conﬁgured in Figure 11.6 is used as an
example only.You need to make sure that you use a strong password for your BGP authenti-
cation, or else your network might not be as secure as you think. If you choose an easy pass-
word, it could be quickly cracked with a brute-force or dictionary attack, whereas strong
passwords would take enough time as to make the process infeasible. If this password is com-
promised, the MD5 authentication will be of no use, since a hacker will be able to authenti-
cate malicious trafﬁc.Also keep in mind that enabling this feature, even with strong
passwords, is no guarantee that your BGP session cannot be tampered with. For example,
there is a theoretical DoS attack against the BGP authentication process in Cisco routers that
could be used to disrupt your BGP session if you are not running a version of IOS that cor-
rects for the vulnerability.
Another way to help prevent hackers from being able to inject faulty information or dis-
rupting your BGP sessions is to implement the BGP TTL Security Hack (BTSH).An eBGP
session, by default, can talk with only a BGP peer that is directly connected to the router.
This is because the originating router will set the time-to-live (TTL) setting in the outgoing
packet to 1, so if the BGP neighbor is not the directly connected device, the upstream
device will decrement the TTL to 0 and drop the packet. However, in some situations you
might need to establish an eBGP session between devices that are more than one hop away.
The way around this problem is to use the eBGP multihop. When eBGP multihop is used,
the TTL in the outgoing packet will be set to the number speciﬁed in the multihop com-
mand, allowing the packet to travel as many hops as required to reach the destination.
Although this might seem like some measure of security in itself, it really doesn’t pro-
vide any security at all. One reason is that BGP doesn’t require that inbound eBGP packets
have a TTL of 1 when they arrive at the destination router. If you don’t know how many
hops away your eBGP neighbor is, you can set the eBGP multihop command to 255 hops
and the session will still establish without issue, as shown in Figure 11.7. Even if this check
was in place, it wouldn’t stop a hacker from setting the TTL on the malformed BGP packets
high enough so that the TTL is the correct value when it arrives at the target router.To
remedy this situation, the BTSH was created.This feature alters the way the TTL is conﬁg-
ured on the BGP peers. For this reason, BTSH and eBGP multihop cannot co-exist with
each other; you must choose the one you want to use.
Figure 11.7 Conﬁguring eBGP Multihop
InternetRouter(conﬁg)# router bgp 200
InternetRouter(conﬁg-router)# neighbor 11.1.254.1 ebgp-multihop 255
BTSH works by being conﬁgured with the number of hops between the eBGP peers
and then setting the TTL for the conﬁgured session to the maximum number, 255. When
the other peer receives the eBGP packet, it knows how many hops are between the two
routers and expects the TTL to be set accordingly. If the two peers are two hops away from
each other, they would expect a TTL of 253 when the packet arrives on the external inter-
www.syngress.com
DMZ Router and Switch Security • Chapter 11
515

face. If the TTL is any lower, the packet will not be accepted. Since the TTL is already set to
the maximum value, this approach prevents a hacker from being able to increase the value to
compensate for the additional hops to send a malicious BGP packet to one of the peers.An
example of this conﬁguration is shown in Figure 11.8.
Figure 11.8 Conﬁguring BTSH
InternetRouter(conﬁg)# router bgp 200
InternetRouter(conﬁg-router)# no neighbor 11.1.254.1 ebgp-multihop 255
InternetRouter(conﬁg-router)# neighbor 11.1.254.1 ttl-security hops 2
BTSH is a fairly new feature that was introduced in 12.0(27)S, which is part of the ser-
vice provider train of code and was later added to 12.3(7)T and later.
Access Control Lists
Access control lists (ACLs) allow a router to ﬁlter trafﬁc that passes through it based on a
certain set of criteria.A router can ﬁlter a number of protocols, but since DMZs mainly use
IP, we concentrate here on IP ACLs.ACLs can be applied inbound or outbound on any
interface of the router and will ﬁlter based on a variety of ﬁelds in the IP header as well as
the headers that belong to higher-layer protocols such as TCP, UDP, and ICMP. It is impor-
tant to remember that ACLs are, for lack of a better term, dumb packet ﬁlters.They do not
possess any of the intelligence that is included in stateful ﬁrewall products.They look indi-
vidually at each packet, check the packet against the parameters of the access list, and make a
decision for each packet.ACLs can be placed anywhere on your network, but in this section,
we concentrate on creating and applying ACLs in key areas within your Internet/DMZ
infrastructure. Depending on your design, you might need to place ACLs in other strategic
areas to protect your network resources.
ACLs are processed top down, and when a match is found, the router executes the
action (permit or deny) and stops checking for further matches.Therefore, the order of the
lines that make up the ACLs is very important. Many people make the mistake of making
broad permit statements, then later in the ACL conﬁguring a speciﬁc deny statement, or vice
versa.This might not provide the desired effect, so be careful when you’re creating ACLs,
because a simple ACL error can open holes in your network that hackers can exploit.All
ACLs have an implicit deny all statement appended at the end, so if a packet is not explicitly
permitted, it will be denied.
There two types of IP ACL: standard and extended.A standard ACL can only ﬁlter based
on the source IP address and mask.The command to create a standard ACL is access-list
<access-list-number> <action> <source-IP> [source-wildcard] [log] in global conﬁguration mode.
As you can see, the command has many parameters, which we have broken down here:
■
Access-list-number Groups the ACL entries together. For standard ACLs, the
number must be between 1 and 99 or between 1300 and 1999.
www.syngress.com
516
Chapter 11 • DMZ Router and Switch Security

■
Action Deﬁnes the action the router will take if the entry is matched.The values
are permit or deny.The permit action allows the packet to continue; the deny action
drops the packet.
■
Source IP The source IP address of the packet.This can be any valid IP address or
the keyword any to signify all IP addresses.
■
Source-wildcard  The wildcard mask or bits to applied to source IP to determine
a range of addresses. If no wildcard mask is speciﬁed (it is optional), the router
assumes you are specifying a single host.
■
Log This statement at the end of a line will generate a log message upon a suc-
cessful match of the speciﬁc entry.This message can be printed to the console, the
internal log buffer or syslog, depending on how you have conﬁgured the logging
facilities on the router.
The example in Figure 11.9 illustrates a standard ACL.The ACL number is 1 and only
permits to a host with the IP address of 192.168.1.50 and any device within the subnet
10.10.0.0 /16.All other trafﬁc is dropped and logged.
NOTE
ACLs can be used in many devices, not just routers. Today almost any device you
purchase that offers some form of security is able to create an ACL. 
Figure 11.9 Standard ACL Example
DMZRouter(conﬁg)# access-list 1 permit 192.168.1.50
DMZRouter(conﬁg)# access-list 1 permit 10.10.0.0 0.0.255.255
DMZRouter(conﬁg)# access-list 1 deny any log
An extended ACL can ﬁlter on the source and/or destination IP address as well as ﬁlter
on source and/or destination port. Extended ACLs can also ﬁlter on other characteristics of
each speciﬁc protocol—for instance, the ﬂags in the TCP header and the many different
functions of ICMP, to name a few.The command to create an extended ACL is access-list
<access-list-number> <action> <protocol> <source-IP> <source-wildcard> [operator [port]] <desti-
nation-IP> <destination-wildcard> [operator [port]] [log]] in global conﬁguration mode.
■
Access-list-number Groups the access list entries together. For extended ACLs,
the number must be between 100 and 199 or between 2000 and 2699.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
517

■
Action Deﬁnes the action the router will take if the entry is matched.The values
are permit or deny.The permit action allows the packet to continue; the deny action
drops the packet.
■
Protocol The name or number of an Internet protocol.The most common values
are TCP, UDP, IP, and ICMP. If IP is deﬁned, it means anything that runs on top of
IP, including but not limited to TCP, UDP, and ICMP.
■
Source-IP The source IP address of the packet.This can be any valid IP address
or the keyword any to signify all source IP addresses.
■
Source-wildcard The wildcard mask or bits to apply to the source IP to deter-
mine a range of addresses.This ﬁeld is not used when the keyword any is used in
the previous ﬁeld.
■
Destination-IP The destination IP address of the packet.This can be any valid IP
address or the keyword any to signify all destination IP addresses.
■
Destination-wildcard The wildcard mask or bits to apply to the destination IP to
determine a range of addresses.This ﬁeld is not used when the keyword any is
used in the previous ﬁeld.
■
Operator This is optional; operands used to compare source or destination ports.
Possible operands are lt (less than), gt (greater than), eq (equal), neq (not equal), and
range.
■
Port The number or name of a TCP or UDP port (optional).
■
Log This statement at the end of a line will generate a log message upon a suc-
cessful match of the speciﬁc entry.This message can be printed to the console, the
internal log buffer, or syslog, depending on how you have conﬁgured the logging
facilities on the router.
NOTE
We listed only some of the most common parameters used in an extended ACL.
There are several other parameters for each speciﬁc Internet Protocol. Cisco
routers also support named ACLs, where names can be given to the standard
and extended ACLs instead of assigning a number. For further details on ACLs,
refer to Cisco router IOS documentation or the following URL:
www.cisco.com/univercd/cc/td/doc/product/software/ios122/122cgcr/ﬁpr_c/ipcprt
1/1cﬁp.htm#1109098. 
Figure 11.10 shows an example of an extended ACL.The ACL number is 102 and
allows ICMP connectivity to and from any host, allows only SNMP access to devices on the
www.syngress.com
518
Chapter 11 • DMZ Router and Switch Security

192.168.1.0 /24 subnet from all hosts, and lastly, permits UDP access from the 192.168.2.0
/24 subnet to the 192.168.1.0 /24 subnet.As with all ACLs, any access not explicitly per-
mitted will be denied.
Figure 11.10 Extended ACL Example
DMZRouter(conﬁg)# access-list 102 permit icmp any any
DMZRouter(conﬁg)# access-list 102 permit tcp any 192.168.1.0 0.0.0.255
eq snmp
DMZRouter(conﬁg)# access-list 102 permit udp 192.168.2.0 0.0.0.255
192.168.1.0 0.0.0.255
To apply an ACL to an interface, use the ip access-group <access-list-number> {in | out}
command in interface conﬁguration mode.Access lists can be applied inbound or outbound
on an interface.The example in Figure 11.11 applies ACL 102 inbound to Fast Ethernet
interface 0/0.
Figure 11.11 Extended ACL Example
DMZRouter(conﬁg)# interface fastethernet 0/0
DMZRouter(conﬁg-if)# ip access-group 102 in
Conﬁguring & Implementing…
Tips on Conﬁguring ACLs for the 
Ingress Interface of Internet-Facing Routers 
In the example in Figure 11.12, we show a typical enterprise branch ofﬁce with
an internal LAN, a DMZ, and connectivity to the Internet. The ﬁrewall will protect
the internal LAN and the DMZ, but the LAN segment in front of the ﬁrewall is left
unprotected, as is the Internet router. Assuming that you control the Internet
router, meaning that it is not part of a service managed by your ISP, you can apply
an ACL to provide some protection for devices connected to the outside LAN,
including the Internet router, switches, and any other device that might be out-
side the ﬁrewall. ACLs can be applied to the ingress or egress interfaces on the
router, to ﬁlter access. In this conﬁguration template, we cover how to conﬁgure
ACLs to protect against unauthorized access and prevent common hacking tech-
niques. We then ﬁnish by discussing how to apply the ACL to the Internet-facing
router’s inbound interface, as shown in Figure 11.12.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
519
Continued

All ingress Internet router ACLs should start with an antispooﬁng ACL,
which will prevent spooﬁng of the special address ranges described in RFC 3330,
Special-Use IPv4 Addresses. RFC 3330 is meant to be a collection of address
assignments that have been made in other RFC documents and includes the pri-
vate address ranges already assigned from RFC 1918, among others. These pri-
vate address ranges, such as 10.0.0.0/8, 172.16.0.0/12, and 192.168.0.0/16,
should be blocked at your Internet border because trafﬁc sourced from these net-
works would never be valid. The exclamation point in the following cod was
added for visual and explanation purposes only and is not needed, nor will it be
shown in the conﬁguration:
! To block spooﬁng of RFC 1918 Address ranges
IntRouter(conﬁg)# access-list 110 deny ip 10.0.0.0
0.255.255.255 any
IntRouter(conﬁg)# access-list 110 deny ip 172.16.0.0
0.15.255.255 any
IntRouter(conﬁg)# access-list 110 deny ip 192.168.0.0
0.0.255.255 any
There are other address ranges listed in RFC 3330 that you will most likely
want to drop in your ACL, such as the loopback range of 127.0.0.0/8, the Link
Local range of 169.254.0.0/16, the Test-Net range of 192.0.2.0/24, and the mul-
ticast range of 224.0.0.0/4. Again, these are ranges that are assigned for special
uses and should never be seen on the Internet. You need to understand your net-
work and its trafﬁc patterns well enough to decide if you also want to block all
the other ranges listed in RFC 3330.
Some Web sites, such as www.cymru.com/Bogons/, also keep a list of net-
work ranges from which you should never see Internet trafﬁc sourced. They refer
to these invalid address ranges as bogons, which include the addresses men-
tioned in RFC 3330, as well as IP blocks that haven’t yet been assigned for allo-
cation. Since these address ranges are not being assigned to users, there is no
valid reason that you should see trafﬁc on the Internet coming from these ranges.
You could decide to manually ﬁlter these preﬁxes by creating an access list based
on the list, or you can use one of the other available methods, such as a BGP
peering session, to receive and ﬁlter these networks in a more automated
fashion. 
In addition to denying trafﬁc sourced from the private and unallocated
address ranges, we can also deny trafﬁc that is sourced from the public address
ranges that have been assigned to our enterprise. All valid trafﬁc going into our
network should have a destination of our public address ranges, but we should
never receive trafﬁc on our Internet connection that is sourced from our public
address ranges. We can add a couple lines to our ACL to deny this trafﬁc:
www.syngress.com
520
Chapter 11 • DMZ Router and Switch Security
Continued

! Block spooﬁng of our public address ranges
IntRouter(conﬁg)# access-list 110 deny ip 11.1.1.0
0.0.0.15 any
IntRouter(conﬁg)# access-list 110 deny ip 11.1.2.0
0.0.0.255 any
Figure 11.12 Ingress Internet-Facing Router ACL
To allow only ICMP echo replies to enter the network from pings originated
from the internal network, you must ﬁrst permit the echo replies, then deny all
other ICMP trafﬁc so that pings initiated from the Internet will not be able to
enter the network. This is an optional step but can be useful to prevent some DoS
attacks:
! Allow ICMP echo reply from a ping initiated from the
internal LAN
IntRouter(conﬁg)# access-list 110 permit icmp any any echo-
reply
IntRouter(conﬁg)# access-list 110 deny icmp any any
Since the Internet router is the ﬁrst line of defense against DoS attacks or
worms, this ACL can be a point at which known attacks or worms can be
thwarted or isolated. For example, to mitigate the exposure of the SQL Slammer
worm, Cisco recommended the following ACL at ingress and egress points of the
www.syngress.com
DMZ Router and Switch Security • Chapter 11
521
Web 
Server
11.1.2.2
E-Mail 
Server
11.1.2.3
Internet
Internet 
Router
AS 200
PIX
 ISP 1
AS 100
Interface F 0/0
IP: 11.1.1.2 /28
Outside Interface
IP: 11.1.1.1 /28
DMZ Interface
IP: 11.1.2.1 /24
Interface S 0/0
IP: 11.1.254.2 /30
Interface S 0/0
IP: 11.1.254.1 /30
Inside Interface
IP: 192.168.0.1/24
User
DMZ
LAN
User
Internet 
FTP
Server
11.1.2.4
Continued

network. This step is optional but can be an effective option in trying to prevent
a fast-moving attack or worm from spreading any further:
! Stop the SQL Slammer worm from spreading
IntRouter(conﬁg)# access-list 110 deny udp any any eq 1434
After you have all the speciﬁc entries deﬁned, you must add the permit all
statement so that legitimate trafﬁc can ﬂow through the router:
! Permit all other access
IntRouter(conﬁg)# access-list 110 permit ip any any
The last step is to apply the ACL the Internet ingress points. In this case, we
apply ACL 110 to Serial 0/0 on the Internet router:
IntRouter(conﬁg)# interface serial 0/0
IntRouter(conﬁg-if)# ip access-group 110 in
Security Banner
All network devices should present the legitimate end user, unauthorized user, or adminis-
trator logging into the system with a legal message prior to the login screen.The message
should contain the following four statements, at a minimum:
■
Unauthorized access is prohibited.
■
Unauthorized access is unlawful, and violators may face civil and/or criminal 
prosecution.
■
Access or attempted access to the system may be recorded and used as evidence 
in court.
■
Any applicable federal, state, or local laws should be cited.
These notices help in the prosecution of any unauthorized person who attempts to
enter and possibly succeeds in entering the system. Unfortunately, even criminals have rights,
and to protect your network, these legal notices are necessary so that you can pursue convic-
tion of intruders, should the need arise.The security banner should be a legal notice and not
contain any information about the device such as its name, make, model, or function.This
information could be useful to intruders trying to break into the system.You should always
check with your legal and security departments prior to conﬁguring the security banner on
your devices to make sure it is worded correctly, meets corporate policies, and will hold up
in court.
The Cisco router can display your legal message prior to the login screen with the use
of the banner login command. Figure 11.13 shows an example of a security banner.
www.syngress.com
522
Chapter 11 • DMZ Router and Switch Security

Figure 11.13 Conﬁguring a Security Banner
DMZRouter(conﬁg)# banner login ^
Warning!!!
You have accessed a private network.
UNAUTHORIZED ACCESS IS PROHIBITED BY LAW
Violators may be prosecuted to the fullest extent of the law.
Your access to this network may be monitored and recorded for quality
assurance, security, performance, and maintenance purposes.
^
NOTE
There are also different login levels for a Cisco device, and other banners can be
constructed for these different levels. For example, let’s say that you have
Banner MOTD, which stands for message of the day. If you conﬁgure banners,
make sure you test them to ensure that you have conﬁgured the proper one. If
your device is compromised, you will not want to provide the attacker with any
information whatsoever. Using tools such as a vulnerability scanner or analyzer,
hackers can do entire scans (sweeps) of large IP address ranges, and the tools
they use will provide them with the banner information. They can then go
through the logs searching for any useful information. If you use banners,
ensure that they provide no useful information at all. 
Securely Administering the Router
This section describes how to conﬁgure the router so that management interfaces and ser-
vices are protected and locked down. We secure all the entries into the CLI or via Web
management.To secure this access, we need to secure all in-band and out-of-band connec-
tivity options to include the console, auxiliary,Telnet, SSH, and HTML.This is done to pre-
vent hackers from making changes to the router’s conﬁguration, gathering important
network information, or using the compromised router as a launching point for other
attacks.You will learn how to use TACACS+ or RADIUS servers to authenticate, authorize,
and log access to the router. Lastly, we discuss using and securing management services such
as SNMP, NTP, and syslog.
Console and Auxiliary Ports
Routers have console and auxiliary ports to allow direct serial access to the routers’ CLI. By
default, there is no security on these interfaces, so it is very important to secure these entry
points into a router’s CLI; if they are left unconﬁgured, a hacker with physical access to the
www.syngress.com
DMZ Router and Switch Security • Chapter 11
523

router can literally connect a laptop to the router’s console or auxiliary port and access the
network with no interference. If you purchase a new router and basically conﬁgure it to pass
trafﬁc without locking it down using the methods described in this chapter, it is highly likely
that you will suffer an attack.Access to the console and auxiliary port can be protected by a
password or authenticated via a TACACS or RADIUS server.This type of access can be used
for general maintenance and monitoring or when access via other methods, such as Telnet or
SSH, is rendered useless due to conﬁguration error or malfunction, whereas accessing the
router via the console could be your last option to correct the problem before having to call
Cisco’s TAC for assistance.
NOTE
Cisco’s TAC is responsible for providing Cisco customers with assistance for
technical and conﬁguration issues for all Cisco’s hardware and software prod-
ucts, including the PIX ﬁrewall. Cisco’s TAC can be contacted by phone or via
the following URL: www.cisco.com/en/US/support/index.html.
By default, no password is set on the console and auxiliary ports. It is very important to
apply a password via the password command to the console or auxiliary interface, to protect
and discourage unauthorized personnel from attaching to the console or auxiliary ports and
obtaining unabated access to exec mode.As always, the password should be a nondictionary
word, difﬁcult to guess, and it should contain a combination of letters, numbers, and special
characters.A weak password will be easily cracked via a dictionary or brute-force attack (a
topic that is covered in Chapter 15,“Hacking the DMZ.”). Passwords can contain up to 80
characters, are case sensitive, and cannot begin with a number. When possible, use TACACS
or RADIUS to authenticate access to the console port, because this allows for centralized
control of the device and makes it easier to audit security violations. We discuss how to con-
ﬁgure TACACS or RADIUS support later in this section.Always apply an exec-timeout
timeout so that idle sessions will time out after a conﬁgured amount of time, such as 15
minutes, as conﬁgured in Figure 11.14.The example in Figure 11.14 illustrates how to use
these commands to secure the console and auxiliary ports.
NOTE
If you want the most secure router (or switch) with virtually no way to pene-
trate it, consider using only out-of-band management via the console. If you
lock your router in a closet or cabinet and use only console access, attackers can
do very little in the way of penetration. This situation becomes a nightmare to
administer, but then again, it is only an option for you to choose, depending on
your need for high security or what your security policy dictates. 
www.syngress.com
524
Chapter 11 • DMZ Router and Switch Security

Figure 11.14 Conﬁguring Console and Auxiliary Ports
DMZRouter(conﬁg)# line con 0
DMZRouter(conﬁg-line)# password H@rd2Cr@ck
DMZRouter(conﬁg-line)# exec-timeout 15 0
DMZRouter(conﬁg)# line aux 0
DMZRouter(conﬁg-line)# password H@rd2Cr@ck
DMZRouter(conﬁg-line)# exec-timeout 15 0
Telnet
The Cisco router provides the ability for you to Telnet to the CLI so you can manage and
administer the device.The router usually allows for ﬁve simultaneous Telnet sessions from
hosts or networks you specify via an ACL.As is the case with the console port,Telnet access
can be protected by a password or authenticated via a TACACS or RADIUS server.
Remember that Telnet trafﬁc is sent in clear text, and if someone is snifﬁng your network,
they can easily capture the router’s Telnet password or the enable password, or if you are
using AAA, they will be able to obtain a user ID and password and use them later for other
malicious activity.
Figure 11.15 shows how to conﬁgure the ﬁve Telnet sessions (numbered 0 though 4) on
the router under the line vty 0 4 virtual terminal line conﬁguration section.You can apply
a password to the virtual interface via the password command. Remember to use a pass-
word that is hard to guess and is a combination of characters and numerals.
Follow the same rules of selecting a password as in the console section. For further
protection, apply an access list that limits the hosts that are allowed to Telnet to the
router. In this example, we used the access-class command to apply access list 10, which
allows only the host with IP address of 192.168.1.50 to Telnet to the router.As with the
console port, apply an exec-timeout timeout so the sessions will time out after an idle period,
again set to 15 minutes in Figure 11.15.The transport input command speciﬁes the type of
protocol to allow on this line. In the example, we allow only Telnet sessions on this line.
Figure 11.15 Telnet Conﬁguration Example
DMZRouter(conﬁg)# access-list 10 permit host 192.168.1.50
DMZRouter(conﬁg)# line vty 0 4
DMZRouter(conﬁg-line)# password H@rd2Cr@ck
DMZRouter(conﬁg-line)# access-class 10 in
DMZRouter(conﬁg-line)# exec-timeout 15 0
DMZRouter(conﬁg-line)# transport input telnet
www.syngress.com
DMZ Router and Switch Security • Chapter 11
525

SSH
One of the major weaknesses inherent to a Telnet session is that all data is sent in clear text.
This can be a serious security vulnerability if someone is able to sniff your Telnet session to
the router.This eavesdropping and snooping of your connection, either promiscuously or via
a man-in-the-middle (MITM) attack, can provide just about any attacker with your full set
of credentials because they will not be secured via encryption.The router can support SSH
version 1.x and 2.0, depending on the IOS version, which gives the administrator secure
access to the router’s CLI.All trafﬁc between the administrator’s workstation and the router
is encrypted, which will make it difﬁcult for a hacker to capture IDs and passwords. Unlike
Telnet, which is available by default on almost every operating system, an SSH client is
required and usually needs to be installed on the workstation(s) that will be managing the
router via SSH.As with the other access methods, the router can be protected by a password
or authenticated via a TACACS+ or RADIUS server.
NOTE
To use SSH, you need SSH conﬁgured on the device you are going to connect
to, and you must run an SSH client on your workstation. Most UNIX/Linux distri-
butions provide SSH, or you can download SSH to use on other operating sys-
tems, such as Windows, from vendors that provide it. Two providers that are
most common are located at www.ssh.com and www.openssh.org. 
To conﬁgure SSH, an IOS loaded image must support DES or 3DES encryption to
generate an RSA key. If the IOS meets this requirement, we can conﬁgure SSH as shown in
Figure 11.16.The router must be assigned a hostname and a domain name prior to gener-
ating an RSA key. In this case, the hostname is DMZRouter and the domain name is syn-
gress.com.To generate an RSA key, use the crypto key generate rsa command, which will
prompt you to enter a modulus; at this prompt you need to enter 1024.
Depending on the router, this process could take some time to complete because the
RSA key generation is processor intensive. Some of the lower-end router models can take
several minutes to generate a key.
Once the prompt is returned to you, set the SSH timeout, which speciﬁes how long the
router should wait for the client to respond during the negotiation phase, using the ip ssh
time-out command. In this example, it is set at 60 seconds, which is a good timeout, but you
can set it however you see ﬁt.You can also specify a limit for authentication retries, after
which the connection is reset and the client will lose connectivity. In this case, the ip ssh
authentication-retries command is used to set the authentication retry limit to 3.
When you’re implementing SSH, it is necessary to create a local user database or authenti-
cate users via a TACACS+ or RADIUS server because SSH requires a username and password.
www.syngress.com
526
Chapter 11 • DMZ Router and Switch Security

In the example in Figure 11.16, we created a local user dmzadmin with the password letmein
for simplicity. But again, in a production environment, we recommend using a TACACS+
or RADIUS server with strong passwords to authenticate SSH users. Like Telnet, SSH can sup-
port ﬁve SSH simultaneous sessions by default. Since the virtual terminal lines (line vty 0 4)
default to using just the line password, we need to tell the router that we want to prompt for
username and password, based on the locally conﬁgured user database.We can accomplish this
by entering the login local command in the vty conﬁguration.
As with the Telnet example, we used the access-class command to apply access list 10,
which allows only the host with an IP address of 192.168.1.50 to SSH to the router,
applied an exec-timeout timeout so sessions will time out after 15 minutes of idle time, and
used the transport input command to only allow SSH sessions on this line. When we say SSH
to a router, it’s the same idea as though you were to Telnet to a router. For more information
on SSH, visit this URL: www.cisco.com/warp/public/707/ssh.shtml.
Figure 11.16 SSH Conﬁguration Example
DMZRouter(conﬁg)# ip domain-name syngress.com
DMZRouter(conﬁg)# crypto key generate rsa
The name for the keys will be: syngress.com
Choose the size of the key modulus in the range of 360 to 2048 for your
General Purpose Keys. Choosing a key modulus greater than 512 may
take a few minutes.
How many bits in the modulus[512]? 1024
Generating RSA keys.... [OK].
DMZRouter(conﬁg)# ip ssh time-out 60
DMZRouter(conﬁg)# ip ssh authentication-retries 3
DMZRouter(conﬁg)# username dmzadmin password letmein
DMZRouter(conﬁg)# access-list 10 permit host 192.168.1.50
DMZRouter(conﬁg)# access-list 10 deny any log
DMZRouter(conﬁg)# line vty 0 4
DMZRouter(conﬁg-line)# login local
DMZRouter(conﬁg-line)# transport input ssh
DMZRouter(conﬁg-line)# access-class 10 in
DMZRouter(conﬁg-line)# exec-timeout 15 0
HTTP and HTTPS
Some newer versions of the Cisco IOS support Web-based management and conﬁguration
of routers using HTML through a Web browser.This requires the router to run Web server
code so that it can serve the HTML pages. Just like other Web server software, the IOS
Web-based conﬁguration tool has been found vulnerable to exploits.These exploits are cor-
rected by performing an IOS upgrade on your router, which is a disruptive process that
www.syngress.com
DMZ Router and Switch Security • Chapter 11
527

requires a reboot of the router.To make things worse, communication between the browser
and the router happens in clear text, including usernames and passwords. Due to the lack of
encryption and the possibility that more vulnerabilities will be found in the future, it is rec-
ommended that this feature be disabled.This feature is generally considered not very effec-
tive for the support and day-to-day maintenance of the router, so disabling it shouldn’t cause
much impact to your daily operations of the device.This feature is disabled by default, but if
it’s active, you might want to disable it using the no ip http server command.
If this feature is something that you need in your environment, you should instead use
the secure HTTP server that was ﬁrst available in version 12.2(15)T of the Cisco IOS.This
will allow you to access the Web interface via an SSL encrypted connection. If security is
your number-one concern, you might still want to leave this feature disabled, if for no other
reason than to have as few processes running on the router as possible that could potentially
be exploited.
WARNING
Sometimes you will not know that the HTTP server is running because it does
not show up in the router conﬁguration. Always try to disable the HTTP server,
even if you do not see it in the conﬁguration. 
Enable Passwords
To keep an unauthorized user from making conﬁguration changes, you should conﬁgure an
enable password so that only authorized users can access the privileged mode.The enable
password is separate from line passwords that allow a user access to exec mode. In exec
mode, users can only show statistics and view interfaces, but once the user enters privileged
exec (enable) mode, he or she can make any sort of conﬁguration change.
There are two methods for applying an enable password.The ﬁrst is via the enable pass-
word command, which should not be used because it is possible to reverse its encryption
algorithm using several tools readily available on the Internet.The second method is via the
enable secret command (as shown in Figure 11.17), which is the preferred method because it
uses a nonreversible encryption method. Figure 11.17 shows the enable secret password being
set, and then the partial output of a show run command, to show that the password has been
encrypted in the conﬁguration ﬁle.
Figure 11.17 Conﬁguring Enable Password
DMZRouter(conﬁg)# enable secret H@rd2Cr@ck
DMZRouter(conﬁg)#^Z
DMZRouter#show run
www.syngress.com
528
Chapter 11 • DMZ Router and Switch Security

Building conﬁguration...
<lines removed>
!
hostname DMZRouter
!
logging queue-limit 100
enable secret 5 $1$FIyU$ibenevdkGwlNKnhtDhZIL/
!
<lines removed>
It is important to remember that even though the enable secret password uses a nonre-
versible algorithm, it can still be cracked with dictionary or brute-force attacks. For this
reason, you should make sure that you use a strong password and change the password on a
regular basis. If you do not use a strong password, the amount of time it could take for a
hacker to break your enable password could be very short, whereas if you use a strong pass-
word it should take long enough to crack the password that a hacker won’t be able to ﬁgure
it out before you’ve changed it due to the regularly scheduled password changes.
To help reduce the risk of your router being compromised because you forgot to con-
ﬁgure an enable password, all recent versions of the IOS code will not allow a user who is
connected via a Telnet session to enter privileged exec mode (enable mode) if an enable
password has not been conﬁgured. Figure 11.18 demonstrates how a router will respond
when someone attempts to enter enable mode on a router lacking a password from a Telnet
session.
Figure 11.18 Entering Enable Mode Via Telnet Without a Password
Trying 1.1.1.1 ... Open
User Access Veriﬁcation
Password:
DMZRouter>en
% No password set
DMZRouter>
The service password-encryption command encrypts all clear-text passwords saved in the
conﬁguration of the router, such as the console,Telnet (vty), and user passwords, so they
cannot be read directly out of the conﬁguration when it is viewed. By default, this feature is
disabled, but you should enable it on all routers.Although it is true that the algorithm used
to encrypt the passwords is reversible and can be decrypted in a matter of seconds with soft-
ware readily available on the Internet (if the hacker has access to the conﬁguration ﬁle con-
www.syngress.com
DMZ Router and Switch Security • Chapter 11
529

taining the encrypted passwords), it is still good practice to turn this feature on. If nothing
else, it prevents people from seeing your passwords if they happen to be watching over your
shoulder as you are working on a router.This command has no effect on the enable pass-
word that is set with the enable secret command, since that password is already encrypted with
a different encryption algorithm that is nonreversible.This command does not encrypt
SNMP community strings listed in the conﬁguration. Figure 11.19 shows how to enable the
password encryption service and then includes a partial output from a show run to show the
encryption of the passwords.
Figure 11.19 Conﬁguring Password Encryption Service
DMZRouter(conﬁg)#service password-encryption
DMZRouter(conﬁg)#^Z
DMZRouter#show run
Building conﬁguration...
<lines removed>
!
username dmzadmin password 7 020A014F0603062F
!
<lines removed>
line vty 0 4
access-class 10 in
exec-timeout 15 0
password 7 022E24490F542C336C4D02
login
transport input telnet
!
!
end
NOTE
If you take a closer look at the encrypted password and secret commands, you
will notice a number between the command and the encrypted password. This
number speciﬁes the level of encryption that is being used on the password.
The level 7 encryption is the reversible algorithm, which is best used to keep
wandering eyes from seeing your passwords. The 5 means that the password
was hashed with MD5 and is not reversible. 
www.syngress.com
530
Chapter 11 • DMZ Router and Switch Security

AAA
AAA stands for authentication, authorization, and accounting, which enable the router to verify,
control, and track users who access the router for administrative purposes.
■
Authentication The process of validating the claimed identity of an end user or
a device, such as a host, server, switch, router, or ﬁrewall.
■
Authorization Granting access rights to a user or groups of users.
■
Accounting The methods to establish who performed a certain action, such as
tracking user connections and logging system users.
The AAA feature can authenticate a user who logs into the router to an external
RADIUS or TACACS+ server. RADIUS or TACACS+ servers contain the IDs, passwords,
and privileges for each user deﬁned to their databases.They can also log such information as
the time a user logged to a system to the command a user entered. If the router receives a
“Success” response from the RADIUS or TACACS+ server, the user will be allowed to gain
access to the device. If a “Fail” message is received, the user will be denied access; it’s as
simple as that.
The AAA feature can also limit commands by authorizing each command an adminis-
trator enters.This feature is useful if you have many levels of administrator who have access
to your routers.You might want some administrators to have only the ability to troubleshoot
the router, which requires the use of show, clear, and debug commands, whereas you want to
provide other senior or advanced administrators the ability to make conﬁguration changes to
interfaces, access lists, routing protocols, and so on.The accounting feature tracks and logs all
the logins and changes an administrator makes.AAA is very useful for large organizations in
which many administrators have access to the company’s routers for management purposes
and the security policy calls for each admin to have a unique ID and password, so changes to
the router can be tracked and individual administrators can be held accountable.AAA can be
applied to administrators accessing the router via the following access methods: console,
Telnet, SSH, and HTTP.
AAA is a very useful feature that works very well for administrative access as well as for
authenticating and authorizing users attempting to gain remote access via a network access
server.A discussion of this topic is outside the scope of this book; if you need more in-depth
information about AAA, check out the following site: www.cisco.com/univercd/cc/td/
doc/product/software/ios122/122cgcr/fsecur_c/fsaaa/index.htm.
In Figure 11.20 you can see the commands necessary to enable AAA to authenticate
users accessing the router for administrative purposes, authorization of commands an admin-
istrator can enter, and logging of administrative logins to a TACACS+ server.This example
assumes that your TACACS server is already conﬁgured with usernames and authorization
settings for all administrator accounts, since we are showing only the commands required to
make the router communicate with the TACACS server.To enable AAA on a router, use the
aaa new-model command in global conﬁguration mode.To authenticate users who want to
www.syngress.com
DMZ Router and Switch Security • Chapter 11
531

access the router to the TACACS+ server, use the aaa authentication login command. In this
example, we use the keyword default to signify that it will be the default method for all ses-
sions, including the console,Telnet, SSH, and HTTP.
With this option set as the default, from now on when you console,Telnet, SSH, or
HTTP into the router, users will be prompted for a username and password instead of only a
password.This prompt will ask the user to supply a full set of credentials that will not only
be veriﬁed but logged as well. We also set a fallback option, should the router not be able to
reach the TACACS+ server, to the enable password. If the TACACS server is down or if the
router is off the network for any reason, you will still be able to log into the router using the
enable password.The two aaa authorization command statements authorize all commands,
whether in exec mode (level 0) or privileged mode (level 15), to the TACACS+ server,
which veriﬁes whether the administrator is authorized to execute a speciﬁc command. In
the example, should the TACACS+ server be unreachable, the router will authorize all com-
mands, since the backup method was set to no authorization (none).To log all the adminis-
trative sessions (logins and logouts) to the TACACS+ server, use the aaa accounting exec
command.To specify the IP address of the TACACS+ server(s), use the tacacs-server host com-
mand.To specify the encryption key, which encrypts communication between the
TACACS+ server and the router, use the tacacs-server key command. In the example, the
TACACS+ server is 192.168.1.50 and the key is MyTACACS-KEY.
We have only brushed on some of the capabilities of AAA; again, refer to the URL
mention earlier for more details on how to conﬁgure other aspects of the AAA feature.
Figure 11.20 Conﬁguring AAA
DMZRouter(conﬁg)# aaa new-model
DMZRouter(conﬁg)# aaa authentication login default group tacacs+ enable
DMZRouter(conﬁg)# aaa authorization commands 0 default group tacacs+ none
DMZRouter(conﬁg)# aaa authorization commands 15 default group tacacs+ none
DMZRouter(conﬁg)# aaa accounting exec default start-stop group tacacs+
DMZRouter(conﬁg)# tacacs-server host 192.169.1.50
DMZRouter(conﬁg)# tacacs-server key MyTACACS-KEY
SNMP
Simple Network Management Protocol (SNMP) allows network management systems to
monitor, collect statistics, and even make conﬁguration changes to the Cisco router. SNMP
version 1 is the most commonly used version of the protocol, but unfortunately it is the least
secure because it uses a community string, which is like a password, that is passed over the
network unencrypted, in clear text, just like Telnet. SNMP version 2 is considered more
secure because it uses message digest authentication (MD5), so if your management system
permits, use SNMP version 2 to manage your routers.
www.syngress.com
532
Chapter 11 • DMZ Router and Switch Security

Cisco routers support SNMP versions 1, 2, and 3. If your management system does not
yet support version 2 or greater, take a look at the example in Figure 11.21, which takes you
through the steps to increase security for SNMP version 1. Since we know that the SNMP
requests should come from only a management system, you should be able to create an
access list that permits only the speciﬁc management system(s) to send SNMP messages to
the router.
In the example, we created access list 10, which only permits the management system
with the IP address 192.168.1.50, denies all other source addresses, and logs the failed
attempts.The snmp-server community command is used to set the community string, deﬁne
the rights (RO for read only or RW for read/write) and to apply an access list all in one line.
In this case, we created two community strings—one for read-only access
(mySNMPReadKey) and one for read/write access (mySNMPWriteKey). Both community
strings have access list 10 applied to them, so only the speciﬁed management server can send
the router SNMP messages. It is important to not use the well-known community strings
public for read-only access or private for read/write access, because they are commonly used
and easily guessed. Not only that, but most vulnerability scanners have a preset to scan all
devices using common string names such as public and private.Try to use community strings
that are a little more challenging (even the strings in the example are too simple), and try
not to use the same community strings for all devices on the network. Furthermore, try to
avoid SNMP on devices accessible by the Internet, if possible, because of its inherent weak-
ness and vulnerabilities. If you need to run SNMP on devices accessible to the Internet, do
not conﬁgure community strings enabling read/write, because if they are hacked, the
intruder can possibly reconﬁgure the router, causing major problems.
WARNING
Using public and private (the default community string names) for any device
on your network is not only unadvisable—it’s a practice known to every hacker.
Never use these strings, no matter what. Always change them or disable SNMP
from the device. 
Figure 11.21 Conﬁguring SNMP
DMZRouter(conﬁg)# access-list 10 permit 192.168.1.50
DMZRouter(conﬁg)# access-list 10 deny any log
DMZRouter(conﬁg)# snmp-server community mySNMPReadKey RO 10
DMZRouter(conﬁg)# snmp-server community mySNMPWriteKey RW 10
www.syngress.com
DMZ Router and Switch Security • Chapter 11
533

Syslog
System logging (syslog) can record several events, from system status to security violations.
These events can be sent directly to a console or terminal session, buffered in RAM, and/or
sent to a syslog server.The information in the syslog can assist you in troubleshooting a
system or network problem and recording matches or violations in an access list.This infor-
mation can be time-stamped to determine the time and sequence of a problem or an attack.
Syslog messages are tagged with one of seven severity levels: emergencies, alerts, critical
errors, warnings, notiﬁcations, informational, and debugging. Each level has a numeric value,
which can be seen in the help information for the logging commands, as shown in Figure
11.22. It is recommended to log syslog messages to both the internal buffer, which is stored
in RAM, and a syslog server, because once the buffer in RAM is full, the oldest entry is
overwritten, and when the router is reloaded, the entries in RAM are lost.
Figure 11.22 Syslog Severity Levels
DMZRouter(conﬁg)#logging trap ?
<0-7>
Logging severity level
alerts
Immediate action needed
(severity=1)
critical
Critical conditions
(severity=2)
debugging
Debugging messages
(severity=7)
emergencies
System is unusable
(severity=0)
errors
Error conditions
(severity=3)
informational
Informational messages
(severity=6)
notiﬁcations
Normal but signiﬁcant conditions (severity=5)
warnings
Warning conditions
(severity=4)
<cr>
Figure 11.23 shows how to set up syslog to log events to the internal buffer and a syslog
server.The service timestamps log datetime msecs command time-stamps log entries with the
date and time (to the millisecond) for each recorded event.An alternate option is uptime,
which shows when the event occurred in relation to when the router was last booted.The
logging trap level command sets the severity level to be forwarded to the syslog server to infor-
mational, which means it will record all events from emergencies to informational events and
send them to the syslog server.The logging <syslog IP> command sets the IP address of the
syslog server to 192.168.1.50.The logging buffered level command sets the severity level for the
internal buffer to debugging, which enables the router to log messages to RAM for all
severity levels.
Figure 11.23 Conﬁguring Syslog
DMZRouter(conﬁg)# service timestamps log datetime msecs
DMZRouter(conﬁg)# logging trap informational
www.syngress.com
534
Chapter 11 • DMZ Router and Switch Security

DMZRouter(conﬁg)# logging 192.168.1.50
DMZRouter(conﬁg)# logging buffered debugging
All syslog messages that are generated by the router should contain the numeric severity
level within the message. For example, every time someone exits global conﬁguration mode,
a message is generated noting that the conﬁguration was possibly changed and the system
will display which user was in conﬁguration mode and the method of connectivity used.
This message will look something like:
*Jun 29 00:28:00.797: %SYS-5-CONFIG_I: Conﬁgured from console by console
The number 5 in the %SYS-5-CONFIG_I: portion of the output shows that this mes-
sage is severity level 5, or notiﬁcations, which is considered a “normal but signiﬁcant condi-
tion,” according to the output in Figure 11.22. In the case of this message, the conﬁguration
was done from the command line (“from console”), where no username was required, so the
message states that the conﬁguration was done “by console.” If we connected via a Telnet
session using a locally conﬁgured username, the output would look like:
*Jun 29 00:34:18.029: %SYS-5-CONFIG_I: Conﬁgured from console by dmzadmin on vty0
(1.1.1.1)
Notice that this message records the username, the vty the user connected on, and the
IP address that the user was connecting from.The following are some examples of other
messages that could be generated by your router and the severity levels of the message type:
*Jun 29 00:34:18.029: %HSRP-6-STATECHANGE: FastEthernet0/0 Grp 1 state Listen ->
Active
*Jun 29 00:40:31.473: %LINK-3-UPDOWN: Interface Serial1/0, changed state to down
The ﬁrst message is generated by Hot Standby Router Protocol (HSRP) and is giving
an informational message (severity 6) to record a state change in the protocol.The second
message shows that the serial interface has lost signal and has been marked “down” by the
router.This message is considered an error condition, which is severity level 3.
Conﬁguring & Implementing…
The Importance of Logging Events
Logging events can be very useful for troubleshooting your network device,
whether a router, switch, or server. However, log ﬁles are essential to determining
how an attack compromised your network and what parts of the network were
www.syngress.com
DMZ Router and Switch Security • Chapter 11
535
Continued

attacked. Furthermore, log ﬁles are important to help prove in a court of law that
an attack or an unauthorized event occurred. 
On routers, logs can be saved to the router’s memory buffer or sent to a
syslog server. Log events sent to a buffer ﬁle in the router’s memory are erased
once the router is rebooted. This means that if the router is rebooted, it will lose
all historical information, including very important data that could prove an
attacker is guilty of penetrating the network. If you are not logging to a syslog
server, an attacker can cover his trail by clearing syslog ﬁles of the devices he pen-
etrated or by forcing the router to reboot. It is a good practice to send log infor-
mation to a syslog ﬁle so that all log events are stored in a central place. Then if
an attack occurs, the ﬁles can be quickly assembled and sent or shown to the
proper authorities. It is also important for the logged events to have accurate
timestamps (down to the second or even millisecond, if possible). To guarantee
accurate timestamps, all devices on the network must have their clocks synchro-
nized, which will make it easier to determine the sequence of events in an attack.
You can synchronize the clocks on all devices on your network using Network
Time Protocol (NTP), discussed in the next section.
Network Time Protocol
NTP synchronizes a router’s clock with a time source, which helps keep time accurate on all
network devices. When an attack occurs, it might be necessary to keep the time consistent
on all network devices, to determine a sequence of events by checking the timestamps in the
logs. Without this service enabled, it can be extremely difﬁcult or even impossible to corre-
late events on different devices.
NTP time sources are ranked based on stratum, which is the number of “hops” a partic-
ular time source is away from an accurate time source, such as an atomic clock.The devices
that receive their time directly from the accurate time source would be a stratum-1 time
source.Time sources that synchronize from stratum-1 time sources would be considered
stratum-2 time sources, and so on.There are many stratum-1 time sources available to the
public on the Internet, hosted by universities and government agencies.A good place to start
for information about NTP and a list of public time sources is the NTP Public Services
Project, located at http://ntp.isc.org.
Many organizations will choose a group of devices to pull time from stratum-1 clocks so
that they can then be used as internal time servers for the entire enterprise.This enables
every device in your network to have synchronized time, allowing you to correlate logs
between devices when an incident occurs. Enabling NTP requires only the ntp server com-
mand to specify the IP address of the time source. Multiple time sources can be conﬁgured,
and a preferred time source can be selected.A router can also be conﬁgured as a time source
for other devices to poll using the ntp master command.The only option for this command is
the stratum level of the local clock, so if you are conﬁgured to pull time from stratum-1
time sources, you would conﬁgure your NTP master as a stratum-2 time source. Figure
www.syngress.com
536
Chapter 11 • DMZ Router and Switch Security

11.24 shows how to further protect the NTP service by also conﬁguring optional message
digest algorithm 5 (MD5) NTP authentication. In the example, the router will synchronize
its time with the NTP server (192.168.50.1) and authenticate using the key NTPkey.
Figure 11.24 Conﬁguring NTP
DMZRouter(conﬁg)# ntp authenticate
DMZRouter(conﬁg)# ntp authentication-key 1 md5 NTPkey
DMZRouter(conﬁg)# ntp trusted-key 1
DMZRouter(conﬁg)# ntp server 192.168.1.50 key 1 prefer
DMZRouter(conﬁg)# ntp server 192.168.1.51 key 1
DMZRouter(conﬁg)# ntp master 2
Disabling Unneeded IOS features
As with many operating systems, some functions and features may be turned on by default to
make conﬁguration and management easier. Unfortunately, these functions and features can
also give away vital information or expose the router to malicious attacks. In this section, we
discuss some of the functions and features that can safely be disabled to mitigate the risk of
an intruder obtaining network topology information or exploiting a weakness in the router’s
code. We strongly suggest that you read all this information very carefully because most
routers are exploited due to unneeded, or more likely unknown, services that are running.
This holds especially true for older routers with older versions of code. Newer routers come
with current IOS that will normally not make available some of these exploits (such as
directed broadcasts, for example, that could be used in a smurf attack). However, you can
never be too sure, especially with your Internet-facing routers or routers within your DMZ.
Remember, all it takes is a script kiddie with a tool like NMAP to check out what you have
and possibly exploit it.
Before we begin, make certain that anything you consider disabling is not being used in
your network, because by disabling services, you could break applications that might have
been dependent on those services. One example is Cisco Discovery Protocol (CDP), which
we discuss in the next section. Normally this service can be disabled without any ill effects,
but the On-Demand Routing (ODR) feature uses CDP to propagate a default route to
neighbors, and Cisco IP phones can use the protocol to negotiate power and QoS details
with the upstream switch.You must be aware of the services that are in use within your net-
works before you start disabling these features.
Cisco Discovery Protocol
Cisco Discovery Protocol (CDP) is a Cisco proprietary network management protocol that
operates on Layer 2. CDP allows a router to discover several characteristics of a directly con-
nected neighbor, including the type of Cisco device, model, IOS, and IP addresses of the
www.syngress.com
DMZ Router and Switch Security • Chapter 11
537

device.An attacker can use this feature to map out a network and determine other devices
on the network and thus formulate an attack plan.This feature can be very useful for trou-
bleshooting or managing a network, especially in very large environments, but it should
never be used on an unsecured network such as the external or DMZ LANs. Network secu-
rity is about managing risk, so you will have to weigh the trade-offs of using this feature on
your internal LAN.
By default, CDP is enabled on all interfaces.To disable CDP on the entire router, use
the no cdp run command in global conﬁguration mode; to disable CDP on speciﬁc inter-
faces, use the no cdp enable command in interface conﬁguration mode.
NOTE
As mentioned, make certain that none of your network management devices
rely on CDP before you attempt to disable it. A general rule of thumb is, never
use CDP on any device within the DMZ, because this protocol will be exploited
to help map out what is located within your DMZ. If you have four Cisco
devices using CDP in the DMZ, all it takes is one hacker to crack one of them to
learn about the others. 
Redirects
Cisco routers can tell a device whether there is a better router or other network device on
the same subnet that can direct the packet to its destination in a more direct fashion.This
prevents a packet from being received and sent out the same interface to another router on
the same subnet.To accomplish this task, when the router receives a packet and the next hop
is on the same subnet as the sending device, the router sends an ICMP redirect message to
the sending device so that it will forward all future packets directly to the better next-hop
router without involving the original router.This makes the path to the destination more
efﬁcient and direct; it also eliminates the unneeded processing of packets by other routers.
Unfortunately, hackers can use ICMP redirects to shape and point trafﬁc to other destina-
tions and disrupt trafﬁc ﬂow.To disable ICMP redirects on a router, use the no ip redirects
command in interface conﬁguration mode. Please note that this is an interface conﬁguration
item, so it will need to be conﬁgured on every interface where you would want to disable
redirects. ICMP redirects are enabled by default.
www.syngress.com
538
Chapter 11 • DMZ Router and Switch Security

NOTE
As you can see, ICMP can easily be used to wreak havoc on a network. ICMP
was meant to be used as an informational troubleshooting tool, but at times it
can be manipulated to cause more bad than good. If you disable ICMP alto-
gether, you will remove the option to use troubleshooting tools such as ping
and traceroute. Make sure you enable and disable ICMP wisely to disrupt
hackers looking to take advantage but so that you retain a way to troubleshoot
your network. A word of advice: If possible, remove the ability for ICMP to be
used for attacks (as you are learning about in this section) as well as to disable
the ability to ping your Internet-facing router from the Internet. 
Unreachables
When a router receives a packet and it has no route for the destination, it will reply with an
ICMP unreachable packet to the original packet’s sender.A hacker can use this information
to ﬁgure out the subnets used on the network, which could be useful information to a
hacker as he maps out the network and launches an attack.To stop a router from sending
ICMP unreachable messages, use the no ip unreachables command in interface conﬁguration
mode. ICMP unreachable messages are enabled by default.
Directed Broadcasts
When a directed broadcast packet traverses a network, it behaves like a Unicast packet and is
forwarded throughout the network as a Unicast packet would be.The difference is that
when it reaches the router that is directly connected the destination subnet, the router will
rewrite the directed broadcast packet as a link layer broadcast packet and ﬂood the subnet.
All replies are sent to the originator of the direct broadcast. Directed broadcasts are used in
smurf attacks, in which a device continuously sends ICMP echo messages with a faked source
address to a directed broadcast address so that all devices on the destination subnet will send
echo reply messages to the false source address.The source address is usually spoofed to that
of the target of the attack.The device with the real source address will be ﬂooded with echo
reply messages, which can severely degrade the device’s performance.To prevent this type of
DoS attack, use the no ip directed-broadcast command.This command stops the router from
converting a direct broadcast packet to a link layer broadcast packet, thus saving lots of band-
width on your Internet links if someone tries to use your site to launch one of these attacks.
In most cases, directed broadcasts are enabled by default.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
539

NOTE
Newer versions of IOS have this command already conﬁgured on the interface,
but you should check anyway, just in case. 
Proxy ARP
Proxy ARP enables hosts on the LAN that have no default gateway conﬁgured to determine
how to get to other networks or subnets.A host sends an ARP request message to determine
where to send trafﬁc for a remote network or subnet to all devices on the subnet. If a router
on the same subnet as the host has a route to the network or subnet in question, it will send
a proxy ARP reply message to the host with its own MAC address, so the host can send to
the router all trafﬁc destined to the remote network or subnet.The router will then forward
the packet to the destination. Even though proxy ARP has many legitimate uses, it can also
be used by a hacker to determine which networks or subnets are connected to the network.
Proxy ARP is enabled by default, but it can be disabled using the no ip proxy-arp command
in interface conﬁguration mode. With the use of DHCP servers or statically conﬁgured
default gateways, it should not be necessary to enable the proxy ARP feature.
Small Servers
The term TCP and UDP “small servers” refers to a list of basic services that were designed as
troubleshooting tools.Today, these services are rarely used, but if left turned on, they can be
exploited to launch DoS attacks. Before we continue, let’s quickly explain what a service is, as
the term is used in this context. If you were to look at www.iana.org, you could easily ﬁnd
the port numbers for many known services such as Telnet (23), SMTP (25), and so on. Small
services are the same, but they use very low port numbers and perform very basic functions.
These services include echo, chargen, discard, and daytime. Each of these services is described
below:
■
Echo A TCP and UDP service designed to echo whatever is received back to 
the sender.
■
Chargen Stands for character generator and is a TCP and UDP service that will
generate a stream of ASCII characters. For UDP, a packet containing a string of
characters will be sent in response to every UDP datagram received. For TCP,
chargen will generate a constant stream of characters until the connection is
closed.
■
Discard A TCP and UDP service that will discard whatever is received.
■
Daytime is a TCP service that will return the date and time conﬁgured on the
router.
www.syngress.com
540
Chapter 11 • DMZ Router and Switch Security

These services have legitimate functions, but they also leave the router vulnerable to certain
types of attack. For example, character generation (chargen) can generate a string of ASCII
data to a user who Telnets to TCP port 19 on the router, with the command shown here:
telnet 10.0.0.1 19
Although this is simple, an attacker can use the chargen service to tie up the CPU, which
can severely degrade router performance.You can see the attack using the show processes cpu
command while you have an open connection to the chargen service.You will see a rise in
CPU usage, possibly up to 100 percent, depending on the CPU power of the router running
chargen. If you capture the data stream with a sniffer you will see that this can generate
thousands of packets in a matter of seconds.That’s pretty bad for a service you will never use
legitimately. One DoS attack involves the attacker causing the UDP chargen service on one
device to send packets to the UDP echo service on another device.This will trigger a ﬂood
of trafﬁc that will continue forever without some sort of intervention from the adminis-
trator. Since these services are so rarely needed (can you see a need to have a chargen
enabled on your router?), it is recommended that you shut down these services by using
both the no service tcp-small-servers and no service udp-small-servers commands in global conﬁgu-
ration mode on all routers, including routers on the internal, external, and DMZ networks.
NOTE
Prior to IOS version 12.0, both TCP and UDP small services were enabled by
default, but IOS 12.0 and greater TCP and UDP small services are disabled by
default. Check the version of your routers and ensure that these two commands
are not enabled, since there really is no need for them, especially on your
Internet-facing routers. 
Finger
The ﬁnger service is a carryover command from the UNIX world; it allows you to learn
which users are logged into the router without you actually logging into it.This feature is
not needed. If you need to know who is logged into your routers, consider using a
TACACS+ or RADIUS server, which can produce reports on who is logged in. By default,
this service is enabled. Use the no ip ﬁnger command in global conﬁguration mode to disable
the ﬁnger service on all routers on your network.Although this service is rarely used, it is
recommended that you disable it, even if you don’t see it disabled in your conﬁguration.
Finger is very informative, and many hackers boast about how much they can learn from
devices that are running ﬁnger without administrators’ knowledge. Many hackers ﬁnd ﬁnger
because it often won’t show up as disabled in the conﬁguration. Run the no ip ﬁnger com-
mand on your devices, or run a vulnerability scanner on your router externally to see if
ﬁnger is in fact running.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
541

Password Recovery
If your router is in an area that doesn’t have adequate physical security, it is possible for
someone to gain access to it using the password recovery procedure.This procedure, which
requires a reboot, allows an attacker to access the router even though he does not know the
passwords that were conﬁgured on the device. Since this procedure requires access through
the console port of the router, it is generally safe to leave enabled, as long as you have good
access controls into the areas where these routers physically sit.The problem occurs when
someone who isn’t authorized to access the router can gain physical access to the device.
If you are concerned about physical access to your device, you can disable the password
recovery procedure with the no service password-recovery command.This command prevents
someone connected on the console port of the router from breaking into ROMMON
mode to bypass the password requirements. Since Cisco does not want to cause an adminis-
trator to never be able to access the device again if he or she forgets the password, the break
sequence can still be used.The difference, though, is when password recovery is disabled and
someone attempts to break into ROMMON; they are prompted to reset the router to fac-
tory defaults before they can gain access.This prevents someone with physical access to the
router from gaining access with a working conﬁguration on the device.To gain access to
your network, they would have to reconﬁgure the router from scratch.
IP Source Routing
The Cisco router can support IP source routing where the information in the IP packet
speciﬁes the path the packet will take to the destination, instead of following the normal
destination-based routing at each hop along the way.This capability can be dangerous
because the packet sender can control the packet’s path. If this feature is enabled, an intruder
can manipulate the packet’s path and possibly circumvent security points within the net-
work.This feature should never be enabled, since source routing is rarely used. IP source
routing is enabled by default and can be disabled with the no ip source-route command in
global conﬁguration mode.
NOTE
It should be noted here that packets could easily be created or forged. Most
people think that it takes a college degree in programming to create a packet,
but that only means that they haven’t scoured enough of the Internet to ﬁnd
the tools they need. You can create falsiﬁed data using most protocol analyzers.
When we talk about hackers causing most of these attacks against your routers
(or any other devices), be aware that they are in fact creating or replaying data
against you. 
www.syngress.com
542
Chapter 11 • DMZ Router and Switch Security

Bootp Server
If bootp services are not needed on the router to assign dynamic IP addressing to clients, it is
recommended that this service be disabled.To disable this feature, use the no ip bootp server
command in global conﬁguration mode.Although vulnerabilities are not common, they can
still be exploited by inundating the router with bootp requests, which can cause high CPU
utilization and possibly cause the router to crash.The Bootp protocol is used by workstations
and other devices to obtain IP addresses and other information about the network conﬁgu-
ration.There should be no need to offer the service outside your internal LAN, which is
usually provided by a separate server and not the router, and it could offer useful information
to intruders.
Other Security Features
The security tips, services, and features discussed in the previous sections referred to standard
features of the router IOS, which means that they are found in all IOS releases. However,
Cisco does offer more security functionality through the many different feature sets the
Cisco router offers, including an IOS ﬁrewall, IOS intrusion detection services (IDSs), and
Security Device Manager (SDM) as well as VPN capabilities. In addition, many newer Cisco
routers have a network module slot that can accept the IPS Network Module (IPS-NM).
This module essentially provides a full-featured IDS/IPS device that ﬁts into the network
module slot and ties into the backplane of the router.These features allow the router to per-
form stateful packet inspection and detect attacks via signatures, just as their dedicated ﬁre-
wall or IDS appliance counterparts would, in addition to normal router functionality.This
makes the router more than a device that directs trafﬁc throughout the network; it becomes
a legitimate security device.
Cisco has also started including its SDM product with many of the new routers and
code versions.This tool can help you speed up deployments of new devices by walking you
through conﬁguration wizards.This tool can also be used to perform security audits on
devices to help you gauge where the device may be vulnerable.Additional information
about this feature can be found at www.cisco.com/go/sdm.
Since the focus of this book is to secure the DMZ, we won’t cover every available secu-
rity feature you can enable with Cisco-based devices, but if you need extra functionality, you
can research it very easily on Cisco’s Web site or with assistance of the Technical Assistance
Center (TAC). It should be noted as well that this extra functionality does come at a cost,
because these services require more memory and CPU power. Unlike dedicated ﬁrewall or
IDS devices, where the hardware is optimized for these functions, the router relies on the
software to provide ﬁrewall and IDS functionality.This means that the router might be
bogged down performing all the extra services such as stateful packet inspection or intrusion
detection, so latency could increase as trafﬁc passes through it and routing updates are
missed, which can cause serious network stability problems.A common rule of thumb is
either scale up or scale out. In other words, don’t be cheap when ordering a device to do it
www.syngress.com
DMZ Router and Switch Security • Chapter 11
543

all, or simply use dedicated devices for dedicated services. In a large DMZ environment, use
a dedicated ﬁrewall or IDS unit instead of the router IOS versions for these features.
However, these features are useful for securing small to medium-sized locations requiring
Internet access or for securing connections to business partners or third parties, so analyze
your requirements and plan accordingly.
NOTE
In an enterprise DMZ environment, a router running the IOS ﬁrewall or IDS fea-
ture set should never replace a dedicated ﬁrewall device. Even though the
router can perform many of the functions a dedicated ﬁrewall such as the PIX
or an IDS unit, like the 4200 series sensor, can perform, it is not optimized for
this purpose and is not recommended.
Securing the Switch 
Switches have evolved over the last few years, from simple Layer 2 devices to very intelligent
network devices that are able to cover all seven layers of the OSI model. Examples are the
Cisco Content Services Switch (CSS) or the Content Switching Module (CSM) on the
Catalyst 6500, which can load-balance up to the application level.
These innovations enable the switch to become a powerful tool for implementing a net-
work infrastructure. Some of the functions and features added to the switch over its lifetime
include VLANs, trunking, and Etherchannel as well as features to help secure the network,
such as port security and private VLANs.The advances in switch hardware and software have
also made the switch more than just a Layer 2 device and have bridged the gap between the
switch and the router. Many of the new switches can now perform many of the upper-layer
functions performed by the router, such as routing and ACLs; some switches can even per-
form application layer load balancing.As you can see, the switch is in a state of ﬂux, with
new enhancements evident in each release of switch software.
This part of the chapter mainly deals with securing the switch itself and some Layer 2
security-related features.Although there are many switches on the market, we recommend
the Cisco Catalyst switch model line because these models are feature rich, highly secure,
and have a CLI similar to the Cisco router line, which makes administration easier.
Cisco Switches
Unlike the Cisco router line, which uses a common operating system across all models, the
Catalyst switch line uses two different operating systems.The ﬁrst Catalyst switches were
designed to run an operating system referred to as CatOS that ran on the supervisor cards
www.syngress.com
544
Chapter 11 • DMZ Router and Switch Security

that controlled the operation of these Layer 2 switches.As Layer 3 features were added to the
switches to improve performance and scalability, IOS software started making its way into the
Catalyst product line.This started with the Route Switch Modules (RSM) for the Catalyst
5000 series switches, which were routers built onto cards and installed into the Catalyst
chassis.These cards ran their own version of the IOS operating system and ran completely
separate from the CatOS software that controlled the Layer 2 features of the switch. For all
intents and purposes, you had a router and a switch that were connected by the internal back-
plane of the chassis instead of Ethernet cables, and they had to be conﬁgured as separate
devices.This design was also used on the ﬁrst versions of the Multilayer Switch Feature Cards
(MSFC) that were used in the Catalyst 6500 series switches. If you were running both oper-
ating systems within your Catalyst switch, you were running in “hybrid mode.”
This design led to some interesting issues when you started adding redundancy within a
chassis. Since these larger switches were designed as highly available data center class
switches, they allow for redundant supervisor cards.The MSFC in the switch is actually a
daughter card on the supervisor modules, so with two cards you can have redundant Layer 2
and Layer 3 features.The supervisors are designed to act in active/standby conﬁguration; any
sort of problem would trigger a failover, and the switch would operate from the second card.
Since the MSFCs were designed as separate routers that attached at the backplane, that
meant that the Layer 3 portion operated in an active/active conﬁguration, just as though you
had two routers attached to your switch.To make one MSFC take over for the other in the
case of a failure, we must use all the features that allowed redundancy between two separate
external routers, like HSRP, routing protocol metrics, and so on. In a redundant conﬁgura-
tion with dual Supervisors with MSFC cards, you were required to conﬁgure one Layer 2
switch (active/standby) and two Layer 3 routers (active/active). Features such as Single
Router Mode (SRM) were developed to reduce the Layer 3 conﬁguration and complexity
by making the MSFCs act in an active/standby conﬁguration, but better overall integration
of the devices in the switch was desired.
Cisco has been able to further integrate these components and started offering “native
mode” software, which was a version of IOS that could control both the Layer 2 and Layer 3
functions of the switch.This allows the supervisor cards to work completely in an
active/standby conﬁguration and uses a common interface to control all Layer 2 and Layer 3
features of the switch.The 6500 series of switch was the slowest to reach this point, but all
the other switches in the Catalyst product line have been migrated to running only IOS
from the 2960s up to the 4500 series chassis-based switches. In some cases you still have the
option to run in hybrid mode, but this will depend on which switch hardware you are using.
For this reason, the examples in this section pertain to only the IOS version of the
Catalyst operating system. However, if you are running a CatOS version of the switch’s
operating system, the concepts and commands can be ported over to the CatOS.To compli-
cate things further, the features of the Catalyst switch are not always consistent across the
model line.To help clarify some features supported by each switch, we list some of the
details of the most popular switches as they pertain to the DMZ.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
545

NOTE
For more information on how to secure Catalyst switches running the CatOS
version of the operating system, refer to www.cisco.com/warp/cus-
tomer/473/103.html. 
Catalyst Express 500
The Cisco Catalyst Express 500 is a line of low-cost switches that are intended for small
businesses with limited network deployments.These are ﬁxed-conﬁguration switches that
come with a limited feature set compared to the rest of the Catalyst line, so businesses do
not have to pay for a large number of features that they would never plan to deploy. Most of
the switches in this line have 24 nonblocking wire-speed Fast Ethernet Ports and two
Gigabit Ethernet ports.There is also a model that contains only Gigabit Ethernet but is lim-
ited to a total of 12 ports.The various conﬁgurations have a varying number of ports capable
of Power over Ethernet (PoE) for use with devices such as IP phones and wireless access
points that receive both data and power over the Ethernet cable.All ports are capable of
automatic medium dependent interface crossover (Auto-MDIX), which is a feature that
automatically detects when a cross-over cable is required and can perform the cross in hard-
ware so that the cable doesn’t need to be replaced.
These switches are designed for ease of deployment and can be conﬁgured only through a
Web-based interface that is accesses via HTTPS on a standard Web browser.The switch uses
the Cisco Smartports feature, which is designed to automatically detect other Cisco Small-to-
Medium Business (SMB) devices that are plugged into the switch and recommend QoS and
security settings for the speciﬁc port. Since this switch was designed for end users in small
environments and cannot be accessed via a command line, the security measures listed later in
this chapter will not apply directly to this switch, but the Catalyst Express 500 line is included
here so that you will have an understanding of the entire Catalyst product line.
To ﬁnd more detailed information on this line of switches, visit www.cisco.com/go/cat-
alystexpress500.
Catalyst 2960
The Cisco Catalyst 2960 series switch is designed to be an access layer switch that provides
end stations access for small to midsized ofﬁces.The Catalyst 2960 has a ﬁxed-chassis conﬁg-
uration that offers different combinations of 24 or 48 Fast Ethernet ports with 2 or 4
Gigabit Ethernet ports.The model numbers that contain a TT have either two or four ﬁxed
RJ-45 Gigabit Ethernet ports for use with copper cabling; the TC models use the dual-pur-
pose Gigabit Ethernet ports.The dual-purpose ports have an RJ-45 port as well as a Small
Form Pluggable (SFP) slot that are both considered the same interface in the software.You
www.syngress.com
546
Chapter 11 • DMZ Router and Switch Security

have the option of using either the RJ-45 port for a copper connection or inserting an SFP
module for ﬁber optic connectivity.The switch’s backplane performance is either 16 or 32
Gbps, depending on the model.This switch has the option of redundant power through the
Cisco RPS 675, which is an external power supply that can provide secondary power to up
to six switches.
The 2960 comes with a large number of Layer 2 features to give you all the ﬂexibility
you might need with this line of switch.They contain many security features, such as port
security, DHCP snooping, IEEE 802.1x, and ACLs. In addition, this switch also contains all
the latest QoS features to guarantee network bandwidth and delay for sensitive applications
such as voice and video.
To see more detailed information about this line of switches, go to www.cisco.com/go/
catalyst2960.
Catalyst 3560
The Cisco Catalyst 3560 series switch is designed as an enterprise-class access switch that
offers multilayer capabilities. Like the Catalyst 2960, the 3560 has a ﬁxed-chassis conﬁgura-
tion that offers Fast Ethernet and Gigabit Ethernet connectivity. Cisco offers several different
chassis options that can fulﬁll many of the Layer 2 needs of a medium-sized network as a
standalone switch.This switch can also have Layer 3 functionality, including full IP routing,
which allows it to be implemented in the core, distribution, or access layer, depending on the
size of the enterprise network.This switch also supports redundant power with the Cisco
RPS 675.
The 3560 has two available types of software image.The IP Base image (formerly
known as the Standard Multilayer Image, or SMI) contains all the latest Layer 2 features and
allows for some basic IP routing setups, although you are limited to RIP for routing updates.
The IP Services image (formerly known as the Enhanced Multilayer Image, or EMI) allows
you to use full Layer 3 capabilities for Unicast and multicast routing, including policy-based
routing.This switch has the performance and functionality to interconnect the servers and
ﬁrewalls in a small to medium-sized DMZ environment.
The 3560 is also the smallest product in the Catalyst line to support Cisco’s network
virtualization features. Network virtualization allows you to segment your network into mul-
tiple isolated areas while staying shared on the same physical equipment. In the same fashion
that VLANs allow you to segment a switch into multiple virtual switches that cannot com-
municate with each other without passing through an external router (MSFC cards being
considered “external”), Virtual Routing and Forwarding (VRF) allows you to create multiple
virtual routers (which we will call VRFs) that are entirely isolated from one another. VRF
was originally used to deploy MPLS VPNs in service provider networks, but this function-
ality can now be added as a feature to routers that do not support the MPLS protocol. On
these routers, this feature is referred to as VRF-lite.
At a minimum, it is a great cost-saving feature when you can take, for example, a 3560
switch with 48 Fast Ethernet ports and turn it into 12 separate virtual routers with four Fast
www.syngress.com
DMZ Router and Switch Security • Chapter 11
547

Ethernet ports per VRF instance. When fully deployed throughout an enterprise, virtualiza-
tion can enable you to quickly and easily add new isolated segments to your network
without needing to ask for additional hardware resources. Network virtualization is not
within the scope of this book, so we are offering only a brief overview of what virtualization
can do for you. Virtualization is one of the components of Cisco’s Service-Oriented
Network Architecture (SONA); you can ﬁnd more information about the SONA architec-
ture, including network virtualization, at www.cisco.com/go/sona.
Designing and Planning…
Network Virtualization
Network virtualization is a concept that has recently started to get much more
vendor support and customer attention. In the past, if you wanted to have com-
pletely isolated areas of the network, you were forced to purchase separate
devices to build these areas. This can become very expensive as you end up run-
ning multiple, separate networks. With virtualization, you can create these sepa-
rate devices, virtually, within the same physical device. This allows network
administrators to quickly deploy new isolated segments of the networks with
existing resources that might not be completely utilized. Although some vendors
have implemented some half-measures that are referred to as virtualization, the
VRF features available in some router and switch models allows for complete iso-
lation between virtual devices. This means that there are separate routing tables,
routing protocol instances, and interfaces for each VRF. When you start using
these features, you will have to remember that you must specify to which VRF a
command will apply. Even when you are just issuing a simple ping, you must
specify which VRF to ping from; otherwise it will use the default VRF, which might
not have any knowledge of the network you are trying to ping. 
You have many options for connecting VRF instances on various devices,
such as physical interfaces, logical interfaces, or tunnel interfaces. Physical inter-
faces are straightforward, since you will assign the physical interface to a VRF
instance and connect the cable to the other device. Another option, which pre-
vents you from quickly consuming all your physical ports, is to use logical inter-
faces such as dot1q. This lets you assign each dot1q VLAN to a different VRF so
that you can connect multiple VRFs on different devices over a single cable. The
third option is to use tunnel interfaces to connect devices that are multiple hops
away. The general idea is to create a base or foundation infrastructure that inter-
connects all devices in the default VRF of each device. You can then use General
Routing Encapsulation (GRE) tunnels or Multiprotocol Label Switching (MPLS)
Label Switching Paths to interconnect additional VRFs without allowing them to
access the default VRF. Even though the logical interface (such as the GRE tunnel
www.syngress.com
548
Chapter 11 • DMZ Router and Switch Security
Continued

interface) is assigned to a particular VRF, the tunnel endpoints can be interfaces
and addresses that belong to the default VRF. This allows a logical point-to-point
connection to be established between two VRFs on devices that are multiple hops
away from each other. An example of this kind of setup is shown in Figure 11.25.
Figure 11.25 Using VRF-lite and GRE to Virtualize the Network
In this example, we see two routers that are implementing VRF-lite: Router
A and Router D. Routers B and C are standard routers within the path between
Router A and Router D. Each of these VRF-lite enabled routers have three
Ethernet interfaces—F0/0, F0/1 and F0/2. In both routers we have moved the F0/2
interface into a VRF that is being used for the development department; the
remaining interfaces (F0/0 and F0/1) have been left in the default VRF. For now,
we want to forget about the Dev VRF and look at the base network infrastruc-
ture that has been created. We have a routed path between Routers A and D that
ﬂows through our standard routers B and C. This path allows the corporate user
attached to Router A to reach the corporate user attached on Router D or Router
C, but none of the corporate users will have access to reach the developers that
are attached to the Dev VRF, since the Dev VRF is isolated from the rest of the 
network.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
549
Interface Tunnel0
Source: Router A, F0/0
Dest: Router D, F0/0
Corporate 
User
F0/0
F0/1
F0/2
Router B
Router C
Default VRF
Default VRF
Dev VRF
Dev VRF
F0/0
F0/1
F0/2
Router A
Router D
Developer
Interface Tunnel0
Source: Router D, F0/0
Dest: Router A, F0/0
GRE 
Tunnel
Corporate 
User
Developer
Corporate 
User
Continued

Going back to the Dev VRF, if we look at the physical connectivity between
Routers A and D, we do not have a path to let the developers communicate with
each other, since the F0/0 interface of both routers is assigned to the default VRF
and cannot also be assigned to the Dev VRF. Fortunately, we can connect these
two Dev VRFs by using a GRE tunnel, because a GRE tunnel interface is allowed
to transit the default VRF. The routers view the GRE tunnel as a direct point-to-
point interface between the Dev VRF in Router A and the Dev VRF in Router D.
Now the developers can communicate with each other, because their trafﬁc will
be encapsulated in a GRE header and tunneled through the base network,
without giving the developers any kind of access to reach resources outside their
VRF, such as the corporate users.
This is just one small example of network virtualization deployed in a router.
Cisco is starting to add virtualization into some of its other product lines so that
you can have this same kind of functionality across all components in your
routing paths. Keep in mind that although this feature can allow for great ﬂexi-
bility in your network designs, you still do not want to use this feature to allow
a single device to house network segments from different security zones. You do
not want to allow for the possibility of a hacker accessing your internal network
by compromising a DMZ device that has been virtualized into different security
zones.
Catalyst 3750
The Catalyst 3750 is Cisco’s top-of-the-line series for ﬁxed-conﬁguration switches.The
3750 supports all the features of the Catalyst 3560 model that we just discussed but includes
Cisco’s StackWise technology for interconnecting multiple 3750 switches.These switches
offer either 24 or 48 ports of Fast Ethernet and four Gigabit Ethernet SFP slots, as well as
some models that also have PoE capabilities. If you need a larger number of Gigabit Ethernet
ports, some models have either 12 SFP ports or 16 copper Gigabit Ethernet ports with a 10-
Gig XENPAK uplink slot.The 10-Gigabit Ethernet is the newest standard of Ethernet to be
standardized by the IEEE.This switch also allows for redundant power in the same manner
as the 2960 and 3560, using the Cisco RPS 675.
The two main beneﬁts of using a stacking architecture versus using Ethernet uplinks is
that the stacking solution allows you to manage the entire stack as a single switch and you
do not have to rely on spanning tree to prevent packet loops internal to the stack.The stack
ring runs its own proprietary protocol that uses an internal header to direct packets passing
across the stack ring.This protocol uses a token system, where the port that currently pos-
sesses the token can put a packet on the ring.As the packet traverses the ring, any port that
needs to transmit the packet can make a copy for transmission before passing it to the next
node in the ring. Once the packet reaches the originating port, it will remove the packet
from the ring.
www.syngress.com
550
Chapter 11 • DMZ Router and Switch Security

Each switch will have an “in” and “out” port on the back of the chassis for the stacking
cables.The cables attach in a way that creates a ring topology that acts as the backplane
between the switches that are a part of a stack.This ring is capable of running at 32Gbps, full
duplex, and a break in the ring (meaning a switch or cable failure) can be corrected for in a
matter of milliseconds by looping the disconnected ports, since trafﬁc can ﬂow in both
directions on the ring.A single stack can support up to nine switches, and any model of
switch in the 3750 line can be added to the stack, giving you the ﬂexibility to add the ports
and features you require into the stack.This allows the 3750 line to rival the port density of
the 4500 and 6500 line of switches if the feature set in this line ﬁts your needs better than
the chassis-based switch solutions that will be discussed in the next sections.
The stack is designed to easily handle addition and deletion of switches from the stack.
When a new switch is added to the stack, the master switch will copy the current software
version and global conﬁguration parameters to the new switch before it is included in the
stack and allowed to pass trafﬁc.The stack is also able to survive the loss of the master
switch, because another switch will be selected as master, based on priority, in its place.To
prevent disruptions when a switch with a higher master priority is added to the stack, the
existing master will never relinquish its role unless it fails, thereby preventing unneeded
master elections. Since the entire stack is managed as a single switch, this means that a single
IP address is used to manage up to nine devices as though they were blades in a chassis-based
solution, and the stack shows up as a single device to neighbors who are running CDP.This
functionality allows for features to span across stack members, such as Etherchannel, which
allows you to aggregate multiple Ethernet links into one logical link. With the 3750s, if you
needed 3 Gigs of bandwidth for an uplink to your core, you could create an Etherchannel
bundle that contains three Gigabit Ethernet links from three different switches within the
stack. If you happened to lose one of the switches in your stack that was a part of that
Etherchannel bundle, the uplink would continue to function as a 2 Gbps link instead of a 3
Gbps link until the failed switch was replaced.
Additional information on the Catalyst 3750 series switches, including a full list of bene-
ﬁts from the StackWise technology, can be found on the datasheets for the product at
www.cisco.com/go/catalyst3750.
Catalyst 4500
The Cisco Catalyst 4500 series switch is Cisco’s high-density, chassis-based switch solution,
designed for edge deployments in medium-sized to large networks, and can support up to
10Gig Ethernet links.The brain of the Catalyst 4500 is the supervisor engine, which man-
ages the conﬁguration and controls all the other cards inserted into the chassis. Currently,
there are three ﬂavors of the 4500 supervisor engine: the Supervisor II-plus, the Supervisor
IV, and the Supervisor V.All these supervisors run the IOS operating system and have
varying levels of processing power and features.The Supervisor II-plus is mainly a Layer 2
card with some basic Layer 3 and 4 functionality.The Supervisor IV is a full multilayer
supervisor card with increased processor power.The Supervisor V is a more powerful version
www.syngress.com
DMZ Router and Switch Security • Chapter 11
551

of the Supervisor IV.The Supervisor V has increased performance from 64 to 96 Gbps and
can perform certain switching functions in hardware, which further increases performance
and reduces CPU load.
The 4500 offers four different chassis sizes, the 4503, 4506, 4507R and 4510R, which
are 3, 6, 7, and 10 slots, respectively.The chassis that contain an R in the model number are
capable of redundant supervisor modules; the other models are limited to a single supervisor.
The remaining card slots can be populated with a variety of Fast and Gigabit Ethernet cards,
depending on your organization’s needs.
NOTE
The 4507R and 4510R chassis reserve Slots 1 and 2 for supervisor modules only.
You cannot put standard line cards in either of these slots. For this reason, the
4507R does not offer any additional port density over the 4506. The beneﬁt of
the 4507R chassis is the ability to have the redundant supervisor module when
more redundancy is required.
Like the other models, the Catalyst 4500 Cisco IOS software can support both Layer 2
and full Layer 3 features, including all the features of IP routing, QoS, security, and multicast
routing.This switch can perform the Layer 2 switching functions within the wiring closet as
well as in the distribution or core layer in a medium-sized network.This switch has the per-
formance and functionality to perform well in a medium-sized DMZ environment.
Additional information about the Catalyst 4500 line can be found at
www.cisco.com/go/catalyst4500.
Catalyst 6500
The Cisco Catalyst 6500 series switch is a feature-rich, very ﬂexible, and versatile switch that
can provide high performance in all parts of the network, including your wiring closets, net-
work core, server farm, and the DMZ.The 6500 is also designed as the switch with the
highest levels of availability and performance throughout the entire Catalyst line.This level
of performance is achieved by building as many features as possible into the hardware ASICs
of the switch.That way, even in a feature-rich environment, very few packets will have to be
punted to the processor for switching decisions, which can slow the ﬂow of trafﬁc through
the switch.The Catalyst 6500 can operate between Layers 2 and 7, which allows it to pro-
vide simple Layer 2 connectivity to complex Layer 7 content load balancing.The Catalyst
6500 is a chassis-based switch with a variety of chassis types and line cards that can be
inserted to accommodate any possible service requirement, from Fast Ethernet to 10 Gigabit
Ethernet.The Catalyst 6500 can also accommodate WAN interfaces, ranging from T1 to
OC-48, as well as a variety of service modules, making it a very powerful, modular, and ver-
satile chassis.
www.syngress.com
552
Chapter 11 • DMZ Router and Switch Security

For high availability, the chassis is designed for redundant power supplies and supervisor
modules. Internal software features allow the standby supervisor modules to track the state of
the switch so that in the event of a supervisor failure, downtime is limited to only a few sec-
onds. Software upgrades between compatible versions can also happen with only a few sec-
onds of downtime per switch, assuming redundant supervisors are being used.The latest
versions of the Catalyst 6500 IOS software now support Cisco IOS Software Modularity,
which is the latest enhancement to the IOS software architecture. In older versions of IOS, if
a single process had a problem (for example, tried to write in the memory space of another
process), the entire OS would crash and the device would reboot. With software modularity,
these processes run independently of each other, and if a problem occurs, the problem pro-
cess can be restarted automatically, without affecting the ﬂow of trafﬁc through the device.
Since most of the switching is done in hardware, trafﬁc can continue to pass through the
switch while certain processes are restarting.This modularity also allows the administrator to
apply patches to individual processes so that critical issues can be addressed in a timely
manner and without disruption to the network. Previously, critical ﬁxes were applied by
upgrading to a newer version of IOS, which was difﬁcult because you had to plan for sched-
uled downtime to apply the ﬁx.
As with the Catalyst 4500, the brain of the Catalyst 6500 is located on the supervisor card,
which provides multilayer switching capabilities.Two different types of supervisor engine are
available, depending on how you plan to use your 6500 switch.The two models are:
■
Supervisor 720 (Sup720
■
Supervisor 32 (Sup32)
The Sup720 is designed as a feature-rich Layer 3 card that contains many IP routing fea-
tures built into hardware for increased performance and scalability.The Sup720 comes with a
Multilayer Switch Feature Card, version 3 (MSFC3), which performs the Layer 3 functions
and Policy Feature Card, version 3 (PFC3), which contains the ASICs that are used for
implementing features such as routing, GRE, and QoS in hardware.The Sup720 also con-
tains Switch Fabric Module (SFM) that increases the backplane speed of the 6500 to 720
Gbps.The Sup720 is offered in three different ﬂavors: Sup720, Sup720-3B, and Sup720-
3BXL, depending on the amount of processing power and advanced features you require.
These different options describe the three versions of the PFC that can be installed onto the
supervisor.The PFC3A is the standard PFC mentioned earlier; the PFC3B and PFC3BXL
support some additional hardware features such as MPLS and an increasing number of VRF
instances per device.
The Catalyst 6500 also has the ability to provide enterprise LAN access or edge services,
such as WAN and Metro Ethernet, at a lower cost, for situations in which you do not
require the same levels of performance as offered in the Sup720.The Sup32 comes with a
PFC3B and supports a backplane capacity of 32 Gbps on a shared bus while supporting all
classic and CEF256 modules available for the Catalyst 6500 line.This supervisor module
enables the 6500 to complete with both the 4500 series and the 3750 series for edge con-
www.syngress.com
DMZ Router and Switch Security • Chapter 11
553

nectivity.The decision becomes much more about which features and functionality work
better for your environment and what sort of growth you expect in the future.
Other modules are also available to grow your investment in the 6500 to include the
following optional components:
■
Firewall Services Module (FWSM)
■
Content Services Module (CSM)
■
Intrusion Detection System Module (IDSM)
■
Wireless LAN Services Module (WLSM)
■
IPSec VPN Services Module (VPNSM)
■
Network Analysis Module (NAM)
All these cards can provide this switch with the greatest features and functionality of any
switch on the market. In other words, this switch can do it all and allows you to build the
chassis that best ﬁts your needs, from one with a very high Ethernet port density to one that
is fully populated with services modules for advanced security and Layer 7 functionality.This
switch can run on the Catalyst OS as well as the Cisco IOS, but new features and enhance-
ments lag a few months on the CatOS version, so it would be in your best interest to ensure
that you run IOS.The versatility, functionality, reliability, and performance this switch brings
make it a favorite among DMZ architects. If you have a large DMZ infrastructure, consider
using this switch; you will not be disappointed.
Securely Managing Switches
As with Cisco routers, Cisco switches offer many of the same management interface options
to conﬁgure and support the switch, including the console,Telnet, SSH, and HTTP. In this
section, we concentrate on the management interfaces of the Cisco Catalyst 2960, 3560,
3750, 4500, and 6500 series switches. Because they have similar CLIs, the same commands
can be applied to all switches in these lines. Since all these switches have the ability to run
Cisco IOS, we focus on the differences among the interface types as well as differences in
conﬁguration, in an effort to avoid duplicating the conﬁguration described earlier, in the
router section of this chapter.
One major difference you might notice is that switches do not have an auxiliary port
the way the router does, so this topic is, of course, not covered here. We do cover how to
conﬁgure the switch so that management interfaces and services (such as SSH,Telnet, con-
sole, and HTTP) are protected and locked down. We secure all the entries into the CLI to
prevent hackers from making changes to the switch’s conﬁguration, gathering important net-
work information, or using the compromised switch as a launching point for other attacks.
You will learn how to use TACACS+ or RADIUS servers to authenticate, authorize, and log
access to the switch. We also review using and securing managements services such as
SNMP, NTP, and syslog.
www.syngress.com
554
Chapter 11 • DMZ Router and Switch Security

NOTE
Technically, you would apply many of the same lockdown procedures you
learned while reading about routers in the beginning of this chapter. It is impor-
tant, however, that you read through this section to learn all the differences,
especially with VLANs, as well as how to apply port-based security where
needed. It’s a sure thing that you will have a switch in your DMZ, so read on
and learn where your network might be vulnerable and what to do about it. 
Before we continue, we need to cover one very important point. Do not use a hub in
your DMZ. For one thing, with today’s technical advancements, using hub-based technology
is simply ridiculous. If you invest the money in your infrastructure to build a DMZ in the
ﬁrst place, make certain that you at least “switch” this segment.As a result, you’ll get more
functionality out of the code running on the switch, as you will see in the following sec-
tions.You can also build virtual LANs, which are a very important security advancement, as
you will learn shortly. Lastly, using a hub is dangerous if it is compromised.A compromised
host could easily be made into a sniffer, and then the attacker will be able to eavesdrop
promiscuously on every transmission that traverses that device.
Console
Out of the box, the switch acts like a dumb switch, with ports all set to auto-sense speed and
duplex as well as all ports placed in VLAN 1.To initially conﬁgure the switch’s features as
well as other management interface options, you need to access the switch’s console port,
which provides direct serial access into the switch CLI. By default, there is no security on
the console interfaces; therefore, it is very important to secure this entry point into the
switch’s CLI. If it is left unconﬁgured, a hacker with physical access to the switch can simply
connect a laptop to the switch’s console port and access the network without any interfer-
ence. Access to the console port can be protected by a password or authenticated via a
TACACS or RADIUS server. This type of access can be used for general maintenance or
monitoring or when accessing the switch via other methods, such as Telnet or SSH, is ren-
dered useless due to conﬁguration error or malfunction. In this case, accessing the switch via
the console could be your last option to correct the problem before you have to call Cisco’s
TAC for assistance.
By default, no password is set on the console port. It is very important to apply a pass-
word to this interface via the password command, to protect and discourage unauthorized
personnel from attaching to the console port and obtaining unabated access to exec mode.
As always, the password should be a nondictionary word, difﬁcult to guess, and it should
contain a combination of letters, numerals, and special characters. Line passwords can contain
up to 25 characters, are case sensitive, and cannot begin with a number. When possible, use
TACACS or RADIUS to authenticate access to the console port. We discuss how to con-
www.syngress.com
DMZ Router and Switch Security • Chapter 11
555

ﬁgure TACACS or RADIUS support later in this section.Always apply an exec-timeout
timeout so that sessions will time out after an idle period. The example in Figure 11.26
illustrates how to use these commands to secure the console ports.
Figure 11.26 Conﬁguring a Console Password
DMZSwitch(conﬁg)# line con 0
DMZSwitch(conﬁg-line)# password H@rd2Cr@ck
DMZSwitch(conﬁg-line)# exec-timeout 15 0
Telnet
The Catalyst switch provides the ability to Telnet to the CLI.The switch allows up to 16
simultaneous Telnet sessions from hosts or networks you specify via an ACL.As was the case
with the console port,Telnet access can be protected by a password or authenticated via a
TACACS+ or RADIUS server. Remember that Telnet trafﬁc is sent in clear text, so if
someone is snifﬁng your network, they can easily capture the switch’s Telnet password or
enable password, or if you are using AAA, they will be able to obtain a user ID and password
and use them later for other malicious activity.
To conﬁgure Telnet, you ﬁrst need to conﬁgure the management VLAN, which is
VLAN 1 by default, with an IP address, and if the switch will be accessed outside the local
subnet, you need to conﬁgure a default gateway. Figure 11.27 shows how to conﬁgure the
16 Telnet sessions on the switch under the line vty 0 15 virtual terminal line conﬁguration
section.Apply the password via the password command. Follow the same rules of selecting
a password as in the console section. For further protection, apply an access list that
limits the host(s) that can Telnet to the switch. In this example, we used the access-class
command to apply access list 10, which allows only the host with IP address of
192.168.1.10 to Telnet to the switch.As with the console port, apply an exec-timeout timeout
so that a session will time out after an idle period. In this case, it is 15 minutes.
Figure 11.27 Telnet Conﬁguration Example
DMZSwitch(conﬁg)# interface Vlan10
DMZSwitch(conﬁg-vlan)# ip address 192.168.1.50 255.255.255.0
DMZSwitch(conﬁg-vlan)# no shutdown
DMZSwitch(conﬁg-vlan)# exit
DMZSwitch(conﬁg)# ip default-gateway 192.168.1.1
DMZSwitch(conﬁg)# access-list 10 permit host 192.168.1.10
DMZSwitch(conﬁg)# line vty 0 15
DMZSwitch(conﬁg-line)# password H@rd2Cr@ck
DMZSwitch(conﬁg-line)# access-class 10 in
DMZSwitch(conﬁg-line)# exec-timeout 15 0
www.syngress.com
556
Chapter 11 • DMZ Router and Switch Security

NOTE
You should never use VLAN 1 as anything other than your management VLAN.
As you might have noticed in the example in Figure 11.27, the management
VLAN is set to 10 because all unassigned and inactive ports belong to VLAN 1
by default. If the management VLAN was set to 1, someone connecting to an
unassigned port could attempt to access the management interface of this
device. In addition, if you explicitly use VLAN 1 for your entire network, one
compromised switch gives them all away—in other words, all management
information is compromised. If VLAN 1 is limited to only containing the unas-
signed ports and doesn’t have routed access to the rest of your network, you
have reduced the risk of unauthorized access if someone manages to plug into
an empty switch port. 
SSH
One of the major weaknesses inherent in a Telnet session is that all data is sent in clear text.
This can be a serious security risk if someone is able to sniff your Telnet session to the
switch. Most recent versions of the Catalyst switch IOS can now support SSH version 1.x,
which gives the administrator secure access to the switch’s CLI.All trafﬁc between the
administrator’s workstation and the switch is encrypted, making it difﬁcult for a hacker to
capture IDs and passwords. Unlike Telnet, which is available by default on almost every oper-
ating system, an SSH version 1.x client is required and usually needs to be installed on the
workstation or workstations that need to manage the switch via SSH.As with the other
access methods, the switch can be protected by a password or authenticated via a TACACS
or RADIUS server.To run SSH on a switch, you need to obtain a special crypto version of
the switch IOS software image, which enables you to switch to encrypt SSH sessions.To
conﬁgure SSH, refer to the router section of this chapter, since the implementation of SSH
on both the router and the switch are the same.
HTTP
Some newer versions of the Cisco IOS support Web-based management and conﬁguration
of switches using HTML through a Web browser. Unlike a router, some switches offer a
more advanced HTTP interface that allows administrators to conﬁgure, manage, and support
standalone switches as well as a cluster of switches. However, in a DMZ environment, it is
recommended that this feature be disabled for security reasons because the communication
between the switch and the Web browser is unencrypted.This feature is disabled by default,
but if it is active, you can disable it using the no ip http server command. For best security
results, do not activate this feature, especially in the DMZ.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
557

Enable Passwords
To protect an unauthorized user from making conﬁguration changes, you should conﬁgure
an enable password so that only authorized users can access privileged mode.The enable
password is separate from line passwords that allow a user access to exec mode, allowing a
user to show statistics and view interfaces but not make conﬁguration changes.As with the
router, there are two methods to apply an enable password on a switch.The ﬁrst is via the
enable password command, which should not be used because it is possible to reverse it using
several algorithms readily available on the Internet.The second method is the enable secret
command, which is the preferred method because it uses a nonreversible encryption
method.The service password-encryption command encrypts all passwords on the switch so that
they are not shown in clear text when the conﬁguration is displayed.As with the routers, the
IOS software will not allow users connected via a Telnet session to enter enable mode if a
password has not been set.
AAA
As with many features of the switch,AAA functionality and conﬁguration are the same as
the router’s implementation of AAA.This makes conﬁguring AAA consistent for all routers
and switches across the network, improving the security integrity of the devices that support
the network. With AAA you are able to validate the identity of an administrator, grant sepa-
rate access rights to users or groups, and log changes made to the switch so that administra-
tors are held accountable for their actions. Whenever possible, use AAA to secure the
switches on the network.
Since the conﬁguration of AAA is similar to the router’s implementation, we only show
you an example of how AAA is used to secure the DMZSwitch in Figure 11.28. In this
example, we used AAA to authenticate administrative sessions, authorize all commands exe-
cuted, and log all sessions on the switch to a TACACS+ server. Once AAA authentication is
enabled, by default AAA will be used to authenticate, authorize, and log on all management
interfaces, including the console,Telnet, and SSH.Therefore, all users accessing the switch
will need to have a username and password to enter the switch.
Figure 11.28 Conﬁguring AAA
DMZSwitch(conﬁg)# aaa new-model
DMZSwitch(conﬁg)# aaa authentication login default group tacacs+
local-case
DMZSwitch(conﬁg)# aaa authorization commands 0 default group tacacs+ none
DMZSwitch(conﬁg)# aaa authorization commands 15 default group tacacs+
none
DMZSwitch(conﬁg)# aaa accounting exec default start-stop group tacacs+
DMZSwitch(conﬁg)# tacacs-server host 192.168.1.50
DMZSwitch(conﬁg)# tacacs-server key MyTACACS-KEY
www.syngress.com
558
Chapter 11 • DMZ Router and Switch Security

Syslogs, SNMP, and NTP
As we have seen, the advantage of having similar CLIs for both the switch and the router is
that they share many of the same commands that make device conﬁguration and support
easier and consistent across devices.These similarities enable you to consistently conﬁgure
and secure services such as syslog, SNMP, and NTP on routers and switches across the net-
work. When you’re conﬁguring these services on the switch, be sure to follow all the same
security precautions presented in the router portion of this chapter. Figure 11.29 shows a
sample conﬁguration for these services.
Figure 11.29 Conﬁguring Syslog, SNMP, and NTP
DMZSwitch(conﬁg)# access-list 10 permit 192.168.1.50
DMZSwitch(conﬁg)# access-list 10 deny any log
DMZSwitch(conﬁg)# snmp-server community mySNMPReadKey RO 10
DMZSwitch(conﬁg)# snmp-server community mySNMPWriteKey RW 10
DMZSwitch(conﬁg)# service timestamps log datetime msecs
DMZSwitch(conﬁg)# logging trap informational
DMZSwitch(conﬁg)# logging 192.168.1.50
DMZSwitch(conﬁg)# logging buffered debugging
DMZSwitch(conﬁg)# ntp authenticate
DMZSwitch(conﬁg)# ntp authentication-key 1 md5 NTPkey
DMZSwitch(conﬁg)# ntp trusted-key 1
DMZSwitch(conﬁg)# ntp server 192.168.1.50 key 1
Security Banner
As we mentioned earlier in this chapter, security banners should be conﬁgured on all net-
work devices on the network, including the switch.This banner is a legal statement that any
unauthorized access to the device is prohibited; if it’s violated, it could lead to criminal or
civil prosecution. It is very important to conﬁgure this banner so that you’ll be able to
legally pursue a hacker who attempts and possibly succeeds at breaking into the network and
disrupting business.As with many of the switch commands, the conﬁguration of the login
banner is the same as on the router, using the banner login command.
Disabling Unneeded IOS Features
Like the router, the switch has services, functions, and features that can be turned on by
default on a switch’s IOS to make conﬁguration and management easier. Unfortunately, these
functions and features can also give away vital information or expose the switch to malicious
attacks.The switch might not have the extensive list of unneeded services that the router has,
but it does have some of the potentially hazardous services enabled by default.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
559

As with the router,TCP and UDP small servers and ﬁnger should always be disabled,
since they provide no useful function, especially in your DMZ. It is also recommended that
CDP be disabled to prevent hackers from obtaining important information about directly
connected devices on the DMZ or outside the ﬁrewall. However, on the internal LAN, it
might be necessary to run CDP because it is used for some plug-and-play functionality built
into the Cisco IP telephony (AVVID) solution.As we mentioned earlier in the chapter, dis-
abling unneeded services is a good idea; disabling needed services is not. Do an analysis of
your network for the applications used and on what they depend, remembering that turning
services off at times will paralyze an application you might depend on.The rule of thumb
for DMZ-based services is less is better. Do not run what you do not need, analyze what
you do need for vulnerabilities, and remove or replace as necessary.The conﬁguration in
Figure 11.30 shows how to disable some of the common unneeded services on the switch.
Figure 11.30 Disabling Unneeded Services 
DMZSwitch(conﬁg)# no service tcp-small-servers
DMZSwitch(conﬁg)# no service udp-small-servers
DMZSwitch(conﬁg)# no ip ﬁnger
DMZSwitch(conﬁg)# no cdp run
VLAN Trunking Protocol
VLAN Trunking Protocol (VTP) is an automated method of distributing VLAN conﬁguration
information throughout a management domain.This process eases the pain of having to con-
ﬁgure identical VLAN information on every single device you add to your network. VTP is a
Layer 2 protocol that maintains VLAN conﬁguration consistency by managing the addition,
deletion, and renaming of VLANs within a VTP domain.VTP minimizes misconﬁgurations
and conﬁguration inconsistencies that can result in a number of problems, such as duplicate
VLAN names and incorrect VLAN speciﬁcations.The switch has three VTP modes:
■
Server In server mode, an administrator can create, modify, and delete VLANs
and specify other conﬁguration parameters for the entire VTP domain. VTP
servers advertise their VLAN conﬁgurations to other network devices in the same
VTP domain and synchronize their VLAN conﬁgurations with other network
devices based on advertisements received over trunk links. VTP server is the
default mode.
■
Client In client mode, the switch will only receive VTP changes from servers.
Switches conﬁgured as clients are not allowed to create, change, or delete VLANs.
www.syngress.com
560
Chapter 11 • DMZ Router and Switch Security

■
Transparent In transparent mode, the switch will not participate in VTP, which
means it will not advertise its VLAN conﬁguration and does not synchronize its
VLAN conﬁguration based on received advertisements. However, transparent net-
work devices do forward VTP advertisements that they receive out their trunked
ports, allowing VTP to function through the transparent device.
VTP is a very useful tool, especially in large networks, but if not secured properly it could
be a point of vulnerability in your DMZ.As the network administrator, you will need to
weight the beneﬁts against the risks of having VTP in your DMZ infrastructure. If your envi-
ronment is small enough that VTP doesn’t offer much beneﬁt, it is recommended that you do
not use this feature, if only for the reason that you should keep the list of running services as
small as possible. If your network is not properly protected, a hacker can inject faulty VLAN
information, corrupting the VLAN databases on all switches in the VTP domain.
Since VTP cannot be disabled on a switch, you must set the device to transparent mode
if you do not want it learning VLAN information from other devices.To change the switch
from server mode, the default, to transparent mode, use the vtp mode transparent command in
global conﬁguration mode for all switches on the DMZ and outside the ﬁrewall. If VTP is
something that would be beneﬁcial to your DMZ environment, you should make sure you
implement the MD5 authentication feature built into VTP.To enable this feature, use the vtp
password command to specify the key that should be used for the MD5 hash.
VLANs
A VLAN is a feature that enables a switch or a group of switches to logically segment a net-
work so that the network architect can group hosts across the LAN by department, applica-
tion, or function instead of by the users’ physical location. Each VLAN creates a separate
broadcast domain, and broadcasts will not cross VLANs. VLANs operate in Layer 2, the data
link layer. For communication of devices between VLANs to occur, Layer 3, network layer,
routing needs to take place. Figure 11.31 illustrates a switch with three VLANs conﬁgured
showing three different broadcast domains. Basically, the diagram shows how a switch can be
conﬁgured to logically act like three different switches. VLANs are useful to cost-effectively
partition your network into logical parts.
In recent versions of IOS code for Cisco switches, there are two ways to conﬁgure
VLANs: VLAN database mode and conﬁg-vlan mode. In database mode, the switch allows
you to conﬁgure VLANs in the normal range, which includes 1 to 1005, and save them to
the VLAN database. In conﬁg-vlan mode, the switch allows you to conﬁgure in the normal
as well as the extended range, which includes 1006 to 4094. In conﬁg-vlan mode, VLANs in
the normal range are saved in the VLAN database, and VLANs in the extended range are
stored in the switch’s conﬁguration ﬁle.To conﬁgure extended VLANs, the switch needs to
be in transparent mode, since the extended range is not supported by VTP. Figure 11.32
shows how to set up a VLAN and select individual ports to the deﬁned VLAN using conﬁg-
vlan mode.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
561

VLAN membership can be statically deﬁned, as our example shows, or dynamically
deﬁned by a MAC address. In a DMZ environment, the ports used within the DMZ are
usually statically deﬁned to a speciﬁc VLAN.As shown in Figure 11.32, the conﬁguration of
VLAN 20 is started with the vlan command in global conﬁguration mode.This command
puts you in conﬁg-vlan mode, where the VLAN can be named and the maximum transmis-
sion unit (MTU) can be conﬁgured. In this example, VLAN 20 is given the name DMZ2,
and the MTU is set to the default value of 1500 bytes.To statically deﬁne an interface to
participate in VLAN 20, use the switchport mode access command to set the interface as a non-
trunking single VLAN port, and use the switchport access vlan command to associate the port
to a VLAN—VLAN 20, in this case.To show the status of the VLANs, use the show vlan
command.
NOTE
Avoid using VLAN 1, the default VLAN for all ports on the switch. If trunking is
necessary, use a dedicated VLAN other than VLAN 1, to avoid the possibility of
VLAN hopping and double-tagged 802.1q attacks. Avoiding the use of VLAN 1
altogether will keep it from being used in access mode on any nontrunked
ports. For additional security, you should disable any unassigned ports, but
some switch administrators place them in an unused VLAN, which, in essence,
has a similar effect.
Figure 11.31 A VLAN 
www.syngress.com
562
Chapter 11 • DMZ Router and Switch Security
VLAN 30
VLAN 20
VLAN 10
VLAN 10

Figure 11.32 Conﬁguring and Applying VLANs
DMZSwitch(conﬁg)# vlan 20
DMZSwitch(conﬁg-vlan)# name DMZ2
DMZSwitch(conﬁg-vlan)# mtu 1500
DMZSwitch(conﬁg)# interface fastethernet 0/1
DMZSwitch(conﬁg-if)# switchport mode access
DMZSwitch(conﬁg-if)# switchport access vlan 20
Designing & Planning…
Tips for Designing VLANs in a DMZ
VLANs are a cost-effective way to segment a network, because a single switch
can be used to support many segmented LANs. This can be very useful on the
internal network, where users are grouped by department, application, or 
function. 
In a DMZ environment, incorrect use of VLANs can cause a security ﬂaw or
weakness in your network’s defenses. Figure 11.33 shows incorrect use of VLANs.
The diagram shows a small branch ofﬁce or small enterprise ofﬁce with an
internal LAN, a DMZ, and connectivity to the Internet. A single switch is used to
support the entire infrastructure and has three VLANs conﬁgured—VLANs 10, 20,
and 30. VLAN 10 houses all the internal users, VLAN 20 supports the DMZ, and
VLAN 30 connects the ﬁrewall to the ISP’s Internet router at the site. 
The problem with this implementation of VLANs is that a single switch log-
ically partitions the various security zones on the network. The switch is not a
security device and should not be counted on to securely partition the network,
even with the use of VLANs. Each zone, the trusted internal LAN, the semitrusted
DMZ, and connectivity to the untrusted Internet should have its own set of
switches, and the switches should never have VLANs that cross zone boundaries.
In the scenario pictured in Figure 11.33, the entire network could be in jeopardy
should a hacker attack the switch, penetrate it, and exploit it. A simple conﬁgu-
ration error could make the hacker’s job that much easier to accomplish. Since
the switch has ports outside the ﬁrewall, this makes it easy to attack. Should the
switch be compromised, a hacker can bypass the ﬁrewall, because the switch has
a presence on all parts of the network—a hacker’s dream. At this point, the
hacker can shut down ports, reconﬁgure VLANs, and so on to cause a major dis-
ruption and create security issue on the network. Furthermore, with a presence
on the outside of the ﬁrewall, the switch is susceptible to DoS attacks and other
forms of attack that focus on other features, such as trunking. 
www.syngress.com
DMZ Router and Switch Security • Chapter 11
563
Continued

Figure 11.33 Improper VLAN Use
To mitigate these risks, use separate switches for each security zone. This
solution prevents an attack on a switch from disrupting the entire network and
compromising security. Figure 11.34 shows a proper VLAN implementation in
which separate switches are used for each security zone, all separated by the ﬁre-
wall. The diagram shows an internal Layer 3 switch conﬁgured with VLAN 10 as
the transit network between the internal switch and the ﬁrewall. VLAN 12 con-
nects all the internal users to the internal switch, and VLAN 11 connects all the
development users on their own subnet. Since the internal switch operates at
Layer 3, it also acts as a router and allows routed access between the three VLANs
conﬁgured on it. VLAN 30 only connects the outside or Internet-facing interface
of the ﬁrewall to the ISP Internet router located at the site. Notice that there are
two DMZ LANs supported by this ﬁrewall: one DMZ on VLAN 20 and the second
on VLAN 25. These VLANs are located on the same switch, known as the DMZ
switch. The connection between the DMZ switch and the ﬁrewall can either be
an ISL or Dot1q trunk, so both VLAN 20 and VLAN 25 can pass across that link.
The ﬁrewall will have two virtual interfaces that are assigned to the same phys-
ical interface: one for each VLAN. This allows the ﬁrewall to separate the two
DMZ VLANs from each other. The use of VLANs to separate DMZs is a common
and accepted practice in designing and building DMZs, because both DMZs
reside in the same security zone, the semitrusted DMZ zone. 
www.syngress.com
564
Chapter 11 • DMZ Router and Switch Security
Web 
Server
E-Mail 
Server
Internet 
Router
VLAN 20
VLAN 20
DMZ
Switch
VLAN 20
VLAN 20
User
VLAN 11
VLAN 11
 ISP 1
Internet
Firewall
VLAN 30
VLAN 20
VLAN 11
VLAN Descriptions:
VLAN 11 – Internal VLAN
VLAN 20 – DMZ VLAN
VLAN 30 – External VLAN
User
VLAN 30
FTP
Server
Continued

Figure 11.34 Proper VLAN Use
For further security, consider using a separate switch for VLAN 20 and VLAN
25. The use of multiple switches servicing each DMZ VLAN is usually complicated
by the cost of the switches, additional physical ﬁrewall interfaces, and the
common use of large, chassis-based switches that can accommodate a large
number of servers, so some DMZ architects take the security risk in return for per-
formance and manageability. In any event, an attack on a switch or switches on
the DMZ will affect only the DMZ; the rest of the network will operate normally.
This is because the switches in each zone are physically isolated, and connectivity
between the zones is protected by the ﬁrewall. Therefore, if one switch is com-
promised, the attacker will need to penetrate the ﬁrewall’s defenses before
moving to or attacking another zone.
Private VLANS
Hackers often look to exploit a server or other end station that has not been hardened or
patched to gain entrance to a network and launch further attacks from the compromised
device. (You learned how to harden hosts on the DMZ in earlier chapters.) From the com-
promised device, the hackers have free access to any device on the local LAN segment
because there are no ﬁrewalls or ACLs in the way to prevent them from attacking local
devices.To reduce the risk of attackers using a compromised box to attack other devices on
the same LAN segment, Cisco has introduced a feature called private VLANs (PVLANs).
www.syngress.com
DMZ Router and Switch Security • Chapter 11
565
Web 
Server
E-Mail 
Server
Internet 
Router
Firewall
VLAN 20
VLAN 20, 25
DMZ
Switch
VLAN 20
VLAN 25
User
VLAN 11
External
Switch
 ISP 1
Internet
VLAN 10
VLAN 12
VLAN 30
VLAN 30
Developer
Internal
Layer 3 
Switch
VLAN Descriptions:
VLAN 10 – Internal Transit Net
VLAN 11 – Development Users
VLAN 12 – Internal Users
VLAN 20 – DMZ VLAN
VLAN 25 – E-mail DMZ VLAN
VLAN 30 – External VLAN
FTP 
Server

DMZ segments are typically shared among many devices that have no interaction with
each other, but they are on the same LAN segment, so they are free to talk to each other.
For instance, a company’s e-mail relay server might not need to communicate with the com-
pany’s Web server, located on the same DMZ LAN, to operate normally.This can be a
problem if a hacker compromises one of the boxes. Let’s use the Web server as an example in
which a hacker can exploit the server, then use the Web server to launch DoS or other
attacks on the e-mail server or any other server on the DMZ.
To help solve this issue, Cisco has added the concept of a private VLAN to some lines of
switches.A PVLAN allows you some control over intra-VLAN communication because you
can isolate or group devices on a VLAN, keeping that group separate from the rest of the
VLAN. With PVLANs, a port on a switch can be conﬁgured as an isolated, community, or
promiscuous port.An isolated port on a switch can communicate only with the promiscuous
port.A community port allows communication between other devices within the same com-
munity and the promiscuous port.The promiscuous port can communicate with all devices
with the PVLAN, including the isolated and community ports.The promiscuous port desig-
nation is usually used for the default gateway device.
NOTE
Although you might think that this discussion is overkill on security for a DMZ,
you would be surprised at how many engineers wish they knew how to add
layers of security with PVLANs, as we are describing. If you need added security,
this is one way to go. In your organization, you should assess the amount of
security you need and apply it with tips and tricks such as the one described
here. 
Figure 11.35 shows how PVLANs are used to isolate and group servers so that devices
can communicate only with other devices on the same LAN that provide normal communi-
cation and functionality. In this example, we isolated the e-mail relay server and grouped the
Web and application servers.The switch’s connection to the ﬁrewall is in promiscuous mode
to allow communication to ﬂow in and out of the DMZ LAN.The switch will only allow
the e-mail server to communicate to the ﬁrewall to get to the internal LAN or the Internet.
The Web and application servers are grouped into a community, meaning that they can
communicate with any device within their community as well as the ﬁrewall so they can get
to the internal LAN or the Internet.Assign IP addressing and masking as you would nor-
mally, through DHCP of static addressing. If you are using static addressing, be vigilant as to
how you track your assignment, because when PVLANs are in use, it is possible for a ping to
fail but the address you are pinging to be in use.
www.syngress.com
566
Chapter 11 • DMZ Router and Switch Security

Figure 11.35 A Private VLAN 
NOTE
Not all Cisco Catalyst switches and Cisco IOS or Catalyst OS versions support
PVLANs. As for the switches that do support PVLANs, not all support the com-
munity port functionality. If you are interested in using this feature, be sure to
check the Catalyst switch documentation prior to implementation or purchase
of hardware, or visit the following URL: www.cisco.com/warp/cus-
tomer/473/63.html. This link requires a CCO login account for access.
To conﬁgure PVLANs, the switch must be set to transparent VTP mode. In this
example, we conﬁgure PVLANs as per the diagram in Figure 11.35. Let’s start with the con-
ﬁguration of primary and secondary PVLANs. PVLANs are conﬁgured similarly to a stan-
dard VLAN with the exception of establishing the role the PVLAN will play using the
private-vlan command in conﬁg-vlan mode.The options include primary, which signiﬁes the
primary VLAN; isolate, which signiﬁes that all devices on this PVLAN are set to isolated; and
community, which groups devices that can communicate between one another. In Figure
11.36, we conﬁgured three PVLANs: the primary PVLAN (VLAN 25), isolated PVLANs
(VLAN251), and a community PVLAN (VLAN 252). Once the roles of the PVLANs have
been established, we need to associate the secondary PVLANs to the primary using the pri-
vate-vlan association command in conﬁg-vlan mode of the primary PVLAN. In this case, we
are associating secondary PVLANs, VLANs 251 and 252, to primary VLAN 25.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
567
Web 
Server
Firewall
PVLAN 251
PVLAN 251
DMZ
Switch
App 
Server
PVLAN 252
Community  
Isolated
VLAN 25
FE 0/1
FE 0/2
FE 0/3
FE 0/4
Promiscuous
E-Mail 
Server
PVLAN 252
PVLAN 251
VLAN 25
To the Internet
LAN
To the Internet
Firewall

Figure 11.36 Conﬁguring Private VLANs
DMZSwitch(conﬁg)# vlan 25
DMZSwitch(conﬁg-vlan)# private-vlan primary
DMZSwitch(conﬁg)# vlan 251
DMZSwitch(conﬁg-vlan)# private-vlan isolate
DMZSwitch(conﬁg)# vlan 252
DMZSwitch(conﬁg-vlan)# private-vlan community
DMZSwitch(conﬁg)# vlan 25
DMZSwitch(conﬁg-vlan)# private-vlan association 251,252
The next step is to conﬁgure the switch’s interfaces (ports) and apply the PVLAN asso-
ciations. We start with the promiscuous connection that supports connectivity to the ﬁre-
wall on Fast Ethernet interface 0/1, as shown in Figure 11.37. We use the switchport mode
private-vlan promiscuous command to set the interface to promiscuous mode.Then we must
map the primary and secondary PVLANs to this promiscuous interface using the switchport
private-vlan mapping command. In this example, the port will be promiscuous for primary
VLAN 25 and secondary VLANs 251 and 252. Next, the e-mail server on the Fast
Ethernet interface 0/2 needs to be associated to the isolated PVLAN using the switchport
mode private-vlan host command, to set the port to host mode, and the switchport private-vlan
host-association command, to associate the port to isolated PVLAN 251.The same commands
are used to set the Web and application servers, on Fast Ethernet interfaces 0/3 and 0/4,
respectively, to community PVLAN 252.At this point the e-mail server will be able to
communicate only through the ﬁrewall, and the Web and application servers can communi-
cate between themselves and through to the ﬁrewall.To display PVLAN information, use
the show vlan private-vlan command.
Figure 11.37 Applying Private VLANs to Ports
DMZSwitch(conﬁg)# interface fastethernet 0/1
DMZSwitch(conﬁg-if)# description Connection to the Firewall
DMZSwitch(conﬁg-if)# switchport mode private-vlan promiscuous
DMZSwitch(conﬁg-if)# switchport private-vlan mapping 25 251,252
DMZSwitch(conﬁg)# interface fastethernet 0/2
DMZSwitch(conﬁg-if)# description Connection to the E-mail Server
DMZSwitch(conﬁg-if)# switchport mode private-vlan host
DMZSwitch(conﬁg-if)# switchport private-vlan host-association 25 251
DMZSwitch(conﬁg)# interface fastethernet 0/3
DMZSwitch(conﬁg-if)# description Connection to the Web Server
DMZSwitch(conﬁg-if)# switchport mode private-vlan host
DMZSwitch(conﬁg-if)# switchport private-vlan host-association 25 252
DMZSwitch(conﬁg)# interface fastethernet 0/4
DMZSwitch(conﬁg-if)# description Connection to the App Server
www.syngress.com
568
Chapter 11 • DMZ Router and Switch Security

DMZSwitch(conﬁg-if)# switchport mode private-vlan host
DMZSwitch(conﬁg-if)# switchport private-vlan host-association 25 252
Securing Switch Ports
The port security function is a Layer 2 security feature that allows the switch to block
packets that enter a port that does not match a dynamically or statically conﬁgured source
MAC address.This feature allows you to specify and limit the number of MAC addresses that
the switch will accept from a particular switch port.This feature can prevent users from
adding unauthorized devices to the network and discourage the unauthorized addition of
hubs or other switches to the network.Another use of this feature is to prevent CAM over-
ﬂow attacks, which attempt to force the switch to ﬂood all packets out all ports by ﬂooding
the switch with trafﬁc from random MAC addresses.This ﬂood of MAC addresses can ﬁll up
the CAM table, which tracks the switch ports a particular MAC address can be reached
through, with invalid entries. If the CAM table is full of invalid entries, it won’t have room
to track valid hosts, and trafﬁc to those valid hosts will be ﬂooded out all ports, allowing an
attacker to capture packets that wouldn’t normally be sent to him.
There are three ways to deﬁne secure MAC addresses on most switches: static, dynamic,
and sticky. Static-secure MAC addresses are manually conﬁgured on the switch port. Dynamic-
secure MAC addresses are learned dynamically by the switch but need to be relearned when
the switch is restarted. Sticky-secure MAC addresses can be dynamically learned or statically
conﬁgured. When they’re dynamically learned, the switch converts and enters them into the
switch’s conﬁguration. Because sticky-secure MAC addresses can be written and saved to the
switch’s conﬁguration ﬁle, there is no need to relearn any dynamic addresses after a reload.
The switch will detect a port security violation when a MAC address that is not statically or
dynamically deﬁned tries to access a switch port, a MAC address that is statically or dynami-
cally deﬁned to a switch port attempts to access another switch port on the same VLAN, or
the maximum number of allowed MAC addresses has been exceeded.The switch can be
conﬁgured to react in protect, restrict, or shutdown mode when a violation occurs. In pro-
tect mode, the switch drops unknown source MAC addresses but will not log the violation.
In restrict mode, the switch drops unknown source MAC addresses but records the violation.
Shutdown mode is the switch’s default setting; in this mode the switch will disable the port
and record the violation.
The switchport port-security command is used to enable port security on an interface.This
is the only mandatory command needed to conﬁgure port security.At this point, the switch
will allow only one dynamically deﬁned source MAC address to access the port, and if a vio-
lation occurs, the port will be disabled.At this point, you can add optional commands that
deﬁne a static or sticky MAC address entry, change the number of MAC addresses that have
access to the port, and change the switch’s reaction to a violation.To specify a static MAC
address, use the switchport port-security mac-address command.To specify multiple static entries,
this command can be entered up to 128 times per interface on most switches.The switchport
www.syngress.com
DMZ Router and Switch Security • Chapter 11
569

port-security mac-address command enables sticky MAC addresses.To specify the maximum
number of MAC addresses an interface can accept, use the switchport port-security maximum
command.The maximum will vary from switch to switch; the default is one. Use the switch-
port port-security violation command to change the method by which the switch handles a
violation.The valid values are protect, restrict, and shutdown, the default value. Use the show
port-security command to verify your port security conﬁguration.To clear dynamic or sticky
MAC addresses, use the clear port-security command.
The example in Figure 11.38 shows port security enabled on two interfaces on the
switch. On the ﬁrst interface, the statically deﬁned MAC address of 0001.0002.0003 will be
the only address allowed to access the port. If a violation occurs, the switch will disable the
port. On the second interface, the switch allows for 10 dynamically deﬁned MAC addresses
to access the port.The sticky command allows the switch to convert the dynamic MAC
address and copy it to the switch’s conﬁguration so that when the switch is restarted, the
MAC addresses will not have to be relearned. On this port, the switch drops packets from
invalid MAC addresses and records violations.
Figure 11.38 Conﬁguring Port Security
DMZSwitch(conﬁg)# interface fastethernet0/1
DMZSwitch(conﬁg-if)# switchport mode access vlan 20
DMZSwitch(conﬁg-if)# switchport port-security
DMZSwitch(conﬁg-if)# switchport port-security mac-address 0001.0002.0003
DMZSwitch(conﬁg-if)# switchport port-security maximum 1
DMZSwitch(conﬁg-if)# switchport port-security violation shutdown
DMZSwitch(conﬁg)# interface fastethernet0/2
DMZSwitch(conﬁg-if)# switchport mode access vlan 20
DMZSwitch(conﬁg-if)# switchport port-security
DMZSwitch(conﬁg-if)# switchport port-security maximum 10
DMZSwitch(conﬁg-if)# switchport port-security mac-address sticky
DMZSwitch(conﬁg-if)# switchport port-security violation restrict
IOS Bugs and Security Advisories
As you know, from time to time bugs or security vulnerabilities are found in software after it
is released to the public.The software loaded in Cisco routers and switches is no different.
Just as with Windows or UNIX operating system software, Cisco constantly releases new
versions that contain new or enhanced functionality but also releases ﬁxes for any bugs or
vulnerabilities discovered in previous releases. It is very important to keep up to date on any
potential security issues on your network, including making sure that the devices supporting
your network infrastructure do not have any weaknesses. Cisco has set up a page on its Web
site that announces security advisories and notices for its entire product line, including Cisco
www.syngress.com
570
Chapter 11 • DMZ Router and Switch Security

routers and switches.The page is constantly updated with new advisories and ﬁxes to known
problems related to Cisco hardware and software, as well as mitigation techniques for new
attacks, to prevent them from spreading.This page also contains links on how to report an
attack as well as how to report a vulnerability about one of its products to Cisco.You can
ﬁnd the Cisco Product Security Advisories and Notices page at the following URL using a
valid CCO login ID: www.cisco.com/en/US/products/products_security_
advisories_listing.html.
NOTE
Cisco also provides several white papers called SAFE Blueprints that break down
the parts of a network into separate modules and detail how to protect and
secure each module. Many of the tips and items listed in this chapter can be
found in these documents. Be sure to read these documents before designing
and conﬁguring your DMZ; they will provide you with sound network design
and security strategies. The SAFE documents can be found at the following URL:
www.cisco.com/go/safe. 
DMZ Router and Switch 
Security Best-Practice Checklists
When you’re designing and conﬁguring routers and switches on your DMZ, make sure that
you follow the checklists presented in this section to make sure that you have covered some
of the important tasks that can increase your network’s security and integrity. If you have
already set up your DMZ, go through the list to determine whether you can improve secu-
rity on the devices you already have in place.
Router Security Checklist
Here is a checklist to follow to ensure router security:
■
Authenticate routing updates on dynamic routing protocols.
■
Use ACLs to protect network resources and prevent address spooﬁng.
■
Secure the management interfaces:
1.
Secure all management interfaces, including the console, auxiliary, and virtual
terminal ports, using hard-to-guess passwords or a TACACS+ or RADIUS
server.
2.
Use SSH instead of Telnet.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
571

3.
If possible, use AAA to authenticate, authorize, and log administrative access to
the router using a TACACS+ or RADIUS server.
4.
Disable the HTTP server, which disables conﬁguration and management of
the router through the Web browser.
■
Lock down the router services:
1.
If possible, use SNMP version 2. Use ACLs to restrict access to SNMP.
2.
Disable CDP.
3.
Use authentication and ACLs to secure NTP.
■
Disable interface-related services:
1.
Disable redirects.
2.
Disable ICMP unreachables.
3.
Disable directed broadcast.
4.
Disable proxy ARP.
■
Disable unneeded services:
1.
Disable TCP and UDP small services.
2.
Disable CDP.
3.
Disable ﬁnger.
4.
Disable password security
5.
Disable IP source route.
6.
Disable the bootp server.
■
Keep up to date on IOS bug ﬁxes and vulnerabilities and upgrade (sometimes
downgrade) if necessary.
Switch Security Checklist
Here is a checklist to follow to ensure switch security:
■
Secure the management interfaces:
1.
Secure all management interfaces, including the console, and virtual terminal
ports, using hard-to-guess passwords or use a TACACS+ or RADIUS server.
2.
Use SSH instead of Telnet.
3.
If possible, use AAA to authenticate, authorize, and log administrative access to
the switch using a TACACS+ or RADIUS server.
www.syngress.com
572
Chapter 11 • DMZ Router and Switch Security

4.
Disable the HTTP server, which disables conﬁguration and management of
the switch through a Web browser.
■
Lock down the router services:
1.
If possible, use SNMP version 2. Use ACLs to restrict access to SNMP.
2.
Use authentication and ACLs to secure NTP.
■
Disable unneeded services:
1.
Disable TCP and UDP small services.
2.
Disable CDP.
3.
Disable ﬁnger.
■
Use VLANs to logically segment a switch.
■
Use PVLANs to isolate hosts on a VLAN.
■
Use port security to secure the input to an interface by limiting and identifying
MAC addresses of the hosts that are allowed to access the port.
■
Do not use VTP on the DMZ switches. Conﬁgure DMZ switches for transport
mode.
■
Keep up to date on IOS bug ﬁxes and vulnerabilities and upgrade (sometimes
downgrade) if necessary.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
573

Summary
As we have seen in this chapter, routers and switches do more than simply provide connec-
tivity between hosts on a network. If implemented and conﬁgured correctly, they can also
provide a higher level of security for the network. Routers direct trafﬁc in and out of the
enterprise network and are usually the ﬁrst line of defense when the network is connecting
to the Internet.Access control lists, or ACLs, on the ingress ports on the Internet-facing
routers can provide the ﬁrst point of defense on the network before trafﬁc is forwarded to
the ﬁrewall.Access lists can be used to prevent address spooﬁng, certain DoS attacks, and
other known attacks from affecting the network. Since routers are key parts of an intercon-
necting network, they are prime targets of hackers. Hackers will try to inﬁltrate routers to
glean information or use them as launching pads for further attacks.This is why it is impor-
tant to lock down routers’ management interfaces and services—to make them difﬁcult for
an intruder to hack.
As with routers, switches have an increasing role in network security.The switch pro-
vides many features, including port security. VLANs and PVLANs provide the tools to keep
the devices on the DMZ secure. It is also important to lock down the switch’s management
interfaces and services so that hackers cannot break into the switch to change VLAN conﬁg-
urations, change port settings, or use the switch to connect to other parts of the network.
New attacks and new vulnerabilities are uncovered every day. It is very important to
keep up to date on security notices and advisories posted on the various security Web sites
as well as Cisco’s site. When a ﬂaw in the hardware or software of your network devices is
exposed, it is very important to patch, upgrade, or ﬁnd a workaround to the issue at the ear-
liest possible time, to prevent an intruder from taking advantage of the vulnerability and
break into or disrupt the enterprise network.
Solutions Fast Track
Securing the Router
■
Router placement and routing in a DMZ environment are essential to connect the
enterprise location to the Internet. Proper routing, whether statically or
dynamically, is important to directing trafﬁc to the Internet so that internal users
are able to access the Internet and users on the Internet can access the DMZ.
■
Often the Internet-facing router is the ﬁrst line of defense in a DMZ
infrastructure. Placing ACLs on the Internet-facing router’s inbound interface can
help protect the network from several types of DoS attack.
www.syngress.com
574
Chapter 11 • DMZ Router and Switch Security

■
Securing router management interfaces and services is important to prevent
intruders from taking over the router and making conﬁguration changes or using
it as a launching pad for other attacks.
■
It is also important to disable any unneeded services on the router to prevent
security holes that could be exposed when these services are activated.
Securing the Switch
■
Proper use of VLANs is essential to protecting the integrity of the network. Use
physically separate switches and different VLANs in each security zone.
■
Take advantage of the switch’s security features, such as port security and private
VLANs, to enhance security on the DMZ.
■
Securing the switch’s management interfaces and services is important to prevent
intruders from taking over the switch and making conﬁguration changes or using
it as a launching pad for other attacks.
■
It is also important to disable any unneeded services on the switch to prevent
security holes that could be exposed when these services are activated.
IOS Bugs and Security Advisories
■
Make sure that the router and switch software is free of any relevant bugs and any
known vulnerabilities.
■
Check any security notices and advisories on a regular basis for the latest attacks
and mitigation techniques. Make changes or upgrades where appropriate.
■
Take advantage of security white papers to identify security “best practices” and
learn how to secure routers and switches on your network.
DMZ Router and Switch 
Security Best-Practice Checklists
■
Follow the Security Best-Practice Checklists and make sure you have covered all
the tasks that can help improve security for routers and switches on your DMZ.
www.syngress.com
DMZ Router and Switch Security • Chapter 11
575

Q: How much memory should my router have to receive the complete BGP routing table
from my ISP?
A: We recommend a minimum of 128MB of RAM in the router to store a complete
global BGP routing table from one BGP peer. If you store complete BGP routes from
multiple peers, you must add more memory.
Q: How can I reset a BGP session?
A: When changes are made in the conﬁguration of BGP, you usually have to reset the ses-
sion to the neighbors for the changes to take effect using the clear ip bgp command. If
you have enabled the “soft reconﬁguration” option, you can resync routing updates
without tearing down the TCP session.
Q: What is the difference between the ip default-gateway, ip default-network, and ip route
0.0.0.0/0 commands?
A: The ip default-network and ip route 0.0.0.0/0 commands are used to route any packets for
which the router does not have an exact route match in its routing table.The ip default-
gateway command is used only when IP routing is disabled on the router.
Q: Should I authenticate routing protocols? Which routing protocols support authentication?
A: Yes, you should always use authentication for routing updates so hackers can’t tamper
with routing tables. RIP v2, EIGRP, OSPF, and BGP all support authentication of
routing updates.
Q: How do you route trafﬁc between VLANs?
A: To route between VLANs, you need to have a switch with Layer 3 routing capabilities—
for example, the 3560, 3750, 4500, and 6500 with MSFC—or connect the individual
VLANs to a router.
Q: How many MAC addresses can you deﬁne using port security?
A: This number varies from switch to switch:
■
128 MAC addresses per interface on the Catalyst 2950/3550 series switches
■
1024 MAC addresses per interface on the Catalyst 4500/6500 series switches
www.syngress.com
576
Chapter 11 • DMZ Router and Switch Security
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

DMZ-Based 
VPN Services
Solutions in this chapter:
■
VPN Services in the DMZ
■
Designing an IPSec Solution
■
Connecting B2B Sites
Chapter 12
577
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
Virtual private networks (VPNs) are quickly supplanting leased lines as a cost-effective and
practical way of providing WAN communication between a central network and various
remote networks or extranet partner networks. However, implementing VPN services in the
DMZ has its share of difﬁculties. For one, you must determine the placement of the VPN
tunnel termination point.To identify the location for this device, you must conduct an eval-
uation as to the security of the device itself. Can it withstand an attack? Are there known
vulnerabilities in the software? 
Another factor that affects VPN device placement and VPN design is the function of
the VPN. More and more companies are turning from dialup services to VPNs for remote
access connectivity for telecommuters as well as mobile workers.The prime motivating
factor in this move appears to be an overall lower total cost of ownership (TCO) of VPNs
compared with dialup phone lines.
It is easy to get confused when we think about all the VPN technologies available, espe-
cially since many of them have different functions.To understand these technologies, it helps
to step back and look at the basic deﬁnition of a VPN, which is just isolated network con-
nectivity over a shared or public network.The word virtual refers to the fact that this con-
nection must pass over a larger shared network as the transport mechanism, whereas the
word private describes that this connection only offers connectivity between the endpoints,
not the intermediate systems, keeping it isolated from the rest of the shared network.The
term VPN is extremely generic and does not dictate a speciﬁc technology (such as IPSec or
GRE), topology (point-to-point, full-mesh, remote access), the number of sites that can par-
ticipate, or even what is being connected with this VPN (networks or single hosts). In most
cases, this public network is the Internet due to its widespread use, but these concepts can
just as easily apply to any kind of network that connects multiple separate entities.
As we just mentioned, when most people think of VPNs, they immediately picture an
encrypted point-to-point connection that travels over the Internet between two sites.
Although this might be the most common use of the term, there are other places where
VPNs are used to enable services, such as MPLS-based WAN services. In these kinds of con-
ﬁgurations, the service provider connects all users to the shared, high-bandwidth network
with leased lines and then creates isolated, private routed networks between sites of the same
company.This way, each customer has its own private WAN that offers direct site-to-site
connectivity, and the bandwidth is limited only by the size of the circuits installed in each
customer site.
Just like most people think of VPNs as traversing the Internet, they also mostly equate
VPNs with IPSec. Other technologies, such as Layer 2 Tunneling Protocol (L2TP), Point-to-
Point Tunneling Protocol (PPTP), Multi-Protocol Label Switching (MPLS), Generic
Routing Encapsulation (GRE), and Secure Sockets Layer (SSL), VPNs have their uses as well
as their drawbacks in constructing VPNs. Even so, certain VPN technologies are used in dif-
ferent ways. Still other proprietary solutions lie ahead, such as Cisco’s Dynamic Multipoint
www.syngress.com
578
Chapter 12 • DMZ-Based VPN Services

VPN (DMVPN) solution, which allows for the automatic creation of VPN tunnels between
sites that have no direct knowledge of each other.
The preceding discussion was written to help you understand the depth and breadth of
VPN services, but this chapter focuses speciﬁcally on the enterprise uses of VPN technology
in the DMZ and mostly on connectivity over the Internet, since you have created your
DMZ as a security measure to protect your systems from other users on this public network.
The most common services used in these kinds of environments are IPSec and SSL VPNs,
so most of our examples discuss these technologies.
VPN Services in the DMZ
VPN services in the DMZ are designed to provide connectivity to two primary groups of
users:
■
Business partners
■
Remote users
Remote users can be further subdivided into three general categories:
■
Branch ofﬁces
■
Telecommuters 
■
Mobile workers 
This section focuses on the various uses of VPN services as well as how these services
can be leveraged to reduce the total cost of WAN connectivity for an enterprise.
A traditional corporate WAN is shown in Figure 12.1. Branch ofﬁce networks are con-
nected through either a circuit-switched data path such as ISDN, providing a low-end, broad-
band connection, or through packet-switched technologies such as Frame Relay or leased
lines (T1, DS3, and so on).The cost of such a WAN topology increases signiﬁcantly as the
number of sites and the number of interconnections between the sites increase. For a fully
meshed topology with four endpoints, six Frame Relay or serial connections are required. In
general, a full meshed network with n nodes requires (n(n – 1)) / 2 links.This system quickly
becomes quite expensive as the number of nodes increases.VPNs provide dramatic ﬂexibility
in network design as well as a reduced total cost of ownership in the WAN.
There is a variety of ways to implement VPN services, including at the enterprise-edge
router, the ﬁrewall, or a dedicated VPN appliance.Another possibility is the virtual private
dialup network (VPDN). Primarily used for remote-access connection to an enterprise
campus network, this type of VPN combines the traditional dialup network through the
PSTN with either Layer 2 Forwarding (L2F) or L2TP.All these various technologies are
available in today’s marketplace, but the most popular VPN technology by far is the IPSec
VPN.This type of VPN is the focus of this chapter.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
579

Figure 12.1 Fully Meshed Enterprise WAN Connectivity
VPN Deployment Models
One of the ﬁrst decisions to make when deploying a VPN is choosing a device to serve as
the termination point for the VPN tunnel.This decision is primarily driven by the place-
ment of the VPN tunnel endpoint but also the capabilities of the device that will serve as
the tunnel endpoint. IPSec VPNs require devices capable of encrypting and decrypting all
the trafﬁc that traverses the VPN tunnel. Insufﬁcient processing power will result in slow
connection speeds over the VPN and poor performance overall. Many vendors address this
problem by offering VPN accelerator modules (VAMs), which are onboard processors
designed to ofﬂoad the encryption and decryption operations from the central CPU to
hardware designed speciﬁcally to handle these functions.
Deployment of VPNs in the enterprise DMZ is done primarily through the three
models listed here and shown in Figures 12.2–12.4:
■
VPN termination at the edge router
■
VPN termination at the corporate ﬁrewall
■
VPN termination at a dedicated appliance
Each of these deployment models presents its own difﬁculties that must be addressed in
order for the VPN topology to be successful. One concern that must be addressed is the use of
Network Address Translation (NAT). Due to its design, IPSec is not capable of traversing NAT
devices.The problem comes when the NAT device changes information in the IP header of
the IPSec packet.The changes will result in an incorrect IPSec checksum that is calculated over
www.syngress.com
580
Chapter 12 • DMZ-Based VPN Services
Corporate
Headquarters
Medium 
Branch
Office
Small Branch
Office
Small Branch
Office

parts of the IP header.There are vendor workarounds for this problem, where the IPSec packet
is encapsulated in a UDP or TCP packet and then transmitted to the other side.An IETF stan-
dard called NAT-Traversal, or NAT-T, has also been created to solve this issue and is deﬁned in
RFC 3947 and 3948. Having a detailed understanding of how your NAT mechanism works
could be important for establishing a working VPN tunnel, especially if there are ﬁrewalls
between the two VPN endpoints, so be sure to research the way your vendor is solving any
NAT issues before you attempt to implement one of these features.
VPN Termination at the Edge Router
Termination of the VPN at the edge router has the beneﬁt of ensuring that all VPN trafﬁc
must conform to external ﬁrewall policy, to reach the internal network.This topology
(shown Figure 12.2) is best deployed for extranet connections where the business partners
do not require access to the internal network but do require access to servers in the DMZ
itself that might not necessarily be exposed to normal Internet trafﬁc.Tunnel termination on
the router eliminates the need to conﬁgure IPSec through NAT.As the number of business
partners connecting through VPNs increases, the load on the routers due to the encryption
and decryption of packets also increases.This situation requires the use of VAMs to ofﬂoad
the encryption/decryption process from the router CPU.
Figure 12.2 VPN Termination at Edge Routers
www.syngress.com
DMZ-Based VPN Services • Chapter 12
581
 ISP 1
 ISP 2
 ISP 3
aBusiness
Partner
Corporate
Headquarters
Business
Partner
ISP
P 3
IS

Designing & Planning…
The VPN Dilemma
When you’re planning the type of network that you see in Figure 12.2, it is imper-
ative that you understand what the cloud represents in the middle of all the sites,
tunnels, and routers. This is the most confusing aspect of VPN design, and this
explanation should help you understand why this chapter is included in this book
and how it relates to a DMZ. 
First, WAN links such as Frame Relay were traditionally used to get corpo-
rate data from one place to another over telecommunication circuits. A tech-
nology like Frame Relay was utilized in many deployments around the globe.
Now, as more services are leaning toward IP (Layer 3 services such as voice and
video), a faster and more ﬂexible solution is needed. With the pervasiveness of
the Internet, you can pretty much get an Internet connection anywhere, but this
is not true with a technology like Frame Relay or ISDN. 
Basically, with VPN technology, the ability to encrypt data over “any” con-
nection has raised the bar. You can basically have a WAN connection with a user,
business partner, or another site using a simple Internet connection instead of
having to build a port and PVC, for example. The ﬂexibility is great, and more
important, the time to get a VPN up and running is much shorter, compared to
ordering and provisioning circuits. The dilemma with the cloud in the ﬁgure is
this: Basically, with VPNs, the cloud can be anything, but you will lean more
toward the public Internet (and that is how the picture is labeled) when using
VPNs because that’s where your encryption investment will pay off. You need the
encryption on the Internet. This is also why it is so important that you understand
DMZ technology; now your WAN links will go out your traditional Internet con-
nection, and most likely you will be hosting some form of services on the DMZ to
utilize that public Internet connection. 
As your network continues to grow, you could ﬁnd that this model no longer ﬁts your
needs. Since routers are not normally designed as large-scale VPN endpoints, they tend to
lack the features required to scale to a large number of tunnels or to perform VPN redun-
dancy. When you have redundant Internet-facing routers, you will have to decide which
router to use for VPN termination.This also means that if one of your Internet routers fails,
you will lose all VPN tunnels that terminate on that device, even though Internet connec-
tivity for the rest of the enterprise will continue working through the backup connection.
VPN redundancy is much easier to implement on a device that has a failover partner that
assumes all the same IP addresses as the master on failover.
www.syngress.com
582
Chapter 12 • DMZ-Based VPN Services

VPN Termination at the Corporate Firewall
Termination of the VPN at the corporate ﬁrewall allows for direct access from branch net-
works to the internal corporate core network as well as any DMZ services that need to be
accessible through that ﬁrewall. Remote users can then access all internal services without
having to authenticate a second time.This particular topology (shown in Figure 12.3) is best
reserved for LAN-to-LAN connections such as connecting a branch ofﬁce to the corporate
enterprise network or allowing access to and from a business partner’s LAN.This topology
also allows you to conﬁgure the tunnel and the access restrictions on the same device, which
could ease administration of your VPN infrastructure.
Figure 12.3 VPN Termination at the DMZ Firewall
The drawback to this topology is that as more branch ofﬁces are connected to the cor-
porate ofﬁce, the load on the ﬁrewall increases due to the increased amount of encryption
each VPN requires. When the load on the ﬁrewall reaches a point at which there is an
overall impact on network connectivity, it is best to either add a VAM to the ﬁrewall or
ofﬂoad the VPN services to a dedicated device, which can be a VPN appliance or a ﬁrewall
used for the sole purpose of terminating VPN connections.Your choice will depend on your
needs, the device feature sets, and any vendor relationships you currently have.
VPN Termination at a Dedicated VPN Appliance
Dedicated VPN appliances are designed to provide VPN tunnel services in both LAN-to-
LAN and remote access conﬁgurations. In larger deployments, you might want to have mul-
www.syngress.com
DMZ-Based VPN Services • Chapter 12
583
 ISP 1
 ISP 2
 ISP 3
aBusiness
Partner
Corporate
Headquarters
Business
Partner
IS

tiple VPN appliances to split up the load, if it is too much for a single device. If your com-
pany has thousands of users who will need remote connectivity to the ofﬁce, you will be
better served by a dedicated appliance (or a pair for redundancy) strictly for remote users
while using another appliance or your corporate ﬁrewall for LAN-to-LAN VPNs.
Figure 12.4 demonstrates LAN-to-LAN tunnels built with a dedicated VPN appliance.
In this particular topology, the VPN appliance is sitting parallel to the corporate ﬁrewall,
with its own connections to the unprotected network and the internal LAN. Unencrypted
trafﬁc coming from the Internet would route through the corporate ﬁrewall to reach the
internal network or DMZ network, just as in all the previous topologies.The VPN tunnels
will be the only trafﬁc that goes directly to the VPN appliance, and once it has been
decrypted it will be sent to the inside networks.The “inside” network could be either the
internal LAN or the DMZ segment, depending on where the “inside” interface of the appli-
ance is attached. In this topology, there is an underlying assumption that the VPN appliance
is secure and ﬂexible enough to be deployed in this fashion. In the case where the VPN
appliance doesn’t have granular enough access controls or you are not comfortable with the
level of security in the device, you might want to put a ﬁrewall or access list either inside or
outside the VPN appliance (or both).This will depend largely on the recommended deploy-
ment strategy for each vendor’s VPN device.You could also use another DMZ interface off
the corporate ﬁrewall, but you will need to be careful of routing issues that could cause the
reply trafﬁc to bypass the VPN appliance, because this will break communications with the
business partner.
Figure 12.4 VPN Termination at a Dedicated VPN Appliance
584
Chapter 12 • DMZ-Based VPN Services
 ISP 1
 ISP 2
 ISP 3
aBusiness
Partner
Corporate
Headquarters
Business
Partner
www.syngress.com

Although it’s not shown in Figure 12.4, you also have the option of using the VPN
appliance to offer LAN access to remote users who have Internet connectivity, but this will
depend on the number of users that you will be supporting. With a large deployment of
remote users, one option is to put another VPN appliance at the corporate ofﬁce that sits
parallel to the existing VPN appliance.
A further beneﬁt to this deployment model is the ability to utilize the VPN appliances
in conjunction with wireless networks.The original IEEE 802.11 wireless network speciﬁca-
tion had signiﬁcant weaknesses that left wireless network open to easy attack and subse-
quently left the internal LAN open to attack as well. Isolating wireless networks “outside”
the internal LAN in a DMZ and requiring users to utilize a VPN to access the corporate
network helps address some of the weaknesses in wireless LANs (WLANs).You can read
about WLAN VPN planning and deployment plans in Chapters 4 and 5.
Topology Models
The deployment models we’ve discussed represent how VPNs can be implemented to pro-
vide access to either the DMZ or the internal corporate network.This section focuses on
the various topologies in which these models can be deployed.There are four general
topologies to consider:
■
Meshed (both fully and partially meshed)
■
Star
■
Hub and spoke
■
Remote access
Each of these topologies is considered in greater detail in this section.
Meshed Topology
Like their traditional WAN counterparts, meshed VPN topologies can be implemented in a
fully or partially meshed conﬁguration. Fully meshed conﬁgurations have a large number of
alternate paths to any given destination. In addition, fully meshed conﬁgurations have excep-
tional redundancy because every VPN device provides connections to every other VPN
device.This topology was illustrated in Figure 12.1, although it was initially used to describe
fully meshed WAN topologies. Even with the replacement of traditional WAN services such
as Frame Relay or leased lines, fully meshed topologies can be expensive to implement due
to the requirement to purchase a VPN device for every link in the mesh.A simpler compro-
mise is the partial-mesh topology, in which all the links are connected to other links in a
more limited fashion.A partial-mesh topology is shown in Figure 12.5.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
585

Figure 12.5 Partial-Mesh VPN Topology
NOTE
Another issue you should be aware of with full versus partial-mesh topology is
the number of tunnels you need to conﬁgure and manage. If you have 100 sites
and add one router, think of all the connections you must make to rebuild a full
mesh! You would be required to reconﬁgure every device in the mesh. In
essence, the partial mesh is the way you want to go, but you might see an extra
hop in the path from place to place because you will no longer have a single
hop to any single destination. There is always give and take. Think about the
method that suits your design needs, and implement that method accordingly.
If a full mesh is required, this could be a great opportunity to look into Cisco’s
Dynamic Multipoint VPN (DMVPN) solution. This feature is brieﬂy discussed with
Cisco IOS VPNs in a later section.
Star Topology
In a star topology conﬁguration, the remote branches can communicate securely with the
corporate headquarters or central site. However, intercommunication between the branches
is not permitted. Such a conﬁguration could be deployed in a bank network so that compro-
mise of one branch will not immediately lead to the compromise of a second branch
without being detected.To gain access to a second branch, the attacker would have to ﬁrst
compromise the central network, which would hopefully be able to detect such an attack.A
star topology conﬁguration is shown in Figure 12.6.
www.syngress.com
586
Chapter 12 • DMZ-Based VPN Services
Corporate
Campus
Branch
Office
Corporate
Headquarters
Branch
Office
Branch
Office
Branch
Office

Figure 12.6 Star VPN Deployment Topology
Hub-and-Spoke Topology
A hub-and-spoke topology by design looks very similar to the star topology. However, there
is one signiﬁcant difference: Unlike the star topology, all branch or stub networks in a hub-
and-spoke topology are able to access other branch or stub networks.The central, corporate
network works as a simple transit point for all trafﬁc from one end of the network to
another.As trafﬁc transits through the central corporate network, the data is decrypted,
inspected, and re-encrypted for transmission to the ﬁnal destination.This topology has more
risk inherent in the design than the star topology because an attacker who is able to com-
promise one branch network might then be able to attack another branch network through
the VPN without being required to attack the central, corporate network.This topology is
shown in Figure 12.7.
Figure 12.7 Hub-and-Spoke VPN Topology
DMZ-Based VPN Services • Chapter 12
587
Corporate
Headquarters
Branch
Office
Branch
Office
Branch
Office
Branch
Office
Corporate
Headquarters
Branch
Office
Branch
Office
Branch
Office
Branch
Office
Branch-to-Branch communication 
that passes through the hub at the 
corporate office.
www.syngress.com

Remote Access Topology
A ﬁnal topology to consider is the remote access topology. Built on either the star or the
hub-and-spoke VPN topology (depending on the solution), this design focuses more on pro-
viding connectivity for remote users such as telecommuters, mobile workers, and other users
who need access to corporate resources while working from outside the ofﬁce. Most often
these users have either dialup or broadband Internet connections with dynamic IP address
assignment. Other users may travel the country, visiting potential customers and often need
access back to company resources from customer locations.These users typically can load a
remote access client onto laptop machines and create secure tunnels back to the corporate
LAN from just about anywhere on the public Internet. Since these users’ IP addresses are
constantly changing, these users will authenticate with username and password combinations,
although additional forms of authentication, such as digital certiﬁcates or tokens that gen-
erate single-use passwords for each VPN connection attempt are usually added.A remote
access VPN topology is shown in Figure 12.8.
Figure 12.8 Remote Access VPN Topology
Since IPSec connections can sometimes be difﬁcult to establish from remote networks
that have strict ﬁrewall policies, companies have been forced to ﬁnd solutions to make their
resources more accessible to their remote employees. Some vendors have built in methods of
tunneling the VPN trafﬁc over more accessible ports, which can be chosen by the VPN
administrator. Most people will try to use ports such as 80 or 443, since nearly everyone will
allow certain areas of their network have access to the Web. SSL VPNs are also another solu-
tion for this issue. SSL VPNs allow users to gain access to company resources without
loading any clients onto a machine.A user will only need to access a secure Web page with
www.syngress.com
588
Chapter 12 • DMZ-Based VPN Services
Corporate
Headquarters
PDA
Remote
User
Mobile
User
Telecommuter

her Web browser for login to then be able to access resources through a Web-based portal
page. Since not all applications can be supported through an SSL VPN portal page, some
vendors offer IPSec-like connections by allowing the remote users to download a small Web
applet to create a point-to-point tunnel over port 443 with the SSL VPN appliance.
The next topic we examine is deciding where to place the VPN endpoints within your
network.
Placement of Devices
Now that we have looked at some of the more common designs of the VPN, we need to
know where to place the VPN endpoint devices in our network. We’ll make many of these
decisions by reviewing areas of the networks that will need to be accessible through these
VPNs as well as the features that are available in the VPN endpoint itself.All VPN endpoint
devices need at least one interface with a public, unique IP address so that they will be
accessible from anywhere on the Internet.
With NAT Traversal (NAT-T), it is possible to use a private address with NAT to make
the device publicly accessible. Be aware that this approach may limit your functionality and
complicate your VPN setup. If the device is sufﬁciently hardened, it can sit directly on the
unprotected network, but if you are not comfortable with the device’s security, you might
want to put the external interface behind another DMZ interface of a ﬁrewall. If your VPN
endpoint’s external interface is behind a ﬁrewall, you will need to make sure you know all
the ports that need to be allowed through the ﬁrewall.
For a basic IPSec tunnel, you will need UDP port 500 for Internet Key Exchange (IKE)
and IP protocol 50 for ESP, which is the most common IPSec VPN method.You may also
need IP protocol 51 if you are using AH for your tunnels. ESP and AH are described in the
“Designing an IPSec Encryption Scheme” section later in this chapter. Other ports may be
required if you are using a NAT traversal technique and depending on which one you are
using. Some of these ports are deﬁned by the protocol standards; others can be user deﬁned,
depending on the vendor implementation.This means that you will need to know the fea-
tures you will use with your VPNs so that you can create a ﬁrewall policy accordingly.
Next, we will want to be very comfortable with how granular we can be with access
controls on the VPN endpoint device.This will help us decide where we should connect the
internal interface of the VPN endpoint device. If the device allows you to easily create poli-
cies for user groups, you might feel comfortable putting the inside interface of the VPN
device directly into the internal or DMZ network. If you are using your ﬁrewall as a VPN
endpoint, your device would already be conﬁgured in this fashion, and no additional links
will be required. Otherwise, you might be more secure by placing the inside interface of the
VPN endpoint in front of a ﬁrewall, which can restrict access. If the VPN endpoint’s inter-
face seems to be difﬁcult to manage for larger deployments with many access restrictions,
you might want to minimize the conﬁguration on the endpoint by assigning IP addresses to
users from address pools assigned per group.This way the ﬁrewall could be used to enforce
access policies on the different user groups. Since each group has a range of IP addresses
www.syngress.com
DMZ-Based VPN Services • Chapter 12
589

available for allocation, the ﬁrewall can still control policies for different user groups by refer-
encing the address range assigned to a particular group.
The basic concept is to keep in mind what you are trying to accomplish and ﬁgure out
how to best implement the solution in your particular environment. Most designs are gov-
erned by business needs, which could force your network to be conﬁgured in a way that is
less than ideal from a pure networking perspective.This makes it impossible to create a
cookie-cutter design for all VPN deployments.
Business Partner Connections 
In addition to branch ofﬁces and other remote connections such as data centers, many enter-
prises have business partners that require secure communications to servers (such as database
servers or servers running middleware applications) within the corporate DMZ.There are
several ways to ensure such communication, including WAN connectivity, LAN-to-LAN
VPNs, and remote access VPNs. WAN connectivity includes such technologies as MPLS,
Frame Relay, leased lines, and dialup connectivity.
Although these services can have signiﬁcant costs associated with them, they might be
the way to go for connections that can’t very well suffer downtime or performance issues.
Although VPN connectivity over the Internet can be much less expensive, it is also much
more difﬁcult to troubleshoot when issues arise. For example, if your VPN tunnel has to pass
though ﬁve different service providers and one of the providers in the middle starts having
performance issues, you might have a very difﬁcult time trying to contact someone to report
the issue. If you can manage to ﬁnd a contact number to call, it is still unlikely that anyone
will talk to you if you aren’t a direct customer of that service provider.This can lead to
extended periods of poor performance that cannot be easily corrected, since you cannot
control the full path trafﬁc will take through the public Internet. When you are dealing with
a single service provider for your WAN services, you will already have the contacts estab-
lished to quickly respond to performance and downtime issues.
In many situations, though, the cost of WAN connectivity cannot be justiﬁed, and per-
formance issues on the VPN tunnel are mostly an inconvenience, as opposed to a major
business risk. In these situations, you might want to use a LAN-to-LAN VPN. Such VPNs
have the beneﬁt of being able to take advantage of your redundant Internet connectivity as
well as being much less expensive than WAN connectivity, while offering the same sort of
access to business partners.The downside of using LAN-to-LAN tunnels lies in the difﬁculty
getting certain vendor solutions to interoperate. In recent years, many vendors have made
their solutions more ﬂexible, and most vendors can interoperate with each other, but in some
cases the VPN administrators from both sides might have to spend a signiﬁcant amount of
time troubleshooting their conﬁgurations.
A remote access VPN solution can also be a good ﬁt, depending on the nature of access
required between your company and the business partner. When a limited number of people
need access to your resources, it could be easiest to allow those users to connect through a
mechanism such as an IPSec VPN client or SSL VPN solution, if a VPN client cannot be
www.syngress.com
590
Chapter 12 • DMZ-Based VPN Services

installed on the remote machines.Assuming that you already have a client VPN solution in
place, it is a very simple process to add a few new users and create the appropriate access
restrictions.This usually takes much less time than setting up a LAN-to-LAN VPN, espe-
cially when the VPN administrators from both sides are trying to set up a multivendor
tunnel.
The downside of an IPSec client VPN lies with the support of the client software, such
as application conﬂicts or connection problems due to ﬁrewalls or NAT conﬁgurations at
the business partner’s site. If your remote access solution allows you to conﬁgure SSL VPNs,
you can bypass many of these client-related issues, since SSL VPNs are established through a
Web browser and nothing needs to be installed on the client machine.A SSL VPN could be
especially useful if the business partner needs access to only a small number of resources that
can be set up in a portal page. If more open access is needed, or if your applications aren’t
supported by the SSL VPN Web portal, most SSL VPN solutions do allow for full “tunnel-
like” access via a small client that is downloaded and executed through the browser if this
sort of access is needed and the business partner won’t allow you to install a software package
on their machines.Although this type of access via an SSL VPN solution could be useful in
certain situations, most SSL VPN vendors openly admit that, if possible, you are better off
using a full IPSec client for this type of access.
The next section covers remote access solutions in more detail. Because there are many
different solutions out there, we cannot cover all vendors that offer these types of solutions,
so we discuss only the more popular solutions available.
Remote Access Services
Remote access services can beneﬁt greatly from VPNs, and IPSec-based VPNs in particular.
Companies can move away from central dialup servers and 1-800 numbers and toward a
decentralized model. In this model, shown in Figure 12.9, companies contract with local ser-
vice providers for dialup service to the Internet for remote users.These services usually con-
sist of a small software package that presents the user with local dialup numbers for any city
to which the user might have traveled.The user can then connect to the Internet using one
of these local dialup lines, to avoid any long distance charges.To access the corporate net-
work, users must dial into the local service provider (Step 1) and authenticate to the service
provider’s access server. Once service provider access is granted, the user must use a VPN to
access the corporate network (Step 2).
To allow users to authenticate against corporate resources when they dial into the ser-
vice provider’s access server, a VPN can be used to connect the service provider’s access
server with an authentication server in the corporate DMZ.This enables the service provider
to authenticate users in accordance with the corporate security policy. In this model, the eas-
iest VPN technology to deploy is IPSec-based VPNs.The need to invest in access server
hardware is eliminated, along with the extra phone lines and their cost, and is replaced with
a new business expense: the cost of the dialup service from the provider.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
591

Figure 12.9 Decentralized Access Using VPN
In addition to decreasing costs for dialup services, this solution also allows remote users
to connect through the plethora of wireless and broadband Internet services that are scat-
tered across the country. Hotels and convention centers usually offer some form of wired
and wireless Internet access, Starbucks has teamed with T-Mobile to provide hotspots at
every Starbucks coffee shop, and T-Mobile and WayPort compete to provide Internet access
at many airports across the United States.Additionally, most home users subscribe to broad-
band services such as cable modem or DSL.These users would only need to start up their
VPN client to connect into the corporate network and access their network resources.
As mentioned in the previous section, an SSL VPN solution is also ideal for this type of
conﬁguration because you rule out some of the troubleshooting involved when users are
trying to gain remote access from behind a ﬁrewall and the required NAT traversal ports are
not opened.The SSL VPN solution also boasts the ability to eliminate troubleshooting the
VPN client itself, because the only software required is a Web browser with access to the
Internet.Again, although this solution may sound excellent because of the lower support and
troubleshooting overhead, you will need to evaluate the services your users require and
decide whether an SSL-based VPN solution will ﬁt your needs.
Nokia
Nokia VPN services are offered in a variety of platforms: dedicated VPN appliances and an
integrated ﬁrewall/VPN appliance.The Nokia appliances are diskless-based, purpose-built
www.syngress.com
592
Chapter 12 • DMZ-Based VPN Services
1
Dial-Up
Access
Server
VPN
Appliance
Firewall
Corporate
Edge
Router
a
 ISP 1
 ISP 2
 ISP 3
Internet
Remote
User
PSTN
Corporate 
Office
Authentication
Server
2
1

platforms running a Nokia proprietary operating system.These appliances range from the
small Nokia 5i VPN gateway for small ofﬁces to the 500i VPN gateway for corporate net-
works. In addition, Nokia produces larger gateways, the 50, 105, and 500 series appliances, in
an “s” version that provides SSL VPN capabilities instead of IPSec VPNs. Nokia’s
ﬁrewall/VPN appliance integrates Check Point’s VPN-1/FW-1 software on a hardened plat-
form running Nokia’s operating system IPSO. Nokia’s VPN offerings provide a variety of
features, some of which are listed here:
■
IP clustering Nokia VPN appliances can be grouped together into a “virtual” appli-
ance gateway.
■
Active session failover This feature enables the use of active session failover for
uninterrupted service. It allows the individual gateways to share security associations, to
provide a seamless transition from one gateway to another in the event of failure.
■
Centralized management As more VPN nodes are added to corporations that look
to VPNs as a low-cost alternative to traditional WANs, a simpliﬁed, centralized man-
agement structure is critical.
■
Firewall integration The ﬁrewall/VPN appliance provides for a tight coupling of a
secure proprietary networking OS integrated with third-party applications designed for
security solutions.
■
SSL VPNs Providing SSL VPN connectivity to users without the need of a client
software package provides access to corporate resources through the standard Web
browser.
For greater ease of management and quick conﬁguration of VPNs, the Check Point
software includes Simpliﬁed Mode VPN setup, which condenses the normal multistep VPN
setup and management processes into a more user-friendly process that allows the administrator
to deﬁne VPN communities.These communities are just a collection of settings to which the
administrator can add remote gateways objects.This way, all devices within a community receive
the same VPN settings without having to manually conﬁgure each tunnel.This makes it quick
and easy to deploy VPNs, whether they are remote access, intranet, or extranet VPNs.
It is important that you understand how to set up multiple VPN systems to see which
one is cost effective and a good ﬁt for your organization.You can learn more about Nokia’s
VPN and ﬁrewall solutions at www.nokiausa.com/business/security/.
Juniper NetScreen VPNs
NetScreen VPNs are integrated with the NetScreen ﬁrewall product.They allow for access
control as well as authentication and network segmentation. NetScreen ﬁrewalls utilize a
“security zone-based” model in which the network is separated into areas, or zones, that are
distinct and separate from one another.The zones can be one or more physical or logical
interfaces.This structure allows the device to cover VPN tunnel interfaces as well.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
593

Each zone is governed by its own security policy, and the NetScreen ﬁrewall applies the
policies between pairs of security zones, to control the type of trafﬁc allowed between the
zones. NetScreen products offer a variety of VPN features:
■
Redundancy  Although path redundancy at the physical layer is critical to
recover from a connection failure, redundancy at the logical VPN layer is also
important to minimize downtime. NetScreen VPNs support full redundancy in
their VPNs by utilizing “standby” tunnels that mirror the VPN’s security associa-
tions. In the event of failure in the live tunnel, the standby tunnel takes over in less
than 1 second.
■
Dynamic VPNs Dynamic VPNs help minimize the time required to manage
VPNs.This is achieved through the use of dynamic routing through the VPN tun-
nels, to communicate network topology as well as link state information.
■
Security zones As mentioned, security zones allow the network administrator to
divide the physical network into a series of virtual sections with various levels of
trust. Security zones can be implemented with their own individual security
polices.The policies can offer ﬁrewall, VPN, and DoS mitigation capabilities.This
structure provides several beneﬁts, including an increased interface density, contain-
ment of unauthorized users and attacks, simpliﬁed management, and lower policy
creation costs.
You can ﬁnd additional information about Juniper’s security products at www.juniper.net/
products/.
Cisco VPNs 
Cisco has integrated VPN technology into most of its networking products.These products
include routers, PIX and ASA ﬁrewalls, and the VPN 3000 series concentrator. Most, if not
all, of Cisco’s IOS versions for its routers have an optional feature set that includes VPN and
ﬁrewall service. Each of these devices provides approximately the same level of VPN services,
as described in the sections that follow.
Cisco IOS VPN
IOS VPN services allow the network administrator to terminate the VPN tunnels at an
external or internal interface of the router.This allows considerable ﬂexibility in the design of
the VPN. Some of the more important site-to-site VPN features available in Cisco IOS are:
■
Diverse networking environment support IPSec is a Unicast, IP-only pro-
tocol, but Cisco’s IOS VPN software features accommodate multicast and multi-
protocol trafﬁc. In addition, when combined with GRE, routing protocols are
supported across the VPN. Scaled mesh VPN topologies are supported through
Cisco’s Dynamic Multipoint VPN (DMVPN) feature, which allows network
www.syngress.com
594
Chapter 12 • DMZ-Based VPN Services

administrators to better scale large and small IPSec-based VPNs by combining
GRE tunnels, IPSec encryption, and Next-Hop Resolution Protocol (NHRP).
DMVPN requires manual conﬁguration of a hub-and-spoke VPN topology but
then allows the spoke sites to learn about each other via the hub site.The spoke
sites can then automatically create spoke-to-spoke VPN tunnels so that further
trafﬁc can bypass the hub site.This scheme allows for an easier deployment of
meshed VPN topologies by automating the provisioning of connections between
spoke sites as well as dynamically setting up connections based on network trafﬁc.
You can ﬁnd additional information about the DMVPN solution at
www.cisco.com/go/dmvpn.
■
Timely, reliable delivery of latency-sensitive trafﬁc Cisco’s IOS VPN fea-
ture set enables trafﬁc to be prioritized up to the application layer.This facilitates
differentiated QoS policies by application type rather than just TCP port number.
This system results in increased transmission reliability and better response time of
business-critical applications traversing the VPNs.
■
V3PN solution By combining advanced QoS, telephony, networking, and VPN
features with purpose-built hardware platforms, Cisco’s VPN offerings are able to
deliver a VPN infrastructure capable of transporting converged data, voice, and
video trafﬁc across a secure IPSec network.This is known as Voice- and Video-
Enabled VPN, or V3PN. More information about this solution is available at
www.cisco.com/go/v3pn.
■
VPN scalability and feature sets Cisco’s IOS VPN supports a wide variety of
features that are essential to VPNs.These features include data encryption, tun-
neling, broad certiﬁcate authority support for public key infrastructure (PKI),
stateful VPN failover, certiﬁcate auto-enrollment, stateful ﬁrewall, intrusion detec-
tion, and service-level validation.
■
VPN management framework  Managing multiple VPN devices over multiple
sites requires not only robust VPN conﬁguration management and monitoring
capabilities but also device inventory and software version management features.
Cisco’s CiscoWorks VPN/Security Management Solution (VMS) combines Web-
based tools for conﬁguring, monitoring, and troubleshooting enterprise VPNs as
well as other devices such as ﬁrewalls and network- and host-based IDS.
PIX and ASA Firewall VPN
The PIX and ASA ﬁrewall product lines also provide VPN capabilities.These capabilities are
designed to allow businesses to securely extend their networks across low-cost Internet con-
nections to mobile users, business partners, and remote ofﬁces.The PIX and ASA ﬁrewall’s
VPN provides several key features:
www.syngress.com
DMZ-Based VPN Services • Chapter 12
595

■
Standards-based IPSec VPN The Cisco solution provides for a standards-based,
site-to-site VPN utilizing the Internet Key Exchange (IKE) and IPSec protocols.
■
Multiplatform, multiclient support The Cisco PIX and ASA ﬁrewall’s VPN
supports a wide range of remote access VPN clients, including Cisco’s own soft-
ware VPN client on various platforms (Microsoft Windows, Linux, Solaris, and
Mac OS X) and Cisco hardware-based VPN clients (PIX 501, 506E, VPN 3002
client, and the Cisco 800 and 1700 series routers). In addition to supporting
IPSec-based VPNs, the PIX and ASA ﬁrewalls also support PPTP and L2TP
clients that are found in Microsoft Windows operating systems.
■
Encryption The PIX and ASA ﬁrewalls utilize one of three cryptographic algo-
rithms for data conﬁdentiality and integrity protection.These algorithms are the
56-bit Data Encryption Standard (DES), the 168-bit Triple DES (3DES), and the
Advanced Encryption Standard (AES) algorithm.The AES implementation in the
PIX and the ASA supports up to 256-bit encryption.
Additional information about PIX ﬁrewalls can be found at www.cisco.com/go/pix.You’ll
ﬁnd additional information about ASA devices at www.cisco.com/go/asa.
3000 Series VPN Concentrator
The third major product in Cisco’s VPN lineup is the 3000 series concentrator.The concen-
trator provides dedicated VPN services for remote access as well as LAN-to-LAN connec-
tivity.The 3000 series provides for a wide range of models, from the 3005 for small
enterprise networks to the 3080, designed for large enterprise networks.The 3000 series
concentrator includes a software client that allows for easy conﬁguration of IPSec tunnels by
remote users.Additionally, a hardware version of the client, the 3002 concentrator, provides
remote IPSec connectivity for telecommuters.Another beneﬁt of the 3000 series VPN con-
centrator is the SSL VPN support that is built into the box, allowing you to deploy an SSL
VPN solution without buying a dedicated box, although if your deployment becomes large
enough, you will want it to run on dedicated hardware. Cisco has more information about
the VPN 3000 platform at www.cisco.com/go/vpn3000.
Cisco EasyVPN
A recent software enhancement that simpliﬁes VPN deployment in Cisco devices is Cisco
Easy VPN.This feature centralizes VPN management and provides for the single deployment
of consistent VPN policies and key management methods, thereby simplifying remote-site
VPN management.The software consists of two components: the Easy VPN Remote and
the Easy VPN Server.
The Cisco Easy VPN Remote feature allows Cisco IOS routers, Cisco PIX and ASA
ﬁrewalls, and Cisco VPN 3002 hardware clients or software clients to act as remote VPN
clients.These devices can receive security policies from a Cisco Easy VPN Server, thus mini-
mizing VPN conﬁguration requirements at the remote location.This cost-effective solution
www.syngress.com
596
Chapter 12 • DMZ-Based VPN Services

is ideal for remote ofﬁces with little IT support or large customer premises equipment
(CPE) deployments in which it is impractical to individually conﬁgure multiple remote
devices.This feature makes VPN conﬁguration as easy as entering a password, increasing pro-
ductivity and lowering costs as the need for local IT support is minimized.
The Cisco Easy VPN Server allows Cisco IOS routers, Cisco PIX and ASA ﬁrewalls,
and Cisco VPN 3000 concentrators to act as VPN head-end devices in site-to-site or remote
access VPNs, where the remote ofﬁce devices are using the Cisco Easy VPN Remote fea-
ture. Using this feature, security policies deﬁned at the head end are pushed to the remote
VPN device, ensuring that those connections have up-to-date policies in place before the
connection is established. In addition, a Cisco Easy VPN Server-enabled device can termi-
nate VPN tunnels initiated by mobile remote workers running Cisco VPN client software
on PCs.This ﬂexibility makes it possible for mobile and remote workers, such as salespeople
on the road or telecommuters, to access their headquarters intranet data and applications.
Additional information on the EasyVPN solution is at www.cisco.com/go/easyvpn.
Windows VPN
Microsoft has integrated VPN solutions into its Windows 2000, Windows XP Home
Edition, Windows XP Professional, and Windows 2003 products.Additionally, a download-
able application, the Microsoft L2TP/IPSec VPN client, is available; it allows users of older
versions of Microsoft Windows (such as NT 4.0, ME, and 98) to create VPN connections.
Additional information as well as a download link for this client is available from Microsoft
at www.microsoft.com/technet/prodtechnol/windows2000serv/support/vpnclientag.mspx.
The implementation of VPNs in Windows is based on a combination of IPSec and
L2TP, as described in RFC 3193. For every L2TP connection, the IPSec Encapsulating
Security Payload (ESP) Transport Mode is negotiated utilizing 3DES as an encryption algo-
rithm. L2TP encapsulates PPP frames to be sent over a variety of network protocols,
including IP, X.25, Frame Relay, or asynchronous transfer mode (ATM) networks. L2TP is
documented in RFC 2661.
L2TP over IP uses UDP to send the tunneled data.The packet payloads are L2TP-
encapsulated PPP frames that can be encrypted and/or compressed. In this case, IPSec pro-
vides the encryption of the payload data. Figure 12.10 shows the structure of an IP packet
containing an L2TP packet.
Figure 12.10 IP Packet Transporting an L2TP Frame
DMZ-Based VPN Services • Chapter 12
597
PPP Frame
L2TP Frame
UDP Packet
PPP Payload
(IP Datagram)
IP
Header
UDP
Header
L2TP
Header
PPP
Header
www.syngress.com

In addition to the L2TP/IPSec VPN solution from Microsoft, there is also support for
PPTP as a VPN technology in the Windows operating system. PPTP functions are divided
between a PPTP Access Controller (PAC) running on a dial-access platform and a PPTP
Network Server (PNS) that operates on a general-purpose operating system. Windows allows
for the PAC and the PNS to exist on a single platform by utilizing Windows Remote Access
Service (RAS) for the PAC dialup capabilities as well as the VPN service for the PNS. PPTP
uses an enhanced GRE mechanism to provide a ﬂow- and congestion-controlled encapsu-
lated datagram service for carrying PPP packets. Some service providers do not allow GRE
packets to traverse their networks, so that could be an obstacle to deploying PPTP as a VPN
solution.
Designing an IPSec Solution
This section focuses on the design of an IPSec solution for a given scenario.The focus here
is on the identiﬁcation of the various needs that drive the choices within an IPSec design.
Designing & Planning…
Tuning VPN Trafﬁc
As noted earlier in the chapter, placing the VPN in the network depends on
whether the tunnel endpoint should terminate at the edge router, on a dedicated
VPN appliance, or on the ﬁrewall itself. However, we failed to cover one aspect
of this question: the amount of VPN overhead and its effect on the ﬁrewall or
edge router. Due to the nature of IPSec, which encapsulates the data it is car-
rying, the IPSec packet sizes are larger than can normally be handled by a router.
Therefore, IPSec trafﬁc tends to get fragmented by an edge device such as a
router, resulting in poorer VPN performance. Another possible side effect occurs
when packets are marked “Do Not Fragment” in the IP header. When these
packets are encapsulated and become larger than a router can accept, the packet
will be dropped, never reaching the destination.
To accommodate this situation, it is generally recommended that the
Maximum Transmission Unit, or MTU (i.e., the maximum packet size), be reduced
to accommodate the additional IPSec headers. It is best to reduce the packet size
to approximately 1400 bytes (from the standard 1500 bytes in an Ethernet
packet), although this number can change depending on the amount of over-
head that is added. For example, additional overhead is added for DSL lines that
use PPPoE for connectivity to the service provider, which could require you to
reduce the MTU further.
www.syngress.com
598
Chapter 12 • DMZ-Based VPN Services
Continued

If the MTU is set too large, you will likely see some erratic behavior, such as
being able to ping a host but being unable to connect to it with something like
Remote Desktop. The FTP protocol is great for demonstrating the effects of incor-
rect MTU settings. A user with the default MTU of 1500 is connecting over a DSL
line, which requires PPPoE, and establishes an IPSec VPN back to the ofﬁce.
Everything connects successfully, so the user ﬁres up an FTP client so that a fairly
large ﬁle can be transferred to the ofﬁce. The user connects to the FTP server,
authenticates successfully, and then tries to upload the ﬁle. Nothing happens; the
client just sits there attempting the transfer, which won’t go through. 
This is a common problem that is caused by an incorrectly set MTU size.
Most of the packets that pass between client and server during the login phase
are small packets that contain FTP control commands. Even browsing through
directories can work ﬁne, as long as the directory listing isn’t too long, but once
the ﬁle attempts to transfer, the user starts having problems. Since the ﬁle is mul-
tiple megabytes large, the user’s operating system will start breaking down the
ﬁle into chunks small enough that adding the TCP and IP headers will add up to
1500 bytes. Then, when the VPN client encapsulates the packet into IPSec (and
adds another UDP and IP header, if UDP encapsulation is being used), the packet
will be much larger than 1500 bytes, and we haven’t even added the PPPoE
header yet. This prevents only the data transfer from working, since that happens
to be the only time full-size packets are being sent.
Designing an IPSec Encryption Scheme
Most vendors support one of three encryption schemes in their VPN solutions: the Digital
Encryption Standard (DES),Triple-DES (3DES), and the Advanced Encryption Standard
(AES).AES is the chosen replacement for the aging DES algorithm. DES provides for the
use of a 56-bit encryption key that has been proven to be inadequate for long-term security
needs. 3DES uses a 168-bit encryption key, is based on the DES algorithm used in a three-
fold manner, and is considered a stop-gap measure until AES can be fully deployed.AES pro-
vides for key sizes ranging from 128 bits (the minimum required by NIST, according to the
competition) to 256 bits and provides for the use of 192-bit keys.
The real choice of an encryption scheme comes down to the level of security needed in
the VPN as well as the encryption speed desired.As noted earlier, DES has long been proven
insecure against an attacker with sufﬁcient computing means at his or her disposal. 3DES has
yet to be compromised; however, it is signiﬁcantly slower than DES and AES.AES has signif-
icant performance and security improvements over DES and 3DES, but it is still the prover-
bial “new kid on the block” as far as encryption algorithms go. Until now, no known attacks
or weaknesses exist in AES that could result in the compromise of encrypted data. Given
these factors, the choice comes down to 3DES or AES.
In addition to choosing an encryption algorithm, the administrator must decide to use
either the IPSec Authentication Header (AH) or Encapsulating Security Payload (ESP) pro-
www.syngress.com
DMZ-Based VPN Services • Chapter 12
599

tocol.The AH protocol only affects the header of the packet and is used to verify integrity
of the VPN packets; the payload that contains the data is left unencrypted.The ESP pro-
tocol, which is used in most VPN deployments, encrypts the payload of the packet while
leaving the header untouched. Some vendors allow for both protocols to be used simultane-
ously, so that the header can have integrity services in addition to encryption.
There are also two different modes for IPSec tunnels: tunnel and transport.Tunnel mode
is used between two VPN endpoints, such as VPN concentrators, PIX and ASA ﬁrewalls, or
Cisco routers running IPSec capable versions of code.This tunnel can carry trafﬁc for mul-
tiple hosts and/or subnets on each side.Transport mode is used between a VPN client and a
VPN endpoint, such as the Cisco VPN Client connecting to a 3000 series concentrator.This
means that your LAN-to-LAN VPN tunnels will be running tunnel mode while your
remote access VPNs will be conﬁgured to use transport mode.
Designing an IPSec Management Strategy
Another thorn in the side of IPSec is management. For a VPN tunnel to be established
between two peers, the peers must be able to negotiate a security association (SA).An IPSec
SA is a one-way, cryptographically protected connection between a sender and a receiver
that affords security services to trafﬁc.The SA is deﬁned for one direction only, and therefore
a bidirectional connection (such as a VPN tunnel) requires two SAs—one for each direction.
An SA is deﬁned by three values:
■
Security Parameters Index (SPI) This identiﬁes the security association under
which a received packet will be processed.
■
Destination Address This is the address of the destination endpoint for the SA.
■
Security Protocol Identiﬁer This identiﬁes whether the association is an AH-
based or an ESP-based SA.
To establish an SA, the two VPN endpoint devices must have a way of authenticating
each other.This can be accomplished through either a preshared key or digital certiﬁcates.
Preshared keys require that the network administrator conﬁgure the secret key on all VPN
devices that are going to establish tunnels with each other.This could require that the key be
communicated to a party (such as an extranet partner) at the other tunnel endpoint through
an out-of-band method.Additionally, since keys should be changed frequently, the adminis-
trator must coordinate changing keys at periodic intervals. Preshared keys are sufﬁcient for a
small deployment, but they quickly become unmanageable in a large, enterprise deployment
of VPNs.
Another method of authentication between IPSec peers utilizes a PKI to provide the
necessary information for a VPN endpoint device to authenticate to another. In this scheme,
the signed X.509 certiﬁcates for both devices in the VPN are available from a certiﬁcate
server at a certiﬁcate authority (CA). Each device retrieves the public key for the IPSec peer
from the CA and uses it to encrypt its authentication challenge to the other side. If the peer
www.syngress.com
600
Chapter 12 • DMZ-Based VPN Services

is able to respond with the proper reply to the challenge, it is determined that authentication
has succeeded.This method allows both sides to prove their identity before negotiating the
SA. For small deployments, PKI requires more administrative overhead than preshared keys
and is generally not recommended. For larger, enterprise-size deployments of VPNs, PKI
provides signiﬁcant beneﬁts and is desired over preshared keys.
Designing Negotiation Policies
IPSec-based VPN tunnel parameters must be negotiated between the endpoint devices.This
negotiation involves the announcements of encryption schemes the devices support (DES,
3DES,AES) as well as the message authentication code (MAC) hash algorithm that will be
used to verify the integrity of the IPSec packets.Typical supported MAC hash algorithms
include MD5 and SHA-1.These parameters are included as part of the tunnel SA and are
negotiated using the Internet Key Exchange (IKE) protocol (formerly known as the Internet
Security Association and Key Management Protocol, or ISAKMP).
The negotiation policy is where most issues occur when trying to establish a VPN
tunnel between devices made by different vendors.All vendors must use the same options,
since they are deﬁned by the IPSec standard, but the default values for each vendor’s imple-
mentations are usually different, which will prevent a quick-and-easy VPN setup between
two different vendors’ devices. By understanding which options make up the negotiation
policy, you can quickly discover where a mismatch between two devices is occurring and
make the appropriate changes to correct the problem.
VPN setup happens in two different phases, which can be reference by a few different
names.The ﬁrst phase is Phase 1 and is usually a Main mode negotiation.The alternate
method is Aggressive mode, which is discussed in the next section. Some vendors sometimes
refer to settings for Phase 1 as the IKE or ISAKMP settings, since this phase is handled by the
IKE protocol. IKE negotiates an encrypted tunnel between the two VPN endpoints that is
used to negotiate the IPSec SAs that deﬁne the trafﬁc that can pass over the VPN.You can
think of this as an encrypted connection that only the two endpoints use to discuss which
IPSec tunnels need to be created or refreshed.
You need to be concerned with ﬁve options to make the Phase 1 negotiation successful:
■
Encryption algorithm This is where you chose the encryption scheme that will
be used to encrypt the Phase 1 trafﬁc that ﬂows between the VPN endpoints.The
most common options available are DES, 3DES, and AES.
■
Hashing algorithm This is where you chose the hashing algorithm you want to
use to verify integrity and authenticity of the Phase 1 communications.The
chosen algorithm is used to generate a keyed-hash message authenticate code
(HMAC) that allows the other side to detect changes to the packet.The most
common options are MD5 and SHA-1.
■
Phase 1 lifetime This is the maximum amount of time that an IKE session can
stay active before the connection must be torn down and recreated with new
www.syngress.com
DMZ-Based VPN Services • Chapter 12
601

encryption keys. Some vendors implement this option in seconds; others use min-
utes.You need to be aware of which unit of measure each endpoint is using, so
you can make sure these values match.The two most common default values are
24 hours (86400 seconds) and 8 hours (28800 seconds).
■
Difﬁe-Hellman group – Difﬁe-Hellman is a protocol that is used to exchange
private information (such as a shared secret) over an insecure transmission path.
This allows the two sides to negotiate the shared secret for the tunnel, without let-
ting someone who might be watching the conversation learn the password.The
different group values relate to the key size used in the exchange.The larger the
key size, the more secure the transmission will be. Some of the more common
Difﬁe-Hellman groups are:
Group 1 768 bits
Group 2 1024 bits
Group 5 1536 bits
Group 14 2048 bits
■
Aggressive mode A Main mode communicate requires six packets to be sent
back and forth between the two endpoints. When Aggressive mode is enabled, this
transaction can be shortened to three packets, which allows for quicker VPN
setups.The problem with Aggressive mode is that it is less secure because some
data is transferred before a secure tunnel is established.This mode is not required
to be supported by all vendors.
Once the Phase 1 negotiation is complete, the two endpoints can start negotiating the
IPSec tunnels that will carry the trafﬁc between local and remote hosts.This is referred to as
Phase 2 or Quick mode of the VPN negotiation process. Some vendors refer to these set-
tings as the IPSec settings. It is possible for Phase 1 to be conﬁgured correctly but have mis-
matches in the Phase 2 conﬁguration that will prevent trafﬁc from ﬂowing across the tunnel.
It is even possible for only certain IPSec SAs to be conﬁgured incorrectly, causing some
trafﬁc to be unable to pass, while other trafﬁc can traverse the VPN just ﬁne.
NOTE
Remember that an SA only allows communication from a single host or subnet to
a single remote host or subnet. This means that if you have three subnets on each
side of the VPN tunnel, nine SAs will have to be created for all three local subnets
to be able to send trafﬁc to the three remote subnets. Another nine will have to
be created to receive the inbound packets from the three remote subnets. 
www.syngress.com
602
Chapter 12 • DMZ-Based VPN Services

Phase 2 has more available options than Phase 1, so most of the VPN negotiation prob-
lems tend to be in the Quick mode conﬁguration.These options are listed and explained
here.This list covers the most common options, but since many VPN vendors might have
implemented proprietary features, we cannot cover every possible option that a vendor may
implement:
■
Encryption algorithm This is where you chose the encryption scheme that will
be used to encrypt the data that ﬂows between the local and remote networks or
hosts.The most common options available are DES, 3DES, and AES.
■
Hashing algorithm This is where you chose the hashing algorithm you want to
use for the IPSec SAs.The most common options are MD5 and SHA-1.
■
Phase 2 lifetime This is the amount of time that the IPSec SA can pass trafﬁc
before it must be torn down and renegotiated with new encryption keys.This
helps ensure that if someone does manage to crack the encryption for one of your
SAs, they will only be able to decrypt a small amount of data.The default IPSec
lifetime for most VPN devices is 1 hour (3600 seconds). Some devices can also
implement a kilobyte lifetime for the IPSec SAs, so after a certain amount of data
is transferred, a renegotiation occurs.“Responder Lifetime” error messages can be
generated if one side is using both a seconds and kilobyte lifetime while the other
is only looking at a seconds lifetime, although this situation usually doesn’t prevent
trafﬁc from using the tunnel.
■
Perfect Forward Secrecy The previous item describes how the keys used for
the IPSec SA are renegotiated after an agreed-on amount of time has passed.The
new keys to be used during the next time period can be derived from the other
keys used in the exchange, which could allow a hacker to break multiple keys if
the hacker manages to compromise a single one. Perfect Forward Secrecy (PFS)
uses the Difﬁe-Hellman algorithm to derive the new keys, so there isn’t a mathe-
matical relationship between the new and old keys.This prevents a hacker from
being able to derive other keys used in the exchange after a renegotiation occurs.
As with Difﬁe-Hellman exchanges in IKE, you will have to conﬁgure the Difﬁe-
Hellman group (key strength) you want to use in your implementation of PFS.
■
Local networks/hosts This is where you deﬁne the list of networks and/or
hosts on the local end of the VPN device that should be able to communicate
over the VPN tunnel.This option can have many names, such as interesting trafﬁc or
the local encryption domain, depending on the vendor you are using.The local net-
works deﬁned for VPN Endpoint A should be exactly the same as the Remote
Networks deﬁned on VPN Endpoint B.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
603

■
Remote networks/hosts This is a list of networks and/or host addresses that
should be accessible on the remote side of the VPN tunnel.This option is some-
times referred to as interesting trafﬁc or the remote encryption domain, depending on
the vendor.The remote networks deﬁned on VPN Endpoint A should be the
exact same as the local networks deﬁned on VPN Endpoint B.
Many of these options are global for all SAs associated with the VPN tunnel, but some
of them are applied on a per-SA basis, such as the local and remote networks that will be
traversing the tunnel. Some vendors allow you to specify both sides of the SA exactly how
you want it; others will try to supernet the networks you input to the largest possible subnet
to keep the SA count as low as possible. Some allow you to specify a network but create
host-to-host SAs for each host within that subnet. When you start trying to establish tunnels
between devices that are using these different options, you are very likely to end up with SA
mismatches that will prevent the VPN from establishing correctly.You must be extremely
aware of how your VPN device handles the SA deﬁnitions so that you can be sure to make
your SAs match exactly what the other side expects to see. Sometimes this will require you to
use any debugging modes available for your product that will tell you exactly what options
are being sent and received, so that you can identify where the problem might exist.
Designing Security Policies
IPSec security policies are deﬁned as a set of conditions that deﬁne an action.The conditions
typically determine whether trafﬁc passing through the device is to be encrypted and sent
through the VPN tunnel or allowed to pass through unencrypted to a device outside the
tunnel. For example, a simple policy would be:
If <condition> then <action>
Here, <condition> can be the source IP address, the destination IP address, the source or
destination port, or the IP protocol being used.The <action> can be to deny the trafﬁc, allow
it, or pass it through the VPN tunnel. Figure 12.11 shows an example of a security policy
being used to segregate IPSec trafﬁc from non-IPSec trafﬁc.
Figure 12.11 An IPSec VPN Security Policy
604
Chapter 12 • DMZ-Based VPN Services
permit ip host 192.168.155.1 host 172.16.45.100
Server A
Server B
192.168.155.1
172.16.45.100
www.syngress.com

In this example, the security policy is shown at the very top.Any IP trafﬁc with a source
IP address of 192.168.155.1 whose destination is 172.16.45.100 is permitted into the tunnel.
Once trafﬁc has been identiﬁed as valid for the tunnel, the trafﬁc is encrypted according to
the tunnel encryption scheme.All trafﬁc that does not match this security policy is allowed
to pass through the router interfaces unencrypted and outside the VPN tunnel.
Designing IP Filters
IP ﬁlters can be used to restrict trafﬁc coming from an external network through the VPN
tunnel.These ﬁlters can limit access only to certain servers on port 80 or allow a broader
level of access to the DMZ as a whole. VPN tunnel ﬁlters act like ACLs on ﬁrewalls and
edge routers by giving administrators the ability to deﬁne trafﬁc that is permissible. Unlike
ACLs on routers and ﬁrewalls, IP ﬁlters tend not to be stateful and therefore may require
more explicit rules to provide for proper two-way communication through the tunnel.
Deﬁning Security Levels
Security levels are used to determine the security policies to implement and where.A net-
work with a high security level might restrict trafﬁc signiﬁcantly, such that only encrypted
trafﬁc is allowed to access the network.Typically, networks with higher security levels con-
tain more sensitive information and have a more restrictive access policy as well as a more
restrictive security policy. Medium security levels allow a broader range of trafﬁc in and out
of the network but could still require strong authentication or encryption to protect the data
in the communication.A low security network could allow plain-text communication pro-
tocols such as Telnet, FTP, or HTTP to access information on servers in the network.
Furthermore, the amount of restriction on the trafﬁc might be minimal.
This concept is also implemented in the PIX and ASA ﬁrewalls, where each interface is
deﬁned a security level.Trafﬁc entering interfaces on higher security levels can automatically
access networks of a lower security level without any explicit rules.To allow access from a
lower security level into a network that is a higher security level, you will have to create
explicit rules. For example, your trusted internal network could have full outbound access to
the Internet automatically while trafﬁc originating from the Internet cannot access your
internal network without explicit rules.
Connecting B2B Sites
Business-to-business (B2B) connectivity has been made immensely easier with the emer-
gence of the Internet and even easier still with the maturation and availability of VPN tech-
nologies. In the past, B2B connectivity utilized leased lines or dialup connections for the
exchange of information and technology between two companies. VPNs have eliminated
that need. However, trust is still of great concern.As with any business relationship, the trust
between two companies can deteriorate at a rapid pace. Consider the relationship of Cisco
www.syngress.com
DMZ-Based VPN Services • Chapter 12
605

Systems Inc. and Dell Computer Corporation. In early 2003, the longtime business relation-
ship between the two was terminated, with Cisco Systems citing Dell’s entry into the switch
marketplace as a factor.
Extranets
Extranets are B2B networks that are based on Internet network technology.An extranet can
be viewed as part of a company’s intranet that is made accessible to other companies or to
the public or that comprises components that enable collaboration with other companies.
Excellent examples of extranets include the Federal Express Tracking System
(www.fedex.com/us/tracking/) and the UPS Tracking System
(www.ups.com/WebTracking/track).These systems allow users to access both FedEx and
UPS public sites, enter tracking numbers, and locate any package still in the system.
Additionally, a user with either a FedEx or a UPS account can enter all the information
needed to prepare a shipment form, obtain a tracking number, print the form, and schedule a
pickup—all from the convenience of the user’s computer and a Web browser. Other uses of
extranets include:
■
Private newsgroups between companies to share valuable experiences and ideas
between business partners
■
Sharing educational material or training programs 
■
Shared product catalogs accessible only to a select group within the industry
■
Project management for intercorporate projects 
As with any other connection, the main point to consider in terms of VPN extranet
implementation is the termination point for the VPN tunnel. For extranets, there are two
possibilities: at the edge router or at a dedicated VPN device in a DMZ leg of the ﬁrewall. It
is not recommended that the VPN be terminated at the ﬁrewall, because of the need to
ensure that the extranet business partner is controlled.Terminating the VPN at the inside
interface of the ﬁrewall could provide the partner with signiﬁcant access to corporate infor-
mation as well as complete access to the corporate network.As we saw with Cisco and Dell,
although the extranet partner might be trusted today, tomorrow that partner might well be a
competitor.
VPN Security
VPN security is perhaps a more critical function of overall network security due to the fact
that extranet VPNs rely on the security of business partners. Unlike remote ofﬁce or branch
networks that fall under the jurisdiction of the corporate security umbrella, extranet partners
that connect into a corporate DMZ through a VPN might not follow the same methods or
implement the same security policies. It is not unheard of for a secure network to be
exploited by an attacker taking advantage of an extranet partner’s VPN.This leads to the
www.syngress.com
606
Chapter 12 • DMZ-Based VPN Services

need to apply differing levels of trust to each VPN tunnel termination point. Many VPN
appliances allow for the application of IP ﬁlters in the tunnel, much like a ﬁrewall.To ensure
the highest level of security in the case of an extranet partner whose network security status
is unknown, it is best to terminate the VPN tunnel at the edge router or at a VPN appliance
in a designated DMZ off the ﬁrewall.These two cases are illustrated in this section.
In Figure 12.12, the termination point for the VPN tunnel allows the extranet partner’s
trafﬁc to access the DMZ between the ﬁrewall and the edge router.This allows the tunnel to
bypass the ACL on the edge router’s external interface but still requires the trafﬁc to comply
with the ﬁrewall’s security policy. In Figure 12.13, the tunnel is terminated at a VPN appli-
ance in a second DMZ leg of the ﬁrewall.This tunnel also bypasses the ACL on the edge
router as well as the security policy on the external interface of the ﬁrewall, but—for the
trafﬁc to access devices within the corporate headquarters network—the trafﬁc must comply
with a deﬁned security policy on the ﬁrewall’s DMZ interface.The trafﬁc permitted by
policy deﬁned on this interface could be considerably different from the trafﬁc permitted by
the policy on the ﬁrewall’s external interface.This provides the ﬂexibility to provide a higher
level of trust between the extranet partner’s network and the corporate network.As an added
level of security, you can deploy IDS at the extranet tunnel termination point to monitor
trafﬁc arriving from the external partner network.
Figure 12.12 Extranet VPN Termination on an Edge Router
www.syngress.com
DMZ-Based VPN Services • Chapter 12
607
Firewall
Corporate
Edge
Router
a
a
 ISP 1
 ISP 2
 ISP 3
Internet
Extranet Business
Partner
Authentication
Server
Corporate
Office

Conﬁguring & Implementing…
Vendor IPSec Enhancements
One of the key issues that must be addressed when you’re designing an IPSec VPN
solution for extranets is the equipment to be used. IPSec itself is an IETF standard
based on a whole range of RFCs, but there has been enough leeway and confusion
in the development of IPSec that vendors have implemented proprietary enhance-
ments to the protocols. At best, these enhancements can result in no impact in the
conﬁguration and implementation of the VPN. At worst, they can, in some cases,
result in signiﬁcant difﬁculties in getting a VPN tunnel to work, if at all. The IETF is
working on resolving the issues with vendor enhancements to the IPSec protocol.
The simple workaround is intended to ensure that either both parties are using the
same vendor’s VPN product or that the products being used are tested and certi-
ﬁed as compatible with other vendor VPN equipment.
Figure 12.13 Extranet VPN Termination at a VPN Appliance
www.syngress.com
608
Chapter 12 • DMZ-Based VPN Services
VPN
Appliance
Firewall
Corporate
Edge
Router
a
 ISP 2
 ISP 3
Internet
Corporateete
e
Office
Extranet Business
Partner
Corporate
Office
Authentication
Server
 ISP 1

Active Directory Security 
Perhaps a business partner requires more access to your corporate network than just data on
a group of servers. Other methods, such as data mirroring or utilizing dual-homed servers,
can accommodate such a case, the practical and more secure solution is to implement such a
design using an IPSec VPN. Microsoft provides integrated software on the Windows server
that allows for the deployment of a quick and easy VPN solution to address this scenario.
This solution provides for greater ease on the part of the remote user as well as lower
administrative overhead for the corporate administrator; it is achieved through the use of an
IPSec policy that is maintained and managed using Group Policy objects stored in Active
Directory.
Figure 12.14 shows an example VPN connection sequence using Windows Active
Directory authentication. Here is the sequence of steps used in authenticating the user:
1.
The remote user initiates a request to access the network via VPN connection.
The user logs in using her username and password for the domain.
2.
The VPN server requests authentication from the domain controller. If the VPN
server is able to authenticate to the domain controller, the VPN server checks the
authorization of the requesting user for VPN access.
3.
If the domain controller authorizes the requesting user for VPN access, the VPN
server and the remote client start an IKE exchange.
4.
The domain controller authenticates the CA server and authorizes the CA server
to issue a certiﬁcate to the remote user.
5.
The remote user is issued a certiﬁcate from the CA.This certiﬁcate allows the
encryption process to ﬁnish.
6.
The IPSec VPN is now established and the remote user is able to access the cor-
porate network with all the permissions she normally would have as if she were
physically present at the corporate network and connected to it.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
609

Figure 12.14 VPN Connection Using Active Directory Authentication
Summary
VPNs have quickly come to supplant traditional WAN technologies such as Frame Relay,
leased lines, and dialup networks.They reduce the total cost of ownership of the WAN by
eliminating recurring costs associated with those technologies and utilizing the underlying
and nascent IP technology a company has deployed.The key to VPN utilization in a DMZ
focuses on the deployment of the VPN in the DMZ itself.
There are three primary methods of terminating VPN tunnels in a DMZ: at the edge
router, at the ﬁrewall, and at a dedicated appliance. Each method has its advantages and dis-
advantages.Terminating the VPN at the edge router allows trafﬁc to reach servers outside the
ﬁrewall and possibly inside the ﬁrewall, depending on the conﬁgured policy, but this solution
can eat up resources on a device that is usually designed to pass packets as quickly as pos-
sible.Terminating a VPN tunnel at the ﬁrewall, however, allows direct access to the internal
or DMZ network but could actually lower the security posture of the internal network if
not conﬁgured well and can use up resources on the ﬁrewall, which could slow down pro-
cessing of all trafﬁc leaving your network.The last option is using a dedicated VPN appli-
ance, which could require some extra attention to make sure it is implemented in a secure
fashion; this is an additional expense when most companies already have edge routers and
www.syngress.com
610
Chapter 12 • DMZ-Based VPN Services

ﬁrewalls, but it allows for larger VPN infrastructures to be built without placing a burden on
other devices in the network.
In addition to these deployment models, there are four deployment topologies to con-
sider: mesh (both fully and partially), star, hub and spoke, and remote access. Each topology
has advantages and disadvantages that should be carefully considered before implementation.
Once you’ve chosen the deployment method and topology for the VPN, the next step is
to identify and design an IPSec security solution.This step includes identifying the encryp-
tion algorithm to use as well as the type of IPSec protocol and transport method.Tunnel
negotiation characteristics must be decided as well, to ensure that both sides of the tunnel are
conﬁgured properly. Determining the IPSec security policy will identify the trafﬁc character-
istics used to distinguish trafﬁc destined for the IPSec VPN tunnel and trafﬁc that will bypass
the tunnel.
VPNs have advanced a long way since the days of leased lines and Frame Relay.The
development of IPSec and other technologies has vastly changed the landscape with regard
to WAN deployment, extranet partner connections, and B2B interaction and communica-
tion.As VPNs continue to mature, they will become the dominant force in these areas by
helping drive down the total cost of ownership of the WAN.
Solutions Fast Track
VPN Services in the DMZ
■
There are three general deployment models of VPN services in the DMZ: at the
edge router, at the internal interface of the ﬁrewall, and at a dedicated VPN device
in a DMZ leg of a ﬁrewall.
■
The four topologies for VPNs are mesh (both fully and partially), star topology,
hub-and-spoke topology, and remote access.
■
The difference between a star topology and a hub-and-spoke topology lies in the
fact that in a star topology, the branch or stub networks are not able to
communicate with one another.They can only communicate with the central
corporate network.
■
IPSec is not capable of traversing NAT devices without some modiﬁcation.The
problem comes when the NAT device changes information in the IP header of
the IPSec packet.The changes will result in an incorrect IPSec checksum that is
calculated over parts of the IP header.There are workarounds for this problem,
such as NAT-T.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
611

■
When the number of VPNs connecting to the router, ﬁrewall, or VPN appliance
becomes sufﬁciently large, it might be necessary to install a VPN accelerator
module (VAM) into the device to ofﬂoad many of the cryptographic functions
used in the VPN.
Designing an IPSec Solution
■
There are three main choices for encryption schemes in IPSec: DES, 3DES, and
AES.AES deployment is not as wide at present, so it might not be possible to use
that encryption algorithm. DES has been proven insecure against an attack with
sufﬁcient resources. 3DES is the only current algorithm that is widely available and
provably secure.
■
Message integrity is provided through the use of MD5 or SHA-1 with the
HMAC hash algorithm.
■
Before an IPSec VPN tunnel can be established, the session parameters must be
negotiated through the use of Internet Key Exchange.
■
There are ﬁve options to be concerned with during Phase 1, or Main mode, VPN
deployments: encryption algorithm, hashing algorithm, lifetime, Difﬁe-Hellman
Group, and Aggressive mode.
■
There are six main options to be concerned with during Phase 2, or Quick mode,
negotiations: encryption algorithm, hashing algorithm, lifetime (seconds and/or
kilobytes), Perfect Forward Secrecy, local networks, and remote networks.
■
IPSec security policies deﬁne the trafﬁc permitted to enter the VPN tunnel.
Connecting B2B Sites
■
Extranets are B2B networks based on Internet network technology.An extranet
can be viewed as part of a company’s intranet that is made accessible to other
companies or to the public or that comprises components that enable
collaboration with other companies.
■
For partner extranets, there are two possible VPN deployment models: VPN
tunnel termination at the edge router or VPN tunnel termination at a dedicated
device on a DMZ leg of the ﬁrewall.
■
VPN security is a critical function of overall network security due to the fact that
extranet VPNs rely on the security of the business partners.
www.syngress.com
612
Chapter 12 • DMZ-Based VPN Services

Q: Why does IPSec have difﬁculty traversing a NAT ﬁrewall unmodiﬁed?
A: Incompatibilities between NAT and IPSec can be caused by myriad issues, two of which
are described here:
■
The AH protocol incorporates the IP source and destination addresses in the keyed
message integrity check. NAT devices make changes to address ﬁelds and therefore
invalidate the message integrity check.
■
TCP and UDP checksums have a dependency on the IP source and destination
addresses through inclusion of the “pseudo-header” in the calculation IPSec. ESP
only passes unimpeded through a NAT device if TCP/UDP is not involved.This
can be accomplished through the use of IPSec tunnel mode or IPSec/GRE. It is
also possible for ESP to pass unimpeded through a NAT device if checksums are
not calculated (as is done with IPv4 UDP).
For a more complete overview of problems between NAT and IPSec, see the IETF
Security Working Group’s Internet draft, IPSec-NAT Compatibility Requirements, at
www.ietf.org/internet-drafts/draft-ietf-IPSec-nat-reqts-04.txt.
Q: How does IKE work?
A: The Internet Key Exchange (IKE) protocol is designed to provide mutual authentication
of systems as well as to establish a shared secret key to create in IPSec SA. IKE operates
in two phases. Phase 1 provides mutual authentication of the systems as well as estab-
lishing session keys and is known as the ISAKMP SA. Phase 2 provides for setting up
the IPSec SA.
Q: What is the signiﬁcance of terminating a VPN tunnel on a ﬁrewall’s internal interface?
A: Terminating a VPN tunnel on a ﬁrewall’s internal interface allows all VPN trafﬁc to
access the internal directory in one hop.This might not be desirable, and if IP ﬁlters
cannot be applied to VPN tunnel trafﬁc, other methods, such as having the VPN tunnel
terminate within an isolated VLAN, must be employed to restrict the trafﬁc.
www.syngress.com
DMZ-Based VPN Services • Chapter 12
613
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

Q: What is the beneﬁt of placing the VPN appliance in a DMZ leg of the ﬁrewall, as was
shown in Figure 12.11?
A: Placing the VPN appliance in a DMZ leg of the ﬁrewall allows for the application of a
unique ﬁrewall policy that is speciﬁc for the VPN trafﬁc.The public interface of the
VPN appliance sits outside the ﬁrewall while the private interface is in the DMZ leg of
the ﬁrewall.
Q: What other types of VPNs are available besides IPSec?
A: Other VPN technologies do exist.They include Point-to-Point Transport Protocol
(PPTP), which was originally developed by Microsoft, and Layer 2 Tunneling Protocol
(L2TP), which was a merger of Microsoft’s PPTP and Cisco Systems’ Layer 2
Forwarding (L2F) protocol. PPTP is deﬁned in RFC 2637, and L2TP is deﬁned in 
RFC 2661.
www.syngress.com
614
Chapter 12 • DMZ-Based VPN Services

Windows 
Bastion Hosts
Solutions in this chapter:
■
Conﬁguring Bastion Hosts
■
Testing Bastion Host Security
■
Windows 2003 and Windows 2000
■
Remote Administration
■
Bastion Host Maintenance and Support
■
Windows Bastion Host Checklist
Chapter 13
615
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
Before we delve too deeply into the conﬁguration of a bastion host, let’s discuss just what is
meant by the term bastion host.A bastion is generally deﬁned as a stronghold or area that is
exceptionally fortiﬁed against an attack. In network terms this could easily apply to most any
security appliance.Typically, however, the term is used to describe a general-purpose net-
working device that has been intentionally hardened against attack because it will be providing
some service to an untrusted network. In most cases, the untrusted network will be the
Internet, but it could also be an extranet, wireless DMZ, or business-to-business (B2B) net-
work. In short, much like the protective gates of an ancient castle, great effort is expended to
secure a network device because you are expecting it to be attacked.The most common exam-
ples of a bastion host are an Internet-facing Web server or DNS server.These are servers that,
by their nature, are exposed to the Internet and a nearly constant barrage of attacks.
At a high level, this hardening includes applying security patches, conﬁguring logical
access controls, and conﬁguring operating system-speciﬁc settings to make the system more
secure. Obviously, entire volumes could be and have been written to cover the hardening of
speciﬁc operating systems.Therefore, this chapter provides a high-level overview of the steps
that are needed to harden a Microsoft Windows 2000 or 2003 server, explaining the relevant
concepts, pointing out any pitfalls or caveats in the process, and providing sources of addi-
tional information where applicable.
Conﬁguring Bastion Hosts
When it comes to conﬁguring a bastion host, try to take a minimalist approach.This host
will be probed and attacked by people with a lot more free time to spend attacking the
machine than you have to defend it. If the host has no services running on a given port, the
proper response to trafﬁc destined for that port is to ignore the packet.This means that com-
promising the system using trafﬁc on a port the host isn’t supposed to be listening to requires
a pretty substantial security ﬂaw in the host’s TCP stack itself.Although these ﬂaws do
happen, as time goes on and the TCP stacks become more mature these types of exploits
become less frequent. What this leaves as the most common exploit path is security ﬂaws in
the software that is listening on a given port. For this reason, you want as few processes lis-
tening on open ports as absolutely necessary.
Planning a bastion host takes time. If you decide to cut corners and put a machine into
production with the intent of hardening the system “later,” you could end up with a com-
promised system. Implementing a bastion host that can withstand the rigors of being visible
on the Internet takes someone who is skilled and experienced with the operating system in
question.There are a plethora of excellent books covering virtually every operating system
currently on the market.Armed with an understanding of the role the host will play in the
network and an understanding of the available options for a given operating system, you will
be well prepared to successfully implement your bastion host.
www.syngress.com
616
Chapter 13 • Windows Bastion Hosts

Testing Bastion Host Security
Whether you are implementing a bastion host from scratch or securing one that you inher-
ited, the ﬁrst step will be to test the current security of the host. If you built, planned, and
implemented the bastion host yourself, the next thing you will want to do is run a few tests
to make sure it is as secure as you had planned. Similarly, if you are inheriting a pre-existing
bastion host, the ﬁrst thing is to determine the current state of the system.This step is vital
so that you can know what work still needs to be done and so you can prioritize the reme-
diation of any remaining vulnerabilities.
Vulnerability Scanning
If you are starting with a pre-existing bastion host that needs to be hardened, a vulnerability
assessment is the ﬁrst step.You need to begin by establishing a security baseline so you know
what needs work and can prioritize your efforts. Vulnerability scanning is the process of per-
forming automated checks for known security weaknesses.A wide variety of vulnerability
scanners are available. Some are more invasive than others, meaning that their scanning is
more likely to cause a service disruption.The closer the software comes to actually executing
an attack, the more accurate is the estimate of your vulnerability to such an attack.
Unfortunately, the test is also more likely to cause some problems. Problems typically
arising from a vulnerability scan are unresponsive services or software. In most cases these
problems can be corrected by restarting the service or rebooting the machine, but in a pro-
duction environment, such steps could be undesirable. In other cases, however, the testing
can cause signiﬁcant damage, such as data corruption when scanning a database. For this
reason, any vulnerability scanning should be undertaken with great care.The tester also needs
to ensure that he or she has explicit permission from upper management to perform the
testing.This permission is for legal protection in case the testing causes any signiﬁcant prob-
lems that result in ﬁnancial loss.
Nmap
Truly a vulnerability scanner on its own, Nmap is typically the ﬁrst tool an attacker will
reach for, so you should be familiar with it as well. Nmap is the most widely used general-
purpose, free port scanner; it’s available from www.insecure.org/Nmap/. In addition to
simple port scanning, Nmap can use a variety of techniques to attempt to see what ports are
open on a host behind a ﬁrewall and attempt to scan without setting off any intrusion detec-
tion systems that might be listening. Nmap can also attempt to identify the OS through a
technique known as ﬁngerprinting. OS ﬁngerprinting utilizes a variety of techniques such as
inspecting the initial sequence number, supported TCP options, and initial window size.
Nmap’s primary role is to scan a machine and determine which ports on the machine are
listening. Identifying the operating system and the types of software that are running will go
a long way to help the hacker choose which exploits to attempt.
www.syngress.com
Windows Bastion Hosts • Chapter 13
617

Although the number of options Nmap accepts can appear daunting, it comes with excel-
lent instructions on its use.This is sample output of a basic scan with only the -O (OS detec-
tion) option enabled.
#nmap –O 192.168.1.99
Starting nmap 3.75 ( http://www.insecure.org/nmap/ ) at 2006-06-12 06:27 EDT
Interesting ports on 192.168.1.99:
(The 1660 ports scanned but not shown below are in state: closed)
PORT
STATE SERVICE
135/tcp open
msrpc
139/tcp open
netbios-ssn
445/tcp open
microsoft-ds
MAC Address: 00:11:D8:88:0F:B3 (Asustek Computer)
Device type: general purpose
Running: Microsoft Windows 2003/.NET|NT/2K/XP
OS details: Microsoft Windows 2003 Server or XP SP2
Nmap run completed -- 1 IP address (1 host up) scanned in 1.595 seconds
Nmap is natively a command-line tool, but you can download a GUI front end called
Nmapfe that does a good job of turning the sometimes complicated command lines into a
simple point-and-click screen.You can also ﬁnd Windows ports of Nmap, though they don’t
run nearly as fast as the native Linux versions.
Nessus
Nessus is a true vulnerability scanner available from http://nessus.org/index.php.Although
still free, the most current version (Nessus 3) is no longer open source.The Nessus system
comprises two components: a server and a client.The server process does the actual scan-
ning; the client is used to conﬁgure and run scans and view the results of a scan. Nessus is a
very feature-rich application that can perform more than 10,000 types of checks via down-
loadable plug-ins. Nessus is available for Linux, FreeBSD, Solaris, Mac OS X, and Microsoft
Windows.The licensing is relatively generous, but in some circumstance you must purchase a
license. For full details on the licensing of Nessus, refer to the licensing FAQ located at
http://nessus.org/plug-ins/index.php?view=faq.
You should periodically scan your hosts for vulnerabilities according to the requirements
of your IT security policy.You should also perform a vulnerability scan any time signiﬁcant
changes are made to your bastion hosts.A signiﬁcant change could include adding a new fea-
ture like enabling terminal services, performing an upgrade, or installing a new service pack.
The installation of Nessus is beyond the scope of this book. For an excellent reference
on Nessus, see the Syngress Press book, Nessus Network Auditing. With Nessus successfully
installed and running, you use the Nessus client to log into the server. In the example shown
in Figure 13.1, the user nessusroot with a password of password is used to log into the server.
www.syngress.com
618
Chapter 13 • Windows Bastion Hosts

Figure 13.1 The Nessus Login Screen
Once you are logged in, you have access to several tabs. Select the Plug-ins tab to
choose the types of checks to perform by clicking in the check box and placing a check
next to them. Use the Target tab to specify which machine to scan. Once you are satisﬁed
with your choices, simply click Start the scan.
NOTE
Several types of check will not be fully tested by default. These are types of scan
that run a higher-than-normal risk of causing an undesirable response from the
target host, typically by causing a service to fail until it can be restarted or the
host rebooted. Nessus’s default behavior is to rely on the host’s responses to
guess whether it is vulnerable instead of actually attempting to exploit the vul-
nerability. This is a safer option, but the results are less reliable. To enable these
plug-ins to perform a true test, you must remove the check next to Safe Checks
on the Scan Options tab.
Once the scan is completed, a report window should open with the results.The inter-
face allows you to go from pane to pane and drill down into your results. By selecting the
Subnet, you are presented with a list of hosts in that subnet. When you select a Host, the
Port pane populates and allows you to drill down into the results for a speciﬁc port. When
you select a speciﬁc Port, you can then choose which results for that port you want to see.
The speciﬁc nature of the vulnerability will be explained in the largest pane in the lower
right, as shown in Figure 13.2.
www.syngress.com
Windows Bastion Hosts • Chapter 13
619

Figure 13.2 Nessus Scan Results
As you can see from the large number of available plug-ins, Nessus is a very powerful
tool for determining vulnerabilities your systems might have. With the large number of sup-
ported operating systems and the ability to check for a wide range of vulnerabilities, Nessus
ﬁts nicely into many security toolkits.
Microsoft Baseline Security Analyzer
The Microsoft Baseline Security Analyzer (MBSA) is just that—a tool for checking the base-
line security of supported Microsoft products.The primary page for MBSA is
www.microsoft.com/technet/security/tools/mbsahome.mspx.There are different versions of
MBSA, each supporting different platforms, so you will need to choose the version that is
appropriate for you.The installation software is relatively short and lightweight, at less than
2MB.The MBSA interface, shown in Figure 13.3, is also very straightforward.
Figure 13.3 Microsoft Baseline Security Analyzer
620
Chapter 13 • Windows Bastion Hosts
www.syngress.com

To scan a single computer, simply click Scan a computer, enter a computer name or
IP address, and then click Start Scan.The results show an expected Microsoft bias. For
example, in Figure 13.4, the MBSA tool has marked a red X because the system doesn’t have
all the disk partitions formatted as NTFS.Although it’s true there is no ﬁle-level security
with FAT32, there can be legitimate reasons for not using NTFS on all partitions.
Figure 13.4 Microsoft Baseline Security Scanner Results
Using Vulnerability Scanning 
Results to Harden Bastion Hosts
Completing a variety of vulnerability scans against your bastion hosts is only the ﬁrst step in
testing their security. Running the scan only tells you where you are vulnerable.The vulner-
ability scanners do not ﬁnish the job for you.You still need to verify that the reported vul-
nerabilities are actually vulnerabilities and not false positives. It is not uncommon for
vulnerability scanners to report something as a risk when in fact it is not. Veriﬁcation can
happen through a variety of means, both automated and manual.After identifying what is
truly a risk, you may ﬁnd yourself staring at a dauntingly long list of risks.
As is usually the case with a large project, the best approach here is to be methodical
and tackle reasonable, bite-sized chunks at a time.A typical next step is to take the assembled
report and sort the vulnerabilities according to priority. Start with the highest-risk items
ﬁrst.This is typically a subjective measure that factors in the vulnerabilities that can most
easily be exploited, the criticality of the host in question, and the likelihood of the vulnera-
bility being exploited.This revised and prioritized list will serve as your road map for the
actual remediation.
Next you must begin the arduous task of securing the vulnerable machine. If you are
lucky, some items on the list might be duplicate vulnerabilities, such that you may be able to
www.syngress.com
Windows Bastion Hosts • Chapter 13
621

automate the changes. For example, suppose your get a long list of directories that have the
permissions set to give everyone full access.You could create a script to connect to the
machine so that it iterates through the list of directories and corrects the permissions. Other
times, each individual change that is needed might need to be made by hand.This process
will likely be time consuming and require extensive communication with stakeholders. Many
times, moving to a more secure conﬁguration could result in some features being disabled.
You should be cognizant of your organization’s change control processes. Large-scale remedi-
ation efforts will bring unexpected problems, and a comprehensive change management pro-
cess will help minimize the service disruptions that could result.
Ideally, vulnerability management should be a mature, cyclical process.As systems are
updated, patched, and modiﬁed, the security posture of those systems will change.
Vulnerability scanning should not be something that is done once and you’re ﬁnished.The
scanning should be repeated on a regularly scheduled basis that is in accordance with your
organization’s IT security policy.The schedule could be dictated simply by the calendar, or it
could coincide with internal audit efforts. Vulnerability scanning and vulnerability remedia-
tion are ongoing processes that are never done.
Conﬁguration Fundamentals
There was a time when Microsoft Windows servers were not even contenders to serve in
the role of bastion host.Those times are gone; more and more Internet-facing servers have
Windows as their underlying operating system.According to a netcraft.com survey of 88 mil-
lion Web sites, Microsoft has gained nearly 15 percent in terms of market share in just the last
three months (placing it at 30% share overall).The survey can be found here:
http://news.netcraft.com/archives/web_server_survey.html.Apache is still the most widely
used Web server, but Microsoft’s Web browser IIS is deﬁnitely closing in. With proper plan-
ning and care, a Windows bastion host can be just as secure as any other operating system.
An important concept to keep in mind as you read this chapter is that the very nature of
a bastion host impacts your strategy to protect it. For most systems connected to your net-
work, you work under the assumption that the ﬁrewalls and routers on your perimeter will
prevent unauthorized access to those systems.The average machine shouldn’t really ever be
reachable by an outside attacker.The bastion host, on the other hand, is exactly the opposite
because it is designed to offer up some service to the outside world.You are working to
secure the bastion host, knowing it will be exposed to hostile network trafﬁc.This expectation
will have a far-reaching impact on your planning and comes into play in virtually every
design decision made concerning the bastion host.
This chapter’s objective is to show you how to conﬁgure the bastion host in such as way
as to minimize the chances of compromise and to minimize the damage that can be done if
it is compromised. Of course, a well-implemented bastion host does not mean that due care
shouldn’t be taken when you’re conﬁguring the network infrastructure.A properly conﬁg-
ured ﬁrewall and network architecture are vital components to keep the bastion host and the
rest of the network as safe as possible from attackers.
www.syngress.com
622
Chapter 13 • Windows Bastion Hosts

Domain Members or Standalone Servers
Very early in the planning process, you will need to determine whether the bastion host will
be conﬁgured as part of a Windows domain or as a standalone server. By allowing the server
to be a member of a domain, you gain the ability to do some security work more easily.
Things like pushing out policies to lock down the machine become much simpler when the
bastion host is part of a domain. Security settings can be applied to parent containers and
then propagated to the objects they hold. When considering this decision, remember the
previous assumption:This machine will certainly be attacked. Realizing this, we want to
minimize any damage that could occur if the host is compromised.
The same isolation that makes administration less convenient on a standalone server can
also help insulate the network from harm if the server is compromised. If an attacker man-
ages to gain control of the bastion host, he or she will only have the ability to compromise
local accounts that have no access to the rest of the network. One of the attacker’s ﬁrst
objectives will be to gain access to additional machines or accounts, so if the original com-
promised account is discovered and locked down, the attacker can maintain access. If the
machine is not a member of a Windows domain, an attacker has a far greater challenge in
gaining access to nonlocal accounts. For this reason, it is considered best practice for bastion
hosts to be standalone servers.
The primary disadvantage of a standalone conﬁguration stems from its limited adminis-
trative capabilities; however, steps can be taken to ease the administrative burden. In the fol-
lowing pages, we discuss several methods for enabling secure remote administration. If you
determine that membership in a domain or active directory is absolutely necessary, there are
some steps you can take to make things as secure as possible.
A ﬁnal consideration is that by not making the system a standalone server, some addi-
tional work will be involved simply to permit domain communications. For example, if there
is a ﬁrewall between the bastion host and the rest of the internal network, ﬁrewall rules will
be needed to allow proper domain communication.This list of ports can get rather lengthy.
The following are Microsoft’s recommendations to allow a Windows 2000 server running
Exchange 2000 domain connectivity:
■
TCP53 (DNS)
■
UDP53 (DNS)
■
TCP80 (Web access)
■
TCP88 (Kerberos to all domain controllers)
■
UDP88 (Kerberos to all domain controllers)
■
UDP123 (NTP to all domain controllers)
■
TCP135 (EndPointMapper to all domain controllers)
www.syngress.com
Windows Bastion Hosts • Chapter 13
623

■
TCP389 (Lightweight Directory Access Protocol, or LDAP, to all domain con-
trollers)
■
UDP389 (LDAP to all domain controllers)
■
TCP445 (Server message block to all domain controllers)
■
TCP3268 (LDAP to global catalog servers)
■
Plus one additional port that must be conﬁgured in the registry on all domain
controllers the Exchange server will use
As you can see, allowing a bastion host to be a member of a domain through a ﬁrewall is
not simple. If you are not careful, by the time you’ve conﬁgured the ﬁrewall to support a
variety of bastion hosts sitting in the DMZ, each offering a variety of services, you could
well end up having a complex ﬁrewall policy with a large number of exceptions for the nec-
essary communications these servers require.At some point you might need to create addi-
tional DMZs, providing further isolation to keep the access control lists reasonable and limit
damage if one of the systems is compromised. Of course, this comes with a price tag, in both
real dollars for equipment as well as management and support overheard for the more com-
plicated infrastructure.
Installation
As is so often the case, the ﬁrst step of installing the operating system does not involve any
software.The ﬁrst step is careful planning. It is important to sit down and plan out what your
needs are, taking into account items such as remote access and remote support, drive parti-
tions, and memory.All of these factors should be laid out well before you sit down and actu-
ally load the operating system. Let’s consider some of the implications of these choices.
Disk Partitions
When it comes to partitioning drives, people tend to fall into one of two camps: Either they
have very strong opinions on how it “should” be done or they just don’t care.At a high
level, the options are to use one single partition per drive or use several partitions per drive.
A majority of Windows systems tend to have the former. Windows can run just ﬁne this
way, but there are several advantages to segregating data onto different partitions and/or
physical disks.
Performance is one advantage. By placing the data on different physical disks, you can
allow greater bandwidth on the controller bus for data transfer.The most common example
of this conﬁguration is to place the Windows swap ﬁle on a different physical disk than the
operating system. In truth, the real performance gains with this setup are very small, but
when you are dealing with a production server having to process a high volume of data, it
could make a difference.Another way to see performance gains is to consider that certain
applications are prone to fragmenting their data. In some cases, this could happen because
www.syngress.com
624
Chapter 13 • Windows Bastion Hosts

the application is inefﬁciently written; in others it could simply be the nature of the pro-
cessing. In these instances, keeping the fragmented partition separate from the operating
system partition could provide some noticeable gains.
There can also be security beneﬁts to using multiple partitions.To be realized, many
common exploits rely on well-known paths to ﬁles.This is true not only at the operating
system level but for application vulnerabilities as well. In some cases you will have afforded
yourself protection from an attack by simply having the vulnerable component on a partition
other than the C: drive.
Once you have determined how you will partition your hard drives, you will need to
decide how to format the partitions.There really isn’t much of an option when it comes to
formatting.The only real choice is NTFS. FAT32 offers no ﬁle-level security at all, so from a
ﬁle system standpoint, everyone who accesses the system would have full control of all ﬁles.
NTFS will allow you to conﬁgure access permissions on individual ﬁles or on entire directo-
ries; it is deﬁnitely the more secure choice.
Service Packs and Hotﬁxes
Now that your hard disks are partitioned and ready to receive the operating system, it’s time
to actually do the installation. It’s worth noting that a clean install is always preferred over
any type of in-place upgrade.This general rule is even more applicable when it comes to
bastion hosts. Frequently the upgrade routine will enable certain features or disable other
ones, with the intent of maintaining backward compatibility with settings or software on the
original system. Often this can introduce a vulnerability that otherwise might not be there
with a clean install. Most often, the upgrade process will not do a good job of removing
unneeded software from the previous installation, resulting in leftover software or programs
on the system that you don’t need.Any of these programs could end up having a vulnera-
bility an attacker could exploit. Whenever possible, it is most secure to perform a clean install
on a freshly formatted system.
Once you have completed the new installation, you will need to bring the machine up
to date on the latest patches and updates.You can go to Microsoft’s Web site to have the
machine automatically checked for updates. It can actually be difﬁcult at times to locate the
proper Web site to do a manual update, because most links will try to take you to the page
to enable automatic updates. If you go to Microsoft’s homepage and then navigate to
Microsoft Update, you will be taken to the page to enable automatic updates.The URL to
manually perform the scan and update is http://update.microsoft.com/windowsupdate/
v6/default.aspx?In=en-us. Even from this Web page there is a button to “Enable automatic
updates.”
The update process on a clean installation will take some time.There will be dozens of
updates, and several reboots will be required. Once this process is completed, you will have
seen the “Enable automatic updates” button many times on the site, and you might be
tempted to use it. Don’t do it! Automatic updates are generally not recommended for mis-
sion-critical servers. If you conﬁgure automatic updates and allow the system to apply
www.syngress.com
Windows Bastion Hosts • Chapter 13
625

updates as they are released, if there is a new patch that breaks something on your server, you
might not know it until it’s already been applied.Automatic updates remove your ability to
apply human judgment in choosing which updates to apply. If you do decide to enable auto-
matic updates, you will be presented with a screen like the one shown in Figure 13.5.
Figure 13.5 Conﬁguring Automatic Updates
This screen allows you to choose when to apply the updates.A better option is to select
the More Options button, after which you will see a screen with some additional choices.
You should select Notify me but don’t automatically download or install them, as
shown in Figure 13.6.
Figure 13.6 Conﬁguring Automatic Updates (Part Two)
www.syngress.com
626
Chapter 13 • Windows Bastion Hosts

This is the best choice for a couple of reasons.As was previously discussed, applying the
patches automatically could result in a system outage.Although Microsoft does test its patches
extensively, it is impossible to test every conceivable combination of hardware and software, so
sometimes problems do occur. Downloading the updates automatically and applying them man-
ually might seem safe; however, the updates themselves could be very large. During this time
the downloading of the update could adversely affect the network load or bandwidth to your
bastion host. For this reason, the recommended option for a bastion host is either to only
notify of updates or to simply disable automatic updates completely.
Another option is to use Windows Server Update Services (WSUS). WSUS allows you
to download the updates to a single system on your network and then allow the client sys-
tems to use their automatic update functionality from your internal system. WSUS offers
several advantages over automatic updates. WSUS allows you to centrally determine which
updates to apply. WSUS also allows you to save on Internet bandwidth because you have to
download the updates only once through the Internet. Client updates will then use your
internal bandwidth.You can ﬁnd more information on WSUS at www.microsoft.com/win-
dowsserversystem/updateservices/default.mspx.
In either case, it is imperative that you don’t completely forget about patching the
devices. During the busy and sometimes hectic work week, it can be easy to neglect patches
and updates.You should have a regularly scheduled change management process that includes
a review of what updates are needed.The updates should then be applied during approved
change windows and then reviewed to ensure that each update was applied properly and
without adverse effect on the host.This managed process will ensure the bastion host’s oper-
ating system is as current and secure as possible.
Removing Optional Components
Once the operating system is installed and updated, you can remove any unneeded compo-
nents.These can include both hardware and software. Recall that the objective is to make the
bastion host as secure as possible under the assumption that it will be attacked.You should
remove any software on the system that is not needed for the bastion host to function prop-
erly. For example, although there might be no known exploits for the built-in Windows cal-
culator (calc.exe), a vulnerability could be discovered in the future. Removing the software
would remove that as a potential vulnerability in the future. Removing the Windows calcu-
lator might be considered extreme in some cases.You will need to carefully evaluate what
components can be safely removed from your environment. Some components to consider
removing or at least disabling could include the following:
■
Unneeded network protocols such as NetBEUI, IPX, and possibly IPv6, if the
environment is not a dual-stack network environment
■
Unneeded software such as Active Desktop
■
Unneeded hardware such as sound cards 
www.syngress.com
Windows Bastion Hosts • Chapter 13
627

Creating a New Local Administrator Account
The local administrator account should be renamed to something that cannot be guessed.
Many exploits target the administrator account by its account name and have no provision
for an administrator account that has been renamed.
After renaming the local administrator account, you should create an additional account
with no privileges and name it administrator, then conﬁgure the account for maximum
auditing (see the next section for auditing conﬁguration).This lets you know if anyone is
trying to access the system using the account named administrator. Barring a brief memory
lapse, employees who are legitimately authorized to access the system will know that there is
no usable account called administrator.This way, if someone does try to access through admin-
istrator, you will get a heads-up that someone is probably trying to compromise the system.
Microsoft provides a complete prescriptive guide for securing both local and domain admin-
istrator accounts in the white paper The Administrator Accounts Security Planning Guide, which
can be found at www.microsoft.com/technet/security/topics/serversecurity/administratorac-
counts/default.mspx.
Security Conﬁguration Using 
the Microsoft Management Console
The vast majority of security conﬁguration is done via the Microsoft Management Console
(MMC).Therefore, you should become familiar with this tool.You can access the console by
navigating to Start | Programs | Administrative Tools.All the listed utilities such as
Services are actually MMC snap-ins.
The MMC will show you a two-pane view.The left pane allows you to highlight a
given snap-in, whereas the right pane shows you the details for the active snap-in. In the case
of the Services snap-in, the left pane will contain only “Service (Local).”
To customize the MMC, go to Start | Run, type mmc, and click OK.This will open
the full MMC.The ﬁrst time you open it, the MMC will have no snap-ins loaded. For
example, to load the Services snap-in, you would open the console and click Console |
Add/Remove Snap-in; then, in the Add/Remove Snap-in window, click the Add
button. In the Add Standalone Snap-in window, select the desired snap-in—in this case,
Services—and click the Add button. Leave the default selection of Local Computer and
click Finish.You can then close the Add Standalone Snap-in window by clicking Close.
Click OK in the Add/Remove snap-in window.This process can be repeated to add
multiple snap-ins to your MMC console.
www.syngress.com
628
Chapter 13 • Windows Bastion Hosts

Figure 13.7 Add Standalone Snap-in Screen
You will need to conﬁgure several security settings on your bastion host.These settings
will control security options such as login restrictions, warning banners, and much more.You
could conﬁgure all these settings by navigating and editing the registry directly, but a much
simpler and safer method is to use the MMC.You can access and conﬁgure each setting indi-
vidually by navigating through the MMC snap-ins separately, or you can conﬁgure and apply
settings via one of the pregenerated security templates.The security templates simplify the
hardening process by bringing conﬁguration options from many different locations together
using a single consistent interface (under a single snap-in).
You can open the Security Templates snap-in by adding it as you did the Services snap-
in, choosing the Security Templates and the Security Conﬁguration and Analysis
snap-ins.The Security Templates snap-in will expand to show all the preconﬁgured tem-
plates.You can use this snap-in to edit these templates directly, or a better option is to right-
click the template you want to start with, select Save As, and choose a name that is
meaningful to you.This approach allows you to create security templates speciﬁc to your
business needs and leaves the default templates intact.
Next you can import your template. Start by creating a new security conﬁguration
database by right-clicking the Security Conﬁguration and Analysis snap-in and selecting
Open Database. Choose a name ending in .sdb and click Open.Then select the Security
Conﬁguration and Analysis snap-in again, right-click and select Import Template, and
choose one of the predeﬁned templates or the one you previously saved. Hisecdc.inf, one of
the more secure templates, is considered to be baseline security settings for a “high-security”
domain controller. Once this is done, you need to right-click again, select Analyze
Computer Now, and click OK for the log path, which reveals several expandable items
under Security Conﬁguration and Analysis.This places all the security-related settings in one
location for easy access and management.
www.syngress.com
Windows Bastion Hosts • Chapter 13
629

Account Lockout Policy
The Account Lockout Policy (Security Conﬁguration and Analysis | Account Policies |
Account Lockout Policy) allows you to conﬁgure the number of incorrect passwords that a
user can enter before they’re locked out of an account, how long the account stays locked
out, and how long to reset the lockout counter.The following recommended settings will
provide the most security an in average environment:
■
Account lockout duration Represents how long the account will stay locked
out. Setting this to zero means that the account will stay locked out until it’s man-
ually unlocked by an administrator.This is the most secure option, though even
allowing the account to reset after as little as 10 minutes will slow down a hacker
who is attempting to brute-force the password.
■
Account lockout threshold Represents the number of invalid passwords that
can be attempted before the user is locked out of the account.A setting of three
invalid logon attempts is usually considered adequate. If the number is too low, a
simple typo could result in an account being locked out. If the number is set to 0
(insecure), the account will never be locked out.
■
Reset account lockout counter after Determines how much time will pass
before the counter is reset.The default setting of 30 minutes is usually adequate.A
longer setting is considered more secure.
The Account Lockout Policy setting and MMC console are depicted in Figure 13.8.
Figure 13.8 Account Lockout Policy
www.syngress.com
630
Chapter 13 • Windows Bastion Hosts

Audit Policy
The Audit Policy (Security Conﬁguration and Analysis | Local Policies | Audit Policy) set-
tings can be very important for a bastion host.Your audit logs can alert you to unauthorized
activity before the system is compromised and after the fact can help you determine the
series of events that might have led up to a successful compromise.You can review
Microsoft’s recommendations for securing Windows 2000/2003, including auditing settings,
at www.microsoft.com/technet/security/prodtech/windows2000/secwin2k/default.mspx.
The most signiﬁcant audit options are outlined here, along with some recommendations
for the most secure settings.Auditing can have a signiﬁcant impact on server performance.
You must carefully weigh the beneﬁts of having the audit trail versus the resources that will
be consumed by enabling various audit options.
■
Audit account logon events Set this to No Auditing.There is a subtle yet
important difference between “audit account logon events” and “audit logon
events.”The account logon events occur only when a local account is used to log
onto another computer. Because this is a standalone server acting as a bastion host,
this event should never be triggered and is primarily useful for domain controllers.
■
Audit account management Keep this set to Success, Failure, which tracks
when passwords are changed, accounts are created and deleted, and group mem-
bership changes.The audit records generated by this setting should be closely
monitored for signs of unauthorized activity that can indicate a system compro-
mise.
■
Audit directory service access Set to No Auditing since this is used to audit
Active Directory (AD) activities. Because the most secure conﬁguration for the
bastion host is as a standalone server, the bastion host should never be exposed to
any of these audit events.
■
Audit logon events Set to Success, Failure.This is the single most important
audit item.These audit events will let you know who and when someone is trying
to log on, and perhaps even more important, whether they are succeeding.This
setting will provide glaring evidence of brute-force logon attempts and hopefully
give you a jump start on investigating the source and taking corrective action.
■
Audit object access Keep at Success, Failure.This is another important audit
setting. It will record access to objects such as printers, registry keys, folders, or
individual ﬁles. Basically, it will audit anything with a system access control list
(SACL) deﬁned.This is explained in more detail later, in the “Registry and File
System ACLs” section of this chapter.
■
Audit policy change Keep at Success, Failure.This will trigger when
someone modiﬁes (or attempts to modify) your policies.An attacker who has suc-
cessfully compromised a system may attempt to alter the system policy to give
himself more freedom over the compromised system.
www.syngress.com
Windows Bastion Hosts • Chapter 13
631

■
Audit privilege use According to Microsoft, this setting will “Audit each
instance of a user exercising a user right.”This might sound handy at ﬁrst, but in
reality it often generates far too much data to be useful. If your environment justi-
ﬁes enabling auditing on these events, setting this option to only audit failures will
usually sufﬁce. Most often this option set to No auditing on production systems
and only enabled for special troubleshooting activities.
■
Audit process tracking Similar to “privilege use,” this setting can generate a
large amount of data and can have a signiﬁcant impact on performance. In most
cases, you should set it to No auditing unless you’re diagnosing speciﬁc problems.
■
Audit system events Keep at Success, Failure.This setting only triggers for
events that affect the entire system, such as system start and shutdown, or for
events that affect the system security or security log.
User Rights Assignment
The list of conﬁgurable events under User Rights Assignments is extensive.These settings
(Security Conﬁguration and Analysis | Local Policies | User Rights Assignment) allow you
to conﬁgure what users (including the accounts that processes run as) can do. Rather than
elaborate on all the speciﬁc settings in this category, we will examine only the most signiﬁ-
cant conﬁgurable events and make recommendations for the most secure settings for the
majority of environments:
■
Access this computer from the network You can safely set this option to
Authenticated Users and remove all other access.You should make certain that
“Anonymous Logon” is not in the allowed list. Users accessing this bastion host as
a Web server will still have access as part of the IIS conﬁguration.
■
Act as part of the operating system No accounts should need this privilege. It
allows a user to impersonate any other user on the system without authentication.
This would pose a huge security risk and render your other auditing events mean-
ingless. If an application needs this type of access to function properly, it should use
the LocalSystem account, which includes this access by default.
■
Bypass traverse checking This setting allows a user to navigate through direc-
tory trees, even if the user does not have access to a directory. It does not allow the
user to list the contents of a directory to which he or she does not have the
appropriate rights.This option should be set to administrators only.
■
Change the system time Setting the time might not seem important at ﬁrst
glance, but it can be a huge security hole. If the time is set incorrectly, certain
encryption systems such as IPSec will fail. Further, it becomes impossible to accu-
rately correlate event logs, and critical transactions could fail, causing a denial of
service for legitimate trafﬁc.This setting should be set to administrators only.
www.syngress.com
632
Chapter 13 • Windows Bastion Hosts

■
Create token object This setting allows an account to create a token that can
then be used to gain access to any system resource.This right should not need to
be set manually on any account. If it is needed, it should be assigned to the local-
system account.
■
Debug programs This right will allow a user to attach a debugger to a process,
which in turn will allow the user to access many sensitive internal resources.This
right should be assigned with great care and usually shouldn’t be needed on a pro-
duction host.
■
Deny access to this computer from the network This right should include
the local administrator account.There is no legitimate need for the local account
to access the system over the network.
■
Deny logon as batch job, Deny logon as service  Both of these rights should
be set to the local administrator. By doing this, you ensure that if the local
administrator account is compromised, the attacker will not be able to immediately
install a service or batch job to further compromise system security.
Security Options
The Security Options group is also extensive (Security Conﬁguration and Analysis | Local
Policies | Security Options) and offers important security settings that impact the entire
system instead of individual accounts. Many of these settings are discussed in the Microsoft
security guide at www.microsoft.com/technet/security/prodtech/windows2000/
w2kccscg/default.mspx.The following are the most important settings to conﬁgure:
■
Do not display last user name in logon screen  This option should be set to
enabled. By displaying the last user to log on, you are giving any attacker who can
get to that logon screen a ﬁrst clue as to a viable account name to attack.
■
Message text for users attempting to log on This message will be seen when
someone attempts to log onto the console directly.This setting gives some legal
protection against unauthorized access. Fill this in with a message stating that only
authorized users should be accessing the system.Your legal department will likely
already have the speciﬁc wording clearly deﬁned; essentially, it serves to negate an
attacker’s claim that they didn’t know they were doing anything wrong.
■
Message title for users attempting to log on This is the title for the pre-
ceding message. Something suitably ominous such as “Warning” or
“Authorized Users Only” should be adequate. Consult your legal department
to be safe.
■
Number of previous logons to cache (in case domain controller is not
available) Because this is a standalone server, there should be no credentials to
cache, so this option can be set to zero (which disables caching). Even if you are
using domain authentication on your bastion host, the most secure setting is zero.
www.syngress.com
Windows Bastion Hosts • Chapter 13
633

■
Rename administrator account As mentioned earlier, the local administrator
account is the most popular user account for attack. Changing this account name to
something other than the default can help prevent the success of some automated
attacks, such as an automated password-cracking attack against the local adminis-
trator account.You should avoid any obvious alternatives such as Admin or root.
■
Rename guest account For the same reasons as the administrator account, this
option should be selected as well.The guest account has few privileges, but it can
still provide a local logon account and act as a ﬁrst step toward elevating an
attacker’s privileges. Code Red, for example, adds Guest to the local Administrators
group. Since this account name is mentioned speciﬁcally in Code Red’s payload,
merely renaming this account would prevent such a group membership modiﬁca-
tion from succeeding.
Event Log
Event log settings are designed to control how the event logs behave. Most of the settings are
fairly self-explanatory and the ramiﬁcations of their conﬁguration obvious.The only setting
here that deserves special attention is the Shut down the computer when the security
audit log is full option.You have to be very careful using this setting. If you set it to
enable, when the security log reaches the size limit you specify, the system will shut down.
Although this action prevents a user from getting away with activities that are not logged
when the log is full, it can also be used to cause a DoS attack.
You should also conﬁgure some means of exporting the logs off the bastion host and into
some central repository.This serves several purposes. For one, it keeps the logs safe, so if an
attacker does manage to take control of the bastion host, he could delete the logs to cover his
tracks, but he would not be able to delete the logs that have been exported and recorded
remotely. Second, exporting the logs allows you to inspect the logs at a central location instead
of trying to view all the event logs across your system.A centralized logging system is the only
practical way to attempt any kind of event correlation, whereby events that might not be sig-
niﬁcant independently could indicate something signiﬁcant when viewed in context.
The problem with this, of course, is that Windows servers lack any built-in method for
exporting the logs.You can view the logs on a remote system using the Event Viewer, but
this is not a practical way to inspect the logs of all your systems or even all your bastion
hosts.The number of logs that will be generated will often be so great as to make manual
inspection impractical or impossible.There are third-party products that will help you in this
regard. Some will inspect and ﬁlter the logs on the host system, using an agent, and then
send the ones that are deemed important to the central console. Others will export every-
thing from the host to a central console and allow the console to determine what is note-
worthy.You can ﬁnd products to do this in both the native Windows logging format and, as
is more common, Syslog format. Microsoft does provide some command-line tools that can
allow some ﬂexibility, but they cannot replace the features and ease of use of a dedicated
product.
www.syngress.com
634
Chapter 13 • Windows Bastion Hosts

The following list highlights some of the Microsoft tools for manipulating event logs:
■
Logevent.exe (Windows 2000 Resource Kit)  Allows you to create an event
you specify in the event log you specify.
■
Eventlog.pl (Windows 2000 Resource Kit, supplement 1) Allows you to
back up event logs, export event lists to text ﬁles, clear event logs, and query prop-
erties of event logs.
■
Eventquery.pl (Windows 2000 Resource Kit, supplement 1) Allows you to
display and ﬁlter event logs based on many ﬁelds such as time, date, source, cate-
gory, and ID.
■
Eventcreate.exe (Windows 2003/XP) Allows you to create an event you
specify in the event log you specify.
■
Eventquery.vbs (Windows 2003/XP) Allows you to ﬁlter and list events of a
local or remote machine.
■
Eventtriggers.exe (Windows 2003/XP)  Allows you to conﬁgure a process to
be executed when certain events are logged.
Restricted Groups
The Restricted Groups Policies allow you to specify who can be members of local groups.
The obvious use of this feature is to restrict the accounts that could be members of the local
administrators group.To edit the settings, simply select Restricted Groups in the left MMC
pane and double-click the group you would like to edit in the right MMC pane (see Figure
13.9). Check Deﬁne this group in the database and then choose the desired user
account to be permitted in the group you are editing. Click Apply and OK when you’re
ﬁnished.The local administrator account will always have administrative access, regardless of
what you deﬁne here.
WARNING
If you apply this policy setting, both inclusion and exclusion are enforced. This
means that if you apply this policy setting and an account you want to be in
the administrators group is not listed, it will not be allowed. Basically, using this
policy setting means that you are statically deﬁning the members of the group
in question.
www.syngress.com
Windows Bastion Hosts • Chapter 13
635

Figure 13.9 Restricted Groups
System Services
Most Windows systems installed with the default settings include a large number of services
that are conﬁgured to run automatically. In addition, these services usually operate with ele-
vated privileges such as localsystem. In an effort to minimize the number of services that can
be attacked, you should disable any services that are not needed. Unfortunately, determining
which ones are needed can often be difﬁcult.You’ll ﬁnd a list of services and their purposes
for Windows 2000 at
www.microsoft.com/technet/prodtechnol/windows2000serv/deploy/prodspecs/win2ksvc.ms
px.You’ll ﬁnd a similar listing for Windows 2003/XP at
www.microsoft.com/technet/prodtechnol/windowsserver2003/technologies/management/s
vrxpser_7.mspx.These lists will hopefully provide a solid foundation from which to research
the services that are essential to your particular environment.
When you select System Services in the left MMC pane, you will see a list of all the
services on the machine in the right pane, as shown in Figure 13.10. For any given service,
you can double-click the service name and edit the policy settings.The Analyzed Security
Policy Setting window is shown in Figure 13.11. Once you choose to enable the policy
for a speciﬁc service by checking Deﬁne this policy in this database, you can choose the
state the service should be in (Automatic, Manual, or Disabled) by default. By clicking Edit
Security, you can apply more granular controls over who can start or stop the service.
The Database Security window is shown in Figure 13.12. For services not needed on
the bastion host, set the services to Disabled and ensure that only the local administrator
account has full control.You can allow authenticated users to read, start, stop, and pause the
services if you think it’s needed. When you’re ﬁnished, click OK twice.
www.syngress.com
636
Chapter 13 • Windows Bastion Hosts

Figure 13.10 Services Policy
Figure 13.11 Service Security Policy Setting
Figure 13.12 Services Security Policy
Windows Bastion Hosts • Chapter 13
637
www.syngress.com

Microsoft has several guides that provide lists of suggested services that are needed
depending on the role of the host system. For example,Table 4.11 of The Microsoft Windows
2000 Security Hardening Guide lists 46 services as the “minimum required.” Of course, situa-
tions vary, but it provides a place to start your research and ﬁne tuning.You can also ﬁnd a
variety of guides on the Web for disabling unneeded services.The key consideration for dis-
abling unneeded services is to thoroughly test in a lab environment any applications that the
bastion host will be running before you deploy the hardened policies to a production host.
Registry and File System ACLs
The Registry and File System settings allow you to conﬁgure speciﬁc access control lists
(ACLs) on individual ﬁles, folders, or parts of the registry.These are the same permissions
you could set by using the registry editor or the Security tab in the ﬁle properties. With
some ﬁles, especially executables, you might ﬁnd it advantageous to conﬁgure the ACL to
deny the Everyone group access to those ﬁles. For other ﬁles, you might simply want to have
a higher degree of auditing on their use.
To enable auditing on speciﬁc ﬁles, follow these steps;
1.
In the left pane, navigate to the directory containing the ﬁle you want to audit. In
this example we’ll use cmd.exe, located in C:\winNT\system32\.
2.
Locate cmd.exe in the right pane and double-click the ﬁle.
3.
Click Edit Security.
4.
Conﬁgure the access settings for the ﬁle.
5.
Click Advanced.
6.
Select the Auditing tab at the top of the Access Control Settings for CMD.EXE
window.
7.
Click Add.
8.
Select the group you want to audit access to CMD.EXE and click OK.
9.
Place a check mark next to any events you want to audit—for example, Traverse
Folder/Execute File.
10.
Click OK four times to close all the windows.
Once you have conﬁgured all your policy settings to your satisfaction, you still need to
apply those settings and save the template.
Applying the High-Security Policy
You can save your template by right-clicking Security Conﬁguration and Analysis and
selecting Save.This action does not apply the settings contained in the template; it only saves
the template for future editing.To apply the settings, right-click Security Conﬁguration and
Analysis and select Conﬁgure Computer Now.You will be asked to verify the error log
www.syngress.com
638
Chapter 13 • Windows Bastion Hosts

path.You may choose to provide a custom path and name or simply click OK. It is highly rec-
ommended that you choose a log ﬁlename that is meaningful to you, such as New Password
Policy.log. Once the template has been applied to the system, you may begin testing the changes
to make sure everything works properly. In the example, we conﬁgured auditing for execution
of CMD.EXE.A screenshot of the generated log event is shown in Figure 13.13.
TIP
Many of the policy settings will take effect immediately, but some will take
effect only after the system is rebooted. For this reason, is it recommended that
you immediately reboot after making policy changes.
Figure 13.13 File Execution Auditing
Conﬁgure Automatic Time Synchronization
Accurate system time is important to proper functioning of your bastion host.Without an
accurate time setting, any logging will have unreliable time stamps.This will make any post
mortem forensics difﬁcult or impossible. Further, SSL and IPSec, two very common protocols
found on bastion hosts, will fail if the system time is incorrect by a large enough margin. For
this reason, you should have a way of securely maintaining an accurate system clock.
Plenty of third-party programs can use the Network Time Protocol (NTP) to keep the
system time synchronized, but you can also do it with built-in tools.To use the Windows
built-in time synchronization, you need to be running the Windows Time Service on the
bastion host. When the Windows 2000 bastion host is a standalone server, this service is not
conﬁgured to start automatically by default.You’ll ﬁnd an excellent article on Windows 2000
www.syngress.com
Windows Bastion Hosts • Chapter 13
639

time settings at www.microsoft.com/technet/prodtechnol/Windows2000Pro/
maintain/w2kmngd/16_2kwts.mspx.The corresponding article for Windows 2003 can be
found at www.microsoft.com/technet/prodtechnol/windowsserver2003/technologies/secu-
rity/ws03mngd/26_s3wts.mspx. It’s worth pointing out that synchronizing your time via
SNTP or NTP inside your DMZ is not advisable unless you also take steps to secure the
protocol. Different versions of NTP provide different levels of security, as follows:
■
NTPv1 No security features
■
NTPv2 Restrictions based on IP address, NTP trafﬁc is unencrypted
■
NTPv3 Symmetric key encryption and authentication
■
NTPv4 Both symmetric encryption and PKI encryption
At the very least, you should conﬁgure the bastion host’s time synchronization mecha-
nism not to synchronize based on NTP broadcasts.This would allow an attacker to simply
broadcast false time updates to your bastion host. If your available time synchronization soft-
ware does not provide the level of security you need, you can conﬁgure your NTP trafﬁc to
use an encrypted IPSec tunnel to communicate with the time server.
Server and Domain Isolation
The recommended conﬁguration for a bastion host is that it be a standalone server.
However, sometimes you can’t conﬁgure things in the most secure way. Sometimes business
drivers and requirements require technical staff to make compromises on security. In the
event that you must implement your bastion host as a member of a domain, you can and
should take steps to provide as much isolation and protection as possible between the bastion
host and the domain controllers. One method to do this is through server and domain isola-
tion. What follows is a brief overview of how server isolation and domain isolation work and
some of the pitfalls to be aware of when implementing them. For a detailed overview of
Microsoft’s server and domain isolation methodology, see the TechNet website at
www.microsoft.com/sdisolation.
What Is Server and Domain Isolation?
In a nutshell, server and domain isolation are conﬁgurations whereby you can restrict
TCP/IP communications between trusted computers.You use Active Directory and Group
Policy to conﬁgure the permitted communications on the systems in question.This is
accomplished by establishing policy-enforced IPSec tunnels between isolated systems.They
are conﬁgured in such a way that the isolated systems can communicate with each other and
with other systems (even those not considered isolated), whereas systems that are not isolated
cannot initiate communications with the isolated systems. In this way you create a virtual
network that can act independently of the underlying topology.These methods are applicable
to Microsoft Windows XP, Microsoft Windows Server 2003, and Microsoft Windows 2000
Server (SP4 or later).
www.syngress.com
640
Chapter 13 • Windows Bastion Hosts

Domain isolation is accomplished by conﬁguring domain member computers to accept
only authenticated and secured communications from other domain member computers
based on group policy settings.This conﬁguration does not inhibit the domain computers
from communicating to nondomain computers.As with many ﬁrewalls, by default the trafﬁc
is restricted inbound only; outbound communications are unhindered. Server isolation works
the same way in that you conﬁgure the domain member server to accept only connections
from other domain member computers, or if desired, only other domain member computers
that are members of speciﬁc Active Directory security groups.The latter variation is called
group-speciﬁc server isolation. Essentially, server isolation is IPSec policies deﬁned via Group
Policy Objects (GPOs).An excellent introductory paper can be downloaded from Microsoft
here: www.microsoft.com/technet/itsolutions/network/sdiso/default.mspx.
How to Conﬁgure Server and Domain Isolation
The ﬁrst step is to take an inventory of the network.You will need to evaluate several things,
including what OS your systems are running, their logical communication requirements, and
their positions in the Active Directory (AD) hierarchy.All these things will impact whether
you can implement server and domain isolation as well as how it will be conﬁgured.
Performing a Host Assessment
Microsoft uses the terms trustworthy and untrustworthy to describe the functionality of the var-
ious operating systems within the scope of server and domain isolation (SDI). If the oper-
ating system is capable of natively supporting IPSec, belongs to an IPSec domain (AD), and
can process the GPOs, it is considered trustworthy. Everything else is “untrustworthy” and
will not be able to be included in an isolation group.These untrusted systems include OSs
such as Windows 95, Windows 98, Windows ME, Windows NT, non-Microsoft OSs, or any
machine regardless of its operating system that is not a member of a domain.
You will also need to verify domain membership for any hosts to include in an isolation
group.As part of this veriﬁcation, you should test that GPOs are being processed correctly
by the host in question.The success or failure to process GPOs may be obvious during the
day-to-day workload, but any systems that have issues will need to be corrected prior to
implementing isolation. Otherwise, when you implement SDI, you could ﬁnd that your sys-
tems cannot communicate properly.
Performing an Active Directory Assessment
The next step is to analyze your Active Directory structure.You will need to establish trusts
between forests if you want hosts on different forests to be in the same isolation group.
Domains will need to have trust relationships to properly manage IKE authentication.Your
Organizational Unit (OU) structure will also impact implementation of isolation groups,
since isolation groups are enforced via GPOs.This also impacts your planning, because GPOs
are applied in order.The GPO deﬁning the IPSec policy that is closest to the computer in
the Active Directory domain structure will be used. Implementing SDI in a complex envi-
ronment is not a trivial task.
www.syngress.com
Windows Bastion Hosts • Chapter 13
641

Implementing Isolation Groups
Now that you know which hosts you are working with, you will need to determine group
membership for these hosts. Communications between isolation groups can basically be
broken down into the following categories;
■
Primary isolation domains These are the bulk of the systems that will com-
municate securely with each other on a regular basis.
■
Untrusted systems These are systems that are untrusted according to the pre-
vious guidelines.
■
Boundary isolation These are systems that will be allowed to communicate
with both trusted systems and untrusted systems. Conceptually, these systems are
similar to systems found in a traditional network DMZ.
■
Exemption lists These are untrusted systems that you want to allow trusted sys-
tems to communicate with, contrary to policy. Good examples here could be DNS
servers or DHCP servers. With Windows 2000, these types of servers (infrastruc-
ture systems) must be on the exemption list; with Windows 2003, these servers can
be included in the isolation domain.
You will need to deﬁne some groups that will be used to apply policy. Microsoft recom-
mends separate groups for user accounts and computer accounts. By applying an isolation
policy to a computer account that hosts an accounting application, you can ensure that isola-
tion is enforced regardless of who logs into that machine. Similarly, by applying the isolation
policies to a user account, you can require that users with administrative access use secured
communications. Deﬁning separate groups for user accounts and computer accounts allows
you this level of ﬂexibility in applying isolation policies.Although a given machine should
not belong to more than one group, your users may well belong to multiple groups.
Creating the actual policies consists of three basic steps:
1.
Create ﬁlter lists.
2.
Create ﬁlter actions.
3.
Create the IPSec policies.
Filter lists are basically access control lists that specify what trafﬁc will need an action applied
to it.You can deﬁne this trafﬁc based on source or destination IP address, by protocol, or by
TCP or UDP port numbers. Filter actions deﬁne how an IP packet is handled when it
matches a ﬁlter list. Each ﬁlter action can have one of three security methods applied to it:
Block, Permit, or Negotiate.The Block and Permit methods are self-explanatory.The
Negotiate action will attempt to apply any of a series of security and cryptographic options
in order of preference.You will also be able to set additional options on the policies to con-
trol the way a host responds to unencrypted trafﬁc.
www.syngress.com
642
Chapter 13 • Windows Bastion Hosts

The IPSec policies also need to be deﬁned via AD group policy.This is accomplished by
deﬁning the authentication methods used to establish trust between computers, the connec-
tion type, and whether or not the speciﬁc rule utilizes a tunnel conﬁguration.The complete
details for conﬁguring these settings, as well as an in-depth explanation of the IPSec pro-
tocol, are beyond the scope of this book.You can ﬁnd more information about Microsoft’s
IPSec support at www.microsoft.com/windowsserver2003/technologies/
networking/ipsec/default.mspx. Conﬁgure these settings via the IPSec Security Policy
Management snap-in.
WARNING
Windows 2000 hosts support a limited number of IPSec policy types (three, to
be exact). Windows 2003 or Windows XP systems support ﬁve additional policy
types. If you need to apply policies to Windows 2000 hosts as part of your isola-
tion groups, you should limit yourself to using only the three policy types that
Windows 2000 supports (Local Policy, Active Directory Domain Policy, and
Dynamic Policy).
The next step is the development of a deployment strategy. It is considered a best prac-
tice not to apply the policies to every system simultaneously. Create the appropriate GPOs
for the IPSec policy, but remove the Apply right from the Authenticated Users group.
Next conﬁgure the policies and assign them to GPOs.At this point, the new policies have
not been distributed. Finally, place the computers to be included in the server and domain
isolation design within the appropriate computer groups in the Group Policy.These systems
will have read access to the GPOs.This approach provides control over when certain systems
receive the new policy.
Despite the prospect of secured communications between hosts in isolation groups and
the ability to enforce encryption at the host level, there are valid reasons to decide not to
implement isolation groups.All the systems in the isolation groups will be doing additional
authentication and possibly encryption, which will place additional strain on the processor,
especially for high-throughput hosts.Although there are ways to mitigate the encryption
overhead (such as NICs with integrated encryption chips), you should be aware of this
potential issue. IPSec can also cause some protocols to fail. Notably the use of IKE via NAT
can require the installation of patches on the OS.There are also some applications that
simply don’t work with IPSec due to the way they are written (such as including IP address
in the data portion of the packet). IPSec is particularly problematic with hosts that are being
load balanced. Finally, encrypted trafﬁc between hosts will, by deﬁnition, prevent other
devices from seeing the raw trafﬁc.This will render ineffective many network inspection
devices such as quality-of-service (QoS) devices, sniffers, and other troubleshooting tools.
www.syngress.com
Windows Bastion Hosts • Chapter 13
643

As you can see, there are a host of potential hurdles to overcome in implementing isola-
tion groups. Due to the SDI’s complexity, extensive testing in a controlled lab should be a
requirement before attempting changes on production systems.You need to develop a solid
understanding of the underlying technologies and their implementation before applying that
knowledge to your production network.Although isolation groups offer powerful function-
ality, it requires planning and caution to realize the beneﬁts.
Remote Administration
The Remote Desktop Protocol (RDP) is the underlying protocol used to send screen
images and other data across a Terminal Services session. It is worth noting that a Terminal
Services session can be an entirely new session, meaning that you will not be able to interact
with an existing, logged-on [user, or it can be a ]session that can be shared with other users.
The latter is far more common because it allows the support staff to see what the end user is
seeing and more effectively diagnose the problem.
Using Terminal Services for 
Remote Administration (Windows 2000)
Terminal Services is the remote administration tool included in Windows 2000 Server,
Windows XP, and Windows 2003. Because it allows you to act as though you were logged
into the system directly,Terminal Services allows you to take full advantage of all the GUI
applications for your administrative tasks.The Remote Desktop Protocol (RDP) is the
underlying protocol used to send screen images and other data across a Terminal Services
session. It is worth noting that a Terminal Services session can be an entirely new session,
meaning that you will not be able to interact with an existing, logged-on user or a session
that can be shared with other users.The latter is far more common because it allows the
support staff to see what the end user is seeing and more effectively diagnose the problem.
Installing Terminal Services
On a Windows 2000 Server, follow these steps to install Terminal Services:
1.
Log on as an administrator.
2.
Go to the Control Panel and open the Add /Remove Programs tool.
3.
Click Add/Remove Windows Components.
4.
In the Windows Components dialog box, check Terminal Services.
www.syngress.com
644
Chapter 13 • Windows Bastion Hosts

5.
If this machine is a standalone machine and you plan to publish applications from
this terminal server, select the Terminal Services Licensing check box and click
Next. If you will be using the Terminal Services functionality for remote adminis-
tration only, you do not need to select this check box.This window is shown in
Figure 13.14.
6.
Choose the mode in which you want to run Terminal Services.There are two
options, Remote Administration Mode or Application Server Mode.Then click
Next, as shown in Figure 13.15.
Figure 13.14 Adding Terminal Services Components
Figure 13.15 Terminal Services Modes
www.syngress.com
Windows Bastion Hosts • Chapter 13
645

Once this process has been completed, you should discover that an additional service
called Terminal Services is running.You will also have several new program shortcuts under
Start | Programs | Administrative Tools.These are used for administrative tasks related to
Terminal Services.
Securely Conﬁguring Terminal Services 
Administrative functions are often not given the attention they warrant when it comes to secu-
rity.Although it is common knowledge that good passwords should be required for all systems
on the network, administrative functions are sometimes performed via insecure methods.The
assumption is that the host was in a relatively secure state before enabling Terminal Services,
and therefore the next task will be to secure the Terminal Services functionality.
One obvious consideration is the level of encryption that will be used.The default
behavior is to use 56-bit keys (Windows 2000) or 128-bit keys (Windows 2003), with the
RC4 cipher to encrypt data ﬂowing in both directions between the Terminal Services server
and client.Although this approach might be adequate for trusted networks, for a bastion host
you would want to increase the encryption strength.You should also change the default
behavior for terminated sessions and some other settings, to be more secure. Follow these
steps to secure Terminal Services settings:
1.
Click Start | Programs | Administrative Tools | Terminal Services
Conﬁguration.
2.
In the left pane of the snap-in window, select Connections.
3.
In the right pane, double-click RDP-Tcp to open the Properties window 
(Figure 13.16).
Figure 13.16 Terminal Services Conﬁguration
4.
On the General tab of the RDP-Tcp Properties window, for Encryption Level,
select High in the drop-down box (Figure 13.17).This choice will increase the
size of the encryption key used, but it will not change the encryption algorithm.
www.syngress.com
646
Chapter 13 • Windows Bastion Hosts

Figure 13.17 RDP-Tcp Properties: General Tab
5.
On the Sessions tab, check the box next to Override user settings, and set it to
end a disconnected session after 1 minute.
6.
Set the Idle session limit to something appropriate to your IT security policy,
typically 10 minutes or so.
7.
Check the box next to Override user settings and set it to End session when
session limit is reached or connection is broken (Figure 13.18).
Figure 13.18 RDP-Tcp Properties: Sessions Tab
www.syngress.com
Windows Bastion Hosts • Chapter 13
647

8.
On the Client Settings tab in the Connection Section, uncheck Use connec-
tion settings from user settings, Connect client printers at logon, and
Default to main client printer.
9.
Under Disable the following, select all available check boxes (Figure 13.19).
Figure 13.19 RDP-Tcp Properties: Client Settings Tab
Remember, these settings represent the most secure conﬁguration.You may have valid
business justiﬁcation to enable some of these. Just remember to take a minimalist approach
and enable only what you need. In most cases, optional functionality such as remote printer
redirection is not critical to performing the desired administrative tasks.
You also must evaluate weather the remote connection should be exposed to the
Internet. Ideally, your administrative access can be granted only from internal IP ranges. If
the administrator is not on the local LAN, he or she should be able to access the bastion host
after being authenticated through some form of VPN and then connect to the bastion host.
If you must expose Terminal Services to the Internet in general, it might be wise to change
the TCP port that the terminal server is listening on for client connections. Generally
speaking, hackers will recognize the default port of 3389 right away. Knowing this, they
might spend a lot of effort trying to gain access to such a system. Changing the listening
port doesn’t make the service any more secure per se, but it might make it a little less of a
target. If you set it to another well-known port, the attacker could assume that the listening
service is the one commonly associated with that port and decide it’s not worth attacking.
This type of approach is usually referred to as security through obscurity. Some common exam-
ples are port 53 for DNS or port 22 for SSH.
Microsoft ofﬁcially does not recommend changing the RDP port number, but it is rela-
tively easy to do.To change the default port, you will need to follow a couple steps:
www.syngress.com
648
Chapter 13 • Windows Bastion Hosts

1.
Go to Start | Run and enter REGEDIT.
2.
Navigate to HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\
Control\Terminal Server\WinStations\RDP-Tcp in the left pane.
3.
In the right pane, double click PortNumber.
4.
Enter the new number you want to use (make sure you change it to decimal
entry) and click OK.
You will then need to stop and start the Terminal Services service or reboot the machine for
the changes to take effect.This process is covered in the Microsoft Knowledgebase article
187623.You will also need to change the port for the RDP client. Do this by exporting the
connection information in the Connection Manager and editing the ﬁle with a plain text
editor such as Notepad.exe.The entry for ServerPort should be changed to match the
newly conﬁgured port; then reimport the ﬁle. If the client is Windows XP, you can simply
specify the IP and port number at the Remote Desktop Connection window in the format
<IP>:<port>.
NOTE
For further reading on RDP, you can ﬁnd an in-depth article covering the most
current version (RDP V5) on Microsoft’s site: www.microsoft.com/win-
dows2000/techinfo/howitworks/terminal/rdpfandp.asp. 
Using RDP for Remote 
Administration (Windows 2003)
For Windows Server 2003, the task of remote administration is made simpler. RDP is
installed by default, so all you need to do to enable remote administration is enable RDP
and specify the users who are allowed to connect.The procedure to do this is outlined here:
1.
Navigate to Start | Control Panel | System.
2.
Select the Remote tab.
3.
In the Remote Desktop section, check Enable remote desktop on this
computer.
4.
Click the Select Remote Users button and click Add.
5.
Add any user accounts you desire to have remote desktop access.
6.
Click OK three times to conﬁrm your choices and ﬁnalize the changes.
www.syngress.com
Windows Bastion Hosts • Chapter 13
649

Once RDP is enabled, the process for hardening the sessions is performed in the same
manner as it is for Windows 2000, via Start | Administrative Tools | Terminal
Services Conﬁguration.
Bastion Host File Replication
As part of normal administrative tasks, it might be necessary to transfer ﬁles to and from the
bastion host on occasion.The challenge in accomplishing this task is to do it in a secure
manner with adequate authentication and encryption for the data being transferred. One
method is to use the encryption for the Terminal Services session. If the Terminal Server is
running Windows 2000 Server, it only supports client drive mappings via a Citrix ITA-based
client, and those check boxes will be disabled automatically.You can get similar functionality
through the RDPclip utility from Microsoft. It can be downloaded from
ftp.microsoft.com/reskit/win2000/rdpclip.zip. Once you have downloaded it, simply decom-
press and run the included FXFRINST.bat on both the client and the Terminal Services server
to install.This will allow you to share a common clipboard between the client and server.
Another alternative would be to enable FTP via an encrypted tunnel such as IPSec or
SSL. Because standard FTP transfers all usernames, passwords, and data unencrypted, it should
be avoided on the bastion hosts at all costs.This might be overkill for a functionality that will
likely be infrequently used.The Secure Shell (SSH) often comes with a tool for secure ﬁle
copy (SCP), which might be simpler to install and conﬁgure securely than an FTP server.
SSH is discussed in more detail in the next section.
Command-Line Administration
If you can accomplish your administrative tasks on the command line without the beneﬁt of
a GUI, some additional options are available to you.Although Telnet is not encrypted, you
can use IPSec to encrypt your Telnet session.This can be done via policies, in the same
manner as conﬁguring server isolation.
Another, more common method is via secure shell (SSH). SSH requires both an SSH
client and an SSH server component. SSH is the industry standard for remote command-line
access, and most systems come with it as part of the default install. Windows systems, how-
ever, are one among the few that do not.A variety of products, both commercial and free, is
available to bring SSH functionality to Windows. One of the better-known commercial SSH
clients is SecureCRT (www.vandyke.com). Most of the free versions are based on the
OpenSSH (www.openssh.com) package, including a version for windows called PuTTY.
Cygwin (www.cygwin.com) is a port of many UNIX tools for Windows, and it includes an
SSH server.To add even more options, SSHWindows is a free package that installs only the
minimum components of the Cygwin package to use SSH, SCP, and SFTP. Let’s walk
through setting up SSHWindows:
1.
Download SSHWindows from sshwindows.sourceforge.net on the client 
and server.
www.syngress.com
650
Chapter 13 • Windows Bastion Hosts

2.
Unzip the ﬁle, run the setup utility, and click Finish.
3.
Under the directory where you installed OpenSSH for Windows, you must edit
the \etc\passwd ﬁle.
4.
If desired, create a separate group on the bastion host to hold users who will have
access to SSH, and add the local user account of your admins.
5.
Go to a command prompt, cd to the directory where you installed OpenSSH, and
cd to the subdirectory \bin.
6.
Enter the following command on the server to specify the groups that can connect
via SSH: mkgroup –l >> ..\etc\group.This command will give all local groups
permission to connect via SSH.You should open the group ﬁle and edit out any
groups you do not want to have access.
7.
Enter the following command on the server to specify a single account that is
authorized to connect via SSH: mkpasswd –l –u <accountname> >>
..\etc\passwd.You must perform both these steps for SSH to work.
8.
Edit the Banner.txt ﬁle located in \etc\ to match the banner speciﬁed by your IP
security policy.
At this point you can connect to the remote system and access a command prompt over
an encrypted session. Output from a successful connection is shown here:
I:\OpenSSH\bin>ssh sshuser@192.168.1.101
************ WARNING BANNER HERE ************
sshuser@192.168.1.101's password:
Last login: Sat Jun 24 20:05:22 2006 from 192.168.1.99
Could not chdir to home directory /home/SSH: No such ﬁle or directory
Microsoft Windows 2000 [Version 5.00.2195]
(C) Copyright 1985-2000 Microsoft Corp.
C:\OpenSSH>ipconﬁg
Windows 2000 IP Conﬁguration
Ethernet adapter Local Area Connection:
Connection-speciﬁc DNS Sufﬁx
. : rr.com
IP Address. . . . . . . . . . . . : 192.168.1.101
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 192.168.1.1
www.syngress.com
Windows Bastion Hosts • Chapter 13
651

This is the sample output from sending a ﬁle to the bastion host (192.168.1.101) via
SCP:
I:\Internet\OpenSSH\bin>scp sample.txt sshuser@192.168.1.101:/
************ WARNING BANNER HERE ************
sshuser@192.168.1.101's password:
Could not chdir to home directory /home/SSHuser: No such ﬁle or directory
sample.txt
100% 1735
1.7KB/s
00:00
TIP
Although the SSH port in SSHWindows uses standard CMD.exe syntax, the SCP
command and the SFTP command both use Unix-style paths. Also of note is the
fact that unless it is conﬁgured differently, the SSH connection will assume that
the directory you installed OpenSSH into is the starting root for client 
connections.
Bastion Host Conﬁgurations
At this point in the process of building your bastion host, you have a server that is at least
minimally secure.Your bastion host is probably up to the task of being exposed on the
Internet, but it is lacking one important feature.At this time the bastion host isn’t really con-
ﬁgured to do anything, it’s just a base server build with remote administration enabled. Some
of the most common functions for a bastion host are Web server, mail server, and DNS
server as well as screening gateway. Here we discuss in detail the steps required to get your
bastion host running as a secure Web server or mail server.
Conﬁguring an IIS5 Server for Web Access
Microsoft’s product for providing Web services is Internet Information Services (IIS). With
the tight integration IIS offers with the underlying (Windows) operating system, many
people ﬁnd IIS a compelling choice to use as their Web server. IIS in its default conﬁgura-
tion is not secure, however.The emphasis is on ease of use, not security. With proper plan-
ning and a little effort, IIS can serve as a secure public Web server.
Setting Up an Anonymous Public Web Site
IIS is an integral component of the Windows server platform if it is not installed during the
initial system installation, simply navigate to Start | Settings | Control Panel |
Add/Remove Programs and click Add/Remove Windows Components. Place a
www.syngress.com
652
Chapter 13 • Windows Bastion Hosts

check mark next to Internet Information Services (IIS) or highlight it and select details.
By checking all of IIS, you will likely install some components you might not need.At a
minimum you need Common Files and World Wide Web Server, which will also automati-
cally select the Internet Information Services Snap-in. When you’re ﬁnished with your selec-
tions, click OK and click Next.
Once this is done, you will need to open the IIS snap-in in the MMC console.You can
go to your saved MMC console and add it following the steps you used previously, or navi-
gate to Start | Programs | Administrative Tools | Internet Services Manager. In
the left pane of the MMC, double-click your server name, which will expand the view.Then
highlight Default Web Site.You’ll notice many of the paths use C:\inetpub, which is the
default for IIS. Because this is the default and many automated hacking programs expect the
default setting, we will want to change the default to something else. Follow these steps to
create a new WWW instance in a nondefault location:
1.
Right-click the Default Web Site, and select Stop.
2.
Now remove it entirely by right-clicking again and selecting Delete and then Yes
at the “Are you Sure?” prompt.
3.
Create a new directory to serve as the WWW root, preferably not on the C: drive
if possible.
4.
In the left pane of the MMC, highlight the server name and select New | Web
Site.This will begin the Web Site Creation Wizard.
5.
Click Next, type a description for the Web site, and click Next again.
6.
The next screen is IP Address and Port Settings.Typically, you can leave the
settings on this screen at the defaults and click Next.
7.
Enter the path to the home directory. In this example, create a new directory
called C:\newWWW (or more preferably, D:\newWWW, or whatever drive letter
you like if you have another physical disk in the system) and click Next. Leave
Allow Anonymous Access to this Site checked if you need to allow anyone to
access the site without logging in.
8.
On the Web site Access Permissions page, you will need to leave the defaults
(Read & Run Scripts) checked if you plan on using Active Server Pages (.asp). If
not, you only need to check Read. When you’re done with your selections, click
Next and Finish.
Once this process is completed, the new site has been created. If you were to place an
index ﬁle in the newWWW directory, you could connect to the server and view it via a
Web browser. If you select the new site in the left pane of the MMC, you can see that many
default WWW folders have been created for the new Web site.The next step is to lock
down the conﬁguration so that it cannot be exploited.To be safe, select the site again, and
right-click and select Stop so that the new site is inaccessible. It is now secured.
www.syngress.com
Windows Bastion Hosts • Chapter 13
653

Conﬁguring an IIS6 Server for Web Access
The process for conﬁguring IIS6 is very similar to the one used to conﬁgure IIS5. Navigate
to Start | Settings | Control Panel | Add/Remove Programs and click
Add/Remove Windows Components. Place a check mark next to Application Server.
By default, all the minimum IIS components should be selected, but you can click details to
verify the selected components. When you are satisﬁed, click Next and Finish. Next, add
the Internet Information Services (IIS) Manager snap-in to your MMC console.To
change the default Web root directory, follow these steps:
1.
In the left pane of the MMC, expand the tree under IIS and the local machine
name.Then expand Web Sites, and highlight the Default Web Site.
2.
Right-click and select Delete.
3.
Right-click the Web Sites folder and select New | Web Site, which will start
the wizard.
4.
Click Next and enter a description for the Web site, then click Next.
5.
Enter the desired IP address to use, alter the TCP port to use (if desired), enter any
host header information (if desired), and click Next.
6.
On the next screen, click to browse to the path to the new Web root directory
you have chosen, and click Next.
7.
Select the desired permissions for the Web site. If you don’t need any type of
scripting support, you can leave it at Read and click Next.
8.
Click Finish.
You should not be able to browse to your new Web site.
The IIS Lockdown Tool
The IIS Lockdown tool is a very useful tool Microsoft produces to help secure IIS via a
scripted process.The ﬁrst thing you need to do to take advantage of this tool is to download
it from Microsoft at www.microsoft.com/technet/security/tools/locktool.mspx. It comes in
the form of an executable; when it is executed, it starts the Internet Information Services
Lockdown Wizard.To use the wizard, follow these steps:
1.
Click Next.
2.
Select I Agree at the End User License Agreement (EULA) screen, and then click
Next.
3.
The next screen is Select Server Template. If you choose any of the listed
options, the Lockdown tool will preconﬁgure the settings for any known product
requirements.These are high-level settings intended to be as generic as possible. It
is very likely that you will need to ﬁne-tune the settings when the wizard com-
www.syngress.com
654
Chapter 13 • Windows Bastion Hosts

pletes. If you need the Web server to serve in multiple listed roles, you should
select Other. Leave View template settings checked and click Next. For our
example, we will select Dynamic Web Server (ASP enabled).
4.
On the next screen, place a check next to any of the services you want to enable.
Unchecked services will be disabled. If you check the Remove unselected ser-
vices at the bottom option, unchecked services will be disabled and removed.
The most secure approach is to check this option and remove any services you
don’t need, although at this point there shouldn’t be any you didn’t plan on using
anyway. In this case we just left Web service (HTTP) checked and clicked Next.
5.
The Script Maps window allows you to disable support for individual script types.
The default should disable everything except Active Server Pages.Assuming these
settings ﬁt your needs, just click Next.
6.
The Additional Security window has some very strong defaults. Unless you
need something, leave these defaults and click Next.
7.
URLScan is a great tool which does exactly that. It ﬁlters URLs as they are
requested from the server and will block them according to a ﬁlter criteria you
specify. Leave Install URLScan ﬁlter on the server checked and click Next.
8.
Click Next to approve your selections and begin the lockdown process. Once it’s
ﬁnished, click Next again and Finish.
Finally, all that is needed is a few manual tweaks to the conﬁgurations.The next step is
to ﬁne-tune the URLScan tool.
NOTE
If you are using IIS 6.0, it includes built-in functionality that duplicates most of
what the URLScan tool can do for you. Odds are good you won’t need the
URLScan tool at all with IIS 6.0, but if you choose to use it, only V2.5 is sup-
ported. You can read more about V2.5 and view a comparison with the built-in
functionality of IIS 6.0 at www.microsoft.com/technet/security/
tools/urlscan.mspx.
The URLScan Tool
The URLScan tool exists in a few different versions.There is one that comes with the IIS
Lockdown tool (V2.0).You can also download a separate version that is V2.5.The added fea-
tures in V2.5 are:
www.syngress.com
Windows Bastion Hosts • Chapter 13
655

■
Change log ﬁle directory Allows you to change the log directory instead of
using the default.
■
Log long URLs By default, the log lines are truncated to 1024 bytes.
■
Restrict the size of requests Allows you to set limits on content length, URL
length, and query string length.
If you need any of these functions, you will need to download and install the newest
URLScan tool separately from the IIS Lockdown tool. By default, the URLScan log ﬁle and
.ini ﬁle, which controls the way URLScan behaves, are located in %SystemRoot%
\system32\inetsrv\urlscan.ini.The .ini ﬁle is heavily commented and fairly easy to under-
stand.You should edit it to suit your speciﬁc needs and ﬁne-tune the way URLScan works.
The following are some of the more important security options within the .ini ﬁle:
■
UseAllowVerbs= Setting this option to 1 or 0 basically determines whether the
server is working off a white list or a black list approach. If you set it to 1, you
must then specify all verbs that are allowed.Anything not explicitly speciﬁed in the
.ini ﬁle will be denied (white list). If you set it to 0, you can specify a list of
explicitly blocked verbs, and anything not explicitly blocked will be permitted
(black list).
■
RemoveServerHeader= Setting this option to 1 will cause the Web server to
remove the server header from all responses.This is generally a more secure way to
run, since telling attackers which Web server you’re running only helps them
narrow their selection of attacks to attempt.Another philosophy is to set it to 0,
causing the server to send a server header, and then specify false information in the
header by using the AlternateServerName= setting.You could, for example, claim in
the header that you were running Apache instead of IIS.Again, this is security
through obscurity.
Final Conﬁguration Steps
The next step is to conﬁgure your Web site logging. If you choose to download the newest
URLScan tool, you can specify the same logging directory for the URLScan tool as the
Web site. Conﬁgure logging for the Web server by performing the following steps:
1.
Open the Internet Information Services MMC plug-in. Highlight the server
name in the left pane.
2.
Right-click and select Properties.
3.
On the Internet Information Services tab, in the Master Properties section,
click Edit.
4.
On the Web Site tab, make sure the check box next to Enable Logging is
checked.
www.syngress.com
656
Chapter 13 • Windows Bastion Hosts

5.
Click Properties.
6.
In the WWW Service Master Properties window, at the bottom click Browse
and set the logging directory to the one you have chosen, as shown in Figure
13.20.
7.
Click OK three times to ﬁnalize the changes.
Figure 13.20 Specify Logging Directory
On the Directory Security tab, in the Anonymous Access and Authentication
Control (Authentication and Access Control in IIS 6) section, click Edit. Make sure
Integrated Windows Authentication is unchecked at the bottom. Because this server is for
anonymous access, there is no need to allow the Web users to authenticate (or attempt to
authenticate) with the Windows authentication system.This window is shown in Figure 13.21.
Figure 13.21 Disable Integrated Windows Authentication
www.syngress.com
Windows Bastion Hosts • Chapter 13
657

Next, on the Home Directory tab, click Conﬁguration and then select the App
Debugging tab. In the Script Error Messages section, select Send Text error message
to client. If you leave the default, which is to send detailed messages to the client, you can
provide an attacker with more detailed errors that he can use to reﬁne his attacks.As is usu-
ally the case, the less information the attacker has, the better.
Setting Up a Secure Web Site
Often, if the contents of the Web pages need to be kept private in transit, you will want to
enable some type of HTTP encryption.This is usually accomplished via Secure Sockets
Layer (SSL).Those pages protected with SSL are denoted in the URL with https:// instead
of the normal http://. To enable SSL on the Web server, you will need a Server Certiﬁcate.
Then you can make the necessary conﬁguration changes on the server as follows:
1.
Open the Properties for the Web site in the IIS snap-in.
2.
Select the Directory Security tab and click Server Certiﬁcate.
3.
This will start the Web Server Certiﬁcate Wizard. Click Next.
4.
On the next screen you have the option to create your own certiﬁcate, assign an
existing certiﬁcate, or import a certiﬁcate. If you need to present your site to third
parties, you might need to get a certiﬁcate issued from a trusted third party, such as
VeriSign.
■
If you select Create a New certiﬁcate, you will be given the option of
preparing the request now to send later, or sending the request immediately
over the Internet.
■
If you select Assign an existing certiﬁcate, you will be presented with a
screen to select which certiﬁcate you want to use.
■
The Import option allows you to browse to and use a key in the form of a
.key ﬁle. Once you have your certiﬁcate, you can go back and use the Import
feature on the same wizard.
5.
After the certiﬁcate has been imported, go to the same Properties screen again. On
the Directory Security tab, select Edit in the Secure Communications 
section.
6.
Check Require secure channel (SSL) and Require 128-bit encryption, and
click OK twice to exit.
Conﬁguring an IIS Server for SMTP
If needed, IIS can also server as a proxy for Internet e-mails.The IIS server can be conﬁg-
ured to be the gateway for e-mail as it passes into or out of your protected network.This is a
www.syngress.com
658
Chapter 13 • Windows Bastion Hosts

common conﬁguration and offers increased security by not exposing your internal mail
servers directly to the Internet.To enable SMTP on your IIS servers, follow these steps:
1.
Navigate to Control Panel | Add/Remove Programs | Add/Remove
Windows Components.
2.
Highlight Internet Information Services (IIS) and click Details.
3.
Check SMTP Service and click OK.
4.
Click Next twice and then Finish after the ﬁles are installed.
5.
Create directories and set permission on them to house a site root directory, a
directory for mail with errors, and a logging directory.
6.
In the MMC, the server name will have a new item under it called Default
SMTP Virtual Server. Right-click it and select Properties.
7.
On the General tab, make sure Enable Logging is checked.
8.
Click Properties and then Browse to conﬁgure the directory to hold the SMTP
logs.
9.
Select the Extended Properties tab, and select as much information as your
resources will allow.At a minimum you should log the date, time, client IP
address, user name, method, URI stem, and host agent.
10.
Click OK.
11.
On the Messages tab, click Browse to conﬁgure the bad mail directory. IIS will
place a copy of messages that could not be delivered or returned in this directory.
12.
Click OK.
13.
With the Default SMTP Virtual Server still highlighted in the left pane, right-
click Domains in the right pane, and select New | Domain.This will start the
new domain wizard.
14.
Select Remote and click Next.
15.
Enter the name of any domains that this SMTP server should process mail for.You
can use asterisks for high-level domain names (i.e. *.microsoft.com). Click Finish.
16.
Double-click and highlight domains in the left pane, then right-click the newly
created domain in the right pane, and select Properties.
17.
On the General tab, check Allow incoming mail to be relayed to this
domain.
18.
In the Route domain section, select the radio button to forward all mail to
smart host. Enter the name of your exchange server and click OK.
19.
Stop and restart the SMTP service for the changes to take effect.
www.syngress.com
Windows Bastion Hosts • Chapter 13
659

Bastion Host Maintenance and Support
It cannot be stressed enough that completing these procedures does not mean your host is
100-percent secure. Even if you could theoretically take steps to protect your host from
every exploit known today, there will be new ones discovered tomorrow. Security is an
ongoing process.Your bastion hosts are a critical piece of your infrastructure and are one of
the most visible targets in the organization for hackers to come after.You must have a
schedule for security patches and updates as well as a schedule to review security logs and
investigate anomalies.You should have a schedule for regular penetration tests and vulnera-
bility scans, and the test results should be reviewed and researched.A bastion host is one of
the most well protected parts of the network; it takes vigilance and effort to keep it safe on
the Internet.
Windows Bastion Host Checklist
The following checklist provides a high-level summary of the steps needed to secure your
Windows bastion host:
■
Plan your hard disk partitioning layout.
■
Perform a clean install of the OS.
■
Update the system with the latest service packs and hotﬁxes.
■
Remove unneeded system components.
■
Conﬁgure local user accounts, renaming the defaults and creating new ones as
appropriate.
■
Customize and apply the high-security template.
■
Conﬁgure time synchronization.
■
Evaluate and conﬁgure IPSec policies if desired.
■
Conﬁgure remote administration.
■
Conﬁgure and lock down bastion host functional software.
■
Perform routine maintenance and security testing.
Summary
Conﬁguring a Windows server as a bastion host can be done, but it requires some planning
and effort. With proper conﬁguration, the Windows server can be just as secure in the role
of bastion host as any other operating system. Further, the host of GUI tools and tight inte-
gration of tools can be a valuable asset in managing a complex conﬁguration.The entire pro-
www.syngress.com
660
Chapter 13 • Windows Bastion Hosts

cess of hardening a system to serve as a bastion host has to be done in the context of the
role the host will serve and its place in the perimeter of your network.
Solutions Fast Track
Conﬁguring Bastion Hosts

Think minimalist, and be cognizant of the bastion host’s role in all design
decisions.

Establish a security baseline.You have to know where you are to know how to get
somewhere.
Conﬁguration Fundamentals

Do the up-front planning for things like server type (domain member or
standalone), disk partitions, and other issues before you are sitting in front of a
computer screen making choices.

Perform a clean install and apply all operating system updates and patches.

Conﬁgure accounts and security settings to suit your needs and limit exposures.

Conﬁgure audit policy and log management settings so that you will know when
something unusual or out of the ordinary occurs.
Remote Administration

Determine whether you need a GUI for remote administration and if so,
conﬁgure it as securely as possible. Use only encrypted protocols for all remote
administrative tasks.

Conﬁgure command-line remote access using encrypted protocols for all
communications.

Conﬁgure a means of transferring ﬁles for administrative purposes, and be sure to
use encryption for all communications.
Sample Bastion Hosts Conﬁgurations

Conﬁgure your bastion host as a Web server, hardening the default conﬁguration
into something that can last on the Internet.

Conﬁgure your bastion host as an SMTP relay to securely act as your mail server’s
interface to the outside world without being compromised.
www.syngress.com
Windows Bastion Hosts • Chapter 13
661

Ongoing Maintenance and Security Assessments

Remember that all these processes should be repeated or at least veriﬁed regularly
as part of an ongoing security program.
Q: Aren’t there other, more secure operating systems besides Windows to use as a bastion
host?
A: Microsoft often takes a bad rap in the media.Truthfully, at one time all Microsoft’s
efforts went toward making things easier to use, with security taking a back seat.Today, a
Windows server can be just as secure as any other OS.The other OS might come with
default settings that are more secure out of the box, but if you take advantage of the
tools Microsoft provides, you can successfully harden your Windows server.
Q: What role does “out-of-band” management play for bastion hosts in a DMZ?
A: An out-of-band or management network can be useful for the bastion hosts. It allows
you to move some of your management sessions completely out of the prying eyes of
the DMZ. It’s worth remembering that if a bastion host is compromised, the manage-
ment network might have just became an extension of the external (untrusted) network.
So all the appropriate security controls should be in place for the management network
as though it were a DMZ itself. Otherwise, by adding a management network, you
could be increasing your overall risk instead of reducing it.
Q: If IIS 6.0 has all the same features as the URLScan tool V2.5, why would I use the
URLScan tool?
A: In most cases, you wouldn’t. From a feature perspective, there probably isn’t much reason
to use the URLScan tool if you are running IIS6.About the only reason is if policies
and/or procedures are such that the URLScan tool is entrenched and changing the con-
ﬁguration methods poses more trouble than it’s worth.
www.syngress.com
662
Chapter 13 • Windows Bastion Hosts
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

Linux Bastion Hosts
Solutions in this chapter:
■
System Installation
■
Minimizing Services
■
Additional Hardening Steps
■
Controlling Access to Resources
■
Auditing Access to Resources
■
Sample Linux Host Conﬁgurations
Chapter 14
663
 Summary
 Solutions Fast Track
 Frequently Asked Questions

Introduction
The general concepts behind hardening a Linux bastion host are no different than they are
for any other OS.You still need to minimize the installed software, update and patch the OS,
and tighten the security settings. It is only the speciﬁc methods for accomplishing these tasks
that vary with a Linux-based bastion host over a Windows-based one.The basic approach to
hardening any bastion host (whether Linux, UNIX, Windows, or other) can be summarized
in the following high-level steps:
1.
Planning comes before doing.
2.
Remember the bastion host’s role during all stages.
3.
Leave only the minimum components on the system to get the job done.
4.
Take what’s left and make it as secure as possible, avoiding default settings where
practical.
In some ways, securing Linux to serve as a bastion host can be harder than if you were
using a Microsoft product, because there are so many options. If you aren’t thoroughly com-
fortable with the landscape, the task of sorting out what tool and conﬁguration to use can
seem daunting. On the ﬂip side, this same weakness—Linux’s extreme ﬂexibility—is also its
main strength.Those same bewildering number of options provide you with near-inﬁnite
ﬂexibility in how you accomplish your objectives. In this chapter we walk through the steps
for hardening a Linux computer and preparing it to serve in the role of bastion host. We
cover the speciﬁc steps you need to take and contrast those with the same steps you would
use on a Windows system. It is assumed that the reader has read or is at least familiar with
the chapter on Windows bastion hosts and that the reader has at least moderate under-
standing of and experience using Linux.
System Installation
With various ﬂavors of Linux becoming so popular, deciding to use Linux as the OS for
your bastion host has never been easier than it is today.The Internet is overﬂowing with
helpful articles and Web sites to help guide you through setting up a Linux system. Many
vendors are offering brand-new systems with Linux already installed. Several distributions of
Linux are speciﬁcally conﬁgured to be user friendly and help a novice learn the ins and outs
of Linux. We will go through the steps of hardening your Linux system on the assumption
that you are installing it from scratch. If it is preinstalled on your system, you will need to
evaluate whether starting over with a clean install with settings you choose is worth the
effort. If you inherited the system, starting over might not be an option, but many of these
procedures can still serve as good guidelines for how you can lock down your newly inher-
ited system.
www.syngress.com
664
Chapter 14 • Linux Bastion Hosts

Disk Partitions
Unlike Windows, Linux has some speciﬁc requirements for disk partitions.All the applica-
tions that could be running at any given time can require a considerable amount of RAM to
run.Typically, more memory is required than the machine has physically installed.
Fortunately, operating systems have a technique to make it appear that more memory is pre-
sent using swap space.This swap space is presented to the application as though it were more
RAM. In Windows, the swap space is in the form of a swap ﬁle, which by default is located
on the same partition as the system partition. Linux, on the other hand, expects the swap
space to be on a separate physical partition.This swap partition actually gets formatted
speciﬁcally as a Linux swap partition, not as a standard ﬁle system. Some Linux distributions
allow you to use a normal ﬁle for swap space, like Windows, but using a separate swap parti-
tion provides some signiﬁcant performance increases and increased stability.
The amount of swap space that is needed will vary based on the programs that are loaded
and the functionality you are using in them.When you use a swap ﬁle, this means the size of
the ﬁle will need to change regularly, causing increased reads and writes to the disk, above and
beyond what is needed to manage the program data, simply to manage the swap ﬁle itself. By
contrast, if you have a separate swap partition, there is no disk activity to manage the swap ﬁle,
only the activity required by the programs using the swap space. Stability can be enhanced
using a separate swap partition as well. If the partition containing your swap ﬁle ﬁlls up with
data, it can prevent the swap ﬁle from growing and providing the needed swap space for a
newly loaded program.A dedicated partition for the swap space provides the desired isolation
from user data and ensures that the swap space will be available.
Choosing a Linux Version
Because there are so many different versions of Linux available, you have a lot of choices
here.The different versions may have some of the same core components, but each offers
different sets of software packages, often with an emphasis on a particular type of function-
ality, such as security testing, general ofﬁce productivity, or software development platforms.
These variations are called distributions, or sometimes even distros for short.A good source of
information on the various distributions is www.distrowatch.com.This site includes a brief
summary of what the distribution is trying to accomplish and includes links to the home-
pages and download locations.You can, of course, always do a Google search to ﬁnd a distri-
bution that does exactly what you are looking for. For a locally installed full installation,
Fedora core (which we examine in the examples in this chapter) provides a lot of features
and has extensive support documentation. If you just want to dabble, a live CD, such as
SLAX, is a very user-friendly way to get your feet wet with Linux.
Choosing Distribution Media
One of the really nice features that Linux has over Windows is that it can be run from a
variety of media.You can ﬁnd distributions that are capable of running off a CD-ROM, full
www.syngress.com
Linux Bastion Hosts • Chapter 14
665

installs to the systems hard disk, and distributions that can run off a USB drive or even a
ﬂoppy disk. Each media type offers some security pros and cons, and not every distribution
is available on every media type. If you need the features of a speciﬁc distribution that
doesn’t come on the media you prefer, you might need to make a compromise.The deci-
sions of media type and distribution selection will be made concurrently, unless you have
some very speciﬁc requirements.You will need to research the media options and choose
one that ﬁts your environment; we review some of the pros and cons of each type in the fol-
lowing sections.
Full Installs
With the traditional install to the systems hard disk, much like Windows, you will boot up
an installation CD and walk through a guided install process.Although it wasn’t always the
case, most of the distributions that are intended to be installed to the hard disk offer GUI
install programs that are pretty easy to get through.There is no great advantage to using this
type of distribution other than the size of the hard disk will allow you to install a lot of extra
software. In a DMZ on a bastion host, this isn’t necessarily desirable, and in many cases one
of the smaller, more streamlined distributions would be more appropriate.
On the down side, this type of install will have all the same disadvantages of a Windows
bastion host—namely, that the entire system is sitting on the hard drive, and if an attacker
manages to compromise the root account, she will be able to install a virus or Trojan on the
system that can survive future reboots, in addition to tampering with the contents of what is
running in memory.Typically, if you discover that your bastion host has been compromised,
unless you have some means of ensuring that the contents of the hard disk have not been
tampered with, you must reinstall the entire system from scratch to guarantee the system’s
integrity.This type of install isn’t really any better or worse than if you were using Windows
for your bastion host operating system.
CD-ROMs
You can get Windows running off a bootable CD-ROM, but it takes a lot more work than
it does with Linux.There are many versions of Linux designed speciﬁcally to run from a
CD-ROM, allowing you to turn virtually any machine into a ﬁrewall, router, or general-
purpose PC.There is an obvious security advantage to having all your conﬁguration infor-
mation on read-only media. Even if a hacker manages to compromise the system, all it takes
is a reboot and your conﬁguration can be restored to its previous condition.The system can
still fall victim to a virus or Trojan but only until it is rebooted. Further, if there is a hard-
ware failure, restoring the system is only as difﬁcult as moving the CD to a new system and
rebooting.
This same advantage also serves as a disadvantage. If you burn the entire OS and conﬁg-
uration settings to a CD, any time you need to make any adjustment you would need to
burn and load a new CD-ROM disk.The cost of the CD media probably isn’t an issue,
because CD-ROMs are inexpensive, but such a conﬁguration could hinder your ability to
www.syngress.com
666
Chapter 14 • Linux Bastion Hosts

remotely administer the system.You would only be able to remotely make changes to the
running conﬁguration, whereas changes that will remain after a reboot will require someone
local to burn and swap the CDs. If you needed to implement and test changes that required
a reboot before they will take effect, this type of setup would make things a little more difﬁ-
cult. Finally, due to simple space limitations on a CD-ROM, you might not be able to ﬁt all
the needed software or functionality on a CD.All that being said, if the role of your bastion
host allows the conﬁguration and data to be relatively static, a live CD could be a very
attractive option.
USB Drives
A Linux bastion host booting from a USB disk could offer the best compromise in security
and ﬂexibility. If you purchase a USB disk that includes a physical write-protect switch, you
can make changes on the ﬂy, as with a live system, and then write-protect the disk against
modiﬁcation when you are done.As the storage capacity of USB drives increases, you will be
able to use a USB-based distribution that includes increasingly greater functionality. Whether
you get the micro hard drive version or the solid-state USB disk, either will be more reliable
than a diskette while offering the same beneﬁt of allowing you to toggle the write-protect
feature.
Diskettes
Although they probably won’t be able to provide the functionality you are looking for in a
Linux bastion host, many versions of Linux can ﬁt on a 3.5-inch diskette.The primary
advantage of these distributions is their very low resource requirements. Often these systems
require only 8MB or 16MB of memory to function.The ability to toggle the write-protect
switch on the diskette can also provide a high degree of conﬁguration ﬂexibility and secu-
rity. Considering the unreliable nature of diskettes, they probably wouldn’t be appropriate for
any critical roles, though.Another disadvantage to diskettes is simply functionality. Whereas
they can act as a simple router or ﬁrewall, they typically lack much in the way of features.
Generally, these diskette-based distributions are single-purpose devices. Due to the space
restrictions and small footprint, diskette-based distributions are almost always command line
only, with no GUI for conﬁguration or management.
Choosing a Speciﬁc Distribution
In conjunction with choosing the media to be used, you will need to choose the exact
Linux distribution you want to employ.This decision can include a host of factors such as
included features, personal preference, availability of documentation and support, and avail-
ability of technical support. Some distributions are known for being more beginner friendly
or for supporting better security controls. One of the key differentiators for selecting a Linux
distribution as a bastion host is technical support. Some distributions, such as Red Hat
Enterprise Linux, are available with full technical support, which can be a major considera-
tion for a corporate bastion host.
www.syngress.com
Linux Bastion Hosts • Chapter 14
667

NOTE
Red Hat is one of the oldest Linux distributions that is still active. The naming of
Red Hat Enterprise Linux servers can be somewhat confusing. Red Hat Enterprise
Linux (RHEL) is the commercial product that includes various levels of technical
support. It comes in a few ﬂavors, such as RHEL WS (appropriate in a worksta-
tion role), RHEL AS (which contains advanced server functionality such as
database support or as an application server) and RHEL ES (appropriate in a
small to medium-sized server role). See www.redhat.com/rhel/compare/ for
more information. To further muddy the waters, the Fedora Core distribution is
basically the same software as RHEL but without any support. Fedora Core is the
freely downloadable consumer version. See http://fedora.redhat.com/ for infor-
mation and downloads.
Once you have selected your preferred distribution, you should go through the installation
process. If you are presented with any choices to install additional software, select No. We
want to keep things to a minimum because our next steps will be removing any unnecessary
software.The following steps assume you have the base Linux operating system installed and
functional. I used the latest Fedora Core distribution for screenshots (V5) with the default
GNOME window manager, but the procedures should be similar for most distributions.
Removing Optional Components
Windows has been the target of much scrutiny and ridicule for the size of its installation.
Typically, Linux is seen as sleek and efﬁcient. Well, this is partially true.The fact is that out of
the box, if you don’t take care to remove components, Linux can be pretty bloated.The
default install of Fedora with none of the high-level optional software categories selected was
just shy of 2GB, which isn’t all that slim.The key difference between Linux and Windows is
that with Linux you can remove or disable unneeded components (even including parts of
the kernel itself) and strip the system down to a very lean and efﬁcient machine. By con-
trast, tampering with the core OS ﬁles in Windows isn’t really an option for most people.
Minimizing Services
Like a Windows system, your chosen Linux distribution will likely be installed with a large
number of programs conﬁgured to run automatically, without human intervention. On
Windows systems these programs are called services; on Linux they are called daemons. In an
effort to minimize the amount of software that is running and thus reduce the number of
software targets a hacker might try to exploit, you should disable any daemons that are not
needed. Determining which daemons are needed will require some investigation and testing.
www.syngress.com
668
Chapter 14 • Linux Bastion Hosts

You’ll ﬁnd a list and brief description of daemons in Fedora Core 5 at
www.mjmwired.net/resources/mjm-services-fc5.html.
To conﬁgure the daemons, navigate to System | Administration | Services. (Fedora
actually uses the Windows terminology to refer to the daemons as services.) This will open
the GUI interface shown in Figure 14.1.
Figure 14.1 Daemon Control Panel
Highlighting a service in the leftmost pane will pull up a description and some addi-
tional details in the Description and Status panes, respectively. Disabling a service is as easy as
removing the check mark next to the service in question, then clicking Save in the upper-
right corner of the window and rebooting.
NOTE
Different services are handled differently with respect to the time at which your
changes take effect. When changes are made to services managed through
xinetd, xinetd is immediately restarted; thus your changes will take effect imme-
diately. When the service is not managed by xinetd, the same is not true. In
those cases you will need to either stop the service manually, go to a command
prompt, type telinit <runlevel> and press Enter to reinitialize the run level, or
simply reboot.
www.syngress.com
Linux Bastion Hosts • Chapter 14
669

If you are administering the bastion host without access to a GUI front end, you will
need to control daemons via the startup scripts. It’s also a good idea to know how to control
the daemons without the GUI because the GUI interface will vary from system to system.
The methods for startup scripts can also vary from one distribution to another.The startup
services in Fedora Core are managed by startup scripts located in /etc/rc.d/init.d.All you
need to do is comment out the line that calls the speciﬁc script by inserting a # at the front
of the line that calls it.You can also edit the individual scripts themselves for control of the
way the services are initialized.The preferred way on Fedora Core is to use the chkconﬁg
utility, which can be found in many distributions.You must be logged in as root to use this
utility.Abbreviated output from chkconﬁg --list is shown in Figure 14.2.
Figure 14.2 Listing Services with chkconﬁg
[root@localhost ~]# chkconﬁg --list
NetworkManager
0:off
1:off
2:off
3:off
4:off
5:off
6:off
acpid
0:off
1:off
2:off
3:on
4:on
5:on
6:off
anacron
0:off
1:off
2:on
3:on
4:on
5:on
6:off
apmd
0:off
1:off
2:on
3:on
4:on
5:on
6:off
atd
0:off
1:off
2:off
3:on
4:on
5:on
6:off
autofs
0:off
1:off
2:off
3:on
4:on
5:on
6:off
avahi-daemon
0:off
1:off
2:off
3:on
4:on
5:on
6:off
avahi-dnsconfd
0:off
1:off
2:off
3:off
4:off
5:off
6:off
bluetooth
0:off
1:off
2:on
3:on
4:on
5:on
6:off
cpuspeed
0:off
1:on
2:on
3:on
4:on
5:on
6:off
crond
0:off
1:off
2:on
3:on
4:on
5:on
6:off
As you can see, apmd (which is used for monitoring and logging the battery status) is
conﬁgured to start for run levels two through ﬁve. Since our bastion host has no battery to
monitor, we can disable apmd for all run levels by entering:
chkconﬁg --level 123456 apmd off
If you want to remove the service entirely form the startup script, type:
chkconﬁg –del apmd
Removing Optional Software
As with Windows, you will also likely end up with some software you don’t need.
Removing the software is most easily accomplished with Pirut, the built-in GUI tool you
can access by navigating to Applications | Add/Remove Software. Once it ﬁnishes
checking what is currently installed on the system, you see the Package Manager window,
which allows you to search for packages, install packages, or remove them. When you use the
www.syngress.com
670
Chapter 14 • Linux Bastion Hosts

Browse button, your interface is hierarchical and looks almost exactly like the one you used
to install the operating system.The Package Manager window is shown in Figure 14.3.
Figure 14.3 Package Manager
To remove the aforementioned apmd package, highlight the Base System category in
the left pane, and then highlight the Base group in the right pane. Click Optional pack-
ages and a new window will open showing all packages in the Base group, as shown in
Figure 14.4. Simply clear the check mark next to apmd and click Close. Back at the
Package Manager window, click Apply. Click Continue on the next window to verify
your changes, and ﬁnally, click OK when the update is completed.
Figure 14.4 Package Listing
www.syngress.com
Linux Bastion Hosts • Chapter 14
671

Packages can also be managed from the command line using the RPM Package
Manager (RPM).You can view a list of all installed packages by entering:
rpm –q -a
For example, to install the apmd package, you would need to ﬁrst obtain the package ﬁle
itself (from www.redhat.com/download/mirror.html, for example) or use the RPMs that
were included on the installation CDs.Then enter the following command to install apmd:
rpm –i apmd-3.2.2-3.2.i386.rpm
If the installation is successful, you should see output similar to the following;
Preparing...
########################################### [100%]
1:apmd-3.2.2-3.2
########################################### [100%]
You can even install a package directly from the Internet by specifying the full FTP or
HTTP path as the path to the RPM, as follows:
rpm –i ftp://somesite.com/5/i386/RPMS/apmd-3.2.2-3.2.i386.rpm
To uninstall the package, you must use the package name, which can differ from the
name of the RPM ﬁle.To uninstall apmd, enter the following command, using the –e switch,
for erase:
rpm –e apmd-3.2.2-3.2
TIP
There are various tools for package management. Here’s a brief summary of the
tools included in Fedora Core 5:
pup GUI tool for updating software, accessed at Applications | System
Tools | Software Updater.
pirut GUI tool for managing software packages, accessed at Applications
| Add/Remove Software.
rpm Command-line tool for managing software packages.
yum Yellowdog updater modiﬁed; command-line tool for managing soft-
ware packages.
yum Extender A GUI interface for YUM (install with yum install yumex).
Pirut and yum will automatically ensure you have the most current version
of a package. Both of these will also automatically check and install any depen-
dencies for the software you install. Rpm does not include this functionality;
you will need to check for dependencies manually when using rpm. YUM only
works on RPM based systems, and not all systems will have YUM
available/installed, therefore it is suggested that you understand how to
manage packages with RPM even if you choose to use YUM for you day to day
management. 
www.syngress.com
672
Chapter 14 • Linux Bastion Hosts

There is no universal list to tell you which packages you should leave installed and
which ones you should remove.You will need to evaluate each service based on your
requirements. However, at a minimum the following services are ones you probably do need
to have installed/running, unless you are very sure you don’t need them:
■
haldaemon Used for gathering and maintaining information concerning hard-
ware devices
■
iptables Manages IPTables ﬁrewalls
■
messagebus Used for sending notiﬁcation for certain system events
■
network Manages the activation of network interface at boot-up
■
NTPd Used to synchronize time via the NTP protocol
■
sshd Runs OpenSSH server
■
syslogd Used for system logging
■
xinetd Manages the startup of services
Tools & Traps…
Services to Be Avoided at All Costs
There are some services that you would never want exposed to an untrusted net-
work such as the Internet. In most cases this means they should not be running
on a bastion host. These services include the following:
■
portmap Used to manage RPC connections
■
Telnet Used for unencrypted remote console access
■
rsh, rlogin, rexec Used for unencrypted remote console access
■
nfs, lockd, mountd, statd Used for Network File System (NFS) and
related services
■
lpd Printer service
All these services are inherently insecure. A variety of alternatives is available
that take advantage of encryption and superior authentication methods. If you
absolutely must use any of these services, you should protect them by tunneling
them in IPSec or equivalent.
www.syngress.com
Linux Bastion Hosts • Chapter 14
673

Choosing a Window Manager
While we’re on the subject of cleaning out unneeded software, it seems like a good time to
discuss window managers. Because Linux is natively a command-line based system, the
graphical desktop environment is not an integral part of the operating system. Unlike with
modern versions of Windows, you can simply remove the GUI altogether.This has several
advantages, the most noticeable of which is that you will free up system resources.The sim-
plest and most easily implemented remote access solutions are also command line only,
which further lends itself to doing away with the GUI altogether. Finally, by not offering up
an X Window session for remote use, that is one less listening port that needs to be opened
on your bastion host, which means increased security.
If you decide a graphical interface is something you must have, you still must choose
one carefully.They are not all created equally. Generally speaking, the more full-featured and
visually appealing desktops are also the largest in terms of disk space and system resource
requirements. Gnome and KDE are by far the most feature-rich, widely supported desktop
environments. Gnome is not itself a window manager and comes standard with the Sawﬁsh
window manager.These two products also happen to be some of the largest and resource-
intensive as well. If performance is a consideration, you will want to choose a lean and fast
window manager such as IceWM (which is Gnome-aware) or Fluxbox. Some window man-
agers can cause the loss of some features with different underlying desktops, so you will need
to do a little research to make an informed choice.
Additional Steps
At this point, the basic system is in place.You have the desired software installed and should
have the undesirable software removed.This covers only the most basic of hardening steps.
The next steps will allow you to drill down into some of the more granular aspects of bas-
tion host hardening. Now let’s look at steps to synchronize time on the bastion host, keep
the system patched, and more.
Conﬁgure Automatic Time Synchronization
Having an accurate system time is important to proper functioning of your bastion host.
Accurate time on the bastion host is critical to having accurate audit logs, the ability to per-
form accurate forensics, and for maintaining secure (encrypted) communications. Fortunately,
most distributions of Linux should support the newest versions of NTP by default.You will
recall from the Windows chapter that different versions of NTP provide different levels of
security:
■
NTPv1 No security features
■
NTPv2 Restrictions based on IP address, NTP trafﬁc is unencrypted
www.syngress.com
674
Chapter 14 • Linux Bastion Hosts

■
NTPv3 Symmetric key encryption and authentication
■
NTPv4 Both symmetric encryption and PKI encryption
In the case of Linux, all you need to do is install the NTPD service, if it’s not already
installed, and then conﬁgure it to start automatically for the appropriate run levels.You can
conﬁgure some of the NTP settings by navigating to System | Administration | Date &
Time.You can then click the Network Time Protocol tab, as shown in Figure 14.5.
Figure 14.5 NTP GUI Conﬁguration
Unfortunately, the GUI interface only lets your conﬁgure basic options, like adding time
servers.You should make sure Synchronize System clock before starting service is the
only option checked under Show Advanced Options.To conﬁgure the NTP security set-
tings, you need to edit the ﬁle /etc/ntpd.conf and some additional ﬁles located in /etc/ntp/.
For secure time synchronization with an NTP server, perform the following steps:
1.
Edit /etc/ntp.conf and add the time servers you want to get time from; include
the key to be used with each server, such as server ourtimeserver.com key
12345.
2.
Ensure that restrict default ignore is in /etc/ntp.conf to set the default 
restrictions.
3.
If needed, add a restrict line for any servers you want to accept NTP requests from.
4.
Edit /etc/ntp/keys and conﬁgure a unique key to be used for each time server,
using the desired algorithm; for example, 12345 A secretkey would conﬁgure key
#12345 as an ASCII string between one and eight characters long, with a value of
secretkey.This key must be in the keys ﬁle of both the NTP server and the client
for this to work.
www.syngress.com
Linux Bastion Hosts • Chapter 14
675

5.
Add the keys to the /etc/ntp.conf ﬁle. For example, to add key 12345 as a
trusted key, enter trustedkey 12345.
6.
Restrict the NTP conﬁguration ﬁles to be owned and readable only by root.
You can view a detailed NTPD status by typing ntpq –p. If you enter ntpq and query
associations, it will display the status of all associations, including an auth column indicating
whether authentication is working properly, as shown in Figure 14.6.You’ll ﬁnd more infor-
mation at www.ntp.org.
Figure 14.6 Viewing NTP Associations
# ntpq
ntpq> associations
ind assID status conf reach auth condition last_event cnt
===========================================================
1 38100
9414
yes
yes
ok
sys.peer
reachable 1
2 38101
9614
yes
yes
none
sys.peer
reachable 1
Patching and Updates
Conﬁguring your bastion host is a never-ending process.As new vulnerabilities are discov-
ered and new features are added to software, you will need to upgrade your host to the most
current version, especially if the updated version addresses a security ﬂaw.Along the same
lines, new versions of the core OS ﬁles will be released periodically.These updates, referred
to as kernel patches, are similar in function to some Microsoft hotﬁxes that address core oper-
ating system functionality. Some kernel patches will be for features or options that don’t
apply to you, in which case you don’t need the patch. Be aware that kernel patches can be
applied incrementally, as they are released, or you can download and apply the latest kernel
in its entirety.
Updating Software Packages
Keeping individual software packages up to date is pretty simple, and there are a couple of
approaches you can take.The most straightforward method is to use the following RPM
commands to freshen (-F switch) an installed package:
rpm –F apmd-3.2.2-3.2.i386.rpm
When you freshen a package, the newer version is installed, but only if an earlier version
already exists.A good alternative is to use the upgrade option (by means of the -U switch),
because this will install the new package, whether it is currently installed or not, and will
remove any previous versions of the package that are present. Many experts advise simply
www.syngress.com
676
Chapter 14 • Linux Bastion Hosts

using –U all the time instead of –I (for Install) to avoid any errors in case the package hap-
pens to already be installed on the system.
rpm –U apmd-3.2.2-3.2.i386.rpm
Updating the Kernel
There are two basic options for updating the kernel.You can download a newer kernel in its
entirety and apply it, or you can download just a kernel patch and apply it.You can obtain
the complete kernel or kernel patches from www.kernel.org.You should also check the Web
site for your speciﬁc distribution to see if there are restrictions on which kernel will work
with that distribution. In most cases you will have the choice of downloading a patch or
patches or downloading the entire updated kernel. Patching the kernel generally requires a
higher level of skill and a larger investment of time than installing a complete new kernel.
TIP
Kernel version numbers follow a speciﬁc pattern. There are several numbers sep-
arated by decimals, such as 2.6.17.4. In this example, the 2 represents the
major version number, and the 6 represents the minor revision number. The
third number represents the patch version, and the fourth is a minor revision of
that patch. Essentially, the farther from the leftmost version number you get,
the less signiﬁcant the change. The high-level version numbers are pretty intu-
itive, but there is still more information hidden in a kernel version. If the minor
revision number (the second number from the left) is even, that is considered a
stable release; if it is odd, it is a developmental release. If the version number
contains a dash, such as 2.6.17-3.4, it is a kernel that has been modiﬁed and
produced by a speciﬁc distribution. The numbers to the right of the dash will
follow a scheme speciﬁc to that distribution.
By entering the following command, you can determine the kernel you are currently
running:
# uname –r
2.6.15-1.2054_FC5
The most current stable kernel on www.kernel.org is 2.16.17.4; however, on the Fedora
site, we found the latest Fedora Core distribution release was 2.6.17-1.2145. Instructions on
updating Fedora Core and a link to Fedora Core updates can be found at
http://fedora.redhat.com/Download/updates.html.You can use Yum or RPM to update
your kernel the same way you would with any other software package. One consideration is
that using RPM will leave each kernel image sitting on the hard drive; over time this could
www.syngress.com
Linux Bastion Hosts • Chapter 14
677

account for a considerable amount of hard disk space.Yum will, by default, leave only the
previous kernel in addition to the newest one and will delete all others.
Removing SUID Programs
Programs with the set user ID (SUID) bit set will be run with the permissions of the owner,
not the user who is executing them. Obviously this could pose a big security risk. If an
attacker were to locate a script with the SUID bit set and that was owned by root, and if the
attacker could ﬁnd a way to modify the script, he could do anything he wanted to the
system, as though he were root.Although a script is the most likely target, an attacker could
also gain root access if he could execute a buffer overﬂow against a binary program with the
SUID bit set as well.The same considerations hold true for ﬁles with the set group ID
(SGID) bit set.You can create a listing of all SUID and SGID ﬁles by entering the following
command:
ﬁnd / -perm -4000 –print
To list ﬁles with the SGID bit set, use the following command:
ﬁnd / -perm -2000 -print
The list may be long, so redirecting the output to a ﬁle for review might be advisable.
Unfortunately, some programs will not function properly without having the SUID or SGID
bits set. Each instance will need to be researched and possibly tested in a lab environment to
determine whether you can safely remove the bit. In all likelihood, either of those bits will
be needed on some ﬁles, but reducing the number of ﬁles to a minimum will leave your bas-
tion host more secure.
With all the obvious risks for using SUID and SGID programs, you might be won-
dering if using them is ever a good idea or simply an evil to be lived with.These bits can
actually improve security in the right situation. For example, if a user needs to perform a
routine maintenance action that requires root privileges, normally he needs to know the root
password to temporarily gain root access and perform the task. By setting the ﬁle SUID and
having it owned by root, you can give the user only permissions to execute the ﬁle but not
modify it. Now he can perform the required task without ever knowing the root password.
SELinux Policy Development
SELinux, which stands for security-enhanced Linux, was developed in partnership with the
National Security Agency (NSA). It provides a higher level of security by enforcing manda-
tory access control (MAC) through the kernel itself rather than by running additional pro-
cesses in the user space. Because the enforcement is through the kernel, it can restrict the
actions of any process, even a superuser (i.e., root) process. In fact, as far as the underlying
components of SELinux are concerned, there is no concept of a root user, only security
policies and security contexts. SELinux is available for many Linux distributions (see which
ones at http://selinux.sourceforge.net/distros/redhat.php3) and comes included in some,
www.syngress.com
678
Chapter 14 • Linux Bastion Hosts

such as Fedora Core.You can read the FAQ from the NSA at
www.nsa.gov/selinux/info/faq.cfm for more information.
It is important to understand that SELinux is a work in progress. Currently, the setup
and conﬁguration can be rather complicated.You can enable SELinux on Fedora Core by
navigating to System | Administration | Security Level and Firewall. On the
SELinux tab, you must change the setting from Disabled to Enforcing or Permissive to
enable SELinux, as shown in Figure 14.7.
Figure 14.7 Enabling SELinux
SELinux uses the xattr labels to generate persistent labels that describe the security con-
text of a ﬁle or directory.These labels are not normally used; thus when you enable
SELinux, you will get the warning dialog box shown in Figure 14.8.You must select Yes to
enable SELinux, then OK on the Security Level Conﬁguration window and reboot.
Figure 14.8 Relabel Warning Dialog Box
If you choose Permissive (which is recommended initially), the system will generate logs
based on the SELinux policy but will not actually restrict any activities.This is useful for
www.syngress.com
Linux Bastion Hosts • Chapter 14
679

ﬁne-tuning the rules until you get the system into a working state. Once you are satisﬁed
with the SELinux rules, you can enable Enforcing mode, which will actually apply your con-
ﬁgured policy. Policies can be deﬁned as targeted or strict.The strict policy applies to all pro-
cesses and ﬁles on the system; the targeted policy is applied only to speciﬁc ﬁles. Strict, while
more secure, has been found to be very difﬁcult to conﬁgure properly.Targeted is easier to
conﬁgure and is the default policy type when SELinux is ﬁrst enabled.You can check the
status of SELinux by typing sestatus.
If you navigate back to the Security Level Conﬁguration window and click the
SELinux tab, then click to expand Modify SELinux Policy, you will be presented with a
list of options to toggle various SELinux settings.These options are only a limited set of pre-
conﬁgured choices to toggle settings in the SELinux policy ﬁles. For any serious conﬁgura-
tion you will need to edit the ﬁles manually.You can also download a third-party SELinux
policy editor from the SELinux Policy Editor Project (http://seedit.sourceforge.net/
index.html).This package includes a simpliﬁed set of tools that is slightly less functional than
the normal package. However, you can switch between using one or the other.
By reviewing the logs, you can see what actions the policy would have denied if it were
enforced. If auditing has not been enabled, the Access Vector Cache (AVC) messages are found
in /var/log/messages. If auditing has been enabled, they will be in /var/log/audit/audit.log.
Further details on conﬁguring SELinux are beyond the scope of this book. It is recom-
mended that you read the documentation on the Web site of your chosen distribution as
well as the ofﬁcial SELinux site (www.nsa.gov/selinux/).
TCP/IP Stack Hardening
Some means of attacking a computer system do not rely on weaknesses in the software that
is providing a service but instead attack weaknesses in the underlying communications pro-
tocol. For Internet-connected systems, this means attacking weaknesses in the various proto-
cols that make up the TCP/IP suite. Further, some of these weaknesses are intrinsic to the
way the protocols work, and they cannot be removed. In those cases, you can still ﬁne-tune
the systems to make your hose more resistant to those attacks.
As with all security measures, they come with a cost. For example, a SYN attack occurs
when an attacker initiates a high number of connections by sending a SYN packet, but the
attacker never completes the TCP handshake.This causes the target machine to wait, with
memory and CPU cycles being used on these half-open connections.The depletion of
resources can cause performance degradation for all users of the system as well as reduce
resources to the point where legitimate clients cannot make connections. One method of
reducing your risk from such an attack is to reduce the length of time a connection can be
in that half-open state before it is dropped, freeing up the resources.The downside to this
approach is that legitimate clients traversing high-latency networks could have problems
establishing a connection due to the short timeouts.
www.syngress.com
680
Chapter 14 • Linux Bastion Hosts

The way that you tune these settings, at least on some distributions, is through the sysctl
utility.This utility allows you to conﬁgure various kernel parameters at run time.You can add
settings to a script to be run at system startup, if desired. If you enter sysctl –a | grep
net.ipv4 you will see the list of available TCP/IP variables. In the previous example, to
reduce the timeout of half-open connections, you would use the following command:
sysctl –w net.ipv4.tcp_synack_retries=3
The default value is 5, which means the half-open connection will not be dropped until
three minutes have passed. Setting it to a value of 3 will result in only a 45-second timeout.
Other values are possible, with a 1 equaling about nine seconds before timeout.As you can
see, these changes will have a signiﬁcant impact on the functionality of the host system, so
they should be used with care.The following is a list of variables you might want to research
and consider altering:
■
net.ipv4.tcp_synack_retries Number of retransmissions in an attempt to com-
plete the three-way handshake; a lower number is more resistant to attack.
■
net.ipv4.tcp_max_syn_backlog Number of half-open connections that can be
in the queue at any given time; a high number is more resistant to attack, at the
cost of system memory.
■
net.ipv4.icmp_echo_ignore_broadcasts=1 Tells the system not to respond to
a ping to a broadcast address. On systems this value is the default anyway.
■
net.ipv4.conf.all.accept_redirects=0 & net.ipv4.conf.all.send_redirects=0
Tells the system not to listen to ICMP redirects, which could be used to alter
routing tables.
■
net.ipv4.conf.all.accept_source_route=0, net.ipv4.conf.all.forwarding=0
and net.ipv4.conf.all.mc_forwarding=0 Together these disable source routing,
which is rarely used for anything other than attack attempts.
■
net.ipv4.conf.all.rp_ﬁlter=1 Tells the system to drop packets when the source
and destination don’t make sense based on the interface they came in on.
■
net.ipv4.conf.all.tcp_syncookies=1 Enables SYN cookies, allowing the con-
nections to be made without using the backlog queue at all. If this setting is
enabled, the net.ipv4.tcp_max_syn_backlog setting will have no effect. It is recom-
mended to enable this setting.
Automated Hardening Scripts
Because there are so many settings to adjust and conﬁgure, it can be easy to miss a step.As a
result, many people have developed semiautomated scripts to help harden a Linux system.
The Cadillac of hardening scripts is Bastille-Linux. It has evolved from a crude basic script to
a well-reﬁned hardening system with a GUI interface. Bastille currently supports Red Hat
www.syngress.com
Linux Bastion Hosts • Chapter 14
681

Enterprise Linux, Fedora Core, SuSE, Debian, Gentoo, Mandrake, and HP-UX, with a Mac
OS X version in development.You can read about and download Bastille from www.bastille-
linux.org.
You can pass only three options to Bastille, each of which tells it to run in a different
mode. If you use bastille –report, the system will generate a Web based report of your host’s
current “hardness.”The –c option will run the actual hardening script in a text-based mode,
and –x will run it in a graphical mode, as shown in Figure 14.9.
Figure 14.9 Bastille Graphical Conﬁguration
All you have to do to use Bastille is start it and it will present a series of questions you
must respond to with a yes or no. Based on your choices, Bastille will conﬁgure various
security settings automatically.These settings include removing SUID bits from some pro-
grams, disabling insecure services (such as rshell, for example), changing user account expira-
tion and much more.The script will usually have the most secure choice as the default
selection, except in cases where the more secure selection has a high risk of impacting
normal functionality. When you are ﬁnished answering the questions, you will be prompted
to choose whether or not to save the resulting Bastille conﬁguration.You will then be
prompted to choose whether you want to apply the conﬁguration or not.
Controlling Access to Resources
The majority of the steps so far have been focused on controlling how a user can interact
with the bastion host. Most of the steps so far were made under the assumption that the user
already has connectivity to the bastion host, from which programs have the SUID bit set to
the security context they use and the services that are available. Following a defense-in-depth
www.syngress.com
682
Chapter 14 • Linux Bastion Hosts

philosophy, the next steps are to restrict who can interact with the bastion host. By restricting
who may communicate with the bastion host, in addition to restricting what they do once
they have established communication, we come closer to having a hacker-proof system.
Address-Based Access Control
From a networking perspective, the most common way to limit access is based on the IP
address of the foreign system.A traditional ﬁrewall falls into this category. In this section we
discuss some of the ways you can restrict access based on the IP address of the systems in
question.
Conﬁguring TCP Wrappers
TCP Wrappers functions similarly to a ﬁrewall, except where a ﬁrewall permits or denies
trafﬁc based on data contained in the IP header of the packet,TCP Wrappers ﬁlters access to
services on the host it is running on. Services that are compiled against the libwrap.a library
can make use of TCP Wrappers. When enabled,TCP Wrappers’ attempts to access a given
services will be compared against the /etc/hosts.allow ﬁle and then the /etc/hosts.deny ﬁle.
Rules are checked sequentially, and processing of the rules ﬁles stops when a match is found.
For example, if you wanted to allow only connections from Syngress.com to SSH on your
bastion host while rejecting all other attempts, you would have the following lines in your
hosts.allow and hosts.deny ﬁles:
/etc/hosts.allow
sshd : .syngress.com
/etc/hosts.deny
sshd : ALL
These two ﬁles accept several wildcards, such as ALL, LOCAL, KNOWN,
UNKNOWN, and PARANOID.You can enable logging in the rule ﬁles as well, and con-
ﬁgure the facility and severity of the log entry. With TCP Wrappers’ limited functionality
and syntax, you might wonder why you would ever use it over simply using the Linux ﬁre-
wall, IPTables. Because IPTables works at the packet level, if you want to deny access to a
particular process, such as HTTP, you must do it based on port number. So if you use
IPTables to explicitly block connection attempts to port 80, and the user starts the Web
server and tells it to listen on port 8080, the connection will be allowed. With TCP
Wrappers, you permit or deny access to a process.This distinction could prove invaluable if
you have a service that uses a large number of listening ports or some type of service that is
spawned as needed and the port number isn’t always consistent, or if the packets are tunneled
in another protocol, rendering identiﬁcation via port numbers impossible.
www.syngress.com
Linux Bastion Hosts • Chapter 14
683

Conﬁguring IPTables
IPTables comes with virtually every distribution of Linux. It is a very functional ﬁrewall with
an impressive array of features and options.To enable the IPTables ﬁrewall, simply navigate to
System | Administration | Security Level and Firewall. On the Firewall Options
tab, ensure that it is Enabled, as shown on Figure 14.10.
Figure 14.10 Enabling an IPTables Firewall
Depending on the distribution you choose, the default rules set for IPTables may vary. In
the case of Fedora Core 5, the default rule set is to permit all outbound trafﬁc and to permit
all inbound trafﬁc that is part of an established session.As you can see in the Figure 14.10,
SSH was checked. Because the default conﬁguration blocked all inbound connection
attempts, checking that box will cause a rule to be created to allow an inbound connection
for SSH (TCP 22). In addition to the preconﬁgured ports (services), you can add your own
custom port in the Other ports section.This interface works well for simple packet ﬁl-
tering, but IPTables is capable of much more functionality than mere ﬁltering.To get more
advanced, you need to be comfortable with the command line. Next we will discuss what
the rules look like and their meanings.
To use an example, this is the default output from the command iptables –L, which is to
list all chains (we will see what a chain is shortly), shown in Figure 14.11.Your default rules
probably won’t look exactly like these.
Figure 14.11 An IPTables Chain Listing
[root@localhost ~]# iptables -L
Chain INPUT (policy ACCEPT)
www.syngress.com
684
Chapter 14 • Linux Bastion Hosts

target
prot opt source
destination
RH-Firewall-1-INPUT
all
--
anywhere
anywhere
Chain FORWARD (policy ACCEPT)
target
prot opt source
destination
RH-Firewall-1-INPUT
all
--
anywhere
anywhere
Chain OUTPUT (policy ACCEPT)
target
prot opt source
destination
Chain RH-Firewall-1-INPUT (2 references)
target
prot opt source
destination
ACCEPT
all
--
anywhere
anywhere
ACCEPT
icmp --
anywhere
anywhere
icmp any
ACCEPT
udp
--
anywhere
224.0.0.251
udp dpt:mdns
ACCEPT
udp
--
anywhere
anywhere
udp dpt:ipp
ACCEPT
tcp
--
anywhere
anywhere
tcp dpt:ipp
ACCEPT
all
--
anywhere
anywhere
state RELATED,ESTABLISHED
ACCEPT
tcp
--
anywhere
anywhere
state NEW tcp dpt:ssh
REJECT
all
--
anywhere
anywhere
reject-with icmp-host-prohibited
[root@localhost ~]#
To start with, let’s review some basic IPTables vocabulary. iptables is the command-line
utility for conﬁguring the Netﬁlter ﬁrewall, which is integrated with the Linux kernel.
Speciﬁcally, Netﬁlter is actually a set of hooks inside the Linux kernel that allows the various
kernel modules to interact with the network stack. In short, this is what allows the ﬁrewall
to do the actual work of packet manipulation.
■
Tables NAT (used for NAT’ing), ﬁlter (used for packet ﬁltering), and mangle (used
for other types of specialized packet modiﬁcation).
■
Chains Basically, these are access control lists that tell the ﬁrewall what to do.
There are built-in chains that are automatically processed by the tables (which start
out empty), and you can create your own custom chains. Built-in chains are FOR-
WARD, INPUT, OUTPUT, PREROUTING, and POSTROUTING.
■
Targets These dictate what action should be taken when a rule is matched.The
default targets are ACCEPT, DROP, QUEUE, and RETURN.
■
Commands These are speciﬁc uppercase options on the command line used to
manipulate the rules themselves; for example, –A to append a rule to a chain, -D
to delete a rule from a chain, and so on.
www.syngress.com
Linux Bastion Hosts • Chapter 14
685

■
Options These are used to specify options for the rule-matching criteria, such as
–s for source address and –p to specify the protocol to match.
Certain tables will process certain chains by default.The one we focus on for a bastion
host is the ﬁlter table. If you do not specify what table to use when adding rules (with –t
<table>) the default is to assume you are working with the ﬁlter table.The ﬁlter table pro-
cesses the FORWARD, INPUT, and OUTPUT chains by default. Referring to the chain
listing, you can see that the target for the built-in chains is to jump to the custom-created
chain RH-Firewall-1-INPUT.This means all packets traversing the system will go through
the same chain.You don’t have to set it up this way. In fact jumping out to custom chains
and then back to the built-in chains can be much more efﬁcient.As an example, let’s suppose
that you have a long list of rules that only need to be checked against trafﬁc to or from the
accounting subnet. Now let’s place this list on its own chain called ACCOUNTING.You
can make a single rule that matches the accounting subnet and then jumps into the
ACCOUNTING chain containing the lengthy list of rules. In this way the majority of your
trafﬁc is only checked against the single rule matching the accounting subnet instead of the
entire list of rules found in the ACCOUNTING chain.
The man page for IPTables contains a wealth of knowledge, and the IPTables Web site
has an excellent FAQ (www.netﬁlter.org/documentation/index.html#documentation-faq).
The large number of features and ﬂexibility can make management over the command line
sometimes cumbersome.There are several GUI tools for creating and editing the Netﬁlter
rules. Some of the most widely used GUIs are Firestarter, Firewall Builder (fwbuilder), and
Guarddog.These allow you to more easily create the rule set without having to know all the
command-line options for IPTables.To see what some of the GUIs look like, take a look at
the main window for Firestarter shown in Figure 14.12.
Figure 14.12 Main Firestarter Console
www.syngress.com
686
Chapter 14 • Linux Bastion Hosts

Auditing Access to Resources
Auditing serves an important role in network security. Not only does it allow you a means to
know what is occurring on your systems in real time; it can also allow you to reconstruct a
series of events after the fact, which can be especially important after a successful compromise
has occurred.There are basically two types of auditing you can do. One is kernel auditing, which
will log system calls, and the other is syslog, which can log most everything else.
Enabling the Audit Daemon
Enabling auditing is a very straightforward process. If you don’t have auditd installed, go
ahead and install it. It should be set to start automatically; if it’s not, conﬁgure it to do so.
The primary ﬁle for conﬁguration of auditd is /etc/audit.conf.This ﬁle contains settings such
as where to write the logs (defaults to /var/log/audit/audit.log), the log formatting, and
what to do if the disk is full. Parameters of note are the dispatcher, disk_full_action, and
max_log_ﬁle_action. Dispatcher is the program that the audit daemon will use to send all logs
to stdin.This program will be run as root, so the program needs to be secure and used with
caution.The disk_full_action is exactly what it sounds like: what should the daemon do when
the disk that holds the log is full? Max_log_ﬁle_action tells the daemon what to do when the
maximum log ﬁle size is reached.
TIP
If auditd is running, the logs for SELinux are written to the same location speci-
ﬁed in the audit.conf ﬁle. If auditd is not running, the logs will instead be
written to the syslog log (which is at /var/log/messages by default). You can
view the logs directly or type dmesg in a terminal to view them.
The other relevant ﬁle for the audit daemon is /etc/audit.rules.This ﬁle tells the audit
daemon what events to audit. By default, the ﬁle contains no rules. If you wanted to audit all
calls for mount, for example, you would place the following line in your audit.rules ﬁle:
-a tools,always –S mount
-w /etc/fstab
This basically means to add a rule to the end of the tools list (-a), and always generate an
audit event.The –S means the syscall to watch is mount. –w tells it to watch the /etc/fstab ﬁle
for access attempts and log them.The usefulness of being able to keep such close tabs on the
use of some of the more important system calls should be clear now.This is a very powerful
tool for spotting intrusion attempts and other activities that could indicate someone is trying
to do something they shouldn’t be doing.The watch option does not accept wildcards, so –w
/etc/*.conf will not work.
www.syngress.com
Linux Bastion Hosts • Chapter 14
687

Enabling the Syslog Daemon
The daemon that supports syslog is syslogd. With current Linux distributions, you would be
hard-pressed to ﬁnd one that didn’t come with syslog already enabled, but if you do manage
to, you can install it like any other package. Once it’s installed, you can control its behavior
through /etc/syslog.conf.This rule ﬁle is relatively simple. Each line consists of a facility, a
priority, and an action.Take the following example:
Mail.*
/var/log/maillog
This would tell the daemon to log all events from the mail subsystem, such as facility,
regardless of their priority, to /var/log/maillog. Pretty straightforward. Examples of valid pri-
orities are debug, info, notice, crit, alert, *, and emerg, which indicate the overall severity of the
event.An asterisk (*) stands for all facilities or priorities, depending on where it is used.
Unless a given facility isn’t used or available on your bastion host, you should point the logs
someplace for all of them.The action will typically point to a real ﬁle, but some other
options are available.The most notable one from a security perspective is the remote machine
action.This allows you to send the logs to a remote machine, which is a good idea.The
syntax for the remote machine action is simply @host. If your bastion host were to be com-
promised by a hacker, any logs on that host would become suspect and of less value if legal
action had to be taken. By sending the syslog events to a syslog daemon on another machine,
you can ensure their integrity.
Viewing and Managing the Logs
Not that you have enabled all these logs, you will hopefully be generating a lot of useful
auditing information.The issue then becomes what to do with all that data.You need a way
to sort through it and pick out the most interesting pieces, then do something about it
where necessary, preferably all in as automated a fashion as possible.The way to do this is
through several handy log tools. One of the simplest of utilities is dmesg. It lacks any real fea-
tures; it is merely a quick way to display the system message buffer.
A good Web site covering log analysis topics is www.loganalysis.org by Tina Bird.You
can probably ﬁnd a utility to do just about anything you want to do with log ﬁles, from
sending e-mails for certain events to shutting down processes or just color-coding the events
on the console.Two popular tools are swatch and logwatch. Of the two, swatch is the more
lightweight, being easier to set up and having fewer options. Swatch is intended to parse the
logs in real time and act on what it ﬁnds inside the logs according to the conﬁguration you
specify. Logwatch has a slightly different role: Its focus is on analyzing and reporting on log
ﬁles, but not in real time.
Conﬁguring Swatch
Since swatch (short for simple watcher) is relatively focused in its purpose, the setup and con-
ﬁguration are pretty simple. Some swatch behaviors can be set from the command line, but
www.syngress.com
688
Chapter 14 • Linux Bastion Hosts

the rules to match must be in a conﬁguration ﬁle.An example command line to invoke
swatch would be swatch -c /etc/swatch.conf –t /var/log/syslog, which would tell swatch to use
the conﬁguration ﬁle (-c) at /etc/swatch.conf. If you don’t specify which ﬁle to watch (-t),
swatch will default to /var/log/messages or /var/log/syslog, in that order. If you don’t specify
a conﬁguration ﬁle, it will echo everything to the console.You can use –f  <ﬁle> to examine
a ﬁle once instead of it running continuously with the –t options.
If you had the following lines in your conﬁguration ﬁle, they would cause any line con-
taining denied or Denied to echo to the console as yellow text and sound the bell once.
Everything else would echo to the console as normal text.
watchfor
/[dD]enied/
echo yellow
bell 1
watchfor /.*/
echo
As you can see, conﬁguring swatch is not difﬁcult. Some of the key commands for 
security considerations and their use follow:
■
--script-dir=<path to directory> Used on the command line. When swatch runs,
it creates a temporary watcher script, which by default is written to the user’s
home directory.You should redirect the watcher script to a secured directory
where it cannot be edited.A hacker with access to this temporary script could
control what swatch reports and cover his tracks.
■
exec command Used in the conﬁg ﬁle, this will cause matches to execute
another command.This could be as simple as pager software, for example, or it
could run a custom script to lock down the Netﬁlter ﬁrewall automatically.
■
Throttle hours:minutes:seconds,[use=message|regex|<reges>] This is
especially valuable because it controls how often duplicates of a given message will
be acted on.This way a brute-force password cracker being run won’t overload
swatch with a nonstop scrolling message, possibly ﬁlling up your logging partition.
■
Threshold events:seconds,[repeat=no|yes] This is another very important
one. It allows you to ignore certain matches until they surpass a given threshold; in
other words, threshold 4:60 will not perform any action unless the pattern matches
four times within a 60-second window.This is very useful for things such as incor-
rect passwords.You don’t want all sorts of alarms going off because the admin
mistypes a password once, but many incorrect attempts in a short time frame may
be a sign of a hacker at work.
www.syngress.com
Linux Bastion Hosts • Chapter 14
689

Conﬁguring Logwatch
Logwatch is intended to be more of a reporting tool than a live monitor. It has a host of
command-line options. Logwatch will do some formatting of the output for you. For
example, if you entered logwatch —service sshd —print, you’d get the output shown in Figure
14.13.
Figure 14.13 Output from Logwatch
[root@localhost ~]# logwatch --service sshd --print
################### LogWatch 7.1 (11/12/05) ####################
Processing Initiated: Mon Jul 10 23:19:05 2006
Date Range Processed: yesterday
( 2006-Jul-09 )
Period is day.
Detail Level of Output: 0
Type of Output: unformatted
Logﬁles for Host: localhost.localdomain
##################################################################
--------------------- SSHD Begin ------------------------
SSHD Killed: 1 Time(s)
SSHD Started: 1 Time(s)
Illegal users from these:
192.168.1.108: 4 times
Users logging in through sshd:
root:
192.168.1.108: 7 times
---------------------- SSHD End -------------------------
###################### LogWatch End #########################
As you can see, Logwatch can be invaluable in helping you sort through very large logs
and extract the meaningful information in an easy-to-understand format.A command-line
option of note is the —archives —range all option.This tells Logwatch to parse not only the
www.syngress.com
690
Chapter 14 • Linux Bastion Hosts

log ﬁle speciﬁed but all archived ﬁles of that log family. For example, if used with the option
—logﬁle messages, Logwatch would parse /var/log/messages in addition to
/var/log/messages.* variations, such as /var/log/messages.1.
Remote Administration
It might be important to have remote administration capabilities for your bastion host.A key
consideration with any administrative activities is to make sure unauthorized individuals
aren’t gathering information from those activities that can be used to compromise the secu-
rity of the bastion host.This is true even if you are logging in directly to the console.The
“guest” in the server room could be “shoulder surﬁng” to get your password.The same is
even more true for remote administration because, by its very nature, your activities are
having to traverse multiple devices and quiet probably hostile networks. Under these circum-
stances the key consideration is maintaining the conﬁdentiality of the data (in this case, the
administrative session) and restricting access to only authorized individuals.The challenge
then becomes to provide your administrators with the needed functionality to do their jobs
in a secure fashion. In this section we walk through the most common ways to accomplish
this goal.
SSH
What secure shell (SSH) lacks in “ﬂash” it makes up for in pure practicality.A secure,
encrypted terminal session to the remote host is invaluable to an administrator, and with
Linux’s command-line-oriented design, very often no other remote access will be needed.
Setting up SSH is pretty easy, too. Start off by installing the SSH daemon (sshd). Odds are
very good it’s already installed, because most distributions install it by default. Some com-
mand-line options should be conﬁgured to impact the security and operation of the
daemon.This is not a complete list of options, only the most important ones from a security
perspective:
■
-f <conﬁguration_ﬁle> Speciﬁes the conﬁguration ﬁle; sshd will not start without
specifying a conﬁguration ﬁle.
■
-h <host_key_ﬁle> This option speciﬁes the ﬁle containing the host key.You
must use this option if sshd is not run as root. Because sshd will work without
being run as root, you should conﬁgure it as a nonroot account and use this
option.
The next step is to create a conﬁguration ﬁle for sshd, which defaults to
/etc/sshd_conﬁg if you don’t specify an alternate ﬁle using the –f option.The following is a
partial list of keywords containing only the most signiﬁcant security settings.All the key-
words and arguments are case sensitive:
www.syngress.com
Linux Bastion Hosts • Chapter 14
691

■
AllowGroups This speciﬁes the groups allowed to log in based on group name.
Wildcards are supported.The default is all groups.You should create a group spe-
ciﬁc to sshd users and populate it appropriately.
■
AllowUsers This speciﬁes the users allowed to log in based on username.The
default is to allow all users.You can also specify USER@HOST to allow a partic-
ular user to log in only from a particular machine.
■
Banner This is a typical banner message, which is usually a good idea to set to
some ominous warning message approved by your legal department.This message
is sent to the client before they log in and is only supported in sshd V2.
■
ClientAliveInterval Speciﬁes the time the session can be idle before sshd sends a
message to the client requesting a response.The default is 0, which means the
client will never see these requests and subsequently never be disconnected (see
below).This setting will not actually disconnect the client.
■
ClientAliveCountMax This setting speciﬁes how many requests for a response
can be sent to the client without receiving a response before the client is discon-
nected.The default value is 3, so if the ClientAliveInterval were set to 20, an unre-
sponsive client would be disconnected after 60 seconds.
■
KeyRegenerationInterval This speciﬁes how often to regenerate the server key.
The default is one hour. If resources allow, a lower setting would be more secure,
depending on how paranoid you want to be.
■
LoginGraceTime This speciﬁes the time the daemon will wait for a client to
authenticate themselves.The default is 600 seconds, which is far too long and just
asking for a DoS attack. Set this to a lower number, such as 30 seconds or less.
■
PrintMotd This will print /etc/motd after the user logs in. Same considerations
apply to the Banner option described previously.
Once you have your conﬁguration ﬁle and the sshd daemon started with all the appro-
priate options, you need to allow inbound connection on the sshd listening port (default is
TCP22). Using a GUI-based tool such as the Security Level Conﬁguration utility, this is
simple. Navigate to System | Administration | Security Level and Firewall. On the
Firewall Options tab, next to Trusted Services, place a check mark next to SSH. We cov-
ered this previously in Figure 14.9. Once this is done, click OK, and click OK again when
the warning dialog box comes up.To make the same changes from the command line, you
could enter:
iptables -A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT
This would tell the ﬁrewall to append (-A) this rule to the INPUT chain. It would
match the TCP protocol (-p) and look for the state to be a newly initiated connection (-m
state –state NEW). When all this is true and the destination port (—dport) is 22, it will
www.syngress.com
692
Chapter 14 • Linux Bastion Hosts

ACCEPT the connection (-j ACCEPT). Remember, the INPUT chain is one of the built-in
chains; yours might be different. In the case of Fedora Core 5, checking the box in the GUI
would add the rule to the RH-Firewall-1-INPUT chain instead.You can also use —source
1.2.3.4 to specify a source address, if known, but this might not be possible if your adminis-
trators will be accessing the bastion host from home.
Remote GUI
Even though you can get any administrative tasks done from an SSH session, maybe you’re
more comfortable using a GUI.The obvious question then is, How do I access a secure GUI
session remotely? Typically it’s done one of two ways: either using X Windows’ built-in func-
tionality or with third-party software such as VNC that’s designed speciﬁcally to share desk-
tops. In either case, you must encrypt the sessions somehow.The free version of VNC that’s
available for download,VNC Free Edition, uses an initial challenge response that hides the
password, but after that the session is completely unencrypted.The current pay versions do
support session encryption.Another commercial alternative is NoMachine NX server. Further
information on this product can be found at www.nomachine.com. Because SSH and the X
Server are a part of almost every Linux distribution and can provide the desired GUI session
remotely, we will look at the settings needed to conﬁgure X Windows over SSH.
Tunneling X Windows over SSH isn’t as complicated as it sounds, and if you’re going to
be doing the administration from a Windows machine, Cygwin/X is a free software package
to provide the X Windows client and SSH client that will run on Windows. First, you need
to open the appropriate ports on the Linux bastion host for inbound X Windows connec-
tions over SSH.The default SSH port is TCP port 22.
The X Server also includes its own rudimentary security mechanism.You must have a
list of all user names or machine names that are allowed to connect to the X Server.This list
is modiﬁed using the xhost utility.The process is very simple: Enter xhost +bob to add the
user bob or the machine bob to the list of allowed X Server connections. Entering xhost
–bob would remove that name from the allowed list. Finally, you need to ensure that the
sshd_conﬁg must have ForwardX11 set to Yes.This allows the X Server to work over SSH,
and in most cases it should default to On.
Bastion Host Conﬁgurations
Now that we have discussed the various ways to harden a Linux bastion host, it’s time to do
something with it.You probably don’t want to have the bastion host exposed to the Internet
without offering up some type of service.The most common Internet-exposed servers are
FTP, Web (HTTP), mail relays (SMTP), and DNS servers. On Linux you don’t need to buy
any expensive software packages to have a secure, robust Web server or FTP server.Apache is
the most widely used Web server on the Internet, and it’s available for free. Here we examine
the basic steps that are needed to provide these services securely over the Internet, and we
www.syngress.com
Linux Bastion Hosts • Chapter 14
693

focus on the steps that are needed in addition to the normal hardening procedures covered
previously in this chapter.
Conﬁguring a Web Server
Follow these steps to enable your Linux bastion host to serve as a Web server:
1.
Install the Apache Web server software (httpd) and openssl.You can use any of the
methods discussed previously to do so.
2.
Conﬁgure the ﬁrewall to allow inbound connections to port 80 and 443 for
HTTP and HTTPS, respectively.You can verify the ports are allowed by entering
iptables –L to list the chains.There should be lines similar to the following;
ACCEPT
tcp
--
anywhere
start NEW tcp dpt:https
ACCEPT
tcp
--
anywhere
start NEW tcp dpt:http
3.
If you are hosting a domain, you will want to add the domain and your server IP
address to your /etc/hosts ﬁle.
4.
Apache uses a conﬁguration ﬁle to determine how it handles the Web site.You
should read the documentation available at http://httpd.apache.org/docs/2.0/ for
more information.The ﬁle is located at /etc/httpd/conf/http.conf by default. Edit
this ﬁle if needed.
5.
Assuming you want httpd to start automatically, go to System | Administration
| Services and place a check next to httpd for the appropriate run levels.
6.
Conﬁgure the appropriate monitoring for the log ﬁle (like swatch) if desired.The
default location for the logﬁle is /etc/httpd/logs/.
7.
At this point you should be able to connect to the Web server and see the Apache
Test Page.The next step is to conﬁgure HTTPS.You can add your own content to
/var/www/html and set the permissions to something appropriate for Web access,
typically read only, or if scripts are used, read and execute; for example, chown –R
755 /var/www/html.
8.
Install mod_ssl, which is the SSL/TLS module for Apache, and openssl.
9.
Place your SSL certiﬁcate (obtained from a third-party CA) in a directory of your
choice, and then edit the /etc/httpd/conf/httpd.conf ﬁle to include the fol-
lowing lines, which point to the certiﬁcate ﬁles.You should select a secured non-
root partition to hold your certiﬁcate ﬁles.
SSLCertiﬁcateFile
<path to certiﬁcate ﬁle>/server.crt
SSLCertiﬁcateKeyFile <path to certiﬁcate ﬁle>/server.key
10.
Edit the permissions to ensure that the server.key ﬁle is readable only by root.
www.syngress.com
694
Chapter 14 • Linux Bastion Hosts

Conﬁguring an FTP Server
To conﬁgure your bastion host as an FTP server, follow these steps:
1.
Select and install an FTP server daemon.Two good choices are vsftpd and pure-ftpd,
but there are many others to choose from. If you are using a SELinux, pure-ftpd
includes SELinux support, which must be downloaded separately. Some users have
reported better performance from vsftpd, so that is the one we will use for this
example; see the vsftpd Web site at http://vsftpd.beasts.org/ for more information.
2.
After installing the daemon, ensure that the service is set to start automatically for
the appropriate run levels.
3.
Enable FTP inbound on the ﬁrewall,TCP port 21.At this point you should be
able to connect to the FTP server from a remote host.
4.
Edit the vsftp conﬁguration ﬁle (must be owned by root) located at
/etc/vsftpd/vsftpd.conf. What follows are some of the more security-oriented set-
tings to be aware of.The default settings for vsftpd are pretty secure.
■
anonymous_enable The default is Yes, and if you comment out this line, the
default will still be Yes.To disable anonymous, you must set this to No.
■
ssl_enable This should be set to Yes to support SSL-encrypted FTP transfers.
■
dual_log_enable Set this to Yes. It tells vsftpd to generate a wu-ftpd style log
(/var/log/xferlog) in addition to vsftpd’s own logging format
(/var/log/vsftpd.log).The wu-ftpd style log will be understood by more log-
parsing utilities.
■
force_local_logins_ssl Setting this to Enable will force all nonanonymous
logins to use SSL.
■
syslog_enable Setting this to Yes will cause the logs to be written to the
system log instead.
■
tcp_wrappers Setting this to Yes will enable tcp_wrapper support (vsftpd has to
be compiled with tcp_wrapper support for this to work).
■
userlist_deny This option is used only if userlist_enable is set to Yes. Setting
this option to No means that a user will be denied login unless he or she is
explicitly listed in the userlist_ﬁle (/etc/vsftpd/user_list). It’s also worth noting
that the user will be denied before being asked for a password.
■
userlist_enable This is the reverse of userlist_deny. With user_list enable, the
user_list ﬁle is checked, and any names in the ﬁle will be denied access before
being prompted for a password.
www.syngress.com
Linux Bastion Hosts • Chapter 14
695

■
anon_root <path> This option sets the root directory for anonymous users
only.This can simplify your security conﬁguration by allowing different roots
for authenticated users from anonymous users.
■
banner_ﬁle <path> This is where you specify the security warning banner.
■
ftpd_banner This setting sets a banner message from the conﬁgu ﬁle, instead of
using a separate banner ﬁle.This setting will override the banner_ﬁle setting.
After setting these directives to the desired values and restarting vsftpd, you should be
running a secure FTP server. Remember that ﬁle permissions are of particular importance
when it comes to FTP servers.You must ensure that a hacker cannot edit any sensitive ﬁles,
such as conﬁguration ﬁles.Additional security can be achieved by running your FTP server
from a chroot jail (explained in the following DNS example).
Conﬁguring an SMTP Relay Server
Follow these steps to secure your SMTP relay bastion host:
1.
Install Sendmail or another mail transfer agent (MTA) of your choosing. We use
Sendmail in this example because it is the most widely used and is included by
default with many distributions. If you check your conﬁguration, you might ﬁnd
it’s already installed and running.
2.
Edit the /etc/mail/local-host-names ﬁle and add to it all domains for which
you want to process mail. For the relay to work, either the sender or the receiver
of the mail must be in this ﬁle or you will get an error.
3.
Install sendmail-cf.
4.
Edit the /etc/mail/sendmail.mc ﬁle and add/conﬁgure the following lines:
■
Edit the line dnl deﬁne(‘SMART_HOST’,`smtp.your.provider’) with the
name of your upstream mail server, and remove dnl from the beginning 
of the line.
■
Comment out the line that reads DAEMON_OPTIONS
(`Port=smtp,Addr=127.0.0.1, Name=MTA’)dnl.This line tells Sendmail
to only accept mail from the local machine and is the default setting.
■
Add the following line to delete all the program and version information from
the SMTP header: deﬁne(`confSMTP_LOGIN_MSG’,`’).
■
Add the following line to remove version numbers in the HELP output;
deﬁne(`HELP_FILE’,`’).
■
Add the following line to enable privacy ﬂags:
Deﬁne(`confPRIVACY_FLAGS’,`authwarnings noexpn novrfy need-
mailhelo noetrn’).
www.syngress.com
696
Chapter 14 • Linux Bastion Hosts

5.
Generate a new Sendmail.cf based on the new Sendmail.mc by entering make
–C /etc/mail or m4 /etc/mail/sendmail.mc > /etc/sendmail.cf.
6.
Add any domains you want to allow mail relay for in the /etc/mail/access. Use
the format somedomain.com       RELAY.After conﬁguring this ﬁle, generate
a new db for Sendmail to use by entering makemap hash /etc/mail/access <
/etc/mail/access.
7.
Start and stop Sendmail for the new settings to take effect.
8.
If there are any issues (or even if there are no issues), review the mail logs at
/var/log/maillog.
Conﬁguring a DNS Server
For this example we use BIND, the de facto standard DNS server.This section assumes that
you have BIND working and are familiar with DNS. Due to the complexity of conﬁguring
a DNS server, we are only going to look at the security-related settings that should be used.
Follow these steps in addition to the other hardening steps that were previously discussed to
get your DNS bastion host up and running.
1.
Edit /etc/named.conf as follows:
■
Remove the // for query-source address * port 53; by default, BIND will
use an unprivileged port, but often only port 53 will be allowed through
many ﬁrewalls.
■
Add the option allow-transfer { 1.2.3.4; localhost; }; to the individual
zone sections.This speciﬁes that only the machine at 1.2.3.4 and the local host
are allowed to perform a zone transfer. If you do not do this, hackers will use
the zone information to locate target servers and help them construct a map
of your internal network.
■
In the options section (which applies to all zones), remove the ability to
answer queries for domains you don’t own by adding the following: allow-
query { 192.168.1.0/24; localhost; };.This says that only queries for
192.168.1.0 and the localhost are allowed.
■
In the individual zone sections, add allow-query { any; };.This says that
anyone is allowed to query for those speciﬁc zones and is needed to provide
DNS for the domains you own.
■
In the Options section, disable recursive queries except from internal sources.
Add the following line: allow-recursion { 192.168.196.0/24; localhost; };.
2.
Run named as a nonroot user in a chroot jail.
■
Create a /chroot/named directory.
www.syngress.com
Linux Bastion Hosts • Chapter 14
697

■
Create the user. In this example we will create the user named. Create a
group called named as well. Set the shell for the user to /bin/false or some-
thing equally invalid, since this user should never need to log in directly. Set
the home directory to /chroot/named.
■
Create a subdirectory structure for the jail.
/chroot
+-- named
+-- dev
+-- etc
|
+-- other
|
+-- slave
+-- var
+-- run
■
Move named.conf to /chroot/named/etc and move any zone ﬁles to
/chroot/named/etc/other.
■
Give named access to /chroot/named/etc/other/slave (for any zones your
name server acts as a slave) and /chroot/named/var/run to write statistical
information.
■
Create a device node for /dev/null and /dev/random:
# mknod /chroot/named/dev/null c 2 2
# mknod /chroot/named/dev/random c 2 3
# chmod 666 /chroot/named/dev/{null,random}
■
Copy /etc/localtime to /chroot/named/etc/.
■
Adjust the ﬁle location in /chroot/named/named.conf to point to the
new jail.
3.
Enable logging from inside the jail by editing the startup script for syslog by adding
-a /chroot/named/dev/log.
4.
Modify the startup script for named and add –t /chroot/named –u named.
5.
Periodically you need to update the root.hints ﬁle.This can be downloaded from
ftp://ftp.internic.org/domain.named.root. Reload named after updating the 
hints ﬁle.
Bastion Host Maintenance and Support
At this point you should be comfortable with the tools required to securely administer your
Linux bastion host. Ongoing maintenance must be performed on a schedule. Changes
www.syngress.com
698
Chapter 14 • Linux Bastion Hosts

should be handled in a systematic fashion.You should deﬁne maintenance windows and a
change control policy whereby patches and upgrades are approved, implemented, and
reviewed. Joining one of the many vulnerability mailing lists will help you stay informed
about new vulnerabilities as quickly as possible.You can bet the serious hackers are all mem-
bers of those mailing lists, so you probably should be too.
There should be a policy in place for log collection and review. Logs should be
recorded, preferably on a read-only media for archival purposes. Logs should be regularly
reviewed and suspicious activity investigated.This last point is key; all too often logs are gen-
erated but in many cases no one looks at them. Use of automated tools like swatch and
Logwatch can help minimize the human labor involved in log analysis, but there will still be
events that need to be looked at more closely. Remember that security is an ongoing process
that requires continued education and effort to stay as hacker-proof as possible.
Linux Bastion Host Checklist
Use the following checklist when hardening your Linux bastion host.These steps are not
speciﬁc to any particular role (such as a web server or SMTP relay).All these steps are crit-
ical; missing any single one could leave you vulnerable to hackers and result in a compro-
mised system.
1.
Research your needs for a Linux bastion host (support, media, functionality), and
select a distribution accordingly.
2.
Plan the partition layout, and give some forethought to providing space for the
operating system, swap partition, system logs, and system data.
3.
Install the OS, and remove and disable any optional software and services.
4.
Apply patches and updates to the system kernel and software as needed.
5.
Remove/minimize processes using the SUID or SGID bit.
6.
If mandatory access control is desired, implement SELinux.
7.
Harden the TCP/IP stack.
8.
Conﬁgure TCP Wrappers.
9.
Conﬁgure the Netﬁlter ﬁrewall via the GUI or IPTables tool.
10.
Apply any needed encryption for sensitive data.
11.
Enable and conﬁgure auditing as required.
12.
Apply scheduled maintenance to keep the system secure.
www.syngress.com
Linux Bastion Hosts • Chapter 14
699

Summary
As you can see, Linux has many free and powerful security tools at its disposal. With a little
care and planning, a Linux bastion host can be at least as secure as a Windows bastion host, if
not more so.Although they may take some getting used to, the package managers offer a
powerful way to install and update packages. Windows users might ﬁnd the interfaces a little
odd, but the ability to download free software for ﬁrewalls, Web servers, and much more, all
from a single interface, is something most Windows users don’t easily have. Netﬁlter offers a
powerful ﬁrewall with many advanced features built in, for free.There is no ﬁrewall with
comparable functionality included with the Windows operating system.Armed with the
knowledge in this chapter, you should be able to connect your Linux bastion host to the
Internet and not get hacked, and if the system should be compromised, you will have logs to
see it happening, or at worst, to reconstruct events so that it doesn’t happen again.
Solutions Fast Track
System Installation

Be cognizant of alternate OS media other than a traditional hard disk install.

Research the strengths and weaknesses of a particular distribution and choose
accordingly (not all are created equally).

Prepare the hard disk (if needed) with forethought, especially with an eye for
logging.
Removing Optional Components

Think minimally. If you don’t need the software in question, remove it.

For services you need, control when they run. Some can be enabled as needed and
don’t need to be running at startup.

Ensure that none of the “high-risk services” are running at all costs, and provide
comparable functionality via more secure alternatives if needed.
Additional Hardening Steps

Make sure your system’s time is accurate.This is important for forensics and
encryption.
www.syngress.com
700
Chapter 14 • Linux Bastion Hosts


Make sure the kernel and software are patched and up to date, to avoid known
vulnerabilities.

Remove or minimize the use of SUID or SGID ﬁles.

Consider applying SELinux for mandatory access controls. Research the
implementation details fully before coming to a decision. SELinux can offer a lot
of protection, but the conﬁguration and management can be burdensome.

Harden the TCP/IP stack to make it more resistant to inherent weaknesses.

Run Bastille Linux in Report mode to see if there are things you missed, or use it
to make actual changes to the system.
Controlling Access to Resource

Implement TCP Wrappers to protect processes based on client IP addresses.

Implement the NetFilter ﬁrewall. It’s free and very powerful.
Auditing Access to Resource

Enable auditd for auditing of system calls.

Enable syslogd for normal syslog logging.

Remember to log access to the logs themselves.Attackers will often attempt to
delete or edit the logs to hide evidence of their activities.

Conﬁgure automated log monitoring to make the volume of data manageable.
www.syngress.com
Linux Bastion Hosts • Chapter 14
701

Q: If I were to run Linux from a CD-ROM on my bastion host, won’t the performance be
worse than if I used a hard drive?
A: Maybe. Many of the live CDs have the option of running entirely in RAM. If you have
adequate hardware, this can result in an extremely fast system. If the host will need to
manipulate a lot of data, using the hard disk might be unavoidable; however, you could
still run from CD-ROM and customize the distribution to make use of the hard disk for
data storage.
Q: Is IPTables the ﬁrewall or Netﬁlter? And what is this IPChains I hear about?
A: Netﬁlter is the actual ﬁrewall component, though it is very common for people to refer
to the ﬁrewall as IPTables. Strictly speaking, IPTables is only the command-line interface
for editing the rules that Netﬁlter uses. IPChains is the previous incarnation of IPTables
and should no longer be used if possible.
Q: Is it any more secure to use the Netﬁlter ﬁrewall than TCP Wrappers?
A: They don’t really do the same thing.The Netﬁlter ﬁrewall makes ﬁltering decisions
based on the contents of the headers of the IP packets alone.TCP Wrappers makes deci-
sions based on only the source IP and the process name that is listening for inbound
connections.The functions of the two overlap only slightly.They complement each
other nicely, however, and using both of them provides defense in depth.
Q: Why wouldn’t I want to run X Windows remotely? I like using a GUI instead of the
command line.
A: For a bastion host, the objective is to minimize exposure to attack.And like any other soft-
ware running on your bastion host, X Windows is simply one more listening service that
an attacker can target. Using SSH only would always be the more secure option, though X
Windows is used all over the Internet today without being compromised. In the end you
will just need to research and weigh the pros and cons for your environment.
www.syngress.com
702
Chapter 14 • Linux Bastion Hosts
Frequently Asked Questions
The following Frequently Asked Questions, answered by the authors of this book,
are designed to both measure your understanding of the concepts presented in 
this chapter and to assist you with real-life implementation of these concepts. To
have your questions about this chapter answered by the author, browse to
www.syngress.com/solutions and click on the “Ask the Author” form. 

703
Index
3G Mobile Wireless services, 230
4GE-SSM card, 239
A
AAA. See authentication, authorization,
accounting
aaa authorization command, 249
aaa-server command, 249, 297
absolute command, 275
acceptable-use policy, 10
access
AAA feature for router security, 531–532
of ASDM, 248
authentication of PIX/ASA access,
249–250
Check Point rules for DMZ access,
332–333
of Cisco PIX/ASA, 243–248
console/auxiliary port configuration,
523–525
in DMZ design, 36–38
enable password, 528–530
IAS server remote access policy, 198
inbound NAT configuration, 264–268
outbound, from services segment,
456–458
outbound NAT configuration, 260–264
remote registry access,A:188
rogue AP in MITM attack, 153–155
security banner message about, 522–523
switch console port, 555–556
systems engineering Windows DMZ,
55–56
Telnet configuration, 525
unauthorized access, 151
WMDZ, 172
access auditing, Linux
audit daemon, enabling, 687
logs, viewing/managing, 688
Logwatch, configuring, 690–691
overview of, 701
resources, 687
Swatch, 688–689
syslog daemon, 688
access control
Apache Web server directives,A:210
file, lists, 123
role-based, 124
access control, Linux
address-based, 683
IPTables, configuring, 684–686
overview of, 701
to resources, 682–683
TCP wrappers, configuring, 683
access control lists (ACLs)
access rules for PIX/ASA, 269–278
configuration for Internet-facing routers,
519–522
extended ACL, 517–519
function of, 516
multi-DMZ and, 212
NAT configuration for PIX/ASA,
261–262, 264
registry/file system, 638
router security, 516–522
standard ACL, 516–517
access list
for Telnet, 525
traffic class definition and, 301
access point (AP)
authentication server and, 160
DoS attack on wireless network,
152–153
for IAS server, 201
IAS server wireless policy and, 198–199
placement of, 166
for RADIUS server redundancy/load
balancing, 202
WDMZ component, 159
wireless DMZ design, 156
in wireless DMZ examples, 162, 163
access rules, 269–278
Access Support, Nokia, 371
Access Vector Cache (AVC), 680
access-class command, 525, 527
access-group command
for inbound ACL, 273
for outbound ACL, 271, 272
access-group id [in | out] interface if_name
command, 271
access-list <access-list-number> <action>
<protocol> <source-IP>
<source-wildcard> [operator
[port]]<destination-
IP><destination-wildcard>
[operator [port]] [log]]
command, 517–518
access-list <access-list-number> <action>
<source-IP> [source-wildcard]
[log] command, 516–517
access-list acl_name compiled command,
274
access-list command
for access rule creation, 269–270
for outbound ACL, 271, 272
for time-based ACLs, 274–276
access-list compiled command, 274
account lockout,A:186
Account Lockout Policy, 630
accounting
AAA configuration for router security,
531–532
configuration for switch, 558
ACID (Analysis Console for Intrusion
Databases),A:73
ACLs. See access control lists
ACS (Cisco Secure Access Control Server),
250
active attacks, on wireless network, 150–153
Active Directory (AD), 609–610, 641
Active Directory Federation Service
(ADFS), 58
Active/Active stateful failover
with cable, 293–294
LAN-based failover, 294–295
in multi-DMZ infrastructure, 213
of PIX/ASA, 285–286
Active/Passive stateful failover
with cable, 288–291
LAN-based, 291–293
Active/Standby failover, 285
ActiveX controls, 295–296
ACU (Aironet Client Utility), 175
AD (Active Directory), 609–610, 641
Adaptive Security Algorithm (ASA), 208,
229
Adaptive Security Appliance. See Cisco ASA
(Adaptive Security Appliance)
firewall
Adaptive Security Device Manager
(ASDM), 247–248
address book entries, 406–407
address ranges, 519–522
address translation rulebase, 333–335
address-based access control, Linux, 683
addressing, in DMZ design, 26
ADFS (Active Directory Federation
Service), 58
admin.cfg file, 283
administration
command-line, 650–652
remote, of Linux bastion hosts, 691–693
administrator account
local, for bastion hosts, 628
reconfiguration of,A:186
of Web server, renaming,A:27
ADODB library,A:77
Advanced Encryption Standard (AES), 599
advanced risks, 34–36
aggressive mode, 602
AH (Authentication Header), 599–600
Aide software package, 116
AIP-SSM
ASA firewall support of, 231
features of, 239
intrusion prevention functions of,
306–307
Aircrack, 149
Aironet Client Utility (ACU), 175
AiroPeek, WildPackets, 147, 150
Airsnort
for network hijacking, 154, 155
for wardriving, 148, 149
alarms
configuration of,A:53–A:55
false, minimizing,A:105
in IDS deployment,A:12
real time intrusion alarms,A:105
alerts
alert database management,A:87–A:90
alert groups,A:84–A:86
BASE, querying database,A:83–A:84
BASE alert graphing,A:86–A:87
BASE unique alerts,A:81–A:82
Specter remote alert function,A:21
all open rule, 480–481
American Registry for Internet Numbers
(ARIN), 510
analog connections
probing,A:150–A:151
war dialing,A:151–A:154
Analysis Console for Intrusion Databases
(ACID),A:73
antenna, 149
antispoofing interface, 327–328
antivirus, NetScreen, 428–429
antivirus software,A:146,A:188
Anti-X Edition, Cisco ASA firewall, 222,
223, 231
AP. See access point
Apache Web server
access to MC for IPS Sensors via,A:39
hardening,A:200–A:214
MC for IPS Sensors installation,A:36
monitoring,A:214
patching/securing OS,A:199–A:200
vulnerabilities within,A:198–A:199
Apache Web server, hardening,A:200–A:214
httpd.conf file, configuration of,
A:206–A:214
OS preparation,A:201–A:202
source code compilation,A:203–A:206
source code integrity,A:202
steps of,A:200–A:201
AppleTalk, 313
Application Inspection feature
of Cisco PIX/ASA OS 7.2, 237
PIX 6.x OS configuration, 299
PIX 7.x OS configuration, 300–306
application map, 306
application server
placement in DMZ, 32–33
in three-tier design, 214–215
approval, of IPS sensor configuration files,
A:58–A:59
architecture, of Check Point firewall,
319–320
archiving, alerts,A:88–A:89
ARIN (American Registry for Internet
Numbers), 510
AS (autonomous system) number
assignment of, 510
BGP configuration on router, 512–513
BGP tracking of, 509
ASA (Adaptive Security Algorithm), 208,
229
ASA firewall. See Cisco ASA (Adaptive
Security Appliance) firewall
ASDM (Adaptive Security Device
Manager), 247–248
AS-Path attribute, 510–511
ASs (autonomous systems), 509
attack, definition of,A:2
attack signatures, 306
attacks
active attacks on wireless network,
150–153
cost of,A:112
on DMZ hosts,A:111
growth in, 2
honeypot and,A:18–A:21
identification of potential threats, 8
IDS signatures and,A:10
jamming attacks, 155
MITM attacks on wireless network,
153–155
with Nmap,A:17–A:18
passive attacks on wireless network,
147–150
phases of,A:29
risks to services, 7
VLAN-hopping attack, 213
on wireless network, 167–168
. See also testing the DMZ
attacks, on DMZ hosts
BIND security,A:160–A:161
DMZ hardening checklist,A:173
DNS exploits,A:155–A:160
DNS spoofing attacks,A:161–A:162
e-mail attacks, hacks,A:167–A:170
overview of,A:178–A:179
Solaris exploit,A:171–A:172
SQL attacks, hacks,A:163–A:167
Web site resources for,A:172–A:173
AU (Microsoft Automatic Update), 625–626
audit daemon, 687
audit log reports,A:61–A:62
audit policy
for bastion hosts, 631–632
configuration of,A:187–A:189
auditd, 687
auditing
for defense in depth,A:149–A:150
IIS Web Server configuration for,A:194
Solaris DMZ, 119–120
. See also access auditing, Linux
authentication
AAA configuration for router security,
531–532
of Apache Web server,A:210–A:211
BGP, 514–515
configuration for switch, 558
of console/auxiliary port, 523–525
DMZ design and, 33–34, 39
IAS server authentication, 196
LEAP with RADIUS, 172–175
network hijacking and, 154–155
outside office to internal network, 43
of PIX/ASA management access,
249–250
RADIUS authentication process,
202–203
of routing protocols, 576
SQL injection and,A:165–A:166
Steel-Belted RADIUS, 176–186
of switch console port access, 555–556
of VPN remote access topology, 588
for WDMZ, 156–158, 166
WDMZ examples of, 162–164
Windows Active Directory domain
authentication, 186–188
authentication, authorization, accounting
(AAA)
configuration for router security,
531–532
configuration for switch, 558
PIX/ASA cut-through proxy, 297–298
PIX/ASA feature, 249–250
with RADIUS server, 160
Authentication Header (AH), 599–600
authentication server, 160–161
authentication spoofing, 151
authorization
AAA configuration for router security,
531–532
configuration for switch, 558
MC for IPS Sensors,A:40
Autodiscovery, 493–497
automatic time synchronization, 639–640,
674–676
Automatic Update (AU), Microsoft,
625–626
autonomous system number. See AS
(autonomous system) number
autonomous systems (ASs), 509
auxiliary ports, 523–525
availability
CIA component, 9
of Cisco Catalyst 6500, 552, 553
Internet connection for Windows DMZ,
61–62
with PIX/ASA firewalls, 209
with three-legged firewall, 210
. See also confidentiality, integrity,
availability; high availability
AVC (Access Vector Cache), 680
B
B2B (business-to-business), connecting with
VPN, 605–610, 612
Back Officer Friendly (BOF),A:19
Back Track,A:174–A:175
backup
disabling for vulnerability scanning,
A:146
for Nokia appliance configuration,
376–377
Secure Platform utility for, 364
of Solaris DMZ servers, 120
of Web server,A:184
bandwidth, 49
banner login command, 522–523, 559
Basic Analysis and Security Engine (BASE)
activation of,A:78
alert database management,A:87–A:90
alert groups,A:84–A:86
configuration of,A:78–A:80
features of,A:72–A:73
graphical features of,A:86–A:87
installation of,A:73–A:78

704
Index
querying database,A:82–A:84
security of,A:80
using,A:81–A:82
Basic Security Module (BSM), 119–120
Bastille-Linux
for script hardening, 681–682
for Web server hardening,A:27
bastion host
definition of, 12
DMZ configuration with, 15–16
hardening Windows DMZ, 82
networks with/without DMZ, 20–21
securing/hardening, 22
traffic flow and, 17, 18–19
Web servers for Windows DMZ, 73–74
. See also Linux bastion hosts
Bellovin, Stephen, 26
Berkeley Internet Name Domain (BIND)
attacks,A:157–A:159
DMZ server security and, 117
for DNS server protection,A:23,
A:24–A:26
DNS spoofing attacks and,A:162
security,A:160–A:161
Berkeley Software Distribution (BSD),A:200
Bernstein, Dan,A:71
best-practice checklist, wireless DMZ,
165–166
BGP. See Border Gateway Protocol
BGP Case Studies document (Cisco), 509
BGP TTL Security Hack (BTSH), 515–516
BIND. See Berkeley Internet Name Domain
blacklisting, 99
Blahot worm,A:91
Bleeding Edge Snort,A:18
blocking,ActiveX/Java, 295–296
Bluesocket WG-2000 Wireless Gateway, 161,
163
BOF (Back Officer Friendly),A:19
Boolean logic,A:91,A:93
bootp server, 543
Border Gateway Protocol (BGP), 509–516
attributes of, 510–511
features of, 509–510
NetScreen, 417–418
reset session, 576
for routers, 507–508
routing decisions, 511–512
securing, 512–516
to send/receive routing updates, 508
boundary isolation, 642
broadcast, 539–540
BSD (Berkeley Software Distribution),A:200
BSM (Basic Security Module), 119–120
BTSH (BGP TTL Security Hack), 515–516
buffer overflow
database software vulnerabilities,A:147
description of,A:5,A:160
Solaris exploit,A:171–A:172
against SQL server,A:163–A:164
Windows services vulnerabilities,
A:142–A:143
Business Edition, Cisco ASA firewall, 222, 223
business partner connections
DMZ design and, 35
VPN services, 590–591
business-to-business (B2B), connecting with
VPN, 605–610, 612
C
C compiler, 144
cable
Active/Active stateful failover with,
293–294
Active/Passive stateful failover with,
288–291
failover requirements, 287
for PIX/ASA failover, 285–286, 287
cache poisoning, DNS,A:159,A:162
Cain & Able,A:141
CatOS, 544–545, 546
CDP, 560
CDP (Cisco Discovery Protocol), 537–538
CD-ROM, 666–667, 702
Center for Internet Security,A:201
central processing unit (CPU), 541
CERT Advisory CA-2002-15,A:159
CERT Advisory CA-2002-19,A:159
certificate, 191–193
certification authority, 192
chains, 685–686
chargen service, 540–541
Chart Period parameter,A:87
Chart Type parameter,A:87
chat clients, Internet, 99–100
Check Point
configuration in Secure Platform
configuration, 361–363
cpconfig utility, using, 379–381
installation on Nokia appliance, 378–379
Check Point FireWall-1
high availability with, 112–114
overview of, 109–111
Check Point firewalls
address translation rulebase configuration,
333–335
Check Point NG DMZ checklist, 350
choice of right solution, 318–319
configuration of, 325–329
DMZ configuration, 323–325
features of, 316–317
higher-level protections, 320–321
management architecture, 319–320
network/application protections, 335–350
operating system selection for, 316–317
securing network perimeters, 321–323
security rulebase configuration, 330–333
stateful inspection, 320
Check Point NG DMZ checklist, 350
Check Point NGX, 109–111
Check Point restricted shell (CPShell), 360
Check Point Secure Platform
choice of right option, 357
configuration of, 357–363
cpconfig utility, using, 379–381
features of, 356
maintenance of, 363–365
overview of, 382–383
Check Point SmartDashboard. See
SmartDashboard, Check Point
Check Point Software Safe@Office, 319
Check Point VPN-1/FW-1, 593
checklist
bastion hosts, 660
Check Point NG DMZ, 350
defense in depth,A:114–A:115
DMZ hardening,A:173
Linux bastion hosts, 699
Nokia firewall/DMZ design, 381
PIX/ASA firewall design/configuration,
308–309
router/switch security, 571–572
WLAN security best-practices, 165–166
checksum,A:203
chkconfig, 670
CIA (confidentiality, integrity, availability)
description of, 8–9
network security, planning, 3–5
CIS Apache Benchmark (Center for Internet
Security),A:201
Cisco
BGP Case Studies document, 509
Dell and, 605–606
extended ACL link, 518
hardware for Windows DMZ, 49, 50–51
LEAP with RADIUS, implementation of,
172–176
VPN services of, 594–597
Cisco 3725 router, 53
Cisco 3745 router, 53
Cisco ACU, 184, 187–188
Cisco Adaptive Security Device Manager,
233, 247–248
Cisco Aironet AP, 175
Cisco ASA 5505 firewall, 224
Cisco ASA 5510 firewall, 225
Cisco ASA 5520 firewall, 225–226
Cisco ASA 5540 firewall, 226–227
Cisco ASA 5550 firewall, 227–228
Cisco ASA (Adaptive Security Appliance)
firewall
access rules, configuration of, 269–278
ActiveX/Java, blocking, 295–296
application inspection, 299–306
ASA/PIX 7.x firewall software features,
230–231
Cisco Adaptive Security Device Manager,
233
content filtering, 296–297
cut-through proxy, 297–298
design/configuration checklist, 308–309
failover services, 285–295
features of, 208–209
FloodGuard, DNSGuard, 307
interfaces, defining, 251–257
intrusion detection, 306–307
licensing, 235
management of, 243–250
NAT configuration, 258–269
network perimeters, securing, 209–215
overview of, 310–313
PIX/ASA version 7.2, 236–237
routing, 278–282
security contexts, 282–285
SNMP/NTP, securing, 307–308
software features, 228–231
SSM options, 239–240
versions/features, 222–228
VPN services of, 595–596
Cisco ASDM Launcher, 248
Cisco Catalyst 2960, 546–547
Cisco Catalyst 3560, 547–548
Cisco Catalyst 3750, 550–551
Cisco Catalyst 4500, 551–552
Cisco Catalyst 6000 IDS module,A:14
Cisco Catalyst 6500, 552–554
Cisco Catalyst Express 500, 546
Cisco Catalyst switch model line, 544
Cisco CatOS (COS) switch,A:13
Cisco Discovery Protocol (CDP), 537–538
Cisco Easy VPN, 596–597
Cisco IOS
for Cisco switches, 545
port mirroring/span,A:13
VPN services of, 594–595
Cisco IOS Software Modularity, 553
Cisco IPS Management Center
installation of,A:33–A:43
need for,A:29–A:30
overview of,A:100–A:101
protection from DoS,A:104
reports,A:61–A:67
sensor configuration files,A:57–A:60
sensors, sensor groups of,A:43–A:51
server, administering,A:67–A:70
signatures/alarms, configuration of,
A:52–A:57
tools of,A:30–A:33
Cisco IPS Management Center, installation of
authorization roles,A:40
CiscoWorks Common Services
architecture,A:34–A:37
client requirements,A:37–A:38
getting started,A:39
installation verification,A:40–A:41
MC for IPS Sensors,A:43
server hardware requirements,A:34
steps of,A:38–A:39
users, adding to CiscoWorks,A:41–A:42
VMS component compatibility,A:37
VMS software suite,A:33
Cisco LEAP, 178–182
Cisco MC for IPS Sensors server
database rules,A:67–A:69
e-mail server settings,A:69–A:70
sensor software/signatures, updating,A:69
Cisco Monitoring Center for Security,A:30
Cisco PIX 7.0, 216
Cisco PIX 501 firewall, 216–217, 232
Cisco PIX 506E firewall, 217–218, 232
Cisco PIX 515 firewall, 313–314
Cisco PIX 515E firewall
failover and, 313–314
features of, 218–219
interface configuration, 252
PCI card installation on, 238–239
Cisco PIX 525 firewall, 220–221
Cisco PIX 535 firewall, 221–222
Cisco PIX Device Manager
Adaptive Security Device Manager and,
233
configuration of, 246–247
function of, 232
Cisco PIX OS 6.x 
AAA configuration for, 250
access rules for PIX/ASA, 269–274
application inspection configuration, 299
cut-through proxy, 297–298
failover with failover cable, 289–290
inbound NAT configuration, 265
interface configuration, 253–254
interface configuration verification,
255–257
NAT configuration, 259, 260, 261
RIP for, 281
Cisco PIX OS 6.3, 236
Cisco PIX OS 7.x 
AAA configuration for, 250
access rules for PIX/ASA, 269–274
application inspection configuration, 299,
300–306
failover with cable, 290–291
inbound NAT configuration, 265
interface configuration, 254–255
interface configuration verification,
255–257
NAT configuration, 259, 260, 261
time-based ACLs in, 274–276
Cisco PIX (Packet Internet Exchange) firewall
access rules, configuration of, 269–278
ActiveX/Java, blocking, 295–296
application inspection, 299–306
ASA/PIX 7.x firewall software features,
230–231
Cisco PIX Device Manager, 232
content filtering, 296–297
cut-through proxy, 297–298
design/configuration checklist, 308–309
failover services, 285–295
features of, 208–209
FloodGuard, DNSGuard, 307
interfaces, defining, 251–257
intrusion detection, 306–307
licensing, 233–235
NAT configuration, 258–269
overview of, 310–313
PCI card options, 237–239
PIX/ASA 7.x security contexts, 282–285
PIX/ASA version 7.2, 236–237
routing, 278–282
securely managing, 243–250
securing network perimeters, 209–215
SNMP/NTP, securing, 307–308
software features, common, 228–230
version 6.3, 236
versions/features, 215–222
VPN services of, 595–596
Cisco PIX/ASA 7.x 
failover services, 285
PIX/ASA cut-through proxy, 298
RIP for, 281–282
security contexts, 283–285
Cisco PIX/ASA, configuration of, 251–282
access rules, 269–278
interfaces, defining, 251–257
NAT, 258–269
routing through PIX, 278–282
Cisco PIX/ASA firewalls
access rules, configuration of, 269–278
ActiveX/Java, blocking, 295–296
application inspection, 299–306
ASA firewall software features, 231
ASA firewall SSM options, 239–240
ASA firewalls, versions/features, 222–228
ASA/PIX 7.x firewall software features,
230–231
Cisco Adaptive Security Device Manager,
233
content filtering, 296–297
cut-through proxy, 297–298
design/configuration checklist, 308–309
DMZ design/planning, 240–243
failover services, 285–295
FloodGuard, DNSGuard, 307
interfaces, defining, 251–257
intrusion detection, 306–307
licensing, 233–235
NAT configuration, 258–269
network perimeters, securing, 209–215
overview of, 310–313
PIX, securely managing, 243–250
PIX Device Manager, 232
PIX firewall PCI card options, 237–239
PIX firewall version 6.3, 236
PIX firewalls, versions/features, 215–222
PIX/ASA 7.x security contexts, 282–285
PIX/ASA version 7.2, 236–237
routing, 278–282
SNMP/NTP, securing, 307–308
software features, common, 228–230
VPN services of, 595–596
Cisco PIX/ASA OS 7.2, 236–237
Cisco Product Security Advisories and
Notices page, 570–571
Cisco proprietary high-speed cable
Active/Active stateful failover with,
293–294
Active/Passive stateful failover with,
288–291
for failover, 287
Cisco routers
access control lists, 516–522
best-practice checklist, 571–572
Border Gateway Protocol, 509–516
configuration for security, 523–537
consistent configuration of, 504
disabling unneeded IOS features, 537–543
IO bugs, security advisories, 570–571
other security features, 543–544
router placement in DMZ environment,
504–509
security banner, 522–523
. See also router security

Index
705
Cisco Secure Access Control Server (ACS),
250
Cisco Security Agent, 116,A:22
Cisco Security Monitor. See Security
Monitor, Cisco
Cisco Security Wheel,A:32–A:33
Cisco StackWise technology, 550–551
Cisco switches
Catalyst 2960, 546–547
Catalyst 3560, 547–548
Catalyst 3750, 550–551
Catalyst 4500, 551–552
Catalyst 6500, 552–554
Catalyst Express 500, 546
development of, 544–545
IDS sensor, port mirroring/span for,
A:12–A:13
management of, 554–559
Cisco’s Technical Assistance Center (TAC),
244, 524
CiscoWorks Common Services
for compatibility,A:37
components of,A:34,A:35
CiscoWorks VPN and Security Management
(VMS) Suite
architecture,A:34–A:37
component compatibility,A:37
components of,A:33
installation verification,A:40–A:41
for large number of PIX firewalls, 232
login,A:39
management of IPS sensors,A:30
for monitoring multiple firewalls, 247
server hardware requirements,A:34
users, adding,A:41–A:42
class-map command, 300–301
cleanup rule, 99
clear command, 249
clear ip bgp command, 576
clearxlate command, 269
CLI. See command-line interface
client mode, VTP, 560
clients
IPS Management Center system
requirements for,A:37–A:38
Web proxy on edge ISA firewall, 493–497
wireless, in LEAP configuration, 183–186
clients, network
corporate, connecting to network services
segment/Internet, 501
Firewall client, installing on, 499–501
Firewall client share, installing on services
segment file server, 497–498
joining to domain, 490
routing table entry, 490
CLISH
for Nokia appliance configuration,
375–376
for OS installation, 377–378
clocks, 536–537
cloud, 582
clusters
with Check Point, 112–114
Check Point firewall, 324
NSRP, 418
in Windows DMZ design, 59–60
ClusterXL module, 112, 113–114
code
security of,A:4–A:5
Web-based,A:185,A:198
COM port, 243–244
Command Line Reference Guide (Nokia),
376
command-line interface (CLI)
accessing in Secure Platform, 360
bastion hosts and, 650–652
CLISH for Nokia appliance configuration,
375–376
for interface/zone binding, 403
for IP address assignment, 403
NetScreen, advantages of, 431
for NetScreen management, 396
for security policy configuration, 405
for static routing, 404, 414
commands, 243, 531
Common Criteria EAL4 certification, 229
common vulnerabilities and exposure (CVE),
102,A:82
communications, 450–454
community attribute, 511
community port, 566
community strings, 532, 533
compatibility, of VMS components,A:37
components
bastion host, 627–628
Linux bastion hosts, 668–673, 700
of wireless DMZ, 158–162
Computer Oracle and Password System
(COPS), 126
confidentiality, integrity, availability (CIA)
description of, 8–9
network security, planning, 3–5
configuration
of Apache Web server,A:198
of BASE,A:78–A:80
NetScreen, 398–399, 430–431
of NetScreen security policies, 405–408
OSPF, 416–417
RIP, 415–416
of secure OS,A:200
configuration, Sun Solaris DMZ
backup, 120
default system settings, assessment of,
121–122
disk layout, 118–119
local auditing verbosity, increasing,
119–120
local file permissions, auditing, 124–126
local security, layering, 122–124
model, building for future use, 127–128
overview of, 117
remote administration, 120–121
configuration files, IPS sensor
approval of,A:58–A:59
deployment of,A:59–A:60
generation of,A:58
review of,A:57–A:58
configuration traffic, 291–293
config-vlan mode, 561, 562
connection limits, 261, 267–268
connectivity
B2B connection with VPN, 605–610
monitoring by sensors,A:44
router configuration for security, 523–528
console, NetScreen, 396–397
Console Notification Report,A:62
console port
Cisco PIX/ASA access via, 243–244
configuration for router security, 523–525
for Nokia appliance configuration, 371
of switch, configuration of, 555–556
content filtering
of ASA firewall software, 231
of PIX/ASA, 229, 296–297
COPS (Computer Oracle and Password
System), 126
Corpnet clients
file server file shares access, 470–472
network services access rules for, 459–461
OWA publishing rule on perimeter ISA
firewall, 461–466
SMTP/POP3/IMAP4 server publishing
rules, 466–469
Corpnet hosts
all open rule for authenticated users,
480–481
controlling outbound traffic from,
477–478
Microsoft Update/Error Reporting sites
access rule, 481–484
outbound DNS from DNS server access
rule, 478–480
Corpnet network
creating on ISA firewall network, 446–447
default internal network and, 448–449
corporate network
client connections, 501
on network services perimeter, 445
network services segment, route between,
447–449
VPN termination at firewall, 583
cost, network penetration,A:111,A:112
cpconfig utility
overview of, 383
on security gateways, 380–381
on SmartCenters, 379–380
CPShell (Check Point restricted shell), 360
CPU (central processing unit), 541
crypto key generate rsa command, 245, 526
CSC-SSM
ASA firewall support of, 231
features of, 239
license of Cisco ASA firewall, 235
CSI/FBI Computer Crime and Security
Survey 2005,A:112
Cult of the Dead Cow web site,A:160
custom filters,A:90–A:94
customer-based sites, 35–36
cut-through proxy
of PIX/ASA, 229, 314
PIX/ASA, configuration of, 297–298
CVE (common vulnerabilities and exposure),
102,A:82
Cygwin, 650–652
Cygwin/X, 693
D
daemon, syslog, 688
daemon tools,A:71
Damn Small Linux,A:174
data
choice of IDS and,A:7
network data visibility risks, 79
risks to, identification of, 6–7
transmission, DMZ design and, 24
Data Source parameter,A:87
database
alert database management,A:87–A:90
for BASE,A:74
BASE, querying,A:82–A:84
configuration for BASE installation,
A:77–A:78
software vulnerabilities of,A:147–A:148
SQL attacks, hacks,A:163–A:167,
A:178–A:179
database rules
adding,A:67–A:68
deleting,A:69
editing,A:68–A:69
viewing,A:69
daytime service, disabling, 540–541
DC. See domain controller
dedicated appliances, for Secure Platform, 357
default administrative password, for WDMZ,
165
default command, 275
default gateway, LAN, 63, 64, 65
default route, 506–509
default settings, IIS servers,A:145–A:149
defense in depth
checklist,A:114–A:115
description of, 9,A:113–A:115
definitions, DMZ, 11–13
deleting
database rule,A:69
generated reports,A:63–A:64
sensor from sensor group,A:50–A:51
sensor subgroups,A:51
Dell Computer Corporation, 606
demilitarized zones (DMZs)
advanced risks, 34–36
Check Point, configuration of, 323–325
Cisco PIX/ASA firewalls for, 208–209
Cisco PIX/ASA, perimeter security with,
209–215
concepts, 14–17
defense for,A:110
definition of, 12
definitions, 11–13
design fundamentals, 22–34
design strategies, advanced, 36–39
design/planning, 240–243
dual-firewall DMZ infrastructure, 214–215
hardening checklist,A:173
honeypot deployment,A:18–A:21
IDS sensor in,A:10
multi-DMZ with physical interfaces,
212–213
multi-DMZ with virtual interfaces,
213–214
network mapping,A:129–A:139
networks with/without, 20–22
overview of, 40–42
planning network security, 3–11
reasons for, 2
router placement in DMZ environment,
504–509
router/switch security for, 504
screened subnet vs., 42
servers, multiple, 143
services to secure,A:135–A:136
traffic flow concepts, 17–20
VLAN design in, 563–565
VLAN Trunking Protocol and, 560–561
demilitarized zones (DMZs), attacks on
BIND security,A:160–A:161
coverage of,A:111
DMZ hardening checklist,A:173
DNS exploits,A:155–A:160
DNS spoofing attacks,A:161–A:162
e-mail attacks, hacks,A:167–A:170
overview of,A:178–A:179
Solaris exploit,A:171–A:172
SQL attacks, hacks,A:163–A:167
Web site resources for,A:172–A:173
Denial-of-service (DoS)
ACL configuration to prevent, 521–522
attacks, types of, 150
directives in httpd.conf file configuration,
A:209
MC for IPS Sensors and,A:104
PIX/ASA FloodGuard protection, 307
risks to services, 7
small services attacks, 541
smurf attacks, 539
on wireless network, 151–153
deny statement, 516
deployment
of IDS,A:11–A:17
of IPS sensor configuration files,
A:59–A:60
deployment models, VPN, 580–585
DES (Digital Encryption Standard), 599
design
perimeter network, 443–444
of wireless DMZ, 156–158, 168
design, DMZ, 22–34
advanced risks and, 34–36
advanced strategies, 36–39
DMZ configurations, 14–17
end-to-end protection, 24
importance of, 22–23
networks with/without DMZ, 20–22
OSI model, 28–32
overview of, 41–42
ports, 26–28
public/private IP addressing, 26
TCP/IPv4 flaws and, 25–26
traffic flow concepts and, 17–20
traffic flow/protocol fundamentals, 24–25
traffic/security risks, 32–34
. See also Windows DMZ design
Destination NAT
description of, 409, 412
policy-based, 413–414
VIP, 412–413
DHCP. See Dynamic Host Configuration
Protocol
dialup phone lines
probing analog connections,A:150–A:151
remote access services with, 591
VPN connection vs., 578
war dialing,A:151–A:154
dictionary attacks, 176
Diffie-Hellman group, 602
dig command,A:155–A:157
dig utility,A:25–A:26
Digital Encryption Standard (DES), 599
Dik, Casper, 126
DIP (dynamic IP) pool, 411–412, 433
directed broadcast, 539–540
directives, httpd.conf file configuration,
A:206–A:214
<Directory> directive,A:211–A:212
disabling
HTTP server on switch, 557
switch IOS features, 559–560
unneeded router IOS features, 537–543
Web server unneeded services,A:27
discard service, 540–541
discontinued appliances, Nokia, 367–368
disk layout, for Solaris DMZ servers, 118–119
disk partitions
bastion hosts and, 624–625
Linux bastion host, 665
diskettes, running Linux from, 667
diskless platforms, of Nokia, 365–366
distributed installation, for Check Point
DMZ, 384
distribution media, Linux, 665–667
djbdns service,A:24–A:25
DMCA,A:141
DMZs. See demilitarized zones
DNS. See Domain Name Service
DNS Security Extensions (DNSSEC), 102
DNSGuard, 307
DNSSEC (DNS Security Extensions), 102
documentation, 10–11
domain
authentication with LEAP/RADIUS,
186–188
isolation, with bastion hosts, 640–644
isolation with IPSec, 67
Windows DMZ design considerations,
59–60
domain controller (DC)
in DMZ design, 33
Read-Only Domain Controller, 83
in Windows DMZ design, 59–60
domain members, 623–624
Domain Name Service (DNS)
cache poisoning,A:159

706
Index
creating DNS entries, 490–493
firewall rules for public networks, 102
outbound for DNS server access rule,
478–480
private network firewall rules and, 99, 101
on private networks, 143–144
server publishing rule, 450, 454–456
weakness of, 25
whois lookup and,A:123–A:124
Domain Name Service (DNS) exploits
BIND attacks,A:157–A:159
BIND security,A:160–A:161
buffer overflow attack,A:160
dig command,A:155–A:157
DNS spoofing attacks,A:161–A:162
overview of,A:178
Domain Name Service (DNS) server
access rule for, 456–458
configuration of, 697–698
DNS exploits,A:155–A:162
hardening,A:24–A:26
name resolution for Windows DMZ,
71–72
port assignment for, 79
of Windows DMZ, 74–75, 89
domain user account, 186–188
domains
bastion host, isolation of, 640–644
joining edge ISA firewall to, 476–477
DoS. See Denial-of-service
downloads
of Apache Web server software,A:202
SBR installation package link, 178
. See also Web site resources
drive-by spamming, 150
drop-in mode, 401
duplex settings, PIX/ASA interface, 254,
255–256
Dynamic Host Configuration Protocol
(DHCP)
administrative access hosts and, 103–104
PIX/ASA software features, 229
WLAN security and, 148
dynamic IP (DIP) pool, 411–412, 433
Dynamic NAT, 260, 262–264
Dynamic PAT, 262
dynamic routing
OSPF for PIX/ASA, 282
purpose of, 432
RIP for PIX/ASA, 280–282
dynamic WEP keys, 174
dynamic-secure MAC address, 569–570
E
Eagle X,A:70–A:71
EAP. See Extensible Authentication Protocol
EAP-Cisco Wireless. See LEAP
EAP-FAST (Flexible Authentication via
Secure Tunneling)
function of, 173
for WDMZ, 157
in wireless DMZ example, 163
eap.ini file, 179–180, 186
EAP-TLS, 157
EAP-Tunneled TLS, 158
eavesdropping
passive attacks on wireless network,
147–150
wireless network protection, 169–170, 205
eBG multihop, 515
echo messages, 539
echo replies, 521
echo service, disabling, 540–541
e-commerce services
DMZ design and, 36
internal/external firewall design for,
214–215
SQL attack on,A:164
on Windows DMZ, 55
Windows DMZ design and, 91
edge ISA firewall
Corpnet/network services hosts, outbound
access rules, 477–484
on default internal network, 472–475
Exchange server services, inbound
connections to, 484–489
firewall/Web proxy clients, configuring
on, 493–497
joining to domain, 476–477
routing table entry, creating on, 475–476
edge router, 581, 582, 607
editing
database rule,A:68–A:69
report parameters,A:64
egress filtering, 269, 271–272
electromagnetic shielding, 156
e-mail
attacks, hacks,A:167–A:170,A:179
blocking file attachments,A:180
mail relaying,A:180
open relays, blacklist of,A:179–A:180
e-mail relay,A:168,A:169–A:170
e-mail server
securing with IDS,A:28–A:29
settings,A:69–A:70
on Windows DMZ, 88
Windows DMZ mail services, 72–73
e-mail services
DMZ design and, 36
Windows DMZ mail services, 72–73
embryonic limit, 261, 267, 268
enable password
configuration for router, 528–530
for switch, 558
enable password command, 528, 558
enable secret command, 528–529, 530
Encapsulating Security Payload (ESP),
599–600
encryption
HTTP for Web site security, 658
IPSec encryption scheme, 599–600
for IPSec negotiation policies, 601, 603
for passive attack protection, 147–148
of router password, 529–530
for Terminal Services, 646
with VPN, 582
for WDMZ, 165
for wireless network protection, 170
encryption key, 599
encryption license, 235
end-of-sale (EOS) policy, 367
endpoint devices, VPN, 589–590
end-to-end security, 24
Enterprise Edition, Cisco ASA firewall, 222
enterprise resource planning (ERP) packages,
35
enterprise wireless gateway (EWG), 161,
163–164
environments, restrictive, 124
EOS (end-of-sale) policy, 367
ERP (enterprise resource planning) packages,
35
ESP (Encapsulating Security Payload),
599–600
Essentials Support, Nokia, 371
Ethereal, 150
Ethernet cards, 107–108
Ethernet device, 359
Ethernet interfaces, 361, 372–373
Etherpeek
custom filter in,A:91–A:93
trace of scan,A:128
Unicode attack capture,A:16
event logging
configuration for servers, 634–635
NTP clock synchronization for, 536–537
syslog configuration for router security,
534–535
EWG (enterprise wireless gateway), 161,
163–164
Exchange RPC, 486–489
exemption lists, 642
exploitation,A:29
exporting, reports,A:63
extended ACL, 517–519
Extensible Authentication Protocol (EAP)
IAS server wireless policy, 199–200
LEAP with RADIUS, implementation of,
172–176
RADIUS server with, 161
for WDMZ, 157–158
external DNS server, 74, 75
external firewall, 214–215
external router, 67–68
external Web server, 74
extranets, 35, 606–608
F
failover
Active/Active stateful failover with cable,
293–294
Active/Active stateful LAN-based,
294–295
Active/Passive stateful failover with cable,
288–291
Active/Passive stateful LAN-based,
291–293
cause of, 286–287
of Cisco PIX/ASA 7.x, 231
DMZ servers and, 118
in multi-DMZ infrastructure, 213
PIX/ASA failover services, 285–286
PIX/ASA firewall software features, 229
requirements, 287–288
stateful failover with PIX/ASA, 210–211
testing/monitoring, 295
failover, NetScreen
description of, 418–419, 423
determining time for, 422
firewall virtualization, 419–420
NSRP, full, 422–423
NSRP cluster, 421–422
NSRP states, 420–421
stateful, configuring, 423–426
failover active command, 295
failover license, of Cisco PIX firewall, 234
failover polltime command, 286
false alarms,A:105
false positives
false alarms, minimizing,A:105
of IDS sensor,A:17
tuning signatures and,A:55
Faraday cage, 170
feature license, Cisco PIX/ASA firewall,
234–235
Federal Express Tracking System, 606
federation agreement, 58
Fedora Core 5
Linux component removal with, 668–670
package management with, 672
file access control lists, 123
file attachments, blocking,A:173,A:180
file permissions, 124–126
file replication, 650
file server, 470–472
file system, 118, 638
File Transfer Protocol (FTP)
application inspection, 299
filtering for PIX/ASA, 297
PIX/ASA cut-through proxy, 297–298
server, 695–696
sites, DMZ design and, 35–36
weakness of, 25
filter actions, 642
filter lists, 642
filtering
content filtering with PIX/ASA, 296–297
custom filters for IDS,A:90–A:94
inbound ACL for PIX/ASA, 272–274
IP filters for IPSec, 605
outbound ACL for PIX/ASA, 271–272
with PIX/ASA firewall, 229, 230, 231
with second firewall, 5
FIN scan
cache poisoning,A:162
description of,A:127
trace of scan,A:128
finger service, 541
Finisar,A:13
Firestarter, 686
firewall
choice of, 208
configuration for DMZ, 4–5
configuration for security,A:2
configuration of Check Point, 325–329
configuration of Windows Firewall,
A:188–A:190
defense in depth and,A:113–A:114
definition of, 12
in DMZ configurations, 14–17
in DMZ design, 29–30
DMZ network designs, 20–22
e-mail server behind, 72–73
for end-to-end security, 24
enterprise wireless gateway as, 161
extra DMZ routers and, 70–71
hardening on DMZ server, 144
for IAS server, 201
IDS and,A:4
IDS deployment and,A:14–A:15
IP filter, 114–115
Netfilter, 685, 702
NetScreen, management of, 396–398
for network security,A:3
port numbers and, 78
router placement in DMZ, 505–506
Secure Platform, 357–365
Secure Platform, Nokia IPSO for, 356
security policy-based DMZ, 69–70
for Solaris DMZ servers, 109–111
SQL security design,A:163–A:164
traffic flow concepts and, 17–20
for traffic management, 46
VPN termination at, 583, 613
for WDMZ, 156, 161
for Windows DMZ, 68–69, 87
Windows DMZ design, 60
. See also Check Point firewalls; ISA
Server 2005, firewall/DMZ
design; Juniper NetScreen
firewall, Cisco PIX and ASA
access rules, configuration of, 269–278
ActiveX/Java, blocking, 295–296
application inspection, 299–306
ASA firewall software features, 231
ASA firewall SSM options, 239–240
ASA firewalls, versions/features, 222–228
ASA/PIX 7.x firewall software features,
230–231
Cisco Adaptive Security Device Manager,
233
content filtering, 296–297
cut-through proxy, 297–298
design/configuration checklist, 308–309
DMZ design/planning, 240–243
failover services, 285–295
features of, 208–209
FloodGuard, DNSGuard, 307
interfaces, defining, 251–257
intrusion detection, 306–307
licensing, 233–235
NAT configuration, 258–269
PIX, securely managing, 243–250
PIX Device Manager, 232
PIX firewall PCI card options, 237–239
PIX firewall version 6.3, 236
PIX firewalls, versions/features, 215–222
PIX/ASA 7.x security contexts, 282–285
PIX/ASA version 7.2, 236–237
routing, 278–282
securing network perimeters, 209–215
SNMP/NTP, securing, 307–308
software features, 228–230
Firewall client, 499–501
Firewall client share, 497–498
Firewall Edition, 222
firewall ruleset, Sun Solaris DMZ
overview of, 98–99, 141
private network, 99–101
public network, 101–103
server, 103–104
FixModes, 126
fixup command, 299–300
Flexible Authentication via Secure Tunneling.
See EAP-FAST
FloodGuard, 307
flooding
NAT configuration and, 261, 267–268
on wireless network, 151–153
Fluxbox, 674
footprinting
definition of,A:111
vulnerability testing as,A:180–A:181
Foundstone,A:174
fping,A:138
frame cloud, 65
Frame Relay, 53, 582
FTP. See File Transfer Protocol
Funk. See Juniper Networks
fwunloadlocal command, 328
G
GD library,A:77
General Routing Encapsulation (GRE)
tunnels, 548–550
getfacl command, 123
global command, 262–263
Global group,A:45
global IP address, 262
global policies, NetScreen, 405
Gnome, 674
GPOs (Group Policy Objects), 641
Graphical User Interface (GUI)
Adaptive Security Device Manager, 233,
247–248
PIX Device Manager, 232, 246–247
for remote administration of Linux, 693
graphing, alerts,A:86–A:87
GRE (General Routing Encapsulation)
tunnels, 548–550
group, 198
group account,A:201–A:202
Group Policy
for IAS server configuration, 201–202
restricted, 635–636
Group Policy Objects (GPOs), 641
groups, isolation, 642–644
group-specific server isolation, 641
GUI. See Graphical User Interface
H

Index
707
Hack Proofing Windows 2000 Server
(Syngress), 47
hackers
auditing/logging evasion,A:149–A:150
cost of network penetration,A:112
firewall misconfiguration and,A:2
identification of potential threats, 8
tools for DMZ attacks, 90
Web server hardening and,A:27
. See also attacks; testing the DMZ
Hackme example sites,A:174
handshake
SYN scan handshake,A:126–A:127
TCP/IP three-way handshake,A:9
hardening
bastion hosts, 102
coverage in book, 46
Microsoft IIS Web Server,A:191–A:194
hardening, Solaris system
automated, 137–139
checklist, 139, 142
manual, 132–136
overview of, 131–132
hardware
for Check Point firewall, 317
Check Point NGX R61, 110–111
for Cisco LEAP solution, 175
requirements for CiscoWorks VMS,A:34
for Secure Platform, 357
Sun platform, OSs supported by, 94
for Sun Solaris DMZ, 105–108
for Windows DMZ, 49–52, 86, 90–91
Hardware Compatibility list, Secure Platform,
357
hashing algorithm, 601, 603
heartbeats, 285–286, 291–293
hex editor,A:141
HIDS. See Host-Based Intrusion Detection
System
high availability
Check Point clusters and, 112–114
Internet connection for Windows DMZ,
61–62
IP filter firewall, 114–115
Nokia appliance configuration for, 384
NSRP and, 418
Solaris 10, security features of, 115
Solaris DMZ server, 111–112
Sun Cluster, 116
Veritas Cluster Server, 115
in Windows DMZ design, 48, 49
high-security policy, 638–639
high-speed serial cable
Active/Active stateful failover with cable,
293–294
Active/Passive stateful failover with,
288–291
for failover services, 285–286, 287
hijacking, wireless network, 153–155
Honeynet Project,A:4
honeypot
definition of, 13
in DMZ,A:19–A:21
DMZ deployment of,A:18–A:19
function of,A:4
MC for IPS Sensors and,A:104–A:105
in mixed NIDS/HIDS deployment,
A:95–A:96
Honeypot Project,A:18
hops, 515–516
host
assessment, 641
IPSec negotiation policy option, 603–604
network security, 130
new host, 330–331
host security software, for Solaris DMZ
servers, 116
Host-Based Intrusion Detection System
(HIDS)
characteristics of,A:6
data sources and,A:7
functions of,A:21–A:22
mixed NIDS/HIDS deployment,
A:94–A:96
for Solaris system hardening, 138–139
Tripwire,A:23–A:24
hosting, Web/FTP sites, 35–36
hostname, Secure Platform configuration, 360
hot fixes, 625–627
htpasswd file, 211
HTTP. See Hypertext Transfer Protocol
http server enable command, 246
httpd.conf file,A:206–A:214
HTTPS (Hypertext Transfer Protocol Secure
sockets), 297, 527–528
HTTrack Website Copier,A:4
hub, 555
hub-and-spoke topology, 587
Hunt Freeware sniffer,A:141
Hypertext Preprocessor (PHP)
application vulnerabilities,A:146–A:147
for BASE installation,A:76
Hypertext Transfer Protocol (HTTP)
PIX/ASA cut-through proxy, 297–298
weakness of, 25
Hypertext Transfer Protocol (HTTP) server
ASDM and, 248
disabling for router security, 527–528
disabling HTTP server on switch, 557
PIX Device Manager and, 246, 247
Hypertext Transfer Protocol Secure sockets
(HTTPS), 297, 527–528
I
IANA (Internet Assigned Numbers
Authority), 90, 258
IAS (Internet Authentication Service) server,
160, 195–202
IBM,A:149
ICANN (Internet Corporation for Assigned
Names and Numbers), 76
IceWM, 674
ICMP. See Internet Control Message Protocol
IDS. See Intrusion detection system
IEEE (Institute of Electrical and Electronics
Engineers), 173
IEEE 802.1q VLANs, 384
IEEE 802.1x protocol
authentication with WEP keys, 174
definition of, 161, 173
with LEAP, 172
RADIUS server and, 160
for WDMZ, 157
IEEE 802.11 protocol, 151, 152
IETF Security Working Group, 613
IIS server. See Internet Information Service
(IIS) server; Microsoft IIS Web
Server
IISLockdown,A:191
IKE (Internet Key Exchange), 601–602, 613
IMAP4
server publishing rule, 466–469
server publishing rules, creating secure,
486–489
implementation phase, DMZ server, 104–105
implicit rule, 99
in-band management, 38, 42–43
inbound ACL
for PIX/ASA, 272–274
tips on, 277–278
inbound NAT, 264–268
inbound policy, 407–408
information gathering
network mapping,A:129–A:139
selection of target,A:117
social engineering,A:124–A:125
tasks of,A:117–A:119
whois lookup,A:119–A:124
ingress filtering
inbound ACL for PIX/ASA, 272–274,
277–278
PIX/ASA access rules, 269
ingress Internet-facing router, 519–522
initialization vector (IV)
changes with LEAP, 174
WEP insecurity and, 205
WEP key weakness with, 175
Inside2DMZ command, 264
inspect command, 299, 305
inspection ports, 302–304
installation
of BASE,A:73–A:78
of Cisco IPS Management Center,
A:33–A:43
of PCI card on PIX firewall, 238–239
of Secure Platform, 357–359
of SSM card on ASA firewall, 239–240
of Steel-Belted RADIUS, 178–182
installation, bastion host
automatic time synchronization,
configuring, 639–640
disk partitions and, 624–625
high-security policy, applying, 638–639
local administrator account, creating, 628
optional components removal, 627
planning for, 624
security configuration with MMC,
628–638
service packs/hot fixes and, 625–627
installation, Linux bastion host
CD-ROM, 666–667
diskette, 667
distribution, choosing, 665, 667–668
distribution media, choosing, 665–666
full install, 665–666
overview of, 700
USB drive, 667
Institute of Electrical and Electronics
Engineers (IEEE), 173
Integrated Security Gateway (ISG), 388
integrity, 5, 9
. See also confidentiality, integrity,
availability
integrity-monitoring software, 114–115
Intercepting Mobile Communications:The
Insecurities of 802.11 (Borisov,
Goldberg, and Wagner), 151
interface modes, NetScreen, 401
interface-based Source NAT, 408
interfaces
Active/Passive stateful LAN-based failover,
291–293
antispoofing, 327–328
application inspection for, 306
on Check Point firewall, configuration of,
326
of Cisco ASA 5510 firewall, 225
Cisco ASA 5550 firewall and, 227
Cisco PIX 525 firewall and, 220
Cisco PIX 535 firewall and, 221
Cisco PIX/ASA configuration, 251–257
for DMZ servers, 106
external, ISA firewall and, 445
failover with cable, 289, 290
of firewall, 68–69
on IDS sensor,A:17
multiple-DMZ infrastructure with physical
interfaces, 212–213
multiple-DMZ infrastructure with virtual
interfaces, 213–214
NetScreen, 401–404
PIX/ASA failover requirements, 287–288
PIX/ASA firewall support of, 209
Security Rulebase configuration, 330
SSH for PIX/ASA access and, 245
virtual, of Cisco PIX/ASA 7.x, 231
virtual security, 419–420
VRF connection to, 548–549
internal firewall, 214–215
internal LAN
RIP on, 281
router placement and, 506–509
static routing on, 279
2006 Internal Threat Report (Mazu
Networks), 2
internal Web server, 74
internal/external firewall design, 214–215
Internet
chat clients, DMZs and, 99–100
connecting network clients to, 501
DMZ security, 316
e-mail attacks and,A:167
risks from, identification of, 29
router placement in DMZ and, 505–507
site-to-site VPN, 52–54
static routing for PIX/ASA, 279–280
for vulnerability research,A:149
WiFi, spread of, 146
Internet Assigned Numbers Authority
(IANA), 90, 258
Internet Authentication Service (IAS) server,
160, 195–202
Internet connection
perimeter security for Windows DMZ,
67–72
switch for, 91
with VPN, 582
WAN link for Windows DMZ and, 63
for Windows DMZ, 49, 61–62, 88
Internet Control Message Protocol (ICMP)
echo messages in smurf attack, 539
echo replies, 278, 521
ping/traceroute and,A:123
redirects, disabling on router, 538–539
unreachables, disabling, 539
Internet Corporation for Assigned Names and
Numbers (ICANN), 76
Internet Explorer, Microsoft,A:143
Internet Information Services (IIS) server
attacks,A:171
configuration for SMTP, 658–659
configuration for Web access, 652–653
configuring fro SMTP in bastion hosts,
658–659
IIS6 server, configuring for Web access,
654–658
security policy-based DMZ, 69–70
URLScan and, 662
vulnerability scanning,A:145–A:149
in Windows DMZ design, 60
. See also Microsoft IIS Web Server
Internet Key Exchange (IKE), 601–602, 613
Internet router
ACL configuration for, 519–522
configuration for default route, 507–508
configuration of, 512–513
placement in DMZ environment, 505
Internet Service Provider (ISP)
BGP security and, 514
Internet router and, 507–508
managed services for Internet router, 512
scanning and,A:126
for Windows DMZ, 61
Internet-facing router, 519–522
Internetwork Operating System (IOS), 504
Internetwork Packet Exchange (IPX), 313
interzone policies, NetScreen, 405
intradomain communications access rule,
450–456
intranet
DMZ design for protection of, 37–38
e-mail attacks on,A:168
intrazone policies, NetScreen, 405
intrusion detection
of ASA firewall software, 231
PIX/ASA, configuration of, 306–307
PIX/ASA firewall software features, 229
Intrusion detection system (IDS)
basics of,A:6–A:11
case study,A:96–A:97
Cisco IPS Management Center,
A:29–A:33
Cisco IPS Management Center,
installation of,A:33–A:43
Cisco MC for IPS Sensors server,
A:67–A:70
custom filters,A:90–A:94
definition of, 13
deployment of IDS,A:11–A:17
deployment strategies,A:94–A:96
DNS server, hardening,A:24–A:26
HIDS,A:21–A:22
honeypot,A:18–A:21
lessons learned,A:97–A:98
network security approaches,A:2–A:6
Nmap,A:17–A:18
overview of,A:98–A:104
reports, configuration of,A:61–A:67
sensor configuration files, Cisco IPS,
A:57–A:60
sensors/sensor groups, Cisco IPS,
A:43–A:51
signatures/alarms, configuration of,
A:52–A:57
Snort,A:70–A:90
on Solaris servers, 96–97
Tripwire,A:23–A:24
Web server, hardening,A:26–A:29
Intrusion Prevention System (IPS)
definition of, 13
function of,A:29
on Solaris servers, 97
IOS (Internetwork Operating System), 504
IP address
access rules for PIX/ASA, 269–278
Active/Active stateful failover with cable,
294
address translation rulebase, 333–335
ASDM and, 248
connection checking,A:122–A:123
in DMZ design, 26
DNS exploits and,A:156,A:157
failover with cable and, 289, 290
in IAS server setup, 195–196
IDS deployment and,A:14–A:15
IPSec security policy and, 604–605
ISA firewall address, 489
name resolution for Windows DMZ,
71–72
NAT configuration for PIX/ASA,
258–269
network hijacking and, 154
network mapping and,A:132,A:133
PIX Device Manager and, 246, 247
PIX/ASA failover and, 286
PIX/ASA interface configuration,
255–256
port numbers, 76–77
ranges as objects, 432
in Secure Platform configuration, 361
for sensor,A:43
setting up in NetScreen, 403
spoofing, 151

708
Index
static routing for PIX/ASA, 279
whois lookup,A:123–A:124
ip address ip_address [netmask] command, 255
ip default-gateway command, 576
ip default-network command, 576
IP filter firewall, 114–115
IP filters, 605
ip route 0.0.0.0/ command, 576
IP routing, 323
IP source routing, 542
IP spoofing, 327–328
ip ssh authentication-retries command, 526
ip ssh time-out command, 526
IP40/IP45, 365
IPChains, 702
IPS. See Intrusion Prevention System
IPS Edition, Cisco ASA firewall, 222, 223
IPSec
NAT and VPN deployment, 580–581
NAT incompatibilities, 613
for server/domain isolation, 67
Telnet access to PIX/ASA, 244
vendor enhancements, 608
VPN client, 590–591
VPN device placement for IPSec tunnel,
589
VPN traffic, tuning, 598
IPSec policy
Windows 2000 hosts and, 643
Windows VPN and, 597
IPSec solution, 598–605
encryption scheme, 599–600
IP filters, 605
management strategy, 600–601
negotiation policies, 601–604
overview of, 612
security levels, 605
security policies, 604–605
tuning VPN, 598–599
IPSO. See Nokia IPSO
IPTables, 684–686
IPX (Internetwork Packet Exchange), 313
ISA Server, 69
ISA Server 2004/Exchange Server
deployment kit, 459
ISA Server 2005, firewall/DMZ design
Corpnet network, creating, 446–447
corporate network on network services
perimeter, 445
DNS/WPAD entries in domain DNS,
490–493
edge firewall, default internal network on,
472–475
edge firewall, inbound connect to
Exchange Server Mail Services,
484–489
edge firewall, joining to domain, 476–477
edge firewall, outbound access of
Corpnet/services hosts, 477–484
edge firewall, routing table entry on,
475–476
Firewall client installation, 499–501
Firewall client share, installing on services
file server, 497–498
firewall/Web proxy clients, 493–497
intradomain access/DNS server publishing
rules, 450–456
joining clients to domain, 490
multiple departmental networks/security
zones, 442–443
network clients, routing table entry on,
490
network services access rules for Corpnet
clients, 459–472
network services segment configuration
options, 437–439
outbound access rules from services
segment, 456–458
overview of, 436
perimeter design, 443–444
route, corporate network/network services
segment, 447–449
stateful packet inspection/request/response
paths, 439–441
ISAPI filters,A:193
ISG (Integrated Security Gateway), 388
ISO/IEC 17799:2005, 10–11
isolated port, 566
isolation, server/domain, 640–644
ISP. See Internet Service Provider
ISP redundancy, 323–324
IV. See initialization vector
J
jamming attacks, 155
Java applets, 295–296
Jumpstart Architecture Security Scripts
(JASS). See Solaris Security
Toolkit
Juniper NetScreen
advanced features, 418
antivirus, 428–429
basics overview, 388–395, 429
configuration of, 398–399, 430–431
failover, 418–426
firewalls, secure management of, 396–398,
430
interfaces, defining, 401–404
NAT, configuring, 408–414
NSRP clusters, 418
policy/performance, 431
routing, 414–418
security policies, configuring, 405–408
virtualization, 399–401
VPN services of, 593–594
Web filtering, 426–428
Juniper NetScreen 5XT/5GT, 389–390
Juniper NetScreen ISG series, 393–394
Juniper Networks
LEAP offered by, 172
SBR installation package link, 178
Steel-Belted RADIUS, 176–186
K
KDE, 674
KeepAlive directive,A:209
KeepAliveTimeout directive,A:209
kernel, 677–678
KEYBOARD_ABORT parameter, 136
keys
authentication server and, 160
IPSec management strategy, 600–601
WEP, with LEAP, 172, 173–174, 175
KisMAC, 149
Kismet, 148
Knoppix,A:174
L
L2TP, 597
LAN. See Local Area Network
LAN Manager (LM),A:145
LAN-based failover
Active/Active, 294–295
Active/Passive, 291–293
failover requirements, 287–288
LANGuard,A:140–A:141
LAN-to-LAN VPNs, 590
Layer 2 mode, 401
Layer 2 switches, 545
Layer 2 transparent firewall, 230
Layer 3 switches, 545
LDAP (Lightweight Directory Access
Protocol), 25
LEAP
configuration of, 181–186
RADIUS with, implementation of,
172–176, 204
as security solution, 205
Steel-Belted RADIUS with, 178–182
Windows AD domain authentication with
LEAP/RADIUS, 186–188
LEAPv2. See EAP-FAST
least privilege, 9, 24
legal issues
of penetration tests,A:141
of port scanning/information gathering,
A:119
legal notice, 522–523
libraries
support libraries for BASE,A:77
Windows, vulnerabilities of,A:143–A:144
licensing
Cisco ASA firewall licensing, 235
Cisco PIX 501 firewall, 216
Cisco PIX 506E firewall, 217
Cisco PIX 515E firewall, 219
Cisco PIX firewall licensing, 233–235
PIX/ASA failover requirement, 288
Lightweight Directory Access Protocol
(LDAP), 25
Linux
live Linux distributions,A:174–A:175
patching OS,A:200
ping sweeping,A:138
test by script-kiddie,A:171
Tripwire,A:23
Linux bastion hosts
checklist, 699
configurations overview, 693–694
DNS server configuration, 697–698
FTP server configuration, 695–696
hardening scripts, automated, 681–682
maintenance/support, 698–699
optional components removal, 668–673
overview of, 664
patching/updates, 676–678
remote administration, 691–693
resource access, auditing, 687–691
resource access, controlling, 682–686
SELinux policy development, 678–680
SMTP relay server configuration, 696–697
SUID programs, removing, 678
system installation, 664–668
TCP/IP stack hardening, 680–681
time synchronization, automatic, 674–676
Web server configuration, 694
window manager, choosing, 674
live Linux distributions,A:174–A:175
LM (LAN Manager),A:145
load balancing
appliances for Solaris servers, 97
of ASA firewall software, 231
for RADIUS server, 202
in Windows DMZ design, 59–60
Local Area Network (LAN)
default gateway for, 63, 64, 65
interface for failover services, 285–286,
287
router, 437–439
VPN termination at dedicated VPN
appliance for, 583–585
VPN termination at firewall for, 583
local preference attribute, 511
local security, 122–124
Lockdown tool, IIS, 654–655
Log Parser,A:194–A:195
logging
Apache Web server directives,
A:212–A:213
for defense in depth,A:149–A:150
events, importance of, 535–536
on IIS Web Server,A:193–A:194
NTP clock synchronization for, 536–537
syslog configuration for router security,
534–535
of Tripwire,A:23
Web site, 656–658
Windows 2003 parameters,A:188
login
finger service for, 541
policy for user accounts,A:186,A:187
security banner display at, 522–523
logs
Event Log configuration for servers,
634–635
of HIDS,A:21–A:22
IAS server logs, 197
for information gathering,A:117
Linux audit, 688
logsnorter,A:73
Logwatch, 690–691
Longhorn, 83–84
Lynx, 373
M
MAC address
definition with port security, 576
network hijacking and, 154
PIX/ASA failover and, 286
spoofing, 150, 151
switch ports, securing, 569–570
Magic Potter case study,A:96–A:97
mail relay, 73
. See also open relays
mail server
Check Point rules for DMZ access,
332–333
publishing rules, 487–489
on Windows DMZ, 55, 87
mail services
firewall rules for private network, 99–100
firewall rules for public networks, 102
of Windows DMZ, 72–73
mailing lists,A:179–A:180
maintenance
of bastion hosts, 660, 662
of Linux bastion hosts, 698–699
Secure Platform, 363–365
maintenance phase, DMZ server, 105
malicious attacks, 2
Managed IP (MIP)
description of, 408
overview of, 409–410
VIP vs., 433
management
access to PIX/ASA, authentication of,
249–250
of alert database,A:87–A:90
of Cisco PIX/ASA OS 7.2, 237
of IPSec, 600–601
VLAN, 556–557
management architecture, Check Point
firewall, 319–320
management station,A:8
Man-in-the-Middle (MITM) attacks, 153–155
mapping. See network mapping
match port command, 304
MaxClients directive,A:209
maximum transmission unit (MTU), 562,
598–599
MaxSpareServers directive,A:209
Mazu Networks, 2
MBSA (Microsoft Baseline Security
Analyzer), 620–621
MC for IPS Sensors. See Cisco IPS
Management Center
McAfee Host IPS,A:22
MCSE/MCSA Implementing and
Administering Security in a
Windows/ 2000 Network: Study
Guide and DVD Training System
(Exam 70-214) (Syngress), 47
MD5 authentication
for NTP, 537
for RIP on PIX 6.x, 281
securing BGP with, 514–515
md5sum,A:203
MDAC (Microsoft Data Access Components),
A:5
mean time before failure (MTBF), 366
MED (multi-exit discriminator) attribute, 511
media integrity, 129
meshed topology, VPN, 585–586
Metasploit Framework,A:174,A:175
Microsoft
security advisory site,A:185
server/domain isolation information, 67
Microsoft Automatic Update (AU), 625–626
Microsoft Baseline Security Analyzer
(MBSA), 620–621
Microsoft Certificate Services, 191–193
Microsoft Data Access Components (MDAC),
A:5
Microsoft Data Engine (MSDE),A:145,A:163
Microsoft Directory Services, 25
Microsoft Error Reporting, 480–481
Microsoft Exchange 2000, 622–623
Microsoft Exchange Server
Corpnet ISA firewall and, 459–461
mail services, edge ISA firewall inbound
connections to, 484–489
Microsoft FrontPage,A:171
Microsoft IIS Web Server
hardening,A:191–A:194
monitoring for secure operation,
A:194–A:195
patching/securing OS,A:185–A:191
vulnerabilities,A:184–A:185
Microsoft Internet Explorer,A:143
Microsoft Management Console (MMC),
628–639
Microsoft Office,A:144–A:145
Microsoft Reporting, 457–458
Microsoft SQL Server
database vulnerabilities of,A:147–A:148
SQL Slammer worm and,A:163
Microsoft SQL Server Desktop,A:145
Microsoft Update, 480–481
Microsoft Windows
authentication server of, 160
configuration vulnerabilities,A:145
libraries, vulnerabilities of,A:143–A:144
Longhorn, 83–84
security of, 46, 662
services, vulnerabilities of,A:142–A:143
VPN services of, 597–598
. See also Windows bastion hosts;
Windows DMZ design
Microsoft Windows 2000, 622–623, 643
Microsoft Windows 2003,A:185–A:191
Microsoft Windows Active Directory,
609–610
Microsoft Windows Firewall,A:188–A:190
Microsoft Windows Update, 457–458
MinSpareServers directive,A:209
MIP. See Managed IP
mirroring,A:12–A:13,A:14,A:17
MITM (Man-in-the-Middle) attacks, 153–155
Mitnick, Kevin,A:120

Index
709
MMC (Microsoft Management Console),
625–639
mod_apache_snmp module,A:214
mod_security Apache module,A:205–A:206
mod_ssl module,A:80
mode command, 283
modeling, system, 127–128
modem
probing analog connections,A:150
war dialing and,A:151–A:152,A:153
ModemScan v5.3,A:152
modsecurity.conf file, 207–208
Modular Policy Framework (MPF), 300
modules, for Apache Web server,A:204–A:206
monitoring
ACLs, 276–277
Apache Web server, 214,A:214
with ASDM, 248
failover, 295
Microsoft IIS Web Server,A:194–A:195
by sensors,A:44
MPF (Modular Policy Framework), 300
MPLS (Multiprotocol Label Switching), 548
MRTG tool,A:195
MSDE (Microsoft Data Engine),A:145,A:163
MSFC (Multilayer Switch Feature Cards), 545
MTBF (mean time before failure), 366
MTU (maximum transmission unit), 562,
598–599
multi-exit discriminator (MED) attribute, 511
multihop, 515
multilayer switch, 504–505, 506
Multilayer Switch Feature Cards (MSFC), 545
multiple departmental networks, 442–443
multiple-DMZ infrastructure
with physical interfaces, 212–213
with virtual interfaces, 213–214
Multiprotocol Label Switching (MPLS), 548
multi-tiered firewall with DMZ
configuration of, 16–17
pros/cons of, 20, 22
traffic flow, 19–20
mutual authentication, 173–174
MySQL database,A:77–A:78
N
N2H2 server, 296
name resolution
DNS servers in Windows DMZ, 74–75
for Windows DMZ perimeter security,
71–72
nameif command, 255
NAP (Network Access Protection), 84
NAT. See Network Address Translation
nat command, 260–264
NAT ID, 260–261, 262, 263
NAT mode, 401
NAT Traversal (NAT-T), 589
nat-control command, 259, 260
native users, 181
needs analysis, 49–50
negotiation policies, IPSec, 601–604
neighbor, 513–514
neighbor password command, 514
neighbor remote-as command, 513, 514
Nessus
bastion host scanning with, 618–620
for vulnerability scanning,A:139–A:140,
A:141
NetBIOS, 79–81
NetBIOS over TCP/IP,A:190
Netcat,A:141
Netfilter firewall, 685
NetScreen. See Juniper NetScreen
NetScreen Redundancy Protocol (NSRP)
clusters, building, 421
configuration synchronization, 422
description of, 418
full version, advantages of, 422–423
NetScreen, adding to, 421
states, 420–421
NetScreen Security Manager (NSM), 396, 398
NetScreen-25/50, 390–391
NetScreen-204/208, 391–392
NetScreen-500, 392
NetScreen-5200/5400, 392–393
NetStumbler, 148
network, intrusion detection for,A:2–A:6
Network Access Protection (NAP), 84
network adapter, 159
Network Address Translation (NAT)
advantages of, 432
Cisco PIX/ASA configuration, 258–269
definition of, 13
IPSec incompatibilities, 613
NetScreen, configuring, 408–409
NetScreen, destination NAT, 412–414
NetScreen, source NAT, 409–412
router placement, 506–507
rulebase, configuration of, 333–335
VPN deployment models and, 580–581
network clients, 490
Network Configuration screen, Secure
Platform, 360
Network Connections Configuration screen,
Secure Platform, 361
network data, 79
network engineering, Windows DMZ, 49–52,
81–82, 86
network hijacking, 153–155
network integration, 237
Network Interface Card (NIC)
on IDS sensor,A:17
in Secure Platform installation, 359
of sensor,A:8
for Snort sensor,A:71–A:72
Network Intrusion Detection System (NIDS)
characteristics of,A:6
choice of IDS,A:7
mixed NIDS/HIDS deployment,
A:94–A:96
on Solaris servers, 96–97
Network Mapper. See Nmap
network mapping
Nmap,A:129–A:135
ping sweeping,A:138
from reconnaissance mission,A:118–A:119
results of,A:137–A:138
services to look for,A:135–A:136
step after,A:139
network node intrusion detection (NNIDS),
A:7
network penetration, cost of,A:111,A:112
network perimeters
securing with Check Point firewall,
321–323
securing with PIX/ASA, 209–215, 312
stateful inspection, 328–329
Windows Server 2003 R2 feature for
security, 57–58
network resources, 29–30
network routes, 404
network security, planning
overview of, 40–41
policies, plans, procedures, 10–11
potential threats, 8
risks to data, identification of, 6–7
risks to services, identification of, 7
security fundamentals, 3–5
standards, 8–10
network security, Security Wheel,A:32–A:33
network services
Corpnet clients, access rules for, 459–461
file server file shares access, 470–472
OWA publishing rule on perimeter ISA
firewall, 461–466
perimeter, creating ISA representing
corporate network, 445
SMTP/POP3/IMAP4 server publishing
rules, 466–469
network services segment
configuration options, 437–439
corporate network, setting route between,
447–449
file server, installing firewall client share
on, 497–498
resources, connecting network clients to,
501
rules for outbound access on perimeter
ISA firewall, 456–458
. See also edge ISA firewall
network statement, 513
network tap
of IDS,A:8
of IDS sensor,A:11
for IDS sensor monitoring,A:13–A:14
Network Time Protocol (NTP), 674–676
configuration for router security, 536–537
configuration for switch, 559
for HIDS hosts,A:22
on PIX/ASA, configuration of, 308
for time synchronization, 639–640
Network Translation, Inc., 208
network virtualization
with Cisco Catalyst 3560, 547–548
description, example of, 548–550
networks
corporate, on network services perimeter,
445
default internal, configuring on edge ISA
firewall, 472–475
IPSec negotiation policy option, 603–604
multiple departmental, 442–443
private, 99–101
public, 101–103
with/without DMZs, 20–22
newpkg command, 378–379
next hop attribute, 510
ngrep, 150
NIC. See Network Interface Card
NIDS. See Network Intrusion Detection
System
Nikto,A:141
NIST Apache Benchmark document,A:201
Nmap (Network Mapper)
alerts in BASE,A:83
attack with,A:17–A:18
bastion host scanning with, 617–618
cache poisoning and,A:162
function of,A:129
installation of,A:129–A:132
network mapping with,A:132–A:138
overview of,A:178
scanning with,A:127,A:128
Specter and,A:19
NNIDS (network node intrusion detection),
A:7
no cdp enable command, 538
no cdp run command, 538
no http server enable command, 247
no ip bootp server command, 543
no ip directed-broadcast command, 539
no ip finger command, 541
no ip http server command, 528, 557
no ip proxy-ARP command, 540
no ip redirects command, 538
no ip source-route command, 542
no ip unreachables command, 539
no service password-recovery command, 542
Nobody account,Apache Web server,A:201
nodes,A:23–A:24
Nokia
SecureXL, 324–325
VPN services of, 592–593
Nokia appliance, configuration of, 371–379
CLISH for, 375–376
initial configuration, 371–373
Nokia Voyager for, 373–374
operating system, software installation,
377–379
time constraints, 376–377
Nokia appliances
choice of right platform, 366–368
comparisons, 368–370
Nokia support, 371
Nokia firewalls, 382, 383
Nokia IP110/IP120/IP130 appliances, 368
Nokia IP260/265 appliances, 366, 369
Nokia IP330 appliance, 368, 370
Nokia IP350/IP355/IP380/IP385 appliances,
368, 369
Nokia IP390 appliances, 367, 369
Nokia IP440 appliance, 368, 370
Nokia IP530 appliance, 368, 370
Nokia IP560 appliances, 367, 370
Nokia IP650 appliance, 368, 370
Nokia IP710/IP740 appliances, 368, 370
Nokia IP1220/1260 appliances, 367, 369
Nokia IP2250 appliances, 367, 369
Nokia IPSO
built-in dynamic routing support of, 323
Check Point features on, 317
choice of right platform, 366–371
clusters, 324
configuration of Nokia appliance, 371–379
cpconfig utility, 379–381
features of, 356
firewall/DMZ design checklist, 381
routing protocols supported by, 385
strengths of, 365–366
Nokia Voyager
Nokia appliance configuration with,
373–374
for OS installation, 377
using, 374
NoMachine NX server, 693
nonexecutable stack setting, 135
Novell.com,A:120–A:121
NSM (NetScreen Security Manager), 396, 398
NSRP. See NetScreen Redundancy Protocol
NT LAN Manager (NTLM),A:145
NTP. See Network Time Protocol
ntp master command, 536
NTP Public Services Project, 536
ntp server command, 536
O
Office, Microsoft,A:144–A:145
On-Demand Routing (ODR), 537
open doors,A:113
Open Relay Database,A:132
open relays
blacklist of,A:179–A:180
closed relay for security,A:180
e-mail attacks,A:168,A:169–A:170
network mapping and,A:132,A:133
Open Shortest Path First (OSPF), 282,
416–417
open systems, for Secure Platform, 357
Open Systems Interconnection (OSI) model,
28–29
OpenBoot parameters, 136
operating system (OS)
of Apache Web server, patching/securing,
A:199–A:200
for BASE,A:74,A:75
for Check Point firewalls, 316–317
Check Point Secure Platform, 357–365
Cisco PIX firewall version 6.3, 236
Cisco PIX/ASA firewall software features,
228–230
Cisco PIX/ASA firewall version 7.2,
236–237
for Cisco switches, 544–545
configuration of secure,A:186–A:188
honeypot as,A:18–A:21
installation on Nokia appliance, 377–378
Nokia IPSO, 365–379
patching,A:185–A:186
PIX Device Manager and, 232
preparation for Apache Web server,
A:201–A:202
Oracle, updates,A:148
origin attribute, 510
OS. See operating system
OSI (Open Systems Interconnection) model,
28–29
OSPF (Open Shortest Path First), 282,
416–417
outbound access control list, 269, 271–272
outbound NAT, 259, 260–264
outbound policy, 407
Outlook Express,A:144–A:145
out-of-band management
bastion hosts and, 662
description of, 396
in DMZ, 38–39
in-band management vs., 42–43
OWA publishing rule, 461–466
OWA Web publishing rule, 485–486
ownership, for Apache Web server,
A:213–A:214
P
P2P (Peer to Peer) File Sharing programs,
A:148–A:149
Package Manager, 670–673
packet filtering
custom filters,A:91–A:94
definition of, 13
DMZ design and, 24
Packet Internet Exchange. See Cisco PIX
(Packet Internet Exchange)
firewall
packets
PIX/ASA packet-capture capabilities, 314
size for VPN traffic, 598–599
stateful inspection with Check Point
firewall, 320
PACs (Protected Access Credentials), 173
padded cell,A:161
partial mesh VPN-based network, 54
partial-mesh VPN topology, 585–586
partitions, 624–625, 665
passive attacks, 147–150
password
for Administrator account,A:186
for BASE security,A:80
for BASE users,A:78
for BASE Web server,A:79
for BGP authentication, 514–515
for CiscoWorks users,A:41–A:42
for console/auxiliary ports, 524–525
database software vulnerabilities,A:147
default for servers, vulnerability scanning,
A:145
for DMZ hardening,A:173
effective, articles on,A:149
enable password, configuration of,
528–530

710
Index
enable password for switch, 558
Microsoft Windows vulnerabilities,A:145
in Nokia appliance configuration, 371–372
P2P vulnerability,A:148
for PIX Device Manager, 247
PIX/ASA access authentication, 249
PIX/ASA Telnet password, 244–245
policy,A:180
policy for user accounts,A:186,A:187
probing analog connections,A:150
Secure Platform configuration, 360
spoofing and, 155
SQL injection and,A:165–A:166
for SSH configuration, 526–527
SSH for PIX/ASA access, 246
for Steel-Belted RADIUS, 180–181
for switch console port, 555–556
for switch Telnet configuration, 557
for Telnet, 525
VPN remote access topology and, 588
for WDMZ, 165
for Web server,A:27
Windows configuration vulnerabilities,
A:145
password recovery, disabling, 542
PAT. See Port Address Translation
patch clusters, 130–131
patches
for DMZ hosts,A:180
for Linux bastion hosts, 676–678
Microsoft operating system,A:185–A:186
for Oracle,A:148
patching OS,A:199–A:200
for Secure Platform, 365
for Web server,A:27
PBX systems,A:150
PC Anywhere,A:150
PCI card, 221, 237–239
PEAP. See Protected Extensible
Authentication Protocol
PEAPv0/EAP-MSCHAPv2, 158
Peer to Peer (P2P) File Sharing programs,
A:148–A:149
penetration testing
analog connections, probing,A:150–A:151
auditing/logging evasion,A:149–A:150
coverage of,A:110
defense in depth,A:113–A:115
definition of,A:113
network mapping,A:129–A:139
overview of,A:177–A:178
reconnaissance,A:116–A:126
scanning techniques,A:126–A:128
vulnerability scanning,A:139–A:149
war dialing,A:151–A:154
Perfect Forward Secrecy, 603
performance directives,A:209
perimeter ISA firewall, network services
corporate network/services segment route
relationship, 447–449
intradomain communications access rule
on, 450–454
outbound access from services segment,
456–458
OWA publishing rule on, 461–466
SSL publishing rule on, 484–485
perimeter network
ISA Server 2005, design example, 443–444
OWA publishing rule, creating, 485–486
perimeter security
Network Access Protection for, 84
of Windows DMZ, 67–72
perimeter security, Windows DMZ
external router, 67–68
extra DMZ routers, 70–71
firewall, 68–69
name resolution, 71–72
security policy-based DMZ, 69–70
perimeterization, 436
periodic command, 275
permissions
for Apache Web server,A:213–A:214
for IIS Web Server,A:192–A:193
permit statement, 516
personnel security, 9
Phase 1 lifetime, 601–602
Phase 1 negotiation, 601–602
Phase 2 lifetime, 603
Phase 2 negotiation, 602–604
Phonesweep,A:153
PHP (Hypertext Preprocessor)
application vulnerabilities,A:146–A:147
for BASE installation,A:76
physical host security, 129
physical interfaces, 212–213
physical security, 9, 542
ping
check of IP address,A:122
disabling redirects and, 539
VRF and, 548
ping flood, 151
ping sweeping,A:138
Pirut, 670, 672
PIX Device Manager (PDM)
Cisco Adaptive Security Device Manager
and, 233
configuration of, 246–247
function of, 232
PIX firewall. See Cisco PIX (Packet Internet
Exchange) firewall
pkginfo tool, 133
pkgrm tool, 133
PKI (Public Key Infrastructure), 600–601
placement
of AP in WDMZ, 166
of IDS sensor,A:10
of wireless equipment for WDMZ, 156
planning
DMZ design, 240–243
network security, 3–11, 40–41
planning list, Windows DMZ design, 81–83,
89
planning phase
DMZ server, 104, 105
high availability, 111
software selection, 108–109
platform licenses, Cisco PIX/ASA firewall,
234, 235
platforms, for Check Point firewall, 316, 317
Point to Point Tunneling Protocol (PPTP),
598
policy
group policy for IAS server, 201–202
High-Security Policy, 638–639
NetScreen security policy, 405–408
remote access policy for IAS server, 198
Restricted Groups Policy, 635–636
wireless policy for IAS server, 198
policy map, 304, 305
policy-based Destination NAT, 409, 413–414
policy-based Source NAT, 409, 410–411
polls, 286
POP3
server publishing rule, 466–469
server publishing rules, creating secure,
486–489
Port Address Translation (PAT)
inbound NAT configuration, 265–268,
269
NAT configuration, 262–264
NAT vs., 258–259
outbound NAT configuration, 260
port forwarding, 384
port mirroring
IDS sensor,A:17
IDS sensor, port mirroring/span for,
A:12–A:13
pros/cons of,A:14
port numbers
assignments, 90
definition of, 76
well-known, 76–78
port scanning,A:119
port security feature, 569–570, 576
ports
of Cisco Catalyst 2960, 546–547
of Cisco Catalyst 3750, 550, 551
of Cisco Catalyst Express 500, 546
console/auxiliary port configuration,
523–525
disabling NetBIOS, SMB, 80
in DMZ design, 26–28
management VLAN and, 557
network mapping and,A:132–A:133,
A:135
PIX default inspection ports, 302–304
PIX/ASA application inspection, 299
private VLAN and, 566
PVLANs, applying to, 568–569
scan for open,A:127–A:128
switch, securing, 569–570
switch console port, configuration of,
555–556
VPN device placement, 589
for Windows Firewall configuration,A:189
PPP over Ethernet (PPoE), 229
PPTP (Point to Point Tunneling Protocol),
598
primary isolation group, 642
private community string, 533
private IP address
in DMZ design, 26
NAT configuration for PIX/ASA,
258–269
private network, 99–101
private VLANs
configuration of, 566–569
function of, 565–566
private-vlan association command, 567
private-vlan command, 567
privileged mode, 528
probing
analog connections,A:150–A:151
phase of attack,A:29
procedural security, 9, 10–11
ProComm Plus,A:152
promiscuous port, 566, 568
Protected Access Credentials (PACs), 173
Protected Extensible Authentication Protocol
(PEAP)
components for Windows 2003
implementation, 191
features of, 188–191
IAS server, setting up, 195–202
Microsoft Certificate Services, 191–193
RADIUS server load balancing,
redundancy, 202–203
Wireless Computer object, creating,
193–195
Wireless User Group, 193
Wireless User object, 195
protocols
DMZ, 24–25
PIX/ASA support of, 313
TCP/IPv4 flaws, DMZ design and, 25–26
VPN, 578, 614
proxy ARP, 540
proxy client settings, Web, 493–497
proxy server
actions of, 314
definition of, 12
placement in DMZ, 506
public access, 30–31
public community string, 533
public Internet connection, 57
public IP address
in DMZ design, 26
NAT configuration for PIX/ASA,
258–269
Public Key Infrastructure (PKI), 600–601
public network, 101–103
pup, 672
Q
QAInspect, SPI Dynamics,A:5
quality assurance (QA),A:165,A:166
Quality of Service (QoS), 325
query,A:82–A:84,A:85
R
radio frequency (RF), 155
RADIUS. See Remote Authentication Dial-
In User Service (RADIUS)
RADIUS Clients, 195–196
RADIUS server. See Remote Authentication
Dial-In User Service (RADIUS)
server
Random Access Memory (RAM), 106,A:5
RBAC (role-based access control), 124
RC4 stream cipher, 175
RDP. See Remote Desktop Protocol
RDPclip utility, 650
Read-Only Domain Controller (RODC), 83
real time intrusion alarms,A:105
reauthentication policies, 174
reconnaissance,A:116–A:126
information gathering,A:117–A:119
overview of,A:177–A:178
penetration testing DMZ,A:116–A:117
penetration/occupation,A:125–A:126
phase of attack,A:29
simplicity of,A:110
social engineering,A:124–A:125
target selection,A:117
whois lookup,A:119–A:124
Red Hat Enterprise Linux, 667–668
redirects, ICMP, 538–539
redundancy
of DMZ architecture, 242
on DMZ host servers, 118
ISP, DMZ configuration for, 323–324
with Juniper NetScreen VPN services, 594
of meshed VPN topology, 585
in multi-DMZ infrastructure, 213
Multilayer Switch Feature Cards and, 545
for RADIUS server, 202
for three-legged firewall, 210, 211
registry,ACL, 638
releases, Check Point, 318
remote access
IAS server policy, 198
VPN extranet, 606–608
VPN with Active Directory, 609–610
remote access services, VPN, 591–598
Cisco VPNs, 594–597
description of, 591–592
Juniper NetScreen VPNs, 593–594
Nokia, 592–593
Windows VPN, 597–598
remote access topology, VPN, 588–589
remote access VPN clustering, 231
remote access VPN solution, 590–591
remote administration
bastion host, 644, 661
bastion host on Windows 2000 with
Terminal Services, 644–649
bastion host on Windows 2003 with RDP,
649–652
of DMZ, 38
of Linux bastion hosts, 691–693
of Solaris DMZ servers, 120–121
remote alert function,A:21
Remote Authentication Dial-In User Service
(RADIUS)
authentication process, 177, 202–203
authentication purpose of, 43
with Cisco LEAP, 172–176, 204
IAS server installation, configuration,
195–202
PIX/ASA firewall software support of, 229
servers in DMZ, 33–34
Steel-Belted RADIUS, 176–186
Windows AD domain authentication with
LEAP/RADIUS, 186–188
Remote Authentication Dial-In User Service
(RADIUS) server
AAA on router and, 531
in LEAP configuration, 182–186
load balancing, redundancy for, 202
Microsoft Certificate Services for, 191–193
PIX/ASA access authentication, 249
PIX/ASA cut-through proxy and, 297
for port access authentication, 524
for SSH configuration, 526–527
for switch console port access
authentication, 555–556
for Telnet access authentication, 525
for WDMZ, 160–161
in wireless DMZ example, 162–163, 164
remote code execution vulnerabilities,A:147
Remote Command Execution vulnerabilities,
A:147
remote control usage, 29
Remote Desktop Protocol (RDP)
Terminal Services and, 644, 646–649
for Windows 2003 remote administration,
649–650
Remote File include vulnerabilities,A:147
remote registry access,A:188
remote sites, 65–66
reports, Cisco IPS Management Center
audit log reports,A:61–A:62
deleting,A:63–A:64
editing report parameters,A:64
example of,A:64–A:65
exporting,A:63
generating,A:62–A:63
Security Monitor reports,A:66–A:67
viewing,A:63
Request for Comment (RFC) 1918, 258
Request for Comment (RFC) 2865, 173
Request for Comment (RFC) 3330, 520
request paths, 439–441
resource access
auditing on Linux bastion hosts, 687–691
controlling on Linux bastion hosts,
682–686, 701
resources
auditing on Linux bastion hosts, 701
Check Point Hardware Compatibility list,
317
on WEP vulnerabilities, 205
. See also Web site resources
response paths, 439–441
restore utility, 364
Restricted Groups Policy, 635–636
Restricted license, 234
restricted shells, 124
restrictive environments, 124
revert utility, 364
RF (radio frequency), 155
RFC (Request for Comment) 1918, 258

Index
711
RFC (Request for Comment) 2865, 173
RFC (Request for Comment) 3330, 520
RIP (Routing Information Protocol),
280–282, 414–416
rip authentication key command, 282
rip authentication mode command, 282
risks
advanced, DMZ design and, 34–36
CIA standard and, 8–9
to data, identification of, 6–7
DMZ design and, 23
identification of potential, 8
from Internet, identification of, 29
planning network security, 3
to services, identification of, 7
traffic/security, DMZ design and, 32–34
RODC (Read-Only Domain Controller), 83
rogue access point (AP), 153, 154–155
role-based access control (RBAC), 124
ROMMON mode, 542
route
corporate network/network services
segment, 447–449
firewalling and, 404
route if_name ip_address netmask next_hop
[metric] command, 279
route mode, 401
Route Switch Modules (RSM), 545
router
enterprise wireless gateway as, 161
external, for Windows DMZ perimeter
security, 67–68
extra, for Windows DMZ perimeter
security, 70–71
extranet VPN termination at edge router,
607
LAN, between ISA firewall/corporate
network, 437–438
placement in DMZ environment, 504–509
Solaris implemented as, 108
switch developments and, 544
tapping into,A:151–A:152
virtual, 400–401, 432
VPN termination at edge router, 581, 582
WAN link for Windows DMZ and, 63–67
for Windows DMZ Internet connection,
62
router bgp command, 513
router ospf command, 282
router rip command, 281
router security
AAA configuration, 531–532
access control lists, 516–522
best-practice checklist, 571–572
Border Gateway Protocol, 509–516
console/auxiliary port configuration,
523–525
disabling unneeded IOS features, 537–543
enable password configuration, 528–530
HTTP/HTTPS configuration, 527–528
IO bugs, security advisories, 570–571
logging events, 535–536
Network Time Protocol configuration,
536–537
other security features, 543–544
overview of, 504, 574–575
router placement in DMZ environment,
504–509
security banner, 522–523
SNMP configuration, 532–533
SSH configuration, 526–527
syslog configuration, 534–535
Telnet configuration, 525
routing
BGP, 511–512
Cisco PIX/ASA configuration, 278–282
dynamic, 432
IP routing, Check Point firewall design
and, 323
IP source routing, disabling, 542
PIX/ASA firewall software features, 229
setting up in NetScreen, 404
routing, NetScreen
BGP, 417–418
OSPF, 416–417
RIP, 414–416
static, 414
Routing Information Protocol (RIP),
280–282, 414–416
routing protocols
authentication of, 576
Border Gateway Protocol, 509–516
PIX/ASA support of, 313
router placement in DMZ environment,
506–509
supported by Nokia/Secure Platform, 385
routing table
on edge ISA firewall, 475–476
on network clients, 490
on WAN router, 64, 65, 66
RPM Package Manager (RPM), 672
RSA key, 526
RSA key pair, 245–246
RSM (Route Switch Modules), 545
RTO (Run-Time Object) mirroring, 423
rules
address translation rulebase, 333–335
Check Point for creation of, 332–333
Corpnet client access, 459–472
Corpnet/internal network route defining
rule, 448–449
DNS server publishing, 450, 454–456
intradomain access on network services
perimeter ISA firewall, 450–454
network services perimeter ISA, 447–449
outbound access from services segment on
perimeter ISA firewall, 456–458
private network, 99–101
public network, 101–103
of Snort,A:89–A:90
traffic, 27
Run-Time Object (RTO) mirroring, 423
S
SA (security association), 600–604
SAFE Blueprints (Cisco), 571
SAINT (Security Administrators Integrated
Network Tool),A:141
SANS Institute
port recommendations, 27–28
Top 20 list, 32,A:141–A:145
web site of,A:149
Sawmill,A:22
SBR. See Steel-Belted RADIUS
scalability
of Cisco PIX/ASA OS 7.2, 237
of DMZ architecture, 242
scanning techniques
analog connections, probing,A:150–A:151
auditing/logging evasion,A:149–A:150
FIN scan,A:128
network mapping,A:129–A:139
SYN scan handshake,A:126–A:127
vulnerability scanning,A:139–A:149
war dialing,A:151–A:154
. See also vulnerability scanning
scheduled backup, Secure Platform, 364
screened subnet
definition of, 13
DMZ design with, 20–21
DMZ vs., 42
for network resource protection, 30
public access to, 30–31
screening router, 13, 161
ScreenOS, 393–394, 395
script mapping,A:193
scripts, 670, 681–682
search,A:82–A:84,A:85
Secure Computing SmartFilter server, 296
Secure Platform, Check Point
best choice for SmartCenter, 384
choice of right option, 357
configuration of, 357–363
cpconfig utility, 379–381
maintenance of, 363–365
overview of, 382–383
routing protocols supported by, 385
Secure Shell (SSH)
NetScreen management with, 397
for PIX remote administration, 247
for PIX/ASA access, 245–246
for remote administration of Linux bastion
hosts, 691–693
for remote command-line access, 650–652
router security configuration, 526–527
server, 484–485
on switch, 557
weakness of, 25
Secure Socket Layer (SSL)
for Apache Web server,A:204
for secure Web pages, 658
SSL VPNs, 591, 592
SecureClient, 317
secure-key derivation, 174
SecuRemote, 317
SecureNet,A:13
SecurePlatform Pro, 323
SecureXL, 324–325
security
Apache Web server vulnerabilities,
A:198–A:199
of BASE,A:80
cost of network penetration,A:112
defense in depth,A:113–A:115
DMZ design for, 22–23
knowledge, 169
LEAP features for, 173–174
local, layering, 122–126
Microsoft IIS Web Server, hardening,
A:184–A:195
NetScreen, 388
network perimeters, securing, 321–323
planning network security, 3–11
risks, DMZ design and, 32–34
VPN security, 606–608
Windows DMZ, 82–83
of WLAN, 146–147
WLAN best-practices checklist, 165–166
. See also demilitarized zones; local
security; zones, security
security, Windows DMZ
fundamental, 47–49
network engineering, 49–52
overview of, 86–87
security analysis, 56–57
site-to-site VPN, 52–55
systems engineering, 55–56
Windows Server 2003 R2, 57–58
Security Administrators Integrated Network
Tool (SAINT),A:141
security advisories, 570–571
security analysis, 56–57
security association (SA), 600–604
security banner
configuration of, 522–523
for switch, 559
security contexts
Active/Active stateful failover with cable,
294
of Cisco PIX/ASA 7.x, 231
failover and, 285
of PIX/ASA 7.x OS, 283–285
security gateways
cpconfig utility on, 380–381
Nokia appliances for, 384
security level
for IPSec VPN solution, 605
for PIX/ASA interface configuration,
252–253, 254–255
Security Manager, NetScreen, 398
Security Monitor, Cisco
functions of,A:30
real time intrusion alarms,A:105
reports,A:61,A:66–A:67
Security Options, 632–633
security plan, 10–11
security policies, NetScreen
components of, 405–407
configuring, 405
inbound policy, 407–408
outbound policy, 407
security policy
Cisco IPS Management Center and,
A:32–A:33
development of, 10–11
firewall as enforcer of, 68
importance of, 42
IPSec, design of, 604–605
planning stage, 12
for WDMZ, 165
security policy-based DMZ, 69–70
Security Problems in the TCP/IP Protocol
Suite (Bellovin), 26
Security Rulebase, 330–333
Security Services Card (SSC), 224
Security Set Identifier (SSID), 166
security standards, 8–10
security templates, 504
security testing bastion hosts
hardening with vulnerability scan results,
621–622
MBSA, 620–621
Nessus, 618–620
Nmap, 617–618
vulnerability scanning, 617
Security Wheel, Cisco,A:32–A:33
security zone
connected to backbone network, 442–443
with Juniper NetScreen VPN services, 594
VLAN design in DMZ, 563–564
security-enhanced Linux (SELinux), 678–680,
A:27
SecurityFocus Web site,A:195
SecurityGateway, 320
security-level command, 255
segmentation devices, 162
SELinux (security-enhanced Linux), 678–680,
A:27
Sensor Configuration Deployment Report,
A:62
Sensor Configuration Import Report,A:62
sensor groups
adding sensor to,A:47–A:50
deleting sensor from,A:50–A:51
deleting sensor subgroups,A:51
hierarchy of,A:45
sensor subgroup,A:45–A:46
sensor subgroup
creation of,A:45–A:46
deleting,A:51
Sensor Version Import Report,A:61
sensors
adding to sensor group,A:47–A:50
choice of IDS,A:7
Cisco IPS Management Center,
A:29–A:30,A:31
configuration files,A:57–A:60
deleting from sensor group,A:50–A:51
deleting sensor subgroups,A:51
deployment in enterprise network,A:104
function of,A:43
hierarchy of,A:45
of IDS,A:8–A:9
IDS deployment,A:12–A:17
monitoring connections with,A:44
of NIDS,A:6
placement of,A:10
reports,A:61–A:67
sensor subgroup,A:45–A:46
Snort IDS sensors,A:71–A:72
tap for,A:11
updates,A:69
serial console, 396
Server Core, 83
server isolation, 640–644
server logs, 197
server message block (SMB), 79–81,A:190
server mode, VTP, 560
server placement, Sun Solaris DMZ, 95–98,
141
server software obfuscation directives, 210,
A:210
servers
bastion host, isolation of, 640–644
Check Point rules for DMZ access,
332–333
DNS server, Linux bastion host as,
697–698
DNS servers in Windows DMZ, 74–75
e-mail server for Windows DMZ, 72–73
FTP, Linux bastion host as, 695–696
isolation with IPSec, 67
proxy, for Web content filtering, 100–101
Security Rulebase configuration, 330–331
SMTP relay, Linux bastion host as,
696–697
Sun Solaris DMZ, firewall rulesets for,
103–104
Web, Linux bastion host as, 694
Web servers for Windows DMZ, 73–74
on Windows DMZ, 55, 88–89
. See also Windows Bastion Hosts
service packs, 625–627
service password-encryption command,
529–530, 558
service timestamps log datetime msecs
command, 534
Service-Oriented Network Architecture
(SONA), 548
service-policy command, 306
services
creating with Check Point, 331–332
disabling for Solaris system hardening, 134
DMZ server placement and, 116–117
on Linux bastion hosts, 668–670, 673
private network, firewall rules for, 99–101
public network, firewall rules for, 101–103
risks to, identification of, 7
security policy and, 407
System Services overview, 636–638
. See also network services
services identification,A:132–A:138
set group ID (SGID), 678
set user ID (SUID), 678
setfacl, 123
severity levels, 534, 535
SGID (set group ID), 678
shared objects, 400
shared-key authentication, 166
shares
access, rule allowing on file server,
470–472

712
Index
firewall client, 497–498
shells, restricted, 124
show access-group command, 277
show access-list command, 276–277
show command, 249
show conn command, 269
show failover command, 295
show interface command, 255–257
show static command, 269
show version command, 239
showxlate command, 269
signatures
alarms, configuration of,A:53–A:55
attack types and,A:10
Cisco IPS Management Center and,
A:31–A:32
custom filters and,A:91
in IDS deployment,A:12
IPS, configuration of,A:52–A:53
of Snort,A:18
tuning,A:55–A:57
updates,A:69,A:104
Simple Mail Transfer Protocol (SMTP)
configuration for switch, 559
e-mail attack and,A:169
gateway configuration in DMZ design, 36
IIS server configuration for, 658–659
relay server configuration, 696–697
server publishing rule, 466–469
server publishing rules, creating secure,
486–489
Simple Network Management Protocol
(SNMP)
configuration for router security, 532–533
configuration for security,A:191
on PIX/ASA, 307
polling,A:195,A:214
single firewall network
configuration of, 14–15
pros/cons of, 20, 21
traffic flow, 17, 18
single firewall with bastion host
configuration of, 15–16
pros/cons of, 20, 21
traffic flow, 17, 18
single firewall with screened subnet/bastion
host, 20, 21
site surveys, 156, 166
site-to-site VPN
definition of/solution, 52–55
for Windows DMZ, 49, 91
small servers, 540–541, 560
small services, 540–541
SmartCenter
Check Point clusters and, 113
Check Point firewall design, 321–322
Check Point interface configuration, 326
Secure Platform for, 384
SmartCenter Server
cpconfig utility on, 379–380
function of, 356
Secure Platform configuration and, 360,
362–363
SmartConsole
of Check Point firewall, 319–320
Check Point firewall design, 321–322
cpconfig utility to enable, 379–381
server installation of, 111
SmartDashboard, Check Point
of Check Point firewall, 319–320
firewall configuration in, 325
for interface antispoofing, 327–328
for stateful inspection customization,
328–329
SmartDefense, 320–321
SmartUpdate, 365
SMB (server message block), 79–81,A:190
SMTP. See Simple Mail Transfer Protocol
smurf attacks, 539
Snapshot Image Management, 364–365
snapshot utility, 364
sniffing
description of, 149–150
as passive attack, 147–148
Telnet session, 526
SNMP. See Simple Network Management
Protocol
snmp-server community command, 533
Snort,A:70–A:90
for additional sensors,A:7
BASE,A:72–A:73
BASE, activation of,A:78
BASE, alert database management,
A:87–A:90
BASE, alert groups,A:84–A:86
BASE, configuration of,A:78–A:80
BASE, graphical features of,A:86–A:87
BASE, installation of,A:73–A:78
BASE, querying database,A:82–A:84
BASE, security of,A:80
BASE, using,A:81–A:82
distributions,A:71–A:72
Eagle X,A:70–A:71
overview of,A:101
running as root,A:12
signatures,A:18
URL for,A:3
Webadmin Snort tool,A:72
Snort 2.1 Intrusion Detection, Second
Edition (Syngress Publishing),
A:70
Snort Intrusion Detection and Prevention
Toolkit (Syngress Publishing),
A:70
Snort User’s Manual,A:77
social engineering
description of,A:124–A:125
overview of,A:177
with whois lookup,A:121–A:122
software
Check Point SmartConsole, 319
Check Point solution choice, 318–319
Cisco Adaptive Security Device Manager,
233
Cisco ASA firewall licensing, 235
Cisco ASA firewall software features, 231
Cisco ASA firewall SSM options, 239–240
Cisco ASA/PIX 7.x features, 230–231
Cisco PIX Device Manager, 232
Cisco PIX firewall licensing, 233–235
Cisco PIX firewall version 6.3, 236
Cisco PIX/ASA firewall version 7.2,
236–237
Cisco PIX/ASA software, common
features, 228–230
firewalls for Sun Solaris DMZs, 109–111
high availability for Sun Solaris DMZs,
111–116
on Linux bastion hosts, 670–673
Linux package updates, 676
NetScreen firewall, 394–396
PIX firewall PCI card options, 237–239
for Solaris DMZs, 108–109, 116–117
Solaris installations, 95, 133–134
software emulator,A:141
Software Modularity, 553
Solaris. See Sun Solaris DMZ design
Solaris Security Toolkit (SST), 137–138
SONA (Service-Oriented Network
Architecture), 548
soup bowl analogy, 403
source code,Apache Web server,A:202,
A:203–A:206
Source NAT
description of, 408, 409
dynamic IP, 411–412
MIP, 409–410
policy-based, 410–411
Source Port Address Translation, 408
source routing, IP, 542
space allocation, 118–119
spamming
drive-by spamming, 150
open relay blacklist,A:179–A:180
span,A:12–A:13,A:14,A:17
spanning tree loop (STP loop),A:13
Specter,A:19–A:21
speed settings, PIX/ASA interface, 254,
255–256
SPI Dynamics QAInspect,A:5
SPLAT. See Secure Platform, Check Point
split DNS architecture,A:24
spoofing
description of, 150
DNS spoofing attacks,A:161–A:162,
A:178
e-mail,A:169
interface antispoofing, 327–328
in network hijacking, 154
wireless network, 152
SQL. See Structured Query Language
SQL Slammer worm
ACL configuration to prevent, 521–522
description of attack,A:163
threat of,A:5–A:6
SSC (Security Services Card), 224
SSH. See Secure Shell
ssh address [netmask] [interface_name]
command, 245
ssh timeout command, 245
SSHWindows, 650–652
SSID (Security Set Identifier), 166
SSL. See Secure Socket Layer
SSL Network Extender, 317
SSM, 239–240
SST (Solaris Security Toolkit), 137–138
stack,A:5
stack hardening, 680–681
stacking architecture, 550–551
standalone servers, 623–624
standard ACL, 516–517
standards
security, 8–10
for security policy/plan, 3, 10–11
star topology, 586–587
Starbucks, 592
StartServers directive,A:209
stateful failover
Active/Active stateful failover with cable,
293–294
Active/Active stateful LAN-based,
294–295
Active/Passive stateful failover with cable,
288–291
Active/Passive stateful LAN-based failover,
291–293
of Cisco PIX/ASA 7.x, 231
configuration of, 423–426
with PIX/ASA, 210–211
testing/monitoring, 295
stateful inspection
of Check Point firewall, 320, 328–329
with PIX/ASA firewalls, 230
stateful packet filtering, 13
stateful packet inspection, 439–441
stateful UDP, 329
static command, 265–266, 267, 268
Static NAT, 265, 266–267, 268
Static PAT, 265, 267–268, 269
static routing
firewalling and, 404
overview of, 414
PIX/ASA configuration of, 278–280
static WEP keys, 174
static-secure MAC address, 569–570
stealth rule, 99
Steel-Belted RADIUS (SBR)
features of, 176–177
installation, configuration of, 178–182
LEAP configuration, 182–186
RADIUS authentication process, 177
Windows AD domain authentication with
LEAP/RADIUS, 186–188
sticky-secure MAC address, 569–570
STP loop (spanning tree loop),A:13
stratum, 536
Structured Query Language (SQL)
attacks, hacks,A:178–A:179
internal/external firewall design and, 214
SQL injection,A:147,A:164–A:167
SQL security design,A:163–A:164
SQL Slammer worm, 521–522,A:5–A:6,
A:163
Subsystem Report,A:61
SUID (set user ID), 678
Sun BluePrints, 105
Sun Cluster, 116
Sun E420R, 106
Sun quad interface cards, 107
Sun Solaris
exploit,A:171–A:172
patch management, 130
Sun Solaris 10
new features of, 94–95
security features of, 115
Sun Solaris DMZ design
configuration, 117–128
firewall ruleset, 98–104
hardware selection, 105–108
implementation, 129–139
overview of, 94, 142
server placement, 95–98
software selection, 108–117
Sun Solaris 10, 94–95
system design, 104–105
Sun V480, 106
Sun Validation Test Suite, 138
Sun x4600 series, 106
supervisor engine
of Cisco Catalyst 4500, 551–552
of Cisco Catalyst 6500, 553
support
of bastion hosts, 660
of Linux bastion hosts, 698–699
Nokia, 367, 371
server software selection and, 108–109
support libraries, BASE,A:77
SurfControl integrated mode, 428
SurfControl redirect mode, 427–428
Swatch, 688–689
switch security
best-practice checklist, 572–573
Cisco switches, 544–548, 550–554
disabling unneeded IOS features, 559–560
IO bugs, security advisories, 570–571
network virtualization, 548–550
overview of, 574, 575
private VLANs, 565–569
securely managing switches, 554–559
switch developments, 544
switch ports, securing, 569–570
VLAN Trunking Protocol, 560–561
VLANs, configuration of, 561–565
Sybase SQL Anytime,A:36
Symantec,A:148–A:149
SYN attack, 261, 267–268
SYN scan handshake,A:126–A:127
synchronization, 422, 674–676
sysconfig utility, 360–361, 363
sysctl, 681
syslog
configuration for router security, 534–535
configuration for switch, 559
daemon, enabling on Linux, 688
for DMZ host audit, 119
logging events, importance of, 535–536
server, logging to, 536
system hardening. See hardening, Solaris
system
system hardening checklist, 137–138
system logging, 534–535
system modeling, 127–128
system processes, MC for IPS Sensors,
A:36–A:37
system requirements, IPS Management Center
clients,A:37–A:38
System Services, 636–638
system settings, Solaris DMZ default, 121–122
systems engineering, Windows DMZ, 55–56,
82, 86–87
T
TAC (Technical Assistance Center), Cisco,
244, 524
TACACS server
for port access authentication, 524
for switch console port access
authentication, 555–556
for Telnet access authentication, 525
TACACS+ server
AAA on router and, 531–532
PIX/ASA access authentication, 249
PIX/ASA cut-through proxy and, 297
PIX/ASA firewall software support of, 229
for SSH configuration, 526–527
target, selection of,A:117
TCP. See Transmission Control Protocol
TCP Wrappers, 683, 702
TCPDump, 150
TCP/IP. See Transmission Control
Protocol/Internet Protocol
Technical Assistance Center (TAC), Cisco,
244, 524
technical security, 10
telephone call,A:124–A:125
telephone line. See dial-up phone lines
Teleport Pro,A:4
Telnet
Cisco PIX/ASA access via, 244–245
configuration for router security, 525
data in clear text, 526
enable password and, 529
PIX/ASA cut-through proxy, 297–298
switch Telnet configuration, 556–557
weakness of, 25
Telnet address [netmask] [interface_name]
command, 244
Teraterm,A:141
terminal emulator, 371
terminal program, 243–244
Terminal Services
installation of, 644–646
secure configuration of, 646–649
for Windows 2000 remote administration,
644
terminology, DMZ definitions, 11–13
testing, failover, 295
testing the DMZ
analog connections, probing,A:150–A:151
auditing/logging evasion,A:149–A:150
BIND security,A:160–A:161
cost of network penetration,A:112
defense in depth,A:113–A:115
DMZ hardening checklist,A:173
DNS exploits,A:155–A:160
DNS spoofing attacks,A:161–A:162
e-mail attacks, hacks,A:167–A:170

Index
713
live Linux distributions,A:174–A:175
Metasploit Framework,A:175
network mapping,A:129–A:139
overview of,A:176–A:179
penetration testing,A:113
reconnaissance,A:116–A:126
scanning techniques,A:126–A:128
Solaris exploit,A:171–A:172
SQL attacks, hacks,A:163–A:167
vulnerability scanning,A:139–A:149
war dialing,A:151–A:154
Web site resources for,A:172–A:173
THC-Scan,A:141,A:152
threat
definition of,A:2
identification of potential, 8
three-legged firewall, 210–211
three-tier design, 214–215
three-way handshake,A:9
throughput
Cisco ASA 5510 firewall and, 225
Cisco ASA 5540 firewall and, 226
Cisco ASA 5550 firewall and, 227
Cisco PIX 515E and, 219
Cisco PIX 525 firewall and, 220
Cisco PIX 535 firewall and, 221
time
network time, accuracy of,A:93–A:94
Network Time Protocol, synchronization
with, 536–537
Nokia appliance configuration, 376–377
NTP for HIDS hosts,A:22
synchronization, automatic, 639–640,
674–676
time-based ACLs, 274–276
timeout
SSH, setting, 526
stateful inspection settings, 329
TCP/IP stack hardening and, 680
Timeout directive,A:209
time-range command, 274–276
timestamp, 534, 536
TKIP, 158
T-Mobile, 592
Tomcat application server,A:36
tools
for jamming attack, 155
for network hijacking, 154–155
for sniffing, 150
for wardriving, 148–149
topology
Check Point interface antispoofing,
327–328
Check Point interface configuration, 326
of Windows DMZ design, 48
topology models, VPN
hub-and-spoke topology, 587
meshed topology, 585–586
placement of devices, 589–590
remote access topology, 588–589
star topology, 586–587
trace,A:128
traceroute
check of IP address,A:122,A:123
with Cisco PIX/ASA OS 7.2, 237
disabling redirects and, 539
traffic
Check Point firewall and, 316
control with PIX/ASA, 312
internal/external firewall design and, 214,
215
Internet traffic from remote site, 65–66
multi-DMZ with virtual interfaces and,
213
NetBIOS, SMB, disabling, 79–81
PIX/ASA application inspection, 299–306
PIX/ASA failover requirements, 287–288
PIX/ASA routing, 278–282
port rules for DMZ design, 27–28
from remote site, 65–66
risks, DMZ design and, 32–34
routing between VLANs, 576
server hardware selection and, 106
traffic-flow analysis, 220
VPN, tuning, 598–599
Windows DMZ and, 75–79, 88
traffic class
associating with action, 304–305
defining, 300–304
traffic flow
DMZ concepts, 17–20
DMZ design, protocols, 24–25
DMZ design,TCP/IPv4 and, 25–26
OSI model for DMZ design, 28–29
traffic-flow analysis, 220
Transmission Control Protocol (TCP)
connection request queue, 135–136
handshake,A:126,A:127
small servers, 540–541, 560
TCP Intercept mode, 268
Transmission Control Protocol/Internet
Protocol (TCP/IP)
model, 28–29
stack hardening on Linux bastion hosts,
680–681
TCP/IPv4 flaws, 25–26
three-way handshake,A:9
transparent mode
description of, 401
for PVLAN configuration, 567
of VTP, 561
Trend Micro, 428–429
trimming, alert database,A:88
Triple-DES (3DES), 232, 599
Tripwire
features of,A:23–A:24
for host integrity monitoring, 116
URL for,A:22
Web site resources for,A:7
well-known HIDS system,A:6
Trojan, 29
tunneling application control, 230
Turbo ACL, 274
U
UDP small servers, 540–541, 560
unauthorized access, 151, 170
Unicode attack,A:15–A:16
Uniform Resource Locator (URL), 229,
296–297,A:119–A:120
unique alerts, BASE,A:81–A:82
Unix,A:149,A:200
unreachables, 539
Unrestricted license, Cisco PIX firewall, 234
untrusted systems, 642
updates
Linux bastion hosts, 676–678
for Microsoft operating system,A:186
patches for DMZ hosts,A:180
for Secure Platform, 365
sensor software/signatures,A:69
for sensors,A:104
for WDMZ, 165
for Web server,A:27
Windows Update, access rule allowing,
457–458
upgrade, of Cisco PIX firewall license, 234
UPS Tracking System, 606
URL (Uniform Resource Locator), 229,
296–297,A:119–A:120
URLScan tool, 655–656,A:191
U.S. veterans, 2
USB drive, 667
user account,A:186–A:188,A:201–A:202
user directives,A:208
user enumeration, 80
user ID,A:165
user licenses, Cisco PIX firewall, 233
User Rights Assignment, 632–633
username
for PIX Device Manager, 247
PIX/ASA access authentication, 249
Secure Platform configuration, 360
for SSH configuration, 526–527
SSH for PIX/ASA access, 246
VPN remote access topology and, 588
users
adding to CiscoWorks,A:41–A:42
authenticated, all open rule for, 480–481
utilities
chkconfig, 670
for Linux package management, 672
Lockdown Tool, 654–655
pup, 672
RDPclip, 650
RPM Package Manager, 672
sysctl, 681
URLScan tool, 655–656
Yellowdog updater modified, 672
V
V3PN solution, 595
VAC, 238
VAC+, 238
VACL,A:14
vendor enhancements, IPSec, 608
Veritas Cluster Server, 115
Version String banner,A:161
viewing
database rule,A:69
reports,A:63
VIP. See Virtual IP
virtual directories,A:191
virtual firewalls, 283–285
virtual interfaces, 213–214, 231
Virtual IP (VIP)
description of, 409
Destination NAT and, 412–413
MIP vs., 433
Virtual LAN (VLAN)
802.1q VLANs, support of, 384
Cisco ASA 5505 firewall’s support of, 224
configuration of, 561–565
in DMZ, tips for designing, 563–565
management VLAN for switch Telnet
configuration, 556–557
multi-DMZ with virtual interfaces,
213–214
private VLANs, 565–569
routing traffic between, 576
Secure Platform network configuration,
361
switch network segmentation with,
561–563
tags, multi-tiered DMZ and, 16
virtual private dialup network (VPDN), 580
Virtual Private Network (VPN)
ASA firewall software and, 231
Check Point capabilities for, 317
Cisco PIX/ASA OS 7.2 and, 237
definition of, 578
DMZ design concepts, 34
failover, of Cisco PIX/ASA 7.x, 231
Network Access Protection, 84
PIX/ASA firewall software features, 229
server, enterprise wireless gateway as, 161
site-to-site, 52–54, 91
solutions in Windows DMZ, 55–56, 87
Virtual Private Network (VPN) appliance
of Nokia, 592–593
VPN termination at, 583–585
Virtual Private Network (VPN) services, in
DMZ
B2B sites, connecting, 605–610
business partner connections, 590–591
deployment models, 580–585
function of, 579
IPSec solution, 598–605
overview of, 610–612
remote access services, 591–598
topology models, 585–590
VPN overview, 578–579
WAN topology, 579, 580
Virtual Private Network (VPN) tunnel
choice of termination point, 580
with Cisco PIX 501, 217
extranet VPN termination, 607
IPSec management strategy, 600–601
LEAP and, 173
meshed VPN topology and, 586
PIX firewall VAC options for, 238
termination at dedicated VPN appliance,
583–585
termination at edge router, 581, 582
termination at firewall, 583, 613
in wireless DMZ example, 164
virtual router (VR)
assigning zones to, 402–403
NetScreen, 400–401
reasons for multiple, 432
Virtual Routing and Forwarding (VRF)
of Cisco Catalyst 3560, 547–548
options for, example of, 548–550
virtual security device (VSD), 419–420, 423
virtual security interface (VSI), 419–420
virtual system (VSYS), 399–400
virtualization. See network virtualization
virtualization, NetScreen
description of, 399
interface modes, 401
NetScreen firewall, 419–420
security zones, 399
virtual routers, 400–401
virtual systems, 399–400
virus, 29, 313
VLAN. See Virtual LAN
VLAN Trunking Protocol (VTP), 560–561
VLAN-hopping attack, 213
VMS Suite. See CiscoWorks VPN and
Security Management (VMS)
Suite
VNC, 693
VNC dll injection payload,A:175
Voyager Guide (Nokia), 374
VPDN (virtual private dialup network), 580
VPN. See Virtual Private Network
VPN and Security Managements Suite. See
CiscoWorks VPN and Security
Management (VMS) Suite
VPN Edition, Cisco ASA firewall, 222, 223
VPN tunnel. See Virtual Private Network
(VPN) tunnel
VPN-1 Express, Check Point, 318
VPN-1 Power, Check Point, 318
VPN-1 Pro, Check Point, 318
VPN-1 UTM, Check Point, 318
VPN-1 UTM Edge, 319
VR. See virtual router
VRF (Virtual Routing and Forwarding)
of Cisco Catalyst 3560, 547–548
options for, example of, 548–550
VRF-lite, 547, 549
VSD (virtual security device), 419–420, 423
VSI (virtual security interface), 419–420
VSYS (virtual system), 399–400
VTP (VLAN Trunking Protocol), 560–561
vtp mode transparent command, 561
vulnerabilities
of Apache Web server,A:198–A:199
of Microsoft IIS Web Server,A:184–A:185
of Microsoft OS/IIS server,A:190–A:191
SANS Top 20 list,A:141–A:145
WEP, 205
. See also risks
vulnerability, definition of,A:2
vulnerability scanning
of bastion hosts, 617
default configuration/passwords for
servers,A:145–A:149
LANGuard,A:140–A:141
with Nessus,A:139–A:140
results, bastion host hardening with,
621–622
SANS Top 20 list,A:141–A:145
W
W3C Extended Log File Format,A:194
WAN. See Wide Area Network
WAP (wireless access point), 156
war dialing,A:151–A:154
War Games (film),A:152
war plugging, 148
wardriving
ease of, 155
as passive attack, 147–148
tools for, 148–149
WayPort, 592
Web browser, 63
Web Cache Communication Protocol
(WCCP), 237
Web filtering, NetScreen
description of, 426
SurfControl integrated mode, 428
SurfControl redirect mode, 427–428
Websense redirect mode, 426–427
Web intelligence, 321
Web proxy client, 493–497
Web screen interface (WebUI), 396, 397–398
Web security services, of Cisco PIX/ASA 7.x,
230
Web server
for BASE,A:74–A:76
Check Point rules for access, 332–333
hardening,A:26–A:29
Linux bastion host, 694
Microsoft IIS Web Server, hardening,
A:184–A:195
password,A:79
in three-tier design, 214–215
on Windows DMZ, 55, 73–74, 87, 88–89
Web services
firewall rules for private network, 99–101
firewall rules for public networks, 102
Web site resources
AAA, 531
Apache Foundation source code,A:203
Apache security advisory,A:199
Apache Web server download,A:202
Apache Web server guides,A:201
Apache Web server logging directives,
A:212
ARIN Web site, 510
ARP spoof, 154
BASE support libraries,A:77
for Basic Security Module, 119
BGP Case Studies document, 509
BIND,A:157–A:158,A:161
BIND attacks,A:159
CatOS, 546
for Check Point, 111
for Check Point hardening, 138

714
Index
Check Point OPSEC web site, 357
Cisco 3000 series VPN concentrator, 596
on Cisco Catalyst switch line, 546, 547,
551, 552
Cisco PIX 535, 221
Cisco PIX OS 6.3, 236
Cisco PIX/ASA software releases, 236
Cisco Product Security Advisories and
Notices page, 571
Cisco SAFE Blueprints, 571
Cisco Secure Access Control Server, 250
Cisco span tutorial,A:13
Cisco TAC, 244, 524
for ClusterXL, 113–114
for COPS, 126
Cult of the Dead Cow,A:160
for CVE, 102
default SSIDs, 166
for DNSSEC, 102
Eagle X,A:70
on extended ACL, 518
for Fedora Core, 668
fping,A:138
on group-specific server isolation, 641
HIDS products,A:22
Honeynet Project,A:4
honeypots,A:18,A:19
on invalid address ranges, 520
IPSec-NAT Compatibility Requirements
(IETF), 613
for IPTables, 686
for ISA Server 2004/Exchange Server
deployment kit, 459
for Lockdown Tool, 654
Log Parser,A:194–A:195
logsnorter,A:73
for MBSA, 620
MC for IPS Sensors installation,A:34
on Microsoft IPSec support, 643
Microsoft patches,A:186
Microsoft security advisory site,A:185
Microsoft Technet article, 193
for Microsoft Update, 625
mod_security module, 205,A:205
for Nessus, 618
Nessus,A:140
network tap manufacturers,A:13
Nokia, 593
Nokia CLISH guide, 376
Nokia support page, 371
Nokia Voyager Guide, 374
for NoMachine NX, 693
NTP Public Services Project, 536
for OpenSSH, 650
operating systems/security sites of,A:199
on passwords, effective,A:149
PIX default inspection ports, 302–304
on PIX Device Manager installation, 232
PIX/ASA, 596
private VLANs, 567
for RDP, 646
for RDPclip utility, 650
for Red Hat, 668
RFC 1918, 258
on routing, 507
RTFC/802.1x definitions, 161
SANS,A:149
for secureCRT, 650
for SELinux, 678–679, 680
SELinux, Bastille-Linux,A:27
for server security statistics, 622
server/domain isolation information, 67,
640
signatures,A:91
Snort,A:3
Snort rules,A:89
Snort signatures,A:18
for Solaris patches, 130
SONA, 548
split DNS architecture,A:24
on SQL attacks,A:166–A:167
SSH information, 527
SSH providers, 526
for SST, 137
for Sun BluePrints, 105
for Sun Validation Test Suite, 138
for testing DMZ,A:172–A:173
testing tools,A:174
Tripwire,A:7,A:23
for UNIX tools for Windows, 650
war dialers,A:152
war dialing,A:154
wardriving tools, 148
Web site content ripping,A:4
Webalizer,A:214
whois lookup,A:120
WildPackets, 147
for Windows Server Update Services, 627
wireless network signal radiation, 166
Web sites
anonymous public, setting up, 652–654
Cisco LEAP, 176
DMZ design and, 35–36
Juniper Networks, 176
logging, configuring, 656–658
protocol IDs list, 24
RFCs/802.1x protocol, 173
SANS Top 20 list, 32
security of content,A:4–A:5
setting up secure, 658
TCP/IP flaws/improvements, 26
Webadmin Snort tool,A:72
Webalizer,A:214
Web-based code,A:185,A:198
WebSense redirect mode, 426–427
WebSense server, 296–297
WebUI (Web screen interface), 396, 397–398
weight attribute, 511
WEP. See Wireless Encryption Protocol
WEP keys
configuration of, 182
with LEAP, 172–173, 174
WEPCrack, 149, 154, 155
WEPlab, 149
What’s Up Professional,A:17
whitelisting, 99
whois lookup
connection checking,A:122–A:123
internal vs. externally hosted DNS,
A:123–A:124
steps of,A:119–A:122
Wide Area Network (WAN)
for business partner connections, 590
link for Windows DMZ, 62–67
topology, 579, 580
with VPN, 582
VPN services for, 578
WiFi, 146
Wi-Fi Protected Access (WPA), 157, 158
WildPackets,AiroPeek, 147
window manager, 673, 674
Windows
configuration vulnerabilities,A:145
libraries, vulnerabilities of,A:143–A:144
services, vulnerabilities of,A:142–A:143
VPN services of, 597–598
Windows 2003, PEAP implementation on
components for, 191
IAS server, setting up, 195–202
Microsoft Certificate Services, 191–193
RADIUS server load balancing,
redundancy, 202–203
Wireless Computer object, creating,
193–195
Wireless User Group, creating, 193
Wireless User object, creating, 195
Windows Active Directory, 186–188
Windows bastion hosts
automatic time synchronization, 639–640
checklist, 660
configuration of, 616, 622, 661
configurations, 652–658
disk partitions, 624–625
domain members vs. standalone servers,
623–624
high-security policy, applying, 638–639
IIS server, configuring for SMTP, 658–659
installation overview, 624
local administrator account, creating, 628
maintenance/support, 660
optional components, removing, 627
overview of, 616
remote administration, 644–652
security configuration with MMC,
628–638
security testing, 617–622
server/domain isolation, 640–644
service packs/hot fixes, 625–627
Windows DMZ, building
designing Windows DMZ style, 59–67
DNS servers in DMZ, 74–75
elements of, 58–59
mail services, 72–73
NetBIOS, SMB, disabling, 79–81
perimeter security, 67–72
traffic, engineering, 75–79
Web servers, 73–74
Windows DMZ design
building Windows DMZ, elements of,
58–59
designing Windows DMZ style, 59–67
DNS servers in DMZ, 74–75
fundamental, 47–49
Longhorn features and, 83–84
mail services, 72–73
NetBIOS, SMB, disabling, 79–81
network engineering, 49–52
overview of, 46–47
perimeter security, 67–72
planning list, 81–83
security analysis, 56–57
site-to-site VPN, 52–55
systems engineering, 55–56
traffic, engineering, 75–79
Web servers, 73–74
Windows Server 2003 R2, new features
in, 57–58
Windows Event Viewer, 197
Windows Server 2003 R2, 57–58
Windows Server Update Services (WSUS),
627
Windows Update, 457–458
WINS servers, 71–72
wireless access point (WAP), 156
Wireless Computer object, 193–195
wireless devices, 165
wireless DMZ (WMDZ)
active attacks on wireless network,
150–153
components, 158–162
decision to implement, 169
design of, 156–158
examples of, 162–164
jamming attacks, 155
MITM attacks on wireless network,
153–155
overview of, 167–169
passive attacks on wireless network,
147–150
security, best-practices checklist, 165–166
security of WLAN, 146–147
wireless DMZ (WMDZ), implementation of
Juniper Steel-Belted RADIUS, 176–186
PEAP, 188–203
RADIUS with Cisco LEAP, 172–176
Windows AD domain authentication with
LEAP/RADIUS, 186–188
Wireless Encryption Protocol (WEP)
active attacks on wireless network, 150,
151
cracking tools, 175
insecurity of, 170
security issues, 205
TKIP replacement of, 158
tools for cracking, 149
for WDMZ, 157
wireless gateway, 161, 163
wireless LANs (WLANs)
active attacks on wireless network,
150–153
jamming attacks, 155
MITM attacks on wireless network,
153–155
passive attacks on wireless network,
147–150
security of, 146–147
wireless network
active attacks on, 150–153
attacks on, 167–168
decision to implement, 169
jamming attacks on, 155
MITM attacks on, 153–155
passive attacks on, 147–150
wireless policy, 198–200
Wireless User Group, 193
Wireless User object, 195
Wireshark,A:16,A:141
WLANs. See wireless LANs
WMDZ. See wireless DMZ
worms
Blahot worm,A:91
password vulnerability and,A:145
passwords and,A:145
PIX/ASA protection against, 313
SQL Slammer worm, 521–522,A:5–A:6,
A:163
Zotob,A:142–A:143
WPA (Wi-Fi Protected Access), 157, 158
WPA2, 157
WPAD entries, 490–493
WSUS (Windows Server Update Services),
627
X
X Windows, 693, 702
xfrnets feature,A:24
xinetd, 669
Y
Yellowdog updater modified (YUM), 672
Yet Another Solaris Security Package
(YASSP), 126
Z
Zettabyte File System (ZFS), 95, 119
zombies,A:123
zone transfer,A:156–A:157,A:161
zones, security
address objects, binding to, 432
advantages of, 431
assigning to virtual routers, 402–403
binding interface to, 403
multiple connected to backbone network,
437–439
zones, Sun Solaris, 94–95
Zotob worm,A:142–A:143

