
Disaster Recovery Using VMware
vSphere Replication and vCenter
Site Recovery Manager Second
Edition

Table of Contents
Disaster Recovery Using VMware vSphere Replication and vCenter Site
Recovery Manager Second Edition
Credits
About the Author
About the Reviewer
www.PacktPub.com
eBooks, discount offers, and more
Why subscribe?
Instant updates on new Packt books
Preface
What this book covers
What you need for this book
Who this book is for
Conventions
Reader feedback
Customer support
Downloading the color images of this book
Errata
Piracy
Questions
1. Installing and Configuring vCenter Site Recovery Manager (SRM) 6.1
Introduction
So what exactly are RPO and RTO?
What is Site Recovery Manager?
Site Recovery Manager(SRM) architecture
Array manager
Storage Replication Adapter (SRA)
Laying the groundwork for an SRM environment
Preparing storage for array-based replication
Host presentation (Zoning) at the protected and the recovery sites
Installing SRM on both the protected and recovery sites
Performing the SRM installation

Pairing SRM sites
Installing the Storage Replication Adapters
Downloading the SRAs
Installing the SRA
Adding array managers and enabling array pairs
Configuring placeholder datastores
Creating resource, folder, and network mappings
Resource mappings
Folder mappings
Network mappings
Virtual machine swap file location
Design choice 1: Separate datastore for the swap files
Design choice 2: Store the swap files in the VM's working directory
Summary
2. Creating Protection Groups and Recovery Plans
Understanding datastore groups
Understanding protection groups
Storage policy-based protection groups
Creating a protection group
What happens when you create a protection group?
Understanding recovery plans
Creating a recovery plan
Summary
3. Testing and Performing a Failover and Failback
Testing a recovery plan
Test workflow
Running the test
Testing a recovery plan – background
Performing the cleanup after a test
Performing a planned migration
Performing a disaster recovery (failover)
Performing a forced recovery
Enabling forced recovery for a site
Running a forced recovery
Reprotecting an SRM site
Performing a failback to an SRM protected site

IPv4 customization rules
Creating an IPv4 customization rule
How does SRM use IP customization rules?
Configuring VM recovery properties
IP customization
Recovery properties
Priority group
VM dependencies
Shutdown action
Startup action
Pre-power on and post-power on steps
Summary
4. Deploying vSphere Replication
Introduction
New features in vSphere Replication 6.1
Understanding the vSphere Replication architecture
Downloading the vSphere Replication bundle
Deploying the vSphere Replication Appliance
How does it work
Setting the VRA hostname and a VRM site name for the VRA
VRA hostname
VRM site name
Configuring a SQL database for VRMS
Deploying a vSphere Replication Server
Registering vSphere Replication Servers
Summary
5. Configuring and Using vSphere Replication 6.1
Adding a remote site as a target
Configuring replication for a VM to the local/remote site
How does replication work?
Using replication seeds
Monitoring replication
Reconfiguring replication
Changing the target datastore
Pausing an Ongoing replication
Synchronize Data Immediately

Stopping replication on a VM
Moving replication to another VR Server
Recovering virtual machines
Configuring failback for VMs
Using SRM with vSphere Replication
Creating a vSphere Replication protection group
Creating a vSphere Replication recovery plan
Testing a vSphere Replication recovery plan
Performing a recovery or a planned migration
Preforming a failback (re-protect and failover)
Summary
6. Using vRealize Orchestrator (vRO) to Automate SRM and vSphere
Replication
Deploying and configuring vRealize Orchestrator
Downloading vRealize Orchestrator
Deploying vRealize Orchestrator
Using the vRealize Orchestrator client
Configuring vRealize Orchestrator
Configure vRO database
Configure authentication provider
Enabling vRealize Orchestration for a vCenter
Adding a vCenter Server instance to vRO
Registering vRO as a vCenter Server extension
Install vRealize Orchestrator plugins for SRM and vSphere
Replication
Downloading the vRO plugins for SRM and vSphere Replication
Installing vRO plugins
Troubleshooting SRM and vSphere Replication
Getting to the logs
Analyzing vSphere Replication logs
Analyzing SRM logs
Increasing the logging level for SRM
Troubleshooting references
Summary
Index

Disaster Recovery Using VMware
vSphere Replication and vCenter
Site Recovery Manager Second
Edition

Disaster Recovery Using VMware
vSphere Replication and vCenter
Site Recovery Manager Second
Edition
Copyright © 2016 Packt Publishing
All rights reserved. No part of this book may be reproduced, stored in a
retrieval system, or transmitted in any form or by any means, without
the prior written permission of the publisher, except in the case of brief
quotations embedded in critical articles or reviews.
Every effort has been made in the preparation of this book to ensure the
accuracy of the information presented. However, the information
contained in this book is sold without warranty, either express or
implied. Neither the author, nor Packt Publishing, and its dealers and
distributors will be held liable for any damages caused or alleged to be
caused directly or indirectly by this book.
Packt Publishing has endeavored to provide trademark information
about all of the companies and products mentioned in this book by the
appropriate use of capitals. However, Packt Publishing cannot guarantee
the accuracy of this information.
First published: May 2014
Second edition: October 2016
Production reference: 1201016
Published by Packt Publishing Ltd.
Livery Place

35 Livery Street
Birmingham B3 2PB, UK.
ISBN 978-1-78588-609-6
www.packtpub.com

Credits
Author
Abhilash G B
Reviewer
Dan Frith
Commissioning Editor
Pratik Shah
Acquisition Editors
Prachi Bisht
Subho Gupta
Content Development Editor
Sanjeet Rao
Technical Editor
Devesh Chugh
Copy Editor
Tom Jacob
Project Coordinator
Judie Jose
Proofreader

Safis Editing
Indexer
Pratik Shirodkar
Graphics
Kirk D'Penha
Production Coordinator
Shantanu N. Zagade
Cover Work
Shantanu N. Zagade

About the Author
Abhilash G B (@abhilashgb) is a virtualization specialist, author,
designer, and a VMware vExpert (2014, 2015, and 2016), who
specializes in the areas of data center virtualization and cloud
computing.
He has been in the IT industry for more than a decade and has been
working on VMware products and technologies since the start of 2007.
He currently works as a senior VMware consultant for one of largest
information technology and services company in the world.
He holds several VMware certifications including VCP3, VCP4, VCP5-
DCV, and VCP-Cloud. He also holds advanced certifications such as
VCAP4-DCA and VCAP5-DCA.
He is also the author of some other books published by Packt Publishing
—VMware vSphere 5.1 Cookbook in July 2013, Disaster Recovery
using VMware vSphere Replication and vCenter Site Recovery
Manager in May 2014, VMware vSphere 5.5 Cookbook in February
2015, and a co-author of the book Learning VMware vSphere in
October 2016.
I dedicate this book to my family. Without their patience and support
this book would not have been possible.
Thanks to the technical reviewer Dan Frith for his valuable input.
Special thanks to the entire Packt Team for their support during the
course of writing this book.

About the Reviewer
Dan Frith (@penguinpunk) has been working with various data center
technologies for the last fifteen years and has focused on storage and
virtualization for the last ten years. He currently works for a global
systems integrator as a consultant and has significant experience with
government and large enterprise. Dan is passionate about enabling
business to succeed through technology. After working hours, Dan
enjoys spending time with his family, blogging, playing basketball
(badly), and listening to records.

www.PacktPub.com
eBooks, discount offers, and more
Did you know that Packt offers eBook versions of every book
published, with PDF and ePub files available? You can upgrade to the
eBook version at www.PacktPub.com and as a print book customer, you
are entitled to a discount on the eBook copy. Get in touch with us at
<customercare@packtpub.com> for more details.
At www.PacktPub.com, you can also read a collection of free technical
articles, sign up for a range of free newsletters and receive exclusive
discounts and offers on Packt books and eBooks.
https://www.packtpub.com/mapt
Get the most in-demand software skills with Mapt. Mapt gives you full
access to all Packt books and video courses, as well as industry-leading
tools to help you plan your personal development and advance your
career.
Why subscribe?
Fully searchable across every book published by Packt
Copy and paste, print, and bookmark content
On demand and accessible via a web browser
Instant updates on new Packt books
Get notified! Find out when new books are published by following
@PacktEnterprise on Twitter or the Packt Enterprise Facebook page.

Preface
This book covers the use of vSphere Replication and VMware Site
Recovery Manager to make your vSphere environment recoverable in
the event of a disaster. All the concepts and tasks covered in this book
are for vSphere Replication 6.1 and VMware vCenter Site Recovery
Manager 6.1.
What this book covers
Chapter 1, Installing and Configuring vCenter Site Recovery Manager
(SRM) 6.1, introduces you to the architecture of SRM and also guides
you through the process of installing and configuring SRM to leverage
array-based replication.
Chapter 2, Creating Protection Groups and Recovery Plans, teaches
you how to configure protection for virtual machines by creating
Protection Groups and creating an orchestrated runbook with the help of
Recovery Plans.
Chapter 3, Testing and Performing a Failover and Failback, teaches
you how to test the recovery plans that were created and also perform a
Planned Migration, a Failover, and a Failback using them.
Chapter 4, Deploying vSphere Replication, guides you through the steps
required to deploy vSphere Replication Appliances and vSphere
Replication Servers.
Chapter 5, Configuring and Using vSphere Replication 6.1, teaches you
how to add target sites and enable replication on virtual machines and
recover them. It also teaches you how to configure vCenter SRM to
leverage the vSphere Replication engine.
Chapter 6, Using vRealize Orchestrator (vRO) to Automate SRM and
vSphere Replication, guides you through the process of deploying and
configuring vRealize Orchestrator. It also teaches you how to install

vRO plugins for SRM and vSphere Replication and has instructions
which will help you to locate SRM and vSphere replication logs and use
them for troubleshooting issues.

What you need for this book
If you were to follow along with each chapter by practicing the tasks in
a lab, then you would need two ESXi hosts, two vCenter Servers, two
SRM instances, and two storage array nodes with replication configured
between them. This might sound like a lot of hardware, but all you need
is a VMware Workstation or VMware Fusion and a Virtual Storage
Appliance such as HP Store Virtual (LeftHand networks). You could get
a trial license for HP Store Virtual by registering for one at HP's website.
For the suggested lab architecture the ESXi hosts, vCenter Servers,
vSphere Replication Appliances, SRM Servers, and the storage nodes
will be virtual machines that are hosted using the VMware
Workstation/Fusion.

Who this book is for
This book is a guide for anyone who is keen on using vSphere
Replication or vCenter Site Recovery Manager as a disaster recovery
solution. This is an excellent handbook for solution architects,
administrators, on-field engineers, and support professionals. Although
the book assumes that the reader has some basic knowledge of data
center virtualization using VMware vSphere, it can still be a very good
reference for anyone who is new to virtualization.

Conventions
In this book, you will find a number of text styles that distinguish
between different kinds of information. Here are some examples of
these styles and an explanation of their meaning.
Code words in text, database table names, folder names, filenames, file
extensions, pathnames, dummy URLs, user input, and Twitter handles
are shown as follows: "Every virtual machine will have a swap file
(.vswp)".
Any command-line input or output is written as follows:
c:\windows\system32\cmd.exe /c d:\demoscript.bat
New terms and important words are shown in bold. Words that you
see on the screen, for example, in menus or dialog boxes, appear in the
text like this: "The Ready to complete screen will summarize the
settings; review them and click on Finish to initiate the test."
Note
Warnings or important notes appear in a box like this.
Tip
Tips and tricks appear like this.

Reader feedback
Feedback from our readers is always welcome. Let us know what you
think about this book—what you liked or disliked. Reader feedback is
important for us as it helps us develop titles that you will really get the
most out of.
To send us general feedback, simply e-mail <feedback@packtpub.com>,
and mention the book's title in the subject of your message.
If there is a topic that you have expertise in and you are interested in
either writing or contributing to a book, see our author guide at
www.packtpub.com/authors.

Customer support
Now that you are the proud owner of a Packt book, we have a number
of things to help you to get the most from your purchase.
Downloading the color images of this book
We also provide you with a PDF file that has color images of the
screenshots/diagrams used in this book. The color images will help you
better understand the changes in the output. You can download this file
from
http://www.packtpub.com/sites/default/files/downloads/DisasterRecovery
Errata
Although we have taken every care to ensure the accuracy of our
content, mistakes do happen. If you find a mistake in one of our books
—maybe a mistake in the text or the code—we would be grateful if you
could report this to us. By doing so, you can save other readers from
frustration and help us improve subsequent versions of this book. If you
find any errata, please report them by visiting
http://www.packtpub.com/submit-errata, selecting your book, clicking
on the Errata Submission Form link, and entering the details of your
errata. Once your errata are verified, your submission will be accepted
and the errata will be uploaded to our website or added to any list of
existing errata under the Errata section of that title.
To view the previously submitted errata, go to
https://www.packtpub.com/books/content/support and enter the name of
the book in the search field. The required information will appear under
the Errata section.
Piracy
Piracy of copyrighted material on the Internet is an ongoing problem
across all media. At Packt, we take the protection of our copyright and

licenses very seriously. If you come across any illegal copies of our
works in any form on the Internet, please provide us with the location
address or website name immediately so that we can pursue a remedy.
Please contact us at <copyright@packtpub.com> with a link to the
suspected pirated material.
We appreciate your help in protecting our authors and our ability to
bring you valuable content.
Questions
If you have a problem with any aspect of this book, you can contact us
at <questions@packtpub.com>, and we will do our best to address the
problem.

Chapter 1. Installing and
Configuring vCenter Site
Recovery Manager (SRM) 6.1
In this chapter, we will cover the following topics:
What is Site Recovery Manager (SRM)?
Laying the groundwork for an SRM environment
Host presentation (Zoning) at the protected and recovery sites
Installing SRM on both the protected and recovery sites
Pairing SRM sites
Installing the Storage Replication Adapters
Adding array managers and enabling array pairs
Configuring placeholder datastores
Creating resource, folder, and network mappings
Virtual machine swap file location
Introduction
With today's IT infrastructures, be it virtual or physical, disaster
recovery is of prime importance. Any business should be able to
continue operating with reduced downtime for its sustainability among
the competition. It also has a legal obligation toward customers to whom
it sold its services. Two of the major factors used to market or sell a
service are its High Availability and Recoverability.
Recoverability is the guarantee that the service offered and its data are
protected against failures, and High Availability is the guarantee that the
service offered would remain operational and the failures are handled in
a way that the user of the service would not even know that there was a
failure.
There are many ways in which businesses plan and implement disaster
recovery. Although important, much of these decisions depend on the

budgetary constraints. What turns out to be the most important is the
existence of a disaster recovery plan. Gone are those days when you had
to wait for a long period of time before all your critical applications were
made available at a recovery site. With a lot of automation and scripting,
businesses now expect better Recovery Point Objective (RPO) and
Recovery Time Objective (RTO).

So what exactly are RPO and
RTO?
RPO defines the amount of data an organization can afford to lose when
measured against time.
RTO defines the amount of downtime the organization can afford for its
services before it becomes operational again.
Both RPO and RTO are defined by time. For example, an organization
can have an RPO set to 4 hours and RTO set to 1 hour. This means, it
can afford to lose up to 4 hours of data, but it can only afford a service
downtime up to 1 hour.
RTO only defines the amount of time a service can remain unavailable
but doesn't account for the data loss. This is where RPO pitches in. It
defines how much data loss can be afforded.
For example, if you were a company hosting an online document format
conversion service, then setting a lower RTO value is very important
because the customers will prefer access to the service, rather than to
the historical data. The RPO value will determine how much historical
data you will have to keep.
Both RPO and RTO help an organization to determine the type of
backup and disaster recovery solution to meet the business
requirements.

What is Site Recovery Manager?
vCenter Site Recovery Manager (SRM) is an orchestration software
that is used to automate disaster recovery testing and failover. It can be
configured to leverage either vSphere replication or a supported array-
based replication. With SRM, you can create protection groups and run
recovery plans against them. These recovery plans can then be used to
test the Disaster Recovery (DR) setup, perform a planned failover, or
be initiated during a DR. SRM is a not a product that performs an
automatic failover, which means there is no intelligence built into SRM
that would detect a disaster/outage and cause failover of the virtual
machines (VMs). The DR process should be manually initiated. Hence,
it is not a high-availability solution either, but purely a tool that
orchestrates a recovery plan.
Site Recovery Manager(SRM) architecture
vCenter SRM is not a tool that works on its own. It needs to
communicate with other components in your vSphere environment. I
will walk you through all the components involved in an environment
protected by SRM.
The following are the components that will be involved in an SRM-
protected environment:

SRM requires both the protected and the recovery sites to be managed
by separate instances of vCenter Server. It also requires an SRM
Instance at both the sites. SRM now uses PSC as an intermediary to
fetch vCenter information.
The following are the possible multiple topologies:
As mentioned previously, SRM cannot work on its own. This is because
it is only an orchestration tool and does not include a replication engine.
However, it can leverage either a supported array-based replication or
VMware's proprietary replication engine, vSphere Replication. We
have separate chapters covering vSphere Replication.
Array manager
Each SRM instance needs to be configured with an array manager for it
to communicate with the storage array. The array manager will detect
the storage array using the information you supply to connect to the
array. Before adding add an array manager, you will need to install an
array specific Storage Replication Adapter (SRA). This is because the

array manager uses the installed SRA to collect the replication
information from the array:
Storage Replication Adapter (SRA)
The SRA is a storage vendor provided component that makes SRM
aware of the array's replication configuration at the array. SRM
leverages the SRA's ability to gather information regarding the replicated
volumes and direction of the replication from the array.
SRM also uses the SRA for the following functions:
Test Failover
Recovery
Reprotect

We will learn more about these functions in the next chapter. For now, it
is important to understand that SRM requires an SRA to be installed for
all of its functions leveraging array-based replication.
When all these components are put together, a site protected by SRM
would look as depicted in the following figure:
SRM conceptually assumes that both the protected and the recovery
sites are separate, regardless of their geographical location. But such a
separation is not mandatory. You can use SRM to protect a chassis of
servers and have another chassis in the same data center as the recovery
site. Now that we have a brief understanding of the SRM architecture, it
is time to learn how to setup these components.

Laying the groundwork for an
SRM environment
You will need to perform a set of configuration activities to lay the
groundwork for an SRM environment so that it can be used to test or
execute the recovery plans.
Here is an outline of the tasks that need to be done to form an SRM
environment:
Preparing the storage for array-based replication
Host presentation (zoning) at the protected and recovery sites
Installing SRM on both the protected and recovery sites
Pairing the SRM instances
Installing the SRA
Adding the array managers
Enabling the array pairs
Creating resource, folder, and network mappings
Creating placeholder datastores

Preparing storage for array-based
replication
The first thing that you will need to do is to make sure that your array is
supported by VMware and licensed for array replication by the array
vendor. Array Replication is a licensed feature from the storage vendor.
Now, to enable replication, you have a couple of approaches that you
can employ:
Approach-
1
Identify the VMs that you want to protect
Identify the VMFS datastores the VMs have their files on
Identify the LUNs corresponding to the already identified datastores
Enable replication on the identified LUNs
Approach-
2
Identify the VMs that you want to protect
Plan the sizing of a datastore large enough to hold all the identified VMs
Create a LUN large enough to host the datastore
Present the new LUN to the hosts running the identified VM and create a new
VMFS volume (datastore) on it
Migrate the VMs that you want to protect onto the new datastore
Enable replication on the new LUN that corresponds to the new datastore
Approach-1: This is used in scenarios where the array does not
have the spare capacity to provision a separate LUN for host-
protected VMs. This approach adds an administrative overhead if
the VMs are spread across multiple datastores. It also contributes to
the wastage of replication bandwidth and storage space, since the
LUNs that are replicated will also contain unprotected VM data.
Approach-2: This is used in scenarios where you have ample spare
capacity. This approach is the best as it reduces the complexity and
avoids the wastage of replication bandwidth and space, unlike
Approach-1. However, this approach will have an impact on the size
of the LUNs required at both the protected and replication sites.

Host presentation (Zoning) at the
protected and the recovery sites
If you are involved in a new implementation, then you will have to plan
how the ESXi hosts are zoned to the array at both the protected and
recovery sites. This means that LUNs should be correctly zoned at the
Fabric:
At the protected site array, zone the ESXi hosts to communicate
with the array, and make sure that the LUNs housing the VMs to be
protected are assigned to the ESXi hosts
At the recovery site array, zone the ESXi hosts to the array, but do
not map the replica LUNs to the hosts yet
Installing SRM on both the protected and
recovery sites
VCenter SRM has to be installed at the both the protected and recovery
sites for the disaster recovery setup to work. The installation process is
identical regardless of the site it is being installed at; the only difference
is that at each site, you will be registering SRM installation to the
vCenter Server managing that site.
SRM can be installed either on the same machine that has vCenter
Server installed or on a different machine. The decision to choose one of
the installation models depends on how you want to size or separate the
service-providing machines in your infrastructure. The most common
deployment model is to have both vCenter and SRM on the same
machine. The rationale behind this is that SRM will not work in
standalone mode, that is, if your vCenter Server goes down, there is no
way to access SRM. Like vCenter Server, SRM can be installed either
on a physical or on a virtual machine.
Another factor that you would want to take into account is the
installation of the SRA. SRAs have to be installed on the same machine

where you have SRM installed. Some SRAs would need a reboot after
they are installed. So, it is important to read through the storage vendor's
documentation prior to proceeding to make a deployment choice for
SRM. If the vCenter downtime is not feasible, then you will have to
consider installing SRM on a separate machine.
Nevertheless, it is important to make yourselves aware of the software
and hardware requirements of a software installation before it is actually
installed. This is to make sure that you don't run into compatibility or
supportability issues during the course of using the product. To
understand the requirements for SRM, refer to page 13 of the Site
Recovery Manager System Requirements chapter, in the Site Recovery
Manager Installation and Configuration guide for SRM 6.1.
This guide can be accessed at the following URL:
http://pubs.vmware.com/srm-61/topic/com.vmware.ICbase/PDF/srm-
install-config-6-1.pdf
The following flowchart depicts the processes involved in installing
vCenter SRM:
Performing the SRM installation
Let's assume that the SRM database and the 64-bit DSN have already

been created. We will delve directly into the installation procedure using
the SRM installer.
Before you begin, you will need to download the SRM installation
bundle from VMware's website. It can be downloaded by navigating to
www.vmware.com and then to Downloads | vCenter Site Recovery
Manager. You will need to log in to your my.vmware.com account
before you cloud download the executable.
The following procedure will guide you through the SRM installation
wizard:
1. Double-click the downloaded executable to load the installer.
2. On the welcome screen of the installation wizard, click on Next to
continue.
3. On the VMware Patents screen, click on Next to continue.
4. Accept the license agreement and click on Next to continue.
5. On the Installation Prerequisites screen, click on Next to
continue.
6. Choose a destination folder for the installer to put the files. The
default location is c:\Program Files\VMware\VMware vCenter Site
Recovery Manager\. You can change this by clicking on the Change
button. For now, I have chosen to leave the default in place. Click
on Next to continue.
7. On the vSphere Platform Services Controller screen, supply the
FQDN or the IP address of the PSC and its Single Sign-On (SSO)
credentials:

The details supplied here correspond to the PSC of the vCenter site
that you intended to protect. Click on Next to continue.
8. You will be prompted to accept the PSC certificate. Click on Accept
and then on OK to close the Certificate Information window.
9. On the VMware vCenter Server screen, choose the vCenter to
register the SRM instance with and click on Next to continue:

You might get a list of more than one vCenter if there is more than
one vCenter using the same PSC, or if the PSCs are part of the same
SSO domain—Linked Mode for example.
10. In the Site Recovery Manager Extension screen, supply a Local
Site Name, Administrator E-mail, and local host IP address.
Listener Port by default is set to 9086. The local site name could
be any name that can identify the vCenter sites in the SRM GUI.
The local host IP address is the IP of the machine on which SRM is
being installed. It is possible that the machine on which SRM is
being installed has more than one network interfaces configured
with different IP addresses. The local host option will let you choose
the interface you want SRM to be available on:

11. On the Site Recovery Manager Plug-in ID screen, choose the
Default Site Recovery Manager Plug-in Identifier option. The
Custom Site Recovery Manager Plug-in Identifier option is used
when you need to share a single site as a recovery site for more than
one protected site. You will learn more about this in the Setting up a
Shared Recovery Site topic of this chapter:

12. In the Certificate Type screen, you can either let the installer
generate a certificate or you could supply a certificate file generated
by a certificate authority.
The options available are:
Automatically generate a certificate
Use a PKCS#12 certificate file
Make your choice and click on Next to continue.
The first option will let the installer generate a new certificate. Use
the second option if you already have a certificate file from your
certificate authority. VMware recommends using CA signed
certificates for all of its products.
13. On the next screen, supply the details (Organization and
Organization Unit) for the certificate generation and click on Next
to continue. You will be prompted for this information only if you
have chosen to automatically generate a certificate.
14. On the Database Server Selection screen, you have a choice
between an embedded database server and an external database:

The embedded database is a vPostgreSQL database and an external
can be SQL or Oracle.
15. If you choose the embedded database server, then on the next
screen you must specify a Data Source Name, Database User
Name, and Database Password for the embedded database:
If you choose to use an external database, for instance SQL, then
you will need a 64-bit DSN pre-created and the valid credentials for
the database connection. It is not a recommended practice to expose
the database server's sa credentials. Hence consider using a service
account.
16. The Site Recovery Manager Service Account by default will use
the local system account. However, the best practice is to use a
separate service account for this.
17. On the Ready to install the Program screen, click on Install to
begin the installation. The account should be a member of the local
Administrators group.
18. Once the installation is complete, click on Finish to exit the
installer.

Pairing SRM sites
Once SRM is installed on both sites, then the next step is to pair these
sites together. The pairing process establishes a connection between the
vCenter Servers at the protected and recovery sites, which in turn makes
the SRM instances at both sites become aware of its counterpart at the
other site (protected/recovery). Without the sites being paired, we
cannot proceed with further configuration of the DR setup.
Here is how the sites can be paired:
1. Connect to either of the protected/recovery sites through vCenter
Server using vSphere Web Client.
2. Navigate to the inventory Home and click on Site Recovery:
3. At the Site Recovery home page, select Sites from the left pane and
navigate to its Objects tab.
4. The Objects tab will list the current SRM site. Click on the pair a
site icon  to bring up the Pair Site Recovery Manager Servers
wizard:

5. On the Pair Site Recovery Manager Servers wizard's Select Site
page, supply the FQDN or IP address of the PSC that corresponds to
the secondary site and click on Next:
6. On the Select vCenter Server screen, select the intended vCenter
and supply its SSO credentials. Click on Next to continue:

7. You will now see a certificate security alert for both the sites. Click
on Yes in both dialog boxes to continue.
8. Once done, you will see both the sites listed:
9. Now, select the site that you just added and click on the  icon to
bring up the Login Site window, prompting the credentials for the
vCenter managing the second site:

10. On the Login Site window, supply the vCenter credentials and click
on Login. This completes the site pairing process.
Note
The paring is done only from one of the sites. This is because the
pairing process establishes reciprocity by configuring the connection
in the reverse direction as well. But when you open the site
recovery solution at the remote vCenter Server, you may be
prompted to enter the administrator credentials of the other site.

Installing the Storage Replication
Adapters
Once you have SRM instances installed and paired, the next step is to
install the SRAs. SRAs are coded and provided by the storage vendors.
VMware certifies the SRAs and posts them as the compatible ones for
the SRM.
Downloading the SRAs
The certified versions of the SRA can be downloaded directly from
VMware's website. Keep in mind that most vendors publish the updated
versions of the SRA at their website before it is certified by VMware.
Since SRA is a vendor-supported component, you could choose to install
the latest version available from the vendor, if that is known to fix a
problem that you are dealing with.
Here is how you can download the SRA:
1. Go to VMware's website www.vmware.com.
2. Under the Product Downloads category, navigate to Downloads |
vCenter Site Recovery Manager.
3. Once you are on the download page for vCenter SRM, click on the
Go to Downloads hyperlink listed against Storage Replication
Adapters.
4. At the Download Storage Replication Adapters for VMware
vCenter Site Recovery Manager page, you will see a list of all the
certified SRAs. Click on the Download Now button corresponding
to the required SRA.
Installing the SRA
The SRA component, once downloaded, has to be installed on both the
sites. In most cases, the SRA installation is pretty simple and
straightforward, but this can be different from vendor to vendor. You

need to refer to the vendor documentation for the installation procedure.

Adding array managers and
enabling array pairs
Once you have installed the SRA at both sites, you will now need to add
an array manager at both sites. An array manager is required to discover
the replicated LUNs and perform other storage operations initiated by
SRM.
Here is how you can add an array manager:
1. Connect to either of the protected/recovery sites through vCenter
Server using vSphere Web Client, navigate to Home | Site
Recovery, click on Array Based Replication, and select its
Objects tab:
2. Under the Objects tab, click on the  icon to bring up the Add
Array Manager wizard:

3. The Add Array Manager wizard presents two options:
Add a pair of array managers: This is used when you want to
go through the process of adding both the protected and
recovery site array managers and enabling the array pair. Use
this method during this initial configuration.
Add a single array manager: This is used when you want to
add the array managers as separate steps. This can be handy
when you want to remove and re-add the array manager
corresponding to a particular site.
4. Select the Add a pair of array managers option, and click on Next
to continue.
5. Select the site pair to configure the array managers, and click on
Next to continue:

6. The Select SRA type screen will list the discovered SRA installed
on the SRM servers at both the sites. You will not be able to proceed
further if it cannot find the SRA at the paired site:

This will be followed by two configure array manager screens, one
each for the protected and recovery sites.
7. On the first Configure array manager screen, enter a Display
Name and the login information required by the protected site's SRA
to connect to its storage array. Click on Next to continue:
8. On the second Configure paired array manager screen, enter a
Display Name and the login information required by the recovery
site's SRA to connect to its storage array. Click on Next to continue:
9. On the Enable array pairs screen, you will be presented with a list
of discovered array pairs. Select the array pair corresponding to the
protected and recovery sites and click on Next to continue:

10. On the Ready to complete screen, review the summary of the
selected settings and click on Finish to create the array manager
pair:
The information prompted on the Configure array manager screen
(at step 8 and step 9) differs from array to array and from vendor to
vendor. It is purely dependent on the SRA being used.
Note
I have used an HP StoreVirtual (left-hand) SRA and have entered
the Virtual IP (VIP) of the cluster the Node Storage Module
(NSM) is part of. If none of the NSMs in the cluster are involved in
the replication for SRM, then I could supply the IP addresses of the
involved NSMs separated by a comma.

If the array managers are successfully added, then they will be listed
with a Status OK under the Object tab:
Now, you can select either of the array managers and navigate to
Manage | Array Pair to view a list of replicated devices and its
direction of replication, which will be Outgoing Replication for the
Protected Site Array Manager and Incoming Replication for the
Recovery Site Array Manager:
Also, to discover and list new replication-enabled LUN devices that
are presented to hosts, click on the  icon to run a Discover
Devices operation for the selected array pair.
The Array Pairs tab shows the replication relationship between two
arrays. Before you enable the array pair, you need SRA installed
and the array manager added at both the sites. For the array
manager to detect an array pair, there should be a replication

schedule already created between the arrays. Refer to the vendor
documentation to understand what a replication schedule would
mean for the vendor's array and the procedure to create it. When an
array pair is enabled, it tries to discover the LUN devices for which
a replication schedule is enabled at the array. However, not all
devices with a replication schedule are displayed as a device for the
array pair. Only the devices that are presented to a host at the
protected site are displayed.
If the replicated LUN devices are not presented to the hosts at the
replication source (protected site), then it will complain about this:

Configuring placeholder
datastores
For every virtual machine that becomes part of a protection group, SRM
creates a shadow virtual machine. A placeholder datastore is used to
store files for the shadow virtual machines. The datastore used for this
purpose should be accessible to all the hosts in the data center/cluster
serving the role of a recovery host. We will learn more about protection
groups and shadow virtual machines in the next chapter. For now,
understand that configuring placeholder datastores is an essential step in
configuring an SRM environment.
Assuming that each of these paired sites are geographically separated,
each site will have its own placeholder datastore. The following figure
shows the relationship between the site and placeholder datastore:

Here is how you can configure placeholder datastores:
1. Navigate to Home | Site Recovery:
2. Click on Sites in the left pane to view the Sites page:

3. Select a site, navigate to Manage | Placeholder Datastores, and
click on the 
 icon to bring up the Configure Placeholder
Datastore window:
4. On the Configure Placeholder Datastore window, select a
datastore to be designated as a placeholder datastore and click on
OK:

5. If successfully designated, it should be listed under the Placeholder
Datastores tab:
6. You should repeat the procedure at the secondary (recovery) site if
you plan to failback.

Creating resource, folder, and
network mappings
Creating resource, folder, and network mappings facilitates further
orchestration of the recovery plan that will be executed for either a
planned migration or a failover. Without these mappings, you wouldn't
be able to configure protection on the virtual machines and the
protection status will indicate that these mappings are missing. We will
learn more about protection groups in the next chapter.
Apart from being a requirement for creating protection groups, there are
other use cases as well. Here are a few common ones:
Use cases
Mapping to
use
If the designated recovery site runs other workloads, then you might want to create a
separate folder for the VMs from the protected site
Folder
mappings
If there is a separate cluster/resource pool at the recovery site to host the VMs
recovered from the protected site
Resource
mappings
If there are vSwitch/DSwitch port groups at the recovery site for the recovered VMs
Network
mappings
Resource mappings
We need to provide a correlation between the compute resource
containers on both the sites. The compute resource containers are
cluster, resource pool, and ESXi host. This is achieved with the help of
resource mappings.
Resource mappings respects the presence of these containers. This
means that, if there is a cluster or a resource pool at the site, then the
ESXi hosts are not made available as a selectable compute container.

Here is how you configure resource mapping:
1. Navigate to Home | Site Recovery and click on Sites to list the
paired sites.
2. Select the protected site, navigate to its Manage | Resource
Mappings tab, and click on the  icon to bring up the Create
Resource Mapping wizard:
3. The Create Resource Mapping screen displays the vCenter
inventory of the Protected Site on the left pane and the recovery site
on the right pane:
Expand the Protected Site's vCenter inventory tree to select the
resource container (cluster/resource pool/ESXi host) that you
want to map.
Expand the recovery site's vCenter inventory tree to select the
destination resource container. Once you have made the
selections, click on Add Mappings.

The mapping can be one-to-one or many-to-one. Click on Next to
continue.
4. The Prepare reverse mappings screen will let you configure
reverse-directional mappings from the secondary/recovery site to
the primary/protected site. This is required if you plan to configure
failback. However, reverse mapping is only made available for one-
to-one mappings. Choosing Select all applicable will only select the
one-to-one mappings. With the selections made, click on Finish to
create the resource mapping:

5. Once configured, the mappings are listed under the Resource
Mappings tab:
Folder mappings
Folders are inventory containers that can only be created using vCenter
Server. They are used to group inventory objects of the same
type/purpose for easier management.
There are different types of folders. This is determined by the inventory
hierarchy level they are created at. The folder names are as follows:
Data center folder
Hosts and clusters folder
Virtual machine and template folder

Networks folder
Storage folder
The vSphere Web Client provides UI menu options to create a folder of
the following types, without needing to navigate to an appropriate
inventory hierarchy level to create them:
Hosts and clusters folder
Networks folder
Storage folder
Virtual machine and templates folder
In the case of SRM folder mappings, we will be dealing only with virtual
machine folders and their parent data center. You will not be able to
configure mapping for any of the other folder types.
Here is how you configure Folder Mappings:
1. Navigate to Site Recovery Manager Home and click on Sites to
list the paired sites.
2. Select the protected site, navigate to its Manage | Folder
Mappings tab, and click on the  icon to bring up the Create
Folder Mapping wizard:
3. The Select creation mode screen presents you with two folder
mapping methods—automatic and manual:
The Automatically prepare mappings for networks with
matching names option is used to auto create one-to-one
mapping between identically named Folders at the Protected
and Recovery sites. This is generally the preferred option when
you have a lot of folders to map and if they were identically

named.
The Prepare mappings manually option is used to create both
many-to-one and one-to-one mappings. This option should be
used when you do not have identically named virtual machine
folders at the secondary site.
Choose the intended option and click on Next to continue:
4. With both the options, once you have made the necessary selections
on the Prepare mappings screen, click on the Add mappings
button to confirm the selection. Click on Next to continue:

5. The Prepare reverse mappings screen will let you configure
mapping reverse-directional folder mappings from the
Secondary/Recovery site to the Primary/Protected site. This is
required if you plan to configure failback. However, reverse
mapping is only made available for one-to-one mappings. Choosing
Select all applicable will only select the one-to-one mappings. With
the selections made, click on Finish to create the folder mapping:
6. Once done, the mappings created will be listed under the Folder
Mappings tab:
Network mappings

Network configuration at the protected and recovery sites need not be
identical. Network mappings provide a method to form a correlation
between the port groups (standard or distributed) of the protected and
recovery sites.
Let's say we have a port group with the name VM Network at the
protected site and it is mapped to a port group with the name Recovery
Network at the recovery site. In this case, a virtual machine that is
connected to VM Network, when failed over, will be reconfigured to use
the Recovery Network.
Here is how you configure Network Mappings:
1. Navigate to Site Recovery Manager Home and click on Sites to
list the paired sites.
2. Select the Protected Site, navigate to its Manage | Network
Mappings tab, and click on the  icon to bring up the Create
Network Mapping wizard:
3. As with the folder mapping options, the Select creation mode
screen presents you with two network mapping methods as well—
automatic and manual mapping. Choose the intended option and
click on Next to continue:
The Automatically prepare mappings for networks with
matching names option is used to auto create one-to-one
mapping between identically named virtual machine port groups
at the protected and recovery sites. This is generally the
preferred option when you have a lot of port groups to map and
if there were identically named.

The Prepare mappings manually option is used to create both
many-to-one and one-to-one mappings. This option should be
used when you do not have identically named virtual machine
port groups at the secondary site.
4. With both these options, once you have made the necessary
selections on the Prepare mappings screen, click on the Add
mappings button to confirm the selection. Click on Next to
continue:

5. On the Select test networks screen, you can set a test network for
all the recovery site port groups that were selected in the previous
mapping screen. By default, the test network is an isolated network
(a VM port group with no uplinks). These are used only while
testing a recovery LAN. We will learn about recovery plans and
their testing in a later chapter. You don't necessarily have to make
any changes on this screen. Click on Next to continue:
6. The Prepare reverse mappings screen will let you configure
mapping reverse-directional port group mappings from the
Secondary/Recovery site to the Primary/Protected site. This is
required if you plan to configure failback. However, reverse
mapping is only made available for one-to-one mappings. Choosing
Select all applicable will only select the one-to-one mappings. With
the selections made, click on Finish to create the network mapping:

7. Once done, all the mappings created will be listed under the
Network Mappings tab:

Virtual machine swap file location
With SRM implementations, there is a common argument about the
placement of the virtual machine swap files. Some would suggest
maintaining a separate datastore for the virtual machine swap files,
whereas some are against it. Before we try to understand the rationale
behind these design choices, it is important to know what a virtual
machine swap file is.
Every virtual machine will have a swap file (.vswp). This swap file is
created every time a virtual machine is powered on. The size of the
swap file is equal to the size of the memory assigned to the virtual
machine, unless there is a reservation. If there is a memory reservation,
then the size of the swap file will be equal to the size of the unreserved
memory. Although rare, some environments use limits on memory as
well.
So, the ideal formula to calculate the size of the swap file is as follows:
The default memory reservation is 0 MB and the default limit is equal to
the configured size of the memory. By default, the swap file is stored
along with the virtual machine in its working directory.
Design choice 1: Separate datastore for the
swap files
Rationale: The swap file is created every time a virtual machine is
powered-on. Since the VM will be powered on at the recovery site, and
the swap file will be created at that time, there is no need to replicate the
swap files.

The following table illustrates the pros and cons of this:
Pros
Cons
Swap file replication, if avoided, can reduce the
bandwidth utilization for storage replication.
Single point of failure.
Reduces the need for the storage space at the
recovery site, which otherwise would be needed
for the swap files.
The swap location should be chosen at a per host
level. This would require a lot of manual work in a
large environment.
 
Need to accommodate a separate large LUN. This
could affect the available spare capacity of the
array.
Design choice 2: Store the swap files in the
VM's working directory
Rationale: Apart from the reduced replication bandwidth usage, there is
no real advantage of maintaining a separate datastore for the swap files,
and most SRM implementations would have already made sure that
there would be more than enough bandwidth to make storage replication
feasible. Also, not all virtual machines frequently use swap the files
unless the vSphere environment is oversubscribed and the virtual
machines are frequently contending for memory resources. In most
cases, the swap files will be replicated during the initial sync.
Subsequent synchronizations will include swap files created consequent
to power-off and power-on operations. Keep in mind that a Guest OS
reboot will not trigger the recreation of the swap files.
Pros
Cons
No administrative overhead, which would
otherwise be needed to configure a swap
datastore per host
Bandwidth wastage, due to the replication of the swap
files
No single point of failure
Wasted storage capacity at the recovery site, which could
be otherwise avoided if the swap files are not duplicated
on the replica LUNs

Note
The design choices and the rationales behind them can vary depending
on the environment you are dealing with. The rationales are only
guidelines.

Summary
In this chapter, we learned what VMware vCenter Site Recovery
Manager is and how it can be installed and configured to lay the
groundwork for any SRM environment. In the next chapter, we will
learn how to enable protection of the virtual machine workload by
creating protection groups and recovery plans.

Chapter 2. Creating Protection
Groups and Recovery Plans
In the previous chapter, you learned how to install SRM, configure it,
and lay the foundation for an SRM protected environment. You learned
how to create resource, folder, and network mappings, as well as
configure placeholder datastores and array managers. In this chapter,
you will learn how to create protection groups and recovery plans.
In this chapter, we will cover the following topics:
Understanding datastore groups
Understanding protection groups
Understanding recovery plans
Once you have done the groundwork required to form an SRM
protected environment, the next step is to enable protection on the
virtual machines (VMs). Before we delve into the procedural steps
involved in protecting VMs, it is very important to understand a couple
of basic concepts, such as the datastore and protection groups.
Understanding datastore groups
A datastore group is a container that aggregates one or more replication-
enabled datastores. The datastore groups are created by SRM and
cannot be manually altered. A replication-enabled datastore is one
whose LUN has a replication schedule enabled at the array.
The following diagram shows the multi-datastore datastore and single-
datastore datastore groups:

A datastore group will contain only a single datastore if that datastore
doesn't store files of VMs from other datastores. See the single datastore
group conceptual diagram.
A datastore group can also contain more than one datastore. SRM
aggregates multiple datastores into a single group if they have VMs
whose files are distributed onto these datastores. For example, if VM-A
has two VMDKs, each placed on Datastore-A and Datastore-B, then
both these datastores become part of the same datastore group.
These datastore groups further aid in the creation of protection groups.

Understanding protection groups
Unlike vSphere Replication, SRM cannot enable protection on
individual VMs. All the VMs that are hosted on the datastores in a
datastore group are protected. The protection is enabled at the datastore
group level because with array-based replication, the LUNs backing the
datastores are replicated. The array doesn't know which VMs are hosted
on the datastore. It just replicates the LUN block by block. So, at the
SRM layer, the protection is enabled at the datastore level. In a way, a
protection group is nothing but a software construct to which datastore
groups are added, which in turn includes all the VMs stored on them in
the protection group.
When creating a protection group, you will have to choose the datastore
groups that will be included. Keep in mind that you cannot individually
select the datastores in a datastore group. If it were ever allowed, then
you will have VMs with not all of their files protected. Let's assume that
you have a virtual machine, VM-A, with two disks (vmdk-1 and vmdk-
2) placed on two different datastores. Let's also say vmdk-1 is on
datastore-X and vmdk-2 is on datastore-Y. When creating a protection
group, if you were allowed to select the individual datastores, and if you
chose only one of them, then you would leave one of the VM's disks
unprotected. Hence, SRM doesn't allow selecting individual datastores
from a datastore group as a measure to prevent such a scenario.

Here, even though we have both the datastore groups included in the
same protection group, Protection Group-A, it is possible to form
separate protection groups for each of the datastore groups.
Note
A datastore group cannot be part of two protection groups at the same
time.
Storage policy-based protection groups
Starting with SRM 6.1, you can create protection groups based on the
virtual machine storage polices that exist in a vSphere environment.
Storage polices enable the placement of virtual machine disk files on
datastores that satisfy the workload characteristics of the virtual

machine. They are created at the vCenter managing the environment
and are based on storage capabilities learned via a VASA provider, or
based on metadata tags manually created at the vCenter, or a
combination of both.
Refer to step 5 in the Creating a protection group section to understand
how to create protection groups based on VM storage policies.
Creating a protection group
A protection group is created at the SRM UI, at the protected site. The
following procedure will guide you through the steps required to create a
protection group:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery.

2. Click on Protection Groups in the left pane under the Inventories
category:
3. Click on the 
 icon to bring up the Create Protection Group
wizard:

4. In the wizard, select the required site pair. If you have formed more
than one site pair using vCenters that are in the linked mode, they
would be listed for selection. With site pairs selected, supply a name
and an optional description for the protection group and click on
Next to continue. Keep in mind that the local vCenter (the one that
you are logged into) is regarded as the protected site. The wizard
lists the site pair in the Protected Site – Recovery Site format:
5. In the Protection group type screen, you will need to choose the
Direction of protection and a Protection group type. Click on
Next to continue:

By selecting the direction of protection, you are basically identifying
the protected and recovery sites. Keep in mind that the local site
(the one that you're logged in to) is always selected as the protected
site. In case you are using the SRM UI from the recovery site, it is
important to make sure that you select the correct direction of
protection.
There are three types of protection group types:
Datastore groups: These can only be used with array-based
replication. Selecting this option will list all the array pairs from
which replication scheduled LUNs are presented to the ESXi
hosts. If the wizard shows more than one array pair, make sure
you select the correct one before proceeding.

Individual VMs: These are used with vSphere Replication. You
will learn about vSphere Replication later in this book.
Storage policies: These are used with array-based replication.
They are used to protect virtual machines hosted on datastores
tagged with a specific storage policy. vCenter lets you create
storage policies to categorize datastores based on the
capabilities of the LUNs backing them. The capabilities are
learned either via a VMware Storage API's for Storage
Awareness (VASA) provider or can be manually created using
vCenter tags. If you select Storage policies as your protection
type, then on the next screen you will be presented with a list of
storage policies created at the protected site's vCenter, as shown
here:

This is followed by the Ready to complete wizard screen, wherein
you can review the options selected and click on Finish to create a
storage policies-based protection group.
6. If you choose Datastore groups as the protection group type, then
on the next screen, you will be presented with a list of datastore
groups. As you learned before, a datastore group is a container that
aggregates one of the more replication-enabled datastores:
Although I have selected a single datastore group, we can select

multiple datastore groups to become part of the protection group.
Click on Next to continue.
7. On the Ready to complete screen, review the settings and click on
Finish to create the protection group:
8. If successful, you will see the protection group created with the
Protection Status OK and Recovery Status Ready:
What happens when you create a protection
group?
When you create a protection group, it enables protection on all the
VMs in the chosen datastore group and creates shadow VMs at the
recovery site. In detail, this means that at the protected site vCenter
Server, you should see a Create VM Protection Group task completed

and subsequently a Protect VM task completed successfully for each of
the VMs in the protection group:
At the recovery site vCenter Server, you will see a Create VM
Protection Group, Protect VM (for each VM), a Create virtual
machine (one for each VM), a Recompute Device Groups, and a
Recompute Datastore Groups task completed successfully:
The shadow VMs appear in the vCenter Server's inventory at the
recovery site:

Since the shadow VMs are solely placeholders, you cannot perform any
power operations on them. Other operations are possible, but are not
recommended. Hence, a warning will be displayed, requesting
confirmation:
The placeholder datastores will only have the configuration file (.vmx)
and a snapshot metadata file (.vmsd) for each VM:
These files will be automatically deleted when you delete the protection

group.

Understanding recovery plans
Recovery plans are created at the recovery site. They are accessible and
can be run from the recovery site when there is a disaster at the
protected site. A recovery plan is executed to failover the virtual
machine workload that was running at the protected site, to the recovery
site. It can also be used to perform planned migrations. A recovery plan
is a series of configuration steps that has to be performed to failover the
protected VMs to the recovery site.
Note
A recovery plan should be associated with at least one protection group.
Creating a recovery plan
Once you have created protection groups, the next step would be to
create a recovery plan for these protection groups. A recovery plan can
be created either from the protected or the recovery sites. However, it is
important to make sure that you select the direct recovery site while
creating it. Since the sites are paired, a copy of the recovery plan will be
created at the recovery site as well.
The following procedure will walk you through the steps required to
create a recovery plan:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery.
2. Click on Recovery Plans in the left pane under the Inventories
category:

3. Click on the  icon to bring up the Create Recovery Plan wizard:
4. On the Create Recovery Plan wizard screen, select the intended
site pair, then supply a name and an optional description and click
on Next to continue:

5. On the next screen, select Recovery Site and click on Next to
continue. If the recovery plan wizard is initiated at a site, then the
wizard will select the other site in the site pair as the recovery site.
For example, if you were to initiate the recovery plan wizard at
SITE-A, then the wizard will autoselect the other site, SITE-B, as
the recovery site, and vice versa.
6. In the Protection groups screen, you will need to choose a
protection group to associate with the recovery plan. The screen can
list two types of protection groups: VM protections Groups and
Storage Policy Protection groups:

If you select VM protection groups, then protection groups
based on array-based replication (ABR) will be listed:
If you select Storage policy protection groups, then protection
groups based on storage policies (SP) will be listed:
With the protection group selected, click on Next to continue.
7. In the next wizard screen, select Test networks. The test networks
are set to Auto* by default. The auto networks are isolated bubble
networks and don't connect to any physical network. They are used
when testing a recovery plan. We will discuss testing a recovery
plan and the use of bubble networks further in the next chapter. So,
unless you have manually created an isolated test network port
group at the recovery site, you can leave it at the auto setting. Click
on Next to continue:

8. In the Ready to complete screen, review the settings and click on
Finish to create the recovery plan:
9. Once done, you will see the plan listed with the status Ready:

Summary
In this chapter, you learned what datastore groups, protection groups,
and recovery plans are. You learned how to create protection groups
based on datastore groups and storage policies. You learned how to
create a recovery plan using either VM protection groups or storage
policy protection groups.
In the next chapter, you will learn how to test the recovery plans and
execute a failover and a failback.

Chapter 3. Testing and
Performing a Failover and
Failback
In the previous chapter, you learned how to create protection groups and
recovery plans. Recovery plans are nothing but precreated workflows
for the recovery of failed sites. In this chapter, you will learn how to test
the recovery plans that are already created, and how to use them to
perform a failover, planned migration, reprotect, and failback.
Here is a list of topics that will be covered in this chapter:
Testing a recovery plan
Performing a planned migration
Performing a disaster recovery (failover)
Performing a forced recovery
Reprotecting an SRM site
Performing a failback to an SRM protected site
IPv4 customization rules
Configuring VM recovery properties
Testing a recovery plan
A recovery plan should be tested for its readiness to make sure that it
would work as expected in the event of a real disaster. Most
organizations periodically review and update their recovery runbook to
make sure that they have an optimized and working plan for a recovery.
The same process can be applied here to periodically test the recovery
plans created.
With Site Recovery Manager, the testing of a recovery plan can be
automated. It is important to understand the workflow involved in
testing a Recovery Plan before we delve into the details of what really
happens in the background.

Test workflow
The testing of a Recovery Plan is done in a manner that doesn't affect
the current operations, which include replication schedules, the actual
replicas, or the protected VMs. In this section of the chapter, we will
learn how this is achieved.
The following figure shows an overview of the steps involved during the
testing of a recovery plan:

Running the test
The test is initiated via SRM's vSphere Web Client interface. The
following steps will guide you through the procedure for testing a
recovery plan:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up Site Recovery Home.
2. At Site Recovery Home, use the left pane to navigate to Recovery
Plans under Inventories:
3. The Recovery Plans page will list all the available recovery plans.
Click on the one that you intend to test:

4. You will now be presented with the selected recovery plan's
Monitor | Recovery Steps page. Click on the  icon to bring up the
test wizard:
Note
The plan should have a Ready status before you can proceed
further.
5. The first screen of the wizard will indicate which of the sites have
been designated as the protected and recovery sites, the site
connection status, and the number of VMs protected:

By default, the storage option Replicate recent changes to the
recovery site is selected. I would recommend you don't deselect
this option because we replicate the recent changes during a planned
migration. So, it is an important ability of the array to respond to a
nonscheduled replication request that is tested. However, we might
not need to do this if the replication is synchronous. Click on Next
to continue.
6. The Ready to complete screen will summarize the settings; review
them and click on Finish to initiate the test.
7. You should now see a test recovery plan task in the Recent Tasks
pane. Also, navigate to the Recovery Steps tab to watch the
progress of the test:

8. Once the test completes successfully, the Plan status changes from
Test in progress to Test Complete:
Testing a recovery plan – background
When you initiate a test, SRM instructs the Storage Replication Adapter
to execute a replication cycle to replicate the latest changes to the
replica LUN at the recovery site. This, however, will only happen if you
have chosen to leave the default option to replicate recent changes
checked. You wouldn't need to replicate the recent change when the
replication is synchronous since the replica would already have the
latest change. Refer to your replication vendor documentation for more
information.

Once the replication is complete, it then needs to find a way to present
the replica LUN's data to the recovery-ESXi hosts so that the VMs can
be powered on. This is achieved differently by different storage arrays.
The most common methodology is to create a writeable snapshot of the
replica LUN and then present the snapshot to the recovery-ESXi hosts.
The hosts will subsequently scan their HBAs to detect the VMFS
volumes on the LUN.
Before the snapshot is presented to the ESXi hosts, SRM needs to make
sure that there is enough room (compute capacity) at the recovery site to
power on the recovered VMs. To make room for the VMs, SRM could
power off the noncritical VMs (if included in the recovery plan) and also
power up the ESXi hosts that were put into standby mode (if any) by
Distributed Power Management (DPM).
Note
The noncritical VMs that SRM chooses to suspend are those that were
marked as noncritical for the recovery plan using the Add NonCritical
VM option.
To power on the recovered VMs, they have to be registered to the
recovery site's vCenter Server. This is achieved by replacing the shadow
VM entries with the entries corresponding to the recovered VMs. Keep
in mind that the shadow VMs are mere inventory objects and do not
have any VMDKs mapped to them.
The VMs are then configured to connect to the test network. The test
network can either be a port group that you precreated for the test, or an
auto bubble network created on a new vSphere Standard Switch with no
physical uplinks.
The following screenshot shows a vSphere Standard Switch and a port
group that was automatically created during a test for the auto (bubble)
network:

Once the VMs have been configured to connect to the test network,
they are powered on. Keep in mind that the testing of a recovery plan
does not affect the power state of the protected VMs at the protected
site.
Performing the cleanup after a test
We know from the previous section that during the course of the testing
of a recovery plan, SRM executes the creation of certain elements to
enact a disaster recovery in a manner that wouldn't affect the running
environment. Hence, the changes done and the objects created are
temporary and have to be cleaned up after a successful test. Fortunately,
this is not a manual process either. SRM provides an automated method
for preforming a cleanup. Keep in mind that a cleanup can only be
performed on a recovery plan that has been tested successfully.
The following will happen during a cleanup:
Putting the ESXi hosts back into DPM standby mode
Powering off the recovery VMs

Powering on the suspended noncritical VMs
Replacing the inventory entries of the recovery VMs with their
corresponding shadow VM entries
Unmounting the VMFS volume
Detaching the LUN device
Rescanning the storage initiators and refreshing the storage system
Deleting the writable snapshot that was created
Removing the port group and the vSwitch that were created for the
bubble network
The following procedure will guide you through the steps required for
the cleanup:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up Site Recovery Home.
2. At Site Recovery Home, use the left pane to navigate to Recovery
Plans under Inventories.
3. Select the recovery plan that was tested successfully, navigate to its
Monitor | Recovery Steps tab, and click on the  icon to bring up
the cleanup wizard:
4. In the Cleanup wizard, the details regarding the current protected
and recovery sites, their connection status, and the number of

protected VMs are displayed. Note that the Force Cleanup option
is greyed out. It will only be available if the cleanup operation had
failed during the previous attempt. Click on Next to continue:
5. The Ready to complete screen will summarize the cleanup options
selected. Click on Finish to initiate the cleanup.
6. The Recovery Steps page shows the cleanup steps are in progress:
7. On successful completion of the cleanup, the Plan status will

change to Ready:

Performing a planned migration
VMware SRM can be used to migrate your workload from one site to
another. A planned migration is done when the protected site is available
and running the virtual machine workload.
There are many use cases, of which the following two are prominent:
When migrating your infrastructure to new hardware
When migrating your virtual machine storage from one array to
another
Note
A planned migration will replicate the most recent changes with the help
of storage replication. This is not optional.
The following procedure will guide you through the steps required in
performing a planned migration:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up Site Recovery Home.
2. At Site Recovery Home, use the left pane to navigate to Recovery
Plans under Inventories.
3. Select the recovery plan, navigate to its Monitor | Recovery Steps
tab, and click on the  icon to bring up the Recovery wizard:

4. The first screen will seek a Recovery Confirmation. The Recovery
Type will be preselected as Planned Migration. You should
acknowledge the recovery confirmation to proceed further. Click on
Next to continue:

5. The Ready to complete screen will summarize the wizard options
that were selected. Click on Finish to initiate the migration.
6. The Recovery Steps tab will show the progress of the planned
migration:

7. Once completed successfully, the Plan status will change to
Recovery Complete:
Note
The planned migration will not proceed further if any of the recovery
steps fail.
However, when you reattempt the planned migration, it would resume
the operation from the step at which it failed. This enables you to fix the
problem and resume from where it failed, saving a considerable amount
of time.

The following flowchart shows the logical sequence of events that would
occur during the course of a planned migration:

Performing a disaster recovery
(failover)
A failover is performed when the protected site becomes fully or
partially unavailable. We use a recovery plan that is already created and
tested, to perform the failover. Keep in mind that SRM does not auto-
determine the occurrence of a disaster at the protected site, hence a
recovery is always manually initiated.
Here is how you perform a failover:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up Site Recovery Home.
2. At Site Recovery Home, use the left pane to navigate to Recovery
Plans under Inventories.
3. Select the recovery plan that was created for disaster recovery,
navigate to its Monitor | Recovery Steps tab, and click on the 
icon to bring up the Recovery wizard. In the Recovery wizard,
agree to the Recovery Confirmation, set the Recovery Type as
Disaster Recovery, and click on Next to continue:

4. The Ready to complete screen will summarize the options selected.
Review and click on Finish to initiate the recovery operation.
5. The Recovery Steps tab of the Recovery Plan will show the
progress of each of the steps involved:

6. Once the failover is complete, the status of the recovery plan should
read Recovery Complete.
The recovery steps involved in a disaster recovery (failover) are the
same as in those of a planned migration, except for the fact that SRM
ignores any unsuccessful attempts to presynchronize the storage or the
shutting down of the protected VMs.

Performing a forced recovery
Forced recovery is used when the protected site is no longer operational
enough to allow SRM to perform its tasks at the protected site before the
failover. It is enabled at the recovery site, thereby letting the recovery
site to failover machines from the protected site by skipping the
protected site operations.
For instance, if there is an unexpected power outage at the protected
site, not only the ESXi hosts but also the storage array become
unavailable. In this scenario, SRM cannot perform any of its tasks at the
protected site, such as shutting down the protected VMs or replicating
the most recent storage changes (if the replication is asynchronous).
Enabling forced recovery for a site
Forced recovery is not enabled by default, but it can be enabled at the
site's Advanced Settings. It is enabled at the recovery site and not the
protected site.
Here is how it is done:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up Site Recovery Home.
2. Click on Sites on the left pane to navigate to the Sites page.
3. On the Sites page, select the recovery site from the left pane and
navigate to Manage | Advanced Settings | Recovery. With
Recovery selected, click on Edit to bring up the Edit Advanced
Settings window:

4. In the Edit Advanced Settings window, select the Enabled listed
against the recovery.forceRecovery setting, and click on OK to
enable forced recovery:
5. If enabled, then the recovery.forceRecovery setting will have a
value of true configured:

Running a forced recovery
Running a forced recovery will skip all the steps that otherwise should
have been performed against the protected site. You should be using
forced recovery only during circumstances where the protected site is
completely down, leaving no connectivity to either the ESXi hosts or the
storage array.
Here is how a forced recovery is executed:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up the Site Recovery Home.
2. At the Site Recovery Home, use the left pane to navigate to
Recovery Plans under Inventories.
3. Select the recovery plan that was created for disaster recovery,
navigate to its Monitor | Recovery Steps tab, and click on the 
icon to bring up the Recovery wizard.
4. In the Recovery wizard, agree to the Recovery Confirmation, set
the Recovery Type as Disaster Recovery, and select the checkbox
against Forced Recovery – recovery site operations only. Click
on Next to continue:

5. On the Ready to complete screen, review the settings and click on
Finish to initiate a forced recovery.
Note
If a forced recovery is executed while the protected site is still
online and available, then it would leave the VMs running at both
the protected and recovery sites, causing a split-brain condition for
SRM. Furthermore, if the array-based replication was asynchronous,
then the chance is that the VMs that were started at the recovery
site are running from old data compared to the ones that protected
the site. So, it is very important that you are cautious when you plan
to execute a forced recovery.

Reprotecting an SRM site
After you failover the workload from a protected site to the recovery
site, the recovery site has no protection enabled for the new workload
that it has begun hosting. SRM provides a method to enable protection
of the recovery site. This method is called reprotect.
A reprotect operation will reverse the direction of the replication, hence
the recovery site is designated as the new protected site. The reprotect
operation can only be done on a recovery plan with the Recovery
complete status. Also, keep in mind that a reprotect operation can only
be executed when you have repaired the failed site and made it available
to become a recovery site.
For instance, let's assume that site-A and site-B are the protected and
recovery sites, respectively. If workload at site-A were failed over to
site-B, then to reprotect site-B, site-A should be made accessible. This
would mean fixing the problems that caused the failure at site-A.
Here is how you perform the reprotect operation:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery to bring up the Site Recovery Home.
2. At the Site Recovery Home, use the left pane to navigate to
Recovery Plans under Inventories.
3. Select the recovery plan with Plan status Recovery complete,
navigate to its Monitor | Recovery Steps tab, and click on the 
icon to bring up the Reprotect wizard:

4. In the reprotect wizard screen, agree to the Reprotect
Confirmation and click on Next to continue:
5. In the Ready to complete screen, click on Finish to begin the
reprotect operation.
6. The Recovery Steps tab will show the progress of every step

involved in the reprotect operation:
7. The status of the recovery plan after a successful reprotect
operation should be Ready.
8. Navigate to the Summary tab of the recovery plan to verify that the
direction of protection is now reversed. In this case, site-B will now
be designated as the protected site and site-A as the recovery site:

Performing a failback to an SRM
protected site
In a scenario wherein, after a failover the original protected site is fixed
and is made available to host the virtual machine workload, you can use
SRM to automate a failback.
The failback, although automated, is a two-step process:
Step 1 will be to perform a reprotect. Read the Reprotecting an
SRM site section in this chapter, to learn how to perform a reprotect
operation.
Step 2 will be to perform a failover. Read the Performing a disaster
recovery (failover) section in this chapter to learn how to perform a
failover.

IPv4 customization rules
Post a successful planned migration or disaster recovery operation, it
becomes important to make sure that the VMs recovered are able to
connect to the IP network at the recovery site.
An administrator can always log on to each of the virtual machines and
change the IP settings, but that could become a time-consuming ordeal
when you have a lot of VMs to work with. VMware SRM allows you to
create IP customization rules that enable SRM to reconfigure the
recovered virtual machines with IP configuration required for it to be
network-alive at the recovery site.
The customization rules are created for a network mapping (a mapping
between port groups of protected and recovery sites). Since they are
created for port group mappings, they are called subnet-level IP
mapping rules.
Tip
To learn how to create network mappings, refer to the topic Creating
resource, folder, and network mappings in Chapter 1, Installing and
Configuring vCenter Site Recovery Manager (SRM) 6.1.
Since the customization involves modifying the IP configuration of the
guest operating systems, it is important to be aware which of the guest
operating systems are supported for customization. SRM 6.1 supports
the customization of all guest operating systems that vSphere 6.0 update
1 supports customizing.
Here is the URL to the latest guest OS customization support matrix:
http://partnerweb.vmware.com/programs/guestOS/guest-os-
customization-matrix.pdf
Creating an IPv4 customization rule

Let's figure out how to create an IP rule first, and then later on we will
delve deeper into how it is used by SRM. The following procedure will
help you create an IP customization rule:
1. Navigate to Site Recovery Manager Home and click on Sites to
list the paired sites.
2. Select the recovery site and navigate to its Manage | Network
Mappings tab to view all the configured network mappings. Choose
the network mapping (port group mapping) that you would like to
create a customization rule for and click on the Add IP
Customization Rule button to bring up the IP Customization rule
window:
3. In the IP Customization rule window, supply a rule name, subnet
mapping, optional gateway, and DNS and WINS settings. Click on
OK to confirm the settings:

4. Once done, the network mapping will now show an IP customization
rule with its configuration:

How does SRM use IP customization rules?
During a test/failover, SRM uses IP customization rules, if present, to
find the static IP configuration of the virtual machine vNICs that
matches the protected site subnet specified in the rule, and replace it
with a static IP from the recovery site's subnet. When doing so, it will
retain the host bits of the new IP and replace the network bits to match
the recovery site's network subnet. For instance, if the VM's static IP is
192.168.40.33, then SRM will replace this with 192.168.80.33.
Tip
IP customization does not affect virtual machine vNICs with Dynamic
Host Configuration Protocol (DHCP) enabled on them.
If the destination default gateway was not configured in the rule, then
SRM will retain the host bit in the gateway address and replace the
network bits to match the recovery site's network subnet. For instance, if

the default gateway of the VM is 192.168.40.1, then SRM will replace it
with 192.168.80.1.
Tip
DNS/WINS settings will not be modified by SRM if they are not
specified in the rule.
SRM uses IP customization rules for test, planned migration, and
disaster recovery operations. There is a one-to-one mapping between an
IP customization rule and a network mapping. Once used, the same IP
customization rule cannot be used for another network mapping.
Tip
As of version 6.1, VMware SRM does not support IPv6 customization
rules yet.
IP customization rules, once created, are by default applied to the virtual
machines during a failover (planned/test/DR) of a recovery plan.
However, the behavior can be changed at a per-VM level. This is done
via the recovery properties of a VM. We will cover more about this in
the Configuring VM recovery properties section of this chapter.

Configuring VM recovery
properties
The VM recovery properties help in further customizing the recovery
procedure at a per-VM level. Although, these properties are only
available via a recovery plan, the changes made to these properties are
retained for the VM, regardless of the recovery plan they would be
included in.
Here are the properties that can be set on a protected virtual machine:
IP customization mode
Recovery properties
Priority group
VM dependencies
Shutdown action
Startup action
Pre-power on steps
Post-power on steps
Before we learn what each of these properties are, let's figure out how to
get to the recovery properties of a protected virtual machine in a
recovery plan. Here is how you do it:
1. Navigate to the vCenter Server's inventory home, and click on Site
Recovery to bring up Site Recovery Home.
2. At Site Recovery Home, use the left pane to navigate to Recovery
Plans under Inventories.
3. Select the recovery plan, navigate to its Related Objects | Virtual
Machines tab, and click on the  icon to bring-up the VM
Recovery Properties window:

4. In the VM Recovery Properties window, you will be presented
with two tabs: Recovery Properties and IP Customization. We will
cover each of these in separate sub-sections of this topic.
IP customization
The IP Customization tab provides you with a drop-down list to choose
the IP customization mode for the selected virtual machine. The mode is
set to Auto by default, which is SRM's site-level global default for every
protected virtual machine of that site:
This behavior can be changed by disabling the protected site's advanced
setting recovery.useIpMapperAutomatically. Select the protected site
and navigate to its Manage | Advanced Settings | Recovery tab to
review the current setting and modify it:

We can change the IP customization mode from Auto to No IP
customization, Manual IP customization, and Use IP customization
rules if applicable.
Auto: It is the site-level global default mode controlled by the
advanced parameter recovery.useIpMapperAutomatically. It will
perform IP customization on the virtual machine's network
interfaces if there is an IP customization rule associated with the
network mapping the VM connects to.
No IP Customization: It is used to disable IP customization for the
selected VM.
Use IP customization rules if applicable: It is used when the site-
level global default to automatically use IP customization
(recovery.useIpMapperAutomatically) is disabled.
Manual IP customization: It is used to manually supply the static
IP configuration for both protected and recovery sites. This method
will require you to modify the settings of each vNIC of the selected
virtual machine. The main difference that stands out when
compared with using the IP customization rules is that you can
modify the IPv6 settings when doing the manual IP customization, if
necessary. As mentioned earlier in this topic, SRM currently does

not support the use of IP customization rules for IPv6 addresses.
Here, the Configure Protection... and Configure Recovery...
buttons can be used to supply the vNIC's IP configuration for
protected and recovery sites. This will be used when you failover
and failback between both the sites.
When you click on either Configure Protection... or Configure
Recovery..., a new IP setting window is shown. You can choose to
use either DHCP, IPv4, or IPv6. It also has options to supply the
DNS server details. You could also choose to fetch the current IP
configuration of the VM using the Retrieve button:

For the retrieve operation to work, you need VMware tools installed
and running in the VM. Once configured, click on OK to confirm
the settings.
Recovery properties
In a modern day datacenter, hosted workloads have different properties
and dependencies. Hence, during a failover, it is important to respect
these requirements to successfully reconfigure a working environment in
the event of a recovery. The recovery properties will allow you to set up
virtual machine start-up priorities, configure virtual machine
dependencies, set virtual machine startup/shutdown methods, and much
more. In this section, we will cover all the recovery properties available
for a protected virtual machine.

Priority group
Priority groups are used to set the start up order of the VMs. VMware
SRM uses five priority groups numbered 1 through 5.
The VMs of the lowest numbered priority group are started first.

By default, every virtual machine is in Priority Group 3. During a
failover, SRM will wait for all the VMs in a Priority Group to failover
successfully, or fail to failover, before it attempts to power on VMs from
a group with lower priority. For instance, SRM will wait for all the VMs
in Priority Group 2 to failover before it attempts the failover of the
VMs in Priority Group 3. This is because Priority Group 2 has a
higher priority than Priority Group 3.
VM dependencies
So, what happens if all the VMs running the services of a three-tier
application are in the same priority group? Can we configure a startup
order within a priority group? The answer is Yes. This is where VM
dependencies come in handy.
Let's consider a three-tier application that has a database, a server
component, and the user interface component hosted on three different
VMs. Now in this case, the server component is dependent on the
availability of the database, and the user interface component is
dependent on the server component. This means the database VM
should start first, then the VM hosting the service component, and
finally the VM hosting the user interface component. Such a startup
order can be achieved using the VM dependencies recovery property.
Here is how a VM dependency startup order is created:
1. Open the Recovery Properties of the virtual machine.
2. Select the VM Dependencies property from the left pane and click
on Configure to bring up the Configure VM Dependencies
window:

3. In the Configure VM Dependencies window, select the virtual
machines that have to be started before the current VM and click on
OK to close the VM dependencies window:
4. Click on OK in the VM Recovery Properties window to save the
settings.

Keep in mind that the VMs are started in the order of their
appearance in the list. So make sure that you plan to add the VMs in
the order in which you want them to start. You can also remove a
VM from the list by hitting the Remove button.
Note
The dependencies between VMs of different priority groups are
ignored by SRM. Also, the dependencies are not mandatory rules,
hence they wouldn't stop the recovery plan from continuing. In case
a VM dependency fails, it throws a warning and proceeds with the
execution of the recovery plan.
Shutdown action
The shutdown action VM recovery property will let you choose whether
a virtual machine at the protected site will be attempted to gracefully
shut down or be powered off, during a planned migration or disaster
recovery. It would also let you set the amount of time SRM would wait
on VMware tools to shutdown the virtual machine before it issues a
power off. The default timeout value is 5 minutes:
A disaster recovery will power off the VM after the timeout, but a
planned migration will not proceed further if the VM cannot be
gracefully shut down.
Startup action
The startup action property will let you choose whether or not to power

on a virtual machine at the recovery site during a test or a recovery
operation. By default, after a virtual machine is powered on at the
recovery site, SRM waits for 5 minutes to determine whether the virtual
machine tools have started. If it sees no response from VMware tools, it
marks a failure of that task and proceeds further with the recovery. But
the recovery operation will have an Incomplete Recovery status. You
can also add a further delay before any of the dependent VMs are
started, or before the execution of any post-power on steps. This is
commonly used to give the service running inside of the VM some
additional time to start:
Pre-power on and post-power on steps
The pre-power on and post-power on steps are VM recovery properties
that let you insert additional steps into the recovery plan.
With the pre-power on steps property, you can create the following
types of step:
A Windows batch command on the SRM server
A message prompt, which the user/administration should dismiss
before the recovery plan can begin its execution
With the post-power on steps property, you can create the following
types of step:
A command on the recovered virtual machine
A Windows batch command on the SRM server
Creating a message prompt is straightforward. Here is how it is done:

1. Select the pre-/post-power on steps property from the left plane and
click on the  icon to bring up the Add Pre/Post Power On Step
window.
2. In the Add Pre/Post Power On Step window, select the Type as
Prompt (requires a user to dismiss before the plan will
continue).
3. Supply a Name and the Message content, and click on OK to save
the settings.
Here is how to create a Windows batch command on the SRM Server:
1. Select the Pre/Post power on steps property from the left plane and
click on the  icon to bring up the Add Pre/Post Power On Step
window.
2. In the Add Pre/Post Power On Step window, select the Type as
Command on SRM Server or Command on Recovered VM.

3. Supply a name for the script and the command script in the content
section, and type the actual command. For instance, to run a batch
script in D:\demoscript.bat, include the following command:
"c:\windows\system32\cmd.exe /c d:\demoscript.bat"
Note
For cmd.exe, always mention the absolute path
c:\windows\system32\cmd.exe.
The default timeout for a batch command is 5 minutes. If the batch file
doesn't finish executing within 5 minutes, then the execution of the
recovery plan will stop with an error indicating this.

Summary
This chapter detailed the workflows involved in testing recovery plans,
running planned migrations, and performing disaster recovery failovers.
You learned how to perform a forced recovery in the event of the
protected site being nonfunctional. You then learned how to reprotect a
site after a successful failover. You also learned how to failback to the
original protected site.
Details regarding how the failed over virtual machines can be
reconfigured with the new IP configuration using the SRM IP
customization rules were also covered. Finally, we covered the recovery
properties available for protected virtual machines and their use cases.

Chapter 4. Deploying vSphere
Replication
In this chapter, you will learn the following:
New features in vSphere Replication 6.1
Understanding the vSphere Replication architecture
Downloading the vSphere Replication bundle
Deploying the vSphere Replication Appliance
Setting the VRA hostname and a VRM site name for the VRA
Configuring a SQL database for VRMS
Deploying a vSphere Replication server
Registering vSphere Replication servers
Introduction
Most organizations will have a DR plan in place, regardless of whether it
is a large enterprise or a small or medium business. VMware Site
Recovery Manager leveraging an array-based replication is a very
effective DR solution. However, an array-based replication can be a
costly solution for some businesses, especially the small and medium
businesses. VMware's proprietary replication engine called vSphere
Replication offers a very cost-effective DR solution without the need for
investments on storage replication technologies.
One of the advantages for businesses using vSphere Replication is the
fact that the replication can be managed without the need for an SRM
license. The vSphere Web Client GUI provides an interface to configure
and manage replication on virtual machines.
In this chapter, we learn what vSphere Replication actually is, its
architecture, and how it can be deployed in your vSphere environment.
vSphere Replication is a replication engine that can be leveraged to
configure replication on individual VMs. It can replicate a virtual

machine and its disks from one location to another without the need to
incorporate expensive array-based replication. What it really does is to
provide a mechanism to replicate a virtual machine using the existing
Ethernet infrastructure and recover them when there is a need.
The concept of vSphere Replication was introduced with VMware Site
Recovery Manager version 5.0. At that time, vSphere Replication was
not a standalone product. With the release of vSphere 5.1, vSphere
Replication has been released as a standalone product and it integrates
directly into the vSphere platform, registering itself as a plugin to the
vCenter server. All the replication and recovery operations are done
using the vSphere Web Client.
It is included in Essential Plus and higher versions of vSphere.
It is storage agnostic, which means that a virtual machine or its disk files
can be replicated to a datastore regardless of it being either a VMFS
volume or an NFS mount. For instance, if the virtual machine that you
want to protect by enabling replication is located on a VMFS volume,
then the replica can be either on another VMFS volume or on a NFS
mount. The reverse is also true.
Note
vSphere Replication can protect a maximum of 2000 VMs. Read
VMware KB article 2102543 for more details regarding the operational
limits of vSphere Replication.
VMware Site Recovery Manager can be configured to leverage the
vSphere Replication engine to perform recovery tests, failovers, planned
migration, failback, and so on.

New features in vSphere
Replication 6.1
The first edition of this book covered version 5.5. However, since then,
VMware has released several upgrades. We will briefly review what
each of those version upgrades introduced:
vSphere Replication 5.5 Update 1 added full support for VMware
VSAN.
vSphere Replication 5.6 introduced support for replicating virtual
machines to vCHS (now known as vCloud Air).
vSphere Replication 5.8 added enhanced reporting and improved
support for vCHS.
vSphere Replication 6.0 was the first major release since version
5.5. It introduced VR scalability and the following performance
features:
VMware now allows the optional compression of the replication
data prior to its transmission over the network reducing network
bandwidth and replication time. Data compression, however,
puts additional load on the source and destination ESXi hosts.
vSphere Replication management and Replication traffic can
now be network-separated.
Improved replication engine with capabilities to compress
replication data.
vSphere Replication Management Server (VRMS) now
supports up to 2,000 simultaneous active replications, up from
500 replications in the previous version.
Support for the the quiescing of Linux guest operating systems
enabling filesystem-level crash consistency.
Storage DRS is now fully supported. If storage DRS moves a
replica VM or its disks to another datastore at the recovery site,
vSphere Replication can now detect this change and seamlessly
update the replication schedule accordingly. Previously, storage
DRS was supported only at the protected site.
vSphere Replication 6.1 introduced several UI enhancements and

now has added support for NFSv4.1 datastores. It now also enables
an RPO as low as 5 minutes for workloads on VSAN datastores.

Understanding the vSphere
Replication architecture
vSphere Replication is VMware's hypervisor-based replication solution.
Unlike array-based replication, the data is replicated over the network,
using the VMware Network File Copy (NFC) protocol. VMware NFC
is a proprietary VMware protocol, which is used to transfer disk
(VMDK) blocks between ESXi hosts.
A vSphere Replication Appliance is a Linux virtual machine running
SUSE Linux Enterprise Server 11 SP3 for VMware. The machine runs
VRMS, a vSphere Replication Server, and an embedded database.
The vSphere Replication architecture comprises of the following
components:

One or more instances of vCenter servers managing the protected
and the recovery sites
A vSphere Replication Server deployed at the protected site
A vSphere Replication Server deployed at the recovery site
The VRM plugin for the vSphere Web Client
The vSphere Replication agent that runs on every ESXi host
For vSphere Replication to work, you will need a VRMS at the
protected site and a VR server at the target recovery site, be it local or
remote. However, there can be only one VRMS per vCenter server.
The recovery site is the site at which you plan to maintain the replicas of
the VMs from the protected site. It is the site to which you will be
sending the replication traffic. The vSphere Replication appliances
provide a replication management interface via the vSphere Web Client.
It registers itself as a plugin for the Web Client.

Note
Every ESXi host, starting with version 5.1, has the vSphere Replication
agent already built into the VMkernel, thereby removing the
dependency on Site Recovery Manager and installing additional
packages into each ESXi host.

Downloading the vSphere
Replication bundle
The vSphere Replication Server appliance is available for download as
an ISO data file or a compressed ZIP package, both of which contain
separate OVFs for the vSphere Replication Appliance and Add-On
servers.
The following steps help you to download the ISO or ZIP bundle:
1. Go to the vSphere downloads page at
www.vmware.com/go/download-vsphere.
2. Click on the Go to Downloads hyperlink corresponding to vSphere
Replication 6.1 listed under your license model.
3. Log in to your My VMware account when prompted.
4. Download either the ZIP or ISO package.

Deploying the vSphere
Replication Appliance
The vSphere Replication Appliance (VRA) should be installed at the
site where you have virtual machines that need to be protected. It may
or may not be required to be installed on both the protected and
recovery sites. You will need VRA to be deployed at the recovery site
only if you intend to pair it with the protected site.
The pairing is done by adding the recovery site as a target site to the
VRMS at the protected site. Read the Adding a remote site as a target
section in Chapter 5, Configuring and Using vSphere Replication 6.1,
for information on how to achieve this.
The total number of VMs that can be protected by vSphere Replication

is 2,000 per site. The limit is imposed at a per VR server level. Each VR
server can protect up to 200 VMs and there can only be a maximum of
10 VR server per VRMS. Since there can be only one VRMS registered
to a site's vCenter, the 2,000 VM limit cannot be exceeded.
If the VRMSs are paired, then the cumulative limit of VMs from both
the sites becomes 2,000 and not 4,000.
To deploy the VRA, you need the following components:
A compatible version of vCenter server
ESXi hosts compatible with the vCenter server
Downloaded bundle for vSphere Replication 6.1
The appliance's OVF can be deployed using the Deploy OVF Template
wizard. The wizard can be initiated from various levels (vCenter,
Datacenter, or ESXi). We will do it at the vCenter level, although this is
not a technical requirement:
1. Extract (unzip) the downloaded package, or in case you have
downloaded the ISO bundle then mount the ISO to the vCenter
server virtual machine or the machine that the vSphere client is
being accessed from.
2. Right-click on the vCenter server and click on Deploy OVF
Template:

3. On the wizard screen, set the source as Local file and click on
Browse...:
4. Navigate to the extracted bundle folder and then to the bin
subfolder:
5. Select the vSphere_Replication_OVF10.ovf OVF file and click on
Open to make the selection and return to the wizard:

6. On the wizard screen, click on Next to continue.
7. The Review details screen summarizes the appliance's details. Click
on Next to continue:
8. On the license agreement screen, accept the license and click on
Next to continue.
9. Supply a name for the VM, select an inventory destination for it,

and click on Next to continue:
10. Select a deployment configuration—either a 2 vCPU or a 4 vCPU
virtual machine:
11. Select a compute location for the VM. The compute location could
be an ESXi host or a cluster of ESXi hosts. Once a selection has
been made, click on Next to continue:

12. Select the VMDK type and a datastore for the VM and click on
Next to continue. The default disk format is Thick Provision Lazy
Zeroed. However, this can be changed to either Thin Provision or
Thick Provision Eager Zeroed. A VM Storage Policy can also be
chosen to display appropriate datastores:
13. Select a network (port group) for the VM's vNIC, choose between
IPv4 and IPv6, and an IP allocation policy (DHCP/Static). We have
selected Static, hence, we will have to manually specify the DNS
Server, the subnet mask, and the gateway of the subnet the VM will
be part of. Once done, click on Next to continue:

14. Set the password and the static IP for the appliance. Click on Next
to continue:
15. The vService bindings screen will show the binding status of the
vCenter extension registration. This is a method to allow the
appliance VM to connect to the vCenter without requiring the user
to enter the vCenter credentials. There is nothing to modify here, so

click on Next to continue.
16. On the Ready to complete screen review the settings and click on
Finish to deploy the appliance VM. You can select the Power on
after deployment checkbox to start the VM if the deployment is
successful.
How does it work
Once deployed, the appliance will be powered on and finish the initial
configuration, which includes the configuration of the embedded
database and the registration of VRMS to the vCenter server.
You can only have a single instance of VRMS registered to a vCenter
server. This means you can't deploy multiple instances of VRA at a site.
If you do so, then the appliance will detect that there is another
appliance that is already registered to the vCenter server and will
prompt for an override or a shutdown of the newly deployed appliance.
The following screenshot capture shows an appliance initialization
detecting the presence of another VRA:
Note
If you select <Continue> you should shut down the already registered
VRA.

You can, however, deploy multiple instances of the vSphere Replication
Server (Add-On) appliance which does not initialize the VRMS
component. The Add-On server appliance is deployed using a different
OVF.
As with any VMware appliance, the VRA also has a web-based
management interface that can be accessed for appliance specific
configuration tasks. This web interface is called Virtual Appliance
Management Interface (VAMI).
You can use the IP address of the appliance to connect to its
management web interface using the URL format: https://<IP address
or FQDN>:5480.
When you reach the login page for the appliance, log in using the root
user and the password you set in the OVF deployment wizard. Once you
are in, you will see a Getting Started tab, which is a sub tab under the
VR tab. There is nothing much you could do at the Getting Started tab.
The other sub tabs available under VR are Configuration, Security,
and Support. We do not need to review or change the options under
these sub tabs unless necessary.
The other main tabs available are Network, Update, and System. These
will be covered in other sections of the chapter.

Setting the VRA hostname and a
VRM site name for the VRA
Although not mandatory, you might need to set a hostname and a target
name for the VRA that you have deployed.
VRA hostname
The hostname for the appliance can be set from the appliance's VAMI.
The default hostname post deployment will be localhost.localdom.
This can be modified.
The following procedure will guide you through the steps required to
modify the hostname:
1. Connect to the VAMI of the appliance. The URL: is https://<IP
address or FQDN>:5480.
2. Log in using the root user and the password that was supplied in the
OVF deployment wizard.
3. Navigate to the Network | Address tab.
Note
Prior to supplying the hostname, it is important to create a new host
(A) record at the DNS Server. Only then you will be able to connect
to the appliance using its hostname.
4. Supply a hostname in the input box corresponding to it and click on
Save Settings:

VRM site name
Every VRM server registered to a vCenter server will have a site name.
By default, during the initial configuration of the appliance, the address
of the vCenter server to which the VRMS gets registered to, is set as the
VRM site name. The site name is only a display name; hence, it is not
mandatory that you change it. For instance, the VRM site name of a
VRMS registered to the protected site vCenter server can be just called
protected site.
The following procedure will guide you through the steps required to
modify the VRM site name:
1. Connect to the VAMI of the appliance using URL: https://<IP
address or FQDN>:5480.
2. Log in using the root user and the password that was supplied in the
OVF deployment wizard.
3. Navigate to the VR | Configuration tab.
4. Modify the VRM Site Name using the input box corresponding to it
and restart the VRM service by clicking on Save and Restart
Service:

Note
The appliance can sometimes take a while to save the setting and
restart the VRM service.

Configuring a SQL database for
VRMS
The VRA by default initializes the default embedded vPostgres
database. All of the initial configuration data and the replication
configuration data will be stored in the embedded database. Therefore, it
is important that you plan the type of database before you configure
replication for the VMs. This is because, if you were to reconfigure the
VRMS component to use an external database then you will lose the
existing replication configuration information. You will also need to
reconfigure the replication on the VMs. Backup and restoration of an
external database is easier because you will only have to back up the
database files. If you were to plan a backup of the embedded database,
then you have to back up the entire appliance.
To know which versions of SQL Server are supported, use the
solution/database interoperability filter on the VMware product
interoperability matrixes web portal.
The portal can be reached by going to the VMware compatibility guides
URL, http://www.vmware.com/in/guides.html, and clicking on the
hyperlink Product Interoperability Matrixes.
At the VMware Product Interoperability Matrixes web portal, select
Solution/Database Interoperability, select the VMware product as
VMware vSphere Replication and the version as 6.1.1. You can then
choose a database from the list and verify its compatibility:

The following procedure will guide you through the steps required to
configure a SQL database for the VRMS:
1. Log in to your database server and start Microsoft SQL Server
Management Studio.
2. In Object Explorer, right-click on Databases and click on New
Database...:

3. In the New Database window, supply a Database name and leave
the rest of the attributes at their defaults for now, and click on OK:

4. In Object Explorer, expand Security, right-click on Logins, and
click on New Login...:

5. In the New Login window, select SQL Server authentication and
supply a Login name, set the password, and deselect Enforce
password policy, which will void the other two password policies
(User must change password at the next login and Enforce
password expiration) as well.
6. Set the Default database to the newly created DB for vSphere
Replication, and click on OK.
Note
In this example, we created a DB named VR_DB, so we should
change the default database to VR_DB.

7. In the Object Explorer, expand Databases, right-click on the new
database (VR_DB) and click on Properties:

8. At the Database Properties window, select the Files page and
change the database Owner to the login you created:
9. From the same window, select the Options page, and change the
Recovery model to Simple:

10. Click on OK to close the Database Properties window.
11. Now, connect to the VAMI of the VRA using URL: https://<IP
address or FQDN>:5480.
12. Log in using the root user and the password.
13. Navigate to the VR | Configuration tab.
14. Set Configuration Mode to Manual configuration.
15. Set DB Type to SQL Server.
16. Supply the DB Host, which could be the address (FQDN/IP) of the
DB server.
17. Specify the DB Username, DB Password, and DB Name:

18. Click on Save and Restart Service. Clicking on Save and Restart
will save the new settings and restart the vSphere Replication
Management Service. It might take some time to finish, owing to the
time it needs to prepare the database. Once done, you will have to
reconfigure replications on the VM.

Deploying a vSphere Replication
Server
Unlike the vSphere Replication Appliances, you can deploy additional
vSphere Replication Servers using an Add-On appliance available in the
vSphere Replication deployment bundle that was downloaded.
Note
You can deploy up to 10 VR server appliances per vCenter server
instance.
There are several use cases for deploying additional VR servers. One of
the prime reasons is manual load distribution. Each VR server with a
default memory configuration of 716 MB can handle up to 200
replications. If there more than 200 VMs are replicated, then you could
choose to either increase the memory of the appliance or deploy
additional appliances and load balance by distributing the replication
traffic to different appliances.
The following procedure will guide you through the steps required to
deploy additional VR servers:
1. On the vSphere Web Client's Home page, click on vSphere
Replication to bring up the vSphere Web Client's interface for
vSphere Replication:

2. The vSphere Replication interface will list the vCenter the VRMS is
registered to. Click on the toolbar item Manage, which should bring
up the Manage tab for that vCenter server with the vSphere
Replication sub tab selected:
3. The Replication Servers view will show a list of registered VR
servers. Click on the  icon to bring up the Deploy OVF Template
wizard:
4. Set the source as Local file and click on Browse....
5. Navigate to the vSphere replication bundle folder (or the ISO

mounted) and then into the bin subfolder.
6. Select the vSphere_Replication_AddOn_OVF10.ovf OVF and click
on open to return to the wizard screen. Click on Next to continue.
7. The Review details screen will summarize the OVF template
details:
Note
Note that the Description says Additional vSphere Replication
Server. Click on Next to continue.
8. Supply a name and inventory location of the appliance VM and
click on Next to continue.
9. Select the compute resource for the VM and click on Next to
continue. The compute resource could be a cluster or a single ESXi
host.
10. On the Select storage screen, choose an intended disk format for
the appliance's VMDKs and choose a datastore to store the VM
files. The default option is Thick Provisioned Lazy Zeroed. Click
on Next to continue.
11. Select a network (port group) for the VM's vNIC, choose between
IPv4 and IPv6, and an IP allocation policy (DHCP/Static). You will
have to manually specify the DNS server, the subnet mask and the

gateway, if you choose the Static IP allocation method. Click on
Next to continue.
12. Set the password, supply the static IP for the appliance, and NTP
server IP addresses. Click on Next to continue.
13. On the Ready to complete screen, review the settings and click on
Finish to deploy the appliance VM. You can select the Power on
after deployment checkbox to start the VM if the deployment is
successful.
14. Once the VRS is deployed, you will have to register the vSphere
Replication Server to the VRMS. For instructions on how to do this,
refer to the Registering vSphere Replication Servers section.

Registering vSphere Replication
Servers
The deployed vSphere Replication Servers should be registered to the
VRMS for them to be used to handle replication traffic. For instructions
on how to deploy vSphere Replication Servers, read the Deploying a
vSphere Replication Server section.
The following procedure will guide you through the steps required to
register vSphere Replication Servers:
1. From the vSphere Web Client's Home page, click on vSphere
Replication to bring up the vSphere Web Client's interface for
vSphere Replication.
2. The vSphere Replication interface will list the vCenter the VRMS is
registered to. Click on the toolbar item Manage, which should bring
up the Manage tab for that vCenter Server with the vSphere
Replication sub tab selected.
3. The Replication Servers view will display a list of registered VR
servers. Click on the  icon to bring up the Register vSphere
Replication Server window:
4. In the Register vSphere Replication Server window, browse
through the vCenter inventory to locate the newly deployed VR
appliance VM.
5. Click on the virtual machine to highlight and click on OK to
confirm the selection:

6. Once the registration is successful, it should be listed in the
Replication Servers page:

Summary
In this chapter, you learned what vSphere Replication is, its architecture,
and the new features since version 5.5. You learned how to download,
deploy, and configure the VRA. We covered the configuration of an
external database hosted on a Microsoft SQL Server. Finally, you
learned how to deploy and register additional VR. In Chapter 5,
Configuring and Using vSphere Replication 6.1, you will learn how to
replicate and recover virtual machines and how to orchestrate vSphere
replication DR activities using SRM.

Chapter 5. Configuring and Using
vSphere Replication 6.1
In the previous chapter, you learned how to deploy the components
required to form a vSphere Replication environment. Now, it is time to
take the discussion further. In this chapter, you will learn how
replication actually works and which configuration tasks are involved
with the replication of a virtual machine.
Here is what we will be covering:
Adding a remote site as a target
Configuring replication for a VM to the local/remote site
How does replication work?
Using replication seeds
Monitoring replication
Reconfiguring replication
Changing the target datastore
Pausing an ongoing replication
Stopping replication for a VM
Moving replication to another VR Server
Recovering virtual machines
Configuring a Failback for virtual machines
Using SRM with vSphere Replication
Adding a remote site as a target
A remote vCenter Server can be added as one of the targets. The pairing
is mandatory when both the sites are managed by different vCenter
Servers. This is because the VRM Server registered to the protected site
vCenter can only see vSphere Replication (VR) Servers that are
registered to it. You can deploy multiple VR Servers at either of the
sites, but pairing can only be used if they are registered to its local VRM
server. The pairing will not be possible if the vCenter Server managing
the remote site does not have a VRMS registered to it.

When adding a target site, you are prompted to specify the address
(FQDN/IP) and connection credentials of the vCenter Server managing
the target site. Most environments use separate accounts for connections
between different vSphere components. The separate account can also
be a service account corresponding to that component. In that case, you
can use the service account corresponding to the vCenter Server that
you are adding as a target site. Here the vCenter Server acts as a proxy
to communicate with the VRM server registered to target site. Once the
connection is successfully made, the VRM Server will be listed as the
target site.
Note
The default site name of the VRM server is the name of the vCenter
Server it is registered to. This can be changed in the VRA's web
interface, under the configuration tab.
The following procedure will guide you through the steps required to
add to a target site:
1. In the vSphere Web Client's Home page, click on vSphere
Replication to bring up the vSphere Web Client's interface for

vSphere Replication:
2. This page will list the vCenter Server the VRMS is registered to.
Click on the toolbar item Manage, which should bring up the
Manage tab for that vCenter Server with the vSphere Replication
sub-tab selected:
3. Click on Target Sites to list all the current target sites seen by the
VRMS. In this case, there are none, because we have not added any
sites yet. Click on the  icon to bring up the Connect to Target Site
window:

4. Supply the address (FQDN/IP) of the Platform Services
Controller (PSC) the target vCenters are connected to, as well as
its connection credentials and click on Log In to list all the vCenters
connected to the PSC. Select the intended target vCenter and click
on OK:
5. Once done, the VRM server registered with the added vCenter
should be listed as a target site:


Configuring replication for a VM
to the local/remote site
Replication can be across sites or at the same site. If you choose to
replicate the VMs that you plan to protect, to a datastore at the same
site, then you can use vSphere Replication to achieve the same.
Configuring replication requires the availability of a replication server
(VRS) at the target site, be it local or remote. Since you have already
deployed a vSphere Replication Appliance that includes both the VRMS
and VRS components, there is no need for an additional step to get the
replication working at the local site.
The following procedure will guide you through the steps required to
configure replication for a VM to a local or remote vCenter site:
1. If you intend to replicate the virtual machine to a datastore managed
by a remote site, then you will need to add the remote site vCenter
as a target site. Refer to the Adding a remote site as a target section
for instructions. Else, proceed directly to step 2.
2. Right-click on the intended virtual machine from the inventory and
navigate to All vSphere Replication Actions | Configure
Replication to bring up the Configure Replication wizard.
3. In the Configure Replication wizard, select the Replicate to a
vCenter Server option and click on Next to continue:

4. On the Target site screen, you will be presented with all the target
sites, both local and remote. You also have an option to add remote
sites as replication targets. Choose the intended (local or remote)
site and click on Next to continue:
5. The Replication server screen will allow you to manually select a
VR Server or select VRMS to auto-assign a VR server for
replication:
6. On the Target location screen, choose a datastore for the replica
virtual machine that will be created. Click on Edit to bring up the
Select Target Location window:

7. In the Select Target Location window, select the appropriate VM
Storage Policy to filter down the list of datastores and choose a
datastore:
Click on OK to return to the Target Location wizard screen and
click on Next to continue.
8. On the Replication options screen, you can enable Guest OS
quiescing and Network Compression. Both the options are not
selected by default:

Note
Guest OS quiescing support includes both Microsoft VSS and Linux
FS quiescing using VMware tools.
For details regarding VSS support refer to VMware KB – 2041909
from the following URL:
https://kb.vmware.com/selfservice/microsites/search.do?
language=en_US&cmd=displayKC&externalId=2041909
9. On the Recovery settings screen, set a planned Recovery Point
Objective (RPO) value. The default is 4 hours, with the lowest
possible being 15 minutes and the highest 24 hours. You can also
choose to save point in time snapshots of the replication, by
selecting the checkbox to enable it. By default, it creates 3 point-in-
time instances and any such instances created during the last 5 days
are retained. You can only retain a maximum of 24 point-in-time
snapshots of the replication. Point-in-time snapshots are useful if
you want to maintain multiple recoverable points for the virtual
machine. Make a selection and click on Next to continue:

10. On the Ready to complete screen, review the settings and click on
Finish to configure the replication.
11. The Recent Tasks pane should show a Configure a virtual
machine for replication task completed successfully.

How does replication work?
Once VM replication is successfully configured, it first does an initial
full sync of the source VMDKs to the target datastore. If you already
have the base VMDKs precopied to the destination datastore, then only
the changed blocks are replicated. The replication happens over the
network using the Network File Copy (NFC) protocol. The changed
blocks are transferred using ESXi's management VMkernel port group.
Once the initial sync is complete, the VR Agent tracks the changed
blocks using the vSCSI filter driver. It tracks, writes, and maintains a
bitmap of the changed blocks. Every time a replica is created, the data
transferred is copied to a redo log file. This is done to make sure that a
VM at the recovery site is not corrupted in the event of a network
disruption. The redo log is committed to the base disk only after the
changed blocks are fully copied, thereby making each replica crash
consistent. When you configure replication for a VM you get to choose
the RPO and the number of multiple point-in-time snapshots that you
would like to maintain. The RPO ranges from 15 minutes to 24 hours,
and you can have up to 24 point-in-time snapshots. This means you can
have up to 24 historical point-in-time recovery points of the replicated
VM. An RPO value of 5 minutes is possible if the virtual machine that is
being replicated and its replica are on Datastores hosted by VSAN.
Both RPO and the number of point-in-time instances dictate the number
of historical snapshots maintained for the VM. For instance, if you set an
RPO of 2 hours, then you will retain 12 point-in-time recovery points for
the VM each day. While the RPO is set to 2 hours, and if the number of
point-in-time instances is set to 4, then you have only 4 snapshots for
that VM. VR tries to keep the oldest of the recovery points created.
Once a replication has been successfully configured, the destination
datastore is populated with the following files:
*.vmdk: The base disk(s) to which the VM data is being replicated
hbrdisk.RDID-*: This is the redo log file that has the latest

replication data
hbrcfg*.vmx: This is a shadow VMX file that will be used to register
the VM, when a recovery is initiated
The following screenshot shows the contents of the replica VM's
directory:
Note
If a VM being replicated is modified by adding a new VMDK to it, then
the active replication will stop with an error. The replication should then
be manually reconfigured by the administrator to include the new
VMDK before resuming the replication.

Using replication seeds
When you configure replication on a virtual machine for the very first
time, vSphere replication will need to make an initial copy of the VM's
VMDKs. The initial copy can be bandwidth intensive and time
consuming based on the size of the VMDKs. This can however be
overcome by transporting the VMDKs to the intended location, prior to
configuring the replication on the VM. The transport method can be of
your choice, ideally couriered to the destination site, if remote.
Note
The copies of the VMDKs transported and placed at the destination
datastore is referred to as a seed.
The following procedure will guide you through the steps required to use
an available seed for a VM:
1. Power off the virtual machine at the source (protected) site, which
you intend to replicate.
2. Copy the VM's folder to the target datastore. If it is in a different
data center, then the files need to be transported to the data center
first and then uploaded to the target datastore.
3. Power on the virtual machine at the source (protected) site.
4. Right-click on the virtual machine from the inventory and navigate
to All vSphere Replication Actions | Configure Replication.
5. Select the Replicate to a vCenter Server option.
6. Select the intended target site and click on Next.
7. Choose a Replication Server or let VMRS auto select one for you.
Make an intended selection and click on Next.
8. On the Target Location screen, click on Edit... to bring up the
Select Target Location window:

9. In the Select Target Location window, choose a datastore where
you would like to place the replica of the virtual machine, and set
the folder corresponding to the copy of the source VM at the
destination datastore as the Target Location. Click on OK to
confirm the section and return to the replication configuration
wizard:
10. A Folder Exists warning prompting you to either use the existing
folder or create a new one will appear. Click on the Use existing
button to return to the Configure Replication wizard:

11. The Target location screen will now indicate that it has found seeds
that can be used for the replication that is being configured. Here,
each seed corresponds to a VMDK. Click on the VM to expand and
review all the seeds found:
12. Once expanded, review all the found seeds and choose to either Use
all seeds or selectively seed only the needed VMDKs. Click on
Next to continue:

13. On the Replication options screen, you can choose to enable Guest
OS quiescing and Network Compression and click on Next to
continue.
14. On the Recovery settings screen, set a desired RPO value and the
number of point-in-time instances that you intend to retain and click
on Next to continue.
15. On the Ready to complete screen, review the settings and click on
Finish to configure the replication.
Note
Regardless of whether you choose to use a seed or not, vSphere
Replication always initiates an initial full sync. When using a seed, the
initial full sync will take considerably less time.

Monitoring replication
Replication configured on the VMs can be monitored for its current
status. Replications can be incoming or outgoing.
The following procedure will guide you through the steps required to
monitor a replication:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
Home.
3. Click on Monitor to go to the monitor tab with the vSphere
Replication sub-tab selected:
4. On the left-hand pane, you will find both Outgoing Replications
and Incoming Replications selected. The Outgoing Replications
section will show all the replications leaving the VR server at the
current site. The Incoming Replications section will show all the
replications arriving at the VR server at the current site:

Here, you might have noticed a Not Active status on one of the
replications. This is because the source VM was not powered on. VR
requires the source VM to be powered on for the replication to begin.
Selecting either Incoming Replications / Outgoing Replications will
list the names of the VMs being replicated and the current status of the
replication.
It is at the Monitor tab, where you get options to Reconfigure ,
Pause , Synchronize , and Stop  or Move  an ongoing replication.
More information on these task have been covered in separate sections
of this chapter:
The same options are made available when you right-click on a
configured replication:

Reconfiguring replication
An Ongoing replication can be reconfigured. This is done if there is a
need to change the replication server in use, the target datastore, or the
recovery settings.
The following procedure will guide you through the steps required in
reconfiguring a replication:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor with the vSphere
Replication sub-tab selected.
4. In the left-hand pane, you will find both Outgoing Replications
and Incoming Replications selected. Make an appropriate selection
depending on whether you are at the local or the remote vCenter
Server.
5. Right-click on an intended replication and click on Reconfigure to
start the reconfiguration wizard.
6. Change the replication server to handle the traffic, if intended. Click
on Next to continue.
7. Select the new target location, if intended. Click on Next to
continue.
8. Modify the replication options, if intended. Click on Next to
continue.
9. Modify the recovery settings, if intended. Click on Next to continue.
10. Review the Ready to complete screen and click on Finish to
initiate the reconfiguration.

Changing the target datastore
You can change the target datastore of an Ongoing replication by
reconfiguring the replication. Doing so will result in the deletion of the
files from the current destination datastore, and an initial full sync will
be done again to the new target datastore location.
The following procedure will guide you through the steps required to
change the target datastore of an ongoing replication:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor with the vSphere Replication
sub-tab selected.
4. In the left-hand pane, you will find both Outgoing Replications
and Incoming Replications selected. Make an appropriate selection
depending on whether you are at the local or the remote vCenter
Server.
5. Right-click on the desired replication and click on Reconfigure to
start the reconfiguration wizard.
6. Select a replication server to handle the traffic. In this case, we have
selected the local VRA. Click on Next to continue.
7. On the Target Location screen, click on Edit... to bring up the
Select Target Location window.
8. In the Target Location window, you will have to change the target
location individually for the VM configuration file (.vmx) and the
VMDKs and click on OK.
Note
Unlike version 5.5, wherein VR would do an initial full sync to the
new location contributing to the loss of all the current replication
instances, with version 6.1 vSphere Replication will move the
selected replicated instances to the new target location.
9. Modify the Replication options, if needed. Click on Next to

continue.
10. Modify the Recovery Settings, if needed. Click on Next to
continue.
11. Review the Ready to complete screen and click on Finish to
initiate the reconfiguration.
12. You should see a Reconfigure virtual machine replication task
completed successfully in the Recent Tasks pane.

Pausing an Ongoing replication
An Ongoing replication can be paused regardless of the status it is in.
Pausing a replication will stop the VR from tracking the changes to the
VMDK files. The following procedure will guide you through the steps
required in pausing an ongoing replication:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor with the vSphere
Replication sub-tab selected.
4. In the left-hand pane, you will find both Outgoing Replications
and Incoming Replications selected. Make an appropriate selection
depending on whether you are at the local or the remote vCenter
Server.
5. Right-click on the replication that you want to pause and click on
Pause.
6. Click on Yes on the confirmation window.
7. Once the replication has been successfully stopped, the status
should read Paused.
On pausing an ongoing replication, the VR server will temporarily stop
monitoring the source VM. A paused replication can then be resumed by
following the same procedure, but by selecting Actions | Resume at the
fifth step.

Synchronize Data Immediately
Synchronization is the process of transferring changed blocks from the
source to the replica at the destination via the vSphere Replication
Server component. vSphere Replication synchronizes the data based on
the RPO setting. If the RPO is set to 4 hours, then the synchronization
happens every 4 hours.
However, we do have an option to force an immediate synchronization,
using Synchronize Data Immediately, without having to wait for the
next scheduled sync. Although it is important to keep in mind that the
amount of time required to perform the sync depends on the amount of
changes to the source VM since the previous scheduled sync. This
operation could potentially increase the network usage, owing to the
amount of data that needs to be transferred.
The following procedure will guide you through the steps required to
initiate an immediate data synchronization:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor with the vSphere Replication
sub-tab selected.
4. In the left-hand pane, you will find both Outgoing Replications
and Incoming Replications selected. Make an appropriate selection
depending on whether you are at the local or the remote vCenter
Server.
5. Right-click on the replication that you want to Synchronize and
click on Sync Now to perform the synchronization:

6. You should see a Synchronize virtual machine task completed
successfully in the Recent Tasks pane.

Stopping replication on a VM
You can choose to stop the replication on a VM if there is a need to do
so. Stopping a replication will permanently stop the replication and
delete all the replicas. This is normally done to remove the replication
for a VM.
The following procedure will guide you through the steps required to
stop replication of a virtual machine:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor tab with the vSphere
Replication sub-tab selected.
4. Select Outgoing Replications, if at the protected site or Incoming
replications, if at the recovery site; either can be selected if the VM
is replicated to the same site as the source.
5. Select the replication, right-click on it, and click on the Stop menu
item.
6. You will be prompted to confirm the action. Click on Yes to confirm.
Keep in mind though that a replication can only be successfully
stopped if both the source and the target sites are able to talk to
each other. If, for whatever reason, the communication between
source and target sites are disrupted, then you need to use the Force
stop replication option to stop the replication at both the sites:

7. The Recent Tasks pane will show an Unconfigure virtual machine
replication task completed successfully.
8. The Outgoing/Incoming Replication sections will no longer list the
stopped replication.

Moving replication to another VR
Server
You can choose to move an active replication to another VR server if
need be. This is generally done when you have multiple VR servers at
the recovery site and you intend to distribute the replication load to
those servers. Moving a replication to another VR Server requires a
reconfiguring of the replication on the VM.
The following procedure will guide you through the steps required in
moving the replication to another VR Server:
1. Connect to the vCenter Server and navigate to the inventory home.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor tab with the vSphere
Replication sub-tab selected.
4. Select either Outgoing Replications or Incoming Replications.
5. Select the replication, right-click on it, and click on the Move to...
menu item:
6. You should now be presented with a list of vSphere Replication
servers registered to the site the VM is being replicated to. Make a
selection and click on OK:

7. The Recent Tasks pane should show the Move replication to other
vSphere Replication Server task completed successfully and the
status should read OK.

Recovering virtual machines
We have described how to configure replication for the virtual
machines. The story will remain half-told, however, if we do not cover
how to recover virtual machines using their replicas. You can perform a
recovery only at the site target site. In other words, you will be
presented with an option to initiate a recovery only at the site which has
seen the incoming replication.
The following procedure will guide you through the steps required to
perform a recovery:
1. Connect to the vCenter Server managing the remote site and
navigate to the inventory home.
Note
If there is only one vCenter Server managing both the protected and
recovery sites, then vSphere Replication's monitor tab will show
both the outgoing and incoming replication for the virtual machine.
2. Click on vSphere Replication to bring up the vSphere Replication
home.
3. Click on Monitor to go to the monitor tab with the vSphere
Replication sub-tab selected.
4. Select Incoming Replications on the left-hand pane and select the
virtual machine that you would like to recover.
5. With the virtual machine selected, right-click on it and click on
Recovery...:

6. You will be presented with the Synchronize recent changes and
Use latest available data recovery options. Choose the appropriate
option and click on Next to continue. More insight on these options
are included here:
Synchronize recent changes: This option will initiate an
immediate synchronization to make sure that the VM after
recovery has the latest data in it. This is not possible if the
source VM is powered on. You will have to manually power off
the VM if it is running.
Use latest available Data: This option will recover using the
most recent redo log that was created. In this case, you will lose

all the changes that happened at the source VM since the last
replication. The amount of data loss will not exceed the RPO
set. For instance, if the RPO was set to 15 minutes, then you
would only lose 15 minutes worth of data.
7. Select the data center/folder you intend to place the VM.
Note
Keep in mind that only the data center to which with the virtual
machine was replicated to can be selected.
Note
You will not be able to place the recovered VM into the same
inventory hierarchical level as that of the source VM. It is a general
practice to create the folder under the data center level, to house the
recovered VMs.
8. On the Resource screen, select the compute resource (cluster, host,
or resource) and click on Next to continue.
9. On the Ready to complete screen, you can choose not to power on
the recovered virtual machine, by unchecking the Power on the
virtual machine after recovery checkbox. It is selected (checked)
by default. Click on Finish to start the recovery:

10. The Recent Tasks pane should show a Recover Virtual Machine
task completed successfully.
11. The replication status of the VM will now be Recovered:
12. After a successful recovery, you should see the recovered VM
powered on and running.
13. The VM's snapshot manager will show all the point in time instances
as snapshots so that Revert-To-snapshot is possible:

Configuring failback for VMs
With vSphere Replication, configuring failback for a virtual machine is a
manual process. The following process will guide you through the steps
required to perform a failback:
1. Recover the virtual machine to the recovery site. Refer to the
Recovering virtual machines section for instructions.
2. Remove the virtual machine from the inventory at the protected
site.
3. Configure an outgoing replication from the recovery site to the
protected site. Refer to the Configuring Replication for a VM to the
local/remote site section for instructions.
When configuring the replication from the recovery to the protected
site, if the datastore at the protected site has the VM files, then those
can be used as seeds; otherwise an initial full sync is performed.
Note
A failover can be automated using SRM.

Using SRM with vSphere
Replication
vSphere Replication as a standalone product has no ability to automate
DR tasks such as a test, a failover, or a failback. SRM can be used to
leverage vSphere Replication as the replication engine and use its
orchestration ability to automate the DR tasks. Refer to following
diagram:
SRM relies on the concept of two sites replicating data between them
with the help of a replication engine. So, you need two sites managed
separately by two different vCenter Servers. Each of the vCenter
Servers should have a VRMS instance registered to it. This means you
need to deploy a vSphere Replication Appliance (VRA) at both the
sites. Once the VRA is deployed, use the vSphere Web Client's vSphere
Replication interface at the protected site to add the recovery site as the

target site. For more information on how to add target sites, refer to the
Adding a remote site as a target section. For SRM to detect the
registered vSphere Replication Appliances at both the sites, you will
need to install the vSphere Replication component bundled with the
SRM installer. If you already have SRM installed, you can run the
installer to repair the installer and install vSphere Replication
components as well. Once you have installed the vSphere Replication
component, the SRM interface should list vSphere Replication.
All the DR tasks that can be performed using SRM have been explained
in the chapters that cover SRM's array-based replication. Although the
DR tasks are notably similar, there are a few changes to the workflow.
We will cover the following tasks in this section:
Creating a vSphere Replication protection group
Creating a vSphere Replication recovery plan
Testing a vSphere Replication recovery plan
Performing a failover (recovery)
Preforming a failback (re-protect and failover)
Creating a vSphere Replication protection
group
You will need to create a protection group for the VMs that you would
like to protect using vSphere Replication. Unlike array-based replication,
you can select any replication-enabled virtual machine to become part
of a protection group.
To do this, perform the following steps:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery.
2. Click on Protection Groups in the left-hand pane.
3. Click on the create protection group icon  to bring up the Create
Protection Group wizard.
4. In the wizard, set a name for the protection group and an optional
description and click on Next to continue.

5. In the Protection group type window, select the Protected site and
set the Replication type as vSphere Replication (VR) and click on
Next to continue:
6. The next screen will provide you with a list of all the replication-
enabled virtual machines. Choose the ones you want to include in
the protection group and click on Next to continue.
7. On the Ready to complete screen, click on Finish to create the
protection group.
You should see a Create Protection Group and a Protect VM task
completed successfully in the Recent Tasks pane. At the recovery site,
you should see a shadow virtual machine created for the VMs that we
added to the protection group.
Creating a vSphere Replication recovery plan
Once the protection groups are created, the next step is to create
recovery plans.
This is done by performing the following steps:
1. Navigate to the vCenter Servers inventory home and click on Site
Recovery.
2. Click on Recovery Plans in the left-hand pane and click on the
create recovery plan icon to bring up the Create Recovery Plan
wizard.

3. Supply a recovery plan name and an optional description and click
on Next to continue.
4. The remote site is chosen as the recovery site by default. Click on
Next to continue.
5. Select a protection group of the type VR. Note that this window will
also display protection groups of the type array-based, if there are
any. So make sure that you select a protection group of the type VR
and click on Next to continue.
6. Choose a Recovery Network and a Test Network. You can leave the
Test Network at Auto, if you intend to use the temporary vSwitch
and the port group that SRM creates for the test. Otherwise, you can
choose another port group that you have create for the testing. Click
on Next to continue.
7. On the Ready to complete screen, review the options and click on
Finish to create the recovery plan.
You should see a Create Recovery Plan task completed successfully in
the Recent Tasks pane.
Testing a vSphere Replication recovery plan
Any recovery plan that you create should be periodically tested to make
sure that it is ready for a DR activity, should a need arise.
This is done by performing the following steps:
1. Navigate to the vCenter Server's inventory home and click on Site
Recovery.
2. Click on Recovery Plans in the left-hand pane and choose a plan
for a vSphere Replication protection group.
3. Click on the Test button to bring up the Test wizard.
4. By default, the Replicate recent changes to recovery site
checkbox is selected. Leave it selected and click on Next to
continue.
5. On the next screen, review the options and click on Start to begin
the test operation.

The progress of the recovery steps can be monitored in the Recovery
Steps tab.
Note
Make sure that you run a Cleanup after the Test is complete.
Performing a recovery or a planned
migration
In the event of a disaster at the protected site, or if there is a need for a
planned migration, we can use SRM's Recovery option to run the
recovery plan to perform either of the tasks. A planned migration and a
recovery are different in terms of whether or not the replication of the
recent changes is necessary. A planned migration cannot proceed
without being able to replicate recent changes. A Disaster Recovery will
attempt to replicate the recent changes, but will continue even if it is
unable to replicate the changes.
The procedure is the same regardless of the replication engine in use.
Refer to the Performing a planned migration and Performing a
disaster recovery (failover) sections from the Chapter 3, Testing and
Performing a Failover and Failback chapter.
A Recovery is always from the recovery site. Once initiated, a new sync
is initiated to replicate the recent changes. Once done, the protected
virtual machine is powered off, and the replication status is changed to
Recovered.
Preforming a failback (re-protect and
failover)
After a failover, you can enable protection of the VMs in the reverse
direction, which is achieved by running a Reprotect operation. Refer to
following diagram:

A Reprotect will reverse the direction of the replication. Now, after the
original protected site becomes operational you can choose to failback
to the original site. This is achieved by issuing a failover after a
successful re-protect operation. Once the failover is complete, the
replication status would be set to Recovered and there is not active
replication. To re-enable replication in the original direction, you should
run a Reprotect operation again.

Summary
In the previous chapter, you learned how to set up a vSphere Replication
environment, and then use it to configure a replication on virtual
machines. We also learned how to stop or pause an ongoing replication
and how to move the replication load onto another vSphere Replication
Server. More importantly, we learned how to recover a virtual machine
from a replica. Most of the replication-related activities that we have
discussed in the chapter are done on a per VM basis, and that is all you
can do with vSphere Replication when implemented as a standalone
solution. We then learned how to configure vCenter Site Recovery
Manager to leverage the vSphere Replication and perform the disaster
recovery tasks.

Chapter 6. Using vRealize
Orchestrator (vRO) to Automate
SRM and vSphere Replication
From the previous chapters, you learned how to use SRM to leverage
vSphere Replication and/or array-based replication to protect virtual
machine workloads to make them available in a Disaster Recovery
situation. While SRM orchestrates most of the DR activities which
otherwise would require a lot of manual work, it still needs an
administrator to hop between many GUI elements to perform the tasks.
In this chapter, you will learn how to deploy and configure vRealize
Orchestrator for use with SRM and vSphere Replication. What we will
not cover is creating custom workflows using vRealize Orchestrator as
that is beyond the scope of this book. This chapter also covers a brief
topic on Troubleshooting SRM and vSphere Replication.
Here is what we will be covering:
Deploying and configuring vRealize Orchestrator
Installing the vRO plugins for SRM and vSphere Replication
Troubleshooting SRM and vSphere Replication
Deploying and configuring
vRealize Orchestrator
vRealize Orchestrator is a vSphere task automation tool that is available
with your vCenter Standard License. It has access to the entire vSphere
API, making it a very powerful tool. The vRO plugin for SRM/vSphere
Replication will enable some prebuilt workflows that can be readily
used. vRO can also be used to create custom workflows for commonly
performed tasks.
It is important to download a version of vRO that is compatible with the

version of the solution whose tasks you intend to automate.
Here are a few charts from the VMware Product Interoperability Matrix
online tool:
https://www.vmware.com/resources/compatibility/sim/interop_matrix.php
VRO's compatibility with all supported versions of SRM
VRO's compatibility with vSphere versions dating back to vCenter 5.5
VRO's compatibility with all supported versions of vSphere Replication

Downloading vRealize Orchestrator
At the time of writing, vRealize Orchestrator 7.0.1 was the latest version
available, and it is compatible with SRM 6.1.1 and vSphere Replication
6.1.1. It is available for download in the OVA format.
The following URL will take you to the download page for VRO 7.0.1:
https://my.vmware.com/web/vmware/details?
productId=490&downloadGroup=VROVA_701
Deploying vRealize Orchestrator
The following procedure will guide you through the steps required to
deploy vRealize Orchestrator from an OVA:
1. Log in to the vCenter Server using vSphere Web client and initiate
the Deploy OVF Template wizard from the right-click context
menu of the vCenter Server:

2. In the Deploy OVF Template wizard, browse and locate the vRO
OVA file and click on Next to continue:
3. The Review details screen will display the Appliance version,
download size, and the size on disk values of its vmdk. Click on
Next to continue.
4. On the Accept License Agreements screen, accept the license
agreement and click on Next to continue.

5. On the Select name and folder screen, supply a name for the
appliance virtual machines and select a virtual machine folder. Click
on Next to continue:
6. On the Select storage screen, select the intended VMDK format,
VM Storage Policy policy, and then a datastore to put the virtual
machine files on. Once done, click on Next to continue:
7. On the Setup networks screen, select a virtual machine port group
for the appliance's vNIC and set the IP protocol to IPv4. Once
done, click on Next to continue:

8. On the Customize template screen, set an initial root password for
the appliance. Optionally enable SSH, supply a hostname, and IP
configuration details. It is recommended that you make sure that a
DNS record is created for the appliance using the supplied hostname
and IP address before you proceed further. Once done, click on
Next to continue:

9. On the Ready to complete screen, review the settings and click on
Finish to initiate the deployment of the appliance. You can
optionally choose to start the virtual machine after the deployment
by selecting the option Power on after deployment before hitting
the Finish button.
You should see two tasks—Initialize OVF deployment and Deploy OVF
template—completed successfully.
Using the vRealize Orchestrator client
Before we proceed further, let's review the types of vRO client
available. The vRO client is available as a standalone client that can be
downloaded from the vRO server or as a Java JNLP client. In this
example, we will use the standalone client application. But keep in mind
that both require the latest Java Runtime Environment installed.

Note
To download the latest version of Java, go to www.java.com/download.
Both the clients are available from the vRealize Orchestrators home
page. The home page URL has the following syntax:
https://FQDN or IP of vRO Server:8281/vco/
At the home page, you get an option to either start the Orchestrator
client or download load the standalone version of the client:
The Start Orchestrator Client link will download a clinet.jnlp file,
which can be launched to web start the orchestrator client.
The Download Orchestrator Client Installable option has client
versions for Windows, Linux, and Mac OS X. Unlike what the
description says, it is not really an installer. It is a ZIP archive containing
a directly launchable version of the client. The name of the client file is
vROWorkflowDesigner:

Configuring vRealize Orchestrator
Once installed, the vRO Server must be prepared and configured to
orchestrate the vCenter instances using one of its built-in workflows.
vRO can be configured using the Orchestrator Control Center. The
URLs for this can be learned from the vRO virtual machines console:

The configuration is a two step process:
Configure vRO database
Configure authentication provider
Configure vRO database
The following procedure will guide you through the steps required to
configure the vRO database:
1. Connect to the vRO Control Center using the following URL:
https://<vRO IP or FQDN>:8283/vco-controlcenter
2. Use the root user password that was supplied by the Deploy OVF
template wizard.
3. In the Control Center, switch to Configuration View and click on
Configure Database:
4. On the Configure Database screen, set the database type
accordingly. In this case, I will be using an embedded PostgreSQL
database. Set the database credentials. The default database name
and username should not be modified.
The defaults are as follows:
database name: vmware
username: vmware
Password: a blank password

Note
vRO does support external SQL, Oracle databases, and an in-
process Apache Derby DB as well.
5. Click on Save Changes to configure the DB.
Configure authentication provider
The vRO must be configured to connect to a vCenter instance for the
plugins to work. This is done by letting it connect to the corresponding
vCenter Single Sign-On Server or the Platform Services Controller.
The following procedure will guide you through the steps required in
configuring vRO to connect to vCenter Server:
1. Connect to the vRO Control Center using the following URL:
https://<vRO IP or FQDN>/vco-controlcenter
2. In the Control Center, click on Configure Authentication
Provider:

3. On the Configure Authentication Provider screen, change the
Authentication mode to vSphere and supply the FQDN of the SSO
Server or PSC in the Host address field. Doing so will autogenerate
an https URL to the VMware Component Manager. Click on
Connect:
Note
Post this configuration change, the vCenter SSO becomes the
authentication provider.
4. You will be prompted to accept the SSO/PSC server certificate for
the connection to go through. Click on Accept Certificate:

5. Now, you will be prompted for the SSO username and password.
Supply the SSO credentials, select the Configure licenses checkbox
and click on Register:

6. You will then be prompted for the Admin group. Click on the
Search button for a drop-down list of user groups. Choose a user
group which has administrator rights at the vCenter Server. In this
example, I have selected the vsphere.local\Administrators group:

7. With the Admin group selected, click on Save Changes:
8. Once the configuration has been successfully saved, you will be
instructed to restart the Orchestrator Server for the changes to take
effect. Click on the hyperlink Startup Options to navigate to the
Startup Options page:

9. In the Startup Options page, click on Restart to bounce the
Orchestrator server service. You can see the progress of restarting
the service in the gray area below the Start/Stop/Restart buttons:
10. Navigate back to the Control Center Home and click on Validate
Configuration:
11. On the Validate Configuration screen, if you see a green tick mark

against all the components, then you are good to go:
Enabling vRealize Orchestration for a
vCenter
Now that we have configured the vRO server, the next step is to tell the
vRO server which vCenter instance we intend to orchestrate and make
the plugin available via the vSphere Web client.
This a two step process:
Adding a vCenter Server instance to vRO
Registering vRO as a vCenter Server Extension
Adding a vCenter Server instance to vRO
The following procedure will guide you through the steps required to
add a vCenter Server instance to vRO:
1. Start the vRO Client and supply the username and password that
correspond to a user in the Admin group, specified when configuring

vSphere as the Authentication provider for vRO. Refer to the
Configure authentication provider section in this chapter for more
details:
Note
Keep in mind that the default username/password for the vRO client
connection is vcoadmin/vcoadmin. This username/password cannot
be used to log in to the orchestrator once the authentication provider
has been changed from LDAP to vSphere.
2. Once you have logged into the vRO server, click on the 
 icon to
navigate to the workflows tab.
3. In the workflows tab, navigate to Library | vCenter |
Configuration and select Add a vCenter Server instance:

4. Right-click on the Add a vCenter Server instance workflow and
click on Start workflow...:

5. In the Start Workflow: Add a vCenter Server instance window,
supply the IP address or the FQDN of the vCenter Server that you
intend to add. Leave the port and the SDK location unmodified.
Select Yes to orchestrate the instance. You could also choose to
ignore the certificate warning:
6. In the Set the connection properties screen, supply user
credentials for the vCenter Server. On this screen you could choose
to spawn only a single unique share connection to the vCenter. By
default, vRO will use a separate session per user. Once done with all
the necessary inputs in the window, click on Submit to run the
workflow:

7. If there are no errors, you should see the workflow completed
successfully.
Registering vRO as a vCenter Server extension
Once the vCenter is added to the vRO, the next step is to install the vRO
plugin to the vSphere web client. This is achieved by running the
Register vCenter Orchestrator as a vCenter Server extension workflow:
1. Right-click on the extension and click on Start Workflow to bring
up the Register vCenter Orchestrator as a vCenter Server
extension window.
2. In the Register vCenter Orchestrator as a vCenter Server
extension window, you will need to select the vCenter to register

with. To do this, click inside the search box to bring up the Select (
VC:SdkConnection ) window:
3. In the Select ( VC:SdkConnection ) window, highlight the vCenter
instance and click on Select:
4. Once you are back at the Register vCenter Orchestrator window,
click on Submit to run the workflow.
5. If there are no errors, you should see the workflow complete

successfully.
6. Close the current vSphere Web client session and reconnect to
select vRealize Orchestrator from the vSphere Web client's
Inventory Home:
7. The Summary tab of vRO Home will show the vRO registered to
this vCenter:
So, this completes the procedure of Registering a vRO server to a
vCenter Server instance to enable orchestration. In the next section, you
will learn how to enable the use of SRM and vSphere Replication vRO
plugins.

Install vRealize Orchestrator
plugins for SRM and vSphere
Replication
In addition to the default plugin for the vCenter Server, VMware
provides separate plugins for Site Recovery Manager and vSphere
Replication. In this section of the chapter, you will learn how to
download, install, and enable these plugins.
Downloading the vRO plugins for SRM and
vSphere Replication
The vRO plugins can be downloaded from the following URL:
https://www.vmware.com/support/pubs/vco_plugins_pubs.html.
At the vRealize Orchestrator Plugin Information page, select the
Plugin Product as vCenter Site Recovery Manager for SRM plugins:
Select vSphere Replication for VR plugins:

The downloaded files will be of the .vmoapp extension:
Installing vRO plugins
The following procedure will guide you through the steps required to
install vRO plugins:
1. Connect to the vRO Control Center using the following URL:
https://<vRO IP or FQDN>:8283/vco-controlcenter.
2. In the Control Center, switch to the Configuration view and click
on Manage Plug-Ins:
3. In the Manage Plug-Ins page, click on Browse... and locate the
.vmoapp file and click on Install:

4. Accept the EULA and click on Install to begin the installation:
5. Once the install is complete, you will be instructed to restart the
Orchestrator Server for the changes to take effect:

6. Go to Startup Options and Restart the Orchestrator service.
7. Repeat steps 1-6 to install the vSphere Replication plugin as well.
8. If successfully installed, the SRM and vSphere Replication
workflows will be made available in the Workflow library:

Troubleshooting SRM and
vSphere Replication
Like with any other software product, you will unavoidably run into
issues that are product configuration issues, bugs or operational gotchas
and so on. The section of the chapter will help you to get to SRM and
vSphere Replication logs and also provide you with troubleshooting
references.
Getting to the logs
To understand why a software functionality failed or exhibited abnormal
behavior, it is important to know what exactly transpired during that
occurrence. Although most modern software will expose events/errors in
the GUI, it is impractical to present a more detailed view of the
events/errors in the graphical user interface. Hence, all software
products maintain logs. Logs are not just generated when something
goes wrong but are constantly maintained. Logs might show errors and
warnings even when everything is working fine.
The important fact is that not everything in the logs would make sense
or help an administrator to troubleshoot an issue. Some entries in the
logs could be developer-infused and very detailed, which is done
intentionally to aid in product improvement from field tests, in-house
tests, customer feedback, bug report, and so on. However, the good
thing here is that, such unnecessary details can be suppressed by what is
referred to as a log level. Log level dictates as to what type of
events/error should be generated in the log files. There is generally an
advanced setting to modify the logging levels. It is also quite possible
that a single software product maintain multiple log files stored at
different locations and corresponding to different components of the
software.
In this section of the chapter, you will learn how to get to the log files of
both Site Recovery Manager and vSphere Replication.

Analyzing vSphere Replication logs
Since vSphere Replication is a hypervisor-based replication engine, the
logs pertaining to replication can be found both on the ESXi host and on
the vSphere Replication Appliance.
The following are the log files to refer to during the troubleshooting of a
vSphere Replication issue:
Host
vSphere Replication Appliance
/var/log/vmkernel.log
/var/log/vmware/hbsrv.log
/var/log/vmware/hms.log
Now that we know the log files, how do we go about using them to
troubleshoot an issue? Since, vSphere Replication is enabled on a per-
virtual machine basis the replication can be tracked based on its Group-
ID. We use the vSphere API command vim-cmd to send instructions to
the host management service (hostd) to perform the actions. The vimcmd
has several command spaces—vmsvc, hostsvc, vimsvc, hbrsvc,
proxysvc, internalsvc, and solo. We will be using vmsvc and hbrsvc.
The following procedure will guide you through the process of tracking
the replication of a virtual machine:
1. Connect to the ESXi host running the virtual machine using an SSH
client such as putty. Log in as root.
2. Now, to the get the VMID of the running virtual machine, issue the
following command:
vim-cmd vmsvc/getallvms
The command will list all the virtual machines registered to the ESXi
host. The first column is the VMID
3. The next step will be to list the replication job details corresponding
to the virtual machine. The input for this command will be the
VMID procured from the output of the previous command:

vim-cmd hbrsvc/vmreplica.getState VMID
The command will retrieve the VM running replication state and a
Group ID
4. You can now check the vmkernel.log file for instances
corresponding to the GID procured from the previous command
output.
5. You can use the same GID to track events corresponding to the
replication in the appliance logs hbsrv.log and hms.log.
Analyzing SRM logs
Since SRM is installed on a machine running a supported Windows
server operating system, the log files are maintained under the
ProgramData directory structure.
Here is the full path to log file location:
\ProgramData\VMware\VMware vCenter Site Recovery Manager\Logs\.
The vmware-dr log files is where all the SRM events are logged. All SRA
events are logged in separate log files. For the location of the SRA log

files, refer to the Storage vendor's SRA documentation.
Increasing the logging level for SRM
Sometimes it becomes necessary to capture more events/warnings/errors
to get to the crux of an issue. You can change the logging level of SRM
from Advanced Settings.
The following procedure will guide you through the steps required to
change the logging level of SRM:
1. Navigate to Site Recovery Manager Home and click on Sites to list
the paired sites.
2. Select the site you intend to increase the logging level on, navigate
to Manage | Advanced Settings, and select Log Manager from the
left pane to view the log settings. Click on Edit to bring up the Edit
Advanced Settings window:
3. In the Edit Advanced Settings window, select the first entry
logManager.Default and use the drop-down box to set a desired
logging level:

Note
A restart of the SRM service is not necessary for the changes to take
effect.
For more details regarding the logs level, read the Change Logging
Settings section at page 135 of the SRM 6.1 Administration Guide,
available at http://bit.ly/SRM61AdminGuide.
Troubleshooting references
As mentioned earlier, the intention of this section is to provide you with
guidelines on how to find the information you need to troubleshoot an
issue. The following list of references could aid you during
troubleshooting:
Collecting diagnostic information for Site Recovery Manager at
http://kb.vmware.com/kb/1009253
Collecting the VMware vSphere Replication logs at
http://kb.vmware.com/kb/2013091
Solutions for common vSphere Replication Problems at page 93 of

the vSphere Replication 6.1 Administration Guide at
http://bit.ly/VR61AdminGuide
Troubleshooting SRM at page 169 of the SRM 6.1 Administration
Guide at http://bit.ly/SRM61AdminGuide
The Site Recovery Manager 6.1.x service stops running during a test
failover for a protection group containing multiple virtual machines
at http://kb.vmware.com/kb/2145559
SRM service fails to start with an error in the Windows Event
Viewer at http://kb.vmware.com/kb/2050400
Operational Limits for vSphere Replication 6.x at
http://kb.vmware.com/kb/2102453
VSS Quiescing Support with vSphere Replication at
http://kb.vmware.com/kb/2041909
Resetting a lost VMware vSphere Replication root password at
http://kb.vmware.com/kb/2062059

Summary
In this chapter, you learned how to deploy and configure vRealize
Orchestrator to enable orchestration of tasks on vCenter Server
instances. You also learned how to install vRO plugins for SRM and
vSphere Replication. Since creating custom workflows is beyond the
scope of this book, I would recommend that you read Using VMware
vRealize Orchestrator Plug-Ins and Developing with VMware vRealize
Orchestrator available at the vRealize Orchestration documentation
home page:
https://www.vmware.com/support/pubs/orchestrator_pubs.html. You
also learned how to get to the log files of both SRM and vSphere
Replication. You also learned how to change the logging level of SRM
logs. The chapter also included additional references to troubleshooting
articles.

Index
A
array-based replication
enabling / Preparing storage for array-based replication
array managers
adding / Adding array managers and enabling array pairs
array pairs
enabling / Adding array managers and enabling array pairs
D
data
synchronization / Synchronize Data Immediately
datastore groups
about / Understanding datastore groups
Disaster Recovery (DR)
about / What is Site Recovery Manager?
disaster recovery (failover)
performing / Performing a disaster recovery (failover)
Discover Devices operation / Adding array managers and enabling
array pairs
Distributed Power Management (DPM) / Testing a recovery plan –
background
Dynamic Host Configuration Protocol (DHCP) / How does SRM
use IP customization rules?
E
ESXi hosts
zonning, at protected and recovery sites / Host presentation
(Zoning) at the protected and the recovery sites
F
failback (re-protect and failover)
performing / Preforming a failback (re-protect and failover)
folder mappings

creating / Creating resource, folder, and network mappings,
Folder mappings
about / Folder mappings
configuring / Folder mappings
forced recovery
performing / Performing a forced recovery
enabling, for site / Enabling forced recovery for a site
Advanced Settings / Enabling forced recovery for a site
running / Running a forced recovery
G
guest OS customization support matrix
reference / IPv4 customization rules
I
IPv4 customization rules
about / IPv4 customization rules
creating / Creating an IPv4 customization rule
J
Java
URL, for downloading / Using the vRealize Orchestrator client
L
logs
obtaining / Getting to the logs
vSphere Replication logs, analysing / Analyzing vSphere
Replication logs
Site Recovery Manager (SRM) logs, analysing / Analyzing SRM
logs
level, increasing Site Recovery Manager (SRM) used /
Increasing the logging level for SRM
level, increasing vSphere Replication used / Increasing the
logging level for SRM
references, troubleshooting / Troubleshooting references

N
Network File Copy (NFC) protocol / How does replication work?
network mappings
creating / Creating resource, folder, and network mappings,
Network mappings
about / Network mappings
configuring / Network mappings
Node Storage Module (NSM) / Adding array managers and enabling
array pairs
O
Ongoing replication
pausing / Pausing an Ongoing replication
P
placeholder datastores
configuring / Configuring placeholder datastores
planned migration
performing / Performing a planned migration, Performing a
recovery or a planned migration
Platform Services Controller (PSC) / Adding a remote site as a
target
protected site / VRM site name
protection group
creating, vSphere Replication used / Creating a vSphere
Replication protection group
protection groups
about / Understanding protection groups
storage policy based protection groups / Storage policy-based
protection groups
creating / Creating a protection group
PSC / Site Recovery Manager(SRM) architecture
R
recovery migration

performing / Performing a recovery or a planned migration
recovery plan
testing / Testing a recovery plan
test workflow / Test workflow
test, running / Running the test
background / Testing a recovery plan – background
cleanup, performing after test / Performing the cleanup after a
test
creating, vSphere Replication used / Creating a vSphere
Replication recovery plan
recovery plans
about / Understanding recovery plans
creating / Creating a recovery plan
references
troubleshooting / Troubleshooting references
remote site
adding, as target / Adding a remote site as a target
replication
configuring, for virtual machine to local vCenter site /
Configuring replication for a VM to the local/remote site
configuring, for virtual machine to remote vCenter site /
Configuring replication for a VM to the local/remote site
working / How does replication work?
monitoring / Monitoring replication
reconfiguring / Reconfiguring replication
stopping, on virtual machine / Stopping replication on a VM
switching, to VR server / Moving replication to another VR
Server
replication seeds
using / Using replication seeds
resource mappings
creating / Creating resource, folder, and network mappings,
Resource mappings
about / Resource mappings
configuring / Resource mappings

S
Site Recovery Manager (SRM)
about / What is Site Recovery Manager?
architecture / Site Recovery Manager(SRM) architecture
components / Site Recovery Manager(SRM) architecture
Array Manager / Array manager
installing, on protected and recovery sites / Installing SRM on
both the protected and recovery sites
IP customization rules, using / How does SRM use IP
customization rules?
Site Recovery Manager (SRM) logs
analysing / Analyzing SRM logs
SQL database
configuring, for VRMS / Configuring a SQL database for VRMS
SRM
used, for vSphere Replication / Using SRM with vSphere
Replication
SRM environment
configuration activities, listing / Laying the groundwork for an
SRM environment
storage, preparing for array-based replication / Preparing
storage for array-based replication
SRM installation
performing / Performing the SRM installation
SRM Instance / Site Recovery Manager(SRM) architecture
SRM protected site
failback, performing / Performing a failback to an SRM
protected site
SRM site
reprotecting / Reprotecting an SRM site
SRM sites
pairing / Pairing SRM sites
Storage Replication Adapter (SRA)
about / Array manager, Storage Replication Adapter (SRA)
installing / Installing the Storage Replication Adapters, Installing

the SRA
downloading / Downloading the SRAs
swap files
cons / Design choice 2: Store the swap files in the VM's working
directory
pros / Design choice 2: Store the swap files in the VM's working
directory
T
target datastore
modifying / Changing the target datastore
target location / Using replication seeds
V
Virtual Appliance Management Interface (VAMI) / How does it
work
Virtual IP (VIP) / Adding array managers and enabling array pairs
virtual machine
replication, configuring to local vCenter site / Configuring
replication for a VM to the local/remote site
replication, configuring to remote vCenter site / Configuring
replication for a VM to the local/remote site
replication, stopping / Stopping replication on a VM
virtual machines
recovering / Recovering virtual machines
failback, configuring used / Configuring failback for VMs
virtual machines (VMs)
about / What is Site Recovery Manager?
virtual machine swap file location
about / Virtual machine swap file location
datastore, separating / Design choice 1: Separate datastore for
the swap files
swap files, storing in VM's working directory / Design choice 2:
Store the swap files in the VM's working directory
VM recovery properties
configuring / Configuring VM recovery properties

IP customization / IP customization
recovery properties / Recovery properties
priority group / Priority group
VM dependencies / VM dependencies
shutdown action / Shutdown action
startup action / Startup action
pre power on steps / Pre-power on and post-power on steps
post power on steps / Pre-power on and post-power on steps
vPostgres database / Configuring a SQL database for VRMS
VRA hostname
setting, for VRA / VRA hostname
vRealize Orchestrator (vRO)
deploying / Deploying and configuring vRealize Orchestrator,
Deploying vRealize Orchestrator
configuring / Deploying and configuring vRealize Orchestrator,
Configuring vRealize Orchestrator
downloading / Downloading vRealize Orchestrator
client, used / Using the vRealize Orchestrator client
database, configuring / Configure vRO database
authentication provider, configuring / Configure authentication
provider
enabling, vCenter used / Enabling vRealize Orchestration for a
vCenter
vCenter Server instance, adding / Adding a vCenter Server
instance to vRO
registering, as vCenter Server extension / Registering vRO as a
vCenter Server extension
plugins, installing Site Recovery Manager (SRM) used / Install
vRealize Orchestrator plugins for SRM and vSphere Replication
plugins, installing vSphere Replication used / Install vRealize
Orchestrator plugins for SRM and vSphere Replication
plugins, downloading vSphere Replication used / Downloading
the vRO plugins for SRM and vSphere Replication
plugins, installing / Installing vRO plugins
logs, obtaining / Getting to the logs
vRealize Orchestrator (vRO) plugins

URL, for downloading / Downloading the vRO plugins for SRM
and vSphere Replication
VRM site name
setting, for VRA / Setting the VRA hostname and a VRM site
name for the VRA, VRM site name
VRO 7.0.1
URL, for downloading / Downloading vRealize Orchestrator
VR server
replication, switching to / Moving replication to another VR
Server
vSphere Replication / Site Recovery Manager(SRM) architecture
about / Introduction
version upgrades / New features in vSphere Replication 6.1
architecture / Understanding the vSphere Replication
architecture
bundle, downloading / Downloading the vSphere Replication
bundle
SRM, used / Using SRM with vSphere Replication
used, for creating protection group / Creating a vSphere
Replication protection group
used, for creating recovery plan / Creating a vSphere
Replication recovery plan
used, for testing recovery plan / Testing a vSphere Replication
recovery plan
vSphere Replication (VR) / Adding a remote site as a target
vSphere Replication 6.1
features / New features in vSphere Replication 6.1
vSphere Replication Appliance (VRA)
deploying / Deploying the vSphere Replication Appliance
working / How does it work
/ Using SRM with vSphere Replication
vSphere Replication logs
analysing / Analyzing vSphere Replication logs
vSphere Replication Management Server (VRMS)
about / How does it work
SQL database, configuring for / Configuring a SQL database for

VRMS
vSphere Replication Server
deploying / Deploying a vSphere Replication Server
registering / Registering vSphere Replication Servers

Table of Contents
Disaster Recovery Using VMware vSphere Replication and vCenter
Site Recovery Manager Second Edition
8
Credits
10
About the Author
12
About the Reviewer
13
www.PacktPub.com
14
eBooks, discount offers, and more
14
Why subscribe?
14
Instant updates on new Packt books
14
Preface
15
What this book covers
15
What you need for this book
17
Who this book is for
18
Conventions
19
Reader feedback
20
Customer support
21
Downloading the color images of this book
21
Errata
21
Piracy
21
Questions
22
1. Installing and Configuring vCenter Site Recovery Manager
(SRM) 6.1
23
Introduction
23
So what exactly are RPO and RTO?
25
What is Site Recovery Manager?
26
Site Recovery Manager(SRM) architecture
26
Array manager
27
Storage Replication Adapter (SRA)
28
Laying the groundwork for an SRM environment
30
Preparing storage for array-based replication
31

Host presentation (Zoning) at the protected and the recovery sites
32
Installing SRM on both the protected and recovery sites
32
Performing the SRM installation
33
Pairing SRM sites
40
Installing the Storage Replication Adapters
44
Downloading the SRAs
44
Installing the SRA
44
Adding array managers and enabling array pairs
46
Configuring placeholder datastores
53
Creating resource, folder, and network mappings
57
Resource mappings
57
Folder mappings
60
Network mappings
63
Virtual machine swap file location
68
Design choice 1: Separate datastore for the swap files
68
Design choice 2: Store the swap files in the VM's working directory
69
Summary
71
2. Creating Protection Groups and Recovery Plans
72
Understanding datastore groups
72
Understanding protection groups
74
Storage policy-based protection groups
75
Creating a protection group
76
What happens when you create a protection group?
82
Understanding recovery plans
86
Creating a recovery plan
86
Summary
91
3. Testing and Performing a Failover and Failback
92
Testing a recovery plan
92
Test workflow
93
Running the test
94
Testing a recovery plan – background
97
Performing the cleanup after a test
99

Performing a planned migration
103
Performing a disaster recovery (failover)
108
Performing a forced recovery
111
Enabling forced recovery for a site
111
Running a forced recovery
113
Reprotecting an SRM site
115
Performing a failback to an SRM protected site
118
IPv4 customization rules
119
Creating an IPv4 customization rule
119
How does SRM use IP customization rules?
122
Configuring VM recovery properties
124
IP customization
125
Recovery properties
128
Priority group
129
VM dependencies
130
Shutdown action
132
Startup action
132
Pre-power on and post-power on steps
133
Summary
136
4. Deploying vSphere Replication
137
Introduction
137
New features in vSphere Replication 6.1
139
Understanding the vSphere Replication architecture
141
Downloading the vSphere Replication bundle
144
Deploying the vSphere Replication Appliance
145
How does it work
152
Setting the VRA hostname and a VRM site name for the VRA
154
VRA hostname
154
VRM site name
155
Configuring a SQL database for VRMS
157
Deploying a vSphere Replication Server
166

Registering vSphere Replication Servers
170
Summary
172
5. Configuring and Using vSphere Replication 6.1
173
Adding a remote site as a target
173
Configuring replication for a VM to the local/remote site
178
How does replication work?
183
Using replication seeds
185
Monitoring replication
189
Reconfiguring replication
191
Changing the target datastore
192
Pausing an Ongoing replication
194
Synchronize Data Immediately
195
Stopping replication on a VM
197
Moving replication to another VR Server
199
Recovering virtual machines
201
Configuring failback for VMs
205
Using SRM with vSphere Replication
206
Creating a vSphere Replication protection group
207
Creating a vSphere Replication recovery plan
208
Testing a vSphere Replication recovery plan
209
Performing a recovery or a planned migration
210
Preforming a failback (re-protect and failover)
210
Summary
212
6. Using vRealize Orchestrator (vRO) to Automate SRM and
vSphere Replication
213
Deploying and configuring vRealize Orchestrator
213
Downloading vRealize Orchestrator
215
Deploying vRealize Orchestrator
215
Using the vRealize Orchestrator client
219
Configuring vRealize Orchestrator
221
Configure vRO database
222
Configure authentication provider
223

Enabling vRealize Orchestration for a vCenter
229
Adding a vCenter Server instance to vRO
229
Registering vRO as a vCenter Server extension
233
Install vRealize Orchestrator plugins for SRM and vSphere
Replication
236
Downloading the vRO plugins for SRM and vSphere Replication
236
Installing vRO plugins
237
Troubleshooting SRM and vSphere Replication
240
Getting to the logs
240
Analyzing vSphere Replication logs
241
Analyzing SRM logs
242
Increasing the logging level for SRM
243
Troubleshooting references
244
Summary
246
Index
247

